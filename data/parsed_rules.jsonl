{"title": "Web Application Suspicious Activity: POST Request Declined", "description": "A POST request to a web application returned a 403 response, which indicates the web application declined to process the\nrequest because the action requested was not allowed.", "query": "http.response.status_code:403 and http.request.method:post", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "apm_403_response_to_a_post.toml"}
{"title": "Web Application Suspicious Activity: Unauthorized Method", "description": "A request to a web application returned a 405 response, which indicates the web application declined to process the\nrequest because the HTTP method is not allowed for the resource.", "query": "http.response.status_code:405", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "apm_405_response_method_not_allowed.toml"}
{"title": "Suspicious File Downloaded from Google Drive", "description": "Identifies suspicious file download activity from a Google Drive URL. This could indicate an attempt to deliver phishing\npayloads via a trusted webservice.", "query": "process where\n\n    /* common browser processes  */\n    event.action in (\"exec\", \"fork\", \"start\") and\n\n    process.name : (\"Microsoft Edge\", \"chrome.exe\", \"Google Chrome\", \"google-chrome-stable\",\n                    \"google-chrome-beta\", \"google-chrome\", \"msedge.exe\", \"firefox.exe\", \"brave.exe\",\n                    \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"firefox\",\n                    \"powershell.exe\", \"curl\", \"curl.exe\", \"wget\", \"wget.exe\") and\n\n    /* Look for Google Drive download URL with AV flag skipping */\n    (process.command_line : \"*drive.google.com*\" and process.command_line : \"*export=download*\" and process.command_line : \"*confirm=no_antivirus*\")", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_google_drive_malicious_file_download.toml"}
{"title": "Potential Non-Standard Port SSH connection", "description": "Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For\nexample, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to the\nstandard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.", "query": "sequence by process.entity_id with maxspan=1m\n  [process where event.action == \"exec\" and process.name in (\"ssh\", \"sshd\") and not process.parent.name in (\n   \"rsync\", \"pyznap\", \"git\", \"ansible-playbook\", \"scp\", \"pgbackrest\", \"git-lfs\", \"expect\", \"Sourcetree\", \"ssh-copy-id\",\n   \"run\"\n   )\n  ]\n  [network where process.name:\"ssh\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n   destination.port != 22 and network.transport == \"tcp\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\"\n     )\n   )\n  ]", "tactic": "Command and Control", "technique": "Non-Standard Port", "technique_id": "T1571", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_non_standard_ssh_port.toml"}
{"title": "Potential Cookies Theft via Browser Debugging", "description": "Identifies the execution of a Chromium based browser with the debugging process argument, which may indicate an attempt\nto steal authentication cookies. An adversary may steal web application or service session cookies and use them to gain\naccess web applications or Internet services as an authenticated user without needing credentials.", "query": "process where event.type in (\"start\", \"process_started\", \"info\") and\n  process.name in (\n             \"Microsoft Edge\",\n             \"chrome.exe\",\n             \"Google Chrome\",\n             \"google-chrome-stable\",\n             \"google-chrome-beta\",\n             \"google-chrome\",\n             \"msedge.exe\") and\n   process.args : (\"--remote-debugging-port=*\",\n                   \"--remote-debugging-targets=*\",\n                   \"--remote-debugging-pipe=*\") and\n   process.args : \"--user-data-dir=*\" and not process.args:\"--remote-debugging-port=0\"", "tactic": "Credential Access", "technique": "Steal Web Session Cookie", "technique_id": "T1539", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_cookies_chromium_browsers_debugging.toml"}
{"title": "Active Directory Forced Authentication from Linux Host - SMB Named Pipes", "description": "Identifies a potential forced authentication using related SMB named pipes. Attackers may attempt to force targets to\nauthenticate to a host controlled by them to capture hashes or enable relay attacks.", "query": "sequence with maxspan=15s\n[network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.port == 445 and not startswith~(string(destination.ip), string(host.ip))] by host.ip, data_stream.namespace\n[file where host.os.type == \"windows\" and event.code == \"5145\" and file.name : (\"Spoolss\", \"netdfs\", \"lsarpc\", \"lsass\", \"netlogon\", \"samr\", \"efsrpc\", \"FssagentRpc\")] by source.ip, data_stream.namespace", "tactic": "Credential Access", "technique": "Forced Authentication", "technique_id": "T1187", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_forced_authentication_pipes.toml"}
{"title": "Agent Spoofing - Mismatched Agent ID", "description": "Detects events that have a mismatch on the expected event agent ID. The status \"agent_id_mismatch/mismatch\" occurs when\nthe expected agent ID associated with the API key does not match the actual agent ID in an event. This could indicate\nattempts to spoof events in order to masquerade actual activity to evade detection.", "query": "event.agent_id_status:(agent_id_mismatch or mismatch)", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_agent_spoofing_mismatched_id.toml"}
{"title": "Agent Spoofing - Multiple Hosts Using Same Agent", "description": "Detects when multiple hosts are using the same agent ID. This could occur in the event of an agent being taken over and\nused to inject illegitimate documents into an instance as an attempt to spoof events in order to masquerade actual\nactivity to evade detection.", "query": "event.agent_id_status:* and not tags:forwarded", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_agent_spoofing_multiple_hosts.toml"}
{"title": "WebServer Access Logs Deleted", "description": "Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensic\nevidence on a system.", "query": "file where event.type == \"deletion\" and\n  file.path : (\"C:\\\\inetpub\\\\logs\\\\LogFiles\\\\*.log\",\n               \"/var/log/apache*/access.log\",\n               \"/etc/httpd/logs/access_log\",\n               \"/var/log/httpd/access_log\",\n               \"/var/www/*/logs/access.log\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_deleting_websvr_access_logs.toml"}
{"title": "Tampering of Shell Command-Line History", "description": "Adversaries may attempt to clear or disable the Bash command-line history in an attempt to evade detection or forensic\ninvestigations.", "query": "process where event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and event.type == \"start\" and\n (\n  ((process.args : (\"rm\", \"echo\") or\n    (process.args : \"ln\" and process.args : \"-sf\" and process.args : \"/dev/null\") or\n    (process.args : \"truncate\" and process.args : \"-s0\"))\n    and process.args : (\".bash_history\", \"/root/.bash_history\", \"/home/*/.bash_history\",\"/Users/.bash_history\", \"/Users/*/.bash_history\",\n                        \".zsh_history\", \"/root/.zsh_history\", \"/home/*/.zsh_history\", \"/Users/.zsh_history\", \"/Users/*/.zsh_history\")) or\n  (process.args : \"history\" and process.args : \"-c\") or\n  (process.args : \"export\" and process.args : (\"HISTFILE=/dev/null\", \"HISTFILESIZE=0\")) or\n  (process.args : \"unset\" and process.args : \"HISTFILE\") or\n  (process.args : \"set\" and process.args : \"history\" and process.args : \"+o\")\n )", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_deletion_of_bash_command_line_history.toml"}
{"title": "Elastic Agent Service Terminated", "description": "Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to\ndisable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This\nmay also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a\nstable state.", "query": "process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : (\"stop\", \"disable\"))\n  or\n  /* pkill , killall used to stop Elastic Agent on Linux */\n  ( event.type == \"end\" and process.name : (\"pkill\", \"killall\") and process.args: \"elastic-agent\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_elastic_agent_service_terminated.toml"}
{"title": "ROT Encoded Python Script Execution", "description": "Identifies the execution of a Python script that uses the ROT cipher for letters substitution. Adversaries may\nuse this method to encode and obfuscate part of their malicious code in legit python packages.", "query": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type in (\"windows\", \"macos\") and event.type == \"start\" and process.name : \"python*\"]\n [file where host.os.type in (\"windows\", \"macos\") and\n  event.action != \"deletion\" and process.name : \"python*\" and file.name : \"rot_??.cpython-*.pyc*\"]", "tactic": "Defense Evasion", "technique": "Deobfuscate/Decode Files or Information", "technique_id": "T1140", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_encoding_rot13_python_script.toml"}
{"title": "Masquerading Space After Filename", "description": "This rules identifies a process created from an executable with a space appended to the end of the filename. This may\nindicate an attempt to masquerade a malicious file as benign to gain user execution. When a space is added to the end of\ncertain files, the OS will execute the file according to it's true filetype instead of it's extension. Adversaries can\nhide a program's true filetype by changing the extension of the file. They can then add a space to the end of the name\nso that the OS automatically executes the file when it's double-clicked.", "query": "process where host.os.type:(\"linux\",\"macos\") and event.type == \"start\" and\nprocess.executable regex~ \"\"\"/[a-z0-9\\s_\\-\\\\./]+\\s\"\"\" and not (\n  process.name in (\"ls\", \"find\", \"grep\", \"xkbcomp\") or\n  process.executable like (\"/opt/nessus_agent/*\", \"/opt/gitlab/sv/gitlab-exporter/*\", \"/tmp/ansible-admin/*\") or\n  process.parent.args in (\n    \"./check_rubrik\", \"/usr/bin/check_mk_agent\", \"/etc/rubrik/start_stop_bootstrap.sh\", \"/etc/rubrik/start_stop_agent.sh\"\n  )\n)", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_space_after_filename.toml"}
{"title": "Timestomping using Touch Command", "description": "Timestomping is an anti-forensics technique which is used to modify the timestamps of a file, often to mimic files that\nare in the same folder.", "query": "process where event.type == \"start\" and\n process.name : \"touch\" and user.id != \"0\" and\n process.args : (\"-r\", \"-t\", \"-a*\",\"-m*\") and\n not process.args : (\n   \"/usr/lib/go-*/bin/go\", \"/usr/lib/dracut/dracut-functions.sh\", \"/tmp/KSInstallAction.*/m/.patch/*\"\n) and not process.parent.name in (\"pmlogger_daily\", \"pmlogger_janitor\", \"systemd\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_timestomp_touch.toml"}
{"title": "Security Software Discovery via Grep", "description": "Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirus\nor Host Firewall details.", "query": "process where event.type == \"start\" and\nprocess.name : \"grep\" and user.id != \"0\" and\n not process.parent.executable : (\"/Library/Application Support/*\", \"/opt/McAfee/agent/scripts/ma\") and\n   process.args :\n         (\"Little Snitch*\",\n          \"Avast*\",\n          \"Avira*\",\n          \"ESET*\",\n          \"BlockBlock*\",\n          \"360Sec*\",\n          \"LuLu*\",\n          \"KnockKnock*\",\n          \"kav\",\n          \"KIS\",\n          \"RTProtectionDaemon*\",\n          \"Malware*\",\n          \"VShieldScanner*\",\n          \"WebProtection*\",\n          \"webinspectord*\",\n          \"McAfee*\",\n          \"isecespd*\",\n          \"macmnsvc*\",\n          \"masvc*\",\n          \"kesl*\",\n          \"avscan*\",\n          \"guard*\",\n          \"rtvscand*\",\n          \"symcfgd*\",\n          \"scmdaemon*\",\n          \"symantec*\",\n          \"sophos*\",\n          \"osquery*\",\n          \"elastic-endpoint*\"\n          ) and\n   not (\n     (process.args : \"Avast\" and process.args : \"Passwords\") or\n     (process.args == \"osquery.conf\") or \n     (process.parent.args : \"/opt/McAfee/agent/scripts/ma\" and process.parent.args : \"checkhealth\") or\n     (process.command_line : (\n       \"grep ESET Command-line scanner, version %s -A2\",\n       \"grep -i McAfee Web Gateway Core version:\",\n       \"grep --color=auto ESET Command-line scanner, version %s -A2\"\n       )\n     ) or\n     (process.parent.command_line : (\n       \"\"\"sh -c printf \"command_start_%s\"*; perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1; printf \"command_done_%s*\"\"\",\n       \"\"\"bash -c perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1 \"\"\"       )\n     )\n    )", "tactic": "Discovery", "technique": "Software Discovery", "technique_id": "T1518", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_security_software_grep.toml"}
{"title": "Virtual Machine Fingerprinting via Grep", "description": "An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies\ncommon locations used to discover virtual machine hardware by a non-root user. This technique has been used by the Pupy\nRAT and other malware.", "query": "process where event.type == \"start\" and\n process.name in (\"grep\", \"egrep\") and user.id != \"0\" and\n process.args : (\"parallels*\", \"vmware*\", \"virtualbox*\") and process.args : \"Manufacturer*\" and\n not process.parent.executable in (\"/Applications/Docker.app/Contents/MacOS/Docker\", \"/usr/libexec/kcare/virt-what\")", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_virtual_machine_fingerprinting_grep.toml"}
{"title": "AWS SSM `SendCommand` with Run Shell Command Parameters", "description": "Identifies the use of the AWS Systems Manager (SSM) `SendCommand` API with the either `AWS-RunShellScript` or\n`AWS-RunPowerShellScript` parameters. The `SendCommand` API call allows users to execute commands on EC2 instances using\nthe SSM service. Adversaries may use this technique to execute commands on EC2 instances without the need for SSH or RDP\naccess. This behavior may indicate an adversary attempting to execute commands on an EC2 instance for malicious\npurposes. This is a [New Terms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that only flags\nwhen this behavior is observed for the first time on a host in the last 7 days.", "query": "event.category: \"process\" and event.type: \"start\" and process.name: \"aws\"\nand (\n    host.os.type: (\"windows\" or \"macos\")\n    or (\n        host.os.type: \"linux\"\n        and event.action: (\"exec\" or \"exec_event\" or \"executed\" or \"process_started\")\n    )\n)\nand process.args: (\n    \"send-command\" and \"--parameters\" and commands=*\n    and (\"AWS-RunShellScript\" or \"AWS-RunPowerShellScript\")\n)", "tactic": "Execution", "technique": "Cloud Administration Command", "technique_id": "T1651", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_aws_ssm_sendcommand_with_command_parameters.toml"}
{"title": "EggShell Backdoor Execution", "description": "Identifies the execution of and EggShell Backdoor. EggShell is a known post exploitation tool for macOS and Linux.", "query": "event.category:process and event.type:(process_started or start) and process.name:espl and process.args:eyJkZWJ1ZyI6*", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_pentest_eggshell_remote_admin_tool.toml"}
{"title": "Potential Widespread Malware Infection Across Multiple Hosts", "description": "This rule uses alert data to determine when a malware signature is triggered in multiple hosts. Analysts can use this to\nprioritize triage and response, as this can potentially indicate a widespread malware infection.", "query": "from logs-endpoint.alerts-*\n| where event.code in (\"malicious_file\", \"memory_signature\", \"shellcode_thread\") and rule.name is not null\n| keep host.id, rule.name, event.code\n| stats hosts = count_distinct(host.id) by rule.name, event.code\n| where hosts >= 3", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_potential_widespread_malware_infection.toml"}
{"title": "Potential Reverse Shell Activity via Terminal", "description": "Identifies the execution of a shell process with suspicious arguments which may be indicative of reverse shell activity.", "query": "process where event.type in (\"start\", \"process_started\") and\n  process.name in (\"sh\", \"bash\", \"zsh\", \"dash\", \"zmodload\") and\n  process.args : (\"*/dev/tcp/*\", \"*/dev/udp/*\", \"*zsh/net/tcp*\", \"*zsh/net/udp*\") and\n\n  /* noisy FPs */\n  not (process.parent.name : \"timeout\" and process.executable : \"/var/lib/docker/overlay*\") and\n  not process.command_line : (\n    \"*/dev/tcp/sirh_db/*\", \"*/dev/tcp/remoteiot.com/*\", \"*dev/tcp/elk.stag.one/*\", \"*dev/tcp/kafka/*\",\n    \"*/dev/tcp/$0/$1*\", \"*/dev/tcp/127.*\", \"*/dev/udp/127.*\", \"*/dev/tcp/localhost/*\", \"*/dev/tcp/itom-vault/*\") and\n  not process.parent.command_line : \"runc init\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_revershell_via_shell_cmd.toml"}
{"title": "Potential JAVA/JNDI Exploitation Attempt", "description": "Identifies an outbound network connection by JAVA to LDAP, RMI or DNS standard ports followed by a suspicious JAVA child\nprocesses. This may indicate an attempt to exploit a JAVA/NDI (Java Naming and Directory Interface) injection\nvulnerability.", "query": "sequence by host.id with maxspan=1m\n [network where event.action == \"connection_attempted\" and\n  process.name : \"java\" and\n  /*\n     outbound connection attempt to\n     LDAP, RMI or DNS standard ports\n     by JAVA process\n   */\n  destination.port in (1389, 389, 1099, 53, 5353)] by process.pid\n [process where event.type == \"start\" and\n\n  /* Suspicious JAVA child process */\n  process.parent.name : \"java\" and\n   process.name : (\"sh\",\n                   \"bash\",\n                   \"dash\",\n                   \"ksh\",\n                   \"tcsh\",\n                   \"zsh\",\n                   \"curl\",\n                   \"perl*\",\n                   \"python*\",\n                   \"ruby*\",\n                   \"php*\",\n                   \"wget\") and\n    not process.command_line like~ (\n      \"bash -c ulimit -u\",\n      \"bash /opt/flutter/bin/flutter*\",\n      \"bash -c echo $$\",\n      \"/bin/bash /opt/python3/bin/jira*\",\n      \"/bin/sh -c env LC_ALL=C /usr/sbin/lpc status*\"\n    )] by process.parent.pid", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_java_netcon_childproc.toml"}
{"title": "My First Rule", "description": "This rule helps you test and practice using alerts with Elastic Security as you get set up. It\u2019s not a sign of threat\nactivity.", "query": "event.kind:event", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "guided_onboarding_sample_rule.toml"}
{"title": "Hosts File Modified", "description": "The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the first\npoint of lookup for DNS hostname resolution so if adversaries can modify the endpoint hosts file, they can route traffic\nto malicious infrastructure. This rule detects modifications to the hosts file on Microsoft Windows, Linux (Ubuntu or\nRHEL) and macOS systems.", "query": "any where\n\n  /* file events for creation; file change events are not captured by some of the included sources for linux and so may\n     miss this, which is the purpose of the process + command line args logic below */\n  (\n   event.category == \"file\" and event.type in (\"change\", \"creation\") and\n     file.path : (\"/private/etc/hosts\", \"/etc/hosts\", \"?:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts\") and \n     not process.name in (\"dockerd\", \"rootlesskit\", \"podman\", \"crio\")\n  )\n  or\n\n  /* process events for change targeting linux only */\n  (\n   event.category == \"process\" and event.type in (\"start\") and\n     process.name in (\"nano\", \"vim\", \"vi\", \"emacs\", \"echo\", \"sed\") and\n     process.args : (\"/etc/hosts\") and \n     not process.parent.name in (\"dhclient-script\", \"google_set_hostname\")\n  )", "tactic": "Impact", "technique": "Data Manipulation", "technique_id": "T1565", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_hosts_file_modified.toml"}
{"title": "Microsoft Azure or Mail Sign-in from a Suspicious Source", "description": "This rule correlate Azure or Office 356 mail successful sign-in events with network security alerts by source.ip.\nAdversaries may trigger some network security alerts such as reputation or other anomalies before accessing cloud resources.", "query": "FROM logs-*, .alerts-security.*\n// query runs every 1 hour looking for activities occured during last 8 hours to match on disparate events\n| where @timestamp > NOW() - 8 hours\n// filter for Azure or M365 sign-in and External Alerts with source.ip not null\n| where TO_IP(source.ip) is not null and (event.dataset in (\"o365.audit\", \"azure.signinlogs\") or kibana.alert.rule.name == \"External Alerts\") and\n// exclude private IP ranges\n  not CIDR_MATCH(TO_IP(source.ip), \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n| keep source.ip, event.action, event.outcome, event.dataset, kibana.alert.rule.name, event.category\n// split alerts to 3 buckets -  M365 mail access, azure sign-in and network related external alerts like NGFW and IDS\n| eval mail_access_src_ip = case(event.dataset == \"o365.audit\" and event.action == \"MailItemsAccessed\" and event.outcome == \"success\", TO_IP(source.ip), null),\n  azure_src_ip = case(event.dataset == \"azure.signinlogs\" and event.outcome == \"success\", TO_IP(source.ip), null),\n  network_alert_src_ip = case(kibana.alert.rule.name == \"External Alerts\" and not event.dataset in (\"o365.audit\", \"azure.signinlogs\"), TO_IP(source.ip), null)\n// aggregated alerts count by bucket and by source.ip\n| stats total_alerts = count(*), is_mail_access = COUNT_DISTINCT(mail_access_src_ip), is_azure = COUNT_DISTINCT(azure_src_ip), unique_dataset = COUNT_DISTINCT(event.dataset),is_network_alert = COUNT_DISTINCT(network_alert_src_ip), datasets = VALUES(event.dataset), rules = VALUES(kibana.alert.rule.name), cat = VALUES(event.category) by source_ip = TO_IP(source.ip)\n// filter for cases where there is a successful sign-in to azure or m365 mail and the source.ip is reported by a network external alert.\n| where is_network_alert  > 0 and unique_dataset >= 2 and (is_mail_access > 0 or is_azure > 0) and total_alerts <= 100", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_azure_o365_with_network_alert.toml"}
{"title": "Zoom Meeting with no Passcode", "description": "This rule identifies Zoom meetings that are created without a passcode. Meetings without a passcode are susceptible to\nZoombombing. Zoombombing is carried out by taking advantage of Zoom sessions that are not protected with a passcode.\nZoombombing refers to the unwanted, disruptive intrusion, generally by Internet trolls and hackers, into a video\nconference call. In a typical Zoombombing incident, a teleconferencing session is hijacked by the insertion of material\nthat is lewd, obscene, racist, or antisemitic in nature, typically resulting of the shutdown of the session.", "query": "event.type:creation and event.module:zoom and event.dataset:zoom.webhook and\n  event.action:meeting.created and not zoom.meeting.password:*", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_zoom_meeting_with_no_passcode.toml"}
{"title": "Multiple Alerts in Different ATT&CK Tactics on a Single Host", "description": "This rule uses alert data to determine when multiple alerts in different phases of an attack involving the same host are\ntriggered. Analysts can use this to prioritize triage and response, as these hosts are more likely to be compromised.", "query": "signal.rule.name:* and kibana.alert.rule.threat.tactic.id:*", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "multiple_alerts_different_tactics_host.toml"}
{"title": "Multiple Alerts Involving a User", "description": "This rule uses alert data to determine when multiple different alerts involving the same user are triggered. Analysts\ncan use this to prioritize triage and response, as these users are more likely to be compromised.", "query": "signal.rule.name:* and user.name:* and not user.id:(\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\")", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "multiple_alerts_involving_user.toml"}
{"title": "Modification of Standard Authentication Module or Configuration", "description": "Adversaries may modify the standard authentication module for persistence via patching the normal authorization process\nor modifying the login configuration to allow unauthorized access or elevate privileges.", "query": "event.category:file and event.type:change and\n  (file.name:pam_*.so or file.path:(/etc/pam.d/* or /private/etc/pam.d/* or /usr/lib64/security/*)) and\n  process.executable:\n    (* and\n      not\n      (\n        /usr/libexec/packagekitd or\n        /usr/bin/vim or\n        /usr/libexec/xpcproxy or\n        /usr/bin/bsdtar or\n        /usr/local/bin/brew or\n        \"/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service\"\n      )\n    ) and\n  not file.path:\n         (\n           /tmp/snap.rootfs_*/pam_*.so or\n           /tmp/newroot/lib/*/pam_*.so or\n           /private/var/folders/*/T/com.apple.fileprovider.ArchiveService/TemporaryItems/*/lib/security/pam_*.so or\n           /tmp/newroot/usr/lib64/security/pam_*.so\n         ) and\n  not process.name:\n         (\n           yum or dnf or rsync or platform-python or authconfig or rpm or pdkg or apk or dnf-automatic or btrfs or\n           dpkg or pam-auth-update or steam or platform-python3.6 or pam-config or microdnf or yum_install or yum-cron or\n           systemd or containerd or pacman\n         )", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_credential_access_modify_auth_module_or_config.toml"}
{"title": "Bash Shell Profile Modification", "description": "Both ~/.bash_profile and ~/.bashrc are files containing shell commands that are run when Bash is invoked. These files\nare executed in a user's context, either interactively or non-interactively, when a user logs in so that their\nenvironment is set correctly. Adversaries may abuse this to establish persistence by executing malicious content\ntriggered by a user\u2019s shell.", "query": "event.category:file and event.type:change and\n  process.name:(* and not (sudo or vim or zsh or env or nano or bash or Terminal or xpcproxy or login or cat or cp or\n  launchctl or java or dnf or tailwatchd or ldconfig or yum or semodule or cpanellogd or dockerd or authselect or chmod or\n  dnf-automatic or git or dpkg or platform-python)) and\n  not process.executable:(/Applications/* or /private/var/folders/* or /usr/local/* or /opt/saltstack/salt/bin/*) and\n  file.path:(/private/etc/rc.local or\n             /etc/rc.local or\n             /home/*/.profile or\n             /home/*/.profile1 or\n             /home/*/.bash_profile or\n             /home/*/.bash_profile1 or\n             /home/*/.bashrc or\n             /Users/*/.bash_profile or\n             /Users/*/.zshenv)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_shell_profile_modification.toml"}
{"title": "SSH Authorized Keys File Modification", "description": "The Secure Shell (SSH) authorized_keys file specifies which users are allowed to log into a server using public key\nauthentication. Adversaries may modify it to maintain persistence on a victim host by adding their own public key(s).", "query": "event.category:file and event.type:(change or creation) and\n file.name:(\"authorized_keys\" or \"authorized_keys2\" or \"/etc/ssh/sshd_config\" or \"/root/.ssh\") and\n not process.executable:\n             (/Library/Developer/CommandLineTools/usr/bin/git or\n              /usr/local/Cellar/maven/*/libexec/bin/mvn or\n              /Library/Java/JavaVirtualMachines/jdk*.jdk/Contents/Home/bin/java or\n              /usr/bin/vim or\n              /usr/local/Cellar/coreutils/*/bin/gcat or\n              /usr/bin/bsdtar or\n              /usr/bin/nautilus or\n              /usr/bin/scp or\n              /usr/bin/touch or\n              /var/lib/docker/* or\n              /usr/bin/google_guest_agent or\n              /opt/jc/bin/jumpcloud-agent or\n              /opt/puppetlabs/puppet/bin/puppet or\n              /usr/bin/chef-client\n)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ssh_authorized_keys_modification.toml"}
{"title": "Potential Privilege Escalation via Sudoers File Modification", "description": "A sudoers file specifies the commands users or groups can run and from which terminals. Adversaries can take advantage\nof these configurations to execute commands as other users or spawn processes with higher privileges.", "query": "event.category:process and event.type:start and process.args:(echo and *NOPASSWD*ALL*)", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_echo_nopasswd_sudoers.toml"}
{"title": "SUID/SGID Bit Set", "description": "An adversary may add the setuid or setgid bit to a file or directory in order to run a file with the privileges of the\nowning user or group. An adversary can take advantage of this to either do a shell escape or exploit a vulnerability in\nan application with the setuid or setgid bit to get code running in a different user\u2019s context. Additionally,\nadversaries can use this mechanism on their own malware to make sure they're able to execute in elevated contexts in the\nfuture.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name == \"chmod\" and (process.args : (\"+s\", \"u+s\", \"g+s\") or process.args regex \"[24][0-9]{3}\")) or\n  (process.name == \"install\" and process.args : \"-m\" and\n  (process.args : (\"+s\", \"u+s\", \"g+s\") or process.args regex \"[24][0-9]{3}\"))\n) and not (\n  process.parent.executable : (\n    \"/usr/NX/*\", \"/var/lib/docker/*\", \"/var/lib/dpkg/info*\", \"/tmp/newroot/*\",\n    \"/System/Library/PrivateFrameworks/PackageKit.framework/Versions/A/XPCServices/package_script_service.xpc/Contents/MacOS/package_script_service\"\n  ) or\n  process.args : (\n    \"/run/*\", \"/var/run/*\", \"/usr/bin/keybase-redirector\", \"/usr/local/share/fonts\", \"/usr/bin/ssh-agent\"\n  )\n)", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_setuid_setgid_bit_set_via_chmod.toml"}
{"title": "Sudoers File Modification", "description": "A sudoers file specifies the commands that users or groups can run and from which terminals. Adversaries can take\nadvantage of these configurations to execute commands as other users or spawn processes with higher privileges.", "query": "event.category:file and event.type:change and file.path:(/etc/sudoers* or /private/etc/sudoers*) and\nnot process.name:(dpkg or platform-python or puppet or yum or dnf) and\nnot process.executable:(/opt/chef/embedded/bin/ruby or /opt/puppetlabs/puppet/bin/ruby or /usr/bin/dockerd)", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sudoers_file_mod.toml"}
{"title": "Sudo Heap-Based Buffer Overflow Attempt", "description": "Identifies the attempted use of a heap-based buffer overflow vulnerability for the Sudo binary in Unix-like systems\n(CVE-2021-3156). Successful exploitation allows an unprivileged user to escalate to the root user.", "query": "event.category:process and event.type:start and\n  process.name:(sudo or sudoedit) and\n  process.args:(*\\\\ and (\"-i\" or \"-s\"))", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sudo_buffer_overflow.toml"}
{"title": "AWS S3 Unauthenticated Bucket Access by Rare Source", "description": "Identifies AWS CloudTrail events where an unauthenticated source is attempting to access an S3 bucket. This activity may\nindicate a misconfigured S3 bucket policy that allows public access to the bucket, potentially exposing sensitive data\nto unauthorized users. Adversaries can specify `--no-sign-request` in the AWS CLI to retrieve objects from an S3 bucket\nwithout authentication. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule, which means it\nwill only trigger once for each unique value of the `source.address` field that has not been seen making this API\nrequest within the last 7 days. This field contains the IP address of the source making the request.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"s3.amazonaws.com\"\n    and event.action: (\n        \"GetObject\" or\n        \"PutObject\" or\n        \"ListObjects\" or\n        \"DeleteObject\" or\n        \"ListBucket\")\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: (\"AWSAccount\" or \"Unknown\")\n    and cloud.account.id: \"anonymous\"", "tactic": "Collection", "technique": "Data from Cloud Storage", "technique_id": "T1530", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_s3_unauthenticated_bucket_access_by_rare_source.toml"}
{"title": "AWS EC2 Unauthorized Admin Credential Fetch via Assumed Role", "description": "Identifies the first occurrence of an unauthorized attempt by an AWS role to use `GetPassword` to access the administrator password of an EC2 instance.\nAdversaries may use this API call to escalate privileges or move laterally within EC2 instances.", "query": "event.dataset:\"aws.cloudtrail\"\n    and event.provider:\"ec2.amazonaws.com\" and event.action:\"GetPasswordData\"\n    and aws.cloudtrail.user_identity.type:\"AssumedRole\" and aws.cloudtrail.error_code:\"Client.UnauthorizedOperation\"", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_aws_getpassword_for_ec2_instance.toml"}
{"title": "AWS IAM Brute Force of Assume Role Policy", "description": "Identifies a high number of failed attempts to assume an AWS Identity and Access Management (IAM) role. IAM roles are\nused to delegate access to users or services. An adversary may attempt to enumerate IAM roles in order to determine if a\nrole exists before attempting to assume or hijack the discovered role.", "query": "event.dataset:aws.cloudtrail and\n  event.provider:iam.amazonaws.com and event.action:UpdateAssumeRolePolicy and\n  aws.cloudtrail.error_code:MalformedPolicyDocumentException and event.outcome:failure", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_aws_iam_assume_role_brute_force.toml"}
{"title": "AWS IAM CompromisedKeyQuarantine Policy Attached to User", "description": "This rule looks for use of the IAM `AttachUserPolicy` API operation to attach the `CompromisedKeyQuarantine` or `CompromisedKeyQuarantineV2` AWS managed policies to an existing IAM user.\nThis policy denies access to certain actions and is applied by the AWS team in the event that an IAM user's credentials have been compromised or exposed publicly.", "query": "any where event.dataset == \"aws.cloudtrail\"\n   and event.action == \"AttachUserPolicy\"\n   and event.outcome == \"success\"\n   and stringContains(aws.cloudtrail.request_parameters, \"AWSCompromisedKeyQuarantine\")", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_iam_compromisedkeyquarantine_policy_attached_to_user.toml"}
{"title": "AWS IAM User Addition to Group", "description": "Identifies the addition of a user to a specified group in AWS Identity and Access Management (IAM).", "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:AddUserToGroup and event.outcome:success", "tactic": "Credential Access", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_iam_user_addition_to_group.toml"}
{"title": "First Time Seen AWS Secret Value Accessed in Secrets Manager", "description": "An adversary with access to a compromised AWS service such as an EC2 instance, Lambda function, or other service may\nattempt to leverage the compromised service to access secrets in AWS Secrets Manager. This rule looks for the first time\na specific user identity has programmatically retrieved a secret value from Secrets Manager using the `GetSecretValue`\nor `BatchGetSecretValue` actions. This rule assumes that AWS services such as Lambda functions and EC2 instances are\nsetup with IAM role's assigned that have the necessary permissions to access the secrets in Secrets Manager. An\nadversary with access to a compromised AWS service such as an EC2 instance, Lambda function, or other service would rely\non the compromised service's IAM role to access the secrets in Secrets Manager.", "query": "event.dataset:aws.cloudtrail and event.provider:secretsmanager.amazonaws.com and\n    event.action: (GetSecretValue or BatchGetSecretValue) and event.outcome:success and\n    not user_agent.name: (\"Chrome\" or \"Firefox\" or \"Safari\" or \"Edge\" or \"Brave\" or \"Opera\")", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_new_terms_secretsmanager_getsecretvalue.toml"}
{"title": "Rapid Secret Retrieval Attempts from AWS SecretsManager", "description": "This rule attempts to identify rapid secret retrieval attempts from AWS SecretsManager. Adversaries may attempt to\nretrieve secrets from the Secrets Manager programmatically using the `GetSecretValue` or `BatchGetSecretValue` API\nactions.", "query": "event.dataset:aws.cloudtrail and event.provider:secretsmanager.amazonaws.com and\n    event.action: (GetSecretValue or BatchGetSecretValue) and event.outcome:success and\n    not user_agent.name: (\"Chrome\" or \"Firefox\" or \"Safari\" or \"Edge\" or \"Brave\" or \"Opera\")", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_rapid_secret_retrieval_attempts_from_secretsmanager.toml"}
{"title": "AWS Systems Manager SecureString Parameter Request with Decryption Flag", "description": "Detects the first occurrence of a user identity accessing AWS Systems Manager (SSM) SecureString parameters using the\nGetParameter or GetParameters API actions with credentials in the request parameters. This could indicate that the user\nis accessing sensitive information. This rule detects when a user accesses a SecureString parameter with the\n`withDecryption` parameter set to true. This is a\n[NewTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that\ndetects the first occurrence of a specific AWS ARN accessing SecureString parameters with decryption within the last 10\ndays.", "query": "event.dataset: aws.cloudtrail\n    and event.provider: \"ssm.amazonaws.com\"\n    and event.action: (GetParameters or GetParameter)\n    and event.outcome: success\n    and aws.cloudtrail.flattened.request_parameters.withDecryption: true\n    and not source.address: (\n        \"cloudformation.amazonaws.com\" or\n        \"servicecatalog.amazonaws.com\"\n    )", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_retrieve_secure_string_parameters_via_ssm.toml"}
{"title": "AWS Management Console Brute Force of Root User Identity", "description": "Identifies a high number of failed authentication attempts to the AWS management console for the Root user identity. An\nadversary may attempt to brute force the password for the Root user identity, as it has complete access to all services\nand resources for the AWS account.", "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and aws.cloudtrail.user_identity.type:Root and event.outcome:failure", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_root_console_failure_brute_force.toml"}
{"title": "AWS CloudTrail Log Evasion", "description": "Identifies the evasion of cloudtrail logging for IAM actions involving policy creation, modification or attachment. When making certain policy-related API calls, an adversary may pad the associated policy document with whitespaces to trigger CloudTrail\u2019s logging size constraints, resulting in incomplete logging where critical details about the policy are omitted. By exploiting this gap, threat actors can bypass monitoring performed through CloudTrail and can effectively obscure unauthorized changes. This rule looks for IAM API calls with the requestParameters property containing reason:\u201drequestParameters too large\u201d and omitted:true.", "query": "event.dataset: aws.cloudtrail and event.provider: iam.amazonaws.com and aws.cloudtrail.flattened.request_parameters.reason: \"requestParameters too large\" and aws.cloudtrail.flattened.request_parameters.omitted : true and event.outcome: success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_cloudtrail_logging_evasion.toml"}
{"title": "AWS CloudTrail Log Suspended", "description": "Identifies suspending the recording of AWS API calls and log file delivery for the specified trail. An adversary may\nsuspend trails in an attempt to evade defenses.", "query": "event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:StopLogging and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_cloudtrail_logging_suspended.toml"}
{"title": "AWS CloudWatch Alarm Deletion", "description": "Identifies the deletion of an AWS CloudWatch alarm. An adversary may delete alarms in an attempt to evade defenses.", "query": "event.dataset:aws.cloudtrail and event.provider:monitoring.amazonaws.com and event.action:DeleteAlarms and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_cloudwatch_alarm_deletion.toml"}
{"title": "AWS Configuration Recorder Stopped", "description": "Identifies an AWS configuration change to stop recording a designated set of resources.", "query": "event.dataset:aws.cloudtrail and event.provider:config.amazonaws.com and event.action:StopConfigurationRecorder and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_configuration_recorder_stopped.toml"}
{"title": "AWS Config Resource Deletion", "description": "Identifies attempts to delete an AWS Config Service resource. An adversary may tamper with Config services in order to\nreduce visibility into the security posture of an account and / or its workload instances.", "query": "event.dataset:aws.cloudtrail and event.provider:config.amazonaws.com and\n    event.action:(DeleteConfigRule or DeleteOrganizationConfigRule or DeleteConfigurationAggregator or\n    DeleteConfigurationRecorder or DeleteConformancePack or DeleteOrganizationConformancePack or\n    DeleteDeliveryChannel or DeleteRemediationConfiguration or DeleteRetentionConfiguration)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_config_service_rule_deletion.toml"}
{"title": "AWS VPC Flow Logs Deletion", "description": "Identifies the deletion of one or more flow logs in AWS Elastic Compute Cloud (EC2). An adversary may delete flow logs in an attempt to evade defenses.", "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:DeleteFlowLogs and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ec2_flow_log_deletion.toml"}
{"title": "AWS EC2 Network Access Control List Deletion", "description": "Identifies the deletion of an Amazon Elastic Compute Cloud (EC2) network access control list (ACL) or one of its ingress/egress entries.", "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(DeleteNetworkAcl or DeleteNetworkAclEntry) and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ec2_network_acl_deletion.toml"}
{"title": "AWS ElastiCache Security Group Modified or Deleted", "description": "Identifies when an ElastiCache security group has been modified or deleted.", "query": "event.dataset:aws.cloudtrail and event.provider:elasticache.amazonaws.com and event.action:(\"Delete Cache Security Group\" or\n\"Authorize Cache Security Group Ingress\" or  \"Revoke Cache Security Group Ingress\" or \"AuthorizeCacheSecurityGroupEgress\" or\n\"RevokeCacheSecurityGroupEgress\") and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_elasticache_security_group_modified_or_deleted.toml"}
{"title": "AWS GuardDuty Detector Deletion", "description": "Identifies the deletion of an Amazon GuardDuty detector. Upon deletion, GuardDuty stops monitoring the environment and\nall existing findings are lost.", "query": "event.dataset:aws.cloudtrail and event.provider:guardduty.amazonaws.com and event.action:DeleteDetector and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_guardduty_detector_deletion.toml"}
{"title": "Route53 Resolver Query Log Configuration Deleted", "description": "Identifies when a Route53 Resolver Query Log Configuration is deleted. When a Route53 Resolver query log configuration\nis deleted, Resolver stops logging DNS queries and responses for the specified configuration. Adversaries may delete\nquery log configurations to evade detection or cover their tracks.", "query": "event.dataset:aws.cloudtrail and event.provider: route53resolver.amazonaws.com\n    and event.action: DeleteResolverQueryLogConfig and event.outcome: success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_route53_dns_query_resolver_config_deletion.toml"}
{"title": "AWS S3 Bucket Server Access Logging Disabled", "description": "Identifies when server access logging is disabled for an Amazon S3 bucket. Server access logs provide a detailed record of requests made to an S3 bucket.\nWhen server access logging is disabled for a bucket, it could indicate an adversary's attempt to impair defenses by disabling logs that contain evidence of malicious activity.", "query": "any where event.dataset == \"aws.cloudtrail\"\n   and event.action == \"PutBucketLogging\"\n   and event.outcome == \"success\"\n   and not stringContains(aws.cloudtrail.request_parameters, \"LoggingEnabled\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_s3_bucket_server_access_logging_disabled.toml"}
{"title": "AWS SQS Queue Purge", "description": "Identifies when an AWS Simple Queue Service (SQS) queue is purged. Adversaries may purge SQS queues to disrupt\noperations, delete messages, or impair monitoring and alerting mechanisms. This action can be used to evade detection\nand cover tracks by removing evidence of malicious activities.", "query": "event.dataset:\"aws.cloudtrail\"\n    and event.provider:\"sqs.amazonaws.com\"\n    and event.action:\"PurgeQueue\"\n    and event.outcome:\"success\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sqs_purge_queue.toml"}
{"title": "First Occurrence of STS GetFederationToken Request by User", "description": "Identifies the first occurrence of an AWS Security Token Service (STS) `GetFederationToken` request made by a user\nwithin the last 10 days. The `GetFederationToken` API call allows users to request temporary security credentials to\naccess AWS resources. Adversaries may use this API to obtain temporary credentials to access resources they would not\nnormally have access to.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: sts.amazonaws.com\n    and event.action: GetFederationToken", "tactic": "Defense Evasion", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sts_get_federation_token.toml"}
{"title": "Insecure AWS EC2 VPC Security Group Ingress Rule Added", "description": "Identifies when a specified inbound (ingress) rule is added or adjusted for a VPC security group in AWS EC2. This rule\ndetects when a security group rule is added that allows traffic from any IP address or from a specific IP address to\ncommon remote access ports, such as 22 (SSH) or 3389 (RDP). Adversaries may add these rules to allow remote access to\nVPC instances from any location, increasing the attack surface and potentially exposing the instances to unauthorized\naccess.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: ec2.amazonaws.com\n    and event.action: AuthorizeSecurityGroupIngress\n    and event.outcome: success\n    and aws.cloudtrail.flattened.request_parameters.cidrIp: (\"0.0.0.0/0\" or \"::/0\")\n    and aws.cloudtrail.flattened.request_parameters.fromPort: (\n        21 or 22 or 23 or 445 or 3389 or 5985 or 5986)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_vpc_security_group_ingress_rule_added_for_remote_connections.toml"}
{"title": "AWS WAF Rule or Rule Group Deletion", "description": "Identifies the deletion of a specified AWS Web Application Firewall (WAF) rule or rule group.", "query": "event.dataset:aws.cloudtrail and event.provider:(waf.amazonaws.com or waf-regional.amazonaws.com or wafv2.amazonaws.com) and event.action:(DeleteRule or DeleteRuleGroup) and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_waf_rule_or_rule_group_deletion.toml"}
{"title": "AWS Discovery API Calls via CLI from a Single Resource", "description": "Detects when a single AWS resource is running multiple `Describe` and `List` API calls in a 10-second window. This\nbehavior could indicate an actor attempting to discover the AWS infrastructure using compromised credentials or a\ncompromised instance. Adversaries may use this information to identify potential targets for further exploitation or to\ngain a better understanding of the target's infrastructure.", "query": "from logs-aws.cloudtrail*\n\n// create time window buckets of 10 seconds\n| eval time_window = date_trunc(10 seconds, @timestamp)\n| where\n    event.dataset == \"aws.cloudtrail\"\n\n    // filter on CloudTrail audit logs for IAM, EC2, and S3 events only\n    and event.provider in (\n      \"iam.amazonaws.com\",\n      \"ec2.amazonaws.com\",\n      \"s3.amazonaws.com\",\n      \"rds.amazonaws.com\",\n      \"lambda.amazonaws.com\",\n      \"dynamodb.amazonaws.com\",\n      \"kms.amazonaws.com\",\n      \"cloudfront.amazonaws.com\",\n      \"elasticloadbalancing.amazonaws.com\",\n      \"cloudfront.amazonaws.com\"\n    )\n\n    // ignore AWS service actions\n    and aws.cloudtrail.user_identity.type != \"AWSService\"\n\n    // filter for aws-cli specifically\n    and user_agent.name == \"aws-cli\"\n\n    // exclude DescribeCapacityReservations events related to AWS Config\n    and not event.action in (\"DescribeCapacityReservations\")\n\n// filter for Describe, Get, List, and Generate API calls\n| where true in (\n    starts_with(event.action, \"Describe\"),\n    starts_with(event.action, \"Get\"),\n    starts_with(event.action, \"List\"),\n    starts_with(event.action, \"Generate\")\n)\n// extract owner, identity type, and actor from the ARN\n| dissect aws.cloudtrail.user_identity.arn \"%{}::%{owner}:%{identity_type}/%{actor}\"\n| where starts_with(actor, \"AWSServiceRoleForConfig\") != true\n| keep @timestamp, time_window, event.action, aws.cloudtrail.user_identity.arn\n| stats\n    // count the number of unique API calls per time window and actor\n    unique_api_count = count_distinct(event.action) by time_window, aws.cloudtrail.user_identity.arn\n\n// filter for more than 5 unique API calls per time window\n| where unique_api_count > 5\n\n// sort the results by the number of unique API calls in descending order\n| sort unique_api_count desc", "tactic": "Discovery", "technique": "Cloud Infrastructure Discovery", "technique_id": "T1580", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ec2_multiple_discovery_api_calls_via_cli.toml"}
{"title": "AWS EC2 Multi-Region DescribeInstances API Calls", "description": "Identifies when a single AWS resource is making `DescribeInstances` API calls in more than 10 regions within a 30-second\nwindow. This could indicate a potential threat actor attempting to discover the AWS infrastructure across multiple\nregions using compromised credentials or a compromised instance. Adversaries may use this information to identify\npotential targets for further exploitation or to gain a better understanding of the target's infrastructure.", "query": "from logs-aws.cloudtrail-*\n\n// filter for DescribeInstances API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"ec2.amazonaws.com\" and event.action == \"DescribeInstances\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// keep only the relevant fields\n| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count >= 10 and window_count >= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc", "tactic": "Discovery", "technique": "Cloud Infrastructure Discovery", "technique_id": "T1580", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ec2_multi_region_describe_instances.toml"}
{"title": "AWS EC2 User Data Retrieval for EC2 Instance", "description": "Identifies discovery request DescribeInstanceAttribute with the attribute userData and instanceId in AWS CloudTrail\nlogs. This may indicate an attempt to retrieve user data from an EC2 instance. Adversaries may use this information to\ngather sensitive data from the instance such as hardcoded credentials or to identify potential vulnerabilities. This is\na New Terms rule that identifies the first time an IAM user or role requests the user data for a specific EC2 instance.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"ec2.amazonaws.com\"\n    and event.action: \"DescribeInstanceAttribute\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.flattened.request_parameters.attribute: \"userData\"\n    and not aws.cloudtrail.user_identity.invoked_by: (\n        \"AWS Internal\" or\n        \"cloudformation.amazonaws.com\"\n    )", "tactic": "Discovery", "technique": "Cloud Infrastructure Discovery", "technique_id": "T1580", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ec2_userdata_request_for_ec2_instance.toml"}
{"title": "AWS STS GetCallerIdentity API Called for the First Time", "description": "An adversary with access to a set of compromised credentials may attempt to verify that the credentials are valid and\ndetermine what account they are using. This rule looks for the first time an identity has called the\nSTS `GetCallerIdentity` API operation in the last 15 days, which may be an indicator of compromised credentials.\nA legitimate user would not need to call this operation as they should know the account they are using.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"GetCallerIdentity\"\n    and event.outcome: \"success\"\n    and not aws.cloudtrail.user_identity.type: \"AssumedRole\"", "tactic": "Discovery", "technique": "Account Discovery", "technique_id": "T1087", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_new_terms_sts_getcalleridentity.toml"}
{"title": "AWS Service Quotas Multi-Region `GetServiceQuota` Requests", "description": "Identifies when a single AWS resource is making `GetServiceQuota` API calls for the EC2 service quota L-1216C47A in more\nthan 10 regions within a 30-second window. Quota code L-1216C47A represents on-demand instances which are used by\nadversaries to deploy malware and mine cryptocurrency. This could indicate a potential threat actor attempting to\ndiscover the AWS infrastructure across multiple regions using compromised credentials or a compromised instance.", "query": "from logs-aws.cloudtrail-*\n\n// filter for GetServiceQuota API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"servicequotas.amazonaws.com\" and event.action == \"GetServiceQuota\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// pre-process the request parameters to extract the service code and quota code\n| dissect aws.cloudtrail.request_parameters \"{%{?service_code_key}=%{service_code}, %{?quota_code_key}=%{quota_code}}\"\n\n// filter for EC2 service quota L-1216C47A (vCPU on-demand instances)\n| where service_code == \"ec2\" and quota_code == \"L-1216C47A\"\n\n// keep only the relevant fields\n| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region, service_code, quota_code\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count >= 10 and window_count >= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc", "tactic": "Discovery", "technique": "Cloud Infrastructure Discovery", "technique_id": "T1580", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_servicequotas_multi_region_service_quota_requests.toml"}
{"title": "AWS Lambda Layer Added to Existing Function", "description": "Identifies when an Lambda Layer is added to an existing Lambda function. AWS layers are a way to share code and data\nacross multiple functions. By adding a layer to an existing function, an attacker can persist or execute code in the\ncontext of the function.", "query": "event.dataset: aws.cloudtrail\n    and event.provider: lambda.amazonaws.com\n    and event.outcome: success\n    and event.action: (PublishLayerVersion* or UpdateFunctionConfiguration)", "tactic": "Execution", "technique": "Serverless Execution", "technique_id": "T1648", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_lambda_external_layer_added_to_function.toml"}
{"title": "First Time AWS Cloudformation Stack Creation by User", "description": "This rule detects the first time a principal calls AWS Cloudwatch `CreateStack` or `CreateStackSet` API. Cloudformation\nis used to create a single collection of cloud resources called a stack, via a defined template file. An attacker with\nthe appropriate privileges could leverage Cloudformation to create specific resources needed to further exploit the\nenvironment. This is a new terms rule that looks for the first instance of this behavior in the last 10 days for a role\nor IAM user within a particular account.", "query": "event.dataset:aws.cloudtrail and event.provider:cloudformation.amazonaws.com and\n    event.action: (CreateStack or CreateStackSet) and event.outcome:success", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_new_terms_cloudformation_createstack.toml"}
{"title": "AWS SSM Command Document Created by Rare User", "description": "Identifies when an AWS Systems Manager (SSM) command document is created by a user who does not typically perform this\naction. Adversaries may create SSM command documents to execute commands on managed instances, potentially leading to\nunauthorized access, command and control, data exfiltration and more.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"ssm.amazonaws.com\"\n    and event.action: \"CreateDocument\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.response_elements: *documentType=Command*", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_ssm_command_document_created_by_rare_user.toml"}
{"title": "AWS SSM `SendCommand` Execution by Rare User", "description": "Detects the execution of commands or scripts on EC2 instances using AWS Systems Manager (SSM), such as `RunShellScript`,\n`RunPowerShellScript` or custom documents. While legitimate users may employ these commands for management tasks, they\ncan also be exploited by attackers with credentials to establish persistence, install malware, or execute reverse shells\nfor further access to compromised instances. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that looks for\nthe first instance of this behavior by the `aws.cloudtrail.user_identity.arn` field in the last 7 days.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"ssm.amazonaws.com\"\n    and event.action: \"SendCommand\"\n    and event.outcome: \"success\"\n    and not aws.cloudtrail.user_identity.arn: *AWSServiceRoleForAmazonSSM/StateManagerService*\n    and not source.address: (\n      \"ssm-guiconnect.amazonaws.com\" or\n      \"ssm.amazonaws.com\" or\n      \"inspector2.amazonaws.com\"\n    )", "tactic": "Execution", "technique": "Cloud Administration Command", "technique_id": "T1651", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_ssm_sendcommand_by_rare_user.toml"}
{"title": "AWS DynamoDB Scan by Unusual User", "description": "Identifies when an AWS DynamoDB table is scanned by a user who does not typically perform this action. Adversaries may\nuse the Scan operation to collect sensitive information or exfiltrate data from DynamoDB tables. This rule detects\nunusual user activity by monitoring for the Scan action in CloudTrail logs. This is a New Terms rule that only flags\nwhen this behavior is observed by the `aws.cloudtrail.user_identity.arn` for the first time in the last 14 days.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"dynamodb.amazonaws.com\"\n    and event.action: \"Scan\"\n    and event.outcome: \"success\"", "tactic": "Exfiltration", "technique": "Exfiltration Over Web Service", "technique_id": "T1567", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_dynamodb_scan_by_unusual_user.toml"}
{"title": "AWS DynamoDB Table Exported to S3", "description": "Identifies when an AWS DynamoDB table is exported to S3. Adversaries may use the ExportTableToPointInTime operation to\ncollect sensitive information or exfiltrate data from DynamoDB tables. This rule detects unusual user activity by\nmonitoring for the ExportTableToPointInTime action in CloudTrail logs. This is a New Terms rule that only flags when\nthis behavior is observed by the `aws.cloudtrail.user_identity.arn` for the first time in the last 14 days.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"dynamodb.amazonaws.com\"\n    and event.action: \"ExportTableToPointInTime\"\n    and aws.cloudtrail.flattened.request_parameters.dryRun: false", "tactic": "Exfiltration", "technique": "Exfiltration Over Web Service", "technique_id": "T1567", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_dynamodb_table_exported_to_s3.toml"}
{"title": "EC2 AMI Shared with Another Account", "description": "Identifies an AWS Amazon Machine Image (AMI) being shared with another AWS account. Adversaries with access may share an\nAMI with an external AWS account as a means of data exfiltration. AMIs can contain secrets, bash histories, code\nartifacts, and other sensitive data that adversaries may abuse if shared with unauthorized accounts. AMIs can be made\npublicly available accidentally as well.", "query": "event.dataset: \"aws.cloudtrail\" and event.provider: \"ec2.amazonaws.com\"\n    and event.action: ModifyImageAttribute and event.outcome: success\n    and aws.cloudtrail.request_parameters: (*imageId* and *add* and *userId*)", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ec2_ami_shared_with_separate_account.toml"}
{"title": "AWS EC2 EBS Snapshot Shared or Made Public", "description": "Identifies AWS EC2 EBS snaphots being shared with another AWS account or made public. EBS virtual disks can be copied\ninto snapshots, which can then be shared with an external AWS account or made public. Adversaries may attempt this in\norder to copy the snapshot into an environment they control, to access the data.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"ec2.amazonaws.com\" and event.action == \"ModifySnapshotAttribute\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?snapshotId}=%{snapshotId},%{?attributeType}=%{attributeType},%{?createVolumePermission}={%{operationType}={%{?items}=[{%{?userId}=%{userId}}]}}}\"\n| where operationType == \"add\" and cloud.account.id != userId\n| keep @timestamp, aws.cloudtrail.user_identity.arn, cloud.account.id, event.action, snapshotId, attributeType, operationType, userId, source.address", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ec2_ebs_snapshot_shared_with_another_account.toml"}
{"title": "Deprecated - AWS EC2 Snapshot Activity", "description": "An attempt was made to modify AWS EC2 snapshot attributes. Snapshots are sometimes shared by threat actors in order to\nexfiltrate bulk data from an EC2 fleet. If the permissions were modified, verify the snapshot was not shared with an\nunauthorized or unexpected AWS account.", "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:ModifySnapshotAttribute", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ec2_snapshot_change_activity.toml"}
{"title": "AWS EC2 VM Export Failure", "description": "Identifies an attempt to export an AWS EC2 instance. A virtual machine (VM) export may indicate an attempt to extract or\nexfiltrate information.", "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:CreateInstanceExportTask and event.outcome:failure", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ec2_vm_export_failure.toml"}
{"title": "AWS RDS DB Snapshot Shared with Another Account", "description": "Identifies an AWS RDS DB snapshot being shared with another AWS account. DB snapshots contain a full backup of an entire DB instance including sensitive data that can be abused if shared with unauthorized accounts or made public. Adversaries may use snapshots to restore a DB Instance in an environment they control as a means of data exfiltration.", "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"rds.amazonaws.com\"\n    and event.outcome == \"success\"\n    and event.action in (\"ModifyDBSnapshotAttribute\", \"ModifyDBClusterSnapshotAttribute\")\n    and stringContains(aws.cloudtrail.request_parameters, \"attributeName=restore\")\n    and stringContains(aws.cloudtrail.request_parameters, \"valuesToAdd=[*]\")", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_rds_snapshot_shared_with_another_account.toml"}
{"title": "AWS S3 Bucket Policy Added to Share with External Account", "description": "Identifies an AWS S3 bucket policy change to share permissions with an external account. Adversaries may attempt to\nbackdoor an S3 bucket by sharing it with an external account. This can be used to exfiltrate data or to provide access\nto other adversaries. This rule identifies changes to a bucket policy via the `PutBucketPolicy` API call where the\npolicy includes an `Effect=Allow` statement that does not contain the AWS account ID of the bucket owner.", "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"s3.amazonaws.com\"\n    and event.action == \"PutBucketPolicy\" and event.outcome == \"success\"\n    and stringContains(aws.cloudtrail.request_parameters, \"Effect=Allow\")\n    and not stringContains(aws.cloudtrail.request_parameters, aws.cloudtrail.recipient_account_id)", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_s3_bucket_policy_added_for_external_account_access.toml"}
{"title": "AWS S3 Bucket Replicated to Another Account", "description": "Identifies when the `PutBucketReplication` operation is used to replicate S3 objects to a bucket in another AWS account. Adversaries may use bucket replication to exfiltrate sensitive data to an environment they control.", "query": "any where event.dataset == \"aws.cloudtrail\"\n   and event.action == \"PutBucketReplication\"\n   and event.outcome == \"success\"\n   and stringContains(aws.cloudtrail.request_parameters, \"Account\")", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_s3_bucket_replicated_to_external_account.toml"}
{"title": "AWS SNS Email Subscription by Rare User", "description": "Identifies when an SNS topic is subscribed to by an email address of a user who does not typically perform this action.\nAdversaries may subscribe to an SNS topic to collect sensitive information or exfiltrate data via an external email\naddress.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sns.amazonaws.com\"\n    and event.action: \"Subscribe\"\n    and aws.cloudtrail.request_parameters: *protocol=email*", "tactic": "Exfiltration", "technique": "Exfiltration Over Web Service", "technique_id": "T1567", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_sns_email_subscription_by_rare_user.toml"}
{"title": "AWS EventBridge Rule Disabled or Deleted", "description": "Identifies when a user has disabled or deleted an EventBridge rule. This activity can result in an unintended loss of\nvisibility in applications or a break in the flow with other AWS services.", "query": "event.dataset:aws.cloudtrail and event.provider:eventbridge.amazonaws.com and event.action:(DeleteRule or DisableRule) and\nevent.outcome:success", "tactic": "Impact", "technique": "Service Stop", "technique_id": "T1489", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_aws_eventbridge_rule_disabled_or_deleted.toml"}
{"title": "AWS S3 Bucket Enumeration or Brute Force", "description": "Identifies a high number of failed S3 operations from a single source and account (or anonymous account) within a short\ntimeframe. This activity can be indicative of attempting to cause an increase in billing to an account for excessive\nrandom operations, cause resource exhaustion, or enumerating bucket names for discovery.", "query": "from logs-aws.cloudtrail*\n| where event.provider == \"s3.amazonaws.com\" and aws.cloudtrail.error_code == \"AccessDenied\"\n// keep only relevant fields\n| keep tls.client.server_name, source.address, cloud.account.id\n| stats failed_requests = count(*) by tls.client.server_name, source.address, cloud.account.id\n  // can modify the failed request count or tweak time window to fit environment\n  // can add `not cloud.account.id in (KNOWN)` or specify in exceptions\n| where failed_requests > 40", "tactic": "Impact", "technique": "Financial Theft", "technique_id": "T1657", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_aws_s3_bucket_enumeration_or_brute_force.toml"}
{"title": "AWS CloudTrail Log Updated", "description": "Identifies an update to an AWS log trail setting that specifies the delivery of log files.", "query": "event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:UpdateTrail and event.outcome:success", "tactic": "Impact", "technique": "Data Manipulation", "technique_id": "T1565", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_cloudtrail_logging_updated.toml"}
{"title": "AWS CloudWatch Log Group Deletion", "description": "Identifies the deletion of a specified AWS CloudWatch log group. When a log group is deleted, all the archived log\nevents associated with the log group are also permanently deleted.", "query": "event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogGroup and event.outcome:success", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_cloudwatch_log_group_deletion.toml"}
{"title": "AWS CloudWatch Log Stream Deletion", "description": "Identifies the deletion of an AWS CloudWatch log stream, which permanently deletes all associated archived log events\nwith the stream.", "query": "event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogStream and event.outcome:success", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_cloudwatch_log_stream_deletion.toml"}
{"title": "AWS EC2 EBS Snapshot Access Removed", "description": "Identifies the removal of access permissions from a shared AWS EC2 EBS snapshot. EBS snapshots are essential for data retention and disaster recovery. Adversaries may revoke or modify snapshot permissions to prevent legitimate users from accessing backups, thereby obstructing recovery efforts after data loss or destructive actions. This tactic can also be used to evade detection or maintain exclusive access to critical backups, ultimately increasing the impact of an attack and complicating incident response.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"ec2.amazonaws.com\" and event.action == \"ModifySnapshotAttribute\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?snapshotId}=%{snapshotId},%{?attributeType}=%{attributeType},%{?createVolumePermission}={%{operationType}={%{?items}=[{%{?userId}=%{userId}}]}}}\"\n| where operationType == \"remove\"\n| keep @timestamp, aws.cloudtrail.user_identity.arn, cloud.account.id, event.action, snapshotId, attributeType, operationType, userId, source.address", "tactic": "Impact", "technique": "Inhibit System Recovery", "technique_id": "T1490", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_ec2_ebs_snapshot_access_removed.toml"}
{"title": "AWS IAM Group Deletion", "description": "Identifies the deletion of a specified AWS Identity and Access Management (IAM) resource group. Deleting a resource\ngroup does not delete resources that are members of the group; it only deletes the group structure.", "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:DeleteGroup and event.outcome:success", "tactic": "Impact", "technique": "Account Access Removal", "technique_id": "T1531", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_iam_group_deletion.toml"}
{"title": "AWS KMS Customer Managed Key Disabled or Scheduled for Deletion", "description": "Identifies attempts to disable or schedule the deletion of an AWS KMS Customer Managed Key (CMK). Deleting an AWS KMS\nkey is destructive and potentially dangerous. It deletes the key material and all metadata associated with the KMS key\nand is irreversible. After a KMS key is deleted, the data that was encrypted under that KMS key can no longer be\ndecrypted, which means that data becomes unrecoverable.", "query": "event.dataset:aws.cloudtrail and event.provider:kms.amazonaws.com and event.action:(\"DisableKey\" or \"ScheduleKeyDeletion\") and event.outcome:success", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_kms_cmk_disabled_or_scheduled_for_deletion.toml"}
{"title": "AWS Deletion of RDS Instance or Cluster", "description": "Identifies the deletion of an Amazon Relational Database Service (RDS) Aurora database cluster, global database cluster,\nor database instance.", "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:(DeleteDBCluster or DeleteGlobalCluster or DeleteDBInstance)\nand event.outcome:success", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_rds_instance_cluster_deletion.toml"}
{"title": "AWS RDS DB Instance or Cluster Deletion Protection Disabled", "description": "Identifies the modification of an AWS RDS DB instance or cluster to remove the deletionProtection feature. Deletion protection is enabled automatically for instances set up through the console and can be used to protect them from unintentional deletion activity. If disabled an instance or cluster can be deleted, destroying sensitive or critical information. Adversaries with the proper permissions can take advantage of this to set up future deletion events against a compromised environment.", "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"rds.amazonaws.com\"\n    and event.action in (\"ModifyDBInstance\", \"ModifyDBCluster\")\n    and event.outcome == \"success\"\n    and stringContains(aws.cloudtrail.request_parameters, \"deletionProtection=false\")", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_rds_instance_cluster_deletion_protection_disabled.toml"}
{"title": "AWS RDS Snapshot Deleted", "description": "Identifies the deletion of an AWS RDS DB snapshot. Snapshots contain a full backup of an entire DB instance. Unauthorized deletion of snapshots can make it impossible to recover critical or sensitive data. This rule detects deleted snapshots and instances modified so that backupRetentionPeriod is set to 0 which disables automated backups and is functionally similar to deleting the system snapshot.", "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"rds.amazonaws.com\"\n    and event.outcome == \"success\"\n    and (\n        event.action in (\"DeleteDBSnapshot\", \"DeleteDBClusterSnapshot\") or\n        (event.action == \"ModifyDBInstance\" and stringContains(aws.cloudtrail.request_parameters, \"backupRetentionPeriod=0\"))\n    )", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_rds_snapshot_deleted.toml"}
{"title": "Potential AWS S3 Bucket Ransomware Note Uploaded", "description": "Identifies potential ransomware note being uploaded to an AWS S3 bucket. This rule detects the `PutObject` S3 API call\nwith a common ransomware note file extension such as `.ransom`, or `.lock`. Adversaries with access to a misconfigured\nS3 bucket may retrieve, delete, and replace objects with ransom notes to extort victims.", "query": "from logs-aws.cloudtrail-*\n\n// any successful uploads via S3 API requests\n| where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"s3.amazonaws.com\"\n    and event.action == \"PutObject\"\n    and event.outcome == \"success\"\n\n// abstract object name from API request parameters\n| dissect aws.cloudtrail.request_parameters \"%{?ignore_values}key=%{object_name}}\"\n\n// regex on common ransomware note extensions\n| where object_name rlike \"(.*)(ransom|lock|crypt|enc|readme|how_to_decrypt|decrypt_instructions|recovery|datarescue)(.*)\"\n    and not object_name rlike \"(.*)(AWSLogs|CloudTrail|access-logs)(.*)\"\n\n// keep relevant fields\n| keep tls.client.server_name, aws.cloudtrail.user_identity.arn, object_name\n\n// aggregate by S3 bucket, resource and object name\n| stats note_upload_count = count(*) by tls.client.server_name, aws.cloudtrail.user_identity.arn, object_name\n\n// filter for single occurrence to eliminate common upload operations\n| where note_upload_count == 1", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_s3_bucket_object_uploaded_with_ransom_extension.toml"}
{"title": "Excessive AWS S3 Object Encryption with SSE-C", "description": "Identifies a high-volume of AWS S3 objects stored in a bucket using using Server-Side Encryption with Customer-Provided Keys\n(SSE-C). Adversaries with compromised AWS credentials can encrypt objects in an S3 bucket using their own encryption\nkeys, rendering the objects unreadable or recoverable without the key. This can be used as a form of ransomware to\nextort the bucket owner for the decryption key. This is a [Threshold](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-threshold-rule) rule that flags when\nthis behavior is observed for a specific bucket more than 15 times in a short time-window.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"s3.amazonaws.com\"\n    and event.action: \"PutObject\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.flattened.request_parameters.x-amz-server-side-encryption-customer-algorithm: \"AES256\"\n    and aws.cloudtrail.flattened.additional_eventdata.SSEApplied: \"SSE_C\"", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_s3_excessive_object_encryption_with_sse_c.toml"}
{"title": "AWS S3 Object Encryption Using External KMS Key", "description": "Identifies `CopyObject` events within an S3 bucket using an AWS KMS key from an external account for encryption.\nAdversaries with access to a misconfigured S3 bucket and the proper permissions may encrypt objects with an external KMS\nkey to deny their victims access to their own data.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n\n// any successful copy event\n| where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"s3.amazonaws.com\"\n    and event.action == \"CopyObject\"\n    and event.outcome == \"success\"\n\n// abstract key account id, key id, encrypted object bucket name and object name\n| dissect aws.cloudtrail.request_parameters \"{%{?bucketName}=%{target.bucketName},%{?x-amz-server-side-encryption-aws-kms-key-id}=%{?arn}:%{?aws}:%{?kms}:%{?region}:%{key.account.id}:%{?key}/%{keyId},%{?Host}=%{?tls.client.server_name},%{?x-amz-server-side-encryption}=%{?server-side-encryption},%{?x-amz-copy-source}=%{?bucket.objectName},%{?key}=%{target.objectName}}\"\n\n// filter for s3 objects whose account id is different from the encryption key's account id\n// add exceptions based on key.account.id or keyId for known external accounts or encryption keys\n| where cloud.account.id != key.account.id\n\n// keep relevant fields\n| keep @timestamp, aws.cloudtrail.user_identity.arn, cloud.account.id, event.action, target.bucketName, key.account.id, keyId, target.objectName", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_s3_object_encryption_with_external_key.toml"}
{"title": "AWS S3 Object Versioning Suspended", "description": "Identifies when object versioning is suspended for an Amazon S3 bucket. Object versioning allows for multiple versions of an object to exist in the same bucket. This allows for easy recovery of deleted or overwritten objects. When object versioning is suspended for a bucket, it could indicate an adversary's attempt to inhibit system recovery following malicious activity. Additionally, when versioning is suspended, buckets can then be deleted.", "query": "any where event.dataset == \"aws.cloudtrail\"\n   and event.action == \"PutBucketVersioning\"\n   and event.outcome == \"success\"\n   and stringContains(aws.cloudtrail.request_parameters, \"Status=Suspended\")", "tactic": "Impact", "technique": "Inhibit System Recovery", "technique_id": "T1490", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_s3_object_versioning_disabled.toml"}
{"title": "AWS S3 Static Site JavaScript File Uploaded", "description": "This rule detects when a JavaScript file is uploaded or accessed in an S3 static site directory (`static/js/`) by an IAM\nuser or assumed role. This can indicate suspicious modification of web content hosted on S3, such as injecting malicious scripts into a\nstatic website frontend.", "query": "from logs-aws.cloudtrail* metadata _id, _version, _index\n| where\n\n    // filter on CloudTrail logs for S3 PutObject actions\n    event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"s3.amazonaws.com\"\n    and event.action in (\"GetObject\",\"PutObject\")\n\n    // filter for IAM users, not federated identities\n    and aws.cloudtrail.user_identity.type in (\"IAMUser\", \"AssumedRole\")\n\n    // filter for S3 static site bucket paths from webpack or similar\n    and aws.cloudtrail.request_parameters LIKE \"*static/js/*.js*\"\n\n    // exclude common IaC tools and automation scripts\n    and not (\n        user_agent.original LIKE \"*Terraform*\"\n        or user_agent.original LIKE \"*Ansible*\"\n        or user_agent.original LIKE \"*Pulumni*\"\n    )\n\n// extract bucket and object details from request parameters\n| dissect aws.cloudtrail.request_parameters \"%{{?bucket.name.key}=%{bucket.name}, %{?host.key}=%{bucket.host}, %{?bucket.object.location.key}=%{bucket.object.location}}\"\n\n// filter for specific bucket and object structure\n| dissect bucket.object.location \"%{}static/js/%{bucket.object}\"\n\n// filter for JavaScript files\n| where ENDS_WITH(bucket.object, \".js\")\n| keep\n    aws.cloudtrail.user_identity.arn,\n    aws.cloudtrail.user_identity.access_key_id,\n    aws.cloudtrail.user_identity.type,\n    aws.cloudtrail.request_parameters,\n    bucket.name,\n    bucket.object,\n    user_agent.original,\n    source.ip,\n    event.action,\n    @timestamp", "tactic": "Impact", "technique": "Data Manipulation", "technique_id": "T1565", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_s3_static_site_js_file_uploaded.toml"}
{"title": "Unusual AWS S3 Object Encryption with SSE-C", "description": "Identifies when AWS S3 objects stored in a bucket are encrypted using Server-Side Encryption with Customer-Provided Keys\n(SSE-C). Adversaries with compromised AWS credentials can encrypt objects in an S3 bucket using their own encryption\nkeys, rendering the objects unreadable or recoverable without the key. This can be used as a form of ransomware to\nextort the bucket owner for the decryption key. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that flags when\nthis behavior is observed for the first time in the last 14 days by the user ARN and target bucket name.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"s3.amazonaws.com\"\n    and event.action: \"PutObject\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.flattened.request_parameters.x-amz-server-side-encryption-customer-algorithm: \"AES256\"\n    and aws.cloudtrail.flattened.additional_eventdata.SSEApplied: \"SSE_C\"", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_s3_unusual_object_encryption_with_sse_c.toml"}
{"title": "AWS Management Console Root Login", "description": "Identifies a successful login to the AWS Management Console by the Root user.", "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and aws.cloudtrail.user_identity.type:Root and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_console_login_root.toml"}
{"title": "AWS Access Token Used from Multiple Addresses", "description": "This rule identifies potentially suspicious activity by detecting instances where a single IAM user's temporary session token is accessed from multiple IP addresses within a short time frame. Such behavior may suggest that an adversary has compromised temporary credentials and is utilizing them from various locations.\nTo enhance detection accuracy and minimize false positives, the rule incorporates criteria that evaluate unique IP addresses, user agents, cities, and networks. These additional checks help distinguish between legitimate distributed access patterns and potential credential misuse.\nDetected activities are classified into different types based on the combination of unique indicators, with each classification assigned a fidelity score reflecting the likelihood of malicious behavior. High fidelity scores are given to patterns most indicative of threats, such as multiple unique IPs, networks, cities, and user agents. Medium and low fidelity scores correspond to less severe patterns, enabling security teams to effectively prioritize alerts.", "query": "FROM logs-aws.cloudtrail* metadata _id, _version, _index\n| WHERE @timestamp > NOW() - 30 minutes\n    // filter on CloudTrail logs for STS temporary session tokens used by IAM users\n\n  AND event.dataset == \"aws.cloudtrail\"\n  AND aws.cloudtrail.user_identity.arn IS NOT NULL\n  AND aws.cloudtrail.user_identity.type == \"IAMUser\"\n  AND source.ip IS NOT NULL\n    \n    // exclude known benign IaC tools and Amazon Network\n  AND NOT (user_agent.original LIKE \"%Terraform%\" OR user_agent.original LIKE \"%Ansible%\" OR user_agent.original LIKE \"%Pulumni%\")\n  AND `source.as.organization.name` != \"AMAZON-AES\"\n    \n    // exclude noisy service APIs less indicative of malicous behavior\n  AND event.provider NOT IN (\"health.amazonaws.com\", \"monitoring.amazonaws.com\", \"notifications.amazonaws.com\", \"ce.amazonaws.com\", \"cost-optimization-hub.amazonaws.com\", \"servicecatalog-appregistry.amazonaws.com\", \"securityhub.amazonaws.com\")\n\n| EVAL\n  // create a time window for aggregation\n    time_window = DATE_TRUNC(30 minutes, @timestamp),\n  // capture necessary fields for detection and investigation  \n    user_id = aws.cloudtrail.user_identity.arn,\n    access_key_id = aws.cloudtrail.user_identity.access_key_id,\n    ip = source.ip,\n    user_agent = user_agent.original,\n    ip_string = TO_STRING(source.ip),  // Convert IP to string\n    ip_user_agent_pair = CONCAT(ip_string, \" - \", user_agent.original),  // Combine IP and user agent\n    ip_city_pair = CONCAT(ip_string, \" - \", source.geo.city_name), // Combine IP and city\n    city = source.geo.city_name,\n    event_time = @timestamp,\n    network_arn = `source.as.organization.name` \n\n| STATS\n    event_actions = VALUES(event.action),\n    event_providers = VALUES(event.provider),\n    access_key_id = VALUES(access_key_id),\n    user_id = VALUES(user_id), \n    ip_list = VALUES(ip),  // Collect list of IPs\n    user_agent_list = VALUES(user_agent),  // Collect list of user agents\n    ip_user_agent_pairs = VALUES(ip_user_agent_pair),  // Collect list of IP - user agent pairs\n    cities_list = VALUES(city), // Collect list of cities\n    ip_city_pairs = VALUES(ip_city_pair), // Collect list of IP - city pairs\n    networks_list = VALUES(network_arn), // Collect list of networks\n    unique_ips = COUNT_DISTINCT(ip),\n    unique_user_agents = COUNT_DISTINCT(user_agent),\n    unique_cities = COUNT_DISTINCT(city),\n    unique_networks = COUNT_DISTINCT(network_arn),\n    first_seen = MIN(event_time),\n    last_seen = MAX(event_time),\n    total_events = COUNT()\n  BY time_window, access_key_id \n\n| EVAL\n //   activity type based on combinations of detection criteria \n    activity_type = CASE(\n        unique_ips >= 2 AND unique_networks >= 2 AND unique_cities >= 2 AND unique_user_agents >= 2, \"multiple_ip_network_city_user_agent\", // high severity\n        unique_ips >= 2 AND unique_networks >= 2 AND unique_cities >= 2, \"multiple_ip_network_city\", // high severity\n        unique_ips >= 2 AND unique_cities >= 2, \"multiple_ip_and_city\", // medium severity\n        unique_ips >= 2 AND unique_networks >= 2, \"multiple_ip_and_network\", // medium severity\n        unique_ips >= 2 AND unique_user_agents >= 2, \"multiple_ip_and_user_agent\", // low severity\n        \"normal_activity\"\n    ),\n // likelihood of malicious activity based on activity type\n    fidelity_score = CASE(\n        activity_type == \"multiple_ip_network_city_user_agent\", \"high\",\n        activity_type == \"multiple_ip_network_city\", \"high\",\n        activity_type == \"multiple_ip_and_city\", \"medium\",\n        activity_type == \"multiple_ip_and_network\", \"medium\",\n        activity_type == \"multiple_ip_and_user_agent\", \"low\"\n    )\n\n| KEEP\n    time_window, activity_type, fidelity_score, total_events, first_seen, last_seen,\n    user_id, access_key_id, event_actions, event_providers, ip_list, user_agent_list, ip_user_agent_pairs, cities_list, ip_city_pairs, networks_list, unique_ips, unique_user_agents, unique_cities, unique_networks\n\n| WHERE activity_type != \"normal_activity\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_iam_session_token_used_from_multiple_addresses.toml"}
{"title": "AWS CLI with Kali Linux Fingerprint Identified", "description": "Identifies the usage of the AWS CLI with a user agent string containing `distrib#kali`, which suggests the request\nwas made from a Kali Linux distribution. This may indicate offensive security tooling or unauthorized use of the AWS CLI\nfrom a potentially adversarial environment.", "query": "event.dataset: \"aws.cloudtrail\" and user_agent.original: (aws-cli*distrib#kali* or Boto3*distrib#kali*)", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_kali_user_agent_detected_with_aws_cli.toml"}
{"title": "AWS IAM Password Recovery Requested", "description": "Identifies AWS IAM password recovery requests. An adversary may attempt to gain unauthorized AWS access by abusing\npassword recovery mechanisms.", "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:PasswordRecoveryRequested and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_password_recovery.toml"}
{"title": "AWS Signin Single Factor Console Login with Federated User", "description": "Identifies when a federated user logs into the AWS Management Console without using multi-factor authentication (MFA).\nFederated users are typically given temporary credentials to access AWS services. If a federated user logs into the AWS\nManagement Console without using MFA, it may indicate a security risk, as MFA adds an additional layer of security to\nthe authentication process. This could also indicate the abuse of STS tokens to bypass MFA requirements.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where\n    event.provider == \"signin.amazonaws.com\"\n    and event.action == \"GetSigninToken\"\n    and aws.cloudtrail.event_type == \"AwsConsoleSignIn\"\n    and aws.cloudtrail.user_identity.type == \"FederatedUser\"\n| dissect aws.cloudtrail.additional_eventdata \"{%{?mobile_version_key}=%{mobile_version}, %{?mfa_used_key}=%{mfa_used}}\"\n| where mfa_used == \"No\"\n| keep @timestamp, event.action, aws.cloudtrail.event_type, aws.cloudtrail.user_identity.type", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_signin_console_login_no_mfa.toml"}
{"title": "SSM Session Started to EC2 Instance", "description": "Identifies the first occurrence of an AWS resource establishing a session via SSM to an EC2 instance. Adversaries may\nuse AWS Systems Manager to establish a session to an EC2 instance to execute commands on the instance. This can be used\nto gain access to the instance and perform actions such as privilege escalation. This rule helps detect the first\noccurrence of this activity for a given AWS resource.", "query": "event.dataset:\"aws.cloudtrail\" and event.provider:\"ssm.amazonaws.com\"\n    and event.action:\"StartSession\" and event.outcome:\"success\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_aws_ssm_start_session_to_ec2_instance.toml"}
{"title": "AWS EC2 Instance Connect SSH Public Key Uploaded", "description": "Identifies when a new SSH public key is uploaded to an AWS EC2 instance using the EC2 Instance Connect service. This\naction could indicate an adversary attempting to maintain access to the instance. The rule also detects the\n`SendSerialConsoleSSHPublicKey` or `SendSSHPublicKey` API actions, which are logged when manually uploading an SSH key\nto an EC2 instance or serial connection. It is important to know that this API call happens automatically by the EC2\nInstance Connect service when a user connects to an EC2 instance using the EC2 Instance Connect service via the CLI or\nAWS Management Console.", "query": "event.dataset: aws.cloudtrail\n    and event.provider: ec2-instance-connect.amazonaws.com\n    and event.action: (SendSSHPublicKey or SendSerialConsoleSSHPublicKey)\n    and event.outcome: success", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ec2_instance_connect_ssh_public_key_uploaded.toml"}
{"title": "AWS EC2 Instance Console Login via Assumed Role", "description": "Identifies a successful console login activity by an EC2 instance profile using an assumed role. This is uncommon behavior and could indicate an attacker using compromised credentials to further exploit an environment. An EC2 instance assumes a role using their EC2 ID as the session name. This rule looks for the pattern \"i-\" which is the beginning pattern for assumed role sessions started by an EC2 instance and a successful `ConsoleLogin` or `GetSigninToken` API call.", "query": "any where event.dataset == \"aws.cloudtrail\"\n   and event.provider == \"signin.amazonaws.com\"\n   and event.action in (\"ConsoleLogin\", \"GetSigninToken\")\n   and event.outcome == \"success\"\n   and aws.cloudtrail.user_identity.type == \"AssumedRole\"\n   and stringContains (user.id, \":i-\")", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ec2_instance_console_login.toml"}
{"title": "SNS Topic Message Publish by Rare User", "description": "Identifies when an SNS topic message is published by a rare user in AWS. Adversaries may publish messages to SNS topics\nfor phishing campaigns, data exfiltration, or lateral movement within the AWS environment. SNS topics are used to send\nnotifications and messages to subscribed endpoints such as applications, devices or email addresses, making them a\nvaluable target for adversaries to distribute malicious content or exfiltrate sensitive data. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that only flags\nwhen this behavior is observed for the first time on a user in the last 14 days.", "query": "event.dataset:\"aws.cloudtrail\"\n    and event.provider:\"sns.amazonaws.com\"\n    and event.action:\"Publish\"\n    and event.outcome:\"success\"", "tactic": "Lateral Movement", "technique": "Internal Spearphishing", "technique_id": "T1534", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_sns_topic_message_publish_by_rare_user.toml"}
{"title": "Spike in AWS Error Messages", "description": "A machine learning job detected a significant spike in the rate of a particular error in the CloudTrail messages. Spikes\nin error messages may accompany attempts at privilege escalation, lateral movement, or discovery.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_cloudtrail_error_message_spike.toml"}
{"title": "Rare AWS Error Code", "description": "A machine learning job detected an unusual error in a CloudTrail message. These can be byproducts of attempted or\nsuccessful persistence, privilege escalation, defense evasion, discovery, lateral movement, or collection.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_cloudtrail_rare_error_code.toml"}
{"title": "Unusual City For an AWS Command", "description": "A machine learning job detected AWS command activity that, while not inherently suspicious or abnormal, is sourcing from\na geolocation (city) that is unusual for the command. This can be the result of compromised credentials or keys being\nused by a threat actor in a different geography than the authorized user(s).", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_cloudtrail_rare_method_by_city.toml"}
{"title": "Unusual Country For an AWS Command", "description": "A machine learning job detected AWS command activity that, while not inherently suspicious or abnormal, is sourcing from\na geolocation (country) that is unusual for the command. This can be the result of compromised credentials or keys being\nused by a threat actor in a different geography than the authorized user(s).", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_cloudtrail_rare_method_by_country.toml"}
{"title": "Unusual AWS Command for a User", "description": "A machine learning job detected an AWS API command that, while not inherently suspicious or abnormal, is being made by a\nuser context that does not normally use the command. This can be the result of compromised credentials or keys as\nsomeone uses a valid account to persist, move laterally, or exfiltrate data.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_cloudtrail_rare_method_by_user.toml"}
{"title": "AWS IAM Virtual MFA Device Registration Attempt with Session Token", "description": "Identifies attempts to register or enable an IAM Virtual MFA device using temporary credentials (access keys\nstarting with 'ASIA'). This may indicate an adversary attempting to escalate privileges or establish persistence using\nstolen session tokens.", "query": "event.dataset: \"aws.cloudtrail\"\n  and event.provider: \"iam.amazonaws.com\"\n  and event.action: (\"CreateVirtualMFADevice\" or \"EnableMFADevice\")\n  and aws.cloudtrail.user_identity.access_key_id: ASIA*", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_aws_attempt_to_register_virtual_mfa_device.toml"}
{"title": "AWS EC2 Network Access Control List Creation", "description": "Identifies the creation of an AWS EC2 network access control list (ACL) or an entry in a network ACL with a specified rule number. Adversaries may exploit ACLs to establish persistence or exfiltrate data by creating permissive rules.", "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:(CreateNetworkAcl or CreateNetworkAclEntry) and event.outcome:success", "tactic": "Persistence", "technique": "External Remote Services", "technique_id": "T1133", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ec2_network_acl_creation.toml"}
{"title": "AWS IAM API Calls via Temporary Session Tokens", "description": "Detects use of sensitive AWS STS or IAM API operations using temporary credentials (session tokens starting with 'ASIA').\nThis may indicate credential theft or abuse of elevated access via a stolen session. It is not common for legitimate users to perform sensitive IAM operations with temporary session tokens.", "query": "event.dataset: aws.cloudtrail\n    and event.provider: (\"iam.amazonaws.com\")\n    and aws.cloudtrail.user_identity.type: \"IAMUser\"\n    and aws.cloudtrail.user_identity.access_key_id: ASIA*", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_api_calls_via_user_session_token.toml"}
{"title": "AWS IAM Login Profile Added for Root", "description": "Detects when an AWS IAM login profile is added to a root user account and is self-assigned. Adversaries, with temporary\naccess to the root account, may add a login profile to the root user account to maintain access even if the original\naccess key is rotated or disabled.", "query": "from logs-aws.cloudtrail* metadata _id, _version, _index\n| where\n    // filter for CloudTrail logs from IAM\n    event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"iam.amazonaws.com\"\n\n    // filter for successful CreateLoginProfile API call\n    and event.action == \"CreateLoginProfile\"\n    and event.outcome == \"success\"\n\n    // filter for Root member account\n    and aws.cloudtrail.user_identity.type == \"Root\"\n\n    // filter for an access key existing which sources from AssumeRoot\n    and aws.cloudtrail.user_identity.access_key_id IS NOT NULL\n\n    // filter on the request parameters not including UserName which assumes self-assignment\n    and NOT TO_LOWER(aws.cloudtrail.request_parameters) LIKE \"*username*\"\n| keep\n    @timestamp,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.response_elements,\n    aws.cloudtrail.user_identity.type,\n    aws.cloudtrail.user_identity.arn,\n    aws.cloudtrail.user_identity.access_key_id,\n    cloud.account.id,\n    event.action,\n    source.address", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_create_login_profile_for_root.toml"}
{"title": "AWS IAM Create User via Assumed Role on EC2 Instance", "description": "Detects the creation of an AWS Identity and Access Management (IAM) user initiated by an assumed role on an EC2\ninstance. Assumed roles allow users or services to temporarily adopt different AWS permissions, but the creation of IAM\nusers through these roles\u2014particularly from within EC2 instances\u2014may indicate a compromised instance. Adversaries might\nexploit such permissions to establish persistence by creating new IAM users under unauthorized conditions.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"iam.amazonaws.com\"\n    and event.action: \"CreateUser\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: \"AssumedRole\"\n    and aws.cloudtrail.user_identity.arn: *i-*", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_create_user_via_assumed_role_on_ec2_instance.toml"}
{"title": "AWS IAM Group Creation", "description": "Identifies the creation of a group in AWS Identity and Access Management (IAM). Groups specify permissions for multiple\nusers. Any user in a group automatically has the permissions that are assigned to the group.", "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:CreateGroup and event.outcome:success", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_group_creation.toml"}
{"title": "AWS IAM Roles Anywhere Profile Creation", "description": "Identifies the creation of an AWS Roles Anywhere profile. AWS Roles Anywhere is a feature that allows you to use AWS\nIdentity and Access Management (IAM) profiles to manage access to your AWS resources from any location via trusted\nanchors. This rule detects the creation of a profile that can be assumed from any service. Adversaries may create\nprofiles tied to overly permissive roles to maintain access to AWS resources. Ensure that the profile creation is\nexpected and that the trust policy is configured securely.", "query": "event.dataset:aws.cloudtrail\n    and event.provider: rolesanywhere.amazonaws.com\n    and event.action: CreateProfile\n    and event.outcome: success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_roles_anywhere_profile_created.toml"}
{"title": "AWS IAM Roles Anywhere Trust Anchor Created with External CA", "description": "Identifies when an AWS IAM Roles Anywhere Trust Anchor with an external certificate authority is created. AWS Roles\nAnywhere profiles are legitimate profiles that can be created by administrators to allow access from any location. This\nrule detects when a trust anchor is created with an external certificate authority that is not managed by AWS\nCertificate Manager Private Certificate Authority (ACM PCA). Adversaries may accomplish this to maintain persistence in\nthe environment.", "query": "event.dataset: aws.cloudtrail\n    and event.provider: rolesanywhere.amazonaws.com\n    and event.action: CreateTrustAnchor\n    and event.outcome: success\n    and not aws.cloudtrail.request_parameters: *sourceType=AWS_ACM_PCA*", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_roles_anywhere_trusted_anchor_created_with_external_ca.toml"}
{"title": "AWS IAM User Created Access Keys For Another User", "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by creating a\nnew set of credentials for an existing user. This rule looks for use of the IAM `CreateAccessKey` API operation to\ncreate new programmatic access keys for another IAM user.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\"\n    and event.action == \"CreateAccessKey\"\n    and event.outcome == \"success\"\n    and user.name != user.target.name\n| keep\n    @timestamp,\n    cloud.region,\n    event.provider,\n    event.action,\n    event.outcome,\n    user.name,\n    source.address,\n    user.target.name,\n    user_agent.original,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.response_elements,\n    aws.cloudtrail.user_identity.arn,\n    aws.cloudtrail.user_identity.type", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_iam_user_created_access_keys_for_another_user.toml"}
{"title": "AWS Lambda Function Policy Updated to Allow Public Invocation", "description": "Identifies when an AWS Lambda function policy is updated to allow public invocation. This rule specifically looks for\nthe `AddPermission` API call with the `Principal` set to `*` which allows any AWS account to invoke the Lambda function.\nAdversaries may abuse this permission to create a backdoor in the Lambda function that allows them to execute arbitrary\ncode.", "query": "event.dataset: aws.cloudtrail\n    and event.provider: lambda.amazonaws.com\n    and event.outcome: success\n    and event.action: AddPermission*\n    and aws.cloudtrail.request_parameters: (*lambda\\:InvokeFunction* and *principal=\\**)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_lambda_backdoor_invoke_function_for_any_principal.toml"}
{"title": "AWS RDS DB Instance or Cluster Password Modified", "description": "Identifies the modification of the master password for an AWS RDS DB instance or cluster. DB instances may contain sensitive data that can be abused if accessed by unauthorized actors. Amazon RDS API operations never return the password, so this operation provides a means to regain access if the password is lost. Adversaries with the proper permissions can take advantage of this to evade defenses and gain unauthorized access to a DB instance or cluster to support persistence mechanisms or privilege escalation.", "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"rds.amazonaws.com\"\n    and event.action in (\"ModifyDBInstance\", \"ModifyDBCluster\")\n    and event.outcome == \"success\"\n    and stringContains(aws.cloudtrail.request_parameters, \"masterUserPassword=*\")", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rds_db_instance_password_modified.toml"}
{"title": "AWS RDS Security Group Creation", "description": "Identifies the creation of an Amazon Relational Database Service (RDS) Security group.", "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:CreateDBSecurityGroup and event.outcome:success", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rds_group_creation.toml"}
{"title": "AWS RDS Instance Creation", "description": "Identifies the creation of an Amazon Relational Database Service (RDS) Aurora database instance.", "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:CreateDBInstance and event.outcome:success", "tactic": "Persistence", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rds_instance_creation.toml"}
{"title": "AWS RDS DB Instance Made Public", "description": "Identifies the creation or modification of an AWS RDS DB instance to enable public access. DB instances may contain sensitive data that can be abused if shared with unauthorized accounts or made public. Adversaries may enable public access on a DB instance to maintain persistence or evade defenses by bypassing access controls.", "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"rds.amazonaws.com\"\n    and event.outcome == \"success\"\n    and (\n        (event.action == \"ModifyDBInstance\" and stringContains(aws.cloudtrail.request_parameters, \"publiclyAccessible=true\"))\n        or\n        (event.action in (\"CreateDBInstance\", \"CreateDBCluster\") and stringContains(aws.cloudtrail.request_parameters, \"publiclyAccessible=true\"))\n    )", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rds_instance_made_public.toml"}
{"title": "AWS Route 53 Domain Transferred to Another Account", "description": "Identifies when a request has been made to transfer a Route 53 domain to another AWS account.", "query": "event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:TransferDomainToAnotherAwsAccount and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_route_53_domain_transferred_to_another_account.toml"}
{"title": "AWS Route 53 Domain Transfer Lock Disabled", "description": "Identifies when a transfer lock was removed from a Route 53 domain. It is recommended to refrain from performing this\naction unless intending to transfer the domain to a different registrar.", "query": "event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:DisableDomainTransferLock and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_route_53_domain_transfer_lock_disabled.toml"}
{"title": "AWS Route53 private hosted zone associated with a VPC", "description": "Identifies when a Route53 private hosted zone has been associated with VPC.", "query": "event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:AssociateVPCWithHostedZone and\nevent.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_route_53_hosted_zone_associated_with_a_vpc.toml"}
{"title": "AWS STS AssumeRole with New MFA Device", "description": "Identifies when a user has assumed a role using a new MFA device. Users can assume a role to obtain temporary credentials and access AWS resources using the AssumeRole API of AWS Security Token Service (STS).\nWhile a new MFA device is not always indicative of malicious behavior it should be verified as adversaries can use this technique for persistence and privilege escalation.", "query": "event.dataset:aws.cloudtrail\n    and event.provider:sts.amazonaws.com\n    and event.action:(AssumeRole or AssumeRoleWithSAML or AssumeRoleWithWebIdentity)\n    and event.outcome:success\n    and user.id:*\n    and aws.cloudtrail.flattened.request_parameters.serialNumber:*", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_sts_assume_role_with_new_mfa.toml"}
{"title": "AWS IAM AdministratorAccess Policy Attached to Group", "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by attaching\nadditional permissions to user groups the compromised user account belongs to. This rule looks for use of the IAM\n`AttachGroupPolicy` API operation to attach the highly permissive `AdministratorAccess` AWS managed policy to an\nexisting IAM user group.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\" and event.action == \"AttachGroupPolicy\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?policyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName},%{?groupName}=%{group.name}}\"\n| where policyName == \"AdministratorAccess\"\n| keep @timestamp, event.provider, event.action, event.outcome, policyName, group.name", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_iam_administratoraccess_policy_attached_to_group.toml"}
{"title": "AWS IAM AdministratorAccess Policy Attached to Role", "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by attaching\nadditional permissions to compromised IAM roles. This rule looks for use of the IAM `AttachRolePolicy` API operation to\nattach the highly permissive `AdministratorAccess` AWS managed policy to an existing IAM role.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\" and event.action == \"AttachRolePolicy\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?policyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName},%{?roleName}=%{role.name}}\"\n| where policyName == \"AdministratorAccess\"\n| keep @timestamp, event.provider, event.action, event.outcome, policyName, role.name", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_iam_administratoraccess_policy_attached_to_role.toml"}
{"title": "AWS IAM AdministratorAccess Policy Attached to User", "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by attaching\nadditional permissions to compromised user accounts. This rule looks for use of the IAM `AttachUserPolicy` API operation\nto attach the highly permissive `AdministratorAccess` AWS managed policy to an existing IAM user.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\" and event.action == \"AttachUserPolicy\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?policyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName},%{?userName}=%{target.userName}}\"\n| where policyName == \"AdministratorAccess\"\n| keep\n    @timestamp,\n    cloud.region,\n    event.provider,\n    event.action,\n    event.outcome,\n    policyName,\n    target.userName,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.user_identity.arn,\n    related.user,\n    user_agent.original,\n    user.name,\n    source.address", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_iam_administratoraccess_policy_attached_to_user.toml"}
{"title": "AWS IAM Customer-Managed Policy Attached to Role by Rare User", "description": "Detects when an AWS Identity and Access Management (IAM) customer-managed policy is attached to a role by an unusual or\nunauthorized user. Customer-managed policies are policies created and controlled within an AWS account, granting\nspecific permissions to roles or users when attached. This rule identifies potential privilege escalation by flagging\ncases where a customer-managed policy is attached to a role by an unexpected actor, which could signal unauthorized\naccess or misuse. Attackers may attach policies to roles to expand permissions and elevate their privileges within the\nAWS environment. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that uses the\n`aws.cloudtrail.user_identity.arn` and `aws.cloudtrail.flattened.request_parameters.roleName` fields to check if the\ncombination of the actor ARN and target role name has not been seen in the last 14 days.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"iam.amazonaws.com\"\n    and event.action: \"AttachRolePolicy\"\n    and event.outcome: \"success\"\n    and not aws.cloudtrail.flattened.request_parameters.policyArn: arn\\:aws\\:iam\\:\\:aws\\:policy*", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_iam_customer_managed_policy_attached_to_role.toml"}
{"title": "AWS IAM SAML Provider Updated", "description": "Identifies when a user has updated a SAML provider in AWS. SAML providers are used to enable federated access to the AWS Management Console. This activity could be an indication of an attacker attempting to escalate privileges.", "query": "event.dataset:aws.cloudtrail\n    and event.provider: iam.amazonaws.com\n    and event.action: UpdateSAMLProvider\n    and event.outcome:success", "tactic": "Privilege Escalation", "technique": "Domain or Tenant Policy Modification", "technique_id": "T1484", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_iam_saml_provider_updated.toml"}
{"title": "AWS IAM Assume Role Policy Update", "description": "Identifies AWS CloudTrail events where an IAM role's trust policy has been updated by an IAM user or Assumed Role identity. The trust policy is a JSON document that defines which principals are allowed to assume the role. An attacker may attempt to modify this policy to gain the privileges of the role. This is a New Terms rule, which means it will only trigger once for each unique combination of the \"cloud.account.id\", \"user.name\" and \"aws.cloudtrail.flattened.request_parameters.roleName\" fields, that have not been seen making this API request within the last 14 days.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"iam.amazonaws.com\"\n    and event.action: \"UpdateAssumeRolePolicy\"\n    and event.outcome: \"success\"\n    and not source.address: \"cloudformation.amazonaws.com\"", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_iam_update_assume_role_policy.toml"}
{"title": "AWS STS Role Assumption by Service", "description": "Identifies when a service has assumed a role in AWS Security Token Service (STS). Services can assume a role to obtain\ntemporary credentials and access AWS resources. Adversaries can use this technique for credential access and privilege\nescalation. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that identifies\nwhen a service assumes a role in AWS Security Token Service (STS) to obtain temporary credentials and access AWS\nresources. While often legitimate, adversaries may use this technique for unauthorized access, privilege escalation, or\nlateral movement within an AWS environment.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"AssumeRole\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: \"AWSService\"\n    and aws.cloudtrail.user_identity.invoked_by: (\n          \"ec2.amazonaws.com\" or\n          \"lambda.amazonaws.com\" or\n          \"rds.amazonaws.com\" or\n          \"ssm.amazonaws.com\" or\n          \"ecs-tasks.amazonaws.com\" or\n          \"ecs.amazonaws.com\" or\n          \"eks.amazonaws.com\" or\n          \"eks-fargate.amazonaws.com\" or\n          \"codepipeline.amazonaws.com\" or\n          \"codebuild.amazonaws.com\" or\n          \"autoscaling.amazonaws.com\")", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_role_assumption_by_service.toml"}
{"title": "AWS STS Role Assumption by User", "description": "Identifies when a user or role has assumed a role in AWS Security Token Service (STS). Users can assume a role to obtain\ntemporary credentials and access AWS resources. Adversaries can use this technique for credential access and privilege\nescalation. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that identifies\nwhen a service assumes a role in AWS Security Token Service (STS) to obtain temporary credentials and access AWS\nresources. While often legitimate, adversaries may use this technique for unauthorized access, privilege escalation, or\nlateral movement within an AWS environment.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"AssumeRole\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: (\"AssumedRole\" or \"IAMUser\")", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_role_assumption_by_user.toml"}
{"title": "AWS Root Login Without MFA", "description": "Identifies attempts to login to AWS as the root user without using multi-factor authentication (MFA). Amazon AWS best\npractices indicate that the root user should be protected by MFA.", "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and\n  aws.cloudtrail.user_identity.type:Root and\n  aws.cloudtrail.console_login.additional_eventdata.mfa_used:false and\n  event.outcome:success", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_root_login_without_mfa.toml"}
{"title": "AWS STS AssumeRoot by Rare User and Member Account", "description": "Identifies when the STS `AssumeRoot` action is performed by a rare user in AWS. The AssumeRoot action allows users to\nassume the root member account role, granting elevated but specific permissions based on the task policy specified.\nAdversaries whom may have compromised user credentials, such as access and secret keys, can use this technique to\nescalate privileges and gain unauthorized access to AWS resources. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that identifies\nwhen the STS `AssumeRoot` action is performed by a user that rarely assumes this role and specific member account.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"AssumeRoot\"\n    and event.outcome: \"success\"", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sts_assume_root_from_rare_user_and_member_account.toml"}
{"title": "AWS STS Role Chaining", "description": "Identifies role chaining activity. Role chaining is when you use one assumed role to assume a second role through the AWS CLI or API.\nWhile this a recognized functionality in AWS, role chaining can be abused for privilege escalation if the subsequent assumed role provides additional privileges.\nRole chaining can also be used as a persistence mechanism as each AssumeRole action results in a refreshed session token with a 1 hour maximum duration.\nThis rule looks for role chaining activity happening within a single account, to eliminate false positives produced by common cross-account behavior.", "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n\n// filter for AssumeRole API calls where access key id is a short term token beginning with ASIA\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"sts.amazonaws.com\" and event.action == \"AssumeRole\" and aws.cloudtrail.resources.account_id == aws.cloudtrail.recipient_account_id and aws.cloudtrail.user_identity.access_key_id like \"ASIA*\"\n\n// keep only the relevant fields\n| keep aws.cloudtrail.user_identity.arn, cloud.region, aws.cloudtrail.resources.account_id, aws.cloudtrail.recipient_account_id, aws.cloudtrail.user_identity.access_key_id", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sts_role_chaining.toml"}
{"title": "AWS SNS Topic Created by Rare User", "description": "Identifies when an SNS topic is created by a user who does not typically perform this action. Adversaries may create SNS\ntopics to stage capabilities for data exfiltration or other malicious activities.", "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sns.amazonaws.com\"\n    and event.action: \"CreateTopic\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: \"AssumedRole\"\n    and aws.cloudtrail.user_identity.arn: *i-*", "tactic": "Resource Development", "technique": "Stage Capabilities", "technique_id": "T1608", "risk_score": "N/A", "tags": [], "references": [], "file": "resource_development_sns_topic_created_by_rare_user.toml"}
{"title": "AWS Bedrock Invocations without Guardrails Detected by a Single User Over a Session", "description": "Identifies multiple AWS Bedrock executions in a one minute time window without guardrails by the same user in the same\naccount over a session. Multiple consecutive executions implies that a user may be intentionally attempting to bypass\nsecurity controls, by not routing the requests with the desired guardrail configuration in order to access sensitive\ninformation, or possibly exploit a vulnerability in the system.", "query": "from logs-aws_bedrock.invocation-*\n// create time window buckets of 1 minute\n| eval time_window = date_trunc(1 minute, @timestamp)\n| where gen_ai.guardrail_id is NULL\n| KEEP @timestamp, time_window, gen_ai.guardrail_id , user.id\n| stats model_invocation_without_guardrails = count() by user.id\n| where model_invocation_without_guardrails > 5\n| sort model_invocation_without_guardrails desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_execution_without_guardrails.toml"}
{"title": "AWS Bedrock Guardrails Detected Multiple Violations by a Single User Over a Session", "description": "Identifies multiple violations of AWS Bedrock guardrails by the same user in the same account over a session. Multiple\nviolations implies that a user may be intentionally attempting to cirvumvent security controls, access sensitive\ninformation, or possibly exploit a vulnerability in the system.", "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.compliance.violation_detected\n| keep user.id, gen_ai.request.model.id, cloud.account.id\n| stats violations = count(*) by user.id, gen_ai.request.model.id, cloud.account.id\n| where violations > 1\n| sort violations desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_guardrails_multiple_violations_by_single_user.toml"}
{"title": "AWS Bedrock Guardrails Detected Multiple Policy Violations Within a Single Blocked Request", "description": "Identifies multiple violations of AWS Bedrock guardrails within a single request, resulting in a block action,\nincreasing the likelihood of malicious intent. Multiple violations implies that a user may be intentionally attempting\nto cirvumvent security controls, access sensitive information, or possibly exploit a vulnerability in the system.", "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.policy.action == \"BLOCKED\"\n| eval policy_violations = mv_count(gen_ai.policy.name)\n| where policy_violations > 1\n| keep gen_ai.policy.action, policy_violations, user.id, gen_ai.request.model.id, cloud.account.id, user.id\n| stats total_unique_request_violations = count(*) by policy_violations, user.id, gen_ai.request.model.id, cloud.account.id\n| sort total_unique_request_violations desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_guardrails_multiple_violations_in_single_request.toml"}
{"title": "Unusual High Confidence Content Filter Blocks Detected", "description": "Detects repeated high-confidence 'BLOCKED' actions coupled with specific 'Content Filter' policy violation having codes\nsuch as 'MISCONDUCT', 'HATE', 'SEXUAL', INSULTS', 'PROMPT_ATTACK', 'VIOLENCE' indicating persistent misuse or attempts\nto probe the model's ethical boundaries.", "query": "from logs-aws_bedrock.invocation-*\n| MV_EXPAND gen_ai.compliance.violation_code\n| MV_EXPAND gen_ai.policy.confidence\n| MV_EXPAND gen_ai.policy.name\n| where gen_ai.policy.action == \"BLOCKED\" and gen_ai.policy.name == \"content_policy\" and gen_ai.policy.confidence LIKE \"HIGH\" and gen_ai.compliance.violation_code IN (\"HATE\", \"MISCONDUCT\", \"SEXUAL\", \"INSULTS\", \"PROMPT_ATTACK\", \"VIOLENCE\")\n| keep user.id, gen_ai.compliance.violation_code\n| stats block_count_per_violation = count() by user.id, gen_ai.compliance.violation_code\n| SORT block_count_per_violation DESC\n| keep user.id, gen_ai.compliance.violation_code, block_count_per_violation\n| STATS violation_count = SUM(block_count_per_violation) by user.id\n| WHERE violation_count > 5\n| SORT violation_count DESC", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_high_confidence_misconduct_blocks_detected.toml"}
{"title": "Potential Abuse of Resources by High Token Count and Large Response Sizes", "description": "Detects potential resource exhaustion or data breach attempts by monitoring for users who consistently generate high\ninput token counts, submit numerous requests, and receive large responses. This behavior could indicate an attempt to\noverload the system or extract an unusually large amount of data, possibly revealing sensitive information or causing\nservice disruptions.", "query": "from logs-aws_bedrock.invocation-*\n| keep user.id, gen_ai.usage.prompt_tokens, gen_ai.usage.completion_tokens\n| stats max_tokens = max(gen_ai.usage.prompt_tokens),\n         total_requests = count(*),\n         avg_response_size = avg(gen_ai.usage.completion_tokens)\n  by user.id\n// tokens count depends on specific LLM, as is related to how embeddings are generated.\n| where max_tokens > 5000 and total_requests > 10 and avg_response_size > 500\n| eval risk_factor = (max_tokens / 1000) * total_requests * (avg_response_size / 500)\n| where risk_factor > 10\n| sort risk_factor desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_high_resource_consumption_detection.toml"}
{"title": "AWS Bedrock Detected Multiple Attempts to use Denied Models by a Single User", "description": "Identifies multiple successive failed attempts to use denied model resources within AWS Bedrock. This could indicated\nattempts to bypass limitations of other approved models, or to force an impact on the environment by incurring\nexhorbitant costs.", "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.response.error_code == \"AccessDeniedException\"\n| keep user.id, gen_ai.request.model.id, cloud.account.id, gen_ai.response.error_code\n| stats total_denials = count(*) by user.id, gen_ai.request.model.id, cloud.account.id\n| where total_denials > 3\n| sort total_denials desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_multiple_attempts_to_use_denied_models_by_user.toml"}
{"title": "Unusual High Denied Sensitive Information Policy Blocks Detected", "description": "Detects repeated compliance violation 'BLOCKED' actions coupled with specific policy name such as\n'sensitive_information_policy', indicating persistent misuse or attempts to probe the model's denied topics.", "query": "from logs-aws_bedrock.invocation-*\n| MV_EXPAND gen_ai.policy.name\n| where gen_ai.policy.action == \"BLOCKED\" and gen_ai.compliance.violation_detected == \"true\" and gen_ai.policy.name == \"sensitive_information_policy\"\n| keep user.id\n| stats sensitive_information_block = count() by user.id\n| where sensitive_information_block > 5\n| sort sensitive_information_block desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_multiple_sensitive_information_policy_blocks_detected.toml"}
{"title": "Unusual High Denied Topic Blocks Detected", "description": "Detects repeated compliance violation 'BLOCKED' actions coupled with specific policy name such as 'topic_policy',\nindicating persistent misuse or attempts to probe the model's denied topics.", "query": "from logs-aws_bedrock.invocation-*\n| MV_EXPAND gen_ai.policy.name\n| where gen_ai.policy.action == \"BLOCKED\" and gen_ai.compliance.violation_detected == \"true\" and gen_ai.policy.name == \"topic_policy\"\n| keep user.id\n| stats denied_topics = count() by user.id\n| where denied_topics > 5\n| sort denied_topics desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_multiple_topic_policy_blocks_detected.toml"}
{"title": "AWS Bedrock Detected Multiple Validation Exception Errors by a Single User", "description": "Identifies multiple validation exeception errors within AWS Bedrock. Validation errors occur when you run the\nInvokeModel or InvokeModelWithResponseStream APIs on a foundation model that uses an incorrect inference parameter or\ncorresponding value. These errors also occur when you use an inference parameter for one model with a model that doesn't\nhave the same API parameter. This could indicate attempts to bypass limitations of other approved models, or to force an\nimpact on the environment by incurring exhorbitant costs.", "query": "from logs-aws_bedrock.invocation-*\n// truncate the timestamp to a 1-minute window\n| eval target_time_window = DATE_TRUNC(1 minutes, @timestamp)\n| where gen_ai.response.error_code == \"ValidationException\"\n| keep user.id, gen_ai.request.model.id, cloud.account.id, gen_ai.response.error_code, target_time_window\n// count the number of users causing validation errors within a 1 minute window\n| stats total_denials = count(*) by target_time_window, user.id, cloud.account.id\n| where total_denials > 3", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_multiple_validation_exception_errors_by_single_user.toml"}
{"title": "Unusual High Word Policy Blocks Detected", "description": "Detects repeated compliance violation 'BLOCKED' actions coupled with specific policy name such as 'word_policy',\nindicating persistent misuse or attempts to probe the model's denied topics.", "query": "from logs-aws_bedrock.invocation-*\n| MV_EXPAND gen_ai.policy.name\n| where gen_ai.policy.action == \"BLOCKED\" and gen_ai.compliance.violation_detected == \"true\" and gen_ai.policy.name == \"word_policy\"\n| keep user.id\n| stats profanity_words= count() by user.id\n| where profanity_words > 5\n| sort profanity_words desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "aws_bedrock_multiple_word_policy_blocks_detected.toml"}
{"title": "Microsoft Entra ID SharePoint Access for User Principal via Auth Broker", "description": "This rule detects non-interactive authentication activity against SharePoint Online (`Office 365 SharePoint Online`) by\na user principal via the `Microsoft Authentication Broker` application. The session leverages a refresh token or Primary\nRefresh Token (PRT) without interactive sign-in, often used in OAuth phishing or token replay scenarios.", "query": "event.dataset: \"azure.signinlogs\"\n    and azure.signinlogs.properties.app_id: \"29d9ed98-a469-4536-ade2-f981bc1d605e\"\n    and azure.signinlogs.properties.resource_id: \"00000003-0000-0ff1-ce00-000000000000\"\n    and azure.signinlogs.identity: *\n    and azure.signinlogs.properties.user_principal_name: *\n    and azure.signinlogs.properties.incoming_token_type: (\"refreshToken\" or \"primaryRefreshToken\")\n    and azure.signinlogs.properties.is_interactive: false", "tactic": "Collection", "technique": "Data from Information Repositories", "technique_id": "T1213", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_entra_auth_broker_sharepoint_access_for_user_principal.toml"}
{"title": "Suspicious Email Access by First-Party Application via Microsoft Graph", "description": "Identifies access to email resources via Microsoft Graph API using an first-party application on behalf of a user\nprincipal. This behavior may indicate an adversary using a phished OAuth refresh token or a Primary Refresh Token (PRT)\nto access email resources. The pattern includes requests to Microsoft Graph API endpoints related to email, such as\n/me/mailFolders/inbox/messages or /users/{user_id}/messages, using a public client application ID and a user principal\nobject ID. This is a New Terms rule that only signals if the application ID and user principal object ID have not been\nseen doing this activity in the last 14 days.", "query": "event.dataset: \"azure.graphactivitylogs\" and\nazure.graphactivitylogs.properties.app_id: * and\nazure.graphactivitylogs.result_signature: 200 and\nazure.graphactivitylogs.properties.c_idtyp: \"user\" and\nazure.graphactivitylogs.properties.client_auth_method: 0 and\nhttp.request.method: (GET or POST or PUT or PATCH or DELETE) and (\n  url.path: (/v1.0/me/*cc or /v1.0/users/*) and\n  (\n    url.path: (*mail* or *messages* or *inbox*) or\n    azure.graphactivitylogs.properties.requestUri: (*mail* or *messages* or *inbox*)\n  ) or\n  azure.graphactivitylogs.properties.scopes: (\n    \"Mail.Read\" or \"Mail.ReadWrite\" or \"Mail.Send\" or \"email\"\n  )\n)", "tactic": "Collection", "technique": "Email Collection", "technique_id": "T1114", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_graph_email_access_by_unusual_public_client_via_graph.toml"}
{"title": "Azure Event Hub Authorization Rule Created or Updated", "description": "Identifies when an Event Hub Authorization Rule is created or updated in Azure. An authorization rule is associated with\nspecific rights, and carries a pair of cryptographic keys. When you create an Event Hubs namespace, a policy rule named\nRootManageSharedAccessKey is created for the namespace. This has manage permissions for the entire namespace and it's\nrecommended that you treat this rule like an administrative root account and don't use it in your application.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.EVENTHUB/NAMESPACES/AUTHORIZATIONRULES/WRITE\" and event.outcome:(Success or success)", "tactic": "Collection", "technique": "Data from Cloud Storage", "technique_id": "T1530", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_update_event_hub_auth_rule.toml"}
{"title": "Microsoft Entra ID Concurrent Sign-Ins with Suspicious Properties", "description": "Identifies concurrent azure signin events for the same user and from multiple sources, and where one of the authentication\nevent has some suspicious properties often associated to DeviceCode and OAuth phishing. Adversaries may steal Refresh\nTokens (RTs) via phishing to bypass multi-factor authentication (MFA) and gain unauthorized access to Azure resources.", "query": "FROM logs-azure.signinlogs* metadata _id, _version, _index\n// the rule is scheduled to run every hour and looks for events occured during last 1 hour.\n| where @timestamp > NOW() - 1 hours\n| where event.dataset == \"azure.signinlogs\" and source.ip is not null and azure.signinlogs.identity is not null and to_lower(event.outcome) == \"success\"\n| keep @timestamp, azure.signinlogs.identity, source.ip, azure.signinlogs.properties.authentication_requirement, azure.signinlogs.properties.app_id, azure.signinlogs.properties.resource_display_name, azure.signinlogs.properties.authentication_protocol, azure.signinlogs.properties.app_display_name\n// devicecode authentication no MFA\n| eval device_code = case(azure.signinlogs.properties.authentication_protocol == \"deviceCode\" and azure.signinlogs.properties.authentication_requirement != \"multiFactorAuthentication\", azure.signinlogs.identity, null),\n// potential Visual Studio Code OAuth code phish - sign-in events with client set to Visual Studio Code\n visual_studio = case(azure.signinlogs.properties.app_id == \"aebc6443-996d-45c2-90f0-388ff96faa56\" and azure.signinlogs.properties.resource_display_name == \"Microsoft Graph\", azure.signinlogs.identity, null),\n// Other sign-in events\n other = case(azure.signinlogs.properties.authentication_protocol != \"deviceCode\" and azure.signinlogs.properties.app_id != \"aebc6443-996d-45c2-90f0-388ff96faa56\", azure.signinlogs.identity, null)\n| stats total = COUNT(*), device_code_count = COUNT_DISTINCT(device_code), vsc = count_distinct(visual_studio), other_count = COUNT_DISTINCT(other), src_ip = COUNT_DISTINCT(source.ip), ips = values(source.ip), clients = values(azure.signinlogs.properties.app_display_name), resources = VALUES(azure.signinlogs.properties.resource_display_name), auth_requirement = VALUES(azure.signinlogs.properties.authentication_requirement) by azure.signinlogs.identity\n// 2 unique source.ip for same account - which may indicate the presence 2 sign-ins one by the adversary and the other by the victim\n| where src_ip >= 2 and (device_code_count > 0 or vsc >0)", "tactic": "Credential Access", "technique": "Steal Application Access Token", "technique_id": "T1528", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_azure_entra_suspicious_signin.toml"}
{"title": "Azure Entra MFA TOTP Brute Force Attempts", "description": "Identifies brute force attempts against Azure Entra multi-factor authentication (MFA) Time-based One-Time Password\n(TOTP) verification codes. This rule detects high frequency failed TOTP code attempts for a single user in a short\ntime-span. Adversaries with valid credentials, when attempting to login to Azure portal or other Azure services, may be\nprompted to provide a TOTP code as part of the MFA process. If successful, adversaries can bypass MFA and gain\nunauthorized access to Azure resources.", "query": "from logs-azure.signinlogs* metadata _id, _version, _index\n| where\n    // filter for Entra Sign-In Logs\n    event.dataset == \"azure.signinlogs\"\n    and azure.signinlogs.operation_name == \"Sign-in activity\"\n\n    // filter for MFA attempts with OATH conditional access attempts or TOTP\n    and azure.signinlogs.properties.authentication_requirement == \"multiFactorAuthentication\"\n    and azure.signinlogs.properties.mfa_detail.auth_method == \"OATH verification code\"\n\n    // filter on failures only from brute-force attempts\n    and azure.signinlogs.properties.conditional_access_status == \"failure\"\n    and azure.signinlogs.result_description == \"Authentication failed during strong authentication request.\"\n| keep azure.signinlogs.properties.sign_in_identifier\n| stats\n    // aggregate by the sign-in account or principal\n    failed_totp_code_attempts = count(*) by azure.signinlogs.properties.sign_in_identifier\n| where\n    // filter on high frequency for a single user\n    failed_totp_code_attempts > 30", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_azure_entra_totp_brute_force_attempts.toml"}
{"title": "Azure Full Network Packet Capture Detected", "description": "Identifies potential full network packet capture in Azure. Packet Capture is an Azure Network Watcher feature that can\nbe used to inspect network traffic. This feature can potentially be abused to read sensitive data from unencrypted\ninternal traffic.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\n    (\n        MICROSOFT.NETWORK/*/STARTPACKETCAPTURE/ACTION or\n        MICROSOFT.NETWORK/*/VPNCONNECTIONS/STARTPACKETCAPTURE/ACTION or\n        MICROSOFT.NETWORK/*/PACKETCAPTURES/WRITE\n    ) and\nevent.outcome:(Success or success)", "tactic": "Credential Access", "technique": "Network Sniffing", "technique_id": "T1040", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_azure_full_network_packet_capture_detected.toml"}
{"title": "Microsoft Entra ID Sign-In Brute Force Activity", "description": "Identifies potential brute-force attacks targeting user accounts by analyzing failed sign-in patterns in Microsoft Entra\nID Sign-In Logs. This detection focuses on a high volume of failed interactive or non-interactive authentication\nattempts within a short time window, often indicative of password spraying, credential stuffing, or password guessing.\nAdversaries may use these techniques to gain unauthorized access to applications integrated with Entra ID or to\ncompromise valid user accounts.", "query": "FROM logs-azure.signinlogs*\n\n// Define a time window for grouping and maintain the original event timestamp\n| EVAL\n    time_window = DATE_TRUNC(15 minutes, @timestamp),\n    event_time = @timestamp\n\n// Filter relevant failed authentication events with specific error codes\n| WHERE event.dataset == \"azure.signinlogs\"\n    AND event.category == \"authentication\"\n    AND azure.signinlogs.category IN (\"NonInteractiveUserSignInLogs\", \"SignInLogs\")\n    AND event.outcome == \"failure\"\n    AND azure.signinlogs.properties.authentication_requirement == \"singleFactorAuthentication\"\n    AND azure.signinlogs.properties.status.error_code IN (\n        50034,  // UserAccountNotFound\n        50126,  // InvalidUsernameOrPassword\n        50055,  // PasswordExpired\n        50056,  // InvalidPassword\n        50057,  // UserDisabled\n        50064,  // CredentialValidationFailure\n        50076,  // MFARequiredButNotPassed\n        50079,  // MFARegistrationRequired\n        50105,  // EntitlementGrantsNotFound\n        70000,  // InvalidGrant\n        70008,  // ExpiredOrRevokedRefreshToken\n        70043,  // BadTokenDueToSignInFrequency\n        80002,  // OnPremisePasswordValidatorRequestTimedOut\n        80005,  // OnPremisePasswordValidatorUnpredictableWebException\n        50144,  // InvalidPasswordExpiredOnPremPassword\n        50135,  // PasswordChangeCompromisedPassword\n        50142,  // PasswordChangeRequiredConditionalAccess\n        120000, // PasswordChangeIncorrectCurrentPassword\n        120002, // PasswordChangeInvalidNewPasswordWeak\n        120020  // PasswordChangeFailure\n    )\n    AND azure.signinlogs.properties.user_principal_name IS NOT NULL AND azure.signinlogs.properties.user_principal_name != \"\"\"    AND user_agent.original != \"Mozilla/5.0 (compatible; MSAL 1.0) PKeyAuth/1.0\"\n    AND source.`as`.organization.name != \"MICROSOFT-CORP-MSN-AS-BLOCK\"\n\n// Aggregate statistics for behavioral pattern analysis\n| STATS\n    authentication_requirement = VALUES(azure.signinlogs.properties.authentication_requirement),\n    client_app_id = VALUES(azure.signinlogs.properties.app_id),\n    client_app_display_name = VALUES(azure.signinlogs.properties.app_display_name),\n    target_resource_id = VALUES(azure.signinlogs.properties.resource_id),\n    target_resource_display_name = VALUES(azure.signinlogs.properties.resource_display_name),\n    conditional_access_status = VALUES(azure.signinlogs.properties.conditional_access_status),\n    device_detail_browser = VALUES(azure.signinlogs.properties.device_detail.browser),\n    device_detail_device_id = VALUES(azure.signinlogs.properties.device_detail.device_id),\n    device_detail_operating_system = VALUES(azure.signinlogs.properties.device_detail.operating_system),\n    incoming_token_type = VALUES(azure.signinlogs.properties.incoming_token_type),\n    risk_state = VALUES(azure.signinlogs.properties.risk_state),\n    session_id = VALUES(azure.signinlogs.properties.session_id),\n    user_id = VALUES(azure.signinlogs.properties.user_id),\n    user_principal_name = VALUES(azure.signinlogs.properties.user_principal_name),\n    result_description = VALUES(azure.signinlogs.result_description),\n    result_signature = VALUES(azure.signinlogs.result_signature),\n    result_type = VALUES(azure.signinlogs.result_type),\n\n    unique_users = COUNT_DISTINCT(azure.signinlogs.properties.user_id),\n    user_id_list = VALUES(azure.signinlogs.properties.user_id),\n    login_errors = VALUES(azure.signinlogs.result_description),\n    unique_login_errors = COUNT_DISTINCT(azure.signinlogs.result_description),\n    error_codes = VALUES(azure.signinlogs.properties.status.error_code),\n    unique_error_codes = COUNT_DISTINCT(azure.signinlogs.properties.status.error_code),\n    request_types = VALUES(azure.signinlogs.properties.incoming_token_type),\n    app_names = VALUES(azure.signinlogs.properties.app_display_name),\n    ip_list = VALUES(source.ip),\n    unique_ips = COUNT_DISTINCT(source.ip),\n    source_orgs = VALUES(source.`as`.organization.name),\n    countries = VALUES(source.geo.country_name),\n    unique_country_count = COUNT_DISTINCT(source.geo.country_name),\n    unique_asn_orgs = COUNT_DISTINCT(source.`as`.organization.name),\n    first_seen = MIN(@timestamp),\n    last_seen = MAX(@timestamp),\n    total_attempts = COUNT()\nBY time_window\n\n// Determine brute force behavior type based on statistical thresholds\n| EVAL\n    duration_seconds = DATE_DIFF(\"seconds\", first_seen, last_seen),\n    bf_type = CASE(\n        // Many users, relatively few distinct login errors, distributed over multiple IPs (but not too many),\n        // and happens quickly. Often bots using leaked credentials.\n        unique_users >= 10 AND total_attempts >= 30 AND unique_login_errors <= 3\n            AND unique_ips >= 5\n            AND duration_seconds <= 600\n            AND unique_users > unique_ips,\n        \"credential_stuffing\",\n\n        // One password against many users. Single error (e.g., \"InvalidPassword\"), not necessarily fast.\n        unique_users >= 15 AND unique_login_errors == 1 AND total_attempts >= 15 AND duration_seconds <= 1800,\n        \"password_spraying\",\n\n        // One user targeted repeatedly (same error), OR extremely noisy pattern from many IPs.\n        (unique_users == 1 AND unique_login_errors == 1 AND total_attempts >= 30 AND duration_seconds <= 300)\n            OR (unique_users <= 3 AND unique_ips > 30 AND total_attempts >= 100),\n        \"password_guessing\",\n\n        // everything else\n        \"other\"\n    )\n\n// Only keep columns necessary for detection output/reporting\n| KEEP\n    time_window, bf_type, duration_seconds, total_attempts, first_seen, last_seen,\n    unique_users, user_id_list, login_errors, unique_login_errors,\n    unique_error_codes, error_codes, request_types, app_names,\n    ip_list, unique_ips, source_orgs, countries,\n    unique_country_count, unique_asn_orgs,\n    authentication_requirement, client_app_id, client_app_display_name,\n    target_resource_id, target_resource_display_name, conditional_access_status,\n    device_detail_browser, device_detail_device_id, device_detail_operating_system,\n    incoming_token_type, risk_state, session_id, user_id,\n    user_principal_name, result_description, result_signature, result_type\n\n// Remove anything not classified as credential attack activity\n| WHERE bf_type != \"other\"", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_entra_id_brute_force_activity.toml"}
{"title": "Entra ID Device Code Auth with Broker Client", "description": "Identifies device code authentication with an Azure broker client for Entra ID. Adversaries abuse Primary Refresh Tokens (PRTs) to bypass multi-factor authentication (MFA) and gain unauthorized access to Azure resources. PRTs are used in Conditional Access policies to enforce device-based controls. Compromising PRTs allows attackers to bypass these policies and gain unauthorized access. This rule detects successful sign-ins using device code authentication with the Entra ID broker client application ID (29d9ed98-a469-4536-ade2-f981bc1d605e).", "query": "event.dataset:(azure.activitylogs or azure.signinlogs)\n    and azure.signinlogs.properties.authentication_protocol:deviceCode\n    and azure.signinlogs.properties.conditional_access_audiences.application_id:29d9ed98-a469-4536-ade2-f981bc1d605e\n    and event.outcome:success or (\n        azure.activitylogs.properties.appId:29d9ed98-a469-4536-ade2-f981bc1d605e\n        and azure.activitylogs.properties.authentication_protocol:deviceCode)", "tactic": "Credential Access", "technique": "Steal Application Access Token", "technique_id": "T1528", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_entra_id_device_code_auth_with_broker_client.toml"}
{"title": "Microsoft Entra ID Exccessive Account Lockouts Detected", "description": "Identifies a high count of failed Microsoft Entra ID sign-in attempts as the result of the target user account being\nlocked out. Adversaries may attempt to brute-force user accounts by repeatedly trying to authenticate with incorrect\ncredentials, leading to account lockouts by Entra ID Smart Lockout policies.", "query": "FROM logs-azure.signinlogs*\n\n| EVAL\n    time_window = DATE_TRUNC(30 minutes, @timestamp),\n    user_id = TO_LOWER(azure.signinlogs.properties.user_principal_name),\n    ip = source.ip,\n    login_error = azure.signinlogs.result_description,\n    error_code = azure.signinlogs.properties.status.error_code,\n    request_type = TO_LOWER(azure.signinlogs.properties.incoming_token_type),\n    app_name = TO_LOWER(azure.signinlogs.properties.app_display_name),\n    asn_org = source.`as`.organization.name,\n    country = source.geo.country_name,\n    user_agent = user_agent.original,\n    event_time = @timestamp\n\n| WHERE event.dataset == \"azure.signinlogs\"\n    AND event.category == \"authentication\"\n    AND azure.signinlogs.category IN (\"NonInteractiveUserSignInLogs\", \"SignInLogs\")\n    AND event.outcome == \"failure\"\n    AND azure.signinlogs.properties.authentication_requirement == \"singleFactorAuthentication\"\n    AND error_code == 50053\n    AND user_id IS NOT NULL AND user_id != \"\"\"    AND asn_org != \"MICROSOFT-CORP-MSN-AS-BLOCK\"\n\n| STATS\n    authentication_requirement = VALUES(azure.signinlogs.properties.authentication_requirement),\n    client_app_id = VALUES(azure.signinlogs.properties.app_id),\n    client_app_display_name = VALUES(azure.signinlogs.properties.app_display_name),\n    target_resource_id = VALUES(azure.signinlogs.properties.resource_id),\n    target_resource_display_name = VALUES(azure.signinlogs.properties.resource_display_name),\n    conditional_access_status = VALUES(azure.signinlogs.properties.conditional_access_status),\n    device_detail_browser = VALUES(azure.signinlogs.properties.device_detail.browser),\n    device_detail_device_id = VALUES(azure.signinlogs.properties.device_detail.device_id),\n    device_detail_operating_system = VALUES(azure.signinlogs.properties.device_detail.operating_system),\n    incoming_token_type = VALUES(azure.signinlogs.properties.incoming_token_type),\n    risk_state = VALUES(azure.signinlogs.properties.risk_state),\n    session_id = VALUES(azure.signinlogs.properties.session_id),\n    user_id = VALUES(azure.signinlogs.properties.user_id),\n    user_principal_name = VALUES(azure.signinlogs.properties.user_principal_name),\n    result_description = VALUES(azure.signinlogs.result_description),\n    result_signature = VALUES(azure.signinlogs.result_signature),\n    result_type = VALUES(azure.signinlogs.result_type),\n\n    unique_users = COUNT_DISTINCT(user_id),\n    user_id_list = VALUES(user_id),\n    login_errors = VALUES(login_error),\n    unique_login_errors = COUNT_DISTINCT(login_error),\n    error_codes = VALUES(error_code),\n    unique_error_codes = COUNT_DISTINCT(error_code),\n    request_types = VALUES(request_type),\n    app_names = VALUES(app_name),\n    ip_list = VALUES(ip),\n    unique_ips = COUNT_DISTINCT(ip),\n    source_orgs = VALUES(asn_org),\n    countries = VALUES(country),\n    unique_country_count = COUNT_DISTINCT(country),\n    unique_asn_orgs = COUNT_DISTINCT(asn_org),\n    first_seen = MIN(event_time),\n    last_seen = MAX(event_time),\n    total_attempts = COUNT()\nBY time_window\n| WHERE unique_users >= 15 AND total_attempts >= 20\n| KEEP\n    time_window, total_attempts, first_seen, last_seen,\n    unique_users, user_id_list, login_errors, unique_login_errors,\n    unique_error_codes, error_codes, request_types, app_names,\n    ip_list, unique_ips, source_orgs, countries,\n    unique_country_count, unique_asn_orgs,\n    authentication_requirement, client_app_id, client_app_display_name,\n    target_resource_id, target_resource_display_name, conditional_access_status,\n    device_detail_browser, device_detail_device_id, device_detail_operating_system,\n    incoming_token_type, risk_state, session_id, user_id,\n    user_principal_name, result_description, result_signature, result_type", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_entra_id_excessive_account_lockouts.toml"}
{"title": "Microsoft 365 Brute Force via Entra ID Sign-Ins", "description": "Identifies potential brute-force attacks targeting Microsoft 365 user accounts by analyzing failed sign-in patterns in\nMicrosoft Entra ID Sign-In Logs. This detection focuses on a high volume of failed interactive or non-interactive\nauthentication attempts within a short time window, often indicative of password spraying, credential stuffing, or\npassword guessing. Adversaries may use these techniques to gain unauthorized access to Microsoft 365 services such as\nExchange Online, SharePoint, or Teams.", "query": "FROM logs-azure.signinlogs*\n\n| EVAL\n    time_window = DATE_TRUNC(15 minutes, @timestamp),\n    user_id = TO_LOWER(azure.signinlogs.properties.user_principal_name),\n    ip = source.ip,\n    login_error = azure.signinlogs.result_description,\n    error_code = azure.signinlogs.properties.status.error_code,\n    request_type = TO_LOWER(azure.signinlogs.properties.incoming_token_type),\n    app_name = TO_LOWER(azure.signinlogs.properties.app_display_name),\n    asn_org = source.`as`.organization.name,\n    country = source.geo.country_name,\n    user_agent = user_agent.original,\n    event_time = @timestamp\n\n| WHERE event.dataset == \"azure.signinlogs\"\n    AND event.category == \"authentication\"\n    AND azure.signinlogs.category IN (\"NonInteractiveUserSignInLogs\", \"SignInLogs\")\n    AND azure.signinlogs.properties.resource_display_name RLIKE \"(.*)365|SharePoint|Exchange|Teams|Office(.*)\"\n    AND event.outcome == \"failure\"\n    AND error_code != 50053\n    AND azure.signinlogs.properties.status.error_code IN (\n        50034,  // UserAccountNotFound\n        50126,  // InvalidUsernameOrPassword\n        50055,  // PasswordExpired\n        50056,  // InvalidPassword\n        50057,  // UserDisabled\n        50064,  // CredentialValidationFailure\n        50076,  // MFARequiredButNotPassed\n        50079,  // MFARegistrationRequired\n        50105,  // EntitlementGrantsNotFound\n        70000,  // InvalidGrant\n        70008,  // ExpiredOrRevokedRefreshToken\n        70043,  // BadTokenDueToSignInFrequency\n        80002,  // OnPremisePasswordValidatorRequestTimedOut\n        80005,  // OnPremisePasswordValidatorUnpredictableWebException\n        50144,  // InvalidPasswordExpiredOnPremPassword\n        50135,  // PasswordChangeCompromisedPassword\n        50142,  // PasswordChangeRequiredConditionalAccess\n        120000, // PasswordChangeIncorrectCurrentPassword\n        120002, // PasswordChangeInvalidNewPasswordWeak\n        120020  // PasswordChangeFailure\n    )\n    AND user_id IS NOT NULL AND user_id != \"\"\"    AND user_agent != \"Mozilla/5.0 (compatible; MSAL 1.0) PKeyAuth/1.0\"\n\n| STATS\n    authentication_requirement = VALUES(azure.signinlogs.properties.authentication_requirement),\n    client_app_id = VALUES(azure.signinlogs.properties.app_id),\n    client_app_display_name = VALUES(azure.signinlogs.properties.app_display_name),\n    target_resource_id = VALUES(azure.signinlogs.properties.resource_id),\n    target_resource_display_name = VALUES(azure.signinlogs.properties.resource_display_name),\n    conditional_access_status = VALUES(azure.signinlogs.properties.conditional_access_status),\n    device_detail_browser = VALUES(azure.signinlogs.properties.device_detail.browser),\n    device_detail_device_id = VALUES(azure.signinlogs.properties.device_detail.device_id),\n    device_detail_operating_system = VALUES(azure.signinlogs.properties.device_detail.operating_system),\n    incoming_token_type = VALUES(azure.signinlogs.properties.incoming_token_type),\n    risk_state = VALUES(azure.signinlogs.properties.risk_state),\n    session_id = VALUES(azure.signinlogs.properties.session_id),\n    user_id = VALUES(azure.signinlogs.properties.user_id),\n    user_principal_name = VALUES(azure.signinlogs.properties.user_principal_name),\n    result_description = VALUES(azure.signinlogs.result_description),\n    result_signature = VALUES(azure.signinlogs.result_signature),\n    result_type = VALUES(azure.signinlogs.result_type),\n\n    unique_users = COUNT_DISTINCT(user_id),\n    user_id_list = VALUES(user_id),\n    login_errors = VALUES(login_error),\n    unique_login_errors = COUNT_DISTINCT(login_error),\n    error_codes = VALUES(error_code),\n    unique_error_codes = COUNT_DISTINCT(error_code),\n    request_types = VALUES(request_type),\n    app_names = VALUES(app_name),\n    ip_list = VALUES(ip),\n    unique_ips = COUNT_DISTINCT(ip),\n    source_orgs = VALUES(asn_org),\n    countries = VALUES(country),\n    unique_country_count = COUNT_DISTINCT(country),\n    unique_asn_orgs = COUNT_DISTINCT(asn_org),\n    first_seen = MIN(event_time),\n    last_seen = MAX(event_time),\n    total_attempts = COUNT()\nBY time_window\n\n| EVAL\n    duration_seconds = DATE_DIFF(\"seconds\", first_seen, last_seen),\n    bf_type = CASE(\n        // Many users, relatively few distinct login errors, distributed over multiple IPs (but not too many),\n        // and happens quickly. Often bots using leaked credentials.\n        unique_users >= 10 AND total_attempts >= 30 AND unique_login_errors <= 3\n            AND unique_ips >= 5\n            AND duration_seconds <= 600\n            AND unique_users > unique_ips,\n        \"credential_stuffing\",\n\n        // One password against many users. Single error (e.g., \"InvalidPassword\"), not necessarily fast.\n        unique_users >= 15 AND unique_login_errors == 1 AND total_attempts >= 15 AND duration_seconds <= 1800,\n        \"password_spraying\",\n\n        // One user targeted repeatedly (same error), OR extremely noisy pattern from many IPs.\n        (unique_users == 1 AND unique_login_errors == 1 AND total_attempts >= 30 AND duration_seconds <= 300)\n            OR (unique_users <= 3 AND unique_ips > 30 AND total_attempts >= 100),\n        \"password_guessing\",\n\n        // everything else\n        \"other\"\n    )\n\n| KEEP\n    time_window, bf_type, duration_seconds, total_attempts, first_seen, last_seen,\n    unique_users, user_id_list, login_errors, unique_login_errors,\n    unique_error_codes, error_codes, request_types, app_names,\n    ip_list, unique_ips, source_orgs, countries,\n    unique_country_count, unique_asn_orgs,\n    authentication_requirement, client_app_id, client_app_display_name,\n    target_resource_id, target_resource_display_name, conditional_access_status,\n    device_detail_browser, device_detail_device_id, device_detail_operating_system,\n    incoming_token_type, risk_state, session_id, user_id,\n    user_principal_name, result_description, result_signature, result_type\n\n| WHERE bf_type != \"other\"", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_entra_signin_brute_force_microsoft_365.toml"}
{"title": "Deprecated - Azure Entra Sign-in Brute Force Microsoft 365 Accounts by Repeat Source", "description": "Identifies potential brute-force attempts against Microsoft 365 user accounts by detecting a high number of failed\ninteractive or non-interactive login attempts within a 30-minute window from a single source. Attackers may attempt to\nbrute force user accounts to gain unauthorized access to Microsoft 365 services via different services such as Exchange,\nSharePoint, or Teams.", "query": "from logs-azure.signinlogs*\n| WHERE\n  event.dataset == \"azure.signinlogs\"\n  and event.category == \"authentication\"\n  and to_lower(azure.signinlogs.properties.resource_display_name) rlike \"(.*)365(.*)\"\n  and azure.signinlogs.category in (\"NonInteractiveUserSignInLogs\", \"SignInLogs\")\n  and event.outcome != \"success\"\n\n  // For tuning, review azure.signinlogs.properties.status.error_code\n  // https://learn.microsoft.com/en-us/entra/identity-platform/reference-error-codes\n\n// keep only relevant fields\n| keep event.dataset, event.category, azure.signinlogs.properties.resource_display_name, azure.signinlogs.category, event.outcome, azure.signinlogs.properties.user_principal_name, source.ip\n\n// Count the number of unique targets per source IP\n| stats\n  target_count = count_distinct(azure.signinlogs.properties.user_principal_name) by source.ip\n\n// Filter for at least 10 distinct failed login attempts from a single source\n| where target_count >= 10", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_entra_signin_brute_force_microsoft_365_repeat_source.toml"}
{"title": "First Occurrence of Entra ID Auth via DeviceCode Protocol", "description": "Identifies when a user is observed for the first time in the last 14 days authenticating using the device code\nauthentication workflow. This authentication workflow can be abused by attackers to phish users and steal access tokens\nto impersonate the victim. By its very nature, device code should only be used when logging in to devices without\nkeyboards, where it is difficult to enter emails and passwords.", "query": "event.dataset:(azure.activitylogs or azure.signinlogs)\n    and (\n            azure.signinlogs.properties.authentication_protocol:deviceCode or\n            azure.signinlogs.properties.original_transfer_method: \"Device code flow\" or\n            azure.activitylogs.properties.authentication_protocol:deviceCode\n        )\n    and event.outcome:success", "tactic": "Credential Access", "technique": "Steal Application Access Token", "technique_id": "T1528", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_first_time_seen_device_code_auth.toml"}
{"title": "Azure Storage Account Key Regenerated", "description": "Identifies a rotation to storage account access keys in Azure. Regenerating access keys can affect any applications or\nAzure services that are dependent on the storage account key. Adversaries may regenerate a key as a means of acquiring\ncredentials to access systems and resources.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.STORAGE/STORAGEACCOUNTS/REGENERATEKEY/ACTION\" and event.outcome:(Success or success)", "tactic": "Credential Access", "technique": "Steal Application Access Token", "technique_id": "T1528", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_storage_account_key_regenerated.toml"}
{"title": "Azure Automation Runbook Deleted", "description": "Identifies when an Azure Automation runbook is deleted. An adversary may delete an Azure Automation runbook in order to\ndisrupt their target's automated business operations or to remove a malicious runbook for defense evasion.", "query": "event.dataset:azure.activitylogs and\n    azure.activitylogs.operation_name:\"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/DELETE\" and\n    event.outcome:(Success or success)", "tactic": "Defense Evasion", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_azure_automation_runbook_deleted.toml"}
{"title": "Azure Blob Permissions Modification", "description": "Identifies when the Azure role-based access control (Azure RBAC) permissions are modified for an Azure Blob. An\nadversary may modify the permissions on a blob to weaken their target's security controls or an administrator may\ninadvertently modify the permissions, which could lead to data exposure or loss.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:(\n     \"MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICES/CONTAINERS/BLOBS/MANAGEOWNERSHIP/ACTION\" or\n     \"MICROSOFT.STORAGE/STORAGEACCOUNTS/BLOBSERVICES/CONTAINERS/BLOBS/MODIFYPERMISSIONS/ACTION\") and\n  event.outcome:(Success or success)", "tactic": "Defense Evasion", "technique": "File and Directory Permissions Modification", "technique_id": "T1222", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_azure_blob_permissions_modified.toml"}
{"title": "Azure Event Hub Deletion", "description": "Identifies an Event Hub deletion in Azure. An Event Hub is an event processing service that ingests and processes large\nvolumes of events and data. An adversary may delete an Event Hub in an attempt to evade detection.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELETE\" and event.outcome:(Success or success)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_event_hub_deletion.toml"}
{"title": "Azure Frontdoor Web Application Firewall (WAF) Policy Deleted", "description": "Identifies the deletion of a Frontdoor Web Application Firewall (WAF) Policy in Azure. An adversary may delete a\nFrontdoor Web Application Firewall (WAF) Policy in an attempt to evade defenses and/or to eliminate barriers to their\nobjective.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.NETWORK/FRONTDOORWEBAPPLICATIONFIREWALLPOLICIES/DELETE\" and event.outcome:(Success or success)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_frontdoor_firewall_policy_deletion.toml"}
{"title": "Azure Kubernetes Events Deleted", "description": "Identifies when events are deleted in Azure Kubernetes. Kubernetes events are objects that log any state changes.\nExample events are a container creation, an image pull, or a pod scheduling on a node. An adversary may delete events in\nAzure Kubernetes in an attempt to evade detection.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/EVENTS.K8S.IO/EVENTS/DELETE\" and\nevent.outcome:(Success or success)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_kubernetes_events_deleted.toml"}
{"title": "Azure Alert Suppression Rule Created or Modified", "description": "Identifies the creation of suppression rules in Azure. Suppression rules are a mechanism used to suppress alerts\npreviously identified as false positives or too noisy to be in production. This mechanism can be abused or mistakenly\nconfigured, resulting in defense evasions and loss of security visibility.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.SECURITY/ALERTSSUPPRESSIONRULES/WRITE\" and\nevent.outcome: \"success\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suppression_rule_created.toml"}
{"title": "BloodHound Suite User-Agents Detected", "description": "Identifies potential enumeration activity using AzureHound, SharpHound, or BloodHound across Microsoft cloud services.\nThese tools are often used by red teamers and adversaries to map users, groups, roles, applications, and access\nrelationships within Microsoft Entra ID (Azure AD) and Microsoft 365.", "query": "any where event.dataset : (\n    \"azure.activitylogs\",\n    \"azure.graphactivitylogs\",\n    \"azure.auditlogs\",\n    \"azure.signinlogs\",\n    \"o365.audit\"\n) and user_agent.original regex~ \"(azure|sharp|blood)(hound)/.*\"", "tactic": "Discovery", "technique": "Permission Groups Discovery", "technique_id": "T1069", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_bloodhound_user_agents_detected.toml"}
{"title": "Azure Command Execution on Virtual Machine", "description": "Identifies command execution on a virtual machine (VM) in Azure. A Virtual Machine Contributor role lets you manage\nvirtual machines, but not access them, nor access the virtual network or storage account they\u2019re connected to. However,\ncommands can be run via PowerShell on the VM, which execute as System. Other roles, such as certain Administrator roles\nmay be able to execute commands on a VM as well.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION\" and event.outcome:(Success or success)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_command_virtual_machine.toml"}
{"title": "Azure Kubernetes Pods Deleted", "description": "Identifies the deletion of Azure Kubernetes Pods. Adversaries may delete a Kubernetes pod to disrupt the normal behavior\nof the environment.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/PODS/DELETE\" and\nevent.outcome:(Success or success)", "tactic": "Impact", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_kubernetes_pod_deleted.toml"}
{"title": "Deprecated - Azure Virtual Network Device Modified or Deleted", "description": "Identifies when a virtual network device is modified or deleted. This can be a network virtual appliance, virtual hub,\nor virtual router.\n\n**Deprecated Notice** - This rule has been deprecated in favor of other rules that provide more contextual threat behavior for Azure Virtual Network.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:(\"MICROSOFT.NETWORK/NETWORKINTERFACES/TAPCONFIGURATIONS/WRITE\" or\n\"MICROSOFT.NETWORK/NETWORKINTERFACES/TAPCONFIGURATIONS/DELETE\" or \"MICROSOFT.NETWORK/NETWORKINTERFACES/WRITE\" or\n\"MICROSOFT.NETWORK/NETWORKINTERFACES/JOIN/ACTION\" or \"MICROSOFT.NETWORK/NETWORKINTERFACES/DELETE\" or\n\"MICROSOFT.NETWORK/NETWORKVIRTUALAPPLIANCES/DELETE\" or \"MICROSOFT.NETWORK/NETWORKVIRTUALAPPLIANCES/WRITE\" or\n\"MICROSOFT.NETWORK/VIRTUALHUBS/DELETE\" or \"MICROSOFT.NETWORK/VIRTUALHUBS/WRITE\" or\n\"MICROSOFT.NETWORK/VIRTUALROUTERS/WRITE\" or \"MICROSOFT.NETWORK/VIRTUALROUTERS/DELETE\") and\nevent.outcome:(Success or success)", "tactic": "Impact", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_virtual_network_device_modified.toml"}
{"title": "Azure Active Directory High Risk User Sign-in Heuristic", "description": "Identifies high risk Azure Active Directory (AD) sign-ins by leveraging Microsoft Identity Protection machine learning\nand heuristics.", "query": "event.dataset:azure.signinlogs and\n  azure.signinlogs.properties.risk_state:(\"confirmedCompromised\" or \"atRisk\") and event.outcome:(success or Success)", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_azure_active_directory_high_risk_signin_atrisk_or_confirmed.toml"}
{"title": "Microsoft Entra ID Session Reuse with Suspicious Graph Access", "description": "Identifies potential session hijacking or token replay in Microsoft Entra ID. This rule detects cases where a user signs\nin and subsequently accesses Microsoft Graph from a different IP address using the same session ID within a short time\nwindow. This may indicate the use of a stolen refresh/access token or session cookie to impersonate the user and\ninteract with Microsoft services.", "query": "FROM logs-azure.*\n| WHERE\n    (event.dataset == \"azure.signinlogs\" AND source.`as`.organization.name != \"MICROSOFT-CORP-MSN-AS-BLOCK\" AND azure.signinlogs.properties.session_id IS NOT NULL)\n    OR\n    (event.dataset == \"azure.graphactivitylogs\" AND source.`as`.organization.name != \"MICROSOFT-CORP-MSN-AS-BLOCK\" AND azure.graphactivitylogs.properties.c_sid IS NOT NULL)\n| EVAL\n    session_id = COALESCE(azure.signinlogs.properties.session_id, azure.graphactivitylogs.properties.c_sid),\n    user_id = COALESCE(azure.signinlogs.properties.user_id, azure.graphactivitylogs.properties.user_principal_object_id),\n    client_id = COALESCE(azure.signinlogs.properties.app_id, azure.graphactivitylogs.properties.app_id),\n    source_ip = source.ip,\n    event_time = @timestamp,\n    event_type = CASE(\n        event.dataset == \"azure.signinlogs\", \"signin\",\n        event.dataset == \"azure.graphactivitylogs\", \"graph\",\n        \"other\"\n    ),\n    time_window = DATE_TRUNC(5 minutes, @timestamp)\n| KEEP session_id, source_ip, event_time, event_type, time_window, user_id, client_id\n| STATS\n    user_id = VALUES(user_id),\n    session_id = VALUES(session_id),\n    source_ip_list = VALUES(source_ip),\n    source_ip_count = COUNT_DISTINCT(source_ip),\n    client_id_list = VALUES(client_id),\n    application_count = COUNT_DISTINCT(client_id),\n    event_type_list = VALUES(event_type),\n    event_type_count = COUNT_DISTINCT(event_type),\n    event_start = MIN(event_time),\n    event_end = MAX(event_time),\n    signin_time = MIN(CASE(event_type == \"signin\", event_time, NULL)),\n    graph_time = MIN(CASE(event_type == \"graph\", event_time, NULL)),\n    document_count = COUNT()\n  BY session_id, time_window\n| EVAL\n    duration_minutes = DATE_DIFF(\"minutes\", event_start, event_end),\n    signin_to_graph_delay_minutes = DATE_DIFF(\"minutes\", signin_time, graph_time)\n| WHERE\n    event_type_count > 1 AND\n    source_ip_count > 1 AND\n    duration_minutes <= 5 AND\n    signin_time IS NOT NULL AND\n    graph_time IS NOT NULL AND\n    signin_to_graph_delay_minutes >= 0", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_graph_single_session_from_multiple_addresses.toml"}
{"title": "Microsoft Entra ID High Risk Sign-in", "description": "Identifies high risk Microsoft Entra ID sign-ins by leveraging Microsoft's Identity Protection machine learning\nand heuristics. Identity Protection categorizes risk into three tiers: low, medium, and high. While Microsoft does not\nprovide specific details about how risk is calculated, each level brings higher confidence that the user or sign-in is\ncompromised.", "query": "event.dataset:azure.signinlogs and\n  (\n    azure.signinlogs.properties.risk_level_during_signin:high or\n    azure.signinlogs.properties.risk_level_aggregated:high\n  )", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_id_high_risk_signin.toml"}
{"title": "Entra ID Protection - Risk Detection - Sign-in Risk", "description": "Identifies sign-in risk detection events via Microsofts Entra ID Protection service. Entra ID Protection detects sign-in\nactivity such as anonymized IP addresses, unlikely travel, password spray, and more.", "query": "event.dataset: \"azure.identity_protection\" and\n    event.action: \"User Risk Detection\" and\n    azure.identityprotection.properties.activity: \"signin\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_id_protection_sign_in_risk_detected.toml"}
{"title": "Entra ID Protection - Risk Detection - User Risk", "description": "Identifies user risk detection events via Microsofts Entra ID Protection service. Entra ID Protection detects user risk\nactivity such as anonymized IP addresses, unlikely travel, password spray, and more.", "query": "event.dataset: \"azure.identity_protection\" and\n    event.action: \"User Risk Detection\" and\n    azure.identityprotection.properties.activity: \"user\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_id_protection_user_risk_detected.toml"}
{"title": "Suspicious Microsoft OAuth Flow via Auth Broker to DRS", "description": "Identifies separate OAuth authorization flows in Microsoft Entra ID where the same user principal and session ID are\nobserved across multiple IP addresses within a 5-minute window. These flows involve the Microsoft Authentication Broker\n(MAB) as the client application and the Device Registration Service (DRS) as the target resource. This pattern is highly\nindicative of OAuth phishing activity, where an adversary crafts a legitimate Microsoft login URL to trick a user into\ncompleting authentication and sharing the resulting authorization code, which is then exchanged for an access and\nrefresh token by the attacker.", "query": "FROM logs-azure.signinlogs* metadata _id, _version, _index\n\n// Filter for Microsoft Entra ID sign-in logs\n| WHERE event.dataset == \"azure.signinlogs\"\n    AND event.outcome == \"success\"\n    AND azure.signinlogs.properties.user_type == \"Member\"\n    AND azure.signinlogs.identity IS NOT NULL\n    AND azure.signinlogs.properties.user_principal_name IS NOT NULL\n    AND source.address IS NOT NULL\n\n    // Filter for MAB as client (app_id) and DRS as resource (resource_id)\n    AND azure.signinlogs.properties.app_id == \"29d9ed98-a469-4536-ade2-f981bc1d605e\" // MAB\n    AND azure.signinlogs.properties.resource_id  == \"01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9\" // DRS\n\n// Normalize timestamps into 30-minute detection windows\n| EVAL target_time_window = DATE_TRUNC(30 minutes, @timestamp)\n\n// Tag browser-based requests and extract session ID\n| EVAL\n    session_id = azure.signinlogs.properties.session_id,\n    is_browser = CASE(\n        TO_LOWER(azure.signinlogs.properties.device_detail.browser) RLIKE \"(chrome|firefox|edge|safari).*\", 1, 0\n    )\n\n| STATS\n    // user & session identity\n    user_display_name = VALUES(azure.signinlogs.properties.user_display_name),\n    user_principal_name = VALUES(azure.signinlogs.properties.user_principal_name),\n    session_id = VALUES(azure.signinlogs.properties.session_id),\n    unique_token_id = VALUES(azure.signinlogs.properties.unique_token_identifier),\n\n    // geolocation\n    city_name = VALUES(source.geo.city_name),\n    country_name = VALUES(source.geo.country_name),\n    region_name = VALUES(source.geo.region_name),\n    source_ip = VALUES(source.address),\n    ip_count = COUNT_DISTINCT(source.address),\n    autonomous_system = VALUES(source.`as`.organization.name),\n\n    // authentication context\n    auth_protocol = VALUES(azure.signinlogs.properties.authentication_protocol),\n    auth_requirement = VALUES(azure.signinlogs.properties.authentication_requirement),\n    is_interactive = VALUES(azure.signinlogs.properties.is_interactive),\n\n    // token & app context\n    token_type = VALUES(azure.signinlogs.properties.incoming_token_type),\n    token_session_status = VALUES(azure.signinlogs.properties.token_protection_status_details.sign_in_session_status),\n    session_id_count = COUNT_DISTINCT(session_id),\n    client_app_display_name = VALUES(azure.signinlogs.properties.app_display_name),\n    client_app_ids = VALUES(azure.signinlogs.properties.app_id),\n    target_resource_ids = VALUES(azure.signinlogs.properties.resource_id),\n    target_resource_display_name = VALUES(azure.signinlogs.properties.resource_display_name),\n\n    // tenant details\n    app_owner_tenant_id = VALUES(azure.signinlogs.properties.app_owner_tenant_id),\n    resource_owner_tenant_id = VALUES(azure.signinlogs.properties.resource_owner_tenant_id),\n\n    // conditional access & risk signals\n    conditional_access_status = VALUES(azure.signinlogs.properties.conditional_access_status),\n    risk_state = VALUES(azure.signinlogs.properties.risk_state),\n    risk_level_aggregated = VALUES(azure.signinlogs.properties.risk_level_aggregated),\n\n    // user agent & device\n    browser = VALUES(azure.signinlogs.properties.device_detail.browser),\n    os = VALUES(azure.signinlogs.properties.device_detail.operating_system),\n    user_agent = VALUES(user_agent.original),\n    has_browser = MAX(is_browser),\n\n    auth_count = COUNT(*)\nBY\n    target_time_window,\n    azure.signinlogs.properties.user_principal_name,\n    session_id\n\n| KEEP\n    target_time_window, user_display_name, user_principal_name, session_id, unique_token_id,\n    city_name, country_name, region_name, source_ip, ip_count, autonomous_system,\n    auth_protocol, auth_requirement, is_interactive,\n    token_type, token_session_status, session_id_count, client_app_display_name,\n    client_app_ids, target_resource_ids, target_resource_display_name,\n    app_owner_tenant_id, resource_owner_tenant_id,\n    conditional_access_status, risk_state, risk_level_aggregated,\n    browser, os, user_agent, has_browser, auth_count\n\n| WHERE\n    ip_count >= 2 AND\n    session_id_count == 1 AND\n    has_browser >= 1 AND\n    auth_count >= 2", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_id_suspicious_oauth_flow_via_auth_broker_to_drs.toml"}
{"title": "Microsoft Entra ID User Reported Suspicious Activity", "description": "Identifies suspicious activity reported by users in Microsoft Entra ID where users have reported suspicious activity related to their accounts, which may indicate potential compromise or unauthorized access attempts. Reported suspicious activity typically occurs during the authentication process and may involve various authentication methods, such as password resets, account recovery, or multi-factor authentication challenges. Adversaries may attempt to exploit user accounts by leveraging social engineering techniques or other methods to gain unauthorized access to sensitive information or resources.", "query": "event.dataset: \"azure.auditlogs\"\n    and azure.auditlogs.operation_name: \"Suspicious activity reported\"\n    and azure.auditlogs.properties.additional_details.key: \"AuthenticationMethod\"\n    and azure.auditlogs.properties.target_resources.*.type: \"User\"\n    and event.outcome: \"success\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_id_user_reported_risk.toml"}
{"title": "Microsoft Entra ID Illicit Consent Grant via Registered Application", "description": "Identifies an illicit consent grant request on-behalf-of a registered Entra ID application. Adversaries may create and\nregister an application in Microsoft Entra ID for the purpose of requesting user consent to access resources. This is\naccomplished by tricking a user into granting consent to the application, typically via a pre-made phishing URL. This\nestablishes an OAuth grant that allows the malicious client applocation to access resources on-behalf-of the user.", "query": "event.dataset: \"azure.auditlogs\" and\n  (\n    azure.auditlogs.operation_name:\"Consent to application\"\n    or event.action:\"Consent to application\"\n  )\n  and event.outcome: \"success\"\n  and azure.auditlogs.properties.additional_details.key: \"AppId\"", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_illicit_consent_grant_via_registered_application.toml"}
{"title": "Microsoft Entra ID OAuth Phishing via Visual Studio Code Client", "description": "Detects potentially suspicious OAuth authorization activity in Microsoft Entra ID where the Visual Studio Code\nfirst-party application (client_id = aebc6443-996d-45c2-90f0-388ff96faa56) is used to request access to Microsoft Graph\nresources. While this client ID is legitimately used by Visual Studio Code, threat actors have been observed abusing it\nin phishing campaigns to make OAuth requests appear trustworthy. These attacks rely on redirect URIs such as VSCode's\nInsiders redirect location, prompting victims to return an OAuth authorization code that can be exchanged for access\ntokens. This rule may help identify unauthorized use of the VS Code OAuth flow as part of social engineering or\ncredential phishing activity.", "query": "event.dataset: \"azure.signinlogs\" and\nevent.action: \"Sign-in activity\" and\nevent.outcome: \"success\" and\n(\n  azure.signinlogs.properties.resource_display_name: \"Microsoft Graph\" or\n  azure.signinlogs.properties.resource_id: \"00000003-0000-0000-c000-000000000000\"\n) and (\n  azure.signinlogs.properties.app_id: \"aebc6443-996d-45c2-90f0-388ff96faa56\" or\n  azure.signinlogs.properties.app_display_name: \"Visual Studio Code\"\n)", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_oauth_phishing_via_vscode_client.toml"}
{"title": "Multiple Microsoft Entra ID Protection Alerts by User Principal", "description": "Identifies more than two Microsoft Entra ID Protection alerts associated to the user principal in a short time period.\nMicrosoft Entra ID Protection alerts are triggered by suspicious sign-in activity, such as anomalous IP addresses, risky\nsign-ins, or other risk detections. Multiple alerts in a short time frame may indicate an ongoing attack or compromised\naccount.", "query": "sequence by azure.identityprotection.properties.user_principal_name with maxspan=10m\n[any where event.module == \"azure\" and event.dataset == \"azure.identity_protection\"] with runs=2", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_protection_multi_azure_identity_protection_alerts.toml"}
{"title": "Azure Entra ID Rare App ID for Principal Authentication", "description": "Identifies rare Azure Entra ID apps IDs requesting authentication on-behalf-of a principal user. An adversary with stolen\ncredentials may specify an Azure-managed app ID to authenticate on-behalf-of a user. This is a rare event and may\nindicate an attempt to bypass conditional access policies (CAP) and multi-factor authentication (MFA) requirements. The\napp ID specified may not be commonly used by the user based on their historical sign-in activity.", "query": "event.dataset: \"azure.signinlogs\" and event.category: \"authentication\"\n    and azure.signinlogs.properties.is_interactive: false\n    and azure.signinlogs.properties.user_type: \"Member\"\n    and not azure.signinlogs.properties.client_app_used: \"Browser\"\n    and not source.as.organization.name: \"MICROSOFT-CORP-MSN-AS-BLOCK\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_rare_app_id_for_principal_auth.toml"}
{"title": "Microsoft Entra ID Rare Authentication Requirement for Principal User", "description": "Identifies rare instances of authentication requirements for Azure Entra ID principal users. An adversary with stolen\ncredentials may attempt to authenticate with unusual authentication requirements, which is a rare event and may indicate\nan attempt to bypass conditional access policies (CAP) and multi-factor authentication (MFA) requirements. The\nauthentication requirements specified may not be commonly used by the user based on their historical sign-in activity.", "query": "event.dataset: \"azure.signinlogs\" and event.category: \"authentication\"\n    and azure.signinlogs.properties.user_type: \"Member\"\n    and azure.signinlogs.properties.authentication_details.authentication_method: \"Password\"\n    and not azure.signinlogs.properties.device_detail.browser: *\n    and not source.as.organization.name: \"MICROSOFT-CORP-MSN-AS-BLOCK\"\n    and not azure.signinlogs.properties.authentication_requirement: \"multiFactorAuthentication\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_entra_rare_authentication_requirement_for_principal_user.toml"}
{"title": "Microsoft Graph First Occurrence of Client Request", "description": "This New Terms rule focuses on the first occurrence of a client application ID\n(azure.graphactivitylogs.properties.app_id) making a request to Microsoft Graph API for a specific tenant ID\n(azure.tenant_id) and user principal object ID (azure.graphactivitylogs.properties.user_principal_object_id). This rule\nmay helps identify unauthorized access or actions performed by compromised accounts. Advesaries may succesfully\ncompromise a user's credentials and use the Microsoft Graph API to access resources or perform actions on behalf of the\nuser.", "query": "event.dataset: \"azure.graphactivitylogs\"\n    and event.type: \"access\"\n    and azure.graphactivitylogs.properties.c_idtyp: \"user\"\n    and azure.graphactivitylogs.properties.client_auth_method: 0\n    and http.response.status_code: 200\n    and url.domain: \"graph.microsoft.com\"", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_graph_first_occurrence_of_client_request.toml"}
{"title": "Azure Automation Account Created", "description": "Identifies when an Azure Automation account is created. Azure Automation accounts can be used to automate management\ntasks and orchestrate actions across systems. An adversary may create an Automation account in order to maintain\npersistence in their target's environment.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WRITE\" and event.outcome:(Success or success)", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_azure_automation_account_created.toml"}
{"title": "Azure Automation Runbook Created or Modified", "description": "Identifies when an Azure Automation runbook is created or modified. An adversary may create or modify an Azure\nAutomation runbook to execute malicious code and maintain persistence in their target's environment.", "query": "event.dataset:azure.activitylogs and\n  azure.activitylogs.operation_name:\n  (\n    \"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/DRAFT/WRITE\" or\n    \"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/WRITE\" or\n    \"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/PUBLISH/ACTION\"\n  ) and\n  event.outcome:(Success or success)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_azure_automation_runbook_created_or_modified.toml"}
{"title": "Azure Automation Webhook Created", "description": "Identifies when an Azure Automation webhook is created. Azure Automation runbooks can be configured to execute via a\nwebhook. A webhook uses a custom URL passed to Azure Automation along with a data payload specific to the runbook. An\nadversary may create a webhook in order to trigger a runbook that contains malicious code.", "query": "event.dataset:azure.activitylogs and\n  azure.activitylogs.operation_name:\n    (\n      \"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WEBHOOKS/ACTION\" or\n      \"MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WEBHOOKS/WRITE\"\n    ) and\n  event.outcome:(Success or success)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_azure_automation_webhook_created.toml"}
{"title": "Azure AD Global Administrator Role Assigned", "description": "In Azure Active Directory (Azure AD), permissions to manage resources are assigned using roles. The Global Administrator\nis a role that enables users to have access to all administrative features in Azure AD and services that use Azure AD\nidentities like the Microsoft 365 Defender portal, the Microsoft 365 compliance center, Exchange, SharePoint Online, and\nSkype for Business Online. Attackers can add users as Global Administrators to maintain access and manage all\nsubscriptions and their settings and resources.", "query": "event.dataset:azure.auditlogs and azure.auditlogs.properties.category:RoleManagement and\nazure.auditlogs.operation_name:\"Add member to role\" and\nazure.auditlogs.properties.target_resources.0.modified_properties.1.new_value:\"\\\"Global Administrator\\\"\"\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_azure_global_administrator_role_assigned.toml"}
{"title": "Azure Privilege Identity Management Role Modified", "description": "Azure Active Directory (AD) Privileged Identity Management (PIM) is a service that enables you to manage, control, and\nmonitor access to important resources in an organization. PIM can be used to manage the built-in Azure resource roles\nsuch as Global Administrator and Application Administrator. An adversary may add a user to a PIM role in order to\nmaintain persistence in their target's environment or modify a PIM role to weaken their target's security controls.", "query": "event.dataset:azure.auditlogs and azure.auditlogs.operation_name:\"Update role setting in PIM\" and event.outcome:(Success or success)", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_azure_privileged_identity_management_role_modified.toml"}
{"title": "Microsoft Entra ID Service Principal Credentials Added by Rare User", "description": "Identifies when new Service Principal credentials have been added in Microsoft Entra ID. In most organizations,\ncredentials will be added to service principals infrequently. Hijacking an application (by adding a rogue secret or\ncertificate) with granted permissions will allow the attacker to access data that is normally protected by MFA\nrequirements.", "query": "event.dataset: \"azure.auditlogs\"\n    and azure.auditlogs.operation_name:\"Add service principal credentials\"\n    and event.outcome: \"success\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_azure_service_principal_credentials_added.toml"}
{"title": "Microsoft Entra ID Conditional Access Policy (CAP) Modified", "description": "Identifies a modification to a conditional access policy (CAP) in Microsoft Entra ID. Adversaries may modify existing CAPs to loosen access controls and maintain persistence in the environment with a compromised identity or entity.", "query": "event.dataset: \"azure.auditlogs\"\n    and event.action:\"Update conditional access policy\"\n    and event.outcome: \"success\"", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_entra_conditional_access_policy_modified.toml"}
{"title": "Suspicious ADRS Token Request by Microsoft Auth Broker", "description": "Detects suspicious OAuth 2.0 token requests where the Microsoft Authentication Broker\n(29d9ed98-a469-4536-ade2-f981bc1d605e) requests access to the Device Registration Service\n(01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9) on behalf of a user principal. The presence of the adrs_access scope in the\nauthentication processing details suggests an attempt to access ADRS, which is atypical for standard user sign-ins. This\nbehavior may reflect an effort to abuse device registration for unauthorized persistence, such as acquiring a Primary\nRefresh Token (PRT) or establishing a trusted session.", "query": "event.dataset: \"azure.signinlogs\" and\n    azure.signinlogs.properties.app_id : \"29d9ed98-a469-4536-ade2-f981bc1d605e\" and\n    azure.signinlogs.properties.resource_id : \"01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9\" and\n    azure.signinlogs.category: \"NonInteractiveUserSignInLogs\" and\n    azure.signinlogs.properties.authentication_processing_details: *adrs_access* and\n    azure.signinlogs.properties.incoming_token_type: \"refreshToken\" and\n    azure.signinlogs.properties.user_type: \"Member\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_entra_id_suspicious_adrs_token_request.toml"}
{"title": "Entra ID User Signed In from Unusual Device", "description": "Identifies when a Microsoft Entra ID user signs in from a device that is not typically used by the user, which may\nindicate potential compromise or unauthorized access attempts. This rule detects unusual sign-in activity by comparing\nthe device used for the sign-in against the user's typical device usage patterns. Adversaries may create and register a\nnew device to obtain a Primary Refresh Token (PRT) and maintain persistent access.", "query": "event.dataset: \"azure.signinlogs\" and\n    event.category: \"authentication\" and\n    azure.signinlogs.properties.user_type: \"Member\" and\n    azure.signinlogs.properties.token_protection_status_details.sign_in_session_status: \"unbound\" and\n    not azure.signinlogs.properties.device_detail.device_id: \"\" and\n    azure.signinlogs.properties.user_principal_name: *", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_entra_id_user_signed_in_from_unusual_device.toml"}
{"title": "Multi-Factor Authentication Disabled for an Azure User", "description": "Identifies when multi-factor authentication (MFA) is disabled for an Azure user account. An adversary may disable MFA\nfor a user account in order to weaken the authentication requirements for the account.", "query": "event.dataset:azure.auditlogs and azure.auditlogs.operation_name:\"Disable Strong Authentication\" and event.outcome:(Success or success)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_mfa_disabled_for_azure_user.toml"}
{"title": "User Added as Owner for Azure Application", "description": "Identifies when a user is added as an owner for an Azure application. An adversary may add a user account as an owner\nfor an Azure application in order to grant additional permissions and modify the application's configuration using\nanother account.", "query": "event.dataset:azure.auditlogs and azure.auditlogs.operation_name:\"Add owner to application\" and event.outcome:(Success or success)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_added_as_owner_for_azure_application.toml"}
{"title": "User Added as Owner for Azure Service Principal", "description": "Identifies when a user is added as an owner for an Azure service principal. The service principal object defines what\nthe application can do in the specific tenant, who can access the application, and what resources the app can access. A\nservice principal object is created when an application is given permission to access resources in a tenant. An\nadversary may add a user account as an owner for a service principal and use that account in order to define what an\napplication can do in the Azure AD tenant.", "query": "event.dataset:azure.auditlogs and azure.auditlogs.operation_name:\"Add owner to service principal\" and event.outcome:(Success or success)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_added_as_owner_for_azure_service_principal.toml"}
{"title": "Azure Kubernetes Rolebindings Created", "description": "Identifies the creation of role binding or cluster role bindings. You can assign these roles to Kubernetes subjects\n(users, groups, or service accounts) with role bindings and cluster role bindings. An adversary who has permissions to\ncreate bindings and cluster-bindings in the cluster can create a binding to the cluster-admin ClusterRole or to other\nhigh privileges roles.", "query": "event.dataset:azure.activitylogs and azure.activitylogs.operation_name:\n\t(\"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/RBAC.AUTHORIZATION.K8S.IO/ROLEBINDINGS/WRITE\" or\n\t \"MICROSOFT.KUBERNETES/CONNECTEDCLUSTERS/RBAC.AUTHORIZATION.K8S.IO/CLUSTERROLEBINDINGS/WRITE\") and\nevent.outcome:(Success or success)", "tactic": "Privilege Escalation", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_azure_kubernetes_rolebinding_created.toml"}
{"title": "Microsoft Entra ID Elevated Access to User Access Administrator", "description": "Identifies when a user has elevated their access to User Access Administrator for their Azure Resources. The User Access\nAdministrator role allows users to manage user access to Azure resources, including the ability to assign roles and\npermissions. Adversaries may target an Entra ID Global Administrator or other privileged role to elevate their access to\nUser Access Administrator, which can lead to further privilege escalation and unauthorized access to sensitive\nresources. This is a New Terms rule that only signals if the user principal name has not been seen doing this activity\nin the last 14 days.", "query": "event.dataset: azure.auditlogs\n    and azure.auditlogs.operation_name: \"User has elevated their access to User Access Administrator for their Azure Resources\"\n    and event.outcome: \"success\"", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_entra_id_elevate_to_user_administrator_access.toml"}
{"title": "Potential Denial of Azure OpenAI ML Service", "description": "Detects patterns indicative of Denial-of-Service (DoS) attacks on machine learning (ML) models, focusing on unusually\nhigh volume and frequency of requests or patterns of requests that are known to cause performance degradation or service\ndisruption, such as large input sizes or rapid API calls.", "query": "from logs-azure_openai.logs-*\n// truncate the timestamp to a 1-minute window\n| eval target_time_window = DATE_TRUNC(1 minutes, @timestamp)\n| where azure.open_ai.operation_name == \"ChatCompletions_Create\"\n| keep azure.open_ai.properties.request_length, azure.resource.name, cloud.account.id,target_time_window\n| stats count = count(), avg_request_size = avg(azure.open_ai.properties.request_length) by target_time_window, azure.resource.name\n| where count >= 10 and avg_request_size >= 5000\n| sort count desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "azure_openai_denial_of_ml_service_detection.toml"}
{"title": "Azure OpenAI Insecure Output Handling", "description": "Detects when Azure OpenAI requests result in zero response length, potentially indicating issues in output handling that\nmight lead to security exploits such as data leaks or code execution. This can occur in cases where the API fails to\nhandle outputs correctly under certain input conditions.", "query": "from logs-azure_openai.logs-*\n| where azure.open_ai.properties.response_length == 0 and azure.open_ai.result_signature == \"200\" and azure.open_ai.operation_name == \"ChatCompletions_Create\"\n| keep azure.open_ai.properties.request_length, azure.open_ai.result_signature, cloud.account.id, azure.resource.name\n| stats count = count() by azure.resource.name\n| where count >= 10\n| sort count desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "azure_openai_insecure_output_handling_detection.toml"}
{"title": "Potential Azure OpenAI Model Theft", "description": "Monitors for suspicious activities that may indicate theft or unauthorized duplication of machine learning (ML) models,\nsuch as unauthorized API calls, atypical access patterns, or large data transfers that are unusual during model\ninteractions.", "query": "from logs-azure_openai.logs-*\n| where azure.open_ai.operation_name == \"ListKey\" and azure.open_ai.category == \"Audit\"\n| KEEP @timestamp, azure.open_ai.operation_name , azure.open_ai.category, azure.resource.group, azure.resource.name, azure.open_ai.properties.response_length\n| stats count = count(), max_data_transferred = max(azure.open_ai.properties.response_length) by azure.resource.group , azure.resource.name\n| where count >= 100 or max_data_transferred >= 1000000\n| sort count desc", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "azure_openai_model_theft_detection.toml"}
{"title": "Statistical Model Detected C2 Beaconing Activity", "description": "A statistical model has identified command-and-control (C2) beaconing activity. Beaconing can help attackers maintain\nstealthy communication with their C2 servers, receive instructions and payloads, exfiltrate data and maintain\npersistence in a network.", "query": "beacon_stats.is_beaconing: true and\nnot process.name: (\"WaAppAgent.exe\" or \"metricbeat.exe\" or \"packetbeat.exe\" or \"WindowsAzureGuestAgent.exe\" or \"HealthService.exe\" or \"Widgets.exe\" or \"lsass.exe\" or \"msedgewebview2.exe\" or\n                   \"MsMpEng.exe\" or \"OUTLOOK.EXE\" or \"msteams.exe\" or \"FileSyncHelper.exe\" or \"SearchProtocolHost.exe\" or \"Creative Cloud.exe\" or \"ms-teams.exe\" or \"ms-teamsupdate.exe\" or\n                   \"curl.exe\" or \"rundll32.exe\" or \"MsSense.exe\" or \"wermgr.exe\" or \"java\" or \"olk.exe\" or \"iexplore.exe\" or \"NetworkManager\" or \"packetbeat\" or \"Ssms.exe\" or \"NisSrv.exe\" or\n                   \"gamingservices.exe\" or \"appidcertstorecheck.exe\" or \"POWERPNT.EXE\" or \"miiserver.exe\" or \"Grammarly.Desktop.exe\" or \"SnagitEditor.exe\" or \"CRWindowsClientService.exe\" or\n                   \"agentbeat\" or \"dnf\" or \"yum\" or \"apt\"\n                  )", "tactic": "Command and Control", "technique": "Web Service", "technique_id": "T1102", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_beaconing.toml"}
{"title": "Statistical Model Detected C2 Beaconing Activity with High Confidence", "description": "A statistical model has identified command-and-control (C2) beaconing activity with high confidence. Beaconing can help\nattackers maintain stealthy communication with their C2 servers, receive instructions and payloads, exfiltrate data and\nmaintain persistence in a network.", "query": "beacon_stats.beaconing_score: 3", "tactic": "Command and Control", "technique": "Web Service", "technique_id": "T1102", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_beaconing_high_confidence.toml"}
{"title": "CyberArk Privileged Access Security Error", "description": "Identifies the occurrence of a CyberArk Privileged Access Security (PAS) error level audit event. The event.code\ncorrelates to the CyberArk Vault Audit Action Code.", "query": "event.dataset:cyberarkpas.audit and event.type:error", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_cyberarkpas_error_audit_event_promotion.toml"}
{"title": "CyberArk Privileged Access Security Recommended Monitor", "description": "Identifies the occurrence of a CyberArk Privileged Access Security (PAS) non-error level audit event which is\nrecommended for monitoring by the vendor. The event.code correlates to the CyberArk Vault Audit Action Code.", "query": "event.dataset:cyberarkpas.audit and\n  event.code:(4 or 22 or 24 or 31 or 38 or 57 or 60 or 130 or 295 or 300 or 302 or\n              308 or 319 or 344 or 346 or 359 or 361 or 378 or 380 or 411) and\n  not event.type:error", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_cyberarkpas_recommended_events_to_monitor_promotion.toml"}
{"title": "Potential Data Exfiltration Activity to an Unusual ISO Code", "description": "A machine learning job has detected data exfiltration to a particular geo-location (by region name). Data transfers to\ngeo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command\nand control channels.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over C2 Channel", "technique_id": "T1041", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_high_bytes_destination_geo_country_iso_code.toml"}
{"title": "Potential Data Exfiltration Activity to an Unusual IP Address", "description": "A machine learning job has detected data exfiltration to a particular geo-location (by IP address). Data transfers to\ngeo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command\nand control channels.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over C2 Channel", "technique_id": "T1041", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_high_bytes_destination_ip.toml"}
{"title": "Potential Data Exfiltration Activity to an Unusual Destination Port", "description": "A machine learning job has detected data exfiltration to a particular destination port. Data transfer patterns that are\noutside the normal traffic patterns of an organization could indicate exfiltration over command and control channels.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over C2 Channel", "technique_id": "T1041", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_high_bytes_destination_port.toml"}
{"title": "Potential Data Exfiltration Activity to an Unusual Region", "description": "A machine learning job has detected data exfiltration to a particular geo-location (by region name). Data transfers to\ngeo-locations that are outside the normal traffic patterns of an organization could indicate exfiltration over command\nand control channels.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over C2 Channel", "technique_id": "T1041", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_high_bytes_destination_region_name.toml"}
{"title": "Spike in Bytes Sent to an External Device", "description": "A machine learning job has detected high bytes of data written to an external device. In a typical operational setting,\nthere is usually a predictable pattern or a certain range of data that is written to external devices. An unusually\nlarge amount of data being written is anomalous and can signal illicit data copying or transfer activities.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over Physical Medium", "technique_id": "T1052", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_high_bytes_written_to_external_device.toml"}
{"title": "Spike in Bytes Sent to an External Device via Airdrop", "description": "A machine learning job has detected high bytes of data written to an external device via Airdrop. In a typical\noperational setting, there is usually a predictable pattern or a certain range of data that is written to external\ndevices. An unusually large amount of data being written is anomalous and can signal illicit data copying or transfer\nactivities.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over Other Network Medium", "technique_id": "T1011", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_high_bytes_written_to_external_device_airdrop.toml"}
{"title": "Unusual Process Writing Data to an External Device", "description": "A machine learning job has detected a rare process writing data to an external device. Malicious actors often use\nbenign-looking processes to mask their data exfiltration activities. The discovery of such a process that has no\nlegitimate reason to write data to external devices can indicate exfiltration.", "query": "N/A", "tactic": "Exfiltration", "technique": "Exfiltration Over Physical Medium", "technique_id": "T1052", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_ml_rare_process_writing_to_external_device.toml"}
{"title": "Machine Learning Detected DGA activity using a known SUNBURST DNS domain", "description": "A supervised machine learning model has identified a DNS question name that used by the SUNBURST malware and is\npredicted to be the result of a Domain Generation Algorithm.", "query": "ml_is_dga.malicious_prediction:1 and dns.question.registered_domain:avsvmcloud.com", "tactic": "Command and Control", "technique": "Dynamic Resolution", "technique_id": "T1568", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_dga_activity_using_sunburst_domain.toml"}
{"title": "Potential DGA Activity", "description": "A population analysis machine learning job detected potential DGA (domain generation algorithm) activity. Such activity\nis often used by malware command and control (C2) channels. This machine learning job looks for a source IP address\nmaking DNS requests that have an aggregate high probability of being DGA activity.", "query": "N/A", "tactic": "Command and Control", "technique": "Dynamic Resolution", "technique_id": "T1568", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_dga_high_sum_probability.toml"}
{"title": "Machine Learning Detected a DNS Request With a High DGA Probability Score", "description": "A supervised machine learning model has identified a DNS question name with a high probability of sourcing from a Domain\nGeneration Algorithm (DGA), which could indicate command and control network activity.", "query": "ml_is_dga.malicious_probability > 0.98", "tactic": "Command and Control", "technique": "Dynamic Resolution", "technique_id": "T1568", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_dns_request_high_dga_probability.toml"}
{"title": "Machine Learning Detected a DNS Request Predicted to be a DGA Domain", "description": "A supervised machine learning model has identified a DNS question name that is predicted to be the result of a Domain\nGeneration Algorithm (DGA), which could indicate command and control network activity.", "query": "ml_is_dga.malicious_prediction:1 and not dns.question.registered_domain:avsvmcloud.com", "tactic": "Command and Control", "technique": "Dynamic Resolution", "technique_id": "T1568", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_dns_request_predicted_to_be_a_dga_domain.toml"}
{"title": "Memory Threat - Detected - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for memory signatures are received. Enabling this rule\nallows you to immediately begin investigating your Endpoint memory signature alerts. This rule identifies Elastic Defend\nmemory signature detections only, and does not include prevention alerts.", "query": "event.kind : alert and event.code : (memory_signature or shellcode_thread) and (event.type : allowed or (event.type: denied and event.outcome: failure))", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_elastic_memory_threat_detected.toml"}
{"title": "Memory Threat - Prevented- Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for memory signatures are received. Enabling this rule\nallows you to immediately begin investigating your Endpoint memory signature alerts. This rule identifies Elastic Defend\nmemory signature preventions only, and does not include detection only alerts.", "query": "event.kind : alert and event.code : (memory_signature or shellcode_thread) and event.type : denied and event.outcome : success", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_elastic_memory_threat_prevented.toml"}
{"title": "Endpoint Security (Elastic Defend)", "description": "Generates a detection alert each time an Elastic Defend alert is received. Enabling this rule allows you to immediately\nbegin investigating your Endpoint alerts.", "query": "event.kind:alert and event.module:(endpoint and not endgame)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "elastic_endpoint_security.toml"}
{"title": "Behavior - Detected - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for malicious behavior is received. Enabling this rule\nallows you to immediately begin investigating your Endpoint behavior alerts. This rule identifies Elastic Defend\nbehavior detections only, and does not include prevention alerts.", "query": "event.kind : alert and event.code : behavior and (event.type : allowed or (event.type: denied and event.outcome: failure))", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "elastic_endpoint_security_behavior_detected.toml"}
{"title": "Behavior - Prevented - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for malicious behavior is received. Enabling this rule\nallows you to immediately begin investigating your Endpoint behavior alerts. This rule identifies Elastic Defend\nbehavior preventions only, and does not include detection only alerts.", "query": "event.kind : alert and event.code : behavior and event.type : denied and event.outcome : success", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "elastic_endpoint_security_behavior_prevented.toml"}
{"title": "Malicious File - Detected - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for malicious files is received. Enabling this rule allows\nyou to immediately begin investigating your Endpoint malicious file alerts. This rule identifies Elastic Defend\nmalicious file detections only, and does not include prevention alerts.", "query": "event.kind : alert and event.code : malicious_file and (event.type : allowed or (event.type: denied and event.outcome: failure))", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_elastic_malicious_file_detected.toml"}
{"title": "Malicious File - Prevented - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for malicious files is received. Enabling this rule allows\nyou to immediately begin investigating your Endpoint malicious file alerts. This rule identifies Elastic Defend\nmalicious file preventions only, and does not include detection only alerts.", "query": "event.kind : alert and event.code : malicious_file and event.type : denied and event.outcome : success", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_elastic_malicious_file_prevented.toml"}
{"title": "Ransomware - Detected - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for ransomware are received. Enabling this rule allows you\nto immediately begin investigating your Endpoint ransomware alerts. This rule identifies Elastic Defend ransomware\ndetections only, and does not include prevention alerts.", "query": "event.kind : alert and event.code : ransomware and (event.type : allowed or (event.type: denied and event.outcome: failure))", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_elastic_ransomware_detected.toml"}
{"title": "Ransomware - Prevented - Elastic Defend", "description": "Generates a detection alert each time an Elastic Defend alert for ransomware are received. Enabling this rule allows you\nto immediately begin investigating your Endpoint ransomware alerts. This rule identifies Elastic Defend ransomware\npreventions only, and does not include detection only alerts.", "query": "event.kind : alert and event.code : ransomware and event.type : denied and event.outcome : success", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_elastic_ransomware_prevented.toml"}
{"title": "Potential Persistence via File Modification", "description": "This rule leverages the File Integrity Monitoring (FIM) integration to detect file modifications of files that are\ncommonly used for persistence on Linux systems. The rule detects modifications to files that are commonly used for cron\njobs, systemd services, message-of-the-day (MOTD), SSH configurations, shell configurations, runtime control, init\ndaemon, passwd/sudoers/shadow files, Systemd udevd, and XDG/KDE autostart entries. To leverage this rule, the paths\nspecified in the query need to be added to the FIM policy in the Elastic Security app.", "query": "file where host.os.type == \"linux\" and event.dataset == \"fim.event\" and event.action == \"updated\" and\nfile.path : (\n  // cron, anacron & at\n  \"/etc/cron.d/*\", \"/etc/cron.daily/*\", \"/etc/cron.hourly/*\", \"/etc/cron.monthly/*\",\n  \"/etc/cron.weekly/*\", \"/etc/crontab\", \"/var/spool/cron/crontabs/*\", \"/etc/cron.allow\",\n  \"/etc/cron.deny\",  \"/var/spool/anacron/*\", \"/var/spool/cron/atjobs/*\",\n\n  // systemd services & timers\n  \"/etc/systemd/system/*\", \"/usr/local/lib/systemd/system/*\", \"/lib/systemd/system/*\",\n  \"/usr/lib/systemd/system/*\", \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\",\n\n  // LD_PRELOAD\n  \"/etc/ld.so.preload\", \"/etc/ld.so.conf.d/*\", \"/etc/ld.so.conf\",\n\n  // Dynamic linker\n  \"/lib/ld-linux*.so*\", \"/lib64/ld-linux*.so*\", \"/usr/lib/ld-linux*.so*\", \"/usr/lib64/ld-linux*.so*\",\n\n  // message-of-the-day (MOTD)\n  \"/etc/update-motd.d/*\",\n\n  // SSH\n  \"/home/*/.ssh/*\", \"/root/.ssh/*\", \"/etc/ssh/*\",\n\n  // system-wide shell configurations\n  \"/etc/profile\", \"/etc/profile.d/*\", \"/etc/bash.bashrc\", \"/etc/zsh/*\", \"/etc/csh.cshrc\",\n  \"/etc/csh.login\", \"/etc/fish/config.fish\", \"/etc/ksh.kshrc\",\n\n  // root and user shell configurations\n  \"/home/*/.profile\", \"/home/*/.bashrc\", \"/home/*/.bash_login\", \"/home/*/.bash_logout\",\n  \"/root/.profile\", \"/root/.bashrc\", \"/root/.bash_login\", \"/root/.bash_logout\",\n  \"/home/*/.zprofile\", \"/home/*/.zshrc\", \"/root/.zprofile\", \"/root/.zshrc\",\n  \"/home/*/.cshrc\", \"/home/*/.login\", \"/home/*/.logout\", \"/root/.cshrc\", \"/root/.login\", \"/root/.logout\",\n  \"/home/*/.config/fish/config.fish\", \"/root/.config/fish/config.fish\",\n  \"/home/*/.kshrc\", \"/root/.kshrc\",\n\n  // runtime control\n  \"/etc/rc.common\", \"/etc/rc.local\",\n\n  // System V init/Upstart\n  \"/etc/init.d/*\", \"/etc/init/*\",\n\n  // passwd/sudoers/shadow\n  \"/etc/passwd\", \"/etc/shadow\", \"/etc/sudoers\", \"/etc/sudoers.d/*\",\n\n  // Systemd udevd\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\", \"/usr/local/lib/udev/rules.d/*\",\n\n  // XDG/KDE autostart entries\n  \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\", \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\",\n  \"/home/*/.kde/Autostart/*\", \"/root/.kde/Autostart/*\",\n  \"/home/*/.kde4/Autostart/*\", \"/root/.kde4/Autostart/*\",\n  \"/home/*/.kde/share/autostart/*\", \"/root/.kde/share/autostart/*\",\n  \"/home/*/.kde4/share/autostart/*\", \"/root/.kde4/share/autostart/*\",\n  \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\",\n  \"/home/*/.config/autostart-scripts/*\", \"/root/.config/autostart-scripts/*\",\n\n  // LKM configuration files\n  \"/etc/modules\", \"/etc/modprobe.d/*\", \"/usr/lib/modprobe.d/*\", \"/etc/modules-load.d/*\",\n  \"/run/modules-load.d/*\", \"/usr/local/lib/modules-load.d/*\", \"/usr/lib/modules-load.d/*\",\n\n  // PAM modules & configuration files\n  \"/lib/security/*\", \"/lib64/security/*\", \"/usr/lib/security/*\", \"/usr/lib64/security/*\",\n  \"/lib/x86_64-linux-gnu/security/*\", \"/usr/lib/x86_64-linux-gnu/security/*\",\n  \"/etc/pam.d/*\", \"/etc/security/pam_*\", \"/etc/pam.conf\",\n\n  // Polkit Rule files\n  \"/etc/polkit-1/rules.d/*\", \"/usr/share/polkit-1/rules.d/*\",\n\n  // Polkit pkla files\n  \"/etc/polkit-1/localauthority/*\", \"/var/lib/polkit-1/localauthority/*\",\n\n  // Polkit Action files\n  \"/usr/share/polkit-1/actions/*\",\n\n  // Polkit Legacy paths\n  \"/lib/polkit-1/rules.d/*\", \"/lib64/polkit-1/rules.d/*\", \"/var/lib/polkit-1/rules.d/*\",\n\n  // NetworkManager\n  \"/etc/NetworkManager/dispatcher.d/*\",\n\n  // D-bus Service files\n  \"/usr/share/dbus-1/system-services/*\", \"/etc/dbus-1/system.d/*\",\n  \"/lib/dbus-1/system-services/*\", \"/run/dbus/system.d/*\",\n  \"/home/*/.local/share/dbus-1/services/*\", \"/home/*/.dbus/session-bus/*\",\n  \"/usr/share/dbus-1/services/*\", \"/etc/dbus-1/session.d/*\",\n\n  // GRUB\n  \"/etc/default/grub.d/*\", \"/etc/default/grub\", \"/etc/grub.d/*\", \"/boot/grub2/grub.cfg\",\n  \"/boot/grub/grub.cfg\", \"/boot/efi/EFI/*/grub.cfg\", \"/etc/sysconfig/grub\",\n\n  // Dracut\n  \"/lib/dracut/modules.d/*\", \"/usr/lib/dracut/modules.d/*\",\n\n  // Misc.\n  \"/etc/shells\"\n\n) and not (\n  file.path : (\n    \"/var/spool/cron/crontabs/tmp.*\", \"/run/udev/rules.d/*rules.*\", \"/home/*/.ssh/known_hosts.*\", \"/root/.ssh/known_hosts.*\"\n  ) or\n  file.extension in (\"dpkg-new\", \"dpkg-remove\", \"SEQ\")\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_file_modifications.toml"}
{"title": "GCP Pub/Sub Subscription Creation", "description": "Identifies the creation of a subscription in Google Cloud Platform (GCP). In GCP, the publisher-subscriber relationship\n(Pub/Sub) is an asynchronous messaging service that decouples event-producing and event-processing services. A\nsubscription is a named resource representing the stream of messages to be delivered to the subscribing application.", "query": "event.dataset:gcp.audit and event.action:google.pubsub.v*.Subscriber.CreateSubscription and event.outcome:success", "tactic": "Collection", "technique": "Data from Cloud Storage", "technique_id": "T1530", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_gcp_pub_sub_subscription_creation.toml"}
{"title": "GCP Firewall Rule Creation", "description": "Identifies when a firewall rule is created in Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or App Engine.\nThese firewall rules can be configured to allow or deny connections to or from virtual machine (VM) instances or\nspecific applications. An adversary may create a new firewall rule in order to weaken their target's security controls\nand allow more permissive ingress or egress traffic flows for their benefit.", "query": "event.dataset:gcp.audit and event.action:(*.compute.firewalls.insert or google.appengine.*.Firewall.Create*Rule)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_firewall_rule_created.toml"}
{"title": "GCP Firewall Rule Deletion", "description": "Identifies when a firewall rule is deleted in Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or App Engine.\nThese firewall rules can be configured to allow or deny connections to or from virtual machine (VM) instances or\nspecific applications. An adversary may delete a firewall rule in order to weaken their target's security controls.", "query": "event.dataset:gcp.audit and event.action:(*.compute.firewalls.delete or google.appengine.*.Firewall.Delete*Rule)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_firewall_rule_deleted.toml"}
{"title": "GCP Firewall Rule Modification", "description": "Identifies when a firewall rule is modified in Google Cloud Platform (GCP) for Virtual Private Cloud (VPC) or App\nEngine. These firewall rules can be modified to allow or deny connections to or from virtual machine (VM) instances or\nspecific applications. An adversary may modify an existing firewall rule in order to weaken their target's security\ncontrols and allow more permissive ingress or egress traffic flows for their benefit.", "query": "event.dataset:gcp.audit and event.action:(*.compute.firewalls.patch or google.appengine.*.Firewall.Update*Rule)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_firewall_rule_modified.toml"}
{"title": "GCP Logging Bucket Deletion", "description": "Identifies a Logging bucket deletion in Google Cloud Platform (GCP). Log buckets are containers that store and organize\nlog data. A deleted bucket stays in a pending state for 7 days, and Logging continues to route logs to the bucket during\nthat time. To stop routing logs to a deleted bucket, you can delete the log sinks that have the bucket as their\ndestination, or modify the filter for the sinks to stop it from routing logs to the deleted bucket. An adversary may\ndelete a log bucket to evade detection.", "query": "event.dataset:gcp.audit and event.action:google.logging.v*.ConfigServiceV*.DeleteBucket and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_logging_bucket_deletion.toml"}
{"title": "GCP Logging Sink Deletion", "description": "Identifies a Logging sink deletion in Google Cloud Platform (GCP). Every time a log entry arrives, Logging compares the\nlog entry to the sinks in that resource. Each sink whose filter matches the log entry writes a copy of the log entry to\nthe sink's export destination. An adversary may delete a Logging sink to evade detection.", "query": "event.dataset:gcp.audit and event.action:google.logging.v*.ConfigServiceV*.DeleteSink and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_logging_sink_deletion.toml"}
{"title": "GCP Pub/Sub Subscription Deletion", "description": "Identifies the deletion of a subscription in Google Cloud Platform (GCP). In GCP, the publisher-subscriber relationship\n(Pub/Sub) is an asynchronous messaging service that decouples event-producing and event-processing services. A\nsubscription is a named resource representing the stream of messages to be delivered to the subscribing application.", "query": "event.dataset:gcp.audit and event.action:google.pubsub.v*.Subscriber.DeleteSubscription and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_pub_sub_subscription_deletion.toml"}
{"title": "GCP Storage Bucket Configuration Modification", "description": "Identifies when the configuration is modified for a storage bucket in Google Cloud Platform (GCP). An adversary may\nmodify the configuration of a storage bucket in order to weaken the security controls of their target's environment.", "query": "event.dataset:gcp.audit and event.action:\"storage.buckets.update\" and event.outcome:success", "tactic": "Defense Evasion", "technique": "Modify Cloud Compute Infrastructure", "technique_id": "T1578", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_storage_bucket_configuration_modified.toml"}
{"title": "GCP Storage Bucket Permissions Modification", "description": "Identifies when the Identity and Access Management (IAM) permissions are modified for a Google Cloud Platform (GCP)\nstorage bucket. An adversary may modify the permissions on a storage bucket to weaken their target's security controls\nor an administrator may inadvertently modify the permissions, which could lead to data exposure or loss.", "query": "event.dataset:gcp.audit and event.action:\"storage.setIamPermissions\" and event.outcome:success", "tactic": "Defense Evasion", "technique": "File and Directory Permissions Modification", "technique_id": "T1222", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_storage_bucket_permissions_modified.toml"}
{"title": "GCP Virtual Private Cloud Network Deletion", "description": "Identifies when a Virtual Private Cloud (VPC) network is deleted in Google Cloud Platform (GCP). A VPC network is a\nvirtual version of a physical network within a GCP project. Each VPC network has its own subnets, routes, and firewall,\nas well as other elements. An adversary may delete a VPC network in order to disrupt their target's network and business\noperations.", "query": "event.dataset:gcp.audit and event.action:v*.compute.networks.delete and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_virtual_private_cloud_network_deleted.toml"}
{"title": "GCP Virtual Private Cloud Route Creation", "description": "Identifies when a virtual private cloud (VPC) route is created in Google Cloud Platform (GCP). Google Cloud routes\ndefine the paths that network traffic takes from a virtual machine (VM) instance to other destinations. These\ndestinations can be inside a Google VPC network or outside it. An adversary may create a route in order to impact the\nflow of network traffic in their target's cloud environment.", "query": "event.dataset:gcp.audit and event.action:(v*.compute.routes.insert or \"beta.compute.routes.insert\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_virtual_private_cloud_route_created.toml"}
{"title": "GCP Virtual Private Cloud Route Deletion", "description": "Identifies when a Virtual Private Cloud (VPC) route is deleted in Google Cloud Platform (GCP). Google Cloud routes\ndefine the paths that network traffic takes from a virtual machine (VM) instance to other destinations. These\ndestinations can be inside a Google VPC network or outside it. An adversary may delete a route in order to impact the\nflow of network traffic in their target's cloud environment.", "query": "event.dataset:gcp.audit and event.action:v*.compute.routes.delete and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_gcp_virtual_private_cloud_route_deleted.toml"}
{"title": "GCP Logging Sink Modification", "description": "Identifies a modification to a Logging sink in Google Cloud Platform (GCP). Logging compares the log entry to the sinks\nin that resource. Each sink whose filter matches the log entry writes a copy of the log entry to the sink's export\ndestination. An adversary may update a Logging sink to exfiltrate logs to a different export destination.", "query": "event.dataset:gcp.audit and event.action:google.logging.v*.ConfigServiceV*.UpdateSink and event.outcome:success", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_gcp_logging_sink_modification.toml"}
{"title": "GCP Service Account Deletion", "description": "Identifies when a service account is deleted in Google Cloud Platform (GCP). A service account is a special type of\naccount used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to\nmake authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users\nthrough domain-wide delegation. An adversary may delete a service account in order to disrupt their target's business\noperations.", "query": "event.dataset:gcp.audit and event.action:google.iam.admin.v*.DeleteServiceAccount and event.outcome:success", "tactic": "Impact", "technique": "Account Access Removal", "technique_id": "T1531", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_gcp_service_account_deleted.toml"}
{"title": "GCP Service Account Disabled", "description": "Identifies when a service account is disabled in Google Cloud Platform (GCP). A service account is a special type of\naccount used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to\nmake authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users\nthrough domain-wide delegation. An adversary may disable a service account in order to disrupt to disrupt their target's\nbusiness operations.", "query": "event.dataset:gcp.audit and event.action:google.iam.admin.v*.DisableServiceAccount and event.outcome:success", "tactic": "Impact", "technique": "Account Access Removal", "technique_id": "T1531", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_gcp_service_account_disabled.toml"}
{"title": "GCP IAM Custom Role Creation", "description": "Identifies an Identity and Access Management (IAM) custom role creation in Google Cloud Platform (GCP). Custom roles are\nuser-defined, and allow for the bundling of one or more supported permissions to meet specific needs. Custom roles will\nnot be updated automatically and could lead to privilege creep if not carefully scrutinized.", "query": "event.dataset:gcp.audit and event.action:google.iam.admin.v*.CreateRole and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_gcp_iam_custom_role_creation.toml"}
{"title": "GCP Service Account Key Creation", "description": "Identifies when a new key is created for a service account in Google Cloud Platform (GCP). A service account is a\nspecial type of account used by an application or a virtual machine (VM) instance, not a person. Applications use\nservice accounts to make authorized API calls, authorized as either the service account itself, or as G Suite or Cloud\nIdentity users through domain-wide delegation. If private keys are not tracked and managed properly, they can present a\nsecurity risk. An adversary may create a new key for a service account in order to attempt to abuse the permissions\nassigned to that account and evade detection.", "query": "event.dataset:gcp.audit and event.action:google.iam.admin.v*.CreateServiceAccountKey and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_gcp_key_created_for_service_account.toml"}
{"title": "GCP Service Account Creation", "description": "Identifies when a new service account is created in Google Cloud Platform (GCP). A service account is a special type of\naccount used by an application or a virtual machine (VM) instance, not a person. Applications use service accounts to\nmake authorized API calls, authorized as either the service account itself, or as G Suite or Cloud Identity users\nthrough domain-wide delegation. If service accounts are not tracked and managed properly, they can present a security\nrisk. An adversary may create a new service account to use during their operations in order to avoid using a standard\nuser account and attempt to evade detection.", "query": "event.dataset:gcp.audit and event.action:google.iam.admin.v*.CreateServiceAccount and event.outcome:success", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_gcp_service_account_created.toml"}
{"title": "GitHub Protected Branch Settings Changed", "description": "This rule detects setting modifications for protected branches of a GitHub repository. Branch protection rules can be\nused to enforce certain workflows or requirements before a contributor can push changes to a branch in your repository.\nChanges to these protected branch settings should be investigated and verified as legitimate activity. Unauthorized\nchanges could be used to lower your organization's security posture and leave you exposed for future attacks.", "query": "configuration where event.dataset == \"github.audit\"\n  and github.category == \"protected_branch\" and event.type == \"change\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_github_protected_branch_settings_changed.toml"}
{"title": "GitHub App Deleted", "description": "Detects the deletion of a GitHub app either from a repo or an organization.", "query": "configuration where event.dataset == \"github.audit\" and github.category == \"integration_installation\" and event.type == \"deletion\"", "tactic": "Execution", "technique": "Serverless Execution", "technique_id": "T1648", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_github_app_deleted.toml"}
{"title": "High Number of Cloned GitHub Repos From PAT", "description": "Detects a high number of unique private repo clone events originating from a single personal access token within a short\ntime period.", "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and event.action:\"git.clone\" and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\") and\ngithub.repository_public:false", "tactic": "Execution", "technique": "Serverless Execution", "technique_id": "T1648", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_github_high_number_of_cloned_repos_from_pat.toml"}
{"title": "GitHub UEBA - Multiple Alerts from a GitHub Account", "description": "This rule is part of the \"GitHub UEBA - Unusual Activity from Account Pack\", and leverages alert data to determine when\nmultiple alerts are executed by the same user in a timespan of one hour. Analysts can use this to prioritize triage and\nresponse, as these alerts are a higher indicator of compromised user accounts or PATs.", "query": "signal.rule.tags:(\"Use Case: UEBA\" and \"Data Source: Github\") and kibana.alert.workflow_status:\"open\"", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_github_ueba_multiple_behavior_alerts_from_account.toml"}
{"title": "New GitHub App Installed", "description": "This rule detects when a new GitHub App has been installed in your organization account. GitHub Apps extend GitHub's\nfunctionality both within and outside of GitHub. When an app is installed it is granted permissions to read or modify\nyour repository and organization data. Only trusted apps should be installed and any newly installed apps should be\ninvestigated to verify their legitimacy. Unauthorized app installation could lower your organization's security posture\nand leave you exposed for future attacks.", "query": "configuration where event.dataset == \"github.audit\" and event.action == \"integration_installation.create\"", "tactic": "Execution", "technique": "Software Deployment Tools", "technique_id": "T1072", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_new_github_app_installed.toml"}
{"title": "GitHub Repository Deleted", "description": "This rule detects when a GitHub repository is deleted within your organization. Repositories are a critical component\nused within an organization to manage work, collaborate with others and release products to the public. Any delete\naction against a repository should be investigated to determine it's validity. Unauthorized deletion of organization\nrepositories could cause irreversible loss of intellectual property and indicate compromise within your organization.", "query": "configuration where event.module == \"github\" and event.dataset == \"github.audit\" and event.action == \"repo.destroy\"", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_github_repository_deleted.toml"}
{"title": "New GitHub Owner Added", "description": "Detects when a new member is added to a GitHub organization as an owner. This role provides admin level privileges. Any\nnew owner roles should be investigated to determine it's validity. Unauthorized owner roles could indicate compromise\nwithin your organization and provide unlimited access to data and settings.", "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.add_member\" and github.permission == \"admin\"", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_github_org_owner_added.toml"}
{"title": "GitHub Owner Role Granted To User", "description": "This rule detects when a member is granted the organization owner role of a GitHub organization. This role provides\nadmin level privileges. Any new owner role should be investigated to determine its validity. Unauthorized owner roles\ncould indicate compromise within your organization and provide unlimited access to data and settings.", "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.update_member\" and github.permission == \"admin\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_organization_owner_role_granted.toml"}
{"title": "Google Drive Ownership Transferred via Google Workspace", "description": "Drive and Docs is a Google Workspace service that allows users to leverage Google Drive and Google Docs. Access to files\nis based on inherited permissions from the child organizational unit the user belongs to which is scoped by\nadministrators. Typically if a user is removed, their files can be transferred to another user by the administrator.\nThis service can also be abused by adversaries to transfer files to an adversary account for potential exfiltration.", "query": "event.dataset:\"google_workspace.admin\" and event.action:\"CREATE_DATA_TRANSFER_REQUEST\"\n  and event.category:\"iam\" and google_workspace.admin.application.name:Drive*", "tactic": "Collection", "technique": "Data Staged", "technique_id": "T1074", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_google_drive_ownership_transferred_via_google_workspace.toml"}
{"title": "Google Workspace Custom Gmail Route Created or Modified", "description": "Detects when a custom Gmail route is added or modified in Google Workspace. Adversaries can add a custom e-mail route\nfor outbound mail to route these e-mails to their own inbox of choice for data gathering. This allows adversaries to\ncapture sensitive information from e-mail and potential attachments, such as invoices or payment documents. By default,\nall email from current Google Workspace users with accounts are routed through a domain's mail server for inbound and\noutbound mail.", "query": "event.dataset:\"google_workspace.admin\" and event.action:(\"CREATE_GMAIL_SETTING\" or \"CHANGE_GMAIL_SETTING\")\n  and google_workspace.event.type:\"EMAIL_SETTINGS\" and google_workspace.admin.setting.name:(\"EMAIL_ROUTE\" or \"MESSAGE_SECURITY_RULE\")", "tactic": "Collection", "technique": "Email Collection", "technique_id": "T1114", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_google_workspace_custom_gmail_route_created_or_modified.toml"}
{"title": "Google Workspace Drive Encryption Key(s) Accessed from Anonymous User", "description": "Detects when an external (anonymous) user has viewed, copied or downloaded an encryption key file from a Google\nWorkspace drive. Adversaries may gain access to encryption keys stored in private drives from rogue access links that do\nnot have an expiration. Access to encryption keys may allow adversaries to access sensitive data or authenticate on\nbehalf of users.", "query": "file where event.dataset == \"google_workspace.drive\" and event.action : (\"copy\", \"view\", \"download\") and\n    google_workspace.drive.visibility: \"people_with_link\" and source.user.email == \"\" and\n    file.extension: (\n        \"token\",\"assig\", \"pssc\", \"keystore\", \"pub\", \"pgp.asc\", \"ps1xml\", \"pem\", \"gpg.sig\", \"der\", \"key\",\n        \"p7r\", \"p12\", \"asc\", \"jks\", \"p7b\", \"signature\", \"gpg\", \"pgp.sig\", \"sst\", \"pgp\", \"gpgz\", \"pfx\", \"crt\",\n        \"p8\", \"sig\", \"pkcs7\", \"jceks\", \"pkcs8\", \"psc1\", \"p7c\", \"csr\", \"cer\", \"spc\", \"ps2xml\")", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_google_workspace_drive_encryption_key_accessed_by_anonymous_user.toml"}
{"title": "Application Removed from Blocklist in Google Workspace", "description": "Google Workspace administrators may be aware of malicious applications within the Google marketplace and block these\napplications for user security purposes. An adversary, with administrative privileges, may remove this application from\nthe explicit block list to allow distribution of the application amongst users. This may also indicate the unauthorized\nuse of an application that had been previously blocked before by a user with admin privileges.", "query": "event.dataset:\"google_workspace.admin\" and event.category:\"iam\" and event.type:\"change\"  and\n  event.action:\"CHANGE_APPLICATION_SETTING\" and\n  google_workspace.admin.application.name:\"Google Workspace Marketplace\" and\n  google_workspace.admin.old_value: *allowed*false* and google_workspace.admin.new_value: *allowed*true*", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_application_removed_from_blocklist_in_google_workspace.toml"}
{"title": "Domain Added to Google Workspace Trusted Domains", "description": "Detects when a domain is added to the list of trusted Google Workspace domains. An adversary may add a trusted domain in\norder to collect and exfiltrate data from their target\u2019s organization with less restrictive security controls.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ADD_TRUSTED_DOMAINS", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_domain_added_to_google_workspace_trusted_domains.toml"}
{"title": "Google Workspace Bitlocker Setting Disabled", "description": "Google Workspace administrators whom manage Windows devices and have Windows device management enabled may also enable\nBitLocker drive encryption to mitigate unauthorized data access on lost or stolen computers. Adversaries with valid\naccount access may disable BitLocker to access sensitive data on an endpoint added to Google Workspace device\nmanagement.", "query": "event.dataset:\"google_workspace.admin\" and event.action:\"CHANGE_APPLICATION_SETTING\" and event.category:(iam or configuration)\n    and google_workspace.admin.new_value:\"Disabled\" and google_workspace.admin.setting.name:BitLocker*", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_google_workspace_bitlocker_setting_disabled.toml"}
{"title": "First Time Seen Google Workspace OAuth Login from Third-Party Application", "description": "Detects the first time a third-party application logs in and authenticated with OAuth. OAuth is used to grant\npermissions to specific resources and services in Google Workspace. Compromised credentials or service accounts could\nallow an adversary to authenticate to Google Workspace as a valid user and inherit their privileges.", "query": "event.dataset: \"google_workspace.token\" and event.action: \"authorize\" and\ngoogle_workspace.token.scope.data: *Login and google_workspace.token.client.id: *apps.googleusercontent.com", "tactic": "Defense Evasion", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_google_workspace_new_oauth_login_from_third_party_application.toml"}
{"title": "Google Workspace Restrictions for Marketplace Modified to Allow Any App", "description": "Detects when the Google Marketplace restrictions are changed to allow any application for users in Google Workspace.\nMalicious APKs created by adversaries may be uploaded to the Google marketplace but not installed on devices managed\nwithin Google Workspace. Administrators should set restrictions to not allow any application from the marketplace for\nsecurity reasons. Adversaries may enable any app to be installed and executed on mobile devices within a Google\nWorkspace environment prior to distributing the malicious APK to the end user.", "query": "event.dataset:\"google_workspace.admin\" and event.action:\"CHANGE_APPLICATION_SETTING\" and event.category:(iam or configuration)\n    and google_workspace.event.type:\"APPLICATION_SETTINGS\" and google_workspace.admin.application.name:\"Google Workspace Marketplace\"\n        and google_workspace.admin.setting.name:\"Apps Access Setting Allowlist access\"  and google_workspace.admin.new_value:\"ALLOW_ALL\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_restrictions_for_marketplace_modified_to_allow_any_app.toml"}
{"title": "Forwarded Google Workspace Security Alert", "description": "Identifies the occurrence of a security alert from the Google Workspace alerts center. Google Workspace's security alert\ncenter provides an overview of actionable alerts that may be affecting an organization's domain. An alert is a warning\nof a potential security issue that Google has detected.", "query": "event.dataset: google_workspace.alert", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "google_workspace_alert_center_promotion.toml"}
{"title": "Google Workspace Admin Role Deletion", "description": "Detects when a custom admin role is deleted. An adversary may delete a custom admin role in order to impact the\npermissions or capabilities of system administrators.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:DELETE_ROLE", "tactic": "Impact", "technique": "Account Access Removal", "technique_id": "T1531", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_google_workspace_admin_role_deletion.toml"}
{"title": "Google Workspace MFA Enforcement Disabled", "description": "Detects when multi-factor authentication (MFA) enforcement is disabled for Google Workspace users. An adversary may\ndisable MFA enforcement in order to weaken an organization\u2019s security controls.", "query": "event.dataset:google_workspace.admin and event.provider:admin\n  and event.category:iam and event.action:ENFORCE_STRONG_AUTHENTICATION\n  and google_workspace.admin.new_value:false", "tactic": "Impact", "technique": "Account Access Removal", "technique_id": "T1531", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_google_workspace_mfa_enforcement_disabled.toml"}
{"title": "External User Added to Google Workspace Group", "description": "Detects an external Google Workspace user account being added to an existing group. Adversaries may add external user\naccounts as a means to intercept shared files or emails with that specific group.", "query": "iam where event.dataset == \"google_workspace.admin\" and event.action == \"ADD_GROUP_MEMBER\" and\n  not endsWith(user.target.email, user.target.group.domain)", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_external_user_added_to_google_workspace_group.toml"}
{"title": "Google Workspace Suspended User Account Renewed", "description": "Detects when a previously suspended user's account is renewed in Google Workspace. An adversary may renew a suspended\nuser account to maintain access to the Google Workspace organization with a valid account.", "query": "event.dataset:google_workspace.admin and event.category:iam and event.action:UNSUSPEND_USER", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_google_workspace_suspended_user_renewed.toml"}
{"title": "Google Workspace Object Copied to External Drive with App Consent", "description": "Detects when a user copies a Google spreadsheet, form, document or script from an external drive. Sequence logic has\nbeen added to also detect when a user grants a custom Google application permission via OAuth shortly after. An\nadversary may send a phishing email to the victim with a Drive object link where \"copy\" is included in the URI, thus\ncopying the object to the victim's drive. If a container-bound script exists within the object, execution will require\npermission access via OAuth in which the user has to accept.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_object_copied_to_external_drive_with_app_consent.toml"}
{"title": "Application Added to Google Workspace Domain", "description": "Detects when a Google marketplace application is added to the Google Workspace domain. An adversary may add a malicious\napplication to an organization\u2019s Google Workspace domain in order to maintain a presence in their target\u2019s organization\nand steal data.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:ADD_APPLICATION", "tactic": "Persistence", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_application_added_to_google_workspace_domain.toml"}
{"title": "Google Workspace 2SV Policy Disabled", "description": "Google Workspace admins may setup 2-step verification (2SV) to add an extra layer of security to user accounts by asking\nusers to verify their identity when they use login credentials. Admins have the ability to enforce 2SV from the admin\nconsole as well as the methods acceptable for verification and enrollment period. 2SV requires enablement on admin\naccounts prior to it being enabled for users within organization units. Adversaries may disable 2SV to lower the\nsecurity requirements to access a valid account.", "query": "event.dataset:\"google_workspace.login\" and event.action:\"2sv_disable\"", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_2sv_policy_disabled.toml"}
{"title": "Google Workspace Admin Role Assigned to a User", "description": "Assigning the administrative role to a user will grant them access to the Google Admin console and grant them\nadministrator privileges which allow them to access and manage various resources and applications. An adversary may\ncreate a new administrator account for persistence or apply the admin role to an existing user to carry out further\nintrusion efforts. Users with super-admin privileges can bypass single-sign on if enabled in Google Workspace.", "query": "event.dataset:\"google_workspace.admin\" and event.category:\"iam\" and event.action:\"ASSIGN_ROLE\"\n  and google_workspace.event.type:\"DELEGATED_ADMIN_SETTINGS\" and google_workspace.admin.role.name : *_ADMIN_ROLE", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_admin_role_assigned_to_user.toml"}
{"title": "Google Workspace API Access Granted via Domain-Wide Delegation", "description": "Detects when a domain-wide delegation of authority is granted to a service account. Domain-wide delegation can be\nconfigured to grant third-party and internal applications to access the data of Google Workspace users. An adversary may\nconfigure domain-wide delegation to maintain access to their target\u2019s data.", "query": "event.dataset:google_workspace.admin\n  and event.provider:admin\n  and event.category:iam\n  and event.action:AUTHORIZE_API_CLIENT_ACCESS\n  and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_api_access_granted_via_dwd.toml"}
{"title": "Google Workspace Custom Admin Role Created", "description": "Detects when a custom admin role is created in Google Workspace. An adversary may create a custom admin role in order to\nelevate the permissions of other user accounts and persist in their target\u2019s environment.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:CREATE_ROLE", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_custom_admin_role_created.toml"}
{"title": "Google Workspace Password Policy Modified", "description": "Detects when a Google Workspace password policy is modified. An adversary may attempt to modify a password policy in\norder to weaken an organization\u2019s security controls.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and\n  event.action:(CHANGE_APPLICATION_SETTING or CREATE_APPLICATION_SETTING) and\n  google_workspace.admin.setting.name:(\n    \"Password Management - Enforce strong password\" or\n    \"Password Management - Password reset frequency\" or\n    \"Password Management - Enable password reuse\" or\n    \"Password Management - Enforce password policy at next login\" or\n    \"Password Management - Minimum password length\" or\n    \"Password Management - Maximum password length\"\n  )", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_password_policy_modified.toml"}
{"title": "Google Workspace Role Modified", "description": "Detects when a custom admin role or its permissions are modified. An adversary may modify a custom admin role in order\nto elevate the permissions of other user accounts and persist in their target\u2019s environment.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(ADD_PRIVILEGE or UPDATE_ROLE)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_role_modified.toml"}
{"title": "Google Workspace User Organizational Unit Changed", "description": "Users in Google Workspace are typically assigned a specific organizational unit that grants them permissions to certain\nservices and roles that are inherited from this organizational unit. Adversaries may compromise a valid account and\nchange which organizational account the user belongs to which then could allow them to inherit permissions to\napplications and resources inaccessible prior to.", "query": "event.dataset:\"google_workspace.admin\" and event.type:change and event.category:iam\n    and google_workspace.event.type:\"USER_SETTINGS\" and event.action:\"MOVE_USER_TO_ORG_UNIT\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_google_workspace_user_organizational_unit_changed.toml"}
{"title": "MFA Disabled for Google Workspace Organization", "description": "Detects when multi-factor authentication (MFA) is disabled for a Google Workspace organization. An adversary may attempt\nto modify a password policy in order to weaken an organization\u2019s security controls.", "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:(ENFORCE_STRONG_AUTHENTICATION or ALLOW_STRONG_AUTHENTICATION) and google_workspace.admin.new_value:false", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_mfa_disabled_for_google_workspace_organization.toml"}
{"title": "Kubernetes Denied Service Account Request", "description": "This rule detects when a service account makes an unauthorized request for resources from the API server. Service\naccounts follow a very predictable pattern of behavior. A service account should never send an unauthorized request to\nthe API server. This behavior is likely an indicator of compromise or of a problem within the cluster. An adversary may\nhave gained access to credentials/tokens and this could be an attempt to access or create resources to facilitate\nfurther movement or execution within the cluster.", "query": "event.dataset: \"kubernetes.audit_logs\"\n  and kubernetes.audit.user.username: system\\:serviceaccount\\:*\n  and kubernetes.audit.annotations.authorization_k8s_io/decision: \"forbid\"", "tactic": "Discovery", "technique": "Container and Resource Discovery", "technique_id": "T1613", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_denied_service_account_request.toml"}
{"title": "Kubernetes Suspicious Self-Subject Review", "description": "This rule detects when a service account or node attempts to enumerate their own permissions via the\nselfsubjectaccessreview or selfsubjectrulesreview APIs. This is highly unusual behavior for non-human identities like\nservice accounts and nodes. An adversary may have gained access to credentials/tokens and this could be an attempt to\ndetermine what privileges they have to facilitate further movement or execution within the cluster.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb:\"create\"\n  and kubernetes.audit.objectRef.resource:(\"selfsubjectaccessreviews\" or \"selfsubjectrulesreviews\")\n  and (kubernetes.audit.user.username:(system\\:serviceaccount\\:* or system\\:node\\:*)\n  or kubernetes.audit.impersonatedUser.username:(system\\:serviceaccount\\:* or system\\:node\\:*))", "tactic": "Discovery", "technique": "Container and Resource Discovery", "technique_id": "T1613", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_suspicious_self_subject_review.toml"}
{"title": "Forbidden Request from Unusual User Agent in Kubernetes", "description": "This rule detects when a forbidden request is made from an unusual user agent in a Kubernetes environment.\nAdversary tooling may use non-standard or unexpected user agents to interact with the Kubernetes API, which\ncan indicate an attempt to evade detection or blend in with legitimate traffic. In combination with a forbidden\nrequest, this behavior can suggest an adversary is attempting to exploit vulnerabilities or misconfigurations\nin the Kubernetes cluster.", "query": "any where host.os.type == \"linux\" and event.dataset == \"kubernetes.audit_logs\" and\nkubernetes.audit.stage == \"ResponseComplete\" and `kubernetes.audit.annotations.authorization_k8s_io/decision` == \"forbid\" and\nnot user_agent.original like~ (\n  \"/\", \"karpenter\", \"csi-secrets-store/*\", \"elastic-agent/*\", \"agentbeat/*\", \"insights-operator*\", \"oc/*\", \"cloud-defend/*\",\n  \"OpenAPI-Generator/*\", \"local-storage-operator/*\", \"falcon-client/*\", \"nginx-ingress-controller/*\", \"config-translator/*\",\n  \"kwatch/*\", \"PrometheusOperator/*\", \"kube*\"\n)", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_forbidden_request_from_unsual_user_agent.toml"}
{"title": "Kubernetes User Exec into Pod", "description": "This rule detects a user attempt to establish a shell session into a pod using the 'exec' command. Using the 'exec'\ncommand in a pod allows a user to establish a temporary shell session and execute any process/commands in the pod. An\nadversary may call bash to gain a persistent interactive shell which will allow access to any data the pod has\npermissions to, including secrets.", "query": "any where host.os.type == \"linux\" and event.dataset == \"kubernetes.audit_logs\" and\nkubernetes.audit.verb in (\"get\", \"create\") and kubernetes.audit.objectRef.subresource == \"exec\" and\nkubernetes.audit.stage == \"ResponseComplete\" and `kubernetes.audit.annotations.authorization_k8s_io/decision` == \"allow\"", "tactic": "Execution", "technique": "Container Administration Command", "technique_id": "T1609", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_user_exec_to_pod.toml"}
{"title": "Kubernetes Exposed Service Created With Type NodePort", "description": "This rule detects an attempt to create or modify a service as type NodePort. The NodePort service allows a user to\nexternally expose a set of labeled pods to the internet. This creates an open port on every worker node in the cluster\nthat has a pod for that service. When external traffic is received on that open port, it directs it to the specific pod\nthrough the service representing it. A malicious user can configure a service as type Nodeport in order to intercept\ntraffic from other pods or nodes, bypassing firewalls and other network security measures configured for load balancers\nwithin a cluster. This creates a direct method of communication between the cluster and the outside world, which could\nbe used for more malicious behavior and certainly widens the attack surface of your cluster.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"services\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.type:\"NodePort\"", "tactic": "Persistence", "technique": "External Remote Services", "technique_id": "T1133", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_exposed_service_created_with_type_nodeport.toml"}
{"title": "Kubernetes Container Created with Excessive Linux Capabilities", "description": "This rule detects a container deployed with one or more dangerously permissive Linux capabilities. An attacker with the\nability to deploy a container with added capabilities could use this for further execution, lateral movement, or\nprivilege escalation within a cluster. The capabilities detected in this rule have been used in container escapes to the\nhost machine.", "query": "event.dataset: kubernetes.audit_logs\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb: create\n  and kubernetes.audit.objectRef.resource: pods\n  and kubernetes.audit.requestObject.spec.containers.securityContext.capabilities.add: (\"BPF\" or \"DAC_READ_SEARCH\"  or \"NET_ADMIN\" or \"SYS_ADMIN\" or \"SYS_BOOT\" or \"SYS_MODULE\" or \"SYS_PTRACE\" or \"SYS_RAWIO\"  or \"SYSLOG\")\n  and not kubernetes.audit.requestObject.spec.containers.image : (\"docker.elastic.co/beats/elastic-agent:8.4.0\" or \"rancher/klipper-lb:v0.3.5\" or \"\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_container_created_with_excessive_linux_capabilities.toml"}
{"title": "Kubernetes Pod Created With HostIPC", "description": "This rule detects an attempt to create or modify a pod using the host IPC namespace. This gives access to data used by\nany pod that also use the hosts IPC namespace. If any process on the host or any processes in a pod uses the hosts\ninter-process communication mechanisms (shared memory, semaphore arrays, message queues, etc.), an attacker can\nread/write to those same mechanisms. They may look for files in /dev/shm or use ipcs to check for any IPC facilities\nbeing used.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.hostIPC:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_pod_created_with_hostipc.toml"}
{"title": "Kubernetes Pod Created With HostNetwork", "description": "This rules detects an attempt to create or modify a pod attached to the host network. HostNetwork allows a pod to use\nthe node network namespace. Doing so gives the pod access to any service running on localhost of the host. An attacker\ncould use this access to snoop on network activity of other pods on the same node or bypass restrictive network policies\napplied to its given namespace.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.hostNetwork:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_pod_created_with_hostnetwork.toml"}
{"title": "Kubernetes Pod Created With HostPID", "description": "This rule detects an attempt to create or modify a pod attached to the host PID namespace. HostPID allows a pod to\naccess all the processes running on the host and could allow an attacker to take malicious action. When paired with\nptrace this can be used to escalate privileges outside of the container. When paired with a privileged container, the\npod can see all of the processes on the host. An attacker can enter the init system (PID 1) on the host. From there,\nthey could execute a shell and continue to escalate privileges to root.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.hostPID:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_pod_created_with_hostpid.toml"}
{"title": "Kubernetes Pod created with a Sensitive hostPath Volume", "description": "This rule detects when a pod is created with a sensitive volume of type hostPath. A hostPath volume type mounts a\nsensitive file or folder from the node to the container. If the container gets compromised, the attacker can use this\nmount for gaining access to the node. There are many ways a container with unrestricted access to the host filesystem\ncan escalate privileges, including reading data from other containers, and accessing tokens of more privileged pods.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.volumes.hostPath.path:\n  (\"/\" or\n  \"/proc\" or\n  \"/root\" or\n  \"/var\" or\n  \"/var/run\" or\n  \"/var/run/docker.sock\" or\n  \"/var/run/crio/crio.sock\" or\n  \"/var/run/cri-dockerd.sock\" or\n  \"/var/lib/kubelet\" or\n  \"/var/lib/kubelet/pki\" or\n  \"/var/lib/docker/overlay2\" or\n  \"/etc\" or\n  \"/etc/kubernetes\" or\n  \"/etc/kubernetes/manifests\" or\n  \"/etc/kubernetes/pki\" or\n  \"/home/admin\")\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_pod_created_with_sensitive_hostpath_volume.toml"}
{"title": "Kubernetes Privileged Pod Created", "description": "This rule detects when a user creates a pod/container running in privileged mode. A highly privileged container has\naccess to the node's resources and breaks the isolation between containers. If compromised, an attacker can use the\nprivileged container to gain access to the underlying host. Gaining access to the host may provide the adversary with\nthe opportunity to achieve follow-on objectives, such as establishing persistence, moving laterally within the\nenvironment, or setting up a command and control channel on the host.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:pods\n  and kubernetes.audit.verb:create\n  and kubernetes.audit.requestObject.spec.containers.securityContext.privileged:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_privileged_pod_created.toml"}
{"title": "Kubernetes Suspicious Assignment of Controller Service Account", "description": "This rule detects a request to attach a controller service account to an existing or new pod running in the kube-system\nnamespace. By default, controllers running as part of the API Server utilize admin-equivalent service accounts hosted in\nthe kube-system namespace. Controller service accounts aren't normally assigned to running pods and could indicate\nadversary behavior within the cluster. An attacker that can create or modify pods or pod controllers in the kube-system\nnamespace, can assign one of these admin-equivalent service accounts to a pod and abuse their powerful token to escalate\nprivileges and gain complete cluster control.", "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb : \"create\"\n  and kubernetes.audit.objectRef.resource : \"pods\"\n  and kubernetes.audit.objectRef.namespace : \"kube-system\"\n  and kubernetes.audit.requestObject.spec.serviceAccountName:*controller", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_suspicious_assignment_of_controller_service_account.toml"}
{"title": "High Mean of Process Arguments in an RDP Session", "description": "A machine learning job has detected unusually high number of process arguments in an RDP session. Executing\nsophisticated attacks such as lateral movement can involve the use of complex commands, obfuscation mechanisms,\nredirection and piping, which in turn increases the number of arguments in a command.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_high_mean_rdp_process_args.toml"}
{"title": "High Mean of RDP Session Duration", "description": "A machine learning job has detected unusually high mean of RDP session duration. Long RDP sessions can be used to evade\ndetection mechanisms via session persistence, and might be used to perform tasks such as lateral movement, that might\nrequire uninterrupted access to a compromised machine.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_high_mean_rdp_session_duration.toml"}
{"title": "Unusual Remote File Size", "description": "A machine learning job has detected an unusually high file size shared by a remote host indicating potential lateral\nmovement activity. One of the primary goals of attackers after gaining access to a network is to locate and exfiltrate\nvaluable information. Instead of multiple small transfers that can raise alarms, attackers might choose to bundle data\ninto a single large file transfer.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_high_remote_file_size.toml"}
{"title": "High Variance in RDP Session Duration", "description": "A machine learning job has detected unusually high variance of RDP session duration. Long RDP sessions can be used to\nevade detection mechanisms via session persistence, and might be used to perform tasks such as lateral movement, that\nmight require uninterrupted access to a compromised machine.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_high_variance_rdp_session_duration.toml"}
{"title": "Unusual Remote File Directory", "description": "An anomaly detection job has detected a remote file transfer on an unusual directory indicating a potential lateral\nmovement activity on the host. Many Security solutions monitor well-known directories for suspicious activities, so\nattackers might use less common directories to bypass monitoring.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_rare_remote_file_directory.toml"}
{"title": "Unusual Remote File Extension", "description": "An anomaly detection job has detected a remote file transfer with a rare extension, which could indicate potential\nlateral movement activity on the host.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_rare_remote_file_extension.toml"}
{"title": "Spike in Number of Connections Made from a Source IP", "description": "A machine learning job has detected a high count of destination IPs establishing an RDP connection with a single source\nIP. Once an attacker has gained access to one system, they might attempt to access more in the network in search of\nvaluable assets, data, or further access points.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_spike_in_connections_from_a_source_ip.toml"}
{"title": "Spike in Number of Connections Made to a Destination IP", "description": "A machine learning job has detected a high count of source IPs establishing an RDP connection with a single destination\nIP. Attackers might use multiple compromised systems to attack a target to ensure redundancy in case a source IP gets\ndetected and blocked.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_spike_in_connections_to_a_destination_ip.toml"}
{"title": "Spike in Number of Processes in an RDP Session", "description": "A machine learning job has detected unusually high number of processes started in a single RDP session. Executing a\nlarge number of processes remotely on other machines can be an indicator of lateral movement activity.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_spike_in_rdp_processes.toml"}
{"title": "Spike in Remote File Transfers", "description": "A machine learning job has detected an abnormal volume of remote files shared on the host indicating potential lateral\nmovement activity. One of the primary goals of attackers after gaining access to a network is to locate and exfiltrate\nvaluable information. Attackers might perform multiple small transfers to match normal egress activity in the network,\nto evade detection.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_spike_in_remote_file_transfers.toml"}
{"title": "Unusual Time or Day for an RDP Session", "description": "A machine learning job has detected an RDP session started at an usual time or weekday. An RDP session at an unusual\ntime could be followed by other suspicious activities, so catching this is a good first step in detecting a larger\nattack.", "query": "N/A", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ml_unusual_time_for_an_rdp_session.toml"}
{"title": "Microsoft 365 Inbox Forwarding Rule Created", "description": "Identifies when a new Inbox forwarding rule is created in Microsoft 365. Inbox rules process messages in the Inbox based\non conditions and take actions. In this case, the rules will forward the emails to a defined address. Attackers can\nabuse Inbox Rules to intercept and exfiltrate email data without making organization-wide configuration changes or\nhaving the corresponding privileges.", "query": "event.dataset:o365.audit and event.provider:Exchange and\nevent.category:web and event.action:(\"New-InboxRule\" or \"Set-InboxRule\") and\n    (\n        o365.audit.Parameters.ForwardTo:* or\n        o365.audit.Parameters.ForwardAsAttachmentTo:* or\n        o365.audit.Parameters.RedirectTo:*\n    )\n    and event.outcome:success", "tactic": "Collection", "technique": "Email Collection", "technique_id": "T1114", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_microsoft_365_new_inbox_rule.toml"}
{"title": "M365 OneDrive Excessive File Downloads with OAuth Token", "description": "Identifies when an excessive number of files are downloaded from OneDrive using OAuth authentication. Adversaries may\nconduct phishing campaigns to steal OAuth tokens and impersonate users. These access tokens can then be used to download\nfiles from OneDrive.", "query": "FROM logs-o365.audit-*\n| WHERE @timestamp > now() - 14 day\n| WHERE\n    event.dataset == \"o365.audit\" and\n\n    // filter on files downloaded from OneDrive\n    event.provider == \"OneDrive\" and\n    event.action == \"FileDownloaded\" and\n\n    // filter on OAuth authentication which encompasses device code workflow\n    o365.audit.AuthenticationType == \"OAuth\"\n    and event.outcome == \"success\"\n// bucket authentication attempts by 1 minute\n| EVAL target_time_window = DATE_TRUNC(1 minutes, @timestamp)\n| KEEP target_time_window, o365.audit.UserId, file.name, source.ip\n\n// aggregate on unique file names and download attempts\n| STATS unique_file_count = count_distinct(file.name), download_attempt_count = count(*) BY target_time_window, o365.audit.UserId, source.ip\n\n// adjustable range for \"excessive\" unique files that were downloaded\n| WHERE unique_file_count >= 25", "tactic": "Collection", "technique": "Data from Cloud Storage", "technique_id": "T1530", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_onedrive_excessive_file_downloads.toml"}
{"title": "Microsoft 365 OAuth Redirect to Device Registration for User Principal", "description": "Identifies attempts to register a new device in Microsoft Entra ID after OAuth authentication with authorization code\ngrant. Adversaries may use OAuth phishing techniques to obtain an OAuth authorization code, which can then be exchanged\nfor access and refresh tokens. This rule detects a sequence of events where a user principal authenticates via OAuth,\nfollowed by a device registration event, indicating potential misuse of the OAuth flow to establish persistence or\naccess resources.", "query": "sequence by related.user with maxspan=30m\n[authentication where event.action == \"UserLoggedIn\" and\n o365.audit.ExtendedProperties.RequestType == \"OAuth2:Authorize\" and o365.audit.ExtendedProperties.ResultStatusDetail == \"Redirect\" and\n o365.audit.UserType: (\"0\", \"2\", \"3\", \"10\")] // victim source.ip\n[authentication where event.action == \"UserLoggedIn\" and\n o365.audit.ExtendedProperties.RequestType == \"OAuth2:Token\" and o365.audit.ExtendedProperties.ResultStatusDetail == \"Success\"] // attacker source.ip to convert oauth code to token\n[web where event.dataset == \"o365.audit\" and event.action == \"Add registered users to device.\"] // user.name is captured in related.user", "tactic": "Credential Access", "technique": "Steal Application Access Token", "technique_id": "T1528", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_antra_id_device_reg_via_oauth_redirection.toml"}
{"title": "Multiple Microsoft 365 User Account Lockouts in Short Time Window", "description": "Detects a burst of Microsoft 365 user account lockouts within a short 5-minute window. A high number of IdsLocked login\nerrors across multiple user accounts may indicate brute-force attempts for the same users resulting in lockouts.", "query": "FROM logs-o365.audit-*\n\n| MV_EXPAND event.category\n| EVAL\n    time_window = DATE_TRUNC(5 minutes, @timestamp),\n    user_id = TO_LOWER(o365.audit.UserId),\n    ip = source.ip,\n    login_error = o365.audit.LogonError,\n    request_type = TO_LOWER(o365.audit.ExtendedProperties.RequestType),\n    asn_org = source.`as`.organization.name,\n    country = source.geo.country_name,\n    event_time = @timestamp\n\n| WHERE event.dataset == \"o365.audit\"\n  AND event.category == \"authentication\"\n  AND event.provider IN (\"AzureActiveDirectory\", \"Exchange\")\n  AND event.action IN (\"UserLoginFailed\", \"PasswordLogonInitialAuthUsingPassword\")\n  AND request_type RLIKE \"(oauth.*||.*login.*)\"\n  AND login_error == \"IdsLocked\"\n  AND user_id != \"not available\"\n  AND o365.audit.Target.Type IN (\"0\", \"2\", \"6\", \"10\")\n  AND asn_org != \"MICROSOFT-CORP-MSN-AS-BLOCK\"\n\n| STATS\n    unique_users = COUNT_DISTINCT(user_id),\n    user_id_list = VALUES(user_id),\n    ip_list = VALUES(ip),\n    unique_ips = COUNT_DISTINCT(ip),\n    source_orgs = VALUES(asn_org),\n    countries = VALUES(country),\n    unique_country_count = COUNT_DISTINCT(country),\n    unique_asn_orgs = COUNT_DISTINCT(asn_org),\n    request_types = VALUES(request_type),\n    first_seen = MIN(event_time),\n    last_seen = MAX(event_time),\n    total_lockout_responses = COUNT()\n  BY time_window\n\n| EVAL\n    duration_seconds = DATE_DIFF(\"seconds\", first_seen, last_seen)\n\n| KEEP\n    time_window, unique_users, user_id_list, ip_list,\n    unique_ips, source_orgs, countries, unique_country_count,\n    unique_asn_orgs, request_types, first_seen, last_seen,\n    total_lockout_responses, duration_seconds\n\n| WHERE\n    unique_users >= 10 AND\n    total_lockout_responses >= 10 AND\n    duration_seconds <= 300", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_microsoft_365_excessive_account_lockouts.toml"}
{"title": "Potential Microsoft 365 User Account Brute Force", "description": "Identifies brute-force authentication activity targeting Microsoft 365 user accounts using failed sign-in patterns that\nmatch password spraying, credential stuffing, or password guessing behavior. Adversaries may attempt brute-force\nauthentication with credentials obtained from previous breaches, leaks, marketplaces or guessable passwords.", "query": "FROM logs-o365.audit-*\n\n| MV_EXPAND event.category\n| EVAL\n    time_window = DATE_TRUNC(5 minutes, @timestamp),\n    user_id = TO_LOWER(o365.audit.UserId),\n    ip = source.ip,\n    login_error = o365.audit.LogonError,\n    request_type = TO_LOWER(o365.audit.ExtendedProperties.RequestType),\n    asn_org = source.`as`.organization.name,\n    country = source.geo.country_name,\n    event_time = @timestamp\n\n| WHERE event.dataset == \"o365.audit\"\n  AND event.category == \"authentication\"\n  AND event.provider IN (\"AzureActiveDirectory\", \"Exchange\")\n  AND event.action IN (\"UserLoginFailed\", \"PasswordLogonInitialAuthUsingPassword\")\n  AND request_type RLIKE \"(oauth.*||.*login.*)\"\n  AND login_error != \"IdsLocked\"\n  AND login_error NOT IN (\n    \"EntitlementGrantsNotFound\", \"UserStrongAuthEnrollmentRequired\", \"UserStrongAuthClientAuthNRequired\",\n    \"InvalidReplyTo\", \"SsoArtifactExpiredDueToConditionalAccess\", \"PasswordResetRegistrationRequiredInterrupt\",\n    \"SsoUserAccountNotFoundInResourceTenant\", \"UserStrongAuthExpired\", \"CmsiInterrupt\"\n  )\n  AND user_id != \"not available\"\n  AND o365.audit.Target.Type IN (\"0\", \"2\", \"6\", \"10\")\n\n| STATS\n    unique_users = COUNT_DISTINCT(user_id),\n    user_id_list = VALUES(user_id),\n    login_errors = VALUES(login_error),\n    unique_login_errors = COUNT_DISTINCT(login_error),\n    request_types = VALUES(request_type),\n    ip_list = VALUES(ip),\n    unique_ips = COUNT_DISTINCT(ip),\n    source_orgs = VALUES(asn_org),\n    countries = VALUES(country),\n    unique_country_count = COUNT_DISTINCT(country),\n    unique_asn_orgs = COUNT_DISTINCT(asn_org),\n    first_seen = MIN(event_time),\n    last_seen = MAX(event_time),\n    total_attempts = COUNT()\n  BY time_window\n\n| EVAL\n    duration_seconds = DATE_DIFF(\"seconds\", first_seen, last_seen),\n    bf_type = CASE(\n        unique_users >= 15 AND unique_login_errors == 1 AND total_attempts >= 10 AND duration_seconds <= 1800, \"password_spraying\",\n        unique_users >= 8 AND total_attempts >= 15 AND unique_login_errors <= 3 AND unique_ips <= 5 AND duration_seconds <= 600, \"credential_stuffing\",\n        unique_users == 1 AND unique_login_errors == 1 AND total_attempts >= 20 AND duration_seconds <= 300, \"password_guessing\",\n        \"other\"\n    )\n\n| KEEP\n    time_window, unique_users, user_id_list, login_errors, unique_login_errors,\n    request_types, ip_list, unique_ips, source_orgs, countries,\n    unique_country_count, unique_asn_orgs, first_seen, last_seen,\n    duration_seconds, total_attempts, bf_type\n\n| WHERE\n    bf_type != \"other\"", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_microsoft_365_potential_user_account_brute_force.toml"}
{"title": "O365 Excessive Single Sign-On Logon Errors", "description": "Identifies accounts with a high number of single sign-on (SSO) logon errors. Excessive logon errors may indicate an\nattempt to brute force a password or SSO token.", "query": "event.dataset:o365.audit and event.provider:AzureActiveDirectory and event.category:authentication and o365.audit.LogonError:\"SsoArtifactInvalidOrExpired\"", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_user_excessive_sso_logon_errors.toml"}
{"title": "Microsoft 365 Exchange DLP Policy Removed", "description": "Identifies when a Data Loss Prevention (DLP) policy is removed in Microsoft 365. An adversary may remove a DLP policy to\nevade existing DLP monitoring.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-DlpPolicy\" and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_exchange_dlp_policy_removed.toml"}
{"title": "Microsoft 365 Exchange Malware Filter Policy Deletion", "description": "Identifies when a malware filter policy has been deleted in Microsoft 365. A malware filter policy is used to alert\nadministrators that an internal user sent a message that contained malware. This may indicate an account or machine\ncompromise that would need to be investigated. Deletion of a malware filter policy may be done to evade detection.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-MalwareFilterPolicy\" and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_exchange_malware_filter_policy_deletion.toml"}
{"title": "Microsoft 365 Exchange Malware Filter Rule Modification", "description": "Identifies when a malware filter rule has been deleted or disabled in Microsoft 365. An adversary or insider threat may\nwant to modify a malware filter rule to evade detection.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-MalwareFilterRule\" or \"Disable-MalwareFilterRule\") and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_exchange_malware_filter_rule_mod.toml"}
{"title": "Microsoft 365 Exchange Safe Attachment Rule Disabled", "description": "Identifies when a safe attachment rule is disabled in Microsoft 365. Safe attachment rules can extend malware\nprotections to include routing all messages and attachments without a known malware signature to a special hypervisor\nenvironment. An adversary or insider threat may disable a safe attachment rule to exfiltrate data or evade defenses.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Disable-SafeAttachmentRule\" and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_exchange_safe_attach_rule_disabled.toml"}
{"title": "O365 Mailbox Audit Logging Bypass", "description": "Detects the occurrence of mailbox audit bypass associations. The mailbox audit is responsible for logging specified\nmailbox events (like accessing a folder or a message or permanently deleting a message). However, actions taken by some\nauthorized accounts, such as accounts used by third-party tools or accounts used for lawful monitoring, can create a\nlarge number of mailbox audit log entries and may not be of interest to your organization. Because of this,\nadministrators can create bypass associations, allowing certain accounts to perform their tasks without being logged.\nAttackers can abuse this allowlist mechanism to conceal actions taken, as the mailbox audit will log no activity done by\nthe account.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.action:Set-MailboxAuditBypassAssociation and event.outcome:success", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_mailboxauditbypassassociation.toml"}
{"title": "Microsoft 365 Suspicious Inbox Rule to Delete or Move Emails", "description": "Identifies when a user creates a new inbox rule in Microsoft 365 that deletes or moves emails containing suspicious\nkeywords. Adversaries who have compromised accounts often create inbox rules to hide alerts, security notifications, or\nother sensitive messages by automatically deleting them or moving them to obscure folders. Common destinations include\nDeleted Items, Junk Email, RSS Feeds, and RSS Subscriptions. This is a New Terms rule that triggers only when the user\nprincipal name and associated source IP address have not been observed performing this activity in the past 14 days.", "query": "event.dataset: \"o365.audit\" and\n    event.action: \"New-InboxRule\" and event.outcome: \"success\" and\n    o365.audit.Parameters.SubjectContainsWords: (\n        *phish* or\n        *hack* or\n        *alert* or\n        *malware* or\n        *security* or\n        *invoice* or\n        *payment* or\n        *wire* or\n        *transfer* or\n        *fraud* or\n        *reset* or\n        *unusual* or\n        *protection* or\n        *login* or\n        *suspicious*\n    ) and (\n    o365.audit.Parameters.DeleteMessage: True or\n    o365.audit.Parameters.MoveToFolder: (\n        *Deleted* or\n        *Junk* or\n        *RSS*\n    )\n)", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_new_inbox_rule_delete_or_move.toml"}
{"title": "Suspicious Microsoft 365 UserLoggedIn via OAuth Code", "description": "Identifies sign-ins on behalf of a principal user to the Microsoft Graph API from multiple IPs using the Microsoft\nAuthentication Broker or Visual Studio Code application. This behavior may indicate an adversary using a phished OAuth\nrefresh token.", "query": "from logs-o365.audit-default*\n| WHERE event.dataset == \"o365.audit\" and event.action == \"UserLoggedIn\" and\n  source.ip is not null and o365.audit.UserId is not null and o365.audit.ApplicationId is not null and o365.audit.UserType in (\"0\", \"2\", \"3\", \"10\") and \n\n  // filter for successful logon to Microsoft Graph and from the Microsoft Authentication Broker or Visual Studio Code\n  o365.audit.ApplicationId in (\"aebc6443-996d-45c2-90f0-388ff96faa56\", \"29d9ed98-a469-4536-ade2-f981bc1d605e\") and\n  o365.audit.ObjectId in (\"00000003-0000-0000-c000-000000000000\")\n\n// keep relevant fields only\n| keep @timestamp, o365.audit.UserId, source.ip, o365.audit.ApplicationId, o365.audit.ObjectId, o365.audit.ExtendedProperties.RequestType, source.as.organization.name, o365.audit.ExtendedProperties.ResultStatusDetail\n\n// case statements to track which are OAuth2 authorization request via redirect and which are related to OAuth2 code to token conversion\n| eval oauth_authorize = case(o365.audit.ExtendedProperties.RequestType == \"OAuth2:Authorize\" and o365.audit.ExtendedProperties.ResultStatusDetail == \"Redirect\", o365.audit.UserId, null), oauth_token = case(o365.audit.ExtendedProperties.RequestType == \"OAuth2:Token\", o365.audit.UserId, null)\n\n// split time to 30 minutes intervals\n| eval target_time_window = DATE_TRUNC(30 minutes, @timestamp)\n\n// aggregate by principal, applicationId, objectId and time window\n| stats unique_ips = COUNT_DISTINCT(source.ip), source_ips = VALUES(source.ip), appIds = VALUES(o365.audit.ApplicationId), asn = values(`source.as.organization.name`), is_oauth_token = COUNT_DISTINCT(oauth_token), is_oauth_authorize = COUNT_DISTINCT(oauth_authorize) by o365.audit.UserId, target_time_window, o365.audit.ApplicationId, o365.audit.ObjectId\n\n// filter for cases where the same appId is used by the same principal user to access the same object and from multiple addresses via OAuth2 token\n| where unique_ips >= 2 and is_oauth_authorize > 0 and is_oauth_token > 0", "tactic": "Defense Evasion", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_365_susp_oauth2_authorization.toml"}
{"title": "Microsoft 365 Exchange Transport Rule Creation", "description": "Identifies a transport rule creation in Microsoft 365. As a best practice, Exchange Online mail transport rules should\nnot be set to forward email to domains outside of your organization. An adversary may create transport rules to\nexfiltrate data.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"New-TransportRule\" and event.outcome:success", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_microsoft_365_exchange_transport_rule_creation.toml"}
{"title": "Microsoft 365 Exchange Transport Rule Modification", "description": "Identifies when a transport rule has been disabled or deleted in Microsoft 365. Mail flow rules (also known as transport\nrules) are used to identify and take action on messages that flow through your organization. An adversary or insider\nthreat may modify a transport rule to exfiltrate data or evade defenses.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-TransportRule\" or \"Disable-TransportRule\") and event.outcome:success", "tactic": "Exfiltration", "technique": "Transfer Data to Cloud Account", "technique_id": "T1537", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_microsoft_365_exchange_transport_rule_mod.toml"}
{"title": "Microsoft 365 Mass download by a single user", "description": "Identifies when Microsoft Cloud App Security reports that a single user performs more than 50 downloads within 1 minute.", "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Mass download by a single user\" and event.outcome:success", "tactic": "Exfiltration", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_microsoft_365_mass_download_by_a_single_user.toml"}
{"title": "Microsoft 365 Potential ransomware activity", "description": "Identifies when Microsoft Cloud App Security reports that a user has uploaded files to the cloud that might be infected\nwith ransomware.", "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Potential ransomware activity\" and event.outcome:success", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_microsoft_365_potential_ransomware_activity.toml"}
{"title": "Microsoft 365 Unusual Volume of File Deletion", "description": "Identifies that a user has deleted an unusually large volume of files as reported by Microsoft Cloud App Security.", "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Unusual volume of file deletion\" and event.outcome:success", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_microsoft_365_unusual_volume_of_file_deletion.toml"}
{"title": "Suspicious Microsoft 365 Mail Access by ClientAppId", "description": "Identifies when a Microsoft 365 Mailbox is accessed by a ClientAppId that was observed for the fist time during the last\n10 days.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:MailItemsAccessed and event.outcome:success and\nnot o365.audit.ClientAppId : (\"13937bba-652e-4c46-b222-3003f4d1ff97\" or \"6326e366-9d6d-4c70-b22a-34c7ea72d73d\" or \n \"a3883eba-fbe9-48bd-9ed3-dca3e0e84250\" or \"d3590ed6-52b3-4102-aeff-aad2292ab01c\" or \"27922004-5251-4030-b22d-91ecd9a37ea4\" or \n \"1fec8e78-bce4-4aaf-ab1b-5451cc387264\" or \"26a7ee05-5602-4d76-a7ba-eae8b7b67941\" or \"00000002-0000-0000-c000-000000000000\" or \n \"00000002-0000-0ff1-ce00-000000000000\" or \"ffcb16e8-f789-467c-8ce9-f826a080d987\" or \"00000003-0000-0ff1-ce00-000000000000\" or \n \"00000004-0000-0ff1-ce00-000000000000\" or \"00000005-0000-0ff1-ce00-000000000000\" or  \"00000006-0000-0ff1-ce00-000000000000\" or \n \"00000007-0000-0000-c000-000000000000\" or \"00000007-0000-0ff1-ce00-000000000000\" or \n \"00000009-0000-0000-c000-000000000000\" or \"0000000c-0000-0000-c000-000000000000\" or \"00000015-0000-0000-c000-000000000000\" or \n \"0000001a-0000-0000-c000-000000000000\" or \"00b41c95-dab0-4487-9791-b9d2c32c80f2\" or \"022907d3-0f1b-48f7-badc-1ba6abab6d66\" or \n \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\" or \"08e18876-6177-487e-b8b5-cf950c1e598c\" or \"0cb7b9ec-5336-483b-bc31-b15b5788de71\" or \n \"0cd196ee-71bf-4fd6-a57c-b491ffd4fb1e\" or \"0f698dd4-f011-4d23-a33e-b36416dcb1e6\" or \"13937bba-652e-4c46-b222-3003f4d1ff97\" or \n \"14d82eec-204b-4c2f-b7e8-296a70dab67e\" or \"16aeb910-ce68-41d1-9ac3-9e1673ac9575\" or \"1786c5ed-9644-47b2-8aa0-7201292175b6\" or \n \"17d5e35f-655b-4fb0-8ae6-86356e9a49f5\" or \"18fbca16-2224-45f6-85b0-f7bf2b39b3f3\" or \"1950a258-227b-4e31-a9cf-717495945fc2\" or \n \"1b3c667f-cde3-4090-b60b-3d2abd0117f0\" or \"1fec8e78-bce4-4aaf-ab1b-5451cc387264\" or \"20a11fe0-faa8-4df5-baf2-f965f8f9972e\" or \n \"23523755-3a2b-41ca-9315-f81f3f566a95\" or \"243c63a3-247d-41c5-9d83-7788c43f1c43\" or \"268761a2-03f3-40df-8a8b-c3db24145b6b\" or \n \"26a7ee05-5602-4d76-a7ba-eae8b7b67941\" or \"26abc9a8-24f0-4b11-8234-e86ede698878\" or \"27922004-5251-4030-b22d-91ecd9a37ea4\" or \n \"28b567f6-162c-4f54-99a0-6887f387bbcc\" or \"29d9ed98-a469-4536-ade2-f981bc1d605e\" or \"2abdc806-e091-4495-9b10-b04d93c3f040\" or \n \"2d4d3d8e-2be3-4bef-9f87-7875a61c29de\" or \"2d7f3606-b07d-41d1-b9d2-0d0c9296a6e8\" or \"3090ab82-f1c1-4cdf-af2c-5d7a6f3e2cc7\" or \n \"35d54a08-36c9-4847-9018-93934c62740c\" or \"37182072-3c9c-4f6a-a4b3-b3f91cacffce\" or \"38049638-cc2c-4cde-abe4-4479d721ed44\" or \n \"3c896ded-22c5-450f-91f6-3d1ef0848f6e\" or \"4345a7b9-9a63-4910-a426-35363201d503\" or \"45a330b1-b1ec-4cc1-9161-9f03992aa49f\" or \n \"4765445b-32c6-49b0-83e6-1d93765276ca\" or \"497effe9-df71-4043-a8bb-14cf78c4b63b\" or  \"4b233688-031c-404b-9a80-a4f3f2351f90\" or \n \"4d5c2d63-cf83-4365-853c-925fd1a64357\" or \"51be292c-a17e-4f17-9a7e-4b661fb16dd2\" or \n \"5572c4c0-d078-44ce-b81c-6cbf8d3ed39e\" or \"5e3ce6c0-2b1f-4285-8d4b-75ee78787346\" or \"60c8bde5-3167-4f92-8fdb-059f6176dc0f\" or \n \"61109738-7d2b-4a0b-9fe3-660b1ff83505\" or \"62256cef-54c0-4cb4-bcac-4c67989bdc40\" or \"6253bca8-faf2-4587-8f2f-b056d80998a7\" or \n \"65d91a3d-ab74-42e6-8a2f-0add61688c74\" or \"66a88757-258c-4c72-893c-3e8bed4d6899\" or \"67e3df25-268a-4324-a550-0de1c7f97287\" or \n \"69893ee3-dd10-4b1c-832d-4870354be3d8\" or \"74658136-14ec-4630-ad9b-26e160ff0fc6\" or \"74bcdadc-2fdc-4bb3-8459-76d06952a0e9\" or \n \"797f4846-ba00-4fd7-ba43-dac1f8f63013\" or \"7ab7862c-4c57-491e-8a45-d52a7e023983\" or \"7ae974c5-1af7-4923-af3a-fb1fd14dcb7e\" or \n \"7b7531ad-5926-4f2d-8a1d-38495ad33e17\" or \"80ccca67-54bd-44ab-8625-4b79c4dc7775\" or \"835b2a73-6e10-4aa5-a979-21dfda45231c\" or \n \"871c010f-5e61-4fb1-83ac-98610a7e9110\" or \"89bee1f7-5e6e-4d8a-9f3d-ecd601259da7\" or \"8edd93e1-2103-40b4-bd70-6e34e586362d\" or \n \"905fcf26-4eb7-48a0-9ff0-8dcc7194b5ba\" or \"91ca2ca5-3b3e-41dd-ab65-809fa3dffffa\" or \"93625bc8-bfe2-437a-97e0-3d0060024faa\" or \n \"93d53678-613d-4013-afc1-62e9e444a0a5\" or \"944f0bd1-117b-4b1c-af26-804ed95e767e\" or \"94c63fef-13a3-47bc-8074-75af8c65887a\" or \n \"95de633a-083e-42f5-b444-a4295d8e9314\" or \"97cb1f73-50df-47d1-8fb0-0271f2728514\" or \"98db8bd6-0cc0-4e67-9de5-f187f1cd1b41\" or \n \"99b904fd-a1fe-455c-b86c-2f9fb1da7687\" or \"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7\" or \"a3475900-ccec-4a69-98f5-a65cd5dc5306\" or \n \"a3b79187-70b2-4139-83f9-6016c58cd27b\" or \"a57aca87-cbc0-4f3c-8b9e-dc095fdc8978\" or \"a970bac6-63fe-4ec5-8884-8536862c42d4\" or \n \"a9b49b65-0a12-430b-9540-c80b3332c127\" or \"ab9b8c07-8f02-4f72-87fa-80105867a763\" or \"ae8e128e-080f-4086-b0e3-4c19301ada69\" or \n \"b23dd4db-9142-4734-867f-3577f640ad0c\" or \"b4bddae8-ab25-483e-8670-df09b9f1d0ea\" or \"b669c6ea-1adf-453f-b8bc-6d526592b419\" or \n \"b6e69c34-5f1f-4c34-8cdf-7fea120b8670\" or \"bb2a2e3a-c5e7-4f0a-88e0-8e01fd3fc1f4\" or \"bdd48c81-3a58-4ea9-849c-ebea7f6b6360\" or \n \"c1c74fed-04c9-4704-80dc-9f79a2e515cb\" or \"c35cb2ba-f88b-4d15-aa9d-37bd443522e1\" or \"c44b4083-3bb0-49c1-b47d-974e53cbdf3c\" or \n \"c9a559d2-7aab-4f13-a6ed-e7e9c52aec87\" or \"cc15fd57-2c6c-4117-a88c-83b1d56b4bbe\" or \"cf36b471-5b44-428c-9ce7-313bf84528de\" or \n \"cf53fce8-def6-4aeb-8d30-b158e7b1cf83\" or \"d176f6e7-38e5-40c9-8a78-3998aab820e7\" or \"d3590ed6-52b3-4102-aeff-aad2292ab01c\" or \n \"d73f4b35-55c9-48c7-8b10-651f6f2acb2e\" or \"d9b8ec3a-1e4e-4e08-b3c2-5baf00c0fcb0\" or \"de8bc8b5-d9f9-48b1-a8ad-b748da725064\" or \n \"dfe74da8-9279-44ec-8fb2-2aed9e1c73d0\" or \"e1ef36fd-b883-4dbf-97f0-9ece4b576fc6\" or \"e64aa8bc-8eb4-40e2-898b-cf261a25954f\" or \n \"e9f49c6b-5ce5-44c8-925d-015017e9f7ad\" or \"ee272b19-4411-433f-8f28-5c13cb6fd407\" or \"f5eaa862-7f08-448c-9c4e-f4047d4d4521\" or \n \"fb78d390-0c51-40cd-8e17-fdbfab77341b\" or \"fc0f3af4-6835-4174-b806-f7db311fd2f3\" or \"fdf9885b-dd37-42bf-82e5-c3129ef5a302\" or \n \"9199bf20-a13f-4107-85dc-02114787ef48\"\n)", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_abnormal_clientappid.toml"}
{"title": "Microsoft 365 OAuth Phishing via Visual Studio Code Client", "description": "Detects potentially suspicious OAuth authorization activity in Microsoft 365 where the Visual Studio Code first-party\napplication (client_id = aebc6443-996d-45c2-90f0-388ff96faa56) is used to request access to Microsoft Graph resources.\nWhile this client ID is legitimately used by Visual Studio Code, threat actors have been observed abusing it in phishing\ncampaigns to make OAuth requests appear trustworthy. These attacks rely on redirect URIs such as VSCode Insiders\nredirect location, prompting victims to return an OAuth authorization code that can be exchanged for access tokens. This\nrule may help identify unauthorized use of the VS Code OAuth flow as part of social engineering or credential phishing\nactivity.", "query": "event.dataset: \"o365.audit\"\n    and event.action: \"UserLoggedIn\"\n    and o365.audit.ApplicationId: \"aebc6443-996d-45c2-90f0-388ff96faa56\"\n    and o365.audit.Target.ID: \"00000003-0000-0000-c000-000000000000\"\n    and o365.audit.ExtendedProperties.RequestType: \"OAuth2:Authorize\"\n    and o365.audit.ExtendedProperties.ResultStatusDetail: \"Redirect\"\n    and o365.audit.UserType: (\"0\" or \"2\" or \"3\" or \"5\" or \"6\" or \"10\")", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_entra_oauth_phishing_via_vscode_client.toml"}
{"title": "Microsoft 365 Exchange Anti-Phish Policy Deletion", "description": "Identifies the deletion of an anti-phishing policy in Microsoft 365. By default, Microsoft 365 includes built-in\nfeatures that help protect users from phishing attacks. Anti-phishing polices increase this protection by refining\nsettings to better detect and prevent attacks.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-AntiPhishPolicy\" and event.outcome:success", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_exchange_anti_phish_policy_deletion.toml"}
{"title": "Microsoft 365 Exchange Anti-Phish Rule Modification", "description": "Identifies the modification of an anti-phishing rule in Microsoft 365. By default, Microsoft 365 includes built-in\nfeatures that help protect users from phishing attacks. Anti-phishing rules increase this protection by refining\nsettings to better detect and prevent attacks.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-AntiPhishRule\" or \"Disable-AntiPhishRule\") and event.outcome:success", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_exchange_anti_phish_rule_mod.toml"}
{"title": "Microsoft 365 Exchange Safe Link Policy Disabled", "description": "Identifies when a Safe Link policy is disabled in Microsoft 365. Safe Link policies for Office applications extend\nphishing protection to documents that contain hyperlinks, even after they have been delivered to a user.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Disable-SafeLinksRule\" and event.outcome:success", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_exchange_safelinks_disabled.toml"}
{"title": "Microsoft 365 Illicit Consent Grant via Registered Application", "description": "Identifies an Microsoft 365 illicit consent grant request on-behalf-of a registered Entra ID application. Adversaries\nmay create and register an application in Microsoft Entra ID for the purpose of requesting user consent to access\nresources in Microsoft 365. This is accomplished by tricking a user into granting consent to the application, typically\nvia a pre-made phishing URL. This establishes an OAuth grant that allows the malicious client applocation to access\nresources in Microsoft 365 on-behalf-of the user.", "query": "event.dataset: \"o365.audit\"\n  and o365.audit.Actor.Type: 5\n  and event.action: \"Consent to application.\"\n  and event.outcome: \"success\"\n  and o365.audit.Target.Type: (0 or 2 or 3 or 9 or 10)", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_illicit_consent_grant_via_registered_application.toml"}
{"title": "Microsoft 365 Impossible travel activity", "description": "Identifies when a Microsoft Cloud App Security reported a risky sign-in attempt due to a login associated with an\nimpossible travel.", "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"Impossible travel activity\" and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_impossible_travel_activity.toml"}
{"title": "Microsoft 365 Portal Logins from Impossible Travel Locations", "description": "Detects successful Microsoft 365 portal logins from impossible travel locations. Impossible travel locations are defined\nas two different countries within a short time frame. This behavior may indicate an adversary attempting to access a\nMicrosoft 365 account from a compromised account or a malicious actor attempting to access a Microsoft 365 account from\na different location.", "query": "event.dataset: \"o365.audit\"\n    and event.provider: \"AzureActiveDirectory\"\n    and event.action: \"UserLoggedIn\"\n    and event.outcome: \"success\"\n    and not o365.audit.UserId: \"Not Available\"\n    and o365.audit.Target.Type: (\"0\" or \"2\" or \"3\" or \"5\" or \"6\" or \"10\")", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_impossible_travel_portal_logins.toml"}
{"title": "Microsoft 365 Portal Login from Rare Location", "description": "Detects successful Microsoft 365 portal logins from rare locations. Rare locations are defined as locations that are not\ncommonly associated with the user's account. This behavior may indicate an adversary attempting to access a Microsoft\n365 account from an unusual location or behind a VPN.", "query": "event.dataset: \"o365.audit\"\n    and event.provider: \"AzureActiveDirectory\"\n    and event.action: \"UserLoggedIn\"\n    and event.outcome: \"success\"\n    and not o365.audit.UserId: \"Not Available\"\n    and o365.audit.Target.Type: (\"0\" or \"2\" or \"3\" or \"5\" or \"6\" or \"10\")", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_portal_login_from_rare_location.toml"}
{"title": "Microsoft 365 User Restricted from Sending Email", "description": "Identifies when a user has been restricted from sending email due to exceeding sending limits of the service policies\nper the Security Compliance Center.", "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.category:web and event.action:\"User restricted from sending email\" and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_microsoft_365_user_restricted_from_sending_email.toml"}
{"title": "O365 Email Reported by User as Malware or Phish", "description": "Detects the occurrence of emails reported as Phishing or Malware by Users. Security Awareness training is essential to\nstay ahead of scammers and threat actors, as security products can be bypassed, and the user can still receive a\nmalicious message. Educating users to report suspicious messages can help identify gaps in security controls and prevent\nmalware infections and Business Email Compromise attacks.", "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.action:AlertTriggered and rule.name:\"Email reported by user as malware or phish\"", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_o365_user_reported_phish_malware.toml"}
{"title": "OneDrive Malware File Upload", "description": "Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers\ncan use File Sharing and Organization Repositories to spread laterally within the company and amplify their access.\nUsers can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain\ninitial access to other endpoints in the environment.", "query": "event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected", "tactic": "Lateral Movement", "technique": "Taint Shared Content", "technique_id": "T1080", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_malware_uploaded_onedrive.toml"}
{"title": "SharePoint Malware File Upload", "description": "Identifies the occurence of files uploaded to SharePoint being detected as Malware by the file scanning engine.\nAttackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their\naccess. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunities\nto gain initial access to other endpoints in the environment.", "query": "event.dataset:o365.audit and event.provider:SharePoint and event.code:SharePointFileOperation and event.action:FileMalwareDetected", "tactic": "Lateral Movement", "technique": "Taint Shared Content", "technique_id": "T1080", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_malware_uploaded_sharepoint.toml"}
{"title": "Suspicious Mailbox Permission Delegation in Exchange Online", "description": "Identifies the assignment of rights to access content from another mailbox. An adversary may use the compromised account\nto send messages to other accounts in the network of the target organization while creating inbox rules, so messages can\nevade spam/phishing detection mechanisms.", "query": "event.dataset: \"o365.audit\" and\nevent.provider: \"Exchange\" and\nevent.outcome: \"success\" and\nnot o365.audit.UserType : (3 or 4) and\n(\n    (event.action: \"Add-MailboxPermission\" and o365.audit.Parameters.AccessRights: \"FullAccess\") or\n    (event.action: \"Add-RecipientPermission\" and o365.audit.Parameters.AccessRights: \"SendAs\") or\n    (event.action: \"Set-Mailbox\" and o365.audit.Parameters.GrantSendOnBehalfTo: *)\n) and\nnot user.id:(\n    \"NT AUTHORITY\\SYSTEM (Microsoft.Exchange.ServiceHost)\" or\n    \"NT AUTHORITY\\SYSTEM (Microsoft.Exchange.AdminApi.NetCore)\" or\n    \"NT AUTHORITY\\SYSTEM (w3wp)\"\n    )", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_exchange_suspicious_mailbox_permission_delegation.toml"}
{"title": "Microsoft 365 Exchange DKIM Signing Configuration Disabled", "description": "Identifies when a DomainKeys Identified Mail (DKIM) signing configuration is disabled in Microsoft 365. With DKIM in\nMicrosoft 365, messages that are sent from Exchange Online will be cryptographically signed. This will allow the\nreceiving email system to validate that the messages were generated by a server that the organization authorized and\nwere not spoofed.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Set-DkimSigningConfig\" and o365.audit.Parameters.Enabled:False and event.outcome:success", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_microsoft_365_exchange_dkim_signing_config_disabled.toml"}
{"title": "Microsoft 365 Exchange Management Group Role Assignment", "description": "Identifies when a new role is assigned to a management group in Microsoft 365. An adversary may attempt to add a role in\norder to maintain persistence in an environment.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"New-ManagementRoleAssignment\" and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_microsoft_365_exchange_management_role_assignment.toml"}
{"title": "Microsoft 365 Global Administrator Role Assigned", "description": "In Microsoft Entra ID, permissions to manage resources are assigned using roles. The Global Administrator / Company Administrator\nis a role that enables users to have access to all administrative features in Entra ID and services that use Entra ID\nidentities like the Microsoft 365 Defender portal, the Microsoft 365 compliance center, Exchange, SharePoint Online, and\nSkype for Business Online. Adversaries can add users as Global Administrators to maintain access and manage all\nsubscriptions and their settings and resources.", "query": "event.dataset:o365.audit\n    and event.code:\"AzureActiveDirectory\"\n    and event.action:\"Add member to role.\"\n    and event.outcome: \"success\"\n    and o365.audit.ModifiedProperties.Role_DisplayName.NewValue: (\n        \"Global Administrator\" or \"Company Administrator\"\n    )\n    and o365.audit.AzureActiveDirectoryEventType: 1\n    and o365.audit.RecordType: 8\n    and not o365.audit.Target.Type: (4 or 5 or 6)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_microsoft_365_global_administrator_role_assign.toml"}
{"title": "Microsoft 365 Teams Custom Application Interaction Allowed", "description": "Identifies when custom applications are allowed in Microsoft Teams. If an organization requires applications other than\nthose available in the Teams app store, custom applications can be developed as packages and uploaded. An adversary may\nabuse this behavior to establish persistence in an environment.", "query": "event.dataset:o365.audit and event.provider:MicrosoftTeams and\nevent.category:web and event.action:TeamsTenantSettingChanged and\no365.audit.Name:\"Allow sideloading and interaction of custom apps\" and\no365.audit.NewValue:True and event.outcome:success", "tactic": "Persistence", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_microsoft_365_teams_custom_app_interaction_allowed.toml"}
{"title": "Microsoft 365 Teams External Access Enabled", "description": "Identifies when external access is enabled in Microsoft Teams. External access lets Teams and Skype for Business users\ncommunicate with other users that are outside their organization. An adversary may enable external access or add an\nallowed domain to exfiltrate data or maintain persistence in an environment.", "query": "event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and\nevent.category:web and event.action:\"Set-CsTenantFederationConfiguration\" and\no365.audit.Parameters.AllowFederatedUsers:True and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_microsoft_365_teams_external_access_enabled.toml"}
{"title": "Microsoft 365 Teams Guest Access Enabled", "description": "Identifies when guest access is enabled in Microsoft Teams. Guest access in Teams allows people outside the organization\nto access teams and channels. An adversary may enable guest access to maintain persistence in an environment.", "query": "event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and\nevent.category:web and event.action:\"Set-CsTeamsClientConfiguration\" and\no365.audit.Parameters.AllowGuestUser:True and event.outcome:success", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_microsoft_365_teams_guest_access_enabled.toml"}
{"title": "New or Modified Federation Domain", "description": "Identifies a new or modified federation domain, which can be used to create a trust between O365 and an external\nidentity provider.", "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Set-AcceptedDomain\" or\n\"Set-MsolDomainFederationSettings\" or \"Add-FederatedDomain\" or \"New-AcceptedDomain\" or \"Remove-AcceptedDomain\" or \"Remove-FederatedDomain\") and\nevent.outcome:success", "tactic": "Privilege Escalation", "technique": "Domain or Tenant Policy Modification", "technique_id": "T1484", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_new_or_modified_federation_domain.toml"}
{"title": "Attempted Bypass of Okta MFA", "description": "Detects attempts to bypass Okta multi-factor authentication (MFA). An adversary may attempt to bypass the Okta MFA\npolicies configured for an organization in order to obtain unauthorized access to an application.", "query": "event.dataset:okta.system and event.action:user.mfa.attempt_bypass", "tactic": "Credential Access", "technique": "Multi-Factor Authentication Interception", "technique_id": "T1111", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_attempted_bypass_of_okta_mfa.toml"}
{"title": "Attempts to Brute Force an Okta User Account", "description": "Identifies when an Okta user account is locked out 3 times within a 3 hour window. An adversary may attempt a brute\nforce or password spraying attack to obtain unauthorized access to user accounts. The default Okta authentication policy\nensures that a user account is locked out after 10 failed authentication attempts.", "query": "event.dataset:okta.system and event.action:user.account.lock", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_attempts_to_brute_force_okta_user_account.toml"}
{"title": "Multiple Okta User Auth Events with Same Device Token Hash Behind a Proxy", "description": "Detects when Okta user authentication events are reported for multiple users with the same device token hash behind a\nproxy.", "query": "event.dataset:okta.system\n    and not okta.actor.id:okta* and okta.debug_context.debug_data.dt_hash:*\n    and okta.event_type:user.authentication* and okta.security_context.is_proxy:true", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_multiple_auth_events_from_single_device_behind_proxy.toml"}
{"title": "Multiple Device Token Hashes for Single Okta Session", "description": "This rule detects when a specific Okta actor has multiple device token hashes for a single Okta session. This may\nindicate an authenticated session has been hijacked or is being used by multiple devices. Adversaries may hijack a\nsession to gain unauthorized access to Okta admin console, applications, tenants, or other resources.", "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    // ignore authentication events where session and device token hash change often\n    AND NOT event.action IN (\n        \"policy.evaluate_sign_on\",\n        \"user.session.start\",\n        \"user.authentication.sso\"\n    )\n    // ignore Okta system events and only allow registered users\n    AND (\n        okta.actor.alternate_id != \"system@okta.com\"\n        AND okta.actor.alternate_id RLIKE \"[^@\\\\s]+\\\\@[^@\\\\s]+\"\n    )\n    AND okta.authentication_context.external_session_id != \"unknown\"\n| KEEP event.action, okta.actor.alternate_id, okta.authentication_context.external_session_id, okta.debug_context.debug_data.dt_hash\n| STATS\n    dt_hash_counts = COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash) BY\n        okta.actor.alternate_id,\n        okta.authentication_context.external_session_id\n| WHERE\n    dt_hash_counts >= 2\n| SORT\n    dt_hash_counts DESC", "tactic": "Credential Access", "technique": "Steal Web Session Cookie", "technique_id": "T1539", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_multiple_device_token_hashes_for_single_okta_session.toml"}
{"title": "Multiple Okta User Authentication Events with Client Address", "description": "Detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.", "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action == \"user.session.start\" OR event.action RLIKE \"user\\\\.authentication(.*)\")\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP okta.client.ip, okta.actor.alternate_id, okta.actor.id, event.action, okta.outcome.reason\n| STATS\n    source_auth_count = COUNT_DISTINCT(okta.actor.id)\n    BY okta.client.ip, okta.actor.alternate_id\n| WHERE\n    source_auth_count > 5\n| SORT\n    source_auth_count DESC", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_okta_authentication_for_multiple_users_from_single_source.toml"}
{"title": "Multiple Okta User Authentication Events with Same Device Token Hash", "description": "Detects when a high number of Okta user authentication events are reported for multiple users in a short time frame. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.", "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.debug_context.debug_data.dt_hash != \"-\"\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP event.action, okta.debug_context.debug_data.dt_hash, okta.actor.id, okta.actor.alternate_id, okta.outcome.reason\n| STATS\n    target_auth_count = COUNT_DISTINCT(okta.actor.id)\n    BY okta.debug_context.debug_data.dt_hash, okta.actor.alternate_id\n| WHERE\n    target_auth_count > 20\n| SORT\n    target_auth_count DESC", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_okta_authentication_for_multiple_users_with_the_same_device_token_hash.toml"}
{"title": "Okta Brute Force or Password Spraying Attack", "description": "Identifies a high number of failed Okta user authentication attempts from a single IP address, which could be indicative\nof a brute force or password spraying attack. An adversary may attempt a brute force or password spraying attack to\nobtain unauthorized access to user accounts.", "query": "event.dataset:okta.system and event.category:authentication and event.outcome:failure", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_okta_brute_force_or_password_spraying.toml"}
{"title": "Potential Okta MFA Bombing via Push Notifications", "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the\nuser eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured\nfor an organization to obtain unauthorized access.", "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\"\n    and okta.event_type == \"user.mfa.okta_verify.deny_push\"] with runs=5\n  until [authentication where event.dataset == \"okta.system\"\n    and (okta.event_type: (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]", "tactic": "Credential Access", "technique": "Multi-Factor Authentication Request Generation", "technique_id": "T1621", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_okta_mfa_bombing_via_push_notifications.toml"}
{"title": "High Number of Okta Device Token Cookies Generated for Authentication", "description": "Detects when an Okta client address has a certain threshold of Okta user authentication events with multiple device token hashes generated for single user authentication. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.", "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.debug_context.debug_data.request_uri == \"/api/v1/authn\"\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP event.action, okta.debug_context.debug_data.dt_hash, okta.client.ip, okta.actor.alternate_id, okta.debug_context.debug_data.request_uri, okta.outcome.reason\n| STATS\n    source_auth_count = COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash)\n    BY okta.client.ip, okta.actor.alternate_id\n| WHERE\n    source_auth_count >= 30\n| SORT\n    source_auth_count DESC", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_okta_multiple_device_token_hashes_for_single_user.toml"}
{"title": "Potentially Successful MFA Bombing via Push Notifications", "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the\nuser eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured\nfor an organization to obtain unauthorized access.", "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and event.action == \"user.mfa.okta_verify.deny_push\"] with runs=3\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and (event.action : (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]", "tactic": "Credential Access", "technique": "Multi-Factor Authentication Request Generation", "technique_id": "T1621", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_okta_potentially_successful_okta_bombing_via_push_notifications.toml"}
{"title": "Okta User Session Impersonation", "description": "A user has initiated a session impersonation granting them access to the environment with the permissions of the user\nthey are impersonating. This would likely indicate Okta administrative access and should only ever occur if requested\nand expected.", "query": "event.dataset:okta.system and event.action:user.session.impersonation.initiate", "tactic": "Credential Access", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_user_impersonation_access.toml"}
{"title": "Attempt to Deactivate an Okta Network Zone", "description": "Detects attempts to deactivate an Okta network zone. Okta network zones can be configured to limit or restrict access to\na network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta\nnetwork zone in order to remove or weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:zone.deactivate", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_to_deactivate_okta_network_zone.toml"}
{"title": "Attempt to Delete an Okta Network Zone", "description": "Detects attempts to delete an Okta network zone. Okta network zones can be configured to limit or restrict access to a\nnetwork based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network\nzone in order to remove or weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:zone.delete", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_to_delete_okta_network_zone.toml"}
{"title": "Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials", "description": "Identifies a failed OAuth 2.0 token grant attempt for a public client app using client credentials. This event is\ngenerated when a public client app attempts to exchange a client credentials grant for an OAuth 2.0 access token, but\nthe request is denied due to the lack of required scopes. This could indicate compromised client credentials in which an\nadversary is attempting to obtain an access token for unauthorized scopes. This is a [New\nTerms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule where the\n`okta.actor.display_name` field value has not been seen in the last 14 days regarding this event.", "query": "event.dataset: okta.system\n    and event.action: \"app.oauth2.as.token.grant\"\n    and okta.actor.type: \"PublicClientApp\"\n    and okta.debug_context.debug_data.flattened.grantType: \"client_credentials\"\n    and okta.outcome.result: \"FAILURE\"\n    and not okta.client.user_agent.raw_user_agent: \"Okta-Integrations\"\n    and not okta.actor.display_name: (Okta* or Datadog)\n    and not okta.debug_context.debug_data.flattened.requestedScopes: (\"okta.logs.read\" or \"okta.eventHooks.read\" or \"okta.inlineHooks.read\")\n    and okta.outcome.reason: \"no_matching_scope\"", "tactic": "Defense Evasion", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_first_occurence_public_app_client_credential_token_exchange.toml"}
{"title": "Attempt to Deactivate an Okta Policy", "description": "Detects attempts to deactivate an Okta policy. An adversary may attempt to deactivate an Okta policy in order to weaken\nan organization's security controls. For example, an adversary may attempt to deactivate an Okta multi-factor\nauthentication (MFA) policy in order to weaken the authentication requirements for user accounts.", "query": "event.dataset:okta.system and event.action:policy.lifecycle.deactivate", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_deactivate_okta_policy.toml"}
{"title": "Attempt to Deactivate an Okta Policy Rule", "description": "Detects attempts to deactivate a rule within an Okta policy. An adversary may attempt to deactivate a rule within an\nOkta policy in order to remove or weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:policy.rule.deactivate", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_deactivate_okta_policy_rule.toml"}
{"title": "Attempt to Delete an Okta Policy", "description": "Detects attempts to delete an Okta policy. An adversary may attempt to delete an Okta policy in order to weaken an\norganization's security controls. For example, an adversary may attempt to delete an Okta multi-factor authentication\n(MFA) policy in order to weaken the authentication requirements for user accounts.", "query": "event.dataset:okta.system and event.action:policy.lifecycle.delete", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_delete_okta_policy.toml"}
{"title": "Attempt to Delete an Okta Policy Rule", "description": "Detects attempts to delete a rule within an Okta policy. An adversary may attempt to delete an Okta policy rule in order\nto weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:policy.rule.delete", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_delete_okta_policy_rule.toml"}
{"title": "Attempt to Modify an Okta Network Zone", "description": "Detects attempts to modify an Okta network zone. Okta network zones can be configured to limit or restrict access to a\nnetwork based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network\nzone in order to remove or weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:(zone.update or network_zone.rule.disabled or zone.remove_blacklist)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_modify_okta_network_zone.toml"}
{"title": "Attempt to Modify an Okta Policy", "description": "Detects attempts to modify an Okta policy. An adversary may attempt to modify an Okta policy in order to weaken an\norganization's security controls. For example, an adversary may attempt to modify an Okta multi-factor authentication\n(MFA) policy in order to weaken the authentication requirements for user accounts.", "query": "event.dataset:okta.system and event.action:policy.lifecycle.update", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_modify_okta_policy.toml"}
{"title": "Attempt to Modify an Okta Policy Rule", "description": "Detects attempts to modify a rule within an Okta policy. An adversary may attempt to modify an Okta policy rule in order\nto weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:policy.rule.update", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_okta_attempt_to_modify_okta_policy_rule.toml"}
{"title": "High Number of Okta User Password Reset or Unlock Attempts", "description": "Identifies a high number of Okta user password reset or account unlock attempts. An adversary may attempt to obtain\nunauthorized access to Okta user accounts using these methods and attempt to blend in with normal activity in their\ntarget's environment and evade detection.", "query": "event.dataset:okta.system and\n  event.action:(system.email.account_unlock.sent_message or system.email.password_reset.sent_message or\n                system.sms.send_account_unlock_message or system.sms.send_password_reset_message or\n                system.voice.send_account_unlock_call or system.voice.send_password_reset_call or\n                user.account.unlock_token)", "tactic": "Defense Evasion", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_okta_user_password_reset_or_unlock_attempts.toml"}
{"title": "Attempt to Revoke Okta API Token", "description": "Identifies attempts to revoke an Okta API token. An adversary may attempt to revoke or delete an Okta API token to\ndisrupt an organization's business operations.", "query": "event.dataset:okta.system and event.action:system.api_token.revoke", "tactic": "Impact", "technique": "Account Access Removal", "technique_id": "T1531", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_attempt_to_revoke_okta_api_token.toml"}
{"title": "Attempt to Deactivate an Okta Application", "description": "Detects attempts to deactivate an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta\napplication in order to weaken an organization's security controls or disrupt their business operations.", "query": "event.dataset:okta.system and event.action:application.lifecycle.deactivate", "tactic": "Impact", "technique": "Service Stop", "technique_id": "T1489", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_okta_attempt_to_deactivate_okta_application.toml"}
{"title": "Attempt to Delete an Okta Application", "description": "Detects attempts to delete an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta\napplication in order to weaken an organization's security controls or disrupt their business operations.", "query": "event.dataset:okta.system and event.action:application.lifecycle.delete", "tactic": "Impact", "technique": "Service Stop", "technique_id": "T1489", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_okta_attempt_to_delete_okta_application.toml"}
{"title": "Attempt to Modify an Okta Application", "description": "Detects attempts to modify an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta\napplication in order to weaken an organization's security controls or disrupt their business operations.", "query": "event.dataset:okta.system and event.action:application.lifecycle.update", "tactic": "Impact", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_okta_attempt_to_modify_okta_application.toml"}
{"title": "Possible Okta DoS Attack", "description": "Detects possible Denial of Service (DoS) attacks against an Okta organization. An adversary may attempt to disrupt an\norganization's business operations by performing a DoS attack against its Okta service.", "query": "event.dataset:okta.system and event.action:(application.integration.rate_limit_exceeded or system.org.rate_limit.warning or system.org.rate_limit.violation or core.concurrency.org.limit.violation)", "tactic": "Impact", "technique": "Network Denial of Service", "technique_id": "T1498", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_possible_okta_dos_attack.toml"}
{"title": "First Occurrence of Okta User Session Started via Proxy", "description": "Identifies the first occurrence of an Okta user session started via a proxy.", "query": "event.dataset:okta.system and okta.event_type: (user.session.start or user.authentication.verify) and okta.security_context.is_proxy:true and not okta.actor.id: okta*", "tactic": "Initial Access", "technique": "External Remote Services", "technique_id": "T1133", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_first_occurrence_user_session_started_via_proxy.toml"}
{"title": "New Okta Authentication Behavior Detected", "description": "Detects events where Okta behavior detection has identified a new authentication behavior.", "query": "event.dataset:okta.system and okta.debug_context.debug_data.risk_behaviors:*", "tactic": "Initial Access", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_new_authentication_behavior_detection.toml"}
{"title": "Okta FastPass Phishing Detection", "description": "Detects when Okta FastPass prevents a user from authenticating to a phishing website.", "query": "event.dataset:okta.system and event.category:authentication and\n  okta.event_type:user.authentication.auth_via_mfa and event.outcome:failure and okta.outcome.reason:\"FastPass declined phishing attempt\"", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_okta_fastpass_phishing.toml"}
{"title": "Unauthorized Access to an Okta Application", "description": "Identifies unauthorized access attempts to Okta applications.", "query": "event.dataset:okta.system and event.action:app.generic.unauth_app_access_attempt", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_okta_user_attempted_unauthorized_access.toml"}
{"title": "Okta User Sessions Started from Different Geolocations", "description": "Detects when a specific Okta actor has multiple sessions started from different geolocations. Adversaries may attempt to\nlaunch an attack by using a list of known usernames and passwords to gain unauthorized access to user accounts from\ndifferent locations.", "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.security_context.is_proxy != true and okta.actor.id != \"unknown\"\n    AND event.outcome == \"success\"\n| KEEP event.action, okta.security_context.is_proxy, okta.actor.id, event.outcome, client.geo.country_name, okta.actor.alternate_id\n| STATS\n    geo_auth_counts = COUNT_DISTINCT(client.geo.country_name)\n    BY okta.actor.id, okta.actor.alternate_id\n| WHERE\n    geo_auth_counts >= 2", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_okta_user_sessions_started_from_different_geolocations.toml"}
{"title": "Okta Sign-In Events via Third-Party IdP", "description": "Detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).", "query": "event.dataset:okta.system and okta.debug_context.debug_data.request_uri:/oauth2/v1/authorize/callback and\n    (not okta.authentication_context.issuer.id:Okta and event.action:(user.authentication.auth_via_IDP\n        or user.authentication.auth_via_inbound_SAML\n        or user.authentication.auth_via_mfa\n        or user.authentication.auth_via_social)\n        or event.action:user.session.start) or\n    (event.action:user.authentication.auth_via_IDP and okta.outcome.result:FAILURE\n        and okta.outcome.reason:(\"A SAML assert with the same ID has already been processed by Okta for a previous request\"\n            or \"Unable to match transformed username\"\n            or \"Unable to resolve IdP endpoint\"\n            or \"Unable to validate SAML Response\"\n            or \"Unable to validate incoming SAML Assertion\"))", "tactic": "Initial Access", "technique": "Trusted Relationship", "technique_id": "T1199", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_sign_in_events_via_third_party_idp.toml"}
{"title": "Successful Application SSO from Rare Unknown Client Device", "description": "Detects successful single sign-on (SSO) events to Okta applications from an unrecognized or \"unknown\" client device, as\nidentified by the user-agent string. This activity may be indicative of exploitation of a vulnerability in Okta's\nClassic Engine, which could allow an attacker to bypass application-specific sign-on policies, such as device or network\nrestrictions. The vulnerability potentially enables unauthorized access to applications using only valid, stolen\ncredentials, without requiring additional authentication factors.", "query": "event.dataset: \"okta.system\"\n    and event.action: \"user.authentication.sso\"\n    and event.outcome: \"success\"\n    and okta.client.device: (\"Unknown\" or \"unknown\")", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_successful_application_sso_from_unknown_client_device.toml"}
{"title": "Suspicious Activity Reported by Okta User", "description": "Detects when a user reports suspicious activity for their Okta account. These events should be investigated, as they can\nhelp security teams identify when an adversary is attempting to gain access to their network.", "query": "event.dataset:okta.system and event.action:user.account.report_suspicious_activity_by_enduser", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_activity_reported_by_okta_user.toml"}
{"title": "Multiple Okta Sessions Detected for a Single User", "description": "Detects when a user has started multiple Okta sessions with the same user account and different session IDs. This may\nindicate that an attacker has stolen the user's session cookie and is using it to access the user's account from a\ndifferent location.", "query": "event.dataset:okta.system\n    and okta.event_type:user.session.start\n    and okta.authentication_context.external_session_id:*\n    and not (okta.actor.id: okta* or okta.actor.display_name: okta*)", "tactic": "Lateral Movement", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_multiple_sessions_for_single_user.toml"}
{"title": "Okta ThreatInsight Threat Suspected Promotion", "description": "Okta ThreatInsight is a feature that provides valuable debug data regarding authentication and authorization processes,\nwhich is logged in the system. Within this data, there is a specific field called threat_suspected, which represents\nOkta's internal evaluation of the authentication or authorization workflow. When this field is set to True, it suggests\nthe presence of potential credential access techniques, such as password-spraying, brute-forcing, replay attacks, and\nother similar threats.", "query": "event.dataset:okta.system and (event.action:security.threat.detected or okta.debug_context.debug_data.threat_suspected: true)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "okta_threatinsight_threat_suspected_promotion.toml"}
{"title": "Administrator Privileges Assigned to an Okta Group", "description": "Detects when an administrator role is assigned to an Okta group. An adversary may attempt to assign administrator\nprivileges to an Okta group in order to assign additional permissions to compromised user accounts and maintain access\nto their target organization.", "query": "event.dataset:okta.system and event.action:group.privilege.grant", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_administrator_privileges_assigned_to_okta_group.toml"}
{"title": "Administrator Role Assigned to an Okta User", "description": "Identifies when an administrator role is assigned to an Okta user. An adversary may attempt to assign an administrator\nrole to an Okta user in order to assign additional permissions to a user account and maintain access to their target's\nenvironment.", "query": "event.dataset:okta.system and event.action:user.account.privilege.grant", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_administrator_role_assigned_to_okta_user.toml"}
{"title": "Attempt to Create Okta API Token", "description": "Detects attempts to create an Okta API token. An adversary may create an Okta API token to maintain access to an\norganization's network while they work to achieve their objectives. An attacker may abuse an API token to execute\ntechniques such as creating user accounts or disabling security rules or policies.", "query": "event.dataset:okta.system and event.action:system.api_token.create", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_attempt_to_create_okta_api_token.toml"}
{"title": "Attempt to Reset MFA Factors for an Okta User Account", "description": "Detects attempts to reset an Okta user's enrolled multi-factor authentication (MFA) factors. An adversary may attempt to\nreset the MFA factors for an Okta user's account in order to register new MFA factors and abuse the account to blend in\nwith normal activity in the victim's environment.", "query": "event.dataset:okta.system and event.action:user.mfa.factor.reset_all", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_attempt_to_reset_mfa_factors_for_okta_user_account.toml"}
{"title": "MFA Deactivation with no Re-Activation for Okta User Account", "description": "Detects multi-factor authentication (MFA) deactivation with no subsequent re-activation for an Okta user account. An\nadversary may deactivate MFA for an Okta user account in order to weaken the authentication requirements for the\naccount.", "query": "sequence by okta.actor.id with maxspan=12h\n    [any where event.dataset == \"okta.system\" and okta.event_type in (\"user.mfa.factor.deactivate\", \"user.mfa.factor.reset_all\")\n        and okta.outcome.reason != \"User reset SECURITY_QUESTION factor\" and okta.outcome.result == \"SUCCESS\"]\n    ![any where event.dataset == \"okta.system\" and okta.event_type == \"user.mfa.factor.activate\"]", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_mfa_deactivation_with_no_reactivation.toml"}
{"title": "New Okta Identity Provider (IdP) Added by Admin", "description": "Detects the creation of a new Identity Provider (IdP) by a Super Administrator or Organization Administrator within\nOkta.", "query": "event.dataset: \"okta.system\" and event.action: \"system.idp.lifecycle.create\" and okta.outcome.result: \"SUCCESS\"", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_new_idp_successfully_added_by_admin.toml"}
{"title": "Modification or Removal of an Okta Application Sign-On Policy", "description": "Detects attempts to modify or delete a sign on policy for an Okta application. An adversary may attempt to modify or\ndelete the sign on policy for an Okta application in order to remove or weaken an organization's security controls.", "query": "event.dataset:okta.system and event.action:(application.policy.sign_on.update or application.policy.sign_on.rule.delete)", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_okta_attempt_to_modify_or_delete_application_sign_on_policy.toml"}
{"title": "Stolen Credentials Used to Login to Okta Account After MFA Reset", "description": "Detects a sequence of suspicious activities on Windows hosts indicative of credential compromise, followed by efforts to\nundermine multi-factor authentication (MFA) and single sign-on (SSO) mechanisms for an Okta user account.", "query": "sequence by user.name with maxspan=12h\n    [any where host.os.type == \"windows\" and signal.rule.threat.tactic.name == \"Credential Access\"]\n    [any where event.dataset == \"okta.system\" and okta.event_type == \"user.mfa.factor.update\"]\n    [any where event.dataset == \"okta.system\" and okta.event_type: (\"user.session.start\", \"user.authentication*\")]", "tactic": "Persistence", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_stolen_credentials_used_to_login_to_okta_account_after_mfa_reset.toml"}
{"title": "Spike in Privileged Command Execution by a User", "description": "A machine learning job has detected an increase in the execution of privileged commands by a user, suggesting potential privileged access activity.\nThis may indicate an attempt by the user to gain unauthorized access to sensitive or restricted parts of the system.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_linux_high_count_privileged_process_events_by_user.toml"}
{"title": "High Command Line Entropy Detected for Privileged Commands", "description": "A machine learning job has identified an unusually high median command line entropy for privileged commands executed by a user, suggesting possible privileged access activity through command lines.\nHigh entropy often indicates that the commands may be obfuscated or deliberately complex, which can be a sign of suspicious or unauthorized use of privileged access.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_linux_high_median_process_command_line_entropy_by_user.toml"}
{"title": "Unusual Process Detected for Privileged Commands by a User", "description": "A machine learning job has detected an unusual process run for privileged commands by a user, indicating potential privileged access activity.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_linux_rare_process_executed_by_user.toml"}
{"title": "Unusual Spike in Concurrent Active Sessions by a User", "description": "A machine learning job has detected an unusually high number of active concurrent sessions initiated by a user, indicating potential privileged access activity.\nA sudden surge in concurrent active sessions by a user may indicate an attempt to abuse valid credentials for privilege escalation or maintain persistence.\nAdversaries might be leveraging multiple sessions to execute privileged operations, evade detection, or perform unauthorized actions across different systems.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_high_sum_concurrent_sessions_by_user.toml"}
{"title": "Unusual Host Name for Okta Privileged Operations Detected", "description": "A machine learning job has identified a user performing privileged operations in Okta from an uncommon device, indicating potential privileged access activity.\nThis could signal a compromised account, an attacker using stolen credentials, or an insider threat leveraging an unauthorized device to escalate privileges.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_rare_host_name_by_user.toml"}
{"title": "Unusual Region Name for Okta Privileged Operations Detected", "description": "A machine learning job has identified a user performing privileged operations in Okta from an uncommon geographical location, indicating potential privileged access activity.\nThis could suggest a compromised account, unauthorized access, or an attacker using stolen credentials to escalate privileges.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_rare_region_name_by_user.toml"}
{"title": "Unusual Source IP for Okta Privileged Operations Detected", "description": "A machine learning job has identified a user performing privileged operations in Okta from an uncommon source IP, indicating potential privileged access activity.\nThis could suggest an account compromise, misuse of administrative privileges, or an attacker leveraging a new network location to escalate privileges.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_rare_source_ip_by_user.toml"}
{"title": "Spike in Group Application Assignment Change Events", "description": "A machine learning job has identified an unusual spike in Okta group application assignment change events, indicating potential privileged access activity.\nThreat actors might be assigning applications to groups to escalate access, maintain persistence, or facilitate lateral movement within an organization\u2019s environment.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_spike_in_group_application_assignment_changes.toml"}
{"title": "Spike in Group Lifecycle Change Events", "description": "A machine learning job has identified an unusual spike in Okta group lifecycle change events, indicating potential privileged access activity.\nAdversaries may be altering group structures to escalate privileges, maintain persistence, or facilitate lateral movement within an organization\u2019s identity management system.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_spike_in_group_lifecycle_changes.toml"}
{"title": "Spike in Group Membership Events", "description": "A machine learning job has identified an unusual spike in Okta group membership events, indicating potential privileged access activity.\nAttackers or malicious insiders might be adding accounts to privileged groups to escalate their access, potentially leading to unauthorized actions or data breaches.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_spike_in_group_membership_changes.toml"}
{"title": "Spike in Group Privilege Change Events", "description": "A machine learning job has identified an unusual spike in Okta group privilege change events, indicating potential privileged access activity.\nAttackers might be elevating privileges by adding themselves or compromised accounts to high-privilege groups, enabling further access or persistence.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_spike_in_group_privilege_changes.toml"}
{"title": "Spike in User Lifecycle Management Change Events", "description": "A machine learning job has identified an unusual spike in Okta user lifecycle management change events, indicating potential privileged access activity.\nThreat actors may manipulate user accounts to gain higher access rights or persist within the environment.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_okta_spike_in_user_lifecycle_management_changes.toml"}
{"title": "Spike in Group Management Events", "description": "A machine learning job has identified a spike in group management events for a user, indicating potential privileged access activity.\nThe machine learning has flagged an abnormal rise in group management actions (such as adding or removing users from privileged groups),\nwhich could point to an attempt to escalate privileges or unauthorized modifications to group memberships.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_high_count_group_management_events.toml"}
{"title": "Spike in Special Logon Events", "description": "A machine learning job has detected a surge in special logon events for a user, indicating potential privileged access activity.\nA sudden spike in these events could suggest an attacker or malicious insider gaining elevated access, possibly for lateral movement or privilege escalation.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_high_count_special_logon_events.toml"}
{"title": "Spike in Special Privilege Use Events", "description": "A machine learning job has detected an unusual increase in special privilege usage events, such as privileged operations and service calls, for a user, suggesting potential unauthorized privileged access.\nA sudden spike in these events may indicate an attempt to escalate privileges, execute unauthorized tasks, or maintain persistence within a system.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_high_count_special_privilege_use_events.toml"}
{"title": "Spike in User Account Management Events", "description": "A machine learning job has identified a spike in user account management events for a user, indicating potential privileged access activity.\nThis indicates an unusual increase in actions related to managing user accounts (such as creating, modifying, or deleting accounts),\nwhich could be a sign of an attempt to escalate privileges or unauthorized activity involving account management.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_high_count_user_account_management_events.toml"}
{"title": "Unusual Host Name for Windows Privileged Operations Detected", "description": "A machine learning job has identified a user performing privileged operations in Windows from an uncommon device, indicating potential privileged access activity.\nThis could signal a compromised account, an attacker using stolen credentials, or an insider threat leveraging an unauthorized device to escalate privileges.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_rare_device_by_user.toml"}
{"title": "Unusual Group Name Accessed by a User", "description": "A machine learning job has detected a user accessing an uncommon group name for privileged operations, indicating potential privileged access activity.\nThis indicates that a user has accessed a group name that is unusual for their typical operations, particularly for actions requiring elevated privileges.\nThis could point to an attempt to manipulate group memberships or escalate privileges on a system.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_rare_group_name_by_user.toml"}
{"title": "Unusual Privilege Type assigned to a User", "description": "A machine learning job has identified a user leveraging an uncommon privilege type for privileged operations, indicating potential privileged access activity.\nThis indicates that a user is performing operations requiring elevated privileges but is using a privilege type that is not typically seen in their baseline logs.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_rare_privilege_assigned_to_user.toml"}
{"title": "Unusual Region Name for Windows Privileged Operations Detected", "description": "A machine learning job has identified a user performing privileged operations in Windows from an uncommon geographical location, indicating potential privileged access activity.\nThis could suggest a compromised account, unauthorized access, or an attacker using stolen credentials to escalate privileges.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_rare_region_name_by_user.toml"}
{"title": "Unusual Source IP for Windows Privileged Operations Detected", "description": "A machine learning job has identified a user performing privileged operations in Windows from an uncommon source IP, indicating potential privileged access activity.\nThis could suggest an account compromise, misuse of administrative privileges, or an attacker leveraging a new network location to escalate privileges.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privileged_access_ml_windows_rare_source_ip_by_user.toml"}
{"title": "Unusual Process Spawned by a Host", "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as suspicious in two\nways. It was predicted to be suspicious by the ProblemChild supervised ML model, and it was found to be an unusual\nprocess, on a host that does not commonly manifest malicious activity. Such a process may be an instance of suspicious\nor malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.", "query": "N/A", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_rare_process_for_a_host.toml"}
{"title": "Unusual Process Spawned by a Parent Process", "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as malicious in two\nways. It was predicted to be malicious by the ProblemChild supervised ML model, and it was found to be an unusual child\nprocess name, for the parent process, by an unsupervised ML model. Such a process may be an instance of suspicious or\nmalicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.", "query": "N/A", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_rare_process_for_a_parent_process.toml"}
{"title": "Unusual Process Spawned by a User", "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as malicious in two\nways. It was predicted to be malicious by the ProblemChild supervised ML model, and it was found to be suspicious given\nthat its user context is unusual and does not commonly manifest malicious activity,by an unsupervised ML model. Such a\nprocess may be an instance of suspicious or malicious activity, possibly involving LOLbins, that may be resistant to\ndetection using conventional search rules.", "query": "N/A", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_rare_process_for_a_user.toml"}
{"title": "Machine Learning Detected a Suspicious Windows Event with a High Malicious Probability Score", "description": "A supervised machine learning model (ProblemChild) has identified a suspicious Windows process event with high\nprobability of it being malicious activity. Alternatively, the model's blocklist identified the event as being\nmalicious.", "query": "process where ((problemchild.prediction == 1 and problemchild.prediction_probability > 0.98) or\nblocklist_label == 1) and not process.args : (\"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.txt*\", \"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.tmp*\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_suspicious_windows_event_high_probability.toml"}
{"title": "Machine Learning Detected a Suspicious Windows Event with a Low Malicious Probability Score", "description": "A supervised machine learning model (ProblemChild) has identified a suspicious Windows process event with low\nprobability of it being malicious activity. Alternatively, the model's blocklist identified the event as being\nmalicious.", "query": "process where ((problemchild.prediction == 1 and problemchild.prediction_probability <= 0.98) or\nblocklist_label == 1) and not process.args : (\"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.txt*\", \"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.tmp*\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_suspicious_windows_event_low_probability.toml"}
{"title": "Host Detected with Suspicious Windows Process(es)", "description": "A machine learning job combination has identified a host with one or more suspicious Windows processes that exhibit\nunusually high malicious probability scores.These process(es) have been classified as malicious in several ways. The\nprocess(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of\nsuspicious processes, each process has the same host name, and the aggregate score of the event cluster was calculated\nto be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity,\npossibly involving LOLbins, that may be resistant to detection using conventional search rules.", "query": "N/A", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_suspicious_windows_process_cluster_from_host.toml"}
{"title": "Parent Process Detected with Suspicious Windows Process(es)", "description": "A machine learning job combination has identified a parent process with one or more suspicious Windows processes that\nexhibit unusually high malicious probability scores. These process(es) have been classified as malicious in several\nways. The process(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a\ncluster of suspicious processes, each process has the same parent process name, and the aggregate score of the event\ncluster was calculated to be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or\nmalicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.", "query": "N/A", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_suspicious_windows_process_cluster_from_parent_process.toml"}
{"title": "User Detected with Suspicious Windows Process(es)", "description": "A machine learning job combination has identified a user with one or more suspicious Windows processes that exhibit\nunusually high malicious probability scores. These process(es) have been classified as malicious in several ways. The\nprocess(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of\nsuspicious processes, each process has the same user name, and the aggregate score of the event cluster was calculated\nto be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity,\npossibly involving LOLbins, that may be resistant to detection using conventional search rules.", "query": "N/A", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ml_suspicious_windows_process_cluster_from_user.toml"}
{"title": "Linux Clipboard Activity Detected", "description": "This rule monitors for the usage of the most common clipboard utilities on unix systems by an uncommon process group\nleader. Adversaries may collect data stored in the clipboard from users copying information within or between\napplications.", "query": "event.category:process and host.os.type:\"linux\" and event.type:\"start\" and\nevent.action:(\"exec\" or \"exec_event\" or \"executed\" or \"process_started\") and\nprocess.name:(\"xclip\" or \"xsel\" or \"wl-clipboard\" or \"clipman\" or \"copyq\") and\nnot process.parent.name:(\"bwrap\" or \"micro\")", "tactic": "Collection", "technique": "Clipboard Data", "technique_id": "T1115", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_linux_clipboard_activity.toml"}
{"title": "AWS CLI Command with Custom Endpoint URL", "description": "Detects the use of the AWS CLI with the `--endpoint-url` argument, which allows users to specify a custom endpoint URL for AWS services. This can be leveraged by adversaries to redirect API requests to non-standard or malicious endpoints, potentially bypassing typical security controls and logging mechanisms. This behavior may indicate an attempt to interact with unauthorized or compromised infrastructure, exfiltrate data, or perform other malicious activities under the guise of legitimate AWS operations.", "query": "host.os.type: \"linux\" and event.category: \"process\" and process.name: \"aws\" and process.args:  \"--endpoint-url\"", "tactic": "Command and Control", "technique": "Web Service", "technique_id": "T1102", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_aws_cli_endpoint_url_used.toml"}
{"title": "Network Activity Detected via cat", "description": "This rule monitors for the execution of the cat command, followed by a connection attempt by the same process. Cat is\ncapable of transfering data via tcp/udp channels by redirecting its read output to a /dev/tcp or /dev/udp channel. This\nactivity is highly suspicious, and should be investigated. Attackers may leverage this capability to transfer tools or\nfiles to another host in the network or exfiltrate data while attempting to evade detection in the process.", "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"cat\" and process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [network where host.os.type == \"linux\" and event.action in (\"connection_attempted\", \"disconnect_received\") and\n   process.name == \"cat\" and not (destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n     )\n   )]", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_cat_network_activity.toml"}
{"title": "Network Connection by Cups or Foomatic-rip Child", "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects network connections initiated by a\nchild processes of foomatic-rip. These flaws impact components like cups-browsed, libcupsfilters, libppd, and\nfoomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted\nUDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.", "query": "sequence by host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"foomatic-rip\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and\n   event.action == \"connection_attempted\"] by process.parent.entity_id", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_cupsd_foomatic_rip_netcon.toml"}
{"title": "Curl SOCKS Proxy Activity from Unusual Parent", "description": "This rule detects the use of the `curl` command-line tool with SOCKS proxy options, launched from an unusual parent\nprocess. Attackers may use `curl` to establish a SOCKS proxy connection to bypass network restrictions and exfiltrate\ndata or communicate with C2 servers.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"curl\" and (\n  process.parent.executable like (\n    \"/dev/shm/*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/run/*\", \"/root/*\", \"/boot/*\", \"/var/www/html/*\", \"/opt/.*\"\n  ) or\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n) and (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or\n  process.args == \"-x\" or\n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n)", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_curl_socks_proxy_detected.toml"}
{"title": "High Number of Egress Network Connections from Unusual Executable", "description": "This rule detects a high number of egress network connections from an unusual executable on a Linux system. This could\nindicate a command and control (C2) communication attempt, a brute force attack via a malware infection, or other\nmalicious activity. ES|QL rules have limited fields available in its alert documents. Make sure to review the original\ndocuments to aid in the investigation of this alert.", "query": "from logs-endpoint.events.network-*\n| keep @timestamp, host.os.type, event.type, event.action, process.name, process.executable, destination.ip, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and (\n     (\n       process.executable like \"/tmp/*\" or\n       process.executable like \"/var/tmp/*\" or\n       process.executable like \"/dev/shm/*\"\n     ) or\n     (process.name like \".*\")\n) and not (\n     CIDR_MATCH(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\",\n       \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\",\n       \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"224.0.0.0/4\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\"\n     ) or\n     process.executable like \"/nix/store/*\" or\n     process.executable like \"/tmp/newroot/*\" or\n     process.executable like \"/tmp/.mount*\" or\n     process.executable like \"/tmp/go-build*\"\n   )\n| stats cc = count(), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.executable\n| where agent_count == 1 and cc > 15\n| sort cc asc\n| limit 100", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_frequent_egress_netcon_from_sus_executable.toml"}
{"title": "Git Repository or File Download to Suspicious Directory", "description": "This rule detects the use of git to clone a repository or download files from GitHub using wget or curl, followed by\nthe creation of files in suspicious directories such as /tmp, /var/tmp, or /dev/shm. This behavior may indicate an\nattempt to download a payload, exploit or tool.", "query": "sequence by process.entity_id, host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n     (process.name == \"git\" and process.args == \"clone\") or\n     (process.name in (\"wget\", \"curl\") and process.command_line like~ \"*github*\")\n  )]\n  [file where host.os.type == \"linux\" and event.type == \"creation\" and file.path like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\")]", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_git_repo_or_file_download_to_sus_dir.toml"}
{"title": "IPv4/IPv6 Forwarding Activity", "description": "This rule monitors for the execution of commands that enable IPv4 and IPv6 forwarding on Linux systems. Enabling IP\nforwarding can be used to route network traffic between different network interfaces, potentially allowing attackers to\npivot between networks, exfiltrate data, or establish command and control channels.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\", \"exec_event\") and\nprocess.parent.executable != null and process.command_line like (\n  \"*net.ipv4.ip_forward*\", \"*/proc/sys/net/ipv4/ip_forward*\", \"*net.ipv6.conf.all.forwarding*\",\n  \"*/proc/sys/net/ipv6/conf/all/forwarding*\"\n) and (\n  (process.name == \"sysctl\" and process.args like (\"*-w*\", \"*--write*\", \"*=*\")) or\n  (\n    process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"-c\" and\n    process.command_line like \"*echo *\"\n  )\n) and\nnot process.parent.name like~ (\"privsep-helper\", \"platform-python*\", \"init.ipv6-global\", \"wsl-bootstrap\")", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ip_forwarding_activity.toml"}
{"title": "Potential Protocol Tunneling via Chisel Client", "description": "This rule monitors for common command line flags leveraged by the Chisel client utility followed by a connection\nattempt. Chisel is a command-line utility used for creating and managing TCP and UDP tunnels, enabling port forwarding\nand secure communication between machines. Attackers can abuse the Chisel utility to establish covert communication\nchannels, bypass network restrictions, and carry out malicious activities by creating tunnels that allow unauthorized\naccess to internal systems.", "query": "sequence by host.id, process.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"client\" and process.args : (\"R*\", \"*:*\", \"*socks*\", \"*.*\") and process.args_count >= 4 and \n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.name in (\"velociraptor\", \"nbemmcmd\", \"redis-cli\", \"ipa\")]\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\")]", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_chisel_client_activity.toml"}
{"title": "Potential Protocol Tunneling via Chisel Server", "description": "This rule monitors for common command line flags leveraged by the Chisel server utility followed by a received\nconnection within a timespan of 1 minute. Chisel is a command-line utility used for creating and managing TCP and UDP\ntunnels, enabling port forwarding and secure communication between machines. Attackers can abuse the Chisel utility to\nestablish covert communication channels, bypass network restrictions, and carry out malicious activities by creating\ntunnels that allow unauthorized access to internal systems.", "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"server\" and process.args in (\"--port\", \"-p\", \"--reverse\", \"--backend\", \"--socks5\") and \n   process.args_count >= 3 and process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_accepted\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\", \"hugo\")]", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_chisel_server_activity.toml"}
{"title": "Network Activity Detected via Kworker", "description": "This rule monitors for network connections from a kworker process. kworker, or kernel worker, processes are part of the\nkernel's workqueue mechanism. They are responsible for executing work that has been scheduled to be done in kernel\nspace, which might include tasks like handling interrupts, background activities, and other kernel-related tasks.\nAttackers may attempt to evade detection by masquerading as a kernel worker process.", "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or connection_accepted) and\nprocess.name:kworker* and not destination.ip:(\n  10.0.0.0/8 or\n  127.0.0.0/8 or\n  169.254.0.0/16 or\n  172.16.0.0/12 or\n  192.168.0.0/16 or\n  224.0.0.0/4 or\n  \"::1\" or\n  \"FE80::/10\" or\n  \"FF00::/8\" or\n  \"0.0.0.0\"\n) and not destination.port:(\"2049\" or \"111\" or \"892\" or \"597\")", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_kworker_netcon.toml"}
{"title": "ProxyChains Activity", "description": "This rule monitors for the execution of the ProxyChains utility. ProxyChains is a command-line tool that enables the\nrouting of network connections through intermediary proxies, enhancing anonymity and enabling access to restricted\nresources. Attackers can exploit the ProxyChains utility to hide their true source IP address, evade detection, and\nperform malicious activities through a chain of proxy servers, potentially masking their identity and intentions.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"proxychains\"", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_proxychains_activity.toml"}
{"title": "Linux SSH X11 Forwarding", "description": "This rule monitors for X11 forwarding via SSH. X11 forwarding is a feature that allows users to run graphical\napplications on a remote server and display the application's graphical user interface on their local machine. Attackers\ncan abuse X11 forwarding for tunneling their GUI-based tools, pivot through compromised systems, and create covert\ncommunication channels, enabling lateral movement and facilitating remote control of systems within a network.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"ssh\", \"sshd\") and process.args in (\"-X\", \"-Y\") and process.args_count >= 3 and\nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_ssh_x11_forwarding.toml"}
{"title": "Suspicious Utility Launched via ProxyChains", "description": "This rule monitors for the execution of suspicious linux tools through ProxyChains. ProxyChains is a command-line tool\nthat enables the routing of network connections through intermediary proxies, enhancing anonymity and enabling access to\nrestricted resources. Attackers can exploit the ProxyChains utility to hide their true source IP address, evade\ndetection, and perform malicious activities through a chain of proxy servers, potentially masking their identity and\nintentions.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"proxychains\" and process.args : (\n  \"ssh\", \"sshd\", \"sshuttle\", \"socat\", \"iodine\", \"iodined\", \"dnscat\", \"hans\", \"hans-ubuntu\", \"ptunnel-ng\",\n  \"ssf\", \"3proxy\", \"ngrok\", \"gost\", \"pivotnacci\", \"chisel*\", \"nmap\", \"ping\", \"python*\", \"php*\", \"perl\", \"ruby\",\n  \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\", \"ftp\", \"curl\", \"wget\"\n)", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_suspicious_proxychains_activity.toml"}
{"title": "Potential Linux Tunneling and/or Port Forwarding", "description": "This rule monitors for a set of Linux utilities that can be used for tunneling and port forwarding. Attackers can\nleverage tunneling and port forwarding techniques to bypass network defenses, establish hidden communication channels,\nand gain unauthorized access to internal resources, facilitating data exfiltration, lateral movement, and remote\ncontrol.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and (\n  (\n    // gost & pivotnacci - spawned without process.parent.name\n    (process.name == \"gost\" and process.args : (\"-L*\", \"-C*\", \"-R*\")) or (process.name == \"pivotnacci\")) or (\n    // ssh\n    (process.name in (\"ssh\", \"sshd\") and (process.args in (\"-R\", \"-L\", \"-D\", \"-w\") and process.args_count >= 4 and \n     not process.args : \"chmod\")) or\n    // sshuttle\n    (process.name == \"sshuttle\" and process.args in (\"-r\", \"--remote\", \"-l\", \"--listen\") and process.args_count >= 4) or\n    // socat\n    (process.name == \"socat\" and process.args : (\"TCP4-LISTEN:*\", \"SOCKS*\") and process.args_count >= 3) or\n    // chisel\n    (process.name : \"chisel*\" and process.args in (\"client\", \"server\")) or\n    // iodine(d), dnscat, hans, ptunnel-ng, ssf, 3proxy & ngrok \n    (process.name in (\"iodine\", \"iodined\", \"dnscat\", \"hans\", \"hans-ubuntu\", \"ptunnel-ng\", \"ssf\", \"3proxy\", \"ngrok\"))\n  ) and process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n)", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_tunneling_and_port_forwarding.toml"}
{"title": "Potential Linux Tunneling and/or Port Forwarding via SSH Option", "description": "This rule detects the use of SSH options that may indicate tunneling or port forwarding on Linux systems. This behavior\nis commonly associated with malicious activity, such as establishing a port forward, proxy or an encrypted tunnel to\nexfiltrate data.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"ssh\", \"sshd\") and process.args == \"-o\" and\nprocess.command_line like~ (\n  \"*ProxyCommand*\", \"*LocalForward*\", \"*RemoteForward*\", \"*DynamicForward*\", \"*Tunnel*\", \"*GatewayPorts*\",\n  \"*ExitOnForwardFailure*\", \"*ProxyCommand*\", \"*ProxyJump*\"\n)", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_linux_tunneling_via_ssh_option.toml"}
{"title": "Suspicious Network Activity to the Internet by Previously Unknown Executable", "description": "This rule monitors for network connectivity to the internet from a previously unknown executable located in a suspicious\ndirectory. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of\nunauthorized or suspicious processes attempting to establish connections to unknown or suspicious destinations such as a\ncommand and control server. Detecting and investigating such behavior can help identify and mitigate potential security\nthreats, protecting the system and its data from potential compromise.", "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or ipv4_connection_attempt_event) and\nprocess.executable : (\n  /etc/crontab or /etc/rc.local or ./* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or\n  /etc/update-motd.d/* or /home/*/.* or /tmp/* or /usr/lib/update-notifier/* or /var/log/* or /var/tmp/*\n) and process.name : * and\nnot (\n  process.executable : (\n    /tmp/newroot/* or /tmp/snap.rootfs* or /etc/cron.hourly/BitdefenderRedline or /tmp/go-build* or /srv/snp/docker/* or\n    /run/containerd/* or /tmp/.mount* or /run/k3s/containerd/* or /tmp/selenium* or /tmp/tmp.*/juliainstaller or\n    /tmp/.criu.mntns* or /home/*/.local/share/containers/* or /etc/update-motd.d/*\n  ) or\n  source.ip:(10.0.0.0/8 or 127.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) or\n  process.name : (\n    apt or chrome or curl or dnf or dockerd or dpkg or firefox-bin or git-remote-https or java or kite-update or\n    kited or node or rpm or saml2aws or selenium-manager or solana-validator or wget or yum or ansible* or aws* or\n    php* or pip* or python* or steam* or terraform* or filebeat or apk or cursor or http\n  ) or\n  destination.ip:(\n    0.0.0.0 or 10.0.0.0/8 or 100.64.0.0/10 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or\n    192.0.0.0/29 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.2.0/24 or\n    192.168.0.0/16 or 192.175.48.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.88.99.0/24 or 198.18.0.0/15 or\n    198.51.100.0/24 or 203.0.113.0/24 or 224.0.0.0/4 or 240.0.0.0/4 or \"::1\" or \"FE80::/10\" or \"FF00::/8\"\n  )\n)", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_suspicious_network_activity_from_unknown_executable.toml"}
{"title": "Linux Telegram API Request", "description": "This rule detects when a process executes the curl or wget command with an argument that includes the\napi.telegram.org domain. This may indicate command and control behavior.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name in (\"curl\", \"wget\") and process.command_line like \"*api.telegram.org*\"", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_telegram_api_request.toml"}
{"title": "Potential Protocol Tunneling via EarthWorm", "description": "Identifies the execution of the EarthWorm tunneler. Adversaries may tunnel network communications to and from a victim\nsystem within a separate protocol to avoid detection and network filtering, or to enable access to otherwise unreachable\nsystems.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n process.args : \"-s\" and process.args : \"-d\" and process.args : \"rssocks\"", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_tunneling_via_earthworm.toml"}
{"title": "AWS Credentials Searched For Inside A Container", "description": "This rule detects the use of system search utilities like grep and find to search for AWS credentials inside a\ncontainer. Unauthorized access to these sensitive files could lead to further compromise of the container environment or\nfacilitate a container breakout to the underlying cloud environment.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and\nprocess.name in (\"grep\", \"egrep\", \"fgrep\", \"find\", \"locate\", \"mlocate\") and\nprocess.command_line like~ (\n  \"*aws_access_key_id*\", \"*aws_secret_access_key*\", \"*aws_session_token*\", \"*accesskeyid*\", \"*secretaccesskey*\",\n  \"*access_key*\", \"*.aws/credentials*\"\n)", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_aws_creds_search_inside_container.toml"}
{"title": "Sensitive Files Compression", "description": "Identifies the use of a compression utility to collect known files containing sensitive information, such as credentials\nand system configurations.", "query": "event.category:process and host.os.type:linux and event.type:start and\n  process.name:(zip or tar or gzip or hdiutil or 7z) and\n  process.args:\n    (\n      /root/.ssh/id_rsa or\n      /root/.ssh/id_rsa.pub or\n      /root/.ssh/id_ed25519 or\n      /root/.ssh/id_ed25519.pub or\n      /root/.ssh/authorized_keys or\n      /root/.ssh/authorized_keys2 or\n      /root/.ssh/known_hosts or\n      /root/.bash_history or\n      /etc/hosts or\n      /home/*/.ssh/id_rsa or\n      /home/*/.ssh/id_rsa.pub or\n      /home/*/.ssh/id_ed25519 or\n      /home/*/.ssh/id_ed25519.pub or\n      /home/*/.ssh/authorized_keys or\n      /home/*/.ssh/authorized_keys2 or\n      /home/*/.ssh/known_hosts or\n      /home/*/.bash_history or\n      /root/.aws/credentials or\n      /root/.aws/config or\n      /home/*/.aws/credentials or\n      /home/*/.aws/config or\n      /root/.docker/config.json or\n      /home/*/.docker/config.json or\n      /etc/group or\n      /etc/passwd or\n      /etc/shadow or\n      /etc/gshadow\n    )", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_collection_sensitive_files.toml"}
{"title": "Sensitive Files Compression Inside A Container", "description": "Identifies the use of a compression utility to collect known files containing sensitive information, such as credentials\nand system configurations inside a container.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\"zip\", \"tar\", \"gzip\", \"hdiutil\", \"7z\") and\nprocess.command_line like~ (\n  \"*/root/.ssh/*\", \"*/home/*/.ssh/*\", \"*/root/.bash_history*\", \"*/etc/hosts*\", \"*/root/.aws/*\", \"*/home/*/.aws/*\",\n  \"*/root/.docker/*\", \"*/home/*/.docker/*\", \"*/etc/group*\", \"*/etc/passwd*\", \"*/etc/shadow*\", \"*/etc/gshadow*\"\n)", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_collection_sensitive_files_compression_inside_container.toml"}
{"title": "Potential Linux Credential Dumping via Unshadow", "description": "Identifies the execution of the unshadow utility which is part of John the Ripper, a password-cracking tool on the host\nmachine. Malicious actors can use the utility to retrieve the combined contents of the '/etc/shadow' and '/etc/password'\nfiles. Using the combined file generated from the utility, the malicious threat actors can use them as input for\npassword-cracking utilities or prepare themselves for future operations by gathering credential information of the\nvictim.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"unshadow\" and process.args_count >= 3", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_credential_dumping.toml"}
{"title": "Linux init (PID 1) Secret Dump via GDB", "description": "This rule monitors for the potential memory dump of the init process (PID 1) through gdb. Attackers may leverage memory\ndumping techniques to attempt secret extraction from privileged processes. Tools that display this behavior include\n\"truffleproc\" and \"bash-memory-dump\". This behavior should not happen by default, and should be investigated thoroughly.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"gdb\" and process.args in (\"--pid\", \"-p\") and process.args == \"1\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_gdb_init_process_hooking.toml"}
{"title": "Linux Process Hooking via GDB", "description": "This rule monitors for potential memory dumping through gdb. Attackers may leverage memory dumping techniques to attempt\nsecret extraction from privileged processes. Tools that display this behavior include \"truffleproc\" and\n\"bash-memory-dump\". This behavior should not happen by default, and should be investigated thoroughly.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"gdb\" and process.args in (\"--pid\", \"-p\") and\n/* Covered by d4ff2f53-c802-4d2e-9fb9-9ecc08356c3f */\nprocess.args != \"1\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_gdb_process_hooking.toml"}
{"title": "Kubernetes Service Account Secret Access", "description": "This rule detects when a process accesses Kubernetes service account secrets. Kubernetes service\naccount secrets are files that contain sensitive information used by applications running in Kubernetes\nclusters to authenticate and authorize access to the cluster. These secrets are typically mounted into\npods at runtime, allowing applications to access them securely. Unauthorized access to these secrets\ncan lead to privilege escalation, lateral movement and unauthorized actions within the cluster.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.command_line like (\n    \"*/run/secrets/kubernetes.io/serviceaccount*\",\n    \"*/var/run/secrets/kubernetes.io/serviceaccount*\",\n    \"*/secrets/kubernetes.io/serviceaccount*\"\n  ) or (\n    process.working_directory like (\n      \"/run/secrets/kubernetes.io/serviceaccount\",\n      \"/var/run/secrets/kubernetes.io/serviceaccount\",\n      \"/secrets/kubernetes.io/serviceaccount\"\n    ) and\n    process.args in (\"ca.crt\", \"token\", \"namespace\")\n  )\n)", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_kubernetes_service_account_secret_access.toml"}
{"title": "Manual Memory Dumping via Proc Filesystem", "description": "This rule monitors for manual memory dumping via the proc filesystem. The proc filesystem in Linux provides a virtual filesystem\nthat contains information about system processes and their memory mappings. Attackers may use this technique to dump the memory\nof a process, potentially extracting sensitive information such as credentials or encryption keys.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"cat\", \"grep\", \"tail\", \"less\", \"more\", \"egrep\", \"fgrep\") and process.command_line like \"/proc/*/mem\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_manual_memory_dumping.toml"}
{"title": "Potential Linux Local Account Brute Force Detected", "description": "Identifies multiple consecutive login attempts executed by one process targeting a local linux user account within a\nshort time interval. Adversaries might brute force login attempts across different users with a default wordlist or a\nset of customly crafted passwords in an attempt to gain access to these accounts.", "query": "sequence by host.id, process.parent.executable, user.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"su\" and\n   not process.parent.name in (\n     \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"clickhouse-server\", \"ma\", \"gitlab-runner\",\n     \"updatedb.findutils\", \"cron\", \"perl\", \"sudo\", \"java\", \"cloud-app-identify\", \"ambari-sudo.sh\"\n   )\n  ] with runs=10", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_linux_local_account_bruteforce.toml"}
{"title": "Potential External Linux SSH Brute Force Detected", "description": "Identifies multiple external consecutive login failures targeting a user account from the same source address within a\nshort time interval. Adversaries will often brute force login attempts across multiple users with a common or known\npassword, in an attempt to gain access to these accounts.", "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   not cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_linux_ssh_bruteforce_external.toml"}
{"title": "Potential Internal Linux SSH Brute Force Detected", "description": "Identifies multiple internal consecutive login failures targeting a user account from the same source address within a\nshort time interval. Adversaries will often brute force login attempts across multiple users with a common or known\npassword, in an attempt to gain access to these accounts.", "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_linux_ssh_bruteforce_internal.toml"}
{"title": "Potential Successful Linux FTP Brute Force Attack Detected", "description": "An FTP (file transfer protocol) brute force attack is a method where an attacker systematically tries different\ncombinations of usernames and passwords to gain unauthorized access to an FTP server, and if successful, the impact can\ninclude unauthorized data access, manipulation, or theft, compromising the security and integrity of the server and\npotentially exposing sensitive information. This rule identifies multiple consecutive authentication failures targeting\na specific user account from the same source address and within a short time interval, followed by a successful\nauthentication.", "query": "sequence by host.id, auditd.data.addr, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"failure\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"success\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] | tail 1", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_successful_linux_ftp_bruteforce.toml"}
{"title": "Potential Successful Linux RDP Brute Force Attack Detected", "description": "An RDP (Remote Desktop Protocol) brute force attack involves an attacker repeatedly attempting various username and\npassword combinations to gain unauthorized access to a remote computer via RDP, and if successful, the potential impact\ncan include unauthorized control over the compromised system, data theft, or the ability to launch further attacks\nwithin the network, jeopardizing the security and confidentiality of the targeted system and potentially compromising\nthe entire network infrastructure. This rule identifies multiple consecutive authentication failures targeting a\nspecific user account within a short time interval, followed by a successful authentication.", "query": "sequence by host.id, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal : \"*rdp*\" and event.outcome == \"failure\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal : \"*rdp*\" and event.outcome == \"success\"] | tail 1", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_successful_linux_rdp_bruteforce.toml"}
{"title": "Potential Successful SSH Brute Force Attack", "description": "Identifies multiple SSH login failures followed by a successful one from the same source address. Adversaries can\nattempt to login into multiple users with a common or known password to gain access to accounts.", "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"failure\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ] with runs=10\n\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"success\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ]", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_successful_linux_ssh_bruteforce.toml"}
{"title": "Potential Linux Credential Dumping via Proc Filesystem", "description": "Identifies the execution of the mimipenguin exploit script which is linux adaptation of Windows tool mimikatz.\nMimipenguin exploit script is used to dump clear text passwords from a currently logged-in user. The tool exploits a\nknown vulnerability CVE-2018-20781. Malicious actors can exploit the cleartext credentials in memory by dumping the\nprocess and extracting lines that have a high probability of containing cleartext passwords.", "query": "sequence by host.id, process.parent.name with maxspan=1m\n  [process where host.os.type == \"linux\" and process.name == \"ps\" and event.action in (\"exec\", \"start\", \"exec_event\")\n   and process.args in (\"-eo\", \"pid\", \"command\")]\n  [process where host.os.type == \"linux\" and process.name == \"strings\" and event.action in (\"exec\", \"start\", \"exec_event\")\n   and process.args : \"/tmp/*\"]", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_proc_credential_dumping.toml"}
{"title": "Sensitive Keys Or Passwords Searched For Inside A Container", "description": "This rule detects the use of system search utilities like grep and find to search for private SSH keys or passwords\ninside a container. Unauthorized access to these sensitive files could lead to further compromise of the container\nenvironment or facilitate a container breakout to the underlying host machine.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and\nprocess.name in (\"grep\", \"egrep\", \"fgrep\", \"find\", \"locate\", \"mlocate\") and\nprocess.command_line like~ (\n  \"*BEGIN PRIVATE*\", \"*BEGIN OPENSSH PRIVATE*\", \"*BEGIN RSA PRIVATE*\", \"*BEGIN DSA PRIVATE*\", \"*BEGIN EC PRIVATE*\",\n  \"*pass*\", \"*ssh*\", \"*user*\", \"*id_rsa*\", \"*id_dsa*\"\n)", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_sensitive_keys_or_passwords_search_inside_container.toml"}
{"title": "Potential OpenSSH Backdoor Logging Activity", "description": "Identifies a Secure Shell (SSH) client or server process creating or writing to a known SSH backdoor log file.\nAdversaries may modify SSH related binaries for persistence or credential access via patching sensitive functions to\nenable unauthorized access or to log SSH credentials for exfiltration.", "query": "file where host.os.type == \"linux\" and event.type == \"change\" and process.executable : (\"/usr/sbin/sshd\", \"/usr/bin/ssh\") and\n  (\n    (file.name : (\".*\", \"~*\", \"*~\") and not file.name : (\".cache\", \".viminfo\", \".bash_history\", \".google_authenticator\",\n      \".jelenv\", \".csvignore\", \".rtreport\")) or\n    file.extension : (\"in\", \"out\", \"ini\", \"h\", \"gz\", \"so\", \"sock\", \"sync\", \"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\") or\n    file.path :\n    (\n      \"/private/etc/*--\",\n      \"/usr/share/*\",\n      \"/usr/include/*\",\n      \"/usr/local/include/*\",\n      \"/private/tmp/*\",\n      \"/private/var/tmp/*\",\n      \"/usr/tmp/*\",\n      \"/usr/share/man/*\",\n      \"/usr/local/share/*\",\n      \"/usr/lib/*.so.*\",\n      \"/private/etc/ssh/.sshd_auth\",\n      \"/usr/bin/ssd\",\n      \"/private/var/opt/power\",\n      \"/private/etc/ssh/ssh_known_hosts\",\n      \"/private/var/html/lol\",\n      \"/private/var/log/utmp\",\n      \"/private/var/lib\",\n      \"/var/run/sshd/sshd.pid\",\n      \"/var/run/nscd/ns.pid\",\n      \"/var/run/udev/ud.pid\",\n      \"/var/run/udevd.pid\"\n    )\n  )", "tactic": "Credential Access", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ssh_backdoor_log.toml"}
{"title": "Unusual Instance Metadata Service (IMDS) API Request", "description": "This rule identifies potentially malicious processes attempting to access the cloud service provider's instance metadata\nservice (IMDS) API endpoint, which can be used to retrieve sensitive instance-specific information such as instance ID,\npublic IP address, and even temporary security credentials if role's are assumed by that instance. The rule monitors for\nvarious tools and scripts like curl, wget, python, and perl that might be used to interact with the metadata API.", "query": "sequence by host.id,  process.parent.entity_id with maxspan=1s\n[process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n process.parent.executable != null and \n (\n  process.name : (\n    \"curl\", \"wget\", \"python*\", \"perl*\", \"php*\", \"ruby*\", \"lua*\", \"telnet\", \"pwsh\",\n    \"openssl\", \"nc\", \"ncat\", \"netcat\", \"awk\", \"gawk\", \"mawk\", \"nawk\", \"socat\", \"node\"\n    ) or \n  process.executable : (\n      \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n      \"/etc/cron*\", \"/etc/update-motd.d/*\", \"/boot/*\", \"/srv/*\", \"/run/*\", \"/etc/rc.local\"\n    ) or\n  process.command_line: \"*169.254.169.254*\" \n  )  \n  and not process.working_directory: (\n          \"/opt/rapid7*\",\n          \"/opt/nessus*\",\n          \"/snap/amazon-ssm-agent*\",\n          \"/var/snap/amazon-ssm-agent/*\",\n          \"/var/log/amazon/ssm/*\",\n          \"/srv/snp/docker/overlay2*\",\n          \"/opt/nessus_agent/var/nessus/*\") \n  and not process.executable: (\n          \"/opt/rumble/bin/rumble-agent*\",\n          \"/opt/aws/inspector/bin/inspectorssmplugin\",\n          \"/snap/oracle-cloud-agent/*\",\n          \"/lusr/libexec/oracle-cloud-agent/*\") \n  and not process.parent.executable: (\n          \"/usr/bin/setup-policy-routes\",\n          \"/usr/share/ec2-instance-connect/*\",\n          \"/var/lib/amazon/ssm/*\", \n          \"/etc/update-motd.d/30-banner\", \n          \"/usr/sbin/dhclient-script\", \n          \"/usr/local/bin/uwsgi\", \n          \"/usr/lib/skylight/al-extras\")\n]\n[network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.ip == \"169.254.169.254\"]", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_unusual_instance_metadata_service_api_request.toml"}
{"title": "Access Control List Modification via setfacl", "description": "This rule detects Linux Access Control List (ACL) modification via the setfacl command.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name == \"setfacl\" and not (\n  process.command_line == \"/bin/setfacl --restore=-\" or\n  process.args == \"/var/log/journal/\" or\n  process.parent.name in (\"stats.pl\", \"perl\", \"find\") or\n  process.parent.command_line like~ \"/bin/sh -c *ansible*\"\n)", "tactic": "Defense Evasion", "technique": "File and Directory Permissions Modification", "technique_id": "T1222", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_acl_modification_via_setfacl.toml"}
{"title": "Attempt to Disable Auditd Service", "description": "Adversaries may attempt to disable the Auditd service to evade detection. Auditd is a Linux service that provides system\nauditing and logging. Disabling the Auditd service can prevent the system from logging important security events, which\ncan be used to detect malicious activity.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and (\n  (process.name == \"service\" and process.args == \"stop\") or\n  (process.name == \"chkconfig\" and process.args == \"off\") or\n  (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))\n) and\nprocess.args in (\"auditd\", \"auditd.service\") and \nnot process.parent.name == \"auditd.prerm\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_to_disable_auditd_service.toml"}
{"title": "Attempt to Disable IPTables or Firewall", "description": "Adversaries may attempt to disable the iptables or firewall service in an attempt to affect how a host is allowed to\nreceive or send network traffic.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n  (\n   /* disable FW */\n   (\n     (process.name == \"ufw\" and process.args == \"disable\") or\n     (process.name == \"iptables\" and process.args in (\"-F\", \"--flush\", \"-X\", \"--delete-chain\") and process.args_count == 2) or\n     (process.name in (\"iptables\", \"ip6tables\") and process.parent.args == \"force-stop\")\n   ) or\n\n   /* stop FW service */\n   (\n     ((process.name == \"service\" and process.args == \"stop\") or\n       (process.name == \"chkconfig\" and process.args == \"off\") or\n       (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))) and\n    process.args in (\"firewalld\", \"ip6tables\", \"iptables\", \"firewalld.service\", \"ip6tables.service\", \"iptables.service\")\n    )\n  )", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_to_disable_iptables_or_firewall.toml"}
{"title": "Attempt to Disable Syslog Service", "description": "Adversaries may attempt to disable the syslog service in an attempt to an attempt to disrupt event logging and evade\ndetection by security controls.", "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n ( (process.name == \"service\" and process.args == \"stop\") or\n   (process.name == \"chkconfig\" and process.args == \"off\") or\n   (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))\n ) and process.args in (\"syslog\", \"rsyslog\", \"syslog-ng\", \"syslog.service\", \"rsyslog.service\", \"syslog-ng.service\") and\nnot process.parent.name == \"rsyslog-rotate\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_to_disable_syslog_service.toml"}
{"title": "SSH Authorized Keys File Deletion", "description": "This rule detects the deletion of the authorized_keys or authorized_keys2 files on Linux systems. These files\nare used to store public keys for SSH authentication. Unauthorized deletion of these files can be an indicator\nof an attacker removing access to the system, and may be a precursor to further malicious activity.", "query": "file where host.os.type == \"linux\" and event.type == \"deletion\" and file.name in (\"authorized_keys\", \"authorized_keys2\") and\nnot (\n  process.executable in (\n    \"/usr/bin/google_guest_agent\", \"/usr/bin/dockerd\", \"/bin/dockerd\", \"/usr/bin/containerd\"\n  ) or\n  process.executable like~ \"/nix/store/*\"\n)", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_authorized_keys_file_deletion.toml"}
{"title": "Base16 or Base32 Encoding/Decoding Activity", "description": "Adversaries may encode/decode data in an attempt to evade detection by host- or network-based security controls.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name in (\"base16\", \"base32\", \"base32plain\", \"base32hex\") and\nnot process.args in (\"--help\", \"--version\")", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_base16_or_base32_encoding_or_decoding_activity.toml"}
{"title": "Unusual Base64 Encoding/Decoding Activity", "description": "This rule leverages ES|QL to detect unusual base64 encoding/decoding activity on Linux systems. Attackers may use base64\nencoding/decoding to obfuscate data, such as command and control traffic or payloads, to evade detection by host- or\nnetwork-based security controls. ES|QL rules have limited fields available in its alert documents. Make sure to review\nthe original documents to aid in the investigation of this alert.", "query": "from logs-endpoint.events.process-*\n| keep @timestamp, host.os.type, event.type, event.action, process.name, process.args, process.command_line, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name in (\"base64\", \"base64plain\", \"base64url\", \"base64mime\", \"base64pem\", \"base32\", \"base16\") and process.command_line like \"*-*d*\") or\n  (process.name == \"openssl\" and process.args == \"enc\" and process.args in (\"-d\", \"-base64\", \"-a\")) or\n  (process.name like \"python*\" and\n    (process.args == \"base64\" and process.args in (\"-d\", \"-u\", \"-t\")) or\n    (process.args == \"-c\" and process.command_line like \"*base64*\" and process.command_line like \"*b64decode*\")\n  ) or\n  (process.name like \"perl*\" and process.command_line like \"*decode_base64*\") or\n  (process.name like \"ruby*\" and process.args == \"-e\" and process.command_line like \"*Base64.decode64*\")\n)\n| stats cc = count(), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.name, process.command_line\n| where agent_count == 1 and cc < 15\n| sort cc asc\n| limit 100", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_base64_decoding_activity.toml"}
{"title": "System Binary Moved or Copied", "description": "This rule monitors for the copying or moving of a system binary. Adversaries may copy/move and rename system binaries to\nevade detection. Copying a system binary to a different location should not occur often, so if it does, the activity\nshould be investigated.", "query": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and process.name != null and\nfile.Ext.original.path : (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/bin/update-alternatives\", \"/bin/update-alternatives\", \"/usr/sbin/update-alternatives\",\n    \"/sbin/update-alternatives\", \"/usr/bin/pip3\", \"/bin/pip3\", \"/usr/local/bin/pip3\", \"/usr/local/bin/node\",\n    \"/bin/node\", \"/usr/bin/node\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/pip\", \"/bin/pip\",\n    \"/usr/local/bin/pip\", \"/usr/libexec/platform-python\", \"/usr/bin/platform-python\", \"/bin/platform-python\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\", \"/sbin/sshd\", \"/usr/local/sbin/sshd\", \"/usr/sbin/crond\", \"/sbin/crond\",\n    \"/usr/local/sbin/crond\", \"/usr/sbin/gdm\"\n  ) or\n  process.name like (\n    \"python*\", \"packagekitd\", \"systemd\", \"ln\", \"platform-python\", \"dnf_install\", \"runc\", \"apt-get\", \"ssm-agent-worker\",\n    \"convert-usrmerge\", \"updatenow.static-cpanelsync\", \"apk\", \"exe\", \"php\", \"containerd-shim-runc-v2\", \"dpkg\", \"sed\",\n    \"platform-python*\", \"gedit\", \"crond\", \"sshd\", \"ruby\", \"sudo\", \"chainctl\", \"update-alternatives\", \"pip*\", \"microdnf\",\n    \"rsync\", \"convert2rhel\", \"convert-usr-merge\"\n  ) or\n  file.Ext.original.path : (\n    \"/bin/*.tmp\", \"/usr/bin/*.tmp\", \"/usr/local/bin/*.tmp\", \"/sbin/*.tmp\", \"/usr/sbin/*.tmp\", \"/usr/local/sbin/*.tmp\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_binary_copied_to_suspicious_directory.toml"}
{"title": "File made Immutable by Chattr", "description": "Detects a file being made immutable using the chattr binary. Making a file immutable means it cannot be deleted or\nrenamed, no link can be created to this file, most of the file's metadata can not be modified, and the file can not be\nopened in write mode. Threat actors will commonly utilize this to prevent tampering or modification of their malicious\nfiles or any system files they have modified for purposes of persistence (e.g .ssh, /etc/passwd, etc.).", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.parent.executable != null and\nprocess.executable : \"/usr/bin/chattr\" and process.args : (\"-*i*\", \"+*i*\") and not (\n  process.parent.executable: (\"/lib/systemd/systemd\", \"/usr/local/uems_agent/bin/*\", \"/usr/lib/systemd/systemd\") or\n  process.parent.name in (\n    \"systemd\", \"cf-agent\", \"ntpdate\", \"xargs\", \"px\", \"preinst\", \"auth\", \"cf-agent\", \"dcservice\", \"dcagentupgrader\",\n    \"sudo\", \"ephemeral-disk-warning\"\n  )\n)", "tactic": "Defense Evasion", "technique": "File and Directory Permissions Modification", "technique_id": "T1222", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_chattr_immutable_file.toml"}
{"title": "Attempt to Clear Kernel Ring Buffer", "description": "Monitors for the deletion of the kernel ring buffer events through dmesg. Attackers may clear kernel ring buffer events\nto evade detection after installing a Linux kernel module (LKM).", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"dmesg\" and process.args in (\"-c\", \"--clear\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_clear_kernel_ring_buffer.toml"}
{"title": "Hidden Files and Directories via Hidden Flag", "description": "Identify activity related where adversaries can add the 'hidden' flag to files to hide them from the user in an attempt\nto evade detection.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.name == \"chflags\"", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_creation_of_hidden_files_directories.toml"}
{"title": "Directory Creation in /bin directory", "description": "This rule identifies the creation of directories in the /bin directory. The /bin directory contains essential binary\nfiles that are required for the system to function properly. The creation of directories in this location could be an\nattempt to hide malicious files or executables, as these /bin directories usually just contain binaries.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"start\", \"ProcessRollup2\", \"exec_event\") and process.name == \"mkdir\" and\n  process.args like (\"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\") and\nnot process.args in (\"/bin/mkdir\", \"/usr/bin/mkdir\", \"/usr/local/bin/mkdir\")", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_directory_creation_in_bin.toml"}
{"title": "Potential Disabling of AppArmor", "description": "This rule monitors for potential attempts to disable AppArmor. AppArmor is a Linux security module that enforces\nfine-grained access control policies to restrict the actions and resources that specific applications and processes can\naccess. Adversaries may disable security tools to avoid possible detection of their tools and activities.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n (\n  (process.name == \"systemctl\" and process.args in (\"stop\", \"disable\", \"kill\") and process.args in (\"apparmor\", \"apparmor.service\")) or\n  (process.name == \"service\" and process.args == \"apparmor\" and process.args == \"stop\") or\n  (process.name == \"chkconfig\" and process.args == \"apparmor\" and process.args == \"off\") or\n  (process.name == \"ln\" and process.args : \"/etc/apparmor.d/*\" and process.args == \"/etc/apparmor.d/disable/\")\n)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disable_apparmor_attempt.toml"}
{"title": "Potential Disabling of SELinux", "description": "Identifies potential attempts to disable Security-Enhanced Linux (SELinux), which is a Linux kernel security feature to\nsupport access control policies. Adversaries may disable security tools to avoid possible detection of their tools and\nactivities.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name == \"setenforce\" and process.args == \"0\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disable_selinux_attempt.toml"}
{"title": "Potential Defense Evasion via Doas", "description": "This rule detects the creation or rename of the Doas configuration file on a Linux system. Adversaries may create or\nmodify the Doas configuration file to elevate privileges and execute commands as other users while attempting to evade\ndetection.", "query": "file where host.os.type == \"linux\" and event.type != \"deletion\" and file.path == \"/etc/doas.conf\"", "tactic": "Defense Evasion", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_doas_configuration_creation_or_rename.toml"}
{"title": "Dynamic Linker Creation or Modification", "description": "Detects the creation or modification of files related to the dynamic linker on Linux systems. The dynamic linker is a\nshared library that is used by the Linux kernel to load and execute programs. Attackers may attempt to hijack the\nexecution flow of a program by modifying the dynamic linker configuration files.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path : (\"/etc/ld.so.preload\", \"/etc/ld.so.conf.d/*\", \"/etc/ld.so.conf\") and\nnot (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\",\n    \"/usr/lib/snapd/snap-update-ns\", \"/usr/bin/vmware-config-tools.pl\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\", \"/opt/dynatrace/oneagent/*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"java\", \"executor\", \"ssm-agent-worker\", \"packagekitd\", \"crio\", \"dockerd-entrypoint.sh\",\n    \"docker-init\", \"BootTimeChecker\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_dynamic_linker_file_creation.toml"}
{"title": "ESXI Timestomping using Touch Command", "description": "Identifies instances where the 'touch' command is executed on a Linux system with the \"-r\" flag, which is used to modify\nthe timestamp of a file based on another file's timestamp. The rule targets specific VM-related paths, such as\n\"/etc/vmware/\", \"/usr/lib/vmware/\", or \"/vmfs/*\". These paths are associated with VMware virtualization software, and\ntheir presence in the touch command arguments may indicate that a threat actor is attempting to tamper with timestamps\nof VM-related files and configurations on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name == \"touch\" and process.args == \"-r\" and process.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_esxi_suspicious_timestomp_touch.toml"}
{"title": "File Deletion via Shred", "description": "Malware or other files dropped or created on a system by an adversary may leave traces behind as to what was done within\na network and how. Adversaries may remove these files over the course of an intrusion to keep their footprint low or\nremove them at the end as part of the post-intrusion cleanup process.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"shred\" and process.args in (\n  \"-u\", \"--remove\", \"-z\", \"--zero\"\n) and not process.parent.name == \"logrotate\"", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_file_deletion_via_shred.toml"}
{"title": "File Permission Modification in Writable Directory", "description": "Identifies file permission modifications in common writable directories by a non-root user. Adversaries often drop files\nor payloads into a writable directory and change permissions prior to execution.", "query": "host.os.type:linux and event.category:process and event.type:start and\nprocess.name:(chattr or chgrp or chmod or chown) and process.working_directory:(/dev/shm or /tmp or /var/tmp) and\nnot process.parent.name:(\n  apt-key or update-motd-updates-available or apt-get or java or pilot or PassengerAgent or nginx\n)", "tactic": "Defense Evasion", "technique": "File and Directory Permissions Modification", "technique_id": "T1222", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_file_mod_writable_dir.toml"}
{"title": "Potential Hex Payload Execution via Command-Line", "description": "This rule detects when a process executes a command line containing hexadecimal characters. Malware authors may use\nhexadecimal encoding to obfuscate their payload and evade detection.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.parent.executable != null and\nprocess.command_line : \"*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\\\\x*\" and\nlength(process.command_line) > 50", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_hex_payload_execution_via_commandline.toml"}
{"title": "Potential Hex Payload Execution via Common Utility", "description": "This rule detects potential hex payload execution on Linux systems. Adversaries may use hex encoding to obfuscate\npayloads and evade detection mechanisms.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name == \"xxd\" and process.args like (\"-r*\", \"-p*\")) or\n    (process.name like \"python*\" and process.command_line like \"*fromhex*\" and process.command_line like (\"*decode*\", \"*encode*\")) or\n    (process.name like \"php*\" and process.command_line like \"*hex2bin*\") or\n    (process.name like \"ruby*\" and process.command_line like \"*].pack(\\\"H*\\\")*\") or\n    (process.name like \"perl*\" and process.command_line like \"*pack(\\\"H*\\\",*\") or\n    (process.name like \"lua*\" and process.command_line like \"*tonumber(cc, 16)*\")\n  )", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_hex_payload_execution_via_utility.toml"}
{"title": "Hidden Directory Creation via Unusual Parent", "description": "This rule detects the creation of a hidden directory via an unusual parent executable. Hidden directories are\ndirectories that are not visible to the user by default. They are often used by attackers to hide malicious files or\ntools.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\", \"exec_event\") and\nprocess.name == \"mkdir\" and process.parent.executable like (\n  \"/dev/shm/*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/run/*\", \"/root/*\", \"/boot/*\", \"/var/www/html/*\", \"/opt/.*\"\n) and process.args like (\".*\", \"/*/.*\") and process.args_count <= 3 and not (\n  process.parent.executable like (\"/tmp/newroot/*\", \"/run/containerd/*\") or\n  process.command_line like (\"mkdir -p .\", \"mkdir ./*\") or\n  process.args == \"/root/.ssh\" or\n  process.parent.executable like (\n    \"/tmp/pear/temp/*\", \"/var/tmp/buildah*\", \"/tmp/python-build.*\", \"/tmp/cliphist-wofi-img\", \"/tmp/snap.rootfs_*\"\n  )\n)", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_hidden_directory_creation.toml"}
{"title": "Creation of Hidden Files and Directories via CommandLine", "description": "Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name.\nAdversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion.\nThis rule looks for hidden files or folders in common writable directories.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.working_directory in (\"/tmp\", \"/var/tmp\", \"/dev/shm\") and\nprocess.args regex~ \"\"\"\\.[a-z0-9_\\-][a-z0-9_\\-\\.]{1,254}\"\"\" and\nnot process.name in (\n  \"ls\", \"find\", \"grep\", \"git\", \"jq\", \"basename\", \"check_snmp\", \"snmpget\", \"snmpwalk\", \"cc1plus\", \"snap\",\n  \"command-not-found\", \"sqlite\", \"apk\", \"fgrep\", \"locate\", \"objdump\"\n)", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_hidden_file_dir_tmp.toml"}
{"title": "Creation of Hidden Shared Object File", "description": "Identifies the creation of a hidden shared object (.so) file. Users can mark specific files as hidden simply by putting\na \".\" as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and\nfolders on the system for persistence and defense evasion.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.extension == \"so\" and file.name : \".*.so\" and\nnot process.name in (\"dockerd\", \"azcopy\", \"podman\")", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_hidden_shared_object.toml"}
{"title": "Unusual Interactive Shell Launched from System User", "description": "This rule detects interactive shells launched from system users. System users typically do not require interactive shells,\nand their presence may indicate malicious activity.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and user.name:(\n   daemon or bin or sys or sync or games or man or mail or news or uucp or proxy or backup or list or irc\n   or gnats or _apt or Debian-exim or systemd-timesync or messagebus or uuidd or _chrony or sshd or\n   gamer or shutdown or halt or dbus or polkitd or rtkit or pipewire or tcpdump or clevis or\n   libstoreagemgmt or geoclue or tss or sssd or gnome-initial-setup or pesign or dnsmasq or chrony\n) and process.interactive:true and process.parent.executable:* and not (\n  process.parent.name:(\n    apt-key or apt-config or gpgv or gpgconf or man-db.postinst or sendmail or rpm or nullmailer-inject\n  ) or\n  process.args:(/etc/apt/trusted.gpg.d/* or /tmp/apt-key-gpg*) or\n  process.name:(awk or apt-config or dpkg or grep or gpgv or sed) or\n  (user.name:_apt and process.name:(sqv or apt-key or gpgconf or sort or mktemp or find or cmp or gpg-connect-agent)) or\n  (user.name:man and process.name:mandb) or\n  (user.name:daemon and process.name:at)\n)", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_interactive_shell_from_system_user.toml"}
{"title": "Base64 Decoded Payload Piped to Interpreter", "description": "This rule detects when a base64 decoded payload is piped to an interpreter on Linux systems. Adversaries may use\nbase64 encoding to obfuscate data and pipe it to an interpreter to execute malicious code. This technique may\nbe used to evade detection by host- or network-based security controls.", "query": "sequence by host.id, process.parent.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n    (process.name in (\"base64\", \"base64plain\", \"base64url\", \"base64mime\", \"base64pem\", \"base32\", \"base16\") and process.command_line like~ \"*-*d*\") or\n    (process.name == \"openssl\" and process.args == \"enc\" and process.args in (\"-d\", \"-base64\", \"-a\")) or\n    (process.name like \"python*\" and\n    (process.args == \"base64\" and process.args in (\"-d\", \"-u\", \"-t\")) or\n    (process.args == \"-c\" and process.args like \"*base64*\" and process.command_line like~ \"*b64decode*\")\n    ) or\n    (process.name like \"perl*\" and process.command_line like~ \"*decode_base64*\") or\n    (process.name like \"ruby*\" and process.args == \"-e\" and process.command_line like~ \"*Base64.decode64*\")\n  )]\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name like~ (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"perl*\", \"ruby*\", \"lua*\", \"php*\"\n )]", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_interpreter_launched_from_decoded_payload.toml"}
{"title": "Kernel Module Removal", "description": "Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the\nfunctionality of the kernel without the need to reboot the system. This rule identifies attempts to remove a kernel\nmodule.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    process.name == \"rmmod\" or\n    (process.name == \"modprobe\" and process.args in (\"--remove\", \"-r\"))\n  ) and\n  process.parent.name in (\"sudo\", \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_kernel_module_removal.toml"}
{"title": "Kill Command Execution", "description": "This rule detects the execution of kill, pkill, and killall commands on Linux systems. These commands are used to terminate\nprocesses on a system. Attackers may use these commands to kill security tools or other processes to evade detection or\ndisrupt system operations.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\nprocess.name:(kill or pkill or killall)", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_kill_command_executed.toml"}
{"title": "Executable Masquerading as Kernel Process", "description": "Monitors for kernel processes with associated process executable fields that are not empty. Unix kernel processes such\nas kthreadd and kworker typically do not have process.executable fields associated to them. Attackers may attempt to\nhide their malicious programs by masquerading as legitimate kernel processes.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name : (\"kworker*\", \"kthread*\") and process.executable != null", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_kthreadd_masquerading.toml"}
{"title": "Unusual LD_PRELOAD/LD_LIBRARY_PATH Command Line Arguments", "description": "This rule detects the use of the LD_PRELOAD and LD_LIBRARY_PATH environment variables in a command line argument.\nThis behavior is unusual and may indicate an attempt to hijack the execution flow of a process. Threat actors may use\nthis technique to evade defenses, escalate privileges, or maintain persistence on a system.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and\nprocess.parent.name:(* and not (\n  awk or bwrap or cylancesvc or dbus-run-session or java or julia or make or matlab_helper or ninja or noproc_sandbox or\n  nxrunner or nxserver or perl or rear or sapcontrol or setsid or spoold or sshd or steam or su or sudo or titanagent or\n  vls_agent or zabbix_agentd\n)) and\nprocess.name:(bash or csh or dash or fish or ksh or sh or tcsh or zsh) and\nprocess.args:-c and process.command_line:(*LD_LIBRARY_PATH=* or *LD_PRELOAD=*)", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ld_preload_cmdline.toml"}
{"title": "Dynamic Linker (ld.so) Creation", "description": "This rule detects the creation of the dynamic linker (ld.so) file. The dynamic linker is used to load shared libraries\nneeded by an executable. Attackers may attempt to replace the dynamic linker with a malicious version to execute\narbitrary code.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.path like~ (\"/lib/ld-linux*.so*\", \"/lib64/ld-linux*.so*\", \"/usr/lib/ld-linux*.so*\", \"/usr/lib64/ld-linux*.so*\") and\nnot process.name in (\"dockerd\", \"yum\", \"dnf\", \"microdnf\", \"pacman\")", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ld_so_creation.toml"}
{"title": "System Log File Deletion", "description": "Identifies the deletion of sensitive Linux system logs. This may indicate an attempt to evade detection or destroy\nforensic evidence on a system.", "query": "file where host.os.type == \"linux\" and event.type == \"deletion\" and\n  file.path :\n    (\n    \"/var/run/utmp\",\n    \"/var/log/wtmp\",\n    \"/var/log/btmp\",\n    \"/var/log/lastlog\",\n    \"/var/log/faillog\",\n    \"/var/log/syslog\",\n    \"/var/log/messages\",\n    \"/var/log/secure\",\n    \"/var/log/auth.log\",\n    \"/var/log/boot.log\",\n    \"/var/log/kern.log\",\n    \"/var/log/dmesg\"\n    ) and\n    not process.name in (\"gzip\", \"executor\", \"dockerd\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_log_files_deleted.toml"}
{"title": "Potential Hidden Process via Mount Hidepid", "description": "Identifies the execution of mount process with hidepid parameter, which can make processes invisible to other users from\nthe system. Adversaries using Linux kernel version 3.2+ (or RHEL/CentOS v6.5+ above) can hide the process from other\nusers. When hidepid=2 option is executed to mount the /proc filesystem, only the root user can see all processes and the\nlogged-in user can only see their own process. This provides a defense evasion mechanism for the adversaries to hide\ntheir process executions from all other commands such as ps, top, pgrep and more. With the Linux kernel hardening\nhidepid option all the user has to do is remount the /proc filesystem with the option, which can now be monitored and\ndetected.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n  process.name == \"mount\" and process.args == \"/proc\" and process.args == \"-o\" and process.args : \"*hidepid=2*\" and\n  not process.parent.command_line like \"/opt/cloudlinux/*\"", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_mount_execution.toml"}
{"title": "Potential Defense Evasion via PRoot", "description": "Identifies the execution of the PRoot utility, an open-source tool for user-space implementation of chroot, mount\n--bind, and binfmt_misc. Adversaries can leverage an open-source tool PRoot to expand the scope of their operations to\nmultiple Linux distributions and simplify their necessary efforts. In a normal threat scenario, the scope of an attack\nis limited by the varying configurations of each Linux distribution. With PRoot, it provides an attacker with a\nconsistent operational environment across different Linux distributions, such as Ubuntu, Fedora, and Alpine. PRoot also\nprovides emulation capabilities that allow for malware built on other architectures, such as ARM, to be run.The\npost-exploitation technique called bring your own filesystem (BYOF), can be used by the threat actors to execute\nmalicious payload or elevate privileges or perform network scans or orchestrate another attack on the environment.\nAlthough PRoot was originally not developed with malicious intent it can be easily tuned to work for one.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.parent.name == \"proot\"", "tactic": "Defense Evasion", "technique": "Exploitation for Defense Evasion", "technique_id": "T1211", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_potential_proot_exploits.toml"}
{"title": "Potential Process Name Stomping with Prctl", "description": "This rule leverages Auditd data to detect the use of the `prctl` syscall to potentially hide a process\nby changing its name. The `prctl` syscall is used to control various process attributes. Attackers can use\nthis syscall to change the name of a process to a hidden directory or file, making it harder to detect. The query\nlooks for the `prctl` syscall with the `PR_SET_NAME` argument set to `f` (PR_SET_NAME is used to set the name of a process).", "query": "process where host.os.type == \"linux\" and auditd.data.syscall == \"prctl\" and auditd.data.a0 == \"f\" and\nprocess.executable like (\n  \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/var/run/*\", \"/etc/update-motd.d/*\",\n  \"/tmp/*\", \"/var/log/*\", \"/var/tmp/*\", \"/home/*\", \"/run/shm/*\", \"/run/*\", \"./*\"\n)", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_prctl_process_name_tampering.toml"}
{"title": "Suspicious Renaming of ESXI Files", "description": "Identifies instances where VMware-related files, such as those with extensions like \".vmdk\", \".vmx\", \".vmxf\", \".vmsd\",\n\".vmsn\", \".vswp\", \".vmss\", \".nvram\", and \".vmem\", are renamed on a Linux system. The rule monitors for the \"rename\"\nevent action associated with these file types, which could indicate malicious activity.", "query": "file where host.os.type == \"linux\" and event.action == \"rename\" and\nfile.Ext.original.name : (\"*.vmdk\", \"*.vmx\", \"*.vmxf\", \"*.vmsd\", \"*.vmsn\", \"*.vswp\", \"*.vmss\", \"*.nvram\", \"*.vmem\")\nand not file.name : (\"*.vmdk\", \"*.vmx\", \"*.vmxf\", \"*.vmsd\", \"*.vmsn\", \"*.vswp\", \"*.vmss\", \"*.nvram\", \"*.vmem\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_rename_esxi_files.toml"}
{"title": "Suspicious Renaming of ESXI index.html File", "description": "Identifies instances where the \"index.html\" file within the \"/usr/lib/vmware/*\" directory is renamed on a Linux system.\nThe rule monitors for the \"rename\" event action associated with this specific file and path, which could indicate\nmalicious activity.", "query": "file where host.os.type == \"linux\" and event.action == \"rename\" and file.name : \"index.html\" and\nfile.Ext.original.path : \"/usr/lib/vmware/*\"", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_rename_esxi_index_file.toml"}
{"title": "Root Certificate Installation", "description": "This rule detects the installation of root certificates on a Linux system. Adversaries may install a root certificate on\na compromised system to avoid warnings when connecting to their command and control servers. Root certificates are used\nin public key cryptography to identify a root certificate authority (CA). When a root certificate is installed, the\nsystem or application will trust certificates in the root's chain of trust that have been signed by the root\ncertificate.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.name in (\"update-ca-trust\", \"update-ca-certificates\") and not (\n  process.parent.name like (\n    \"ca-certificates.postinst\", \"ca-certificates-*.trigger\", \"pacman\", \"pamac-daemon\", \"autofirma.postinst\",\n    \"ipa-client-install\", \"su\", \"platform-python\", \"python*\", \"kesl\", \"execd\", \"systemd\", \"flock\"\n  ) or\n  process.parent.args like \"/var/tmp/rpm*\" or\n  (process.parent.name in (\"sh\", \"bash\", \"zsh\") and process.args == \"-e\")\n)", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_root_certificate_installation.toml"}
{"title": "SELinux Configuration Creation or Renaming", "description": "This rule detects the creation or renaming of the SELinux configuration file. SELinux is a security module that\nprovides access control security policies. Modifications to the SELinux configuration file may indicate an attempt to\nimpair defenses by disabling or modifying security tools.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\", \"rename\", \"file_rename_event\")\nand file.path : \"/etc/selinux/config\" and not process.name in (\"dockerd\", \"platform-python\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_selinux_configuration_creation_or_renaming.toml"}
{"title": "SSL Certificate Deletion", "description": "This rule detects the deletion of SSL certificates on a Linux system. Adversaries may delete SSL certificates to subvert\ntrust controls and negatively impact the system.", "query": "file where host.os.type == \"linux\" and event.type == \"deletion\" and file.path : \"/etc/ssl/certs/*\" and\nfile.extension in (\"pem\", \"crt\") and not process.name in (\"dockerd\", \"pacman\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ssl_certificate_deletion.toml"}
{"title": "Suspicious Path Mounted", "description": "This rule detects suspicious paths mounted on Linux systems. The mount command is used to attach filesystems to\nthe system, and attackers may use it to mount malicious filesystems or directories for data exfiltration or\npersistence.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"mount\" and\nprocess.args like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/home/*\", \"/root/*\", \"/mount\") and process.parent.executable != null and\nnot (\n  process.parent.executable like (\"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\", \"/usr/libexec/*\") or\n  process.parent.name == \"snapd\"\n)", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_path_mounted.toml"}
{"title": "Potentially Suspicious Process Started via tmux or screen", "description": "This rule monitors for the execution of suspicious commands via screen and tmux. When launching a command and detaching\ndirectly, the commands will be executed in the background via its parent process. Attackers may leverage screen or tmux\nto execute commands while attempting to evade detection.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.parent.name in (\"screen\", \"tmux\") and process.name like (\n    \"nmap\", \"nc\", \"ncat\", \"netcat\", \"socat\", \"nc.openbsd\", \"ngrok\", \"ping\", \"java\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n    \"openssl\", \"telnet\", \"wget\", \"curl\", \"id\"\n  )", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sus_utility_executed_via_tmux_or_screen.toml"}
{"title": "System Binary Symlink to Suspicious Location", "description": "This rule detects the creation of a symbolic link from a system binary to a suspicious and writable location. This\nactivity may indicate an attacker's attempt to evade detection by behavioral rules that depend on predefined process\nparent/child relationships. By executing the symlinked variant of a binary instead of the original, the attacker aims to\nbypass these rules. Through the new_terms rule type, this rule can identify uncommon parent processes that may indicate the\npresence of a malicious symlink.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.parent.executable:* and\n(process.name:ln or process.name:busybox and process.args:ln or process.name:cp and process.args:--symbolic-link) and\nprocess.args:(\n  (\n    /bin/* or /lib/* or /lib64/* or /sbin/* or /usr/bin/* or /usr/lib/* or /usr/lib64/* or /usr/local/bin/* or\n    /usr/local/lib/* or /usr/local/lib64/* or /usr/local/sbin/* or /usr/sbin/*\n  ) and (\n    /*/.* or /dev/shm/* or /home/* or /root/* or /tmp/* or /var/tmp/*\n  ) and\n  not (/usr/bin/coreutils or /tmp/mkinitcpio* or /var/tmp/dracut* or /var/tmp/mkinitramfs*)\n)", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_symlink_binary_to_writable_dir.toml"}
{"title": "Suspicious Kernel Feature Activity", "description": "This rule detects the modification and reading of kernel features through built-in commands. Attackers may collect\ninformation, disable or weaken Linux kernel protections. For example, an attacker may modify ASLR protection by\ndisabling kernel.randomize_va_space, allow ptrace by setting kernel.yama.ptrace_scope to 0, or disable the\nNMI watchdog by setting kernel.nmi_watchdog to 0. These changes may be used to impair defenses and evade detection.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.command_line : (\n  \"*/etc/sysctl.conf*\", \"*/etc/sysctl.d/*\", \"*/proc/sys/kernel/nmi_watchdog*\",\n  \"*/proc/sys/vm/nr_hugepages*\", \"*/proc/sys/kernel/yama/ptrace_scope*\",\n  \"*/proc/sys/kernel/randomize_va_space*\", \"*/proc/sys/vm/drop_caches*\",\n  \"*/proc/sys/kernel/sysrq*\", \"*grsecurity*\", \"*exec-shield*\",\n  \"*kernel.randomize_va_space*\", \"*kernel.yama.ptrace_scope*\",\n  \"*kernel.nmi_watchdog*\", \"*vm.nr_hugepages*\", \"*vm.drop_caches*\",\n  \"*kernel.sysrq*\"\n) and\nprocess.parent.executable != null and \n(\n  (process.name == \"tee\" and process.args like \"-*a*\") or // also detects --append\n  (process.name == \"cat\" and not process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")) or\n  (process.name == \"grep\" and process.args_count == 3 and not process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")) or\n  (process.name == \"sysctl\" and process.args like (\"*-w*\", \"*--write*\", \"*=*\")) or\n  (process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"-c\" and process.args : \"*echo *\")\n)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sysctl_kernel_feature_activity.toml"}
{"title": "Unusual Preload Environment Variable Process Execution", "description": "This rule detects processes that are executed with environment variables that are not commonly used. This could indicate\nan attacker is attempting to hijack the execution flow of a process by loading malicious libraries or binaries into the\nprocess memory space.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and process.env_vars:*", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_preload_env_vars.toml"}
{"title": "File Creation in /var/log via Suspicious Process", "description": "This rule detects the creation of files in the /var/log/ directory via process executables located in\nworld-writeable locations or via hidden processes. Attackers may attempt to hide their activities by\ncreating files in the /var/log/ directory, which is commonly used for logging system events.", "query": "event.category:file and host.os.type:linux and event.action:(creation or file_create_event or file_rename_event or rename) and\n(process.executable:(/tmp/* or /var/tmp/* or /dev/shm/* or ./* or /boot/*) or process.name:.*) and\nfile.path:/var/log/* and not file.extension:*", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_var_log_file_creation_by_unsual_process.toml"}
{"title": "Docker Socket Enumeration", "description": "This rule detects potential Docker socket enumeration activity by monitoring processes that attempt to interact with the\nDocker socket file (/var/run/docker.sock). Docker socket enumeration is a common technique used by attackers to interact\nwith the Docker daemon and perform various operations, such as creating, starting, stopping, and removing containers.\nAttackers may abuse Docker socket enumeration to gain unauthorized access to the host system, escalate privileges, or\nmove laterally within the environment.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name in (\"curl\", \"socat\", \"nc\", \"netcat\", \"ncat\", \"nc.traditional\") and\nprocess.command_line like (\"*/var/run/docker.sock*\", \"*/run/docker.sock*\")", "tactic": "Discovery", "technique": "Container and Resource Discovery", "technique_id": "T1613", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_docker_socket_discovery.toml"}
{"title": "Suspicious Dynamic Linker Discovery via od", "description": "Monitors for dynamic linker discovery via the od utility. od (octal dump) is a command-line utility in Unix operating\nsystems used for displaying data in various formats, including octal, hexadecimal, decimal, and ASCII, primarily used\nfor examining and debugging binary files or data streams. Attackers can leverage od to analyze the dynamic linker by\nidentifying injection points and craft exploits based on the observed behaviors and structures within these files.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"od\" and process.args in (\n  \"/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/etc/ld.so.preload\", \"/lib64/ld-linux-x86-64.so.2\",\n  \"/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/usr/lib64/ld-linux-x86-64.so.2\"\n)", "tactic": "Discovery", "technique": "Process Discovery", "technique_id": "T1057", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_dynamic_linker_via_od.toml"}
{"title": "ESXI Discovery via Find", "description": "Identifies instances where the 'find' command is started on a Linux system with arguments targeting specific VM-related\npaths, such as \"/etc/vmware/\", \"/usr/lib/vmware/\", or \"/vmfs/*\". These paths are associated with VMware virtualization\nsoftware, and their presence in the find command arguments may indicate that a threat actor is attempting to search for,\nanalyze, or manipulate VM-related files and configurations on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n  process.name == \"find\" and process.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\") and\n  not process.parent.executable == \"/usr/lib/vmware/viewagent/bin/uninstall_viewagent.sh\"", "tactic": "Discovery", "technique": "Software Discovery", "technique_id": "T1518", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_esxi_software_via_find.toml"}
{"title": "ESXI Discovery via Grep", "description": "Identifies instances where a process named 'grep', 'egrep', or 'pgrep' is started on a Linux system with arguments\nrelated to virtual machine (VM) files, such as \"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", or\n\"vmem\". These file extensions are associated with VM-related file formats, and their presence in grep command arguments\nmay indicate that a threat actor is attempting to search for, analyze, or manipulate VM files on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"executed\", \"process_started\") and\n  process.name in (\"grep\", \"egrep\", \"pgrep\") and\n  process.args in (\"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", \"vmem\") and\n  not process.parent.executable == \"/usr/share/qemu/init/qemu-kvm-init\"", "tactic": "Discovery", "technique": "Software Discovery", "technique_id": "T1518", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_esxi_software_via_grep.toml"}
{"title": "Enumeration of Kernel Modules", "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They\nextend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate\ninformation about a kernel module.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:(exec or exec_event) and (\n (process.name:(lsmod or modinfo)) or\n (process.name:kmod and process.args:list) or\n (process.name:depmod and process.args:(--all or -a))\n) and\nnot (\n  process.parent.name:(\n    mkinitramfs or cryptroot or framebuffer or dracut or jem or thin-provisioning-tools or readykernel or lvm2 or\n    vz-start or iscsi or mdadm or ovalprobes or bcache or plymouth or dkms or overlayroot or weak-modules or zfs or\n    systemd or whoopsie-upload-all or kdumpctl or apport-gtk or casper or rear or kernel-install or newrelic-infra\n  ) or\n  process.parent.executable:/var/lib/dpkg/info/linux-modules*-generic.post*\n)", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_kernel_module_enumeration.toml"}
{"title": "Kernel Seeking Activity", "description": "This rule detects kernel seeking activity through several built-in Linux utilities. Attackers may use these utilities\nto search the Linux kernel for available symbols, functions, and other information that can be used to exploit the\nkernel.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n(process.parent.args like \"/boot/*\" or process.args like \"/boot/*\") and (\n  (process.name == \"tail\" and (process.args like \"-c*\" or process.args == \"--bytes\")) or\n  (process.name == \"cmp\" and process.args == \"-i\") or\n  (process.name in (\"hexdump\", \"xxd\") and process.args == \"-s\") or\n  (process.name == \"dd\" and process.args like \"seek*\")\n)", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_kernel_seeking.toml"}
{"title": "Kernel Unpacking Activity", "description": "This rule detects kernel unpacking activity through several built-in Linux utilities. Attackers may use these utilities\nto unpack kernel images and modules to search for vulnerabilities or to modify the kernel.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n(process.parent.args like \"/boot/*\" or process.args like \"/boot/*\") and (\n  (process.name in (\"file\", \"unlzma\", \"gunzip\", \"unxz\", \"bunzip2\", \"unzstd\", \"unzip\", \"tar\")) or\n  (process.name == \"grep\" and process.args == \"ELF\") or\n  (process.name in (\"lzop\", \"lz4\") and process.args in (\"-d\", \"--decode\"))\n) and\nnot process.parent.name == \"mkinitramfs\"", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_kernel_unpacking.toml"}
{"title": "Kubeconfig File Discovery", "description": "The kubeconfig file is a critical component in Kubernetes environments, containing configuration\ndetails for accessing and managing Kubernetes clusters. Attackers may attempt to get access to,\ncreate, or modify kubeconfig files to gain unauthorized initial access to Kubernetes clusters or\nmove laterally within the cluster. This rule detects process discovery executions that involve\nkubeconfig files, particularly those executed from common shell environments or world-writeable\ndirectories.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") or\n  (\n    process.parent.executable like (\"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/root/*\", \"/home/*\") or\n    process.parent.name like (\".*\", \"*.sh\")\n  )\n) and\n(\n  (\n    process.working_directory like (\"/etc/kubernetes\", \"/root/.kube\", \"/home/*/.kube\") and\n    process.args in (\"kubeconfig\", \"admin.conf\", \"super-admin.conf\", \"kubelet.conf\", \"controller-manager.conf\", \"scheduler.conf\")\n  ) or\n  process.args like (\n    \"/etc/kubernetes/admin.conf\",\n    \"/etc/kubernetes/super-admin.conf\",\n    \"/etc/kubernetes/kubelet.conf\",\n    \"/etc/kubernetes/controller-manager.conf\",\n    \"/etc/kubernetes/scheduler.conf\",\n    \"/home/*/.kube/config\",\n    \"/root/.kube/config\",\n    \"/var/lib/*/kubeconfig\"\n  )\n) and not process.name in (\"stat\", \"md5sum\", \"dirname\")", "tactic": "Discovery", "technique": "Container and Resource Discovery", "technique_id": "T1613", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_kubeconfig_file_discovery.toml"}
{"title": "Kubectl Permission Discovery", "description": "This rule detects the use of the \"kubectl auth --can-i\" command, which is used to check permissions in Kubernetes clusters.\nAttackers may use this command to enumerate permissions and discover potential misconfigurations in the cluster, allowing\nthem to gain unauthorized access or escalate privileges.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"kubectl\" and process.args == \"auth\" and process.args == \"can-i\"", "tactic": "Discovery", "technique": "Container and Resource Discovery", "technique_id": "T1613", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_kubectl_permission_discovery.toml"}
{"title": "Hping Process Activity", "description": "Hping ran on a Linux host. Hping is a FOSS command-line packet analyzer and has the ability to construct network packets\nfor a wide variety of network security testing applications, including scanning and firewall auditing.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name in (\"hping\", \"hping2\", \"hping3\")", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_linux_hping_activity.toml"}
{"title": "Nping Process Activity", "description": "Nping ran on a Linux host. Nping is part of the Nmap tool suite and has the ability to construct raw packets for a wide\nvariety of security testing applications, including denial of service testing.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name == \"nping\"", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_linux_nping_activity.toml"}
{"title": "Manual Mount Discovery via /etc/exports or /etc/fstab", "description": "This rule detects manual mount discovery via the /etc/exports or /etc/fstab file on Linux systems. These files are used\nby NFS (Network File System) to define which directories are shared with remote hosts. Attackers may access this\nfile to gather information about shared directories and potential targets for further exploitation.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"cat\", \"grep\", \"tail\", \"less\", \"more\", \"egrep\", \"fgrep\") and process.command_line like (\"/etc/exports\", \"/etc/fstab\")", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_manual_mount_discovery_via_exports_or_fstab.toml"}
{"title": "Pluggable Authentication Module (PAM) Version Discovery", "description": "This rule detects PAM version discovery activity on Linux systems. PAM version discovery can be an indication of an\nattacker attempting to backdoor the authentication process through malicious PAM modules.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.parent.name != null and\n  (\n    (process.name in (\"dpkg\", \"dpkg-query\") and process.args == \"libpam-modules\") or\n    (process.name == \"rpm\" and process.args == \"pam\")\n  ) and\nnot process.parent.name in (\"dcservice\", \"inspectorssmplugin\")", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_pam_version_discovery.toml"}
{"title": "Potential Network Scan Executed From Host", "description": "This threshold rule monitors for the rapid execution of unix utilities that are capable of conducting network scans.\nAdversaries may leverage built-in tools such as ping, netcat or socat to execute ping sweeps across the network while\nattempting to evade detection or due to the lack of network mapping tools available on the compromised host.", "query": "event.category:process and host.os.type:linux and event.action:(exec or exec_event or executed or process_started) and\nevent.type:start and process.name:(ping or nping or hping or hping2 or hping3 or nc or ncat or netcat or socat)", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ping_sweep_detected.toml"}
{"title": "Polkit Version Discovery", "description": "This rule detects Polkit version discovery activity on Linux systems. Polkit version discovery can be an indication of\nan attacker attempting to exploit misconfigurations or vulnerabilities in the Polkit service.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and (\n  (process.name == \"dnf\" and process.args == \"dnf\" and process.args == \"info\" and process.args == \"polkit\") or\n  (process.name == \"rpm\" and process.args == \"polkit\") or\n  (process.name == \"apt\" and process.args == \"show\" and process.args == \"policykit-1\") or\n  (process.name == \"pkaction\" and process.args == \"--version\")\n)", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_polkit_version_discovery.toml"}
{"title": "Potential Port Scanning Activity from Compromised Host", "description": "This rule detects potential port scanning activity from a compromised host. Port scanning is a common reconnaissance\ntechnique used by attackers to identify open ports and services on a target system. A compromised host may exhibit port\nscanning behavior when an attacker is attempting to map out the network topology, identify vulnerable services, or\nprepare for further exploitation. This rule identifies potential port scanning activity by monitoring network connection\nattempts from a single host to a large number of ports within a short time frame. ES|QL rules have limited fields\navailable in its alert documents. Make sure to review the original documents to aid in the investigation of this alert.", "query": "from logs-endpoint.events.network-*\n| keep @timestamp, host.os.type, event.type, event.action, destination.port, process.executable, destination.ip, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\"\n| stats cc = count(), port_count = count_distinct(destination.port), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.executable, destination.ip\n| where agent_count == 1 and port_count > 100\n| sort cc asc\n| limit 100", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_port_scanning_activity_from_compromised_host.toml"}
{"title": "Private Key Searching Activity", "description": "This rule detects private key searching activity on Linux systems. Searching for private keys can be an indication of an\nattacker attempting to escalate privileges or exfiltrate sensitive information.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.name == \"find\" and\n  process.command_line like (\"*id_dsa*\", \"*id_rsa*\", \"*id_ed*\", \"*id_ecdsa*\", \"*id_xmss*\", \"*id_dh*\") and\n  process.command_line like (\"*/home/*\", \"*/etc/ssh*\", \"*/root/*\", \"/\")", "tactic": "Discovery", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_private_key_password_searching_activity.toml"}
{"title": "Process Capability Enumeration", "description": "Identifies recursive process capability enumeration of the entire filesystem through the getcap command. Malicious users\nmay manipulate identified capabilities to gain root privileges.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"ProcessRollup2\") and\n  process.name == \"getcap\" and process.args == \"-r\" and process.args == \"/\" and\n  process.args_count == 3 and user.id != \"0\"", "tactic": "Discovery", "technique": "Process Discovery", "technique_id": "T1057", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_process_capabilities.toml"}
{"title": "Suspicious /proc/maps Discovery", "description": "Monitors for /proc/*/maps file reads. The /proc/*/maps file in Linux provides a memory map for a specific process,\ndetailing the memory segments, permissions, and what files are mapped to these segments. Attackers may read a process's\nmemory map to identify memory addresses for code injection or process hijacking.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name in (\"cat\", \"grep\", \"tail\", \"less\", \"more\", \"egrep\", \"fgrep\") and process.args like \"/proc/*/maps\"", "tactic": "Discovery", "technique": "Process Discovery", "technique_id": "T1057", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_proc_maps_read.toml"}
{"title": "Potential Pspy Process Monitoring Detected", "description": "This rule leverages auditd to monitor for processes scanning different processes within the /proc directory using the\nopenat syscall. This is a strong indication for the usage of the pspy utility. Attackers may leverage the pspy process\nmonitoring utility to monitor system processes without requiring root permissions, in order to find potential privilege\nescalation vectors.", "query": "sequence by process.pid, host.id with maxspan=5s\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"openat\" and file.path == \"/proc\" and\n   auditd.data.a0 : (\"ffffffffffffff9c\", \"ffffff9c\") and auditd.data.a2 : (\"80000\", \"88000\") and\n   not process.name in (\"agentbeat\", \"packetbeat\")\n  ] with runs=10", "tactic": "Discovery", "technique": "Process Discovery", "technique_id": "T1057", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_pspy_process_monitoring_detected.toml"}
{"title": "Security File Access via Common Utilities", "description": "This rule detects sensitive security file access via common utilities on Linux systems. Adversaries may attempt to read\nfrom sensitive files using common utilities to gather information about the system and its security configuration.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name in (\"cat\", \"grep\", \"less\", \"more\", \"strings\", \"awk\", \"find\", \"xargs\") and\n  process.args like (\n    \"/etc/security/*\", \"/etc/pam.d/*\", \"/etc/login.defs\", \"/lib/security/*\", \"/lib64/security/*\",\n    \"/usr/lib/security/*\", \"/usr/lib64/security/*\", \"/usr/lib/x86_64-linux-gnu/security/*\",\n    \"/home/*/.aws/credentials\", \"/home/*/.aws/config\", \"/home/*/.config/gcloud/*credentials.json\",\n    \"/home/*/.config/gcloud/configurations/config_default\", \"/home/*/.azure/accessTokens.json\",\n    \"/home/*/.azure/azureProfile.json\"\n  ) and \nnot process.parent.name in (\"wazuh-modulesd\", \"lynis\")", "tactic": "Discovery", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_security_file_access_via_common_utility.toml"}
{"title": "Potential Subnet Scanning Activity from Compromised Host", "description": "This rule detects potential subnet scanning activity from a compromised host. Subnet scanning is a common reconnaissance\ntechnique used by attackers to identify live hosts within a network range. A compromised host may exhibit subnet\nscanning behavior when an attacker is attempting to map out the network topology, identify vulnerable hosts, or prepare\nfor further exploitation. This rule identifies potential subnet scanning activity by monitoring network connection\nattempts from a single host to a large number of hosts within a short time frame. ES|QL rules have limited fields\navailable in its alert documents. Make sure to review the original documents to aid in the investigation of this alert.", "query": "from logs-endpoint.events.network-*\n| keep @timestamp, host.os.type, event.type, event.action, process.executable, destination.ip, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\"\n| stats cc = count(), dest_count = count_distinct(destination.ip), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.executable\n| where agent_count == 1 and dest_count > 250\n| sort cc asc\n| limit 100", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_subnet_scanning_activity_from_compromised_host.toml"}
{"title": "Sudo Command Enumeration Detected", "description": "This rule monitors for the usage of the sudo -l command, which is used to list the allowed and forbidden commands for\nthe invoking user. Attackers may execute this command to enumerate commands allowed to be executed with sudo\npermissions, potentially allowing to escalate privileges to root.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.name == \"sudo\" and process.args == \"-l\" and\n  process.args_count == 2 and process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  not process.args == \"dpkg\"", "tactic": "Discovery", "technique": "System Owner/User Discovery", "technique_id": "T1033", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_sudo_allowed_command_enumeration.toml"}
{"title": "SUID/SGUID Enumeration Detected", "description": "This rule monitors for the usage of the \"find\" command in conjunction with SUID and SGUID permission arguments. SUID\n(Set User ID) and SGID (Set Group ID) are special permissions in Linux that allow a program to execute with the\nprivileges of the file owner or group, respectively, rather than the privileges of the user running the program. In case\nan attacker is able to enumerate and find a binary that is misconfigured, they might be able to leverage this\nmisconfiguration to escalate privileges by exploiting vulnerabilities or built-in features in the privileged program.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"find\" and process.args : \"-perm\" and process.args : (\n  \"/6000\", \"-6000\", \"/4000\", \"-4000\", \"/2000\", \"-2000\", \"/u=s\", \"-u=s\", \"/g=s\", \"-g=s\", \"/u=s,g=s\", \"/g=s,u=s\"\n) and not (\n  user.Ext.real.id == \"0\" or group.Ext.real.id == \"0\" or process.args_count >= 12 or\n  (process.args : \"/usr/bin/pkexec\" and process.args : \"-xdev\" and process.args_count == 7)\n)", "tactic": "Discovery", "technique": "File and Directory Discovery", "technique_id": "T1083", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_suid_sguid_enumeration.toml"}
{"title": "Suspicious Memory grep Activity", "description": "Monitors for grep activity related to memory mapping. The /proc/*/maps file in Linux provides a memory map for a\nspecific process, detailing the memory segments, permissions, and what files are mapped to these segments. Attackers may\nread a process's memory map to identify memory addresses for code injection or process hijacking.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name in (\"grep\", \"egrep\", \"fgrep\", \"rgrep\") and process.args in (\"[stack]\", \"[vdso]\", \"[heap]\")", "tactic": "Discovery", "technique": "Process Discovery", "technique_id": "T1057", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_suspicious_memory_grep_activity.toml"}
{"title": "Suspicious Network Tool Launched Inside A Container", "description": "This rule detects commonly abused network utilities running inside a container. Network utilities like nc, nmap, dig,\ntcpdump, ngrep, telnet, mitmproxy, zmap can be used for malicious purposes such as network reconnaissance, monitoring,\nor exploitation, and should be monitored closely within a container.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\n  \"nc.traditional\", \"nc\", \"ncat\", \"netcat\", \"nmap\", \"dig\", \"nslookup\", \"tcpdump\", \"tshark\", \"ngrep\", \"telnet\",\n  \"mitmproxy\", \"socat\", \"zmap\", \"masscan\", \"zgrab\"\n)", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_suspicious_network_tool_launched_inside_container.toml"}
{"title": "Suspicious which Enumeration", "description": "This rule monitors for the usage of the which command with an unusual amount of process arguments. Attackers may\nleverage the which command to enumerate the system for useful installed utilities that may be used after compromising a\nsystem to escalate privileges or move latteraly across the network.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\") and\n  process.name == \"which\" and process.args_count >= 10 and not (\n    process.parent.name == \"jem\" or\n    process.parent.executable like (\"/vz/root/*\", \"/var/lib/docker/*\") or\n    process.args == \"--tty-only\"\n  )\n\n/* potential tuning if rule would turn out to be noisy\nand process.args in (\"nmap\", \"nc\", \"ncat\", \"netcat\", nc.traditional\", \"gcc\", \"g++\", \"socat\") and\nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n*/", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_suspicious_which_command_execution.toml"}
{"title": "Unusual User Privilege Enumeration via id", "description": "This rule monitors for a sequence of 20 \"id\" command executions within 1 second by the same parent process. This\nbehavior is unusual, and may be indicative of the execution of an enumeration script such as LinPEAS or LinEnum. These\nscripts leverage the \"id\" command to enumerate the privileges of all users present on the system.", "query": "sequence by host.id, process.parent.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"id\" and process.args_count == 2 and\n   not (\n     process.parent.name in (\"rpm\", \"snarftmp\", \"quota_copy\", \"java\") or\n     process.parent.args : \"/var/tmp/rpm-tmp*\"\n    )] with runs=20", "tactic": "Discovery", "technique": "System Owner/User Discovery", "technique_id": "T1033", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_unusual_user_enumeration_via_id.toml"}
{"title": "Virtual Machine Fingerprinting", "description": "An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies\ncommon locations used to discover virtual machine hardware by a non-root user. This technique has been used by the Pupy\nRAT and other malware.", "query": "event.category:process and host.os.type:linux and event.type:(start or process_started) and\n  process.args:(\"/sys/class/dmi/id/bios_version\" or\n                \"/sys/class/dmi/id/product_name\" or\n                \"/sys/class/dmi/id/chassis_vendor\" or\n                \"/proc/scsi/scsi\" or\n                \"/proc/ide/hd0/model\") and\n  not user.name:root", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_virtual_machine_fingerprinting.toml"}
{"title": "Yum/DNF Plugin Status Discovery", "description": "This rule detects the execution of the `grep` command with the `plugins` argument on Linux systems. This command is used\nto search for YUM/DNF configurations and/or plugins with an enabled state. This behavior may indicate an attacker is\nattempting to establish persistence in a YUM or DNF plugin.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name == \"grep\" and process.args : \"plugins*\" and process.args : (\n    \"/etc/yum.conf\", \"/usr/lib/yum-plugins/*\", \"/etc/yum/pluginconf.d/*\",\n    \"/usr/lib/python*/site-packages/dnf-plugins/*\", \"/etc/dnf/plugins/*\", \"/etc/dnf/dnf.conf\"\n  )", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_yum_dnf_plugin_detection.toml"}
{"title": "Abnormal Process ID or Lock File Created", "description": "Identifies the creation of a Process ID (PID), lock or reboot file created in temporary file storage paradigm (tmpfs)\ndirectory /var/run. On Linux, the PID files typically hold the process ID to track previous copies running and manage\nother tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising\nitself or these files as legitimate PID files.", "query": "host.os.type:linux and event.category:file and event.action:(creation or file_create_event) and\nfile.extension:(pid or lock or reboot) and file.path:(/var/run/* or /run/*) and (\n  (process.name : (\n    bash or dash or sh or tcsh or csh or zsh or ksh or fish or ash or touch or nano or vim or vi or editor or mv or cp)\n  ) or (\n  process.executable : (\n    ./* or /tmp/* or /var/tmp/* or /dev/shm/* or /var/run/* or /boot/* or /srv/* or /run/*\n  ))\n) and not (\n  process.executable : (\n  /tmp/newroot/* or /run/containerd/* or /run/k3s/containerd/* or /run/k0s/container* or /snap/* or /vz/* or\n  /var/lib/docker/* or /etc/*/universal-hooks/pkgs/mysql-community-server/* or /var/lib/snapd/* or /etc/rubrik/* or\n  /run/udev/data/*\n  ) or\n  process.name : (\n    go or git or containerd* or snap-confine or cron or crond or sshd or unattended-upgrade or vzctl or ifup or\n    rpcbind or runc or gitlab-runner-helper or elastic-agent or metricbeat or redis-server or libvirt_leaseshelper or\n    s6-ipcserver-socketbinder or xinetd or libvirtd or veeamdeploymentsvc  or dnsmasq or virtlogd or lynis or\n    veeamtransport\n  ) or\n  file.name : (\n    jem.*.pid or lynis.pid or redis.pid or yum.pid or MFS.pid or jenkins.pid or nvmupdate.pid or openlitespeed.pid or\n    rhnsd.pid\n  ) or\n  file.path : (/run/containerd/* or /var/run/docker/containerd/* or /var/run/jem*.pid)\n)", "tactic": "Execution", "technique": "Native API", "technique_id": "T1106", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_abnormal_process_id_file_created.toml"}
{"title": "Container Management Utility Run Inside A Container", "description": "This rule detects when a container management binary is run from inside a container. These binaries are critical\ncomponents of many containerized environments, and their presence and execution in unauthorized containers could\nindicate compromise or a misconfiguration.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.interactive == true and\nprocess.name in (\"dockerd\", \"docker\", \"kubelet\", \"kube-proxy\", \"kubectl\", \"containerd\", \"systemd\", \"crictl\") and\nnot process.parent.executable in (\"/sbin/init\", \"/usr/bin/dockerd\")", "tactic": "Execution", "technique": "Container Administration Command", "technique_id": "T1609", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_container_management_binary_launched_inside_container.toml"}
{"title": "File Creation by Cups or Foomatic-rip Child", "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects suspicious file creation events\nexecuted by child processes of foomatic-rip. These flaws impact components like cups-browsed, libcupsfilters, libppd,\nand foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through\ncrafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.", "query": "sequence by host.id with maxspan=10s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name == \"foomatic-rip\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.entity_id\n  [file where host.os.type == \"linux\" and event.type != \"deletion\" and\n   not (process.name == \"gs\" and file.path like \"/tmp/gs_*\")] by process.parent.entity_id", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_cupsd_foomatic_rip_file_creation.toml"}
{"title": "Printer User (lp) Shell Execution", "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects shell executions from the foomatic-rip\nparent process through the default printer user (lp). These flaws impact components like cups-browsed, libcupsfilters,\nlibppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data\nthrough crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is\ninitiated.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\") and user.name == \"lp\" and\n  process.parent.name in (\"cupsd\", \"foomatic-rip\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n    process.command_line like (\n      \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n      \"/bin/bash -e -c cat\"\n    ) or\n    process.args like \"gs*\"\n  )", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_cupsd_foomatic_rip_lp_user_execution.toml"}
{"title": "Cupsd or Foomatic-rip Shell Execution", "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects shell executions from the\nfoomatic-rip parent process. These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip,\nallowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or\nnetwork spoofing. This can result in arbitrary command execution when a print job is initiated.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and process.parent.name == \"foomatic-rip\" and\n  process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n    process.command_line like (\n      \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n      \"/bin/bash -e -c cat\"\n    ) or\n    process.args like \"gs*\"\n  )", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_cupsd_foomatic_rip_shell_execution.toml"}
{"title": "Suspicious Execution from Foomatic-rip or Cupsd Parent", "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176,\nCVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects suspicious process command lines\nexecuted by child processes of foomatic-rip and cupsd. These flaws impact components like cups-browsed, libcupsfilters,\nlibppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data\nthrough crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is\ninitiated.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.parent.name in (\"foomatic-rip\", \"cupsd\") and process.command_line like (\n  // persistence\n  \"*cron*\", \"*/etc/rc.local*\", \"*/dev/tcp/*\", \"*/etc/init.d*\", \"*/etc/update-motd.d*\", \"*/etc/sudoers*\",\n  \"*/etc/profile*\", \"*autostart*\", \"*/etc/ssh*\", \"*/home/*/.ssh/*\", \"*/root/.ssh*\", \"*~/.ssh/*\", \"*udev*\",\n  \"*/etc/shadow*\", \"*/etc/passwd*\",\n\n  // Downloads\n  \"*curl*\", \"*wget*\",\n\n  // encoding and decoding\n  \"*base64 *\", \"*base32 *\", \"*xxd *\", \"*openssl*\",\n\n  // reverse connections\n  \"*GS_ARGS=*\", \"*/dev/tcp*\", \"*/dev/udp/*\", \"*import*pty*spawn*\", \"*import*subprocess*call*\", \"*TCPSocket.new*\",\n  \"*TCPSocket.open*\", \"*io.popen*\", \"*os.execute*\", \"*fsockopen*\", \"*disown*\", \"*nohup*\",\n\n  // SO loads\n  \"*openssl*-engine*.so*\", \"*cdll.LoadLibrary*.so*\", \"*ruby*-e**Fiddle.dlopen*.so*\", \"*Fiddle.dlopen*.so*\",\n  \"*cdll.LoadLibrary*.so*\",\n\n  // misc. suspicious command lines\n   \"*/etc/ld.so*\", \"*/dev/shm/*\", \"*/var/tmp*\", \"*echo*\", \"*>>*\", \"*|*\"\n) and not process.args like \"gs*\"", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_cupsd_foomatic_rip_suspicious_child_execution.toml"}
{"title": "Potential curl CVE-2023-38545 Exploitation", "description": "Detects potential exploitation of curl CVE-2023-38545 by monitoring for vulnerable command line arguments in conjunction\nwith an unusual command line length. A flaw in curl version <= 8.3 makes curl vulnerable to a heap based buffer overflow\nduring the SOCKS5 proxy handshake. Upgrade to curl version >= 8.4 to patch this vulnerability. This exploit can be\nexecuted with and without the use of environment variables. For increased visibility, enable the collection of\nhttp_proxy, HTTPS_PROXY and ALL_PROXY environment variables based on the instructions provided in the setup guide of\nthis rule.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\"\nand (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or\n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n) and length(process.command_line) > 255 and not (\n  process.parent.name in (\"cf-agent\", \"agent-run\", \"agent-check\", \"rudder\", \"agent-inventory\", \"cf-execd\") or\n  process.args like \"/opt/rudder/*\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/rudder/*\")\n)", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_curl_cve_2023_38545_heap_overflow.toml"}
{"title": "Egress Connection from Entrypoint in Container", "description": "This rule identifies a sequence of events where a process named `entrypoint.sh` is started in a container, followed by a\nnetwork connection attempt. This sequence indicates a potential egress connection from an entrypoint in a container. An\nentrypoint is a command or script specified in the Dockerfile and executed when the container starts. Attackers can use\nthis technique to establish a foothold in the environment, escape from a container to the host, or establish persistence.", "query": "sequence by host.id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.entry_leader.entry_meta.type == \"container\" and process.name == \"entrypoint.sh\"] by process.entity_id\n  [network where event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\", \"172.31.0.0/16\"\n       )\n    )] by process.parent.entity_id", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_egress_connection_from_entrypoint_in_container.toml"}
{"title": "Process Started with Executable Stack", "description": "This rule monitors the syslog log file for messages related to instances of processes that are started with an executable\nstack. This can be an indicator of a process that is attempting to execute code from the stack, which can be a security risk.", "query": "host.os.type:\"linux\" and event.dataset:\"system.syslog\" and process.name:\"kernel\" and\nmessage:\"started with executable stack\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_executable_stack_execution.toml"}
{"title": "File Creation, Execution and Self-Deletion in Suspicious Directory", "description": "This rule monitors for the creation of a file, followed by its execution and self-deletion in a short timespan within a\ndirectory often used for malicious purposes by threat actors. This behavior is often used by malware to execute\nmalicious code and delete itself to hide its tracks.", "query": "sequence by host.id, user.id with maxspan=1m\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   process.name in (\"curl\", \"wget\", \"fetch\", \"ftp\", \"sftp\", \"scp\", \"rsync\", \"ld\") and\n   file.path : (\"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\",\n     \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\")] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.parent.executable like (\n     \"/tmp/VeeamApp*\", \"/tmp/rajh/spack-stage/*\", \"plz-out/bin/vault/bridge/test/e2e/base/bridge-dev\",\n     \"/usr/bin/ranlib\", \"/usr/bin/ar\", \"plz-out/bin/vault/bridge/test/e2e/base/local-k8s\"\n   )] by process.name\n  [file where host.os.type == \"linux\" and event.action == \"deletion\" and\n   file.path : (\n     \"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\", \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\"\n    ) and not process.name in (\"rm\", \"ld\", \"conftest\", \"link\", \"gcc\", \"getarch\", \"ld\")] by file.name", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_file_execution_followed_by_deletion.toml"}
{"title": "File Made Executable via Chmod Inside A Container", "description": "This rule detects when chmod or chown are used to add the execute permission to a file inside a container. Modifying file\npermissions to make a file executable could indicate malicious activity, as an attacker may attempt to run unauthorized\nor malicious code inside the container.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\"chmod\", \"chown\") and\nprocess.args in (\"4755\", \"755\", \"000\", \"777\", \"444\", \"-x\", \"+x\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_file_made_executable_via_chmod_inside_container.toml"}
{"title": "File Transfer or Listener Established via Netcat", "description": "A netcat process is engaging in network activity on a Linux host. Netcat is often used as a persistence mechanism by\nexporting a reverse shell or by serving a shell on a listening port. Netcat is also sometimes used for data\nexfiltration.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and\n      process.name:(\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\") and (\n          /* bind shell to echo for command execution */\n          (process.args:(\"-l\",\"-p\") and process.args:(\"-c\",\"echo\",\"$*\"))\n          /* bind shell to specific port */\n          or process.args:(\"-l\",\"-p\",\"-lp\")\n          /* reverse shell to command-line interpreter used for command execution */\n          or (process.args:(\"-e\") and process.args:(\"/bin/bash\",\"/bin/sh\"))\n          /* file transfer via stdout */\n          or process.args:(\">\",\"<\")\n          /* file transfer via pipe */\n          or (process.args:(\"|\") and process.args:(\"nc\",\"ncat\"))\n      ) and\n      not process.command_line like~ (\"*127.0.0.1*\", \"*localhost*\")]\n  [network where host.os.type == \"linux\" and (process.name == \"nc\" or process.name == \"ncat\" or process.name == \"netcat\" or\n                  process.name == \"netcat.openbsd\" or process.name == \"netcat.traditional\")]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_file_transfer_or_listener_established_via_netcat.toml"}
{"title": "Potential Upgrade of Non-interactive Shell", "description": "Identifies when a non-interactive terminal (tty) is being upgraded to a fully interactive shell. Attackers may upgrade a\nsimple reverse shell to a fully interactive tty after obtaining initial access to a host, in order to obtain a more\nstable connection.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name == \"stty\" and process.args == \"raw\" and process.args == \"-echo\" and process.args_count >= 3) or\n    (process.name == \"script\" and process.args in (\"-qc\", \"-c\") and process.args == \"/dev/null\" and\n    process.args_count == 4)\n  )", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_interpreter_tty_upgrade.toml"}
{"title": "Netcat Listener Established via rlwrap", "description": "Monitors for the execution of a netcat listener via rlwrap. rlwrap is a 'readline wrapper', a small utility that uses\nthe GNU Readline library to allow the editing of keyboard input for any command. This utility can be used in conjunction\nwith netcat to gain a more stable reverse shell.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name == \"rlwrap\" and process.args in (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\", \"socat\") and\n  process.args : \"*l*\" and process.args_count >= 4", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_nc_listener_via_rlwrap.toml"}
{"title": "Network Connection from Binary with RWX Memory Region", "description": "Monitors for the execution of a unix binary with read, write and execute memory region permissions, followed by a\nnetwork connection. The mprotect() system call is used to change the access protections on a region of memory that has\nalready been allocated. This syscall allows a process to modify the permissions of pages in its virtual address space,\nenabling or disabling permissions such as read, write, and execute for those pages. RWX permissions on memory is in many\ncases overly permissive, and should (especially in conjunction with an outbound network connection) be analyzed\nthoroughly.", "query": "sample by host.id, process.pid, process.name\n  /* auditd.data.a2 == \"7\" translates to RWX memory region protection (PROT_READ | PROT_WRITE | PROT_EXEC) */\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"mprotect\" and auditd.data.a2 == \"7\" and\n   not process.name == \"httpd\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_netcon_from_rwx_mem_region_binary.toml"}
{"title": "Network Connection via Recently Compiled Executable", "description": "This rule monitors a sequence involving a program compilation event followed by its execution and a subsequent network\nconnection event. This behavior can indicate the set up of a reverse tcp connection to a command-and-control server.\nAttackers may spawn reverse shells to establish persistence onto a target system.", "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name in (\"gcc\", \"g++\", \"cc\")] by process.args\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and process.name == \"ld\"] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\"] by process.name\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.ip != null and not (\n     cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\") or\n     process.name in (\"simpleX\", \"conftest\", \"ssh\", \"python\", \"ispnull\", \"pvtui\", \"npreal2d\", \"ruby\", \"source\", \"ssh\")\n   )] by process.name", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_network_event_post_compilation.toml"}
{"title": "Interactive Terminal Spawned via Perl", "description": "Identifies when a terminal (tty) is spawned via Perl. Attackers may upgrade a simple reverse shell to a fully\ninteractive tty after obtaining initial access to a host.", "query": "event.category:process and host.os.type:linux and event.type:(start or process_started) and process.name:perl and\n  process.args:(\"exec \\\"/bin/sh\\\";\" or \"exec \\\"/bin/dash\\\";\" or \"exec \\\"/bin/bash\\\";\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_perl_tty_shell.toml"}
{"title": "Privileged Docker Container Creation", "description": "This rule leverages the new_terms rule type to identify the creation of a potentially unsafe docker container from an\nunusual parent process. Attackers can use the `--privileged` flag to create containers with escalated privileges, which\ncan lead to trivial privilege escalation, docker escaping and persistence. access.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:docker and\nprocess.args:(run and --privileged)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_potentially_overly_permissive_container_creation.toml"}
{"title": "Potential Linux Hack Tool Launched", "description": "Monitors for the execution of different processes that might be used by attackers for malicious intent. An alert from\nthis rule should be investigated further, as hack tools are commonly used by blue teamers and system administrators as\nwell.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\nprocess.name in~ (\n  // exploitation frameworks\n  \"crackmapexec\", \"msfconsole\", \"msfvenom\", \"sliver-client\", \"sliver-server\", \"havoc\",\n  // network scanners (nmap left out to reduce noise)\n  \"zenmap\", \"nuclei\", \"netdiscover\", \"legion\",\n  // web enumeration\n  \"gobuster\", \"dirbuster\", \"dirb\", \"wfuzz\", \"ffuf\", \"whatweb\", \"eyewitness\",\n  // web vulnerability scanning\n  \"wpscan\", \"joomscan\", \"droopescan\", \"nikto\",\n  // exploitation tools\n  \"sqlmap\", \"commix\", \"yersinia\",\n  // cracking and brute forcing\n  \"john\", \"hashcat\", \"hydra\", \"ncrack\", \"cewl\", \"fcrackzip\", \"rainbowcrack\",\n  // host and network\n  \"linenum.sh\", \"linpeas.sh\", \"pspy32\", \"pspy32s\", \"pspy64\", \"pspy64s\", \"binwalk\", \"evil-winrm\",\n  \"linux-exploit-suggester-2.pl\", \"linux-exploit-suggester.sh\", \"panix.sh\"\n)", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_potential_hack_tool_executed.toml"}
{"title": "Process Backgrounded by Unusual Parent", "description": "This rule identifies processes that are backgrounded by an unusual parent process. This behavior may indicate a process\nattempting to evade detection by hiding its parent process.", "query": "event.category:process and host.os.type:linux and event.type:start and\nevent.action:(ProcessRollup2 or exec or exec_event or start) and\nprocess.name:(bash or csh or dash or fish or ksh or sh or tcsh or zsh) and\nprocess.args:(-c and *&)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_process_backgrounded_by_unusual_parent.toml"}
{"title": "Process Started from Process ID (PID) File", "description": "Identifies a new process starting from a process ID (PID), lock or reboot file within the temporary file storage\nparadigm (tmpfs) directory /var/run directory. On Linux, the PID files typically hold the process ID to track previous\ncopies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables\nand other tasks, disguising itself or these files as legitimate PID files.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and user.id == \"0\" and\n  process.executable regex~ \"\"\"/var/run/\\w+\\.(pid|lock|reboot) \"\"\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_process_started_from_process_id_file.toml"}
{"title": "Binary Executed from Shared Memory Directory", "description": "Identifies the execution of a binary by root in Linux shared memory directories: (/dev/shm/, /run/shm/, /var/run/,\n/var/lock/). This activity is to be considered highly abnormal and should be investigated. Threat actors have placed\nexecutables used for persistence on high-uptime servers in these directories as system backdoors.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nuser.id == \"0\" and process.executable : (\"/dev/shm/*\", \"/run/shm/*\", \"/var/run/*\", \"/var/lock/*\") and\nnot process.executable : (\"/var/run/docker/*\", \"/var/run/utsns/*\", \"/var/run/s6/*\", \"/var/run/cloudera-scm-agent/*\",\n\"/var/run/argo/argoexec\") and not process.parent.command_line : \"/usr/bin/runc init\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_process_started_in_shared_memory_directory.toml"}
{"title": "Interactive Terminal Spawned via Python", "description": "Identifies when a terminal (tty) is spawned via Python. Attackers may upgrade a simple reverse shell to a fully\ninteractive tty after obtaining initial access to a host.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n(\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.parent.args_count >= 3 and process.parent.args : \"*pty.spawn*\" and process.parent.args : \"-c\") or\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.args : \"*sh\" and process.args_count == 1 and process.parent.args_count == 1)\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_python_tty_shell.toml"}
{"title": "Web Server Spawned via Python", "description": "This rule identifies when a web server is spawned via Python. Attackers may use Python to spawn a web server to\nexfiltrate/infiltrate data or to move laterally within a network.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name like \"python*\" and process.args in (\"http.server\", \"SimpleHTTPServer\")) or\n    (\n      process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n      process.command_line like~ \"*python* -m http.server*\"\n    )\n  )", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_python_webserver_spawned.toml"}
{"title": "Potential Code Execution via Postgresql", "description": "This rule monitors for suspicious activities that may indicate an attacker attempting to execute arbitrary code within a\nPostgreSQL environment. Attackers can execute code via PostgreSQL as a result of gaining unauthorized access to a public\nfacing PostgreSQL database or exploiting vulnerabilities, such as remote command execution and SQL injection attacks,\nwhich can result in unauthorized access and malicious actions, and facilitate post-exploitation activities for\nunauthorized access and malicious actions.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"fork\", \"fork_event\") and user.name == \"postgres\" and (\n  (process.parent.args : \"*sh\" and process.parent.args : \"echo*\") or\n  (process.args : \"*sh\" and process.args : \"echo*\")\n) and not (\n  process.parent.name == \"puppet\" or\n  process.command_line like (\n    \"*BECOME-SUCCESS-*\", \"bash -c while true; do sleep 1;*\", \"df -l\", \"sleep 1\", \"who\", \"head -v -n *\", \"tail -v -n *\",\n    \"/bin/sh -c echo BECOME-SUCCESS*\", \"/usr/bin/python3 /var/tmp/ansible-tmp*\"\n  ) or\n  process.parent.command_line like \"*BECOME-SUCCESS-*\"\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_remote_code_execution_via_postgresql.toml"}
{"title": "Linux Restricted Shell Breakout via Linux Binary(s)", "description": "Identifies the abuse of a Linux binary to break out of a restricted shell or environment by spawning an interactive\nsystem shell. The activity of spawning a shell from a binary is not common behavior for a user or system administrator,\nand may indicate an attempt to evade detection, increase capabilities or enhance the stability of an adversary.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n(\n  /* launching shell from capsh */\n  (process.name == \"capsh\" and process.args == \"--\") or\n\n  /* launching shells from unusual parents or parent+arg combos */\n  (process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n    (process.parent.name : \"*awk\" and process.parent.args : \"BEGIN {system(*)}\") or\n    (process.parent.name == \"git\" and process.parent.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") or\n     process.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") and not process.name == \"ssh\" ) or\n    (process.parent.name : (\"byebug\", \"ftp\", \"strace\", \"zip\", \"tar\") and\n    (\n      process.parent.args : \"BEGIN {system(*)}\" or\n      (process.parent.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") or process.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\")) or\n      (\n        (process.parent.args : \"exec=*sh\" or (process.parent.args : \"-I\" and process.parent.args : \"*sh\")) or\n        (process.args : \"exec=*sh\" or (process.args : \"-I\" and process.args : \"*sh\"))\n        )\n      )\n    ) or\n\n    /* shells specified in parent args */\n    /* nice rule is broken in 8.2 */\n    (process.parent.args : \"*sh\" and\n      (\n        (process.parent.name == \"nice\") or\n        (process.parent.name == \"cpulimit\" and process.parent.args == \"-f\") or\n        (process.parent.name == \"find\" and process.parent.args == \".\" and process.parent.args == \"-exec\" and\n         process.parent.args == \";\" and process.parent.args : \"/bin/*sh\") or\n        (process.parent.name == \"flock\" and process.parent.args == \"-u\" and process.parent.args == \"/\")\n      )\n    )\n  )) or\n\n  /* shells specified in args */\n  (process.args : \"*sh\" and (\n    (process.parent.name == \"crash\" and process.parent.args == \"-h\") or\n    (process.name == \"sensible-pager\" and process.parent.name in (\"apt\", \"apt-get\") and process.parent.args == \"changelog\")\n    /* scope to include more sensible-pager invoked shells with different parent process to reduce noise and remove false positives */\n\n  )) or\n  (process.name == \"busybox\" and event.action == \"exec\" and process.args_count == 2 and process.args : \"*sh\" and not\n   process.executable : \"/var/lib/docker/overlay2/*/merged/bin/busybox\" and not (process.parent.args == \"init\" and\n   process.parent.args == \"runc\") and not process.parent.args in (\"ls-remote\", \"push\", \"fetch\") and not process.parent.name == \"mkinitramfs\") or\n  (process.name == \"env\" and process.args_count == 2 and process.args : \"*sh\") or\n  (process.parent.name in (\"vi\", \"vim\") and process.parent.args == \"-c\" and process.parent.args : \":!*sh\") or\n  (process.parent.name in (\"c89\", \"c99\", \"gcc\") and process.parent.args : \"*sh,-s\" and process.parent.args == \"-wrapper\") or\n  (process.parent.name == \"expect\" and process.parent.args == \"-c\" and process.parent.args : \"spawn *sh;interact\") or\n  (process.parent.name == \"mysql\" and process.parent.args == \"-e\" and process.parent.args : \"\\\\!*sh\") or\n  (process.parent.name == \"ssh\" and process.parent.args == \"-o\" and process.parent.args : \"ProxyCommand=;*sh 0<&2 1>&2\")\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_evasion_linux_binary.toml"}
{"title": "Openssl Client or Server Activity", "description": "This rule identifies when the openssl client or server is used to establish a connection. Attackers may use openssl to\nestablish a secure connection to a remote server or to create a secure server to receive connections. This activity may\nbe used to exfiltrate data or establish a command and control channel.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n  process.name == \"openssl\" and (\n    (process.args == \"s_client\" and process.args : (\"-connect\", \"*:*\") and not process.args == \"-showcerts\") or\n    (process.args == \"s_server\" and process.args == \"-port\")\n  ) and\n  not process.parent.executable in (\n    \"/pro/xymon/client/ext/awsXymonCheck.sh\", \"/opt/antidot-svc/nrpe/plugins/check_cert\", \"/etc/zabbix/scripts/check_dane_tlsa.sh\"\n  )", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_openssl_client_or_server.toml"}
{"title": "Potential Reverse Shell via Background Process", "description": "Monitors for the execution of background processes with process arguments capable of opening a socket in the /dev/tcp\nchannel. This may indicate the creation of a backdoor reverse connection, and should be investigated further.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.name in (\"setsid\", \"nohup\") and process.args : \"*/dev/tcp/*0>&1*\" and\n  process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_background_process.toml"}
{"title": "Potential Reverse Shell via Child", "description": "This detection rule identifies suspicious network traffic patterns associated with TCP reverse shell activity. This\nactivity consists of a network event that is followed by the creation of a shell process with suspicious command line\narguments. An attacker may establish a Linux TCP reverse shell to gain remote access to a target system.", "query": "sequence by host.id, process.entity_id with maxspan=5s\n  [network where event.type == \"start\" and host.os.type == \"linux\" and\n     event.action in (\"connection_attempted\", \"connection_accepted\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"socat\") and destination.ip != null and\n     not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]\n  [process where event.type == \"start\" and host.os.type == \"linux\" and event.action == \"exec\" and\n     process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n       (process.args : (\"-i\", \"-l\")) or (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n   )]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_child_tcp_utility_linux.toml"}
{"title": "Potential Reverse Shell via Java", "description": "This detection rule identifies the execution of a Linux shell process from a Java JAR application post an incoming\nnetwork connection. This behavior may indicate reverse shell activity via a Java application.", "query": "sequence by host.id with maxspan=5s\n  [network where host.os.type == \"linux\" and event.action in (\"connection_accepted\", \"connection_attempted\") and\n   process.executable : (\"/usr/bin/java\", \"/bin/java\", \"/usr/lib/jvm/*\", \"/usr/java/*\") and\n   not (destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n    )\n  )] by process.entity_id\n  [process where host.os.type == \"linux\" and event.action == \"exec\" and\n   process.parent.executable : (\"/usr/bin/java\", \"/bin/java\", \"/usr/lib/jvm/*\", \"/usr/java/*\") and\n   process.parent.args : \"-jar\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n   and not process.parent.args in (\n     \"/usr/share/java/jenkins.war\", \"/etc/remote-iot/services/remoteiot.jar\",\n     \"/usr/lib64/NetExtender.jar\", \"/usr/lib/jenkins/jenkins.war\"\n   )] by process.parent.entity_id", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_java_revshell_linux.toml"}
{"title": "Potential Reverse Shell via Suspicious Child Process", "description": "This detection rule detects the creation of a shell through a suspicious process chain. Any reverse shells spawned by\nthe specified utilities that are initialized from a single process followed by a network connection attempt will be\ncaptured through this rule. Attackers may spawn reverse shells to establish persistence onto a target system.", "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"fork\") and (\n    (process.name : \"python*\" and process.args : \"-c\" and process.args : (\n     \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n    )) or\n    (process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n     \"*exec*\", \"*system*\"\n    )) or\n    (process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n     \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n     )) or\n    (process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n     \"*io.popen*\", \"*os.execute*\"\n    )) or\n    (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or\n    (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or\n    (process.name : \"openssl\" and process.args : \"-connect\") or\n    (process.name : (\"nc\", \"ncat\", \"netcat\") and process.args == \"-e\" and process.args_count >= 3 and\n     not process.args == \"-z\") or\n    (process.name : \"telnet\" and process.args_count >= 3)\n  ) and process.parent.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n    \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n    process.name : (\"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\") and\n    destination.ip != null and not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_lolbin_interpreter_linux.toml"}
{"title": "Potential Meterpreter Reverse Shell", "description": "This detection rule identifies a sample of suspicious Linux system file reads used for system fingerprinting, leveraged\nby the Metasploit Meterpreter shell to gather information about the target that it is executing its shell on. Detecting\nthis pattern is indicative of a successful meterpreter shell connection.", "query": "sample by host.id, process.pid, user.id\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/etc/machine-id\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/etc/passwd\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/proc/net/route\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/proc/net/ipv6_route\"]\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"open\" and auditd.data.a2 == \"1b6\" and file.path == \"/proc/net/if_inet6\"]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_meterpreter_linux.toml"}
{"title": "Potential Reverse Shell via Suspicious Binary", "description": "This detection rule detects the creation of a shell through a chain consisting of the execution of a suspicious binary\n(located in a commonly abused location or executed manually) followed by a network event and ending with a shell being\nspawned. Stageless reverse tcp shells display this behaviour. Attackers may spawn reverse shells to establish\npersistence onto a target system.", "query": "sequence by host.id, process.entity_id with maxspan=1s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.executable : (\n  \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n  \"/etc/crontab\", \"/etc/cron.*\", \"/etc/update-motd.d/*\", \"/usr/lib/update-notifier/*\",\n  \"/boot/*\", \"/srv/*\", \"/run/*\", \"/root/*\", \"/etc/rc.local\"\n   ) and\n  process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not\n  process.name : (\"curl\", \"wget\", \"ping\", \"apt\", \"dpkg\", \"yum\", \"rpm\", \"dnf\", \"dockerd\") ]\n[ network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and\n  process.executable : (\n  \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n  \"/etc/crontab\", \"/etc/cron.*\", \"/etc/update-motd.d/*\", \"/usr/lib/update-notifier/*\",\n  \"/boot/*\", \"/srv/*\", \"/run/*\", \"/root/*\", \"/etc/rc.local\"\n   ) and destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" ]\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") ]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_suspicious_binary.toml"}
{"title": "Potential Reverse Shell", "description": "This detection rule identifies suspicious network traffic patterns associated with TCP reverse shell activity. This\nactivity consists of a parent-child relationship where a network event is followed by the creation of a shell process.\nAn attacker may establish a Linux TCP reverse shell to gain remote access to a target system.", "query": "sequence by host.id with maxspan=5s\n  [network where event.type == \"start\" and host.os.type == \"linux\" and\n     event.action in (\"connection_attempted\", \"connection_accepted\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"socat\") and destination.ip != null and\n     not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")] by process.entity_id\n  [process where event.type == \"start\" and host.os.type == \"linux\" and event.action in (\"exec\", \"fork\") and\n     process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n       (process.args : (\"-i\", \"-l\")) or (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n   )] by process.parent.entity_id", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_tcp_cli_utility_linux.toml"}
{"title": "Potential Reverse Shell via UDP", "description": "This detection rule identifies suspicious network traffic patterns associated with UDP reverse shell activity. This\nactivity consists of a sample of an execve, socket and connect syscall executed by the same process, where the\nauditd.data.a0-1 indicate a UDP connection, ending with an egress connection event. An attacker may establish a Linux\nUDP reverse shell to bypass traditional firewall restrictions and gain remote access to a target system covertly.", "query": "sample by host.id, process.pid, process.parent.pid\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"executed\" and process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    )]\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"socket\" and process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    ) and auditd.data.a1 == \"2\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connected-to\" and\n   process.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl\", \"python*\", \"nc\", \"ncat\", \"netcat\", \"php*\",\n    \"ruby\", \"openssl\", \"awk\", \"telnet\", \"lua*\", \"socat\"\n    ) and network.direction == \"egress\" and destination.ip != null and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_via_udp_cli_utility_linux.toml"}
{"title": "Suspicious System Commands Executed by Previously Unknown Executable", "description": "This rule monitors for the execution of several commonly used system commands executed by a previously unknown\nexecutable located in commonly abused directories. An alert from this rule can indicate the presence of potentially\nmalicious activity, such as the execution of unauthorized or suspicious processes attempting to run malicious code.\nDetecting and investigating such behavior can help identify and mitigate potential security threats, protecting the\nsystem and its data from potential compromise.", "query": "host.os.type:linux and event.category:process and event.action:(exec or exec_event or fork or fork_event) and\nprocess.executable:(* and (\n  /etc/crontab or /bin/* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or /etc/update-motd.d/* or\n  /home/*/.* or /tmp/* or /usr/bin/* or /usr/lib/update-notifier/* or /usr/share/* or /var/tmp/*\n) and not /tmp/go-build*) and\nprocess.args:(hostname or id or ifconfig or ls or netstat or ps or pwd or route or top or uptime or whoami) and\nnot (process.name:\n  (apt or dnf or docker or dockerd or dpkg or hostname or id or ls or netstat or ps or pwd or rpm or snap or\n  snapd or sudo or top or uptime or which or whoami or yum) or\nprocess.parent.executable:(\n  /opt/cassandra/bin/cassandra or /opt/nessus/sbin/nessusd or /opt/nessus_agent/sbin/nessus-agent-module or /opt/puppetlabs/puppet/bin/puppet or\n  /opt/puppetlabs/puppet/bin/ruby or /usr/libexec/platform-python or /usr/local/cloudamize/bin/CCAgent or /usr/sbin/sshd or /bin/* or\n  /etc/network/* or /opt/Elastic/* or /opt/TrendMicro* or /opt/aws/* or /opt/eset/* or /opt/rapid7/* or /run/containerd/* or /run/k3s/* or\n  /snap/* or /tmp/dpkg-licenses* or /tmp/newroot/* or /usr/bin/* or /var/lib/amagent/* or /var/lib/docker/* or /vz/*\n  ) or\n  process.executable:(/run/containerd/* or /srv/snp/docker/* or /tmp/.criu*)\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_executable_running_system_commands.toml"}
{"title": "Suspicious Mining Process Creation Event", "description": "Identifies service creation events of common mining services, possibly indicating the infection of a system with a\ncryptominer.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and event.action : (\"creation\", \"file_create_event\") and\nfile.name : (\"aliyun.service\", \"moneroocean_miner.service\", \"c3pool_miner.service\", \"pnsd.service\", \"apache4.service\", \"pastebin.service\", \"xvf.service\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_mining_process_creation_events.toml"}
{"title": "Suspicious Named Pipe Creation", "description": "This rule detects the creation of unusually labeled named pipes (FIFOs) by the mkfifo command, which is often used by\nattackers to establish persistence on a target system or to execute commands in the background. Through the new_terms\nrule type, this rule can identify uncommon process command lines that may indicate the presence of a malicious\nnamed pipe.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:mkfifo and\nprocess.parent.name:(bash or csh or dash or fish or ksh or sh or tcsh or zsh) and\nprocess.args:((/dev/shm/* or /tmp/* or /var/tmp/*) and not /*fifo*)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_mkfifo_execution.toml"}
{"title": "Suspicious Content Extracted or Decompressed via Funzip", "description": "Identifies when suspicious content is extracted from a file and subsequently decompressed using the funzip utility.\nMalware may execute the tail utility using the \"-c\" option to read a sequence of bytes from the end of a file. The\noutput from tail can be piped to funzip in order to decompress malicious code before it is executed. This behavior is\nconsistent with malware families such as Bundlore.", "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n((process.args == \"tail\" and process.args == \"-c\" and process.args == \"funzip\")) and\nnot process.args : \"/var/log/messages\" and\nnot process.parent.executable : (\"/usr/bin/dracut\", \"/sbin/dracut\", \"/usr/bin/xargs\") and\nnot (process.parent.name in (\"sh\", \"sudo\") and process.parent.command_line : \"*nessus_su*\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_sus_extraction_or_decrompression_via_funzip.toml"}
{"title": "System Binary Path File Permission Modification", "description": "This rule identifies file permission modification events on files located in common system binary paths. Adversaries may attempt to\nhide their payloads in the default Linux system directories, and modify the file permissions of these payloads prior to execution.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name in (\"chmod\", \"chown\") and\nprocess.args like~ (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\",\n  \"/lib/*\", \"/usr/lib/*\", \"/lib64/*\", \"/usr/lib64/*\"\n) and\nprocess.args in (\"4755\", \"755\", \"000\", \"777\", \"444\", \"-x\", \"+x\") and not (\n  process.args in (\"/bin/chmod\", \"/usr/bin/chmod\", \"/usr/local/bin/chmod\") or\n  process.parent.executable like~ (\"/tmp/newroot/*\", \"/var/lib/dpkg/info/*\") or\n  process.parent.name in (\"udevadm\", \"systemd\", \"entrypoint\", \"sudo\", \"dart\") or\n  process.parent.command_line == \"runc init\" or\n  process.parent.args like \"/var/tmp/rpm-tmp.*\"\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_system_binary_file_permission_change.toml"}
{"title": "BPF filter applied using TC", "description": "Detects when the tc (transmission control) binary is utilized to set a BPF (Berkeley Packet Filter) on a network\ninterface. Tc is used to configure Traffic Control in the Linux kernel. It can shape, schedule, police and drop traffic.\nA threat actor can utilize tc to set a bpf filter on an interface for the purpose of manipulating the incoming traffic.\nThis technique is not at all common and should indicate abnormal, suspicious or malicious activity.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.executable == \"/usr/sbin/tc\" and\nprocess.args == \"filter\" and process.args == \"add\" and process.args == \"bpf\" and\nnot process.parent.executable == \"/usr/sbin/libvirtd\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_tc_bpf_filter.toml"}
{"title": "Unix Socket Connection", "description": "This rule monitors for inter-process communication via Unix sockets. Adversaries may attempt to communicate with local\nUnix sockets to enumerate application details, find vulnerabilities/configuration mistakes and potentially escalate\nprivileges or set up malicious communication channels via Unix sockets for inter-process communication to attempt to\nevade detection.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n (\n  (process.name in (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and\n   process.args == \"-U\" and process.args : (\"/usr/local/*\", \"/run/*\", \"/var/run/*\")) or\n  (process.name == \"socat\" and\n   process.args == \"-\" and process.args : (\"UNIX-CLIENT:/usr/local/*\", \"UNIX-CLIENT:/run/*\", \"UNIX-CLIENT:/var/run/*\")) or\n  (process.name == \"curl\" and process.args : (\"--unix-socket\", \"--abstract-unix-socket\"))\n) and\nnot (\n  process.args == \"/var/run/libvirt/libvirt-sock\" or\n  process.parent.name in (\"bundle\", \"ruby\", \"haproxystatus.sh\")\n)", "tactic": "Execution", "technique": "Inter-Process Communication", "technique_id": "T1559", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_unix_socket_communication.toml"}
{"title": "Unknown Execution of Binary with RWX Memory Region", "description": "Monitors for the execution of a previously unknown unix binary with read, write and execute memory region permissions.\nThe mprotect() system call is used to change the access protections on a region of memory that has already been\nallocated. This syscall allows a process to modify the permissions of pages in its virtual address space, enabling or\ndisabling permissions such as read, write, and execute for those pages. RWX permissions on memory is in many cases\noverly permissive, and should be analyzed thoroughly.", "query": "event.category:process and host.os.type:linux and auditd.data.syscall:mprotect and auditd.data.a2:7 and not (\n  process.executable:(\n    \"/usr/share/kibana/node/bin/node\" or \"/usr/share/elasticsearch/jdk/bin/java\" or \"/usr/sbin/apache2\"\n  ) or\n  process.name:(httpd or java)\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_unknown_rwx_mem_region_binary_executed.toml"}
{"title": "Unusual Interactive Process Launched in a Container", "description": "This rule detects when an unusual interactive process is launched inside a container. Interactive processes are typically\nrun in the foreground and require user input, which is unusual behavior for a containerized environment. This activity\ncould indicate an attacker attempting to gain access to the container environment or perform malicious actions.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\nprocess.entry_leader.entry_meta.type:container and process.interactive:true", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_unusual_interactive_process_inside_container.toml"}
{"title": "Unusual Execution from Kernel Thread (kthreadd) Parent", "description": "This rule detects suspicious child process from the kernel thread (kthreadd) parent process. Attackers may execute payloads from\nkernel space via kthreadd to perform actions on the host and evade detection. Through the usage of the new_terms rule type, this\nrule can identify uncommon child processes that may indicate the presence of a malicious process.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.parent.name:kthreadd and (\n  process.executable:(/dev/shm/* or /tmp/* or /var/tmp/* or /var/www/*) or\n  process.name:(bash or csh or curl or dash or fish or id or ksh or nohup or setsid or sh or tcsh or wget or whoami or zsh)\n) and\nprocess.command_line:(\n  */dev/shm/* or */dev/tcp/* or */etc/init.d* or */etc/ld.so* or */etc/profile* or */etc/rc.local* or */etc/shadow* or */etc/ssh* or\n  */etc/sudoers* or */home/*/.ssh/* or */root/.ssh* or */tmp/* or */var/log/* or */var/run/* or */var/tmp/* or */var/www/* or\n  *base64* or *cron* or *xxd* or *~/.ssh/*\n) and not (\n  process.name:(true or cifs.upcall or dpkg or flock or gdbus or getopt or grep or mount or touch or umount or uname) or\n  process.command_line:(\n    \"sh -c /bin/true\" or */bin/ps* or */usr/bin/find* or */usr/bin/grep* or *ds_agent* or *gitlabrunner* or *nagios* or\n    *omsagent* or *pgrep*\n  ) or\n  process.executable:(\n    /lib/systemd/systemd-cgroups-agent or /proc/self/exe or /usr/local/axs-haproxy-monitoring/haproxy_stats.sh or /tmp/newroot/* or\n    /var/lib/docker/overlay2/* or /vz/root/*\n  )\n)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_unusual_kthreadd_execution.toml"}
{"title": "Suspicious Path Invocation from Command Line", "description": "This rule detects the execution of a PATH variable in a command line invocation by a shell process. This behavior\nis unusual and may indicate an attempt to execute a command from a non-standard location. This technique may be\nused to evade detection or perform unauthorized actions on the system.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\nprocess.name:(bash or csh or dash or fish or ksh or sh or tcsh or zsh) and process.args:-c and\nprocess.command_line:(*PATH=* and not sh*/run/motd.dynamic.new)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_unusual_path_invocation_from_command_line.toml"}
{"title": "Unusual Pkexec Execution", "description": "This rule detects the execution of the `pkexec` command by a shell process. The `pkexec` command is used to execute\nprograms as another user, typically as the superuser. Through the `new_terms` rule type, unusual executions of `pkexec`\nare identified, and may indicate an attempt to escalate privileges or perform unauthorized actions on the system.", "query": "event.category:process and host.os.type:linux and event.type:start and\nevent.action:(exec or exec_event or start or ProcessRollup2) and process.name:pkexec and\nprocess.args:pkexec and process.parent.name:(bash or dash or sh or tcsh or csh or zsh or ksh or fish)", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_unusual_pkexec_execution.toml"}
{"title": "Potential Data Exfiltration Through Curl", "description": "Detects the use of curl to upload an archived file to an internet server. Threat actors often will collect data on a\nsystem and compress it in an archive file before exfiltrating the file back to their C2 server for review. Many threat \nactors have been seen utilizing curl to upload this archive file with the collected data to do this. Use of curl in this \nway while not inherently malicious should be considered highly abnormal and suspicious activity.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\" and\nprocess.parent.executable != null and (process.args in (\"-F\", \"-T\", \"-d\") or process.args like \"--data*\") and \nprocess.command_line like~ (\"*@/*.zip*\", \"*@/*.gz*\", \"*@/*.tgz*\", \"*b64=@*\", \"*=<*\") and\nprocess.command_line like~ \"*http*\"", "tactic": "Exfiltration", "technique": "Exfiltration Over Alternative Protocol", "technique_id": "T1048", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_potential_curl_data_exfiltration.toml"}
{"title": "Potential Data Splitting Detected", "description": "This rule looks for the usage of common data splitting utilities with specific arguments that indicate data splitting\nfor exfiltration on Linux systems. Data splitting is a technique used by adversaries to split data into smaller parts to\navoid detection and exfiltrate data.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name == \"dd\" and process.args like \"bs=*\" and process.args like \"if=*\") or\n    (\n      process.name in (\"split\", \"rsplit\") and\n      (\n        (process.args == \"-b\" or process.args like \"--bytes*\") or\n        (process.args == \"-C\" or process.args like \"--line-bytes*\")\n      )\n    )\n  ) and\n  not (\n    process.parent.name in (\"apport\", \"overlayroot\", \"nessus-agent-module\") or\n    process.args like (\n      \"if=/tmp/nvim*\", \"if=/boot/*\", \"if=/dev/random\", \"if=/dev/urandom\", \"/dev/mapper/*\",\n      \"if=*.iso\", \"of=/dev/stdout\", \"if=/dev/zero\", \"if=/dev/sda\", \"/proc/sys/kernel/*\"\n    )\n  )", "tactic": "Exfiltration", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_potential_data_splitting_for_exfiltration.toml"}
{"title": "Unusual File Transfer Utility Launched", "description": "This rule leverages ES|QL to detect the execution of unusual file transfer utilities on Linux systems. Attackers may use\nthese utilities to exfiltrate data from a compromised system. ES|QL rules have limited fields available in its alert\ndocuments. Make sure to review the original documents to aid in the investigation of this alert.", "query": "from logs-endpoint.events.process-*\n| keep @timestamp, host.os.type, event.type, event.action, process.name, process.executable, process.parent.executable, process.command_line, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.name in (\"scp\", \"ftp\", \"sftp\", \"vsftpd\", \"sftp-server\", \"rsync\")\n| stats cc = count(), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.executable, process.parent.executable, process.command_line\n| where agent_count == 1 and cc < 5\n| sort cc asc\n| limit 100", "tactic": "Exfiltration", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_unusual_file_transfer_utility_launched.toml"}
{"title": "Suspicious Data Encryption via OpenSSL Utility", "description": "Identifies when the openssl command-line utility is used to encrypt multiple files on a host within a short time window.\nAdversaries may encrypt data on a single or multiple systems in order to disrupt the availability of their target's data\nand may attempt to hold the organization's data to ransom for the purposes of extortion.", "query": "sequence by host.id, user.name, process.parent.entity_id with maxspan=5s\n  [ process where host.os.type == \"linux\" and event.action == \"exec\" and\n    process.name == \"openssl\" and process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl*\", \"php*\", \"python*\", \"xargs\") and\n    process.args == \"-in\" and process.args == \"-out\" and\n    process.args in (\"-k\", \"-K\", \"-kfile\", \"-pass\", \"-iv\", \"-md\") and\n    /* excluding base64 encoding options and including encryption password or key params */\n    not process.args in (\"-d\", \"-a\", \"-A\", \"-base64\", \"-none\", \"-nosalt\") ] with runs=10", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_data_encrypted_via_openssl.toml"}
{"title": "Suspicious Termination of ESXI Process", "description": "Identifies instances where VMware processes, such as \"vmware-vmx\" or \"vmx,\" are terminated on a Linux system by a \"kill\"\ncommand. The rule monitors for the \"end\" event type, which signifies the termination of a process. The presence of a\n\"kill\" command as the parent process for terminating VMware processes may indicate that a threat actor is attempting to\ninterfere with the virtualized environment on the targeted system.", "query": "process where host.os.type == \"linux\" and event.type == \"end\" and process.name in (\"vmware-vmx\", \"vmx\")\nand process.parent.name == \"kill\"", "tactic": "Impact", "technique": "Service Stop", "technique_id": "T1489", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_esxi_process_kill.toml"}
{"title": "Memory Swap Modification", "description": "This rule detects memory swap modification events on Linux systems. Memory swap modification can be used to manipulate\nthe system's memory and potentially impact the system's performance. This behavior is commonly observed in malware that\ndeploys miner software such as XMRig.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.parent.executable != null and\nprocess.name in (\"swapon\", \"swapoff\") or (\n  process.command_line like (\"*vm.swappiness*\", \"*/proc/sys/vm/swappiness*\") and (\n    (process.name == \"sysctl\" and process.args like (\"*-w*\", \"*--write*\", \"*=*\")) or\n    (\n      process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.args == \"-c\" and\n      process.command_line like \"*echo *\"\n    )\n  )\n) and\nnot process.parent.name in (\"lynis\", \"systemd\", \"end-zram-swapping\", \"SyxsenseResponder\", \"tuned\", \"platform-python\", \"timeout\")", "tactic": "Impact", "technique": "Resource Hijacking", "technique_id": "T1496", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_memory_swap_modification.toml"}
{"title": "Potential Malware-Driven SSH Brute Force Attempt", "description": "This detection identifies a Linux host that has potentially been infected with malware and is being used to conduct\nbrute-force attacks against external systems over SSH (port 22 and common alternative SSH ports). The detection looks\nfor a high volume of outbound connection attempts to non-private IP addresses from a single process. A compromised host\nmay be part of a botnet or controlled by an attacker, attempting to gain unauthorized access to remote systems. This\nbehavior is commonly observed in SSH brute-force campaigns where malware hijacks vulnerable machines to expand its\nattack surface. ES|QL rules have limited fields available in its alert documents. Make sure to review the original\ndocuments to aid in the investigation of this alert.", "query": "from logs-endpoint.events.network-*\n| keep @timestamp, host.os.type, event.type, event.action, destination.port, process.executable, destination.ip, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and\n  destination.port in (22, 222, 2222, 10022, 2022, 2200, 62612, 8022) and not\n     CIDR_MATCH(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\",\n       \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\",\n       \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"224.0.0.0/4\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\"\n     )\n| stats cc = count(), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.executable, destination.port\n| where agent_count == 1 and cc > 15\n| sort cc asc\n| limit 100", "tactic": "Impact", "technique": "Resource Hijacking", "technique_id": "T1496", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_potential_bruteforce_malware_infection.toml"}
{"title": "Potential Linux Ransomware Note Creation Detected", "description": "This rule identifies a sequence of a mass file encryption event in conjunction with the creation of a .txt file with a\nfile name containing ransomware keywords executed by the same process in a 1 second timespan. Ransomware is a type of\nmalware that encrypts a victim's files or systems and demands payment (usually in cryptocurrency) in exchange for the\ndecryption key. One important indicator of a ransomware attack is the mass encryption of the file system, after which a\nnew file extension is added to the file.", "query": "sequence by process.entity_id, host.id with maxspan=1s\n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\"\n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\") and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\", \"rustup-init\", \"bun\"\n    )\n  ] with runs=25\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   file.name : (\"*restore*\", \"*lock*\", \"*recovery*\", \"*read*\", \"*instruction*\", \"*how_to*\", \"*ransom*\")\n  ]", "tactic": "Impact", "technique": "Data Encrypted for Impact", "technique_id": "T1486", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_potential_linux_ransomware_note_detected.toml"}
{"title": "High Number of Process Terminations", "description": "This rule identifies a high number (10) of process terminations via pkill from the same host within a short time period.", "query": "event.category:process and host.os.type:linux and event.type:start and process.name:\"pkill\" and process.args:\"-f\"", "tactic": "Impact", "technique": "Service Stop", "technique_id": "T1489", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_process_kill_threshold.toml"}
{"title": "Successful SSH Authentication from Unusual SSH Public Key", "description": "This rule leverages the new_terms rule type to detect successful SSH authentications via a public\nkey that has not been seen in the last 10 days. Public key authentication is a secure method for\nauthenticating users to a server. Monitoring unusual public key authentication events can help\ndetect unauthorized access attempts or suspicious activity on the system.", "query": "event.category:authentication and host.os.type:linux and event.action:ssh_login and event.outcome:success and system.auth.ssh.method:publickey", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_first_time_public_key_authentication.toml"}
{"title": "Successful SSH Authentication from Unusual IP Address", "description": "This rule leverages the new_terms rule type to detect successful SSH authentications by an IP-\naddress that has not been authenticated in the last 10 days. This behavior may indicate an\nattacker attempting to gain access to the system using a valid account.", "query": "event.category:authentication and host.os.type:linux and event.action:ssh_login and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_successful_ssh_authentication_by_unusual_ip.toml"}
{"title": "Successful SSH Authentication from Unusual User", "description": "This rule leverages the new_terms rule type to detect successful SSH authentications by a user\nwho has not been authenticated in the last 10 days. This behavior may indicate an attacker\nattempting to gain access to the system using a valid account.", "query": "event.category:authentication and host.os.type:linux and event.action:ssh_login and event.outcome:success", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_successful_ssh_authentication_by_unusual_user.toml"}
{"title": "Kubeconfig File Creation or Modification", "description": "The kubeconfig file is a critical component in Kubernetes environments, containing configuration\ndetails for accessing and managing Kubernetes clusters. Attackers may attempt to get access to,\ncreate or modify kubeconfig files to gain unauthorized initial access to Kubernetes clusters or\nmove laterally within the cluster.", "query": "file where host.os.type == \"linux\" and event.type != \"deletion\" and file.path like (\n  \"/root/.kube/config\",\n  \"/home/*/.kube/config\",\n  \"/etc/kubernetes/admin.conf\",\n  \"/etc/kubernetes/super-admin.conf\",\n  \"/etc/kubernetes/kubelet.conf\",\n  \"/etc/kubernetes/controller-manager.conf\",\n  \"/etc/kubernetes/scheduler.conf\",\n  \"/var/lib/*/kubeconfig\"\n) and not (\n  process.name in (\"kubeadm\", \"kubelet\", \"vcluster\", \"minikube\") or\n  (process.name == \"sed\" and file.Ext.original.name like \"sed*\")\n)", "tactic": "Lateral Movement", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_kubeconfig_file_activity.toml"}
{"title": "Remote File Creation in World Writeable Directory", "description": "This rule detects the creation of a file in a world-writeable directory through a service that is\ncommonly used for file transfer. This behavior is often associated with lateral movement and can\nbe an indicator of an attacker attempting to move laterally within a network.", "query": "file where host.os.type == \"linux\" and event.action == \"creation\" and\nprocess.name in (\"scp\", \"sshd\", \"ssh\", \"ftp\", \"sftp\", \"vsftpd\", \"sftp-server\", \"rsync\") and\nfile.path like~ (\"/tmp*\", \"/var/tmp*\", \"/dev/shm/*\", \"/home/.*\") and user.id != \"0\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_remote_file_creation_world_writeable_dir.toml"}
{"title": "Potential SSH-IT SSH Worm Downloaded", "description": "Identifies processes that are capable of downloading files with command line arguments containing URLs to SSH-IT's\nautonomous SSH worm. This worm intercepts outgoing SSH connections every time a user uses ssh.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n process.name in (\"curl\", \"wget\") and process.args : (\n  \"https://thc.org/ssh-it/x\", \"http://nossl.segfault.net/ssh-it-deploy.sh\", \"https://gsocket.io/x\",\n  \"https://thc.org/ssh-it/bs\", \"http://nossl.segfault.net/bs\"\n)", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ssh_it_worm_download.toml"}
{"title": "SSH Process Launched From Inside A Container", "description": "This rule detects an SSH or SSHD process executed from inside a container. This includes both the client ssh binary and\nserver ssh daemon process. SSH usage inside a container should be avoided and monitored closely when necessary. With\nvalid credentials an attacker may move laterally to other containers or to the underlying host through container\nbreakout. They may also use valid SSH credentials as a persistence mechanism.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name in (\"sshd\", \"ssh\", \"autossh\")", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_ssh_process_launched_inside_container.toml"}
{"title": "Unusual Remote File Creation", "description": "This rule leverages the new_terms rule type to detect file creation via a commonly used file\ntransfer service while excluding typical remote file creation activity. This behavior is\noften linked to lateral movement, potentially indicating an attacker attempting to move\nwithin a network.", "query": "event.category:file and host.os.type:linux and event.action:creation and\nprocess.name:(scp or ftp or sftp or vsftpd or sftp-server or sync) and\nnot file.path:(/dev/ptmx or /run/* or /var/run/*)", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_unusual_remote_file_creation.toml"}
{"title": "Suspicious APT Package Manager Execution", "description": "Detects suspicious process events executed by the APT package manager, potentially indicating persistence through an APT\nbackdoor. In Linux, APT (Advanced Package Tool) is a command-line utility used for handling packages on Debian-based\nsystems, providing functions for installing, updating, upgrading, and removing software along with managing package\nrepositories. Attackers can backdoor APT to gain persistence by injecting malicious code into scripts that APT runs,\nthereby ensuring continued unauthorized access or control each time APT is used for package management.", "query": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name == \"apt\" and process.args == \"-c\" and process.name in (\n     \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"\n   ) and not process.executable == \"/usr/lib/venv-salt-minion/bin/python.original\"\n  ] by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and process.name : (\n     \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\",\n     \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\"\n   )\n  ] by process.parent.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_apt_package_manager_execution.toml"}
{"title": "APT Package Manager Configuration File Creation", "description": "Detects file creation events in the configuration directory for the APT package manager. In Linux, APT (Advanced Package\nTool) is a command-line utility used for handling packages on (by default) Debian-based systems, providing functions for\ninstalling, updating, upgrading, and removing software along with managing package repositories. Attackers can backdoor\nAPT to gain persistence by injecting malicious code into scripts that APT runs, thereby ensuring continued unauthorized\naccess or control each time APT is used for package management.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : \"/etc/apt/apt.conf.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/local/bin/apt-get\", \"/usr/bin/apt-get\"\n  ) or\n  file.path :(\"/etc/apt/apt.conf.d/*.tmp*\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"pveupdate\", \"perl\", \"executor\", \"crio\", \"docker-init\", \"dockerd\", \"pvedaemon\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_apt_package_manager_file_creation.toml"}
{"title": "Suspicious APT Package Manager Network Connection", "description": "Detects suspicious network events executed by the APT package manager, potentially indicating persistence through an APT\nbackdoor. In Linux, APT (Advanced Package Tool) is a command-line utility used for handling packages on Debian-based\nsystems, providing functions for installing, updating, upgrading, and removing software along with managing package\nrepositories. Attackers can backdoor APT to gain persistence by injecting malicious code into scripts that APT runs,\nthereby ensuring continued unauthorized access or control each time APT is used for package management.", "query": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"apt\" and process.args == \"-c\" and process.name in (\n     \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"\n    )\n  ] by process.entity_id\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\", \"172.31.0.0/16\"\n     )\n   ) and not process.executable == \"/usr/bin/apt-listbugs\"\n  ] by process.parent.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_apt_package_manager_netcon.toml"}
{"title": "At Job Created or Modified", "description": "This rule monitors for at jobs being created or renamed. Linux at jobs are scheduled tasks that can be leveraged by\nsystem administrators to set up scheduled tasks, but may be abused by malicious actors for persistence, privilege\nescalation and command execution. By creating or modifying cron job configurations, attackers can execute malicious\ncommands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized activities.", "query": "file where host.os.type == \"linux\" and\nevent.action in (\"rename\", \"creation\") and file.path : \"/var/spool/cron/atjobs/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_at_job_creation.toml"}
{"title": "Boot File Copy", "description": "This rule detects the process of copying or moving files from or to the `/boot` directory on Linux systems. The `/boot`\ndirectory contains files that are essential for the system to boot, such as the kernel and initramfs images. Attackers\nmay copy or move files to the `/boot` directory to modify the boot process, which can be leveraged to maintain access to\nthe system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and\nprocess.name in (\"cp\", \"mv\") and process.parent.executable != null and process.args like~ \"/boot/*\" and not (\n  process.parent.name in (\"update-initramfs\", \"dracut\", \"grub-mkconfig\", \"shim-install\", \"sudo\", \"activate-theme\", \"update-grub-gfxpayload\", \"grub-pc.postinst\") or\n  process.parent.executable like~ (\"/usr/lib/kernel/install.d/*\", \"/tmp/newroot/*\", \"/var/lib/dpkg/info/*\") or\n  process.parent.args like~ (\"/usr/bin/mkinitcpio\", \"/var/tmp/rpm-tmp.*\")\n)", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_boot_file_copy.toml"}
{"title": "Suspicious Usage of bpf_probe_write_user Helper", "description": "This rule monitors the syslog log file for messages related to instances of a program using the `bpf_probe_write_user` helper.\nThe `bpf_probe_write_user` helper is used to write data to user space from a BPF program. Unauthorized use of this helper can\nbe indicative of an eBPF rootkit or other malicious activity.", "query": "host.os.type:linux and event.dataset:\"system.syslog\" and process.name:kernel and message:\"bpf_probe_write_user\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_bpf_probe_write_user.toml"}
{"title": "Chkconfig Service Add", "description": "Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize\nthis technique to maintain persistence on a system. When a new service is added, chkconfig ensures that the service has\neither a start or a kill entry in every runlevel and when the system is rebooted the service file added will run\nproviding long-term persistence.", "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\", \"start\") and\n( \n  (process.executable : \"/usr/sbin/chkconfig\" and process.args : \"--add\") or\n  (process.args : \"*chkconfig\" and process.args : \"--add\")\n) and not (\n  process.parent.name in (\"rpm\", \"qualys-scan-util\", \"qualys-cloud-agent\", \"update-alternatives\") or\n  process.parent.args : (\"/var/tmp/rpm*\", \"/var/lib/waagent/*\") or\n  process.args in (\"jexec\", \"sapinit\", \"httpd\", \"dbora\")\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_chkconfig_service_add.toml"}
{"title": "Modification of OpenSSH Binaries", "description": "Adversaries may modify SSH related binaries for persistence or credential access by patching sensitive functions to\nenable unauthorized access or by logging SSH credentials for exfiltration.", "query": "event.category:file and host.os.type:linux and event.type:change and\n  process.name:(* and not (\n    dnf or dnf-automatic or dpkg or yum or rpm or yum-cron or anacron or platform-python* or\n    apk or ansible-admin or systemd or python* or yum or nix-daemon or nix\n    )\n  ) and \n  (file.path:(/usr/bin/scp or \n                /usr/bin/sftp or \n                /usr/bin/ssh or \n                /usr/sbin/sshd) or \n  file.name:libkeyutils.so) and\n  not process.executable:/usr/share/elasticsearch/*", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_credential_access_modify_ssh_binaries.toml"}
{"title": "Cron Job Created or Modified", "description": "This rule monitors for (ana)cron jobs being created or renamed. Linux cron jobs are scheduled tasks that can be\nleveraged by system administrators to set up scheduled tasks, but may be abused by malicious actors for persistence,\nprivilege escalation and command execution. By creating or modifying cron job configurations, attackers can execute\nmalicious commands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized\nactivities.", "query": "file where host.os.type == \"linux\" and\nevent.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/cron.d/*\", \"/etc/cron.hourly/*\", \"/etc/cron.daily/*\", \"/etc/cron.weekly/*\",\n  \"/etc/cron.monthly/*\", \"/etc/crontab\", \"/var/spool/cron/crontabs/*\", \"/var/spool/anacron/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\", \"/opt/elasticbeanstalk/bin/platform-engine\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/opt/imunify360/venv/bin/python3\",\n    \"/opt/eset/efs/lib/utild\", \"/usr/sbin/anacron\", \"/usr/bin/podman\", \"/kaniko/kaniko-executor\"\n  ) or\n  file.path like (\"/var/spool/cron/crontabs/tmp.*\", \"/etc/cron.d/jumpcloud-updater\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"crond\", \"executor\", \"puppet\", \"droplet-agent.postinst\", \"cf-agent\", \"schedd\", \"imunify-notifier\", \"perl\",\n    \"jumpcloud-agent\", \"crio\", \"dnf_install\", \"utild\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_cron_job_creation.toml"}
{"title": "D-Bus Service Created", "description": "This rule detects the creation of D-Bus service files on Linux systems. D-Bus is a message bus system that provides a\nway for applications to talk to one another. D-Bus services are defined in service files that are typically located in\ndefault directories. The rule looks for the creation of service files that are not associated with known package\nmanagers or system services. Attackers may create malicious D-Bus services to establish persistence or escalate\nprivileges on a system.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.extension in (\"service\", \"conf\") and file.path like~ (\n  \"/usr/share/dbus-1/system-services/*\", \"/etc/dbus-1/system.d/*\",\n  \"/lib/dbus-1/system-services/*\", \"/run/dbus/system.d/*\",\n  \"/home/*/.local/share/dbus-1/services/*\", \"/home/*/.dbus/session-bus/*\",\n  \"/usr/share/dbus-1/services/*\", \"/etc/dbus-1/session.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.name like (\n    \"ssm-agent-worker\", \"platform-python*\", \"dnf_install\", \"cloudflared\", \"lxc-pve-prestart-hook\",\n    \"convert-usrmerge\", \"elastic-agent\", \"google_metadata_script_runner\", \"update-alternatives\", \"gitlab-runner\",\n    \"install\", \"crio\", \"apt-get\", \"package-cleanup\", \"dcservice\", \"dcregister\", \"jumpcloud-agent\", \"executor\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dbus_service_creation.toml"}
{"title": "Unusual D-Bus Daemon Child Process", "description": "This rule detects when an unusual child process is spawned from the `dbus-daemon` parent process. The `dbus-daemon`\nprocess is a message bus system that provides a way for applications to talk to each other. Attackers may abuse this\nprocess to execute malicious code or escalate privileges.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.parent.name == \"dbus-daemon\" and process.args_count > 1 and not (\n  process.parent.args == \"--session\" or\n  process.args in (\"/usr/lib/software-properties/software-properties-dbus\", \"/usr/share/backintime/qt/serviceHelper.py\") or\n  process.name in (\"dbus-daemon-launch-helper\", \"gnome-keyring-daemon\", \"abrt-dbus\", \"aptd\", \"usb-creator-helper\") or\n  process.executable like~ (\"/usr/lib/*\", \"/usr/local/lib/*\", \"/usr/libexec/*\", \"/tmp/newroot/*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dbus_unsual_daemon_parent_execution.toml"}
{"title": "DNF Package Manager Plugin File Creation", "description": "Detects file creation events in the plugin directories for the Yum package manager. In Linux, DNF (Dandified YUM) is a\ncommand-line utility used for handling packages on Fedora-based systems, providing functions for installing, updating,\nupgrading, and removing software along with managing package repositories. Attackers can backdoor DNF to gain\npersistence by injecting malicious code into plugins that DNF runs, thereby ensuring continued unauthorized access or\ncontrol each time DNF is used for package management.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : (\"/usr/lib/python*/site-packages/dnf-plugins/*\", \"/etc/dnf/plugins/*\") and not (\n  process.executable in (\n    \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\", \"/usr/bin/microdnf\", \"/bin/rpm\",\n    \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\", \"/bin/puppet\",\n    \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/bin/autossl_check\",\n    \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\",\n    \"/usr/libexec/netplan/generate\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\") or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") or\n  file.path like~ \"/etc/dnf/plugins/.ansible_tmp*\" or\n  process.name like~ (\"ssm-agent-worker, NinjaOrbit\", \"python*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dnf_package_manager_plugin_file_creation.toml"}
{"title": "DPKG Package Installed by Unusual Parent Process", "description": "This rule detects the installation of a Debian package (dpkg) by an unusual parent process. The dpkg command is used to\ninstall, remove, and manage Debian packages on a Linux system. Attackers can abuse the dpkg command to install malicious\npackages on a system.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:dpkg and\nprocess.args:(\"-i\" or \"--install\")", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dpkg_package_installation_from_unusual_parent.toml"}
{"title": "Unusual DPKG Execution", "description": "This rule detects the execution of the DPKG command by processes not associated with the DPKG package manager. The DPKG\ncommand is used to install, remove, and manage Debian packages on a Linux system. Attackers can abuse the DPKG command\nto install malicious packages on a system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.executable : \"/var/lib/dpkg/info/*\" and process.session_leader.name != null and\nprocess.group_leader.name != null and not (\n  process.parent.name in (\"dpkg\", \"dpkg-reconfigure\", \"frontend\") or\n  process.session_leader.name == \"dpkg\" or\n  process.group_leader.name == \"dpkg\" or\n  process.parent.executable in (\"/usr/share/debconf/frontend\", \"/usr/bin/unattended-upgrade\")\n)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dpkg_unusual_execution.toml"}
{"title": "Dracut Module Creation", "description": "This rule detects the creation of Dracut module files on Linux systems. Dracut is a tool used to generate an initramfs\nimage that is used to boot the system. Dracut modules are scripts that are executed during the initramfs image\ngeneration process. Attackers may create malicious Dracut modules to execute arbitrary code at boot time, which can be\nleveraged to maintain persistence on a Linux system.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.path like~ (\"/lib/dracut/modules.d/*\", \"/usr/lib/dracut/modules.d/*\") and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\n  process.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dracut_module_creation.toml"}
{"title": "Dynamic Linker Copy", "description": "Detects the copying of the Linux dynamic loader binary and subsequent file creation for the purpose of creating a backup\ncopy. This technique was seen recently being utilized by Linux malware prior to patching the dynamic loader in order to\ninject and preload a malicious shared object file. This activity should never occur and if it does then it should be\nconsidered highly suspicious or malicious.", "query": "sequence by process.entity_id with maxspan=1m\n[process where host.os.type == \"linux\" and event.type == \"start\" and process.name in (\"cp\", \"rsync\") and\n   process.args in (\n     \"/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/etc/ld.so.preload\", \"/lib64/ld-linux-x86-64.so.2\",\n     \"/usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2\", \"/usr/lib64/ld-linux-x86-64.so.2\"\n    )]\n[file where host.os.type == \"linux\" and event.action == \"creation\" and file.extension == \"so\"]", "tactic": "Persistence", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_dynamic_linker_backup.toml"}
{"title": "Deprecated - Suspicious File Creation in /etc for Persistence", "description": "Detects the manual creation of files in specific etc directories, via user root, used by Linux malware to persist and\nelevate privileges on compromised systems. File creation in these directories should not be entirely common and could\nindicate a malicious binary or script installing persistence mechanisms for long term access.", "query": "file where host.os.type == \"linux\" and event.type in (\"creation\", \"file_create_event\") and user.id == \"0\" and\nfile.path : (\"/etc/ld.so.conf.d/*\", \"/etc/cron.d/*\", \"/etc/sudoers.d/*\", \"/etc/init.d/*\", \"/etc/systemd/system/*\",\n\"/usr/lib/systemd/system/*\") and not (\n  (process.name : (\n    \"chef-client\", \"ruby\", \"pacman\", \"packagekitd\", \"python*\", \"platform-python\", \"dpkg\", \"yum\", \"apt\", \"dnf\", \"rpm\",\n    \"systemd\", \"snapd\", \"dnf-automatic\", \"yum-cron\", \"elastic-agent\", \"dnfdaemon-system\", \"dockerd\", \"executor\",\n    \"rhn_check\"\n    )\n  ) or \n  (file.extension in (\"swp\", \"swpx\", \"tmp\"))\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_etc_file_creation.toml"}
{"title": "Initramfs Extraction via CPIO", "description": "This rule detects the extraction of an initramfs image using the `cpio` command on Linux systems. The `cpio` command is\nused to create or extract cpio archives. Attackers may extract the initramfs image to modify the contents or add\nmalicious files, which can be leveraged to maintain persistence on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and\nprocess.name == \"cpio\" and process.args in (\"-H\", \"--format\") and process.args == \"newc\" and not (\n  process.parent.name in (\"mkinitramfs\", \"dracut\") or\n  process.parent.executable like~ (\"/usr/share/initramfs-tools/*\", \"/nix/store/*\")\n)", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_extract_initramfs_via_cpio.toml"}
{"title": "Git Hook Command Execution", "description": "This rule detects the execution of a potentially malicious process from a Git hook. Git hooks are scripts that Git\nexecutes before or after events such as: commit, push, and receive. An attacker can abuse Git hooks to execute arbitrary\ncommands on the system and establish persistence.", "query": "sequence by host.id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name == \"git\" and process.args : \".git/hooks/*\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n  ] by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.parent.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_git_hook_execution.toml"}
{"title": "Git Hook Created or Modified", "description": "This rule detects the creation or modification of a Git hook file on a Linux system. Git hooks are scripts that Git\nexecutes before or after events such as commit, push, and receive. They are used to automate tasks, enforce policies,\nand customize Git's behavior. Attackers can abuse Git hooks to maintain persistence on a system by executing malicious\ncode whenever a specific Git event occurs.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path : \"*.git/hooks/*\" and\nfile.extension == null and process.executable != null and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/usr/bin/pamac-daemon\", \"/bin/pamac-daemon\",\n    \"/usr/local/bin/dockerd\", \"/sbin/dockerd\"\n  ) or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.name in (\"git\", \"dirname\", \"tar\", \"gitea\", \"git-lfs\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_git_hook_file_creation.toml"}
{"title": "Git Hook Egress Network Connection", "description": "This rule detects a suspicious egress network connection attempt from a Git hook script. Git hooks are scripts that Git\nexecutes before or after events such as: commit, push, and receive. An attacker can abuse these features to execute\narbitrary commands on the system, establish persistence or to initialize a network connection to a remote server and\nexfiltrate data or download additional payloads.", "query": "sequence by host.id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"git\" and process.args : \".git/hooks/*\" and\n   process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\", \"172.31.0.0/16\"\n     )\n   )\n  ] by process.parent.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_git_hook_netcon.toml"}
{"title": "Git Hook Child Process", "description": "This rule detects child processes spawned by Git hooks. Git hooks are scripts that Git executes before or after events\nsuch as commit, push, and receive. The rule identifies child processes spawned by Git hooks that are not typically\nspawned by the Git process itself. This behavior may indicate an attacker attempting to hide malicious activity by\nleveraging the legitimate Git process to execute unauthorized commands.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  process.parent.name in (\n    \"applypatch-msg\", \"commit-msg\", \"fsmonitor-watchman\", \"post-update\", \"post-checkout\", \"post-commit\",\n    \"pre-applypatch\", \"pre-commit\", \"pre-merge-commit\", \"prepare-commit-msg\", \"pre-push\", \"pre-rebase\", \"pre-receive\",\n    \"push-to-checkout\", \"update\", \"post-receive\", \"pre-auto-gc\", \"post-rewrite\", \"sendemail-validate\", \"p4-pre-submit\",\n    \"post-index-change\", \"post-merge\", \"post-applypatch\"\n  ) and\n  (\n    process.name in (\"nohup\", \"setsid\", \"disown\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") or\n    process.name : (\"php*\", \"perl*\", \"ruby*\", \"lua*\") or\n    process.executable : (\n      \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\",\n      \"/run/*\", \"/srv/*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/log/*\"\n    )\n  ) and\n  not process.name in (\"git\", \"dirname\")", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_git_hook_process_execution.toml"}
{"title": "GRUB Configuration File Creation", "description": "This rule detects the creation of GRUB configuration files on Linux systems. The GRUB configuration file is used to\nconfigure the boot loader, which is responsible for loading the operating system. Attackers may create malicious GRUB\nconfiguration files to execute arbitrary code or escalate privileges during the boot process, which can be leveraged to\nmaintain persistence on the system.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and file.path like~ (\n  \"/etc/default/grub.d/*\", \"/etc/default/grub\", \"/etc/grub.d/*\",\n  \"/boot/grub2/grub.cfg\", \"/boot/grub/grub.cfg\", \"/boot/efi/EFI/*/grub.cfg\",\n  \"/etc/sysconfig/grub\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\n  process.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_grub_configuration_creation.toml"}
{"title": "GRUB Configuration Generation through Built-in Utilities", "description": "This rule detects the generation of a new GRUB configuration file using built-in Linux commands. The GRUB configuration\nfile is used to configure the GRUB bootloader, which is responsible for loading the Linux kernel and initramfs image\nduring the boot process. Attackers may use these built-in utilities to generate a new GRUB configuration file that\nincludes malicious kernel parameters or boot options, which can be leveraged to maintain persistence on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.parent.executable != null and process.name in (\"grub-mkconfig\", \"grub2-mkconfig\", \"update-grub\") and not (\n  process.parent.name in (\"run-parts\", \"sudo\", \"update-grub\", \"pacman\", \"dockerd\", \"dnf\", \"rpm\", \"yum\") or\n  process.parent.executable like~ (\n    \"/var/lib/dpkg/info/*\", \"/usr/lib/bootloader/grub2-efi/config\", \"/tmp/newroot/*\", \"/usr/lib/kernel/install.d/*\"\n  )\n)", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_grub_makeconfig.toml"}
{"title": "System V Init Script Created", "description": "Files that are placed in the /etc/init.d/ directory in Unix can be used to start custom applications, services, scripts\nor commands during start-up. Init.d has been mostly replaced in favor of Systemd. However, the \"systemd-sysv-generator\"\ncan convert init.d files to service unit files that run at boot. Adversaries may add or alter files located in the\n/etc/init.d/ directory to execute malicious code upon boot in order to gain persistence on the system.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\", \"rename\", \"file_rename_event\")\nand file.path : \"/etc/init.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\", \"dpkg-new\") or\n  file.path like (\"/etc/init.d/*beat*\", \"/etc/init.d/elastic-agent*\") or\n  process.executable like (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\", \"/opt/puppetlabs/puppet/bin/ruby\") or\n  process.name in (\"docker-init\", \"jumpcloud-agent\", \"crio\") or\n  process.executable == null or\n  process.name in (\"executor\", \"univention-config-registry\", \"install\", \"dockerd-entrypoint.sh\", \"platform-python*\", \"ssm-agent-worker\") or\n  (process.name == \"ln\" and file.path : \"/etc/init.d/rc*.d/*\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_init_d_file_creation.toml"}
{"title": "Kernel Module Load via insmod", "description": "Detects the use of the insmod binary to load a Linux kernel object file. Threat actors can use this binary, given they\nhave root privileges, to load a rootkit on a system providing them with complete control and the ability to hide from\nsecurity products. Manually loading a kernel module in this manner should not be at all common and can indicate\nsuspcious or malicious behavior.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"insmod\" and process.args : \"*.ko\" and\nnot process.parent.executable like (\n  \"/opt/ds_agent/*\", \"/usr/sbin/veeamsnap-loader\", \"/opt/TrendMicro/vls_agent/*\", \"/opt/intel/oneapi/*\",\n  \"/opt/commvault/Base/linux_drv\", \"/bin/falcoctl\"\n)", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_insmod_kernel_module_load.toml"}
{"title": "Persistence via KDE AutoStart Script or Desktop File Modification", "description": "Identifies the creation or modification of a K Desktop Environment (KDE) AutoStart script or desktop file that will\nexecute upon each user logon. Adversaries may abuse this method for persistence.", "query": "file where host.os.type == \"linux\" and event.type != \"deletion\" and\n  file.extension in (\"sh\", \"desktop\") and\n  file.path :\n    (\n      \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n      \"/home/*/.kde/Autostart/*\", \"/root/.kde/Autostart/*\",\n      \"/home/*/.kde4/Autostart/*\", \"/root/.kde4/Autostart/*\",\n      \"/home/*/.kde/share/autostart/*\", \"/root/.kde/share/autostart/*\",\n      \"/home/*/.kde4/share/autostart/*\", \"/root/.kde4/share/autostart/*\",\n      \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\",\n      \"/home/*/.config/autostart-scripts/*\", \"/root/.config/autostart-scripts/*\",\n      \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\"\n    ) and\n    not process.name in (\n      \"yum\", \"dpkg\", \"install\", \"dnf\", \"teams\", \"yum-cron\", \"dnf-automatic\", \"docker\", \"dockerd\", \"rpm\", \"pacman\",\n      \"podman\", \"nautilus\", \"remmina\", \"cinnamon-settings.py\", \"executor\", \"xfce4-clipman\", \"jetbrains-toolbox\",\n      \"ansible-admin\", \"apk\"\n    )", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_kde_autostart_modification.toml"}
{"title": "Kernel Driver Load", "description": "Detects the loading of a Linux kernel module through system calls. Threat actors may leverage Linux kernel modules to\nload a rootkit on a system providing them with complete control and the ability to hide from security products. As other\nrules monitor for the addition of Linux kernel modules through system utilities or .ko files, this rule covers the gap\nthat evasive rootkits leverage by monitoring for kernel module additions on the lowest level through auditd_manager.", "query": "driver where host.os.type == \"linux\" and event.action == \"loaded-kernel-module\" and\nauditd.data.syscall in (\"init_module\", \"finit_module\")", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_kernel_driver_load.toml"}
{"title": "Kernel Driver Load by non-root User", "description": "Detects the loading of a Linux kernel module by a non-root user through system calls. Threat actors may leverage Linux\nkernel modules to load a rootkit on a system providing them with complete control and the ability to hide from security\nproducts. As other rules monitor for the addition of Linux kernel modules through system utilities or .ko files, this\nrule covers the gap that evasive rootkits leverage by monitoring for kernel module additions on the lowest level through\nauditd_manager.", "query": "driver where host.os.type == \"linux\" and event.action == \"loaded-kernel-module\" and\nauditd.data.syscall in (\"init_module\", \"finit_module\") and user.id != \"0\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_kernel_driver_load_by_non_root.toml"}
{"title": "Kernel Object File Creation", "description": "This rule detects the creation of a Linux kernel object file (.ko) on a system. Threat actors may leverage Linux kernel\nobject files to load a rootkit or other type of malware on a system providing them with complete control and the ability\nto hide from security products.", "query": "event.category:file and host.os.type:linux and event.type:creation and file.extension:ko and not (\n  file.path:/var/tmp/mkinitramfs_* or process.executable:/snap/* or process.name:cpio\n) and not file.path:/tmp/mkinitramfs*", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_kernel_object_file_creation.toml"}
{"title": "Suspicious File Creation via Kworker", "description": "This rule monitors for a file creation event originating from a kworker parent process. kworker, or kernel worker,\nprocesses are part of the kernel's workqueue mechanism. They are responsible for executing work that has been scheduled\nto be done in kernel space, which might include tasks like handling interrupts, background activities, and other\nkernel-related tasks. Attackers may attempt to evade detection by masquerading as a kernel worker process.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and\n  process.name : \"kworker*\" and not (\n    (process.name : \"kworker*kcryptd*\") or\n    (file.path : (\n      \"/var/log/*\", \"/var/crash/*\", \"/var/run/*\", \"/var/lib/systemd/coredump/*\", \"/var/spool/*\",\n      \"/var/lib/nfs/nfsdcltrack/main.sqlite-journal\", \"/proc/*/cwd/core.*\", \"/var/run/apport.lock\",\n      \"/var/spool/abrt/ccpp-*\", \"/var/lib/dynatrace/oneagent/*\", \"/var/lib/nfs*\", \"/run/user/*/.bubblewrap/*\",\n      \"/etc/localtime/*\", \"/proc/*/cwd/core.*\"\n      )\n    )\n  )", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_kworker_file_creation.toml"}
{"title": "Potential Linux Backdoor User Account Creation", "description": "Identifies the attempt to create a new backdoor user by setting the user's UID to 0. Attackers may alter a user's UID to\n0 to establish persistence on a system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\")\n and process.name == \"usermod\" and process.args : \"-u\" and process.args : \"0\" and process.args : \"-o\"", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_linux_backdoor_user_creation.toml"}
{"title": "Linux Group Creation", "description": "Identifies attempts to create a new group. Attackers may create new groups to establish persistence on a system.", "query": "iam where host.os.type == \"linux\" and (event.type == \"group\" and event.type == \"creation\") and\nprocess.name in (\"groupadd\", \"addgroup\") and group.name != null", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_linux_group_creation.toml"}
{"title": "Potential Remote Code Execution via Web Server", "description": "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access.\nAttackers may exploit a vulnerability in a web application to execute commands via a web server, or place a backdoor\nfile that can be abused to gain code execution as a mechanism for persistence.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\") and process.parent.executable : (\n  \"/usr/sbin/nginx\", \"/usr/local/sbin/nginx\",\n  \"/usr/sbin/apache\", \"/usr/local/sbin/apache\",\n  \"/usr/sbin/apache2\", \"/usr/local/sbin/apache2\",\n  \"/usr/sbin/php*\", \"/usr/local/sbin/php*\",\n  \"/usr/sbin/lighttpd\", \"/usr/local/sbin/lighttpd\",\n  \"/usr/sbin/hiawatha\", \"/usr/local/sbin/hiawatha\",\n  \"/usr/local/bin/caddy\", \n  \"/usr/local/lsws/bin/lswsctrl\",\n  \"*/bin/catalina.sh\"\n) and\nprocess.name : (\n  \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\",\n  \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and process.args : (\n  \"whoami\", \"id\", \"uname\", \"cat\", \"hostname\", \"ip\", \"curl\", \"wget\", \"pwd\", \"ls\", \"cd\", \"python*\", \"php*\", \"perl\",\n  \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and not process.name == \"phpquery\"", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_linux_shell_activity_via_web_server.toml"}
{"title": "Linux User Account Creation", "description": "Identifies attempts to create new users. Attackers may add new users to establish persistence on a system.", "query": "iam where host.os.type == \"linux\" and (event.type == \"user\" and event.type == \"creation\") and\nprocess.name in (\"useradd\", \"adduser\") and user.name != null", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_linux_user_account_creation.toml"}
{"title": "Linux User Added to Privileged Group", "description": "Identifies attempts to add a user to a privileged group. Attackers may add users to a privileged group in order to\nestablish persistence on a system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.args in (\n    \"root\", \"admin\", \"wheel\", \"staff\", \"sudo\",\"disk\", \"video\", \"shadow\", \"lxc\", \"lxd\"\n  ) and\n  (\n    process.name in (\"usermod\", \"adduser\") or\n    (process.name == \"gpasswd\" and process.args in (\"-a\", \"--add\", \"-M\", \"--members\"))\n  )", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_linux_user_added_to_privileged_group.toml"}
{"title": "Loadable Kernel Module Configuration File Creation", "description": "This rule detects the creation of Loadable Kernel Module (LKM) configuration files. Attackers may create or modify these\nfiles to allow their LKMs to be loaded upon reboot, ensuring persistence on a compromised system.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and process.executable != null and\nfile.path like (\n  \"/etc/modules\", \"/etc/modprobe.d/*\", \"/run/modprobe.d/*\", \"/usr/local/lib/modprobe.d/*\", \"/usr/lib/modprobe.d/*\",\n  \"/lib/modprobe.d/*\", \"/etc/modules-load.d/*\", \"/run/modules-load.d/*\", \"/usr/local/lib/modules-load.d/*\",\n  \"/usr/lib/modules-load.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\", \"/opt/elasticbeanstalk/bin/platform-engine\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/opt/imunify360/venv/bin/python3\",\n    \"/opt/eset/efs/lib/utild\", \"/usr/sbin/anacron\", \"/usr/bin/podman\", \"/kaniko/kaniko-executor\", \"/usr/bin/prime-select\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable like (\n    \"/nix/store/*\", \"/var/lib/dpkg/info/kmod.postinst\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"crond\", \"executor\", \"puppet\", \"droplet-agent.postinst\", \"cf-agent\", \"schedd\", \"imunify-notifier\", \"perl\",\n    \"jumpcloud-agent\", \"crio\", \"dnf_install\", \"utild\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_lkm_configuration_file_creation.toml"}
{"title": "Manual Dracut Execution", "description": "This rule detects manual execution of the `dracut` command on Linux systems. Dracut is a tool used to generate an\ninitramfs image that is used to boot the system. Attackers may use `dracut` to create a custom initramfs image that\nincludes malicious code or backdoors, allowing them to maintain persistence on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\nprocess.name == \"dracut\" and process.parent.executable != null and not (\n  process.parent.executable like~ (\n    \"/usr/lib/kernel/*\", \"/etc/kernel/install.d/*\", \"/var/lib/dpkg/info/dracut.postinst\",\n    \"/tmp/newroot/*\", \"/usr/lib/module-init-tools/*\"\n  ) or\n  process.parent.name in (\n    \"dracut-install\", \"dracut\", \"run-parts\", \"weak-modules\", \"mkdumprd\", \"new-kernel-pkg\", \"sudo\"\n  ) or\n  process.parent.args like~ (\"/usr/bin/dracut-rebuild\", \"/var/tmp/rpm-tmp.*\") or\n  process.parent.command_line like~ \"/bin/sh -c if command -v mkinitcpio*\"\n)", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_manual_dracut_execution.toml"}
{"title": "Message-of-the-Day (MOTD) File Creation", "description": "This rule detects the creation of potentially malicious files within the default MOTD file directories. Message of the\nday (MOTD) is the message that is presented to the user when a user connects to a Linux server via SSH or a serial\nconnection. Linux systems contain several default MOTD files located in the \"/etc/update-motd.d/\" directory. These\nscripts run as the root user every time a user connects over SSH or a serial connection. Adversaries may create\nmalicious MOTD files that grant them persistence onto the target every time a user connects to the system by executing a\nbackdoor script or command.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : \"/etc/update-motd.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"executor\", \"dockerd\", \"crio\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_message_of_the_day_creation.toml"}
{"title": "Process Spawned from Message-of-the-Day (MOTD)", "description": "Message of the day (MOTD) is the message that is presented to the user when a user connects to a Linux server via SSH or\na serial connection. Linux systems contain several default MOTD files located in the \"/etc/update-motd.d/\" directory.\nThese scripts run as the root user every time a user connects over SSH or a serial connection. Adversaries may create\nmalicious MOTD files that grant them persistence onto the target every time a user connects to the system by executing a\nbackdoor script or command. This rule detects the execution of potentially malicious processes through the MOTD utility.", "query": "process where event.type == \"start\" and host.os.type == \"linux\" and event.action : (\"exec\", \"exec_event\", \"start\") and\n  process.parent.executable : \"/etc/update-motd.d/*\" and\n  (\n    (\n      process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n      (\n        process.args : (\"-i\", \"-l\") or\n        (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n      )\n    ) or\n    (\n      process.name : (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and process.args_count >= 3 and \n      not process.args : (\"-*z*\", \"-*l*\")\n    ) or\n    (\n      process.name : \"python*\" and process.args : \"-c\" and process.args : (\n        \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n      )\n    ) or\n    (\n      process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n        \"*exec*\", \"*system*\"\n      )\n    ) or\n    (\n      process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n        \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n      )\n    ) or\n    (\n      process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n        \"*io.popen*\", \"*os.execute*\"\n      )\n    ) or\n    (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or \n    (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or \n    (process.name in (\"openssl\", \"telnet\")) or\n    (\n      process.args : (\n        \"./*\", \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\", \"/run/*\", \"/srv/*\",\n        \"/tmp/*\", \"/var/tmp/*\", \"/var/log/*\", \"/opt/*\"\n      ) and process.args_count == 1\n    )\n  ) and \n  not (\n    process.parent.args == \"--force\" or\n    process.args in (\"/usr/games/lolcat\", \"/usr/bin/screenfetch\") or\n    process.parent.name == \"system-crash-notification\"\n  )", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_message_of_the_day_execution.toml"}
{"title": "NetworkManager Dispatcher Script Creation", "description": "This rule detects the creation of a NetworkManager dispatcher script on a Linux system. NetworkManager dispatcher\nscripts are shell scripts that NetworkManager executes when network interfaces change state. Attackers can abuse\nNetworkManager dispatcher scripts to maintain persistence on a system by executing malicious code whenever a network\nevent occurs.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path like~ \"/etc/NetworkManager/dispatcher.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\n  process.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_network_manager_dispatcher_persistence.toml"}
{"title": "OpenSSL Password Hash Generation", "description": "This rule detects the usage of the `openssl` binary to generate password hashes on Linux systems. The `openssl` command\nis a cryptographic utility that can be used to generate password hashes. Attackers may use `openssl` to generate\npassword hashes for new user accounts or to change the password of existing accounts, which can be leveraged to maintain\npersistence on a Linux system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and process.name == \"openssl\"\nand process.args == \"passwd\"", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_openssl_passwd_hash_generation.toml"}
{"title": "Creation or Modification of Pluggable Authentication Module or Configuration", "description": "This rule monitors for the creation or modification of Pluggable Authentication Module (PAM) shared object files or\nconfiguration files. Attackers may create or modify these files to maintain persistence on a compromised system, or\nharvest account credentials.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nprocess.executable != null and (\n  (file.path like~ (\n    \"/lib/security/*\", \"/lib64/security/*\", \"/usr/lib/security/*\", \"/usr/lib64/security/*\",\n    \"/lib/x86_64-linux-gnu/security/*\", \"/usr/lib/x86_64-linux-gnu/security/*\"\n  ) and file.extension == \"so\") or\n  (file.path like~ \"/etc/pam.d/*\" and file.extension == null) or\n  (file.path like~ \"/etc/security/pam_*\" or file.path == \"/etc/pam.conf\")\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/sbin/pam-auth-update\",\n    \"/usr/lib/systemd/systemd\", \"/usr/libexec/packagekitd\", \"/usr/bin/bsdtar\", \"/sbin/pam-auth-update\"\n  ) or\n  file.path like (\n    \"/tmp/snap.rootfs_*/pam_*.so\", \"/tmp/newroot/lib/*/pam_*.so\", \"/tmp/newroot/usr/lib64/security/pam_*.so\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable like (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  (process.name == \"sed\" and file.name like~ \"sed*\") or\n  (process.name == \"perl\" and file.name like~ \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_pluggable_authentication_module_creation.toml"}
{"title": "Pluggable Authentication Module (PAM) Creation in Unusual Directory", "description": "This rule detects the creation of Pluggable Authentication Module (PAM) shared object files in unusual directories.\nAttackers may compile PAM shared object files in temporary directories, to move them to system directories later,\npotentially allowing them to maintain persistence on a compromised system, or harvest account credentials.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.name like \"pam_*.so\" and not file.path like (\n  \"/lib/security/*\",\n  \"/lib64/security/*\",\n  \"/lib/x86_64-linux-gnu/security/*\",\n  \"/usr/lib/security/*\",\n  \"/usr/lib64/security/*\",\n  \"/usr/lib/x86_64-linux-gnu/security/*\"\n) and not (\n  process.name in (\"dockerd\", \"containerd\", \"steam\", \"buildkitd\", \"unsquashfs\", \"pacman\") or\n  file.path like (\n    \"/build/rootImage/nix/store/*\", \"/home/*/.local/share/containers/*\", \"/nix/store/*\", \"/var/lib/containerd/*\",\n    \"/var/snap/*\", \"/usr/share/nix/nix/store/*\", \"/tmp/cura/squashfs-root/*\", \"/home/*/docker/*\", \"/tmp/containerd*\"\n  )\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_pluggable_authentication_module_creation_in_unusual_dir.toml"}
{"title": "Potential Backdoor Execution Through PAM_EXEC", "description": "This rule detects SSH session ID change followed by a suspicious SSHD child process, this may\nindicate the successful execution of a potentially malicious process through the Pluggable\nAuthentication Module (PAM) utility. PAM is a framework used by Linux systems to authenticate\nusers. Adversaries may create malicious PAM modules that grant them persistence onto the\ntarget every time a user logs in by executing a backdoor script or command.", "query": "sequence by process.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"session_id_change\" and process.name in (\"ssh\", \"sshd\")]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name in (\"ssh\", \"sshd\") and\n   process.args_count == 2 and (\n     process.name like (\"perl*\", \"python*\", \"php*\", \"ruby*\", \"lua*\") or\n     process.executable like (\n       \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"./*\", \"/boot/*\", \"/sys/*\", \"/lost+found/*\", \"/media/*\", \"/proc/*\",\n       \"/var/backups/*\", \"/var/log/*\", \"/var/mail/*\", \"/var/spool/*\") or\n     process.name like \".*\"\n   )]", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_pluggable_authentication_module_pam_exec_backdoor_exec.toml"}
{"title": "Pluggable Authentication Module (PAM) Source Download", "description": "This rule detects the usage of `curl` or `wget` to download the source code of a Pluggable Authentication Module (PAM)\nshared object file. Attackers may download the source code of a PAM shared object file to create a backdoor in the\nauthentication process.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name in (\"curl\", \"wget\") and\nprocess.args like~ \"https://github.com/linux-pam/linux-pam/releases/download/v*/Linux-PAM-*.tar.xz\"", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_pluggable_authentication_module_source_download.toml"}
{"title": "Polkit Policy Creation", "description": "This rule monitors for the creation of Polkit policy files on Linux systems. Polkit policy files are used to define the\npermissions for system-wide services and applications. The creation of new Polkit policy files may indicate an attempt\nto modify the authentication process, which could be used for persistence by an adversary.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.executable != null and\nfile.extension in (\"rules\", \"pkla\", \"policy\") and file.path like~ (\n\n  // Rule files\n  \"/etc/polkit-1/rules.d/*\", \"/usr/share/polkit-1/rules.d/*\",\n\n  // pkla files\n  \"/etc/polkit-1/localauthority/*\", \"/var/lib/polkit-1/localauthority/*\",\n\n  // Action files\n  \"/usr/share/polkit-1/actions/*\",\n\n  // Misc. legacy paths\n  \"/lib/polkit-1/rules.d/*\", \"/lib64/polkit-1/rules.d/*\", \"/var/lib/polkit-1/rules.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\", \"/usr/local/bin/pacman\"\n  ) or\nprocess.executable like~ (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  )\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_polkit_policy_creation.toml"}
{"title": "Executable Bit Set for Potential Persistence Script", "description": "This rule monitors for the addition of an executable bit for scripts that are located in directories which are commonly\nabused for persistence. An alert of this rule is an indicator that a persistence mechanism is being set up within your\nenvironment. Adversaries may create these scripts to execute malicious code at start-up, or at a set interval to gain\npersistence onto the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.args : (\n  // Misc.\n  \"/etc/rc.local\", \"/etc/rc.common\", \"/etc/rc.d/rc.local\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\",\n  \"/etc/apt/apt.conf.d/*\", \"/etc/cron*\", \"/etc/init/*\", \"/etc/NetworkManager/dispatcher.d/*\",\n  \"/lib/dracut/modules.d/*\", \"/usr/lib/dracut/modules.d/*\",\n\n  // XDG\n  \"/etc/xdg/autostart/*\", \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n  \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\", \"/home/*/.config/autostart-scripts/*\",\n  \"/root/.config/autostart-scripts/*\", \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\",\n\n  // udev\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\"\n\n) and (\n  (process.name == \"chmod\" and process.args : (\"+x*\", \"1*\", \"3*\", \"5*\", \"7*\")) or\n  (process.name == \"install\" and process.args : \"-m*\" and process.args : (\"7*\", \"5*\", \"3*\", \"1*\"))\n) and not (\n  process.parent.executable : \"/var/lib/dpkg/*\" or\n  process.command_line in (\"chmod 777 /etc/update-motd.d/\", \"chmod 755 /etc/update-motd.d/\")\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_potential_persistence_script_executable_bit_set.toml"}
{"title": "Process Capability Set via setcap Utility", "description": "This rule detects the use of the setcap utility to set capabilities on a process. The setcap utility is used to set the\ncapabilities of a binary to allow it to perform privileged operations without needing to run as root. This can be used\nby attackers to establish persistence by creating a backdoor, or escalate privileges by abusing a misconfiguration on a\nsystem.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"start\") and\nprocess.name == \"setcap\" and not (\n  process.parent.executable == null or\n  process.parent.executable : (\"/var/lib/dpkg/*\", \"/var/lib/docker/*\", \"/tmp/newroot/*\", \"/var/tmp/newroot/*\") or\n  process.parent.name in (\"jem\", \"vzctl\")\n)", "tactic": "Persistence", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_process_capability_set_via_setcap.toml"}
{"title": "Python Path File (pth) Creation", "description": "This rule detects the creation of .pth files in system-wide and user-specific Python package\ndirectories, which can be abused for persistent code execution. .pth files automatically\nexecute Python code when the interpreter starts, making them a stealthy persistence mechanism.\nMonitoring these paths helps identify unauthorized modifications that could indicate\npersistence by an attacker or malicious package injection.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and file.extension == \"pth\" and\nfile.path like~ (\n  \"/usr/local/lib/python*/dist-packages/*\", \n  \"/usr/lib/python*/dist-packages/*\",\n  \"/usr/local/lib/python*/site-packages/*\",\n  \"/usr/lib/python*/site-packages/*\",\n  \"/home/*/.local/lib/python*/site-packages/*\",\n  \"/opt/*/lib/python*/site-packages/*\"\n) and process.executable != null and not (\n  process.executable in (\n    \"/usr/local/bin/pip2\", \"/usr/bin/restic\", \"/usr/bin/pacman\", \"/usr/bin/dockerd\", \"/usr/local/bin/pip3\",\n    \"/usr/bin/pip3\", \"/usr/local/bin/pip\", \"/usr/bin/pip\", \"/usr/bin/podman\", \"/usr/local/bin/poetry\",\n    \"/usr/bin/poetry\", \"/usr/bin/pamac-daemon\", \"/opt/venv/bin/pip\", \"/usr/bin/dnf\", \"./venv/bin/pip\",\n    \"/usr/bin/dnf5\", \"/bin/dnf5\", \"/bin/pip\", \"/bin/podman\"\n  ) or\n  process.executable like~ (\n    \"/usr/bin/python*\", \"/usr/local/bin/python*\", \"/opt/venv/bin/python*\",\n    \"/nix/store/*libexec/docker/dockerd\", \"/snap/docker/*dockerd\"\n  )\n)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_pth_file_creation.toml"}
{"title": "Suspicious rc.local Error Message", "description": "This rule monitors the syslog log file for error messages related to the rc.local process. The rc.local file is a script\nthat is executed during the boot process on Linux systems. Attackers may attempt to modify the rc.local file to execute\nmalicious commands or scripts during system startup. This rule detects error messages such as \"Connection refused,\" \"No\nsuch file or directory,\" or \"command not found\" in the syslog log file, which may indicate that the rc.local file has\nbeen tampered with.", "query": "host.os.type:linux and event.dataset:system.syslog and process.name:rc.local and\nmessage:(\"Connection refused\" or \"No such file or directory\" or \"command not found\")", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rc_local_error_via_syslog.toml"}
{"title": "Potential Execution of rc.local Script", "description": "This rule detects the potential execution of the `/etc/rc.local` script through the `already_running` event action\ncreated by the `rc-local.service` systemd service. The `/etc/rc.local` script is a legacy initialization script that is\nexecuted at the end of the boot process. The `/etc/rc.local` script is not enabled by default on most Linux\ndistributions. The `/etc/rc.local` script can be used by attackers to persistently execute malicious commands or scripts\non a compromised system at reboot. As the rc.local file is executed prior to the initialization of Elastic Defend, the\nexecution event is not ingested, and therefore the `already_running` event is leveraged to provide insight into the\npotential execution of `rc.local`.", "query": "process where host.os.type == \"linux\" and event.type == \"info\" and event.action == \"already_running\" and\nprocess.parent.args == \"/etc/rc.local\" and process.parent.args == \"start\"", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rc_local_service_already_running.toml"}
{"title": "rc.local/rc.common File Creation", "description": "This rule monitors the creation/alteration of the rc.local/rc.common file. The /etc/rc.local file is used to start\ncustom applications, services, scripts or commands during start-up. The rc.local file has mostly been replaced by\nSystemd. However, through the \"systemd-rc-local-generator\", rc.local files can be converted to services that run at\nboot. Adversaries may alter rc.local/rc.common to execute malicious code at start-up, and gain persistence onto the\nsystem.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path in (\"/etc/rc.local\", \"/etc/rc.common\") and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"ssm-agent-worker\", \"convert2rhel\", \"platform-python*\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rc_script_creation.toml"}
{"title": "RPM Package Installed by Unusual Parent Process", "description": "This rule leverages the new_terms rule type to identify the installation of RPM packages by an unusual parent process.\nRPM is a package management system used in Linux systems such as Red Hat, CentOS and Fedora. Attacks may backdoor RPM\npackages to gain initial access or install malicious RPM packages to maintain persistence.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:rpm and\nprocess.args:(\"-i\" or \"--install\")", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_rpm_package_installation_from_unusual_parent.toml"}
{"title": "Setcap setuid/setgid Capability Set", "description": "This rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap. Setuid (Set User ID)\nand setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the\nfile owner or group. Threat actors can exploit these attributes to achieve persistence by creating malicious binaries,\nallowing them to maintain control over a compromised system with elevated permissions.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and \n  process.name == \"setcap\" and process.args : \"cap_set?id+ep\" and not (\n    process.parent.name in (\"jem\", \"vzctl\") or\n    process.args like \"/usr/bin/new?idmap\"\n  )", "tactic": "Persistence", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_setuid_setgid_capability_set.toml"}
{"title": "Shadow File Modification by Unusual Process", "description": "This rule monitors for Linux Shadow file modifications. These modifications are indicative of a potential password\nchange or user addition event. Threat actors may attempt to create new users or change the password of a user account to\nmaintain access to a system.", "query": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and\nfile.path == \"/etc/shadow\" and file.Ext.original.path != null and \nnot process.name in (\n  \"usermod\", \"useradd\", \"passwd\", \"chage\", \"systemd-sysusers\", \"chpasswd\", \"userdel\", \"adduser\", \"update-passwd\", \"perl\"\n)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_shadow_file_modification.toml"}
{"title": "Shared Object Created or Changed by Previously Unknown Process", "description": "This rule monitors the creation of shared object files by previously unknown processes. The creation of a shared object\nfile involves compiling code into a dynamically linked library that can be loaded by other programs at runtime. While\nthis process is typically used for legitimate purposes, malicious actors can leverage shared object files to execute\nunauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows\nmalware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the\naffected system and its data.", "query": "host.os.type:\"linux\" and event.action:(\"creation\" or \"file_create_event\" or \"file_rename_event\" or \"rename\" or \"file_write_event\") and\n(file.extension:\"so\" or file.name:*.so.*) and\nfile.path:(\n  /dev/shm/* or /usr/lib/* or /usr/lib64/* or /usr/local/lib/* or /usr/local/lib64/* or /lib/x86_64-linux-gnu/* or\n  /usr/lib/x86_64-linux-gnu/* or /lib/i386-linux-gnu/* or /usr/lib/i386-linux-gnu/* or /lib/* or /lib64/*\n) and not (\n  process.name:(\n    \"dockerd\" or \"dpkg\" or \"rpm\" or \"snapd\" or \"yum\" or \"vmis-launcher\" or \"pacman\" or \"apt-get\" or \"dnf\" or \"podman\" or\n    platform-python* or \"dnf-automatic\" or \"unattended-upgrade\" or \"apk\" or \"snap-update-ns\" or \"install\" or \"exe\" or\n    \"systemd\" or \"root\" or \"sshd\" or \"pip\" or \"jlink\" or python* or \"update-alternatives\" or pip* or \"crio\" or \"packagekitd\"\n  ) or \n  (process.name:\"vmware-install.pl\" and file.path:/usr/lib/vmware-tools/*) or\n  (process.name:\"ssm-agent-worker\" and file.path:/usr/lib/jvm/java*) or \n  process.executable : (/dev/fd/* or \"/\" or \"/kaniko/executor\" or \"/usr/bin/buildah\")\n)", "tactic": "Persistence", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_shared_object_creation.toml"}
{"title": "Shell Configuration Creation or Modification", "description": "This rule monitors the creation/alteration of a shell configuration file. Unix systems use shell configuration files to\nset environment variables, create aliases, and customize the user's environment. Adversaries may modify or add a shell\nconfiguration file to execute malicious code and gain persistence in the system. This behavior is consistent with the\nKaiji malware family.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  // system-wide configurations\n  \"/etc/profile\", \"/etc/profile.d/*\", \"/etc/bash.bashrc\", \"/etc/bash.bash_logout\", \"/etc/zsh/*\",\n  \"/etc/csh.cshrc\", \"/etc/csh.login\", \"/etc/fish/config.fish\", \"/etc/ksh.kshrc\",\n  // root and user configurations\n  \"/home/*/.profile\", \"/home/*/.bashrc\", \"/home/*/.bash_login\", \"/home/*/.bash_logout\", \"/home/*/.bash_profile\",\n  \"/root/.profile\", \"/root/.bashrc\", \"/root/.bash_login\", \"/root/.bash_logout\", \"/root/.bash_profile\",\n  \"/root/.bash_aliases\", \"/home/*/.bash_aliases\", \"/home/*/.zprofile\", \"/home/*/.zshrc\", \"/root/.zprofile\",\n  \"/root/.zshrc\", \"/home/*/.cshrc\", \"/home/*/.login\", \"/home/*/.logout\", \"/root/.cshrc\", \"/root/.login\",\n  \"/root/.logout\", \"/home/*/.config/fish/config.fish\", \"/root/.config/fish/config.fish\", \"/home/*/.kshrc\",\n  \"/root/.kshrc\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/sbin/adduser\", \"/usr/sbin/useradd\", \"/usr/local/bin/dockerd\",\n    \"/usr/sbin/gdm\", \"/usr/bin/unzip\", \"/usr/bin/gnome-shell\", \"/sbin/mkhomedir_helper\", \"/usr/sbin/sshd\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/bin/xfce4-session\", \"/usr/libexec/oddjob/mkhomedir\", \"/sbin/useradd\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/crond\", \"/usr/bin/pamac-daemon\", \"/usr/sbin/mkhomedir_helper\",\n    \"/opt/pbis/sbin/lwsmd\", \"/usr/sbin/oddjobd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\"adclient\", \"mkhomedir_helper\", \"teleport\", \"mkhomedir\", \"adduser\", \"desktopDaemon\", \"executor\", \"crio\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_shell_configuration_modification.toml"}
{"title": "Simple HTTP Web Server Connection", "description": "This rule detects connections accepted by a simple HTTP web server in Python and PHP built-in modules. Adversaries may\ncreate simple HTTP web servers to establish persistence on a compromised system by uploading a reverse or command shell\npayload to the server web root, allowing them to regain remote access to the system if lost. This event may occur when\nan attacker requests the server to execute a command or script via a potential backdoor.", "query": "network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_accepted\" and (\n  (process.name regex~ \"\"\"php?[0-9]?\\.?[0-9]{0,2}\"\"\" and process.command_line like \"*-S*\") or\n  (process.name like \"python*\" and process.command_line like (\"*--cgi*\", \"*CGIHTTPServer*\"))\n)", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_simple_web_server_connection_accepted.toml"}
{"title": "Simple HTTP Web Server Creation", "description": "This rule detects the creation of a simple HTTP web server using PHP or Python built-in modules. Adversaries may create\nsimple HTTP web servers to establish persistence on a compromised system by uploading a reverse or command shell payload\nto the server web root, allowing them to regain remote access to the system if lost.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\") and\n  (\n    (process.name regex~ \"\"\"php?[0-9]?\\.?[0-9]{0,2}\"\"\" and process.args == \"-S\") or\n    (process.name like \"python*\" and process.args in (\"--cgi\", \"CGIHTTPServer\"))\n  ) and\nnot process.parent.name in (\"check_kmp_wrapper\", \"naemon\")", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_simple_web_server_creation.toml"}
{"title": "Python Site or User Customize File Creation", "description": "This rule detects the creation and modification of sitecustomize.py and usercustomize.py, which\nPython automatically executes on startup. Attackers can exploit these files for persistence by\ninjecting malicious code. The rule monitors system-wide, user-specific, and virtual environment\nlocations to catch unauthorized changes that could indicate persistence or backdooring attempts.", "query": "file where host.os.type == \"linux\" and event.type in (\"creation\", \"rename\") and process.executable != null and\nfile.path like~ (\n  \"/usr/lib/python*/sitecustomize.py\",\n  \"/usr/local/lib/python*/sitecustomize.py\",\n  \"/usr/lib/python*/dist-packages/sitecustomize.py\",\n  \"/usr/local/lib/python*/dist-packages/sitecustomize.py\",\n  \"/opt/*/lib/python*/sitecustomize.py\",\n  \"/home/*/.local/lib/python*/site-packages/usercustomize.py\",\n  \"/home/*/.config/python/usercustomize.py\"\n) and not (\n  process.executable in (\n    \"/usr/local/bin/pip2\", \"/usr/bin/restic\", \"/usr/bin/pacman\", \"/usr/bin/dockerd\", \"/usr/local/bin/pip3\",\n    \"/usr/bin/pip3\", \"/usr/local/bin/pip\", \"/usr/bin/pip\", \"/usr/bin/podman\", \"/usr/local/bin/poetry\",\n    \"/usr/bin/poetry\", \"/usr/bin/pamac-daemon\", \"./venv/bin/pip\"\n  ) or\n  process.executable like~ (\n    \"/usr/bin/python*\", \"/usr/local/bin/python*\", \"/opt/venv/bin/python*\",\n    \"/nix/store/*libexec/docker/dockerd\", \"/snap/docker/*dockerd\"\n  )\n)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_site_and_user_customize_file_creation.toml"}
{"title": "SSH Key Generated via ssh-keygen", "description": "This rule identifies the creation of SSH keys using the ssh-keygen tool, which is the standard utility for generating\nSSH keys. Users often create SSH keys for authentication with remote services. However, threat actors can exploit this\ntool to move laterally across a network or maintain persistence by generating unauthorized SSH keys, granting them SSH\naccess to systems.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and\nprocess.executable == \"/usr/bin/ssh-keygen\" and file.path : (\"/home/*/.ssh/*\", \"/root/.ssh/*\", \"/etc/ssh/*\") and\nnot file.name : \"known_hosts.*\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ssh_key_generation.toml"}
{"title": "Network Connection Initiated by SSHD Child Process", "description": "This rule identifies an egress internet connection initiated by an SSH Daemon child process. This behavior is\nindicative of the alteration of a shell configuration file or other mechanism that launches a process when a\nnew SSH login occurs. Attackers can also backdoor the SSH daemon to allow for persistence, call out to a C2\nor to steal credentials.", "query": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.executable == \"/usr/sbin/sshd\"] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\", \"172.31.0.0/16\"\n     )\n    ) and not (\n      process.executable in (\"/bin/yum\", \"/usr/bin/yum\") or\n      process.name in (\"login_duo\", \"ssh\", \"sshd\", \"sshd-session\")\n    )\n  ] by process.parent.entity_id", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ssh_netcon.toml"}
{"title": "Login via Unusual System User", "description": "This rule identifies successful logins by system users that are uncommon to authenticate. These users\nhave `nologin` set by default, and must be modified to allow SSH access. Adversaries may backdoor these users to\ngain unauthorized access to the system.", "query": "authentication where host.os.type == \"linux\" and event.action in (\"ssh_login\", \"user_login\") and\nuser.name in (\n  \"deamon\", \"bin\", \"sys\", \"games\", \"man\", \"lp\", \"mail\", \"news\", \"uucp\", \"proxy\", \"www-data\", \"backup\",\n  \"list\", \"irc\", \"gnats\", \"nobody\", \"systemd-timesync\", \"systemd-network\", \"systemd-resolve\", \"messagebus\",\n  \"avahi\", \"sshd\", \"dnsmasq\"\n) and event.outcome == \"success\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ssh_via_backdoored_system_user.toml"}
{"title": "Potential Suspicious File Edit", "description": "This rule monitors for the potential edit of a suspicious file. In Linux, when editing a file through an editor, a\ntemporary .swp file is created. By monitoring for the creation of this .swp file, we can detect potential file edits of\nsuspicious files. The execution of this rule is not a clear sign of the file being edited, as just opening the file\nthrough an editor will trigger this event. Attackers may alter any of the files added in this rule to establish\npersistence, escalate privileges or perform reconnaisance on the system.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and file.extension == \"swp\" and\nfile.path : (\n  /* common interesting files and locations */\n  \"/etc/.shadow.swp\", \"/etc/.shadow-.swp\", \"/etc/.shadow~.swp\", \"/etc/.gshadow.swp\", \"/etc/.gshadow-.swp\",\n  \"/etc/.passwd.swp\", \"/etc/.pwd.db.swp\", \"/etc/.master.passwd.swp\", \"/etc/.spwd.db.swp\", \"/etc/security/.opasswd.swp\",\n  \"/etc/.environment.swp\", \"/etc/.profile.swp\", \"/etc/sudoers.d/.*.swp\", \"/etc/ld.so.conf.d/.*.swp\",\n  \"/etc/init.d/.*.swp\", \"/etc/.rc.local.swp\", \"/etc/rc*.d/.*.swp\", \"/dev/shm/.*.swp\", \"/etc/update-motd.d/.*.swp\",\n  \"/usr/lib/update-notifier/.*.swp\",\n\n  /* service, timer, want, socket and lock files */\n  \"/etc/systemd/system/.*.swp\", \"/usr/local/lib/systemd/system/.*.swp\", \"/lib/systemd/system/.*.swp\",\n  \"/usr/lib/systemd/system/.*.swp\",\"/home/*/.config/systemd/user/.*.swp\", \"/run/.*.swp\", \"/var/run/.*.swp/\",\n\n  /* profile and shell configuration files */\n  \"/home/*.profile.swp\", \"/home/*.bash_profile.swp\", \"/home/*.bash_login.swp\", \"/home/*.bashrc.swp\", \"/home/*.bash_logout.swp\",\n  \"/home/*.zshrc.swp\", \"/home/*.zlogin.swp\", \"/home/*.tcshrc.swp\", \"/home/*.kshrc.swp\", \"/home/*.config.fish.swp\",\n  \"/root/*.profile.swp\", \"/root/*.bash_profile.swp\", \"/root/*.bash_login.swp\", \"/root/*.bashrc.swp\", \"/root/*.bash_logout.swp\",\n  \"/root/*.zshrc.swp\", \"/root/*.zlogin.swp\", \"/root/*.tcshrc.swp\", \"/root/*.kshrc.swp\", \"/root/*.config.fish.swp\"\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_file_opened_through_editor.toml"}
{"title": "Potential Execution via XZBackdoor", "description": "It identifies potential malicious shell executions through remote SSH and detects cases where the sshd service suddenly\nterminates soon after successful execution, suggesting suspicious behavior similar to the XZ backdoor.", "query": "sequence by host.id, user.id with maxspan=1s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"sshd\" and\n    process.args == \"-D\" and process.args == \"-R\"] by process.pid, process.entity_id\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"sshd\" and\n  process.executable != null and not (\n    process.executable in (\"/usr/sbin/sshd\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/bin/fipscheck\") or\n    process.args like (\"rsync*\", \"systemctl*\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/sbin/aad_certhandler*\") or\n    process.command_line like \"sh -c /usr/bin/env -i PATH=*\"\n  )] by process.parent.pid, process.parent.entity_id\n [process where host.os.type == \"linux\" and event.action == \"end\" and process.name == \"sshd\" and process.exit_code != 0] by process.pid, process.entity_id\n [network where host.os.type == \"linux\" and event.type == \"end\" and event.action == \"disconnect_received\" and process.name == \"sshd\"] by process.pid, process.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_ssh_execution_xzbackdoor.toml"}
{"title": "Systemd Generator Created", "description": "This rule detects the creation of a systemd generator file. Generators are small executables executed by systemd at\nbootup and during configuration reloads. Their main role is to convert non-native configuration and execution parameters\ninto dynamically generated unit files, symlinks, or drop-ins, extending the unit file hierarchy for the service manager.\nSystemd generators can be used to execute arbitrary code at boot time, which can be leveraged by attackers to maintain\npersistence on a Linux system.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n\"/run/systemd/system-generators/*\", \"/etc/systemd/system-generators/*\",\n\"/usr/local/lib/systemd/system-generators/*\", \"/lib/systemd/system-generators/*\",\n\"/usr/lib/systemd/system-generators/*\", \"/etc/systemd/user-generators/*\",\n\"/usr/local/lib/systemd/user-generators/*\", \"/usr/lib/systemd/user-generators/*\",\n\"/lib/systemd/user-generators/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/usr/sbin/sshd\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\"\n  ) or\n  process.name like~ (\"ssm-agent-worker\", \"crio\", \"docker-init\", \"systemd\", \"pacman\", \"python*\", \"platform-python*\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable == null\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_systemd_generator_creation.toml"}
{"title": "Suspicious Network Connection via systemd", "description": "Detects suspicious network events executed by systemd, potentially indicating persistence through a systemd backdoor.\nSystemd is a system and service manager for Linux operating systems, used to initialize and manage system processes.\nAttackers can backdoor systemd for persistence by creating or modifying systemd unit files to execute malicious scripts\nor commands, or by replacing legitimate systemd binaries with compromised ones, ensuring that their malicious code is\nautomatically executed at system startup or during certain system events.", "query": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"systemd\" and process.name in (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\"\n   )\n  ] by process.entity_id\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and\n   not process.executable == \"/tmp/newroot/bin/curl\"] by process.parent.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_systemd_netcon.toml"}
{"title": "Systemd Timer Created", "description": "Detects the creation of a systemd timer within any of the default systemd timer directories. Systemd timers can be used\nby an attacker to gain persistence, by scheduling the execution of a command or script. Similarly to cron/at, systemd\ntimers can be set up to execute on boot time, or on a specific point in time, which allows attackers to regain access in\ncase the connection to the infected asset was lost.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"timer\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/kaniko/executor\"\n  ) or\n  process.name like (\n    \"python*\", \"crio\", \"apt-get\", \"install\", \"snapd\", \"cloudflared\", \"sshd\", \"convert-usrmerge\", \"docker-init\",\n    \"google_metadata_script_runner\", \"ssm-agent-worker\", \"pacman\", \"convert2rhel\", \"platform-python\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_systemd_scheduled_timer_created.toml"}
{"title": "Systemd Service Created", "description": "This rule detects the creation or renaming of a new Systemd file in all of the common Systemd service locations for both\nroot and regular users. Systemd service files are configuration files in Linux systems used to define and manage system\nservices. Malicious actors can leverage systemd service files to achieve persistence by creating or modifying services\nto execute malicious commands or payloads during system startup or at a predefined interval by adding a systemd timer.\nThis allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"service\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name like (\n    \"ssm-agent-worker\", \"python*\", \"platform-python*\", \"dnf_install\", \"cloudflared\", \"lxc-pve-prestart-hook\",\n    \"convert-usrmerge\", \"elastic-agent\", \"google_metadata_script_runner\", \"update-alternatives\", \"gitlab-runner\",\n    \"install\", \"crio\", \"apt-get\", \"package-cleanup\", \"dcservice\", \"dcregister\", \"jumpcloud-agent\", \"executor\",\n    \"pacman\", \"convert2rhel\", \"packagekitd\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_systemd_service_creation.toml"}
{"title": "Systemd Service Started by Unusual Parent Process", "description": "Systemctl is a process used in Linux systems to manage systemd processes through service configuration files. Malicious\nactors can leverage systemd services to achieve persistence by creating or modifying service files to execute malicious\ncommands or payloads during system startup. This allows them to maintain unauthorized access, execute additional\nmalicious activities, or evade detection.", "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and\nprocess.executable:/usr/bin/systemctl and process.args:(enable or reenable or start) and \nprocess.entry_leader.entry_meta.type:* and\nnot (\n  process.entry_leader.entry_meta.type:(container or init or unknown) or\n  process.parent.pid:1 or\n  process.parent.executable:(\n    /bin/adduser or /bin/dnf or /bin/dnf-automatic or /bin/dockerd or /bin/dpkg or /bin/microdnf or /bin/pacman or\n    /bin/podman or /bin/rpm or /bin/snapd or /bin/sudo or /bin/useradd or /bin/yum or /usr/bin/dnf or\n    /usr/bin/dnf-automatic or /usr/bin/dockerd or /usr/bin/dpkg or /usr/bin/microdnf or /usr/bin/pacman or\n    /usr/bin/podman or /usr/bin/rpm or /usr/bin/snapd or /usr/bin/sudo or /usr/bin/yum or /usr/sbin/adduser or\n    /usr/sbin/invoke-rc.d or /usr/sbin/useradd or /var/lib/dpkg/*\n  ) or\n  process.args_count >= 5\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_systemd_service_started.toml"}
{"title": "Systemd Shell Execution During Boot", "description": "This rule detects the execution of shell commands by systemd during the boot process on Linux systems. Systemd\nis a system and service manager for Linux operating systems. Attackers may execute shell commands during the\nboot process to maintain persistence on the system. This may be a sign of malicious systemd services, initramfs\nor GRUB bootloader manipulation, or other persistence mechanisms.", "query": "process where host.os.type == \"linux\" and event.type == \"info\" and event.action == \"already_running\" and\nprocess.parent.name == \"systemd\" and process.name in (\"bash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nprocess.parent.command_line == \"/sbin/init\" and process.args_count >= 2", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_systemd_shell_execution.toml"}
{"title": "Tainted Kernel Module Load", "description": "This rule monitors the syslog log file for messages related to instances of a tainted kernel module load. Rootkits often\nleverage kernel modules as their main defense evasion technique. Detecting tainted kernel module loads is crucial for\nensuring system security and integrity, as malicious or unauthorized modules can compromise the kernel and lead to\nsystem vulnerabilities or unauthorized access.", "query": "host.os.type:linux and event.dataset:\"system.syslog\" and process.name:kernel and\nmessage:\"module verification failed: signature and/or required key missing - tainting kernel\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_tainted_kernel_module_load.toml"}
{"title": "Tainted Out-Of-Tree Kernel Module Load", "description": "This rule monitors the syslog log file for messages related to instances of a out-of-tree kernel module load, indicating\nthe taining of the kernel. Rootkits often leverage kernel modules as their main defense evasion technique. Detecting\ntainted kernel module loads is crucial for ensuring system security and integrity, as malicious or unauthorized modules\ncan compromise the kernel and lead to system vulnerabilities or unauthorized access.", "query": "host.os.type:linux and event.dataset:\"system.syslog\" and process.name:kernel and\nmessage:\"loading out-of-tree module taints kernel.\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_tainted_kernel_module_out_of_tree_load.toml"}
{"title": "Systemd-udevd Rule File Creation", "description": "Monitors for the creation of rule files that are used by systemd-udevd to manage device nodes and handle kernel device\nevents in the Linux operating system. Systemd-udevd can be exploited for persistence by adversaries by creating\nmalicious udev rules that trigger on specific events, executing arbitrary commands or payloads whenever a certain device\nis plugged in or recognized by the system.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nprocess.executable != null and file.extension == \"rules\" and\nfile.path : (\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\", \"/usr/local/lib/udev/rules.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/lib/systemd/system-generators/netplan\", \"/lib/systemd/systemd\", \"/usr/bin/containerd\", \"/usr/sbin/sshd\",\n    \"/kaniko/executor\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\"\n  ) or\n  process.name in (\n    \"systemd\", \"netplan\", \"apt-get\", \"vmware-config-tools.pl\", \"systemd-hwdb\", \"ssm-agent-worker\", \"crio\", \"cloud-init\", \"convert2rhel\" \n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_udev_rule_creation.toml"}
{"title": "Initramfs Unpacking via unmkinitramfs", "description": "This rule detects the unpacking of an initramfs image using the `unmkinitramfs` command on Linux systems. The\n`unmkinitramfs` command is used to extract the contents of an initramfs image, which is used to boot the system.\nAttackers may use `unmkinitramfs` to unpack an initramfs image and modify its contents to include malicious code or\nbackdoors, allowing them to maintain persistence on the system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\") and\nprocess.name == \"unmkinitramfs\"", "tactic": "Persistence", "technique": "Pre-OS Boot", "technique_id": "T1542", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_unpack_initramfs_via_unmkinitramfs.toml"}
{"title": "Unusual Exim4 Child Process", "description": "This rule detects the execution of unusual commands via a descendant process of exim4. Attackers may use descendant\nprocesses of exim4 to evade detection and establish persistence or execute post-exploitation commands on a target system.", "query": "host.os.type:linux and event.type:start and event.action:exec and process.parent.name:exim4 and\nnot process.name:(\n  exim4 or start-stop-daemon or run-parts or systemctl or update-exim4.conf or install or plymouth or\n  readlink or grep or stat or cmake or gcc or cppcheck or sort or sshd\n)", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_unusual_exim4_child_process.toml"}
{"title": "Authentication via Unusual PAM Grantor", "description": "This rule detects successful authentications via PAM grantors that are not commonly used. This could indicate an\nattacker is attempting to escalate privileges or maintain persistence on the system by modifying the default PAM\nconfiguration.", "query": "event.category:authentication and host.os.type:linux and event.action:authenticated and event.outcome:success and\nauditd.data.grantors:(* and not (pam_rootok or *pam_cap* or *pam_permit*))", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_unusual_pam_grantor.toml"}
{"title": "Unusual SSHD Child Process", "description": "This rule detects the creation of an unusual SSHD child process through the usage of the `new_terms` rule type.\nAttackers may abuse SSH to maintain persistence on a compromised system, or to establish a backdoor for remote access,\npotentially resulting in an unusual SSHD child process being created.", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\nprocess.parent.name:(ssh or sshd) and process.args_count:2 and\nnot (\n  process.command_line:(-bash or -zsh or -sh) or\n  process.name:(ractrans or exectask or tty or tput or ferny-askpass or id or ip)\n)", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_unusual_sshd_child_process.toml"}
{"title": "Linux User Account Credential Modification", "description": "This rule detects Linux user account credential modification events where the echo command is\nused to directly echo a password into the passwd utility. This technique is used by malware\nto automate the process of user account credential modification on Linux systems post-infection.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nprocess.command_line like~ \"*echo*passwd*\" and\nnot (\n  process.parent.command_line == \"runc init\" or\n  process.parent.executable in (\"/usr/bin/make\", \"/bin/make\")\n)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_credential_modification_via_echo.toml"}
{"title": "User or Group Creation/Modification", "description": "This rule leverages the `auditd_manager` integration to detect user or group creation or modification events on Linux\nsystems. Threat actors may attempt to create or modify users or groups to establish persistence on the system.", "query": "iam where host.os.type == \"linux\" and event.type in (\"creation\", \"change\") and auditd.result == \"success\" and\nevent.action in (\"changed-password\", \"added-user-account\", \"added-group-account-to\") and process.name != null", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_or_group_creation_or_modification.toml"}
{"title": "Unusual Process Spawned from Web Server Parent", "description": "This rule detects unusual processes spawned from a web server parent process by identifying low frequency counts of\nprocess spawning activity. Unusual process spawning activity may indicate an attacker attempting to establish\npersistence, execute malicious commands, or establish command and control channels on the host system. ES|QL rules have\nlimited fields available in its alert documents. Make sure to review the original documents to aid in the investigation\nof this alert.", "query": "from logs-endpoint.events.process-*\n| keep @timestamp, host.os.type, event.type, event.action, process.parent.name, user.name, user.id, process.working_directory, process.name, process.executable, process.command_line, process.parent.executable, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.parent.name in (\n    \"apache\", \"nginx\", \"apache2\", \"httpd\", \"lighttpd\", \"caddy\", \"node\", \"mongrel_rails\", \"java\", \"gunicorn\",\n    \"uwsgi\", \"openresty\", \"cherokee\", \"h2o\", \"resin\", \"puma\", \"unicorn\", \"traefik\", \"tornado\", \"hypercorn\",\n    \"daphne\", \"twistd\", \"yaws\", \"webfsd\", \"httpd.worker\", \"flask\", \"rails\", \"mongrel\"\n  ) or\n  process.parent.name like \"php-*\" or\n  process.parent.name like \"python*\" or\n  process.parent.name like \"ruby*\" or\n  process.parent.name like \"perl*\" or\n  user.name in (\n    \"apache\", \"www-data\", \"httpd\", \"nginx\", \"lighttpd\", \"tomcat\", \"tomcat8\", \"tomcat9\", \"ftp\", \"ftpuser\", \"ftpd\"\n  ) or\n  user.id in (\"99\", \"33\", \"498\", \"48\") or\n  process.working_directory like \"/var/www/*\"\n) and\nnot (\n  process.working_directory like \"/home/*\" or\n  process.working_directory like \"/\" or\n  process.parent.executable like \"/vscode/vscode-server/*\"\n)\n| stats cc = count(), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.executable, process.working_directory, process.parent.executable\n| where agent_count == 1 and cc < 5\n| sort cc asc\n| limit 100", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_web_server_sus_child_spawned.toml"}
{"title": "Unusual Command Execution from Web Server Parent", "description": "This rule detects potential command execution from a web server parent process on a Linux host. Adversaries may attempt\nto execute commands from a web server parent process to blend in with normal web server activity and evade detection.\nThis behavior is commonly observed in web shell attacks where adversaries exploit web server vulnerabilities to execute\narbitrary commands on the host. The detection rule identifies unusual command execution from web server parent\nprocesses, which may indicate a compromised host or an ongoing attack. ES|QL rules have limited fields available in its\nalert documents. Make sure to review the original documents to aid in the investigation of this alert.", "query": "from logs-endpoint.events.process-*\n| keep @timestamp, host.os.type, event.type, event.action, process.parent.name, user.name, user.id, process.working_directory, process.name, process.command_line, process.parent.executable, agent.id, host.name\n| where @timestamp > now() - 1 hours\n| where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  process.parent.name in (\n    \"apache\", \"nginx\", \"apache2\", \"httpd\", \"lighttpd\", \"caddy\", \"node\", \"mongrel_rails\", \"java\", \"gunicorn\",\n    \"uwsgi\", \"openresty\", \"cherokee\", \"h2o\", \"resin\", \"puma\", \"unicorn\", \"traefik\", \"tornado\", \"hypercorn\",\n    \"daphne\", \"twistd\", \"yaws\", \"webfsd\", \"httpd.worker\", \"flask\", \"rails\", \"mongrel\"\n  ) or\n  process.parent.name like \"php-*\" or\n  process.parent.name like \"python*\" or\n  process.parent.name like \"ruby*\" or\n  process.parent.name like \"perl*\" or\n  user.name in (\n    \"apache\", \"www-data\", \"httpd\", \"nginx\", \"lighttpd\", \"tomcat\", \"tomcat8\", \"tomcat9\", \"ftp\", \"ftpuser\", \"ftpd\"\n  ) or\n  user.id in (\"99\", \"33\", \"498\", \"48\") or\n  process.working_directory like \"/var/www/*\"\n) and\n  process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and process.command_line like \"* -c *\" and\n  not (\n  process.working_directory like \"/home/*\" or\n  process.working_directory like \"/\" or\n  process.working_directory like \"/vscode/vscode-server/*\" or\n  process.parent.executable like \"/vscode/vscode-server/*\" or\n  process.parent.executable == \"/usr/bin/xfce4-terminal\"\n)\n| stats cc = count(), agent_count = count_distinct(agent.id), host.name = VALUES(host.name), agent.id = VALUES(agent.id) by process.command_line, process.working_directory, process.parent.executable\n| where agent_count == 1 and cc < 5\n| sort cc asc\n| limit 100", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_web_server_sus_command_execution.toml"}
{"title": "Uncommon Destination Port Connection by Web Server", "description": "This rule identifies unusual destination port network activity originating from a web server process. The\nrule is designed to detect potential web shell activity or unauthorized communication from a web server\nprocess to external systems.", "query": "network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and (\n     user.name in (\n      \"apache\", \"www-data\", \"httpd\", \"nginx\", \"lighttpd\", \"tomcat\", \"tomcat8\", \"tomcat9\", \"ftp\", \"ftpuser\", \"ftpd\"\n     ) or\n     user.id in (\"99\", \"33\", \"498\", \"48\")\n   ) and (\n   process.name in (\n    \"apache\", \"nginx\", \"apache2\", \"httpd\", \"lighttpd\", \"caddy\", \"node\", \"mongrel_rails\", \"java\", \"gunicorn\",\n    \"uwsgi\", \"openresty\", \"cherokee\", \"h2o\", \"resin\", \"puma\", \"unicorn\", \"traefik\", \"tornado\", \"hypercorn\",\n    \"daphne\", \"twistd\", \"yaws\", \"webfsd\", \"httpd.worker\", \"flask\", \"rails\", \"mongrel\"\n  ) or\n    process.name like (\"php-*\", \"python*\", \"ruby*\", \"perl*\")\n) and\nnetwork.direction == \"egress\" and destination.ip != null and\nnot destination.port in (80, 443, 8080, 8443, 8000, 8888, 3128, 3306) and\nnot cidrmatch(destination.ip, \"127.0.0.0/8\", \"::1\",\"FE80::/10\", \"FF00::/8\")\n\n/* \nThis rule does not exclude local IP ranges by default. To exclude these, use the following exclusion statement:\ncidrmatch(destination.ip, \"10.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\",\n\"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\",\n\"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"224.0.0.0/4\", \"240.0.0.0/4\")\n*/", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_web_server_sus_destination_port.toml"}
{"title": "Network Connections Initiated Through XDG Autostart Entry", "description": "Detects network connections initiated through Cross-Desktop Group (XDG) autostart entries for GNOME and XFCE-based Linux\ndistributions. XDG Autostart entries can be used to execute arbitrary commands or scripts when a user logs in. This rule\nhelps to identify potential malicious activity where an attacker may have modified XDG autostart scripts to establish\npersistence on the system.", "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n     (process.parent.executable == \"/usr/bin/xfce4-session\") or\n     (process.executable == \"/bin/sh\" and process.args == \"-e\" and process.args == \"-u\" and\n      process.args == \"-c\" and process.args : \"export GIO_LAUNCHED_DESKTOP_FILE_PID=$$;*\")\n   )\n  ]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\", \"172.31.0.0/16\"\n       ) or\n       process.name in (\n         \"telegram-desktop\", \"firefox\", \"gnome-calculator\", \"remmina\", \"spotify\", \"librewolf\", \"fortitraylauncher\",\n         \"flameshot\", \"thunderbird\", \"update-manager\", \"warp-terminal\", \"obs\", \"transmission-gtk\"\n       )\n     )\n  ]", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_xdg_autostart_netcon.toml"}
{"title": "Yum Package Manager Plugin File Creation", "description": "Detects file creation events in the plugin directories for the Yum package manager. In Linux, Yum (Yellowdog Updater,\nModified) is a command-line utility used for handling packages on (by default) Fedora-based systems, providing functions\nfor installing, updating, upgrading, and removing software along with managing package repositories. Attackers can\nbackdoor Yum to gain persistence by injecting malicious code into plugins that Yum runs, thereby ensuring continued\nunauthorized access or control each time Yum is used for package management.", "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : (\"/usr/lib/yum-plugins/*\", \"/etc/yum/pluginconf.d/*\") and not (\n  process.executable in (\n    \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\", \"/usr/bin/microdnf\", \"/bin/rpm\",\n    \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\", \"/bin/puppet\",\n    \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/bin/autossl_check\",\n    \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\",\n    \"/usr/libexec/netplan/generate\"\n  ) or\n  process.name in (\"yumBackend.py\", \"crio\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\") or\n  file.Ext.original.name like \".ansible*\" or\n  file.name like \".ansible_tmp*\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_yum_package_manager_plugin_file_creation.toml"}
{"title": "Potential Unauthorized Access via Wildcard Injection Detected", "description": "This rule monitors for the execution of the \"chown\" and \"chmod\" commands with command line flags that could indicate a\nwildcard injection attack. Linux wildcard injection is a type of security vulnerability where attackers manipulate\ncommands or input containing wildcards (e.g., *, ?, []) to execute unintended operations or access sensitive data by\ntricking the system into interpreting the wildcard characters in unexpected ways.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.name in (\"chown\", \"chmod\") and process.args == \"-R\" and process.args : \"--reference=*\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_chown_chmod_unauthorized_file_read.toml"}
{"title": "Potential Privilege Escalation via Container Misconfiguration", "description": "This rule monitors for the execution of processes that interact with Linux containers through an interactive shell\nwithout root permissions. Utilities such as runc and ctr are universal command-line utilities leveraged to interact with\ncontainers via root permissions. On systems where the access to these utilities are misconfigured, attackers might be\nable to create and run a container that mounts the root folder or spawn a privileged container vulnerable to a container\nescape attack, which might allow them to escalate privileges and gain further access onto the host file system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name == \"runc\" and process.args == \"run\") or\n  (process.name == \"ctr\" and process.args == \"run\" and process.args in (\"--privileged\", \"--mount\"))\n) and not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\" and\nprocess.interactive == true and process.parent.interactive == true", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_container_util_misconfiguration.toml"}
{"title": "Potential Privilege Escalation via Linux DAC permissions", "description": "Identifies potential privilege escalation exploitation of DAC (Discretionary access control) file permissions. The rule\nidentifies exploitation of DAC checks on sensitive file paths via suspicious processes whose capabilities include\nCAP_DAC_OVERRIDE (where a process can bypass all read write and execution checks) or CAP_DAC_READ_SEARCH (where a\nprocess can read any file or perform any executable permission on the directories).", "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\n(process.thread.capabilities.permitted:CAP_DAC_* or process.thread.capabilities.effective: CAP_DAC_*) and\nprocess.command_line:(*sudoers* or *passwd* or *shadow* or */root/.ssh*) and not (\n  user.id : \"0\" or\n  process.name : (\n    \"tar\" or \"getent\" or \"su\" or \"stat\" or \"dirname\" or \"chown\" or \"sudo\" or \"dpkg-split\" or \"dpkg-deb\" or \"dpkg\" or\n    \"podman\" or \"awk\" or \"passwd\" or \"dpkg-maintscript-helper\" or \"mutt_dotlock\" or \"nscd\" or \"logger\" or \"gpasswd\"\n  ) or\n  process.executable : /usr/lib/*/lxc/rootfs/* or\n  process.parent.name : (\n    \"dpkg\" or \"java\" or *postinst or \"dpkg-preconfigure\" or \"gnome-shell\"\n  )\n)", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_dac_permissions.toml"}
{"title": "File System Debugger Launched Inside a Container", "description": "This rule detects the use of the built-in Linux DebugFS utility from inside a container. DebugFS is a special\nfile system debugging utility which supports reading and writing directly from a hard drive device. When launched inside\na privileged container, a container deployed with all the capabilities of the host machine, an attacker can access\nsensitive host level files which could be used for further privilege escalation and container escapes to the host\nmachine.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name == \"debugfs\" and\nprocess.command_line like~ \"/dev/sd*\" and not process.args == \"-R\"", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_debugfs_launched_inside_container.toml"}
{"title": "Docker Escape via Nsenter", "description": "This rule identifies a UID change event via `nsenter`. The `nsenter` command is used to enter a namespace, which is a\nway to isolate processes and resources. Attackers can use `nsenter` to escape from a container to the host, which can\nlead to privilege escalation and lateral movement.", "query": "process where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"uid_change\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.args == \"nsenter\" and\nprocess.args in (\"-t\", \"--target\") and process.args_count >= 4", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_docker_escape_via_nsenter.toml"}
{"title": "Potential Chroot Container Escape via Mount", "description": "Monitors for the execution of a file system mount followed by a chroot execution. Given enough permissions, a user\nwithin a container is capable of mounting the root file system of the host, and leveraging chroot to escape its\ncontainarized environment. This behavior pattern is very uncommon and should be investigated.", "query": "sequence by host.id, process.parent.entity_id with maxspan=5m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.name == \"mount\" and process.args : \"/dev/sd*\" and process.args_count >= 3 and\n   process.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n   process.name == \"chroot\"]", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_docker_mount_chroot_container_escape.toml"}
{"title": "Docker Release File Creation", "description": "This rule detects the creation of files named release_agent or notify_on_release, which are\ncommonly associated with the abuse of Linux cgroup release mechanisms. In Docker or containerized\nenvironments, this behavior may indicate an attempt to exploit privilege escalation vulnerabilities\nsuch as CVE-2022-0492, where attackers use the release_agent feature to execute code on the host\nfrom within a container.", "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.name in (\"release_agent\", \"notify_on_release\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_docker_release_file_creation.toml"}
{"title": "Potential Privilege Escalation via Enlightenment", "description": "Identifies an attempt to exploit a local privilege escalation CVE-2022-37706 via a flaw in Linux window manager package\nEnlightenment. enlightenment_sys in Enlightenment before 0.25.4 allows local users to gain privileges because it is\nsetuid root, and the system library function mishandles pathnames that begin with a /dev/.. substring.", "query": "sequence by host.id, process.parent.entity_id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n    process.name == \"enlightenment_sys\" and process.args in (\"/bin/mount/\", \"-o\",\"noexec\",\"nosuid\",\"nodev\",\"uid=*\") ]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and user.id == \"0\"]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_enlightenment_window_manager.toml"}
{"title": "Privilege Escalation via GDB CAP_SYS_PTRACE", "description": "Identifies instances where GDB (granted the CAP_SYS_PTRACE capability) is executed, after which the user's access is\nelevated to UID/GID 0 (root). In Linux, the CAP_SYS_PTRACE capability grants a process the ability to use the ptrace\nsystem call, which is typically used for debugging and allows the process to trace and control other processes.\nAttackers may leverage this capability to hook and inject into a process that is running with root permissions in order\nto escalate their privileges to root.", "query": "sequence by host.id, process.entry_leader.entity_id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"gdb\" and\n   (process.thread.capabilities.effective : \"CAP_SYS_PTRACE\" or process.thread.capabilities.permitted : \"CAP_SYS_PTRACE\") and\n   user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name != null and user.id == \"0\"]", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_gdb_sys_ptrace_elevation.toml"}
{"title": "Root Network Connection via GDB CAP_SYS_PTRACE", "description": "Identifies instances where GDB (granted the CAP_SYS_PTRACE capability) is executed, after which an outbound network\nconnection is initiated by UID/GID 0 (root). In Linux, the CAP_SYS_PTRACE capability grants a process the ability to use\nthe ptrace system call, which is typically used for debugging and allows the process to trace and control other\nprocesses. Attackers may leverage this capability to hook and inject into a process that is running with root\npermissions in order to execute shell code and gain a reverse shell with root privileges.", "query": "sequence by host.id, process.entry_leader.entity_id with maxspan=30s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"gdb\" and\n   (process.thread.capabilities.effective : \"CAP_SYS_PTRACE\" or process.thread.capabilities.permitted : \"CAP_SYS_PTRACE\") and\n   user.id != \"0\"]\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and\n   process.name != null and user.id == \"0\"]", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_gdb_sys_ptrace_netcon.toml"}
{"title": "Suspicious Kworker UID Elevation", "description": "Monitors for the elevation of regular user permissions to root permissions through the kworker process. kworker, or\nkernel worker, processes are part of the kernel's workqueue mechanism. They are responsible for executing work that has\nbeen scheduled to be done in kernel space, which might include tasks like handling interrupts, background activities,\nand other kernel-related tasks. Attackers may attempt to evade detection by masquerading as a kernel worker process, and\nhijack the execution flow by hooking certain functions/syscalls through a rootkit in order to provide easy access to\nroot via a special modified command.", "query": "process where host.os.type == \"linux\" and event.action == \"session_id_change\" and process.name : \"kworker*\" and\nuser.id == \"0\"", "tactic": "Privilege Escalation", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_kworker_uid_elevation.toml"}
{"title": "Modification of Dynamic Linker Preload Shared Object", "description": "Identifies modification of the dynamic linker preload shared object (ld.so.preload). Adversaries may execute malicious\npayloads by hijacking the dynamic linker used to load libraries.", "query": "host.os.type:linux and event.category:file and event.action:(file_rename_event or rename or renamed or updated) and\nnot event.type:deletion and file.path:/etc/ld.so.preload and\nprocess.name:(* and not (oneagentinstallaction or passwd or wine))", "tactic": "Privilege Escalation", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_ld_preload_shared_object_modif.toml"}
{"title": "Suspicious Symbolic Link Created", "description": "Identifies the creation of a symbolic link to a suspicious file or location. A symbolic link is a reference to a file or\ndirectory that acts as a pointer or shortcut, allowing users to access the target file or directory from a different\nlocation in the file system. An attacker can potentially leverage symbolic links for privilege escalation by tricking a\nprivileged process into following the symbolic link to a sensitive file, giving the attacker access to data or\ncapabilities they would not normally have.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"ln\" and process.args in (\"-s\", \"-sf\") and\n  (\n    /* suspicious files */\n    (process.args in (\"/etc/shadow\", \"/etc/shadow-\", \"/etc/shadow~\", \"/etc/gshadow\", \"/etc/gshadow-\") or\n    (process.working_directory == \"/etc\" and process.args in (\"shadow\", \"shadow-\", \"shadow~\", \"gshadow\", \"gshadow-\"))) or\n\n    /* suspicious bins */\n    (process.args in (\"/bin/bash\", \"/bin/dash\", \"/bin/sh\", \"/bin/tcsh\", \"/bin/csh\", \"/bin/zsh\", \"/bin/ksh\", \"/bin/fish\") or\n    (process.working_directory == \"/bin\" and process.args : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or\n    (process.args in (\"/usr/bin/bash\", \"/usr/bin/dash\", \"/usr/bin/sh\", \"/usr/bin/tcsh\", \"/usr/bin/csh\", \"/usr/bin/zsh\", \"/usr/bin/ksh\", \"/usr/bin/fish\") or\n    (process.working_directory == \"/usr/bin\" and process.args in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or\n\n    /* suspicious locations */\n    (process.args : (\"/etc/cron.d/*\", \"/etc/cron.daily/*\", \"/etc/cron.hourly/*\", \"/etc/cron.weekly/*\", \"/etc/cron.monthly/*\")) or\n    (process.args : (\"/home/*/.ssh/*\", \"/root/.ssh/*\",\"/etc/sudoers.d/*\", \"/dev/shm/*\"))\n  ) and\n  process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n  not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_linux_suspicious_symbolic_link.toml"}
{"title": "Potential Privilege Escalation via UID INT_MAX Bug Detected", "description": "This rule monitors for the execution of the systemd-run command by a user with a UID that is larger than the maximum\nallowed UID size (INT_MAX). Some older Linux versions were affected by a bug which allows user accounts with a UID\ngreater than INT_MAX to escalate privileges by spawning a shell through systemd-run.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"ProcessRollup2\") and\n  process.name == \"systemd-run\" and process.args == \"-t\" and process.args_count >= 3 and user.id >= \"1000000000\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_linux_uid_int_max_bug.toml"}
{"title": "Kernel Load or Unload via Kexec Detected", "description": "This detection rule identifies the usage of kexec, helping to uncover unauthorized kernel replacements and potential\ncompromise of the system's integrity. Kexec is a Linux feature that enables the loading and execution of a different\nkernel without going through the typical boot process. Malicious actors can abuse kexec to bypass security measures,\nescalate privileges, establish persistence or hide their activities by loading a malicious kernel, enabling them to\ntamper with the system's trusted state, allowing e.g. a VM Escape.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.name == \"kexec\" and process.args in (\"--exec\", \"-e\", \"--load\", \"-l\", \"--unload\", \"-u\") and\n  not process.parent.name in (\"kdumpctl\", \"unload.sh\")", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_load_and_unload_of_kernel_via_kexec.toml"}
{"title": "Potential Privilege Escalation via CVE-2023-4911", "description": "This rule detects potential privilege escalation attempts through Looney Tunables (CVE-2023-4911). Looney Tunables is a\nbuffer overflow vulnerability in GNU C Library's dynamic loader's processing of the GLIBC_TUNABLES environment variable.", "query": "sequence by host.id, process.parent.entity_id, process.executable with maxspan=5s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.env_vars : \"*GLIBC_TUNABLES=glibc.*=glibc.*=*\"] with runs=5", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_looney_tunables_cve_2023_4911.toml"}
{"title": "Mount Launched Inside a Container", "description": "This rule detects the use of the mount utility from inside a container. The mount command is used to make a\ndevice or file system accessible to the system, and then to connect its root directory to a specified mount point on the\nlocal file system. When launched inside a privileged container--a container deployed with all the capabilities of the\nhost machine-- an attacker can access sensitive host level files which could be used for further privilege escalation\nand container escapes to the host machine. Any usage of mount inside a running privileged container should be further\ninvestigated.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.entry_leader.entry_meta.type == \"container\" and process.name == \"mount\"", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_mount_launched_inside_container.toml"}
{"title": "Network Connection via Sudo Binary", "description": "Detects network connections initiated by the \"sudo\" binary. This behavior is uncommon and may occur in instances where\nreverse shell shellcode is injected into a process run with elevated permissions via \"sudo\". Attackers may attempt to\ninject shellcode into processes running as root, to escalate privileges.", "query": "sequence by host.id, process.entity_id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"connection_attempted\", \"ipv4_connection_attempt_event\") and process.name == \"sudo\" and not (\n    destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n      destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n      \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n      \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n      \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n      \"FF00::/8\", \"172.31.0.0/16\"\n    )\n  )]", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_netcon_via_sudo_binary.toml"}
{"title": "Potential Privilege Escalation via OverlayFS", "description": "Identifies an attempt to exploit a local privilege escalation (CVE-2023-2640 and CVE-2023-32629) via a flaw in Ubuntu's\nmodifications to OverlayFS. These flaws allow the creation of specialized executables, which, upon execution, grant the\nability to escalate privileges to root on the affected machine.", "query": "sequence by process.parent.entity_id, host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n    process.name == \"unshare\" and process.args : (\"-r\", \"-rm\", \"m\") and process.args : \"*cap_setuid*\"  and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and\n    user.id == \"0\"]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_overlayfs_local_privesc.toml"}
{"title": "Potential Privilege Escalation via PKEXEC", "description": "Identifies an attempt to exploit a local privilege escalation in polkit pkexec (CVE-2021-4034) via unsecure environment\nvariable injection. Successful exploitation allows an unprivileged user to escalate to the root user.", "query": "file where host.os.type == \"linux\" and file.path : \"/*GCONV_PATH*\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_pkexec_envar_hijack.toml"}
{"title": "Potential Buffer Overflow Attack Detected", "description": "Detects potential buffer overflow attacks by querying the \"Segfault Detected\" pre-built rule signal index, through a\nthreshold rule, with a minimum number of 100 segfault alerts in a short timespan. A large amount of segfaults in a short\ntime interval could indicate application exploitation attempts.", "query": "kibana.alert.rule.rule_id:\"5c81fc9d-1eae-437f-ba07-268472967013\" and host.os.type:linux and event.kind:signal", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_potential_bufferoverflow_attack.toml"}
{"title": "Privilege Escalation via SUID/SGID", "description": "Identifies instances where a process is executed with user/group ID 0 (root), and a real user/group ID that is not 0.\nThis is indicative of a process that has been granted SUID/SGID permissions, allowing it to run with elevated\nprivileges. Attackers may leverage a misconfiguration for exploitation in order to escalate their privileges to root, or\nestablish a backdoor for persistence.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.user.id == \"0\" and process.real_user.id != \"0\") or\n  (process.group.id == \"0\" and process.real_group.id != \"0\")\n) and (\n  process.name in (\n    \"aa-exec\", \"ab\", \"agetty\", \"alpine\", \"ar\", \"arj\", \"arp\", \"as\", \"ascii-xfr\", \"ash\", \"aspell\",\n    \"atobm\", \"awk\", \"base32\", \"base64\", \"basenc\", \"basez\", \"bash\", \"bc\", \"bridge\", \"busctl\",\n    \"busybox\", \"bzip2\", \"cabal\", \"capsh\", \"cat\", \"choom\", \"chown\", \"chroot\", \"clamscan\", \"cmp\",\n    \"column\", \"comm\", \"cp\", \"cpio\", \"cpulimit\", \"csh\", \"csplit\", \"csvtool\", \"cupsfilter\", \"curl\",\n    \"cut\", \"dash\", \"date\", \"dd\", \"debugfs\", \"dialog\", \"diff\", \"dig\", \"distcc\", \"dmsetup\", \"docker\",\n    \"dosbox\", \"ed\", \"efax\", \"elvish\", \"emacs\", \"env\", \"eqn\", \"espeak\", \"expand\", \"expect\", \"file\",\n    \"find\", \"fish\", \"flock\", \"fmt\", \"fold\", \"gawk\", \"gcore\", \"gdb\", \"genie\", \"genisoimage\", \"gimp\",\n    \"grep\", \"gtester\", \"gzip\", \"hd\", \"head\", \"hexdump\", \"highlight\", \"hping3\", \"iconv\", \"install\",\n    \"ionice\", \"ispell\", \"jjs\", \"join\", \"jq\", \"jrunscript\", \"julia\", \"ksh\", \"ksshell\", \"kubectl\",\n    \"ld.so\", \"less\", \"links\", \"logsave\", \"look\", \"lua\", \"make\", \"mawk\", \"minicom\", \"more\",\n    \"mosquitto\", \"msgattrib\", \"msgcat\", \"msgconv\", \"msgfilter\", \"msgmerge\", \"msguniq\", \"multitime\",\n    \"mv\", \"nasm\", \"nawk\", \"ncftp\", \"nft\", \"nice\", \"nl\", \"nm\", \"nmap\", \"node\", \"nohup\", \"ntpdate\",\n    \"od\", \"openssl\", \"openvpn\", \"pandoc\", \"paste\", \"perf\", \"perl\", \"pexec\", \"pg\", \"php\", \"pidstat\",\n    \"pr\", \"ptx\", \"python\", \"rc\", \"readelf\", \"restic\", \"rev\", \"rlwrap\", \"rsync\", \"rtorrent\",\n    \"run-parts\", \"rview\", \"rvim\", \"sash\", \"scanmem\", \"sed\", \"setarch\", \"setfacl\", \"setlock\", \"shuf\",\n    \"soelim\", \"softlimit\", \"sort\", \"sqlite3\", \"ss\", \"ssh-agent\", \"ssh-keygen\", \"ssh-keyscan\",\n    \"sshpass\", \"start-stop-daemon\", \"stdbuf\", \"strace\", \"strings\", \"sysctl\", \"systemctl\", \"tac\",\n    \"tail\", \"taskset\", \"tbl\", \"tclsh\", \"tee\", \"terraform\", \"tftp\", \"tic\", \"time\", \"timeout\", \"troff\",\n    \"ul\", \"unexpand\", \"uniq\", \"unshare\", \"unsquashfs\", \"unzip\", \"update-alternatives\", \"uudecode\",\n    \"uuencode\", \"vagrant\", \"varnishncsa\", \"view\", \"vigr\", \"vim\", \"vimdiff\", \"vipw\", \"w3m\", \"watch\",\n    \"wc\", \"wget\", \"whiptail\", \"xargs\", \"xdotool\", \"xmodmap\", \"xmore\", \"xxd\", \"xz\", \"yash\", \"zsh\",\n    \"zsoelim\"\n  ) or\n  process.name == \"ip\" and (\n    (process.args == \"-force\" and process.args in (\"-batch\", \"-b\")) or (process.args == \"exec\")\n  )\n) and not process.parent.name == \"spine\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_potential_suid_sgid_exploitation.toml"}
{"title": "Potential Shell via Wildcard Injection Detected", "description": "This rule monitors for the execution of a set of linux binaries, that are potentially vulnerable to wildcard injection,\nwith suspicious command line flags followed by a shell spawn event. Linux wildcard injection is a type of security\nvulnerability where attackers manipulate commands or input containing wildcards (e.g., *, ?, []) to execute unintended\noperations or access sensitive data by tricking the system into interpreting the wildcard characters in unexpected ways.", "query": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and (\n    (process.name == \"tar\" and process.args : \"--checkpoint=*\" and process.args : \"--checkpoint-action=*\") or\n    (process.name == \"rsync\" and process.args : \"-e*\") or\n    (process.name == \"zip\" and process.args == \"--unzip-command\")\n   ) and not process.executable : \"/tmp/newroot/*\"\n  ]  by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"start\") and\n     process.parent.name : (\"tar\", \"rsync\", \"zip\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n  ] by process.parent.entity_id", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_potential_wildcard_shell_spawn.toml"}
{"title": "Potential Suspicious DebugFS Root Device Access", "description": "This rule monitors for the usage of the built-in Linux DebugFS utility to access a disk device without root permissions.\nLinux users that are part of the \"disk\" group have sufficient privileges to access all data inside of the machine\nthrough DebugFS. Attackers may leverage DebugFS in conjunction with \"disk\" permissions to read sensitive files owned by\nroot, such as the shadow file, root ssh private keys or other sensitive files that may allow them to further escalate\nprivileges.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"debugfs\" and process.args : \"/dev/sd*\" and not process.args == \"-R\" and\nnot user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sda_disk_mount_non_root.toml"}
{"title": "Potential Shadow File Read via Command Line Utilities", "description": "Identifies access to the /etc/shadow file via the commandline using standard system utilities. After elevating\nprivileges to root, threat actors may attempt to read or dump this file in order to gain valid credentials. They may\nutilize these to move laterally undetected and access additional resources.", "query": "host.os.type : \"linux\" and event.category : \"process\" and event.action : (\"exec\" or \"exec_event\") and\n(process.args : \"/etc/shadow\" or (process.working_directory: \"/etc\" and process.args: \"shadow\")) and not (\n  (process.executable : (\"/bin/chown\" or \"/usr/bin/chown\") and process.args : \"root:shadow\") or\n  (process.executable : (\"/bin/chmod\" or \"/usr/bin/chmod\") and process.args : \"640\") or\n  process.executable:(/vz/* or /var/lib/docker/* or /run/containerd/* or /tmp/.criu* or /tmp/newroot/*) or\n  process.parent.name:(gen_passwd_sets or scc_* or wazuh-modulesd)\n)", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_shadow_file_read.toml"}
{"title": "Potential Sudo Privilege Escalation via CVE-2019-14287", "description": "This rule monitors for the execution of a suspicious sudo command that is leveraged in CVE-2019-14287 to escalate\nprivileges to root. Sudo does not verify the presence of the designated user ID and proceeds to execute using a user ID\nthat can be chosen arbitrarily. By using the sudo privileges, the command \"sudo -u                              \nrepresenting the root user. This exploit may work for sudo versions prior to v1.28.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n  event.action in (\"exec\", \"exec_event\", \"start\", \"ProcessRollup2\", \"executed\", \"process_started\") and\n  process.name == \"sudo\" and process.args == \"-u#-1\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sudo_cve_2019_14287.toml"}
{"title": "Potential Sudo Hijacking", "description": "Identifies the creation of a sudo binary located at /usr/bin/sudo. Attackers may hijack the default sudo binary and\nreplace it with a custom binary or script that can read the user's password in clear text to escalate privileges or\nenable persistence onto the system every time the sudo binary is executed.", "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path in (\"/usr/bin/sudo\", \"/bin/sudo\") and not (\n  file.Ext.original.path in (\"/usr/bin/sudo\", \"/bin/sudo\") or\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/bin/pacman\", \"/usr/bin/pacman\",\n    \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/apt\",\n    \"/usr/sbin/pacman\", \"/usr/bin/microdnf\", \"/usr/local/bin/dockerd\", \"/usr/local/bin/podman\", \"/usr/local/bin/dnf\",\n    \"/kaniko/executor\", \"/proc/self/exe\", \"/usr/bin/apt-get\", \"/usr/bin/apt-cache\", \"/usr/bin/apt-mark\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/var/lib/docker/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sudo_hijacking.toml"}
{"title": "Potential Sudo Token Manipulation via Process Injection", "description": "This rule detects potential sudo token manipulation attacks through process injection by monitoring the use of a\ndebugger (gdb) process followed by a successful uid change event during the execution of the sudo process. A sudo token\nmanipulation attack is performed by injecting into a process that has a valid sudo token, which can then be used by\nattackers to activate their own sudo token. This attack requires ptrace to be enabled in conjunction with the existence\nof a living process that has a valid sudo token with the same uid as the current user.", "query": "sequence by host.id, process.session_leader.entity_id with maxspan=15s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n  process.name == \"gdb\" and process.user.id != \"0\" and process.group.id != \"0\" ]\n[ process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and\n  process.name == \"sudo\" and process.user.id == \"0\" and process.group.id == \"0\" ]", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_sudo_token_via_process_injection.toml"}
{"title": "Potential Privilege Escalation via Python cap_setuid", "description": "This detection rule monitors for the execution of a system command with setuid or setgid capabilities via Python,\nfollowed by a uid or gid change to the root user. This sequence of events may indicate successful privilege escalation.\nSetuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated\nprivileges, based on the file owner or group. Threat actors can exploit these attributes to escalate privileges to the\nprivileges that are set on the binary that is being executed.", "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.args : \"import os;os.set?id(0);os.system(*)\" and process.args : \"*python*\" and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action in (\"uid_change\", \"gid_change\") and event.type == \"change\" and\n   (user.id == \"0\" or group.id == \"0\")]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_suspicious_cap_setuid_python_execution.toml"}
{"title": "Privilege Escalation via CAP_CHOWN/CAP_FOWNER Capabilities", "description": "Identifies instances where a processes (granted CAP_CHOWN and/or CAP_FOWNER capabilities) is executed, after which the\nownership of a suspicious file or binary is changed. In Linux, the CAP_CHOWN capability allows a process to change the\nowner of a file, while CAP_FOWNER permits it to bypass permission checks on operations that require file ownership (like\nreading, writing, and executing). Attackers may abuse these capabilities to obtain unauthorized access to files.", "query": "sequence by host.id, process.pid with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name != null and process.thread.capabilities.effective : (\"CAP_CHOWN\", \"CAP_FOWNER\") and\n   process.command_line : (\"*sudoers*\", \"*passwd*\", \"*shadow*\", \"*/root/*\") and user.id != \"0\"]\n  [file where host.os.type == \"linux\" and event.action == \"changed-file-ownership-of\" and event.type == \"change\" and\n   event.outcome == \"success\" and file.path in (\n     \"/etc/passwd\",\n     \"/etc/shadow\",\n     \"/etc/sudoers\",\n     \"/root/.ssh/*\"\n   ) and user.id != \"0\"\n  ]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_suspicious_chown_fowner_elevation.toml"}
{"title": "Suspicious Passwd File Event Action", "description": "Monitors for the generation of a passwd password entry via openssl, followed by a file write activity on the\n\"/etc/passwd\" file. The \"/etc/passwd\" file in Linux stores user account information, including usernames, user IDs,\ngroup IDs, home directories, and default shell paths. Attackers may exploit a misconfiguration in the \"/etc/passwd\" file\npermissions or other privileges to add a new entry to the \"/etc/passwd\" file with root permissions, and leverage this\nnew user account to login as root.", "query": "sequence by host.id, process.parent.pid with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name == \"openssl\" and process.args == \"passwd\" and user.id != \"0\"]\n  [file where host.os.type == \"linux\" and file.path == \"/etc/passwd\" and process.parent.pid != 1 and\n   not auditd.data.a2 == \"80000\" and event.outcome == \"success\" and user.id != \"0\"]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_suspicious_passwd_file_write.toml"}
{"title": "Privilege Escalation via CAP_SETUID/SETGID Capabilities", "description": "Identifies instances where a process (granted CAP_SETUID and/or CAP_SETGID capabilities) is executed, after which the\nuser's access is elevated to UID/GID 0 (root). In Linux, the CAP_SETUID and CAP_SETGID capabilities allow a process to\nchange its UID and GID, respectively, providing control over user and group identity management. Attackers may leverage\na misconfiguration for exploitation in order to escalate their privileges to root.", "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name != null and\n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\") and\n   user.id != \"0\" and not (\n     process.parent.executable : (\"/tmp/newroot/*\", \"/opt/carbonblack*\") or\n     process.parent.executable in (\n       \"/opt/SolarWinds/Agent/bin/Plugins/JobEngine/SolarWinds.Agent.JobEngine.Plugin\", \"/usr/bin/vmware-toolbox-cmd\",\n       \"/usr/bin/dbus-daemon\", \"/usr/bin/update-notifier\", \"/usr/share/language-tools/language-options\",\n       \"/opt/SolarWinds/Agent/*\", \"/usr/local/sbin/lynis.sh\"\n     ) or\n     process.executable : (\"/opt/dynatrace/*\", \"/tmp/newroot/*\", \"/opt/SolarWinds/Agent/*\") or\n     process.executable in (\n       \"/bin/fgrep\", \"/usr/bin/sudo\", \"/usr/bin/pkexec\", \"/usr/lib/cockpit/cockpit-session\", \"/usr/sbin/suexec\"\n     ) or\n     process.parent.name in (\"update-notifier\", \"language-options\", \"osqueryd\", \"saposcol\", \"dbus-daemon\", \"osqueryi\", \"sdbrun\") or\n     process.command_line like (\"sudo*BECOME-SUCCESS*\", \"/bin/sh*sapsysinfo.sh*\", \"sudo su\", \"sudo su -\") or\n     process.name in (\"sudo\", \"fgrep\", \"lsb_release\", \"apt-update\", \"dbus-daemon-launch-helper\", \"man\") or\n     process.parent.command_line like \"/usr/bin/python*ansible*\"\n   )]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and\n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\")\n   and user.id == \"0\"]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_suspicious_uid_guid_elevation.toml"}
{"title": "Potential Privilege Escalation via Recently Compiled Executable", "description": "This rule monitors a sequence involving a program compilation event followed by its execution and a subsequent\nalteration of UID permissions to root privileges. This behavior can potentially indicate the execution of a kernel or\nsoftware privilege escalation exploit.", "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.name in (\"gcc\", \"g++\", \"cc\") and user.id != \"0\"] by process.args\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and event.type == \"creation\" and\n   process.name == \"ld\" and user.id != \"0\"] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   user.id != \"0\"] by process.name\n  [process where host.os.type == \"linux\" and event.action in (\"uid_change\", \"guid_change\") and event.type == \"change\" and\n   user.id == \"0\"] by process.name", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uid_change_post_compilation.toml"}
{"title": "UID Elevation from Previously Unknown Executable", "description": "Monitors for the elevation of regular user permissions to root permissions through a previously unknown executable.\nAttackers may attempt to evade detection by hijacking the execution flow and hooking certain functions/syscalls through\na rootkit in order to provide easy access to root via a special modified command.", "query": "host.os.type:\"linux\" and event.category:\"process\" and event.action:\"uid_change\" and event.type:\"change\" and user.id:\"0\"\nand process.parent.name:(\"bash\" or \"dash\" or \"sh\" or \"tcsh\" or \"csh\" or \"zsh\" or \"ksh\" or \"fish\") and not (\n  process.executable:(\n    /bin/* or /usr/bin/* or /sbin/* or /usr/sbin/* or /snap/* or /tmp/newroot/* or /var/lib/docker/* or /usr/local/* or\n    /opt/psa/admin/* or /usr/lib/snapd/snap-confine or /opt/dynatrace/* or /opt/microsoft/* or\n    /var/lib/snapd/snap/bin/node or /opt/gitlab/embedded/sbin/logrotate or /etc/apt/universal-hooks/* or\n    /opt/puppetlabs/puppet/bin/puppet or /opt/cisco/* or /run/k3s/containerd/* or /usr/lib/postfix/sbin/master or\n    /usr/libexec/postfix/local or /var/lib/snapd/snap/bin/postgresql* or /opt/puppetlabs/puppet/bin/ruby\n  ) or\n  process.name:(\n    \"bash\" or \"dash\" or \"sh\" or \"tcsh\" or \"csh\" or \"zsh\" or \"ksh\" or \"fish\" or \"sudo\" or \"su\" or \"apt\" or \"apt-get\" or\n    \"aptitude\" or \"squid\" or \"snap\" or \"fusermount\" or \"pkexec\" or \"umount\" or \"master\" or \"omsbaseline\" or \"dzdo\" or\n    \"sandfly\" or \"logrotate\" or \"nix-installer\" \n  ) or\n  process.args:/usr/bin/python*\n)", "tactic": "Privilege Escalation", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uid_elevation_from_unknown_executable.toml"}
{"title": "Namespace Manipulation Using Unshare", "description": "Identifies suspicious usage of unshare to manipulate system namespaces. Unshare can be utilized to escalate privileges\nor escape container security boundaries. Threat actors have utilized this binary to allow themselves to escape to the\nhost and access other resources or escalate privileges.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action : (\"exec\", \"exec_event\", \"start\") and\nprocess.executable: \"/usr/bin/unshare\" and\nnot process.parent.executable: (\"/usr/bin/udevadm\", \"*/lib/systemd/systemd-udevd\", \"/usr/bin/unshare\") and\nnot process.args == \"/usr/bin/snap\" and not process.parent.name in (\"zz-proxmox-boot\", \"java\")", "tactic": "Privilege Escalation", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_unshare_namespace_manipulation.toml"}
{"title": "Potential Privilege Escalation through Writable Docker Socket", "description": "This rule monitors for the usage of Docker runtime sockets to escalate privileges on Linux systems. Docker sockets by\ndefault are only be writable by the root user and docker group. Attackers that have permissions to write to these\nsockets may be able to create and run a container that allows them to escalate privileges and gain further access onto\nthe host file system.", "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n(\n  (process.name == \"docker\" and process.args : \"run\" and process.args : \"-it\"  and\n   process.args : (\"unix://*/docker.sock\", \"unix://*/dockershim.sock\")) or\n  (process.name == \"socat\" and process.args : (\"UNIX-CONNECT:*/docker.sock\", \"UNIX-CONNECT:*/dockershim.sock\"))\n) and not user.Ext.real.id : \"0\" and not group.Ext.real.id : \"0\"", "tactic": "Privilege Escalation", "technique": "Escape to Host", "technique_id": "T1611", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_writable_docker_socket.toml"}
{"title": "Unusual Network Connection to Suspicious Top Level Domain", "description": "This rule monitors for the unusual occurrence of outbound network connections to suspicious top level domains.", "query": "event.category : \"network\" and host.os.type : \"macos\" and event.type : \"start\" and\ndestination.domain : (*.team or *.lol or *.kr or *.ke or *.nu or *.space or \n                          *.capital or *.in or *.cfd or *.online or *.ru or \n                          *.info or *.top or *.buzz or *.xyz or *.rest or \n                          *.ml or *.cf or *.gq or *.ga or *.onion or \n                          *.network or *.monster or *.marketing or *.cyou or \n                          *.quest or *.cc or *.bar or *.click or *.cam or \n                          *.surf or *.tk or *.shop or *.club or *.icu or \n                          *.pw or *.ws or *.hair or *.mom or \n                          *.beauty or *.boats or *.fun or *.life or \n                          *.store)", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_unusual_connection_to_suspicious_top_level_domain.toml"}
{"title": "Unusual Network Connection to Suspicious Web Service", "description": "This rule monitors for the unusual occurrence of outbound network connections to suspicious webservice domains.", "query": "event.category : \"network\" and host.os.type : \"macos\" and event.type : \"start\" and\ndestination.domain : (\n    pastebin.* or\n    paste.ee or\n    ghostbin.com or\n    drive.google.com or\n    ?.docs.live.net or\n    api.dropboxapi.* or\n    content.dropboxapi.* or\n    *dl.dropboxusercontent.* or\n    api.onedrive.com or\n    *.onedrive.org or\n    onedrive.live.com or\n    filebin.net or\n    *.ngrok.io or\n    ngrok.com or\n    *.portmap.* or\n    *serveo.net or\n    *localtunnel.me or\n    *pagekite.me or\n    *localxpose.io or\n    *notabug.org or\n    rawcdn.githack.* or\n    paste.nrecom.net or\n    zerobin.net or\n    controlc.com or\n    requestbin.net or\n    api.slack.com or\n    slack-redir.net or\n    slack-files.com or\n    cdn.discordapp.com or\n    discordapp.com or\n    discord.com or\n    apis.azureedge.net or\n    cdn.sql.gg or\n    ?.top4top.io or\n    top4top.io or\n    uplooder.net or\n    *.cdnmegafiles.com or\n    transfer.sh or\n    updates.peer2profit.com or\n    api.telegram.org or\n    t.me or\n    meacz.gq or\n    rwrd.org or\n    *.publicvm.com or\n    *.blogspot.com or\n    api.mylnikov.org or\n    script.google.com or\n    script.googleusercontent.com or\n    paste4btc.com or\n    workupload.com or\n    temp.sh or\n    filetransfer.io or\n    gofile.io or\n    store?.gofile.io or\n    tiny.one or\n    api.notion.com or\n    *.sharepoint.com or\n    *upload.ee or\n    bit.ly or\n    t.ly or\n    cutt.ly or\n    mbasic.facebook.com or\n    api.gofile.io or\n    file.io or\n    api.anonfiles.com or\n    api.trello.com or\n    gist.githubusercontent.com or\n    dpaste.com or\n    *azurewebsites.net or\n    *.zulipchat.com or\n    *.4shared.com or\n    filecloud.me or\n    i.ibb.co or\n    files.catbox.moe or\n    *.getmyip.com or\n    mockbin.org or\n    webhook.site or\n    run.mocky.io or\n    *infinityfreeapp.com or\n    free.keep.sh or\n    tinyurl.com or\n    ftpupload.net or\n    lobfile.com or\n    *.ngrok-free.app or\n    myexternalip.com or\n    yandex.ru or\n    *.yandex.ru or\n    *.aternos.me or\n    cdn??.space or\n    *.pcloud.com or\n    mediafire.zip or\n    urlz.fr or\n    rentry.co or\n    *.b-cdn.net or\n    pastecode.dev or\n    i.imgur.com or\n    the.earth.li or\n    *.trycloudflare.com\n)", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_unusual_network_connection_to_suspicious_web_service.toml"}
{"title": "Keychain CommandLine Interaction via Unsigned or Untrusted Process", "description": "Adversaries may collect the keychain storage data from a system to acquire credentials. Keychains are the built-in way\nfor macOS to keep track of users' passwords and credentials for many services and features such as WiFi passwords,\nwebsites, secure notes and certificates.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and event.action == \"exec\" and\n  process.args like (\"/Users/*/Library/Keychains/*\", \"/Library/Keychains/*\", \"login.keychain-db\", \"login.keychain\") and \n  ((process.code_signature.trusted == false or process.code_signature.exists == false) or \n   (process.name in (\"bash\", \"sh\", \"zsh\", \"osascript\", \"cat\", \"echo\", \"cp\") and \n   (process.parent.code_signature.trusted == false or process.parent.code_signature.exists == false)))", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_credentials_keychains.toml"}
{"title": "Dumping Account Hashes via Built-In Commands", "description": "Identifies the execution of macOS built-in commands used to dump user account hashes. Adversaries may attempt to dump\ncredentials to obtain account login information in the form of a hash. These hashes can be cracked or leveraged for\nlateral movement.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name in (\"defaults\", \"mkpassdb\") and process.args like~ (\"ShadowHashData\", \"-dump\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dumping_hashes_bi_cmds.toml"}
{"title": "Dumping of Keychain Content via Security Command", "description": "Adversaries may dump the content of the keychain storage data from a system to acquire credentials. Keychains are the\nbuilt-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi\nand website passwords, secure notes, certificates, and Kerberos.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.args like~ \"dump-keychain\" and process.args == \"-d\"", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dumping_keychain_security.toml"}
{"title": "Suspicious pbpaste High Volume Activity", "description": "Identifies a high volume of `pbpaste` executions, which may indicate a bash loop continuously collecting clipboard\ncontents, potentially allowing an attacker to harvest user credentials or other sensitive information.", "query": "sequence by host.hostname, host.id with maxspan=1m\n[process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and process.name: \"pbpaste\"] with runs = 5", "tactic": "Credential Access", "technique": "Input Capture", "technique_id": "T1056", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_high_volume_of_pbpaste.toml"}
{"title": "Kerberos Cached Credentials Dumping", "description": "Identifies the use of the Kerberos credential cache (kcc) utility to dump locally cached Kerberos tickets. Adversaries\nmay attempt to dump credential material in the form of tickets that can be leveraged for lateral movement.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"kcc\" and\n  process.args like~ \"copy_cred_cache\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_kerberosdump_kcc.toml"}
{"title": "Keychain Password Retrieval via Command Line", "description": "Adversaries may collect keychain storage data from a system to in order to acquire credentials. Keychains are the\nbuilt-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi\nand website passwords, secure notes, certificates, and Kerberos.", "query": "process where host.os.type == \"macos\" and event.action == \"exec\" and\n process.name == \"security\" and\n process.args like (\"-wa\", \"-ga\") and process.args like~ (\"find-generic-password\", \"find-internet-password\") and\n process.command_line : (\"*Chrome*\", \"*Chromium*\", \"*Opera*\", \"*Safari*\", \"*Brave*\", \"*Microsoft Edge*\", \"*Firefox*\") and\n not process.parent.executable like \"/Applications/Keeper Password Manager.app/Contents/Frameworks/Keeper Password Manager Helper*/Contents/MacOS/Keeper Password Manager Helper*\"", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_keychain_pwd_retrieval_security_cmd.toml"}
{"title": "WebProxy Settings Modification", "description": "Identifies the use of the built-in networksetup command to configure webproxy settings. This may indicate an attempt to\nhijack web browser traffic for credential access via traffic sniffing or redirection.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and event.action == \"exec\" and\n process.name == \"networksetup\" and process.args like~ (\"-setwebproxy\", \"-setsecurewebproxy\", \"-setautoproxyurl\") and\n (process.parent.name like~ (\"osascript\", \"bash\", \"sh\", \"zsh\", \"Terminal\", \"Python*\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))", "tactic": "Credential Access", "technique": "Steal Web Session Cookie", "technique_id": "T1539", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_mitm_localhost_webproxy.toml"}
{"title": "Potential macOS SSH Brute Force Detected", "description": "Identifies a high number (20) of macOS SSH KeyGen process executions from the same host. An adversary may attempt a\nbrute force attack to obtain unauthorized access to user accounts.", "query": "event.category:process and host.os.type:macos and event.type:start and process.name:\"sshd-keygen-wrapper\" and process.parent.name:launchd", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_macos_ssh_bruteforce.toml"}
{"title": "Prompt for Credentials with Osascript", "description": "Identifies the use of osascript to execute scripts via standard input that may prompt a user with a rogue dialog for\ncredentials.", "query": "process where event.action == \"exec\" and host.os.type == \"macos\" and\n process.name == \"osascript\" and process.args == \"-e\" and process.command_line like~ (\"*osascript*display*dialog*password*\", \"*osascript*display*dialog*passphrase*\", \"*pass*display*dialog*\") and\n not (process.parent.executable == \"/usr/bin/sudo\" and process.command_line like~ \"*Encryption Key Escrow*\") and\n not (process.command_line like~ \"*-e with timeout of 3600 seconds*\" and user.id like \"0\" and process.parent.executable == \"/bin/bash\") and\n not process.Ext.effective_parent.executable like~\n                                               (\"/usr/local/jamf/*\",\n                                                \"/Library/Intune/Microsoft Intune Agent.app/Contents/MacOS/IntuneMdmDaemon\",\n                                                \"/Library/Application Support/Mosyle/MosyleMDM.app/Contents/MacOS/MosyleMDM\",\n                                                \"/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-Elements\",\n                                                \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon\",\n                                                \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfManagementService.app/Contents/MacOS/JamfManagementService\")", "tactic": "Credential Access", "technique": "Input Capture", "technique_id": "T1056", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_promt_for_pwd_via_osascript.toml"}
{"title": "Suspicious Web Browser Sensitive File Access", "description": "Identifies the access or file open of web browser sensitive files by an untrusted/unsigned process or osascript.\nAdversaries may acquire credentials from web browsers by reading files specific to the target browser.", "query": "file where event.action == \"open\" and host.os.type == \"macos\" and process.executable != null and\n file.name like~ (\"cookies.sqlite\",\n                  \"key?.db\",\n                  \"logins.json\",\n                  \"Cookies\",\n                  \"Cookies.binarycookies\",\n                  \"Login Data\") and\n ((process.code_signature.trusted == false or process.code_signature.exists == false) or process.name == \"osascript\") and\n not process.code_signature.signing_id == \"org.mozilla.firefox\" and\n not Effective_process.executable like \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\"", "tactic": "Credential Access", "technique": "Steal Web Session Cookie", "technique_id": "T1539", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_suspicious_web_browser_sensitive_file_access.toml"}
{"title": "SystemKey Access via Command Line", "description": "Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and\nfeatures, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos. Adversaries may collect the\nkeychain storage data from a system to acquire credentials.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.args in (\"/private/var/db/SystemKey\", \"/var/db/SystemKey\") and\n  not process.Ext.effective_parent.executable like \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\"", "tactic": "Credential Access", "technique": "Credentials from Password Stores", "technique_id": "T1555", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_systemkey_dumping.toml"}
{"title": "SoftwareUpdate Preferences Modification", "description": "Identifies changes to the SoftwareUpdate preferences using the built-in defaults command. Adversaries may abuse this in\nan attempt to disable security updates.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"defaults\" and\n process.args like \"write\" and process.args like \"-bool\" and process.args like~ (\"com.apple.SoftwareUpdate\", \"/Library/Preferences/com.apple.SoftwareUpdate.plist\") and not process.args like (\"TRUE\", \"true\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_apple_softupdates_modification.toml"}
{"title": "Quarantine Attrib Removed by Unsigned or Untrusted Process", "description": "Detects deletion of the quarantine attribute by an unusual process (xattr). In macOS, when applications or programs are\ndownloaded from the internet, there is a quarantine flag set on the file. This attribute is read by Apple's Gatekeeper\ndefense program at execution time. An adversary may disable this attribute to evade defenses.", "query": "file where event.action == \"extended_attributes_delete\" and host.os.type == \"macos\" and process.executable != null and\n (process.code_signature.trusted == false or process.code_signature.exists == false) and \n not process.executable like (\"/usr/bin/xattr\",\n                              \"/System/*\",\n                              \"/private/tmp/KSInstallAction.*/*/Install Google Software Update.app/Contents/Helpers/ksinstall\",\n                              \"/Applications/CEWE Fotoschau.app/Contents/MacOS/FotoPlus\",\n                              \"/Applications/.com.bomgar.scc.*/Remote Support Customer Client.app/Contents/MacOS/sdcust\") and \n not file.path like \"/private/var/folders/*\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_del_quarantine_attrib.toml"}
{"title": "Attempt to Disable Gatekeeper", "description": "Detects attempts to disable Gatekeeper on macOS. Gatekeeper is a security feature that's designed to ensure that only\ntrusted software is run. Adversaries may attempt to disable Gatekeeper before executing malicious code.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"spctl\" and\n process.args like~ \"--master-disable\"", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_attempt_to_disable_gatekeeper.toml"}
{"title": "Attempt to Install Root Certificate", "description": "Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to their command\nand control servers. Root certificates are used in public key cryptography to identify a root certificate authority\n(CA). When a root certificate is installed, the system or application will trust certificates in the root's chain of\ntrust that have been signed by the root certificate.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"security\" and process.args like \"add-trusted-cert\" and\n  (process.parent.name like~ (\"osascript\", \"bash\", \"sh\", \"zsh\", \"Terminal\", \"Python*\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_install_root_certificate.toml"}
{"title": "Modification of Environment Variable via Unsigned or Untrusted Parent", "description": "Identifies modifications to an environment variable using the built-in launchctl command. Adversaries may execute their\nown malicious payloads by hijacking certain environment variables to load arbitrary libraries or bypass certain\nrestrictions.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"launchctl\" and\n  (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false) and\n  process.args == \"setenv\"", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_modify_environment_launchctl.toml"}
{"title": "Potential Privacy Control Bypass via TCCDB Modification", "description": "Identifies the use of sqlite3 to directly modify the Transparency, Consent, and Control (TCC) SQLite database. This may\nindicate an attempt to bypass macOS privacy controls, including access to sensitive resources like the system camera,\nmicrophone, address book, and calendar.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"sqlite*\" and\n process.args like \"/*/Application Support/com.apple.TCC/TCC.db\" and\n (process.parent.name like~ (\"osascript\", \"bash\", \"sh\", \"zsh\", \"Terminal\", \"Python*\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_privacy_controls_tcc_database_modification.toml"}
{"title": "Potential Privacy Control Bypass via Localhost Secure Copy", "description": "Identifies use of the Secure Copy Protocol (SCP) to copy files locally by abusing the auto addition of the Secure Shell\nDaemon (sshd) to the authorized application list for Full Disk Access. This may indicate attempts to bypass macOS\nprivacy controls to access sensitive files.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"scp\" and\n process.args like~ \"StrictHostKeyChecking=no\" and\n process.command_line : (\"scp *localhost:/*\", \"scp *127.0.0.1:/*\") and\n not process.args : \"vagrant@*127.0.0.1*\"", "tactic": "Defense Evasion", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_privilege_escalation_privacy_pref_sshd_fulldiskaccess.toml"}
{"title": "Modification of Safari Settings via Defaults Command", "description": "Identifies changes to the Safari configuration using the built-in defaults command. Adversaries may attempt to enable or\ndisable certain Safari settings, such as enabling JavaScript from Apple Events to ease in the hijacking of the users\nbrowser.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.name == \"defaults\" and process.args like~ (\"com.apple.Safari\", \"write\") and \n  not process.args like~ (\"UniversalSearchEnabled\", \"SuppressSearchSuggestions\", \"WebKitTabToLinksPreferenceKey\", \n                          \"ShowFullURLInSmartSearchField\", \"com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_safari_config_change.toml"}
{"title": "Potential Microsoft Office Sandbox Evasion", "description": "Identifies the creation of a suspicious zip file prepended with special characters. Sandboxed Microsoft Office\napplications on macOS are allowed to write files that start with special characters, which can be combined with an\nAutoStart location to achieve sandbox evasion.", "query": "file where host.os.type == \"macos\" and event.action in (\"modification\", \"rename\") and file.name like~ \"~$*.zip\"", "tactic": "Defense Evasion", "technique": "Virtualization/Sandbox Evasion", "technique_id": "T1497", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sandboxed_office_app_suspicious_zip_file.toml"}
{"title": "TCC Bypass via Mounted APFS Snapshot Access", "description": "Identifies the use of the mount_apfs command to mount the entire file system through Apple File System (APFS) snapshots\nas read-only and with the noowners flag set. This action enables the adversary to access almost any file in the file\nsystem, including all user data and files protected by Apple\u2019s privacy framework (TCC).", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"mount_apfs\" and\n process.args like~ \"/System/Volumes/Data\" and process.args like~ \"noowners\"", "tactic": "Defense Evasion", "technique": "Direct Volume Access", "technique_id": "T1006", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_tcc_bypass_mounted_apfs_access.toml"}
{"title": "Attempt to Unload Elastic Endpoint Security Kernel Extension", "description": "Identifies attempts to unload the Elastic Endpoint Security kernel extension via the kextunload command.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"kextunload\" and process.args like~ (\"/System/Library/Extensions/EndpointSecurity.kext\", \"EndpointSecurity.kext\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unload_endpointsecurity_kext.toml"}
{"title": "Enumeration of Users or Groups via Built-in Commands", "description": "Identifies the execution of macOS built-in commands related to account or group enumeration. Adversaries may use account\nand group information to orient themselves before deciding how to act.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    process.name in (\"ldapsearch\", \"dsmemberutil\") or\n    (process.name == \"dscl\" and\n      process.args in (\"read\", \"-read\", \"list\", \"-list\", \"ls\", \"search\", \"-search\") and\n      process.args like (\"/Active Directory/*\", \"/Users*\", \"/Groups*\"))\n\t) and\n  ((process.Ext.effective_parent.executable like \"/Volumes/*\" or process.parent.executable like \"/Volumes/*\") or\n   (process.Ext.effective_parent.name : \".*\" or process.parent.name : \".*\") or\n   (process.parent.code_signature.trusted == false or process.parent.code_signature.exists == false))", "tactic": "Discovery", "technique": "Permission Groups Discovery", "technique_id": "T1069", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_users_domain_built_in_commands.toml"}
{"title": "Execution via Electron Child Process Node.js Module", "description": "Identifies attempts to execute a child process from within the context of an Electron application using the\nchild_process Node.js module. Adversaries may abuse this technique to inherit permissions from parent processes.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.args == \"-e\" and process.args : \"const*require*child_process*\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_defense_evasion_electron_app_childproc_node_js.toml"}
{"title": "Suspicious Browser Child Process", "description": "Identifies the execution of a suspicious browser child process. Adversaries may gain access to a system through a user\nvisiting a website over the normal course of browsing. With this technique, the user's web browser is typically targeted\nfor exploitation.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.parent.name like~ (\"Google Chrome\", \"Google Chrome Helper*\", \"firefox\", \"Opera\", \"Safari\", \"com.apple.WebKit.WebContent\", \"Microsoft Edge\") and\n  ((process.name like~ (\"sh\", \"bash\", \"dash\", \"ksh\", \"tcsh\", \"zsh\") and process.command_line : (\"*curl*\", \"*nscurl*\", \"*wget*\", \"*whoami*\", \"*pwd*\")) or\n  process.name like~ (\"curl\", \"wget\", \"python*\", \"perl*\", \"php*\", \"osascript\", \"pwsh\")) and\n  process.command_line != null", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_initial_access_suspicious_browser_childproc.toml"}
{"title": "Suspicious Installer Package Spawns Network Event", "description": "Detects the execution of a MacOS installer package with an abnormal child process (e.g bash) followed immediately by a\nnetwork connection via a suspicious process (e.g curl). Threat actors will build and distribute malicious MacOS\ninstaller packages, which have a .pkg extension, many times imitating valid software in order to persuade and infect\ntheir victims often using the package files (e.g pre/post install scripts etc.) to download additional tools or\nmalicious software. If this rule fires it should indicate the installation of a malicious or suspicious package.", "query": "sequence by host.id, process.entity_id with maxspan=15s\n[process where host.os.type == \"macos\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name like~ (\"installer\", \"package_script_service\") and ((process.name in (\"bash\", \"sh\", \"zsh\") and process.args == \"-c\") or (process.name like~ (\"python*\", \"osascript\", \"tclsh*\", \"curl\", \"nscurl\")))]\n[network where host.os.type == \"macos\" and event.type == \"start\"]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_installer_package_spawned_network_event.toml"}
{"title": "Apple Script Execution followed by Network Connection", "description": "Detects execution via the Apple script interpreter (osascript) followed by a network connection from the same process\nwithin a short time period. Adversaries may use malicious scripts for execution and command and control.", "query": "sequence by host.id, process.entity_id with maxspan=30s\n [process where host.os.type == \"macos\" and event.type == \"start\" and process.name == \"osascript\"]\n [network where host.os.type == \"macos\" and event.type == \"start\" and process.name == \"osascript\" and\n   not cidrmatch(destination.ip, \n       \"240.0.0.0/4\", \"233.252.0.0/24\", \"224.0.0.0/4\", \"198.19.0.0/16\", \"192.18.0.0/15\", \n       \"192.0.0.0/24\", \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \n       \"100.64.0.0/10\", \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\",\n       \"::1\", \"FE80::/10\", \"FF00::/8\")]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_scripting_osascript_exec_followed_by_netcon.toml"}
{"title": "Suspicious Automator Workflows Execution", "description": "Identifies the execution of the Automator Workflows process followed by a network connection from it's XPC service.\nAdversaries may drop a custom workflow template that hosts malicious JavaScript for Automation (JXA) code as an\nalternative to using osascript.", "query": "sequence by host.id, process.entity_id with maxspan=15s\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"Automator\"]\n [network where host.os.type == \"macos\"]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_script_via_automator_workflows.toml"}
{"title": "Shell Execution via Apple Scripting", "description": "Identifies the execution of the shell process (sh) via scripting (JXA or AppleScript). Adversaries may use the\ndoShellScript functionality in JXA or do shell script in AppleScript to execute system commands.", "query": "sequence by host.id with maxspan=10s\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and event.action == \"exec\" and process.name == \"osascript\" and process.args == \"-e\"] by process.entity_id\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name in (\"sh\", \"bash\", \"zsh\") and process.args == \"-c\" and process.command_line : (\"*curl*\", \"*pbpaste*\", \"*http*\", \"*chmod*\", \"*nscurl*\")] by process.parent.entity_id", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shell_execution_via_apple_scripting.toml"}
{"title": "Suspicious macOS MS Office Child Process", "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, and\nExcel). These child processes are often launched during exploitation of Office applications or by documents with\nmalicious macros.", "query": "process where event.action == \"exec\" and host.os.type == \"macos\" and\n    process.parent.name: (\n      \"Microsoft Word\",\n      \"Microsoft Outlook\",\n      \"Microsoft Excel\",\n      \"Microsoft PowerPoint\",\n      \"Microsoft OneNote\"\n    ) and\n  process.name : (\n    \"curl\",\n    \"nscurl\",\n    \"bash\",\n    \"sh\",\n    \"osascript\",\n    \"python*\",\n    \"perl*\",\n    \"mktemp\",\n    \"chmod\",\n    \"php\",\n    \"nohup\",\n    \"openssl\",\n    \"plutil\",\n    \"PlistBuddy\",\n    \"xattr\",\n    \"mktemp\",\n    \"sqlite3\",\n    \"funzip\",\n    \"popen\"\n  ) and\n\n  // Filter FPs related to product version discovery and Office error reporting behavior\n  not process.args:\n    (\n      \"ProductVersion\",\n      \"hw.model\",\n      \"ioreg\",\n      \"ProductName\",\n      \"ProductUserVisibleVersion\",\n      \"ProductBuildVersion\",\n      \"/Library/Application Support/Microsoft/MERP*/Microsoft Error Reporting.app/Contents/MacOS/Microsoft Error Reporting\",\n      \"open -a Safari *\",\n      \"defaults read *\",\n      \"sysctl hw.model*\",\n      \"ioreg -d2 -c IOPlatformExpertDevice *\",\n      \"ps aux | grep 'ToDesk_Desktop' | grep -v grep\",\n      \"PIPE=\\\"$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\"\n    ) and\n\n   not process.parent.executable :\n        (\n          \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n          \"/usr/local/Privacy-i/PISupervisor\",\n          \"/Library/Addigy/lan-cache\",\n          \"/Library/Elastic/Agent/*\",\n          \"/opt/jc/bin/jumpcloud-agent\",\n          \"/usr/sbin/networksetup\"\n        ) and\n   not (process.name : \"sh\" and process.command_line : \"*$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\") and\n\n   not process.Ext.effective_parent.executable : (\n        \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n        \"/usr/local/Privacy-i/PISupervisor\",\n        \"/Library/Addigy/auditor\",\n        \"/Library/Elastic/Agent/*\",\n        \"/opt/jc/bin/jumpcloud-agent\",\n        \"/usr/sbin/networksetup\"\n      )", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_mac_ms_office_child_process.toml"}
{"title": "Potential Kerberos Attack via Bifrost", "description": "Identifies use of Bifrost, a known macOS Kerberos pentesting tool, which can be used to dump cached Kerberos tickets or\nattempt unauthorized authentication techniques such as pass-the-ticket/hash and kerberoasting.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.args like~ \"-action\" and (process.args like~ (\"-kerberoast\", \"askhash\", \"asktgs\", \"asktgt\", \"s4u\") or process.args like~ (\"-ticket\", \"ptt\") or process.args like~ \"dump\") and process.args like~ (\"tickets\", \"keytab\")", "tactic": "Lateral Movement", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_credential_access_kerberos_bifrostconsole.toml"}
{"title": "Attempt to Mount SMB Share via Command Line", "description": "Identifies the execution of macOS built-in commands to mount a Server Message Block (SMB) network share. Adversaries may\nuse valid accounts to interact with a remote network share using SMB.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    process.name == \"mount_smbfs\" or\n    (process.name == \"open\" and process.args like~ \"smb://*\") or\n    (process.name == \"mount\" and process.args like~ \"smbfs\") or\n    (process.name == \"osascript\" and process.command_line : \"osascript*mount volume*smb://*\")\n  ) and\n  not process.parent.executable like \"/Applications/Google Drive.app/Contents/MacOS/Google Drive\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_mounting_smb_share.toml"}
{"title": "Remote SSH Login Enabled via systemsetup Command", "description": "Detects use of the systemsetup command to enable remote SSH Login.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"systemsetup\" and\n process.args like~ \"-setremotelogin\" and \n process.args like~ \"on\" and\n process.parent.executable != null and\n not process.parent.executable like (\"/usr/local/jamf/bin/jamf\", \"/usr/libexec/xpcproxy\", \"/usr/bin/sudo\")", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_remote_ssh_login_enabled.toml"}
{"title": "Virtual Private Network Connection Attempt", "description": "Identifies the execution of macOS built-in commands to connect to an existing Virtual Private Network (VPN). Adversaries\nmay use VPN connections to laterally move and control remote systems on a network.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    (process.name == \"networksetup\" and process.args like~ \"-connectpppoeservice\") or\n    (process.name == \"scutil\" and process.args like~ \"--nc\" and process.args like~ \"start\") or\n    (process.name == \"osascript\" and process.command_line : \"osascript*set VPN to service*\")\n  )", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_vpn_connection_attempt.toml"}
{"title": "Potential Hidden Local User Account Creation", "description": "Identifies attempts to create a local account that will be hidden from the macOS logon window. This may indicate an\nattempt to evade user attention while maintaining persistence using a separate local account.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"dscl\" and process.args like~ \"IsHidden\" and process.args like~ \"create\" and \n process.args like~ (\"true\", \"1\", \"yes\")", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_account_creation_hide_at_logon.toml"}
{"title": "Launch Service Creation and Immediate Loading", "description": "An adversary can establish persistence by installing a new launch agent that executes at login by using launchd or\nlaunchctl to load a plist into the appropriate directories.", "query": "sequence by host.id with maxspan=30s\n [file where host.os.type == \"macos\" and event.action == \"launch_daemon\"] by process.entity_id\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"launchctl\" and process.args == \"load\"] by process.parent.entity_id", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_creation_change_launch_agents_file.toml"}
{"title": "Creation of Hidden Login Item via Apple Script", "description": "Identifies the execution of osascript to create a hidden login item. This may indicate an attempt to persist a malicious\nprogram while concealing its presence.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"osascript\" and\n process.command_line : \"osascript*login item*hidden:true*\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_creation_hidden_login_item_osascript.toml"}
{"title": "Deprecated - LaunchDaemon Creation or Modification and Immediate Loading", "description": "Indicates the creation or modification of a launch daemon, which adversaries may use to repeatedly execute malicious\npayloads as part of persistence.", "query": "sequence by host.id with maxspan=1m\n [file where host.os.type == \"macos\" and event.type != \"deletion\" and file.path : (\"/System/Library/LaunchDaemons/*\", \"/Library/LaunchDaemons/*\")]\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"launchctl\" and process.args == \"load\"]", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_creation_modif_launch_deamon_sequence.toml"}
{"title": "Authorization Plugin Modification", "description": "Authorization plugins are used to extend the authorization services API and implement mechanisms that are not natively\nsupported by the OS, such as multi-factor authentication with third party software. Adversaries may abuse this feature\nto persist and/or collect clear text credentials as they traverse the registered plugins during user logon.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.path like \"/Library/Security/SecurityAgentPlugins/*\" and\n  not file.path like (\"/Library/Security/SecurityAgentPlugins/KandjiPassport.bundle/*\", \"/Library/Security/SecurityAgentPlugins/TeamViewerAuthPlugin.bundle/*\") and\n  not process.name == \"shove\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_credential_access_authorization_plugin_creation.toml"}
{"title": "Suspicious CronTab Creation or Modification", "description": "Identifies attempts to create or modify a crontab via a process that is not crontab (i.e python, osascript, etc.). This\nactivity should not be highly prevalent and could indicate the use of cron as a persistence mechanism by a threat actor.", "query": "file where host.os.type == \"macos\" and event.type != \"deletion\" and process.name != null and\n  file.path like \"/private/var/at/tabs/*\" and not process.executable == \"/usr/bin/crontab\"", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_crontab_creation.toml"}
{"title": "Suspicious Hidden Child Process of Launchd", "description": "Identifies the execution of a launchd child process with a hidden file. An adversary can establish persistence by\ninstalling a new logon item, launch agent, or daemon that executes upon login.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name like~ \".*\" and process.parent.name == \"launchd\"", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_defense_evasion_hidden_launch_agent_deamon_logonitem_process.toml"}
{"title": "Persistence via DirectoryService Plugin Modification", "description": "Identifies the creation or modification of a DirectoryService PlugIns (dsplug) file. The DirectoryService daemon\nlaunches on each system boot and automatically reloads after crash. It scans and executes bundles that are located in\nthe DirectoryServices PlugIns folder and can be abused by adversaries to maintain persistence.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.path like \"/Library/DirectoryServices/PlugIns/*.dsplug\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_directory_services_plugins_modification.toml"}
{"title": "Persistence via Docker Shortcut Modification", "description": "An adversary can establish persistence by modifying an existing macOS dock property list in order to execute a malicious\napplication instead of the intended one when invoked.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like \"/Users/*/Library/Preferences/com.apple.dock.plist\" and\n ((process.name like~ (\"osascript\", \"python*\", \"sh\", \"bash\", \"zsh\", \"node\") or Effective_process.name like~ (\"osascript\", \"python*\", \"sh\", \"bash\", \"zsh\", \"node\")) or\n  (process.code_signature.exists == false or process.code_signature.trusted == false))", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_docker_shortcuts_plist_modification.toml"}
{"title": "Emond Rules Creation or Modification", "description": "Identifies the creation or modification of the Event Monitor Daemon (emond) rules. Adversaries may abuse this service by\nwriting a rule to execute commands when a defined event occurs, such as system start up or user authentication.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like (\"/private/etc/emond.d/rules/*.plist\", \"/etc/emon.d/rules/*.plist\", \"/private/var/db/emondClients/*\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_emond_rules_file_creation.toml"}
{"title": "Suspicious Emond Child Process", "description": "Identifies the execution of a suspicious child process of the Event Monitor Daemon (emond). Adversaries may abuse this\nservice by writing a rule to execute commands when a defined event occurs, such as system start up or user\nauthentication.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.parent.name == \"emond\" and\n process.name like~ (\n   \"bash\",\n   \"dash\",\n   \"sh\",\n   \"tcsh\",\n   \"csh\",\n   \"zsh\",\n   \"ksh\",\n   \"fish\",\n   \"Python\",\n   \"python*\",\n   \"perl*\",\n   \"php*\",\n   \"osascript\",\n   \"pwsh\",\n   \"curl\",\n   \"wget\",\n   \"cp\",\n   \"mv\",\n   \"touch\",\n   \"echo\",\n   \"base64\",\n   \"launchctl\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_emond_rules_process_execution.toml"}
{"title": "Attempt to Enable the Root Account", "description": "Identifies attempts to enable the root account using the dsenableroot command. This command may be abused by adversaries\nfor persistence, as the root account is disabled by default.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"dsenableroot\" and \n not process.args == \"-d\"", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_enable_root_account.toml"}
{"title": "Creation of Hidden Launch Agent or Daemon", "description": "Identifies the creation of a hidden launch agent or daemon. An adversary may establish persistence by installing a new\nlaunch agent or daemon which executes at login.", "query": "file where host.os.type == \"macos\" and event.action == \"launch_daemon\" and\n  Persistence.name : \".*\"", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_evasion_hidden_launch_agent_deamon_creation.toml"}
{"title": "Finder Sync Plugin Registered and Enabled", "description": "Finder Sync plugins enable users to extend Finder\u2019s functionality by modifying the user interface. Adversaries may abuse\nthis feature by adding a rogue Finder Plugin to repeatedly execute malicious payloads for persistence.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"pluginkit\" and\n  process.args == \"-e\" and process.args like~ \"use\" and process.args == \"-i\" and\n  (process.name like~ (\"python*\", \"node\", \"osascript\", \"bash\", \"sh\", \"zsh\") or (process.parent.code_signature.exists == false or process.parent.code_signature.trusted == false))", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_finder_sync_plugin_pluginkit.toml"}
{"title": "Persistence via Folder Action Script", "description": "Detects modification of a Folder Action script. A Folder Action script is executed when the folder to which it is\nattached has items added or removed, or when its window is opened, closed, moved, or resized. Adversaries may abuse this\nfeature to establish persistence by utilizing a malicious script.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.parent.name == \"com.apple.foundation.UserScriptService\" and\n ((process.name like~ (\"osascript\", \"python*\", \"tcl*\", \"node\", \"perl\", \"ruby\", \"php\")) or \n  (process.name in (\"bash\", \"csh\", \"zsh\", \"sh\") and process.args == \"-c\")) and \n not process.args like (\"/Users/*/Library/Scripts/*\", \"/Users/*/Library/Application Scripts/*\", \"/Library/Scripts/*\")", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_folder_action_scripts_runtime.toml"}
{"title": "Potential Persistence via Login Hook", "description": "Identifies the creation or modification of the login window property list (plist). Adversaries may modify plist files to\nrun a program during system boot or user login for persistence.", "query": "event.category:file and host.os.type:macos and not event.type:\"deletion\" and\n file.name:\"com.apple.loginwindow.plist\" and\n not process.name: (systemmigrationd or DesktopServicesHelper or diskmanagementd or rsync or launchd or cfprefsd or xpcproxy or ManagedClient or MCXCompositor or backupd or \"iMazing Profile Editor\" or storagekitd or CloneKitService)", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_loginwindow_plist_modification.toml"}
{"title": "Persistence via Login or Logout Hook", "description": "Identifies use of the Defaults command to install a login or logoff hook in MacOS. An adversary may abuse this\ncapability to establish persistence in an environment by inserting code to be executed at login or logout.", "query": "process where host.os.type == \"macos\" and event.type == \"start\" and\n process.name == \"defaults\" and process.args == \"write\" and process.args : (\"LoginHook\", \"LogoutHook\") and\n not process.args :\n       (\n         \"Support/JAMF/ManagementFrameworkScripts/logouthook.sh\",\n         \"Support/JAMF/ManagementFrameworkScripts/loginhook.sh\",\n         \"/Library/Application Support/JAMF/ManagementFrameworkScripts/logouthook.sh\",\n         \"/Library/Application Support/JAMF/ManagementFrameworkScripts/loginhook.sh\"\n       )", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_login_logout_hooks_defaults.toml"}
{"title": "Sublime Plugin or Application Script Modification", "description": "Adversaries may create or modify the Sublime application plugins or scripts to execute a malicious payload each time the\nSublime application is started.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and file.extension == \"py\" and\n  file.path like\n    (\n      \"/Users/*/Library/Application Support/Sublime Text*/Packages/*.py\",\n      \"/Applications/Sublime Text.app/Contents/MacOS/sublime.py\"\n    ) and\n  not process.executable like\n    (\n      \"/Applications/Sublime Text*.app/Contents/*\",\n      \"/usr/local/Cellar/git/*/bin/git\",\n      \"/Library/Developer/CommandLineTools/usr/bin/git\",\n      \"/usr/libexec/xpcproxy\",\n      \"/System/Library/PrivateFrameworks/DesktopServicesPriv.framework/Versions/A/Resources/DesktopServicesHelper\"\n    )", "tactic": "Persistence", "technique": "Compromise Host Software Binary", "technique_id": "T1554", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_modification_sublime_app_plugin_or_script.toml"}
{"title": "Potential Persistence via Periodic Tasks", "description": "Identifies the creation or modification of the default configuration for periodic tasks. Adversaries may abuse periodic\ntasks to execute malicious code or maintain persistence.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like (\"/private/etc/periodic/*\", \"/private/etc/defaults/periodic.conf\", \"/private/etc/periodic.conf\")", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_periodic_tasks_file_mdofiy.toml"}
{"title": "Unexpected Child Process of macOS Screensaver Engine", "description": "Identifies when a child process is spawned by the screensaver engine process, which is consistent with an attacker's\nmalicious payload being executed after the screensaver activated on the endpoint. An adversary can maintain persistence\non a macOS endpoint by creating a malicious screensaver (.saver) file and configuring the screensaver plist file to\nexecute code each time the screensaver is activated.", "query": "process where host.os.type == \"macos\" and event.type == \"start\" and process.parent.name == \"ScreenSaverEngine\"", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_screensaver_engine_unexpected_child_process.toml"}
{"title": "Screensaver Plist File Modified by Unexpected Process", "description": "Identifies when a screensaver plist file is modified by an unexpected process. An adversary can maintain persistence on\na macOS endpoint by creating a malicious screensaver (.saver) file and configuring the screensaver plist file to execute\ncode each time the screensaver is activated.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.name like~ \"com.apple.screensaver.*.plist\" and\n   file.path like (\n      \"/Users/*/Library/Preferences/ByHost/*\",\n      \"/Library/Managed Preferences/*\",\n      \"/System/Library/Preferences/*\"\n      ) and\n  (\n    process.code_signature.trusted == false or\n    process.code_signature.exists == false or\n\n    /* common script interpreters and abused native macOS bins */\n    process.name like~ (\n      \"curl\",\n      \"mktemp\",\n      \"tail\",\n      \"funzip\",\n      \"python*\",\n      \"osascript\",\n      \"perl\"\n      )\n   ) and\n\n  /* Filter OS processes modifying screensaver plist files */\n  not process.executable like (\n    \"/usr/sbin/cfprefsd\",\n    \"/usr/libexec/xpcproxy\",\n    \"/System/Library/CoreServices/ManagedClient.app/Contents/Resources/MCXCompositor\",\n    \"/System/Library/CoreServices/ManagedClient.app/Contents/MacOS/ManagedClient\"\n    )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_screensaver_plist_file_modification.toml"}
{"title": "Suspicious Calendar File Modification", "description": "Identifies suspicious modifications of the calendar file by an unusual process. Adversaries may create a custom calendar\nnotification procedure to execute a malicious program at a recurring interval to establish persistence.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n  file.path like~ \"/Users/*/Library/Calendars/*.calendar/Events/*.ics\" and\n  not process.executable like (\"/System/Library/*\", \"/System/Applications/Calendar.app/Contents/MacOS/*\", \n                               \"/System/Applications/Mail.app/Contents/MacOS/Mail\", \"/usr/libexec/xpcproxy\",\n                               \"/sbin/launchd\", \"/Applications/*\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_calendar_modification.toml"}
{"title": "Potential Persistence via Atom Init Script Modification", "description": "Identifies modifications to the Atom desktop text editor Init File. Adversaries may add malicious JavaScript code to the\ninit.coffee file that will be executed upon the Atom application opening.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like \"/Users/*/.atom/init.coffee\" and \n not process.name like (\"Atom\", \"xpcproxy\") and \n not user.name == \"root\"", "tactic": "Persistence", "technique": "Boot or Logon Initialization Scripts", "technique_id": "T1037", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_atom_init_file_modification.toml"}
{"title": "Apple Scripting Execution with Administrator Privileges", "description": "Identifies execution of the Apple script interpreter (osascript) without a password prompt and with administrator\nprivileges.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"osascript\" and\n process.command_line : \"osascript*with administrator privileges\" and\n ((process.parent.code_signature.trusted == false or process.parent.code_signature.exists == false) or process.Ext.effective_parent.executable like (\"/tmp/*\", \"/private/tmp/*\", \"/Users/Shared/*\"))", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_applescript_with_admin_privs.toml"}
{"title": "Execution with Explicit Credentials via Scripting", "description": "Identifies execution of the security_authtrampoline process via a scripting interpreter. This occurs when programs use\nAuthorizationExecute-WithPrivileges from the Security.framework to run another program with root privileges. It should\nnot be run by itself, as this is a sign of execution with explicit logon credentials.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name == \"security_authtrampoline\" and\n process.parent.name like~ (\"osascript\", \"com.apple.automator.runner\", \"sh\", \"bash\", \"dash\", \"zsh\", \"python*\", \"perl*\", \"php*\", \"ruby\", \"pwsh\")", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_explicit_creds_via_scripting.toml"}
{"title": "Suspicious Child Process of Adobe Acrobat Reader Update Service", "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Adobe Acrobat Reader\nPrivilegedHelperTool responsible for installing updates. For more information, refer to CVE-2020-9615, CVE-2020-9614 and\nCVE-2020-9613 and verify that the impacted system is patched.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  process.parent.name like \"com.adobe.ARMDC.SMJobBlessHelper\" and\n  user.name == \"root\" and\n  not process.executable like (\"/Library/PrivilegedHelperTools/com.adobe.ARMDC.SMJobBlessHelper\",\n                               \"/usr/bin/codesign\",\n                               \"/private/var/folders/zz/*/T/download/ARMDCHammer\",\n                               \"/usr/sbin/pkgutil\",\n                               \"/usr/bin/shasum\",\n                               \"/usr/bin/perl*\",\n                               \"/usr/sbin/spctl\",\n                               \"/usr/sbin/installer\",\n                               \"/usr/bin/csrutil\")", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_exploit_adobe_acrobat_updater.toml"}
{"title": "Potential Admin Group Account Addition", "description": "Identifies attempts to add an account to the admin group via the command line. This could be an indication of privilege\nescalation activity.", "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n process.name in (\"dscl\", \"dseditgroup\") and process.args like~ (\"/Groups/admin\", \"admin\") and process.args like (\"-a\", \"-append\") and\n not process.Ext.effective_parent.executable like (\"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon\",\n                                                   \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfManagementService.app/Contents/MacOS/JamfManagementService\",\n                                                   \"/opt/jc/bin/jumpcloud-agent\",\n                                                   \"/Library/Addigy/go-agent\")", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_local_user_added_to_admin.toml"}
{"title": "Privilege Escalation via Root Crontab File Modification", "description": "Identifies modifications to the root crontab file. Adversaries may overwrite this file to gain code execution with root\nprivileges by exploiting privileged file write or move related vulnerabilities.", "query": "file where host.os.type == \"macos\" and event.action == \"modification\" and\n file.path like \"/private/var/at/tabs/root\" and \n not process.executable like \"/usr/bin/crontab\"", "tactic": "Privilege Escalation", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_root_crontab_filemod.toml"}
{"title": "User Added to the Admin Group", "description": "Identifies users being added to the admin group. This could be an indication of privilege\nescalation activity.", "query": "configuration where host.os.type == \"macos\" and event.type == \"change\" and\n  event.action == \"od_group_add\" and group.name:\"admin\"", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_user_added_to_admin_group.toml"}
{"title": "DNS Tunneling", "description": "A machine learning job detected unusually large numbers of DNS queries for a single top-level DNS domain, which is often\nused for DNS tunneling. DNS tunneling can be used for command-and-control, persistence, or data exfiltration activity.\nFor example, dnscat tends to generate many DNS questions for a top-level domain as it uses the DNS protocol to tunnel\ndata.", "query": "N/A", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_packetbeat_dns_tunneling.toml"}
{"title": "Unusual DNS Activity", "description": "A machine learning job detected a rare and unusual DNS query that indicate network activity with unusual DNS domains.\nThis can be due to initial access, persistence, command-and-control, or exfiltration activity. For example, when a user\nclicks on a link in a phishing email or opens a malicious document, a request may be sent to download and run a payload\nfrom an uncommon domain. When malware is already running, it may send requests to an uncommon DNS domain the malware\nuses for command-and-control communication.", "query": "N/A", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_packetbeat_rare_dns_question.toml"}
{"title": "Unusual Web Request", "description": "A machine learning job detected a rare and unusual URL that indicates unusual web browsing activity. This can be due to\ninitial access, persistence, command-and-control, or exfiltration activity. For example, in a strategic web compromise\nor watering hole attack, when a trusted website is compromised to target a particular sector or organization, targeted\nusers may receive emails with uncommon URLs for trusted websites. These URLs can be used to download and run a payload.\nWhen malware is already running, it may send requests to uncommon URLs on trusted websites the malware uses for\ncommand-and-control communication. When rare URLs are observed being requested for a local web server by a remote\nsource, these can be due to web scanning, enumeration or attack traffic, or they can be due to bots and web scrapers\nwhich are part of common Internet background traffic.", "query": "N/A", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_packetbeat_rare_urls.toml"}
{"title": "Unusual Web User Agent", "description": "A machine learning job detected a rare and unusual user agent indicating web browsing activity by an unusual process\nother than a web browser. This can be due to persistence, command-and-control, or exfiltration activity. Uncommon user\nagents coming from remote sources to local destinations are often the result of scanners, bots, and web scrapers, which\nare part of common Internet background traffic. Much of this is noise, but more targeted attacks on websites using tools\nlike Burp or SQLmap can sometimes be discovered by spotting uncommon user agents. Uncommon user agents in traffic from\nlocal sources to remote destinations can be any number of things, including harmless programs like weather monitoring or\nstock-trading programs. However, uncommon user agents from local sources can also be due to malware or scanning\nactivity.", "query": "N/A", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ml_packetbeat_rare_user_agent.toml"}
{"title": "Spike in Failed Logon Events", "description": "A machine learning job found an unusually large spike in authentication failure events. This can be due to password\nspraying, user enumeration or brute force activity and may be a precursor to account takeover or credentialed access.", "query": "N/A", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_auth_spike_in_failed_logon_events.toml"}
{"title": "Spike in Logon Events", "description": "A machine learning job found an unusually large spike in successful authentication events. This can be due to password\nspraying, user enumeration or brute force activity.", "query": "N/A", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_auth_spike_in_logon_events.toml"}
{"title": "Spike in Successful Logon Events from a Source IP", "description": "A machine learning job found an unusually large spike in successful authentication events from a particular source IP\naddress. This can be due to password spraying, user enumeration or brute force activity.", "query": "N/A", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_auth_spike_in_logon_events_from_a_source_ip.toml"}
{"title": "Unusual Linux Process Calling the Metadata Service", "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order\nto harvest credentials or user data scripts containing secrets.", "query": "N/A", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_linux_anomalous_metadata_process.toml"}
{"title": "Unusual Linux User Calling the Metadata Service", "description": "Looks for anomalous access to the cloud platform metadata service by an unusual user. The metadata service may be\ntargeted in order to harvest credentials or user data scripts containing secrets.", "query": "N/A", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_linux_anomalous_metadata_user.toml"}
{"title": "Unusual Login Activity", "description": "Identifies an unusually high number of authentication attempts.", "query": "N/A", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_suspicious_login_activity.toml"}
{"title": "Unusual Windows Process Calling the Metadata Service", "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order\nto harvest credentials or user data scripts containing secrets.", "query": "N/A", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_windows_anomalous_metadata_process.toml"}
{"title": "Unusual Windows User Calling the Metadata Service", "description": "Looks for anomalous access to the cloud platform metadata service by an unusual user. The metadata service may be\ntargeted in order to harvest credentials or user data scripts containing secrets.", "query": "N/A", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ml_windows_anomalous_metadata_user.toml"}
{"title": "Unusual Linux System Information Discovery Activity", "description": "Looks for commands related to system information discovery from an unusual user context. This can be due to uncommon\ntroubleshooting activity or due to a compromised account. A compromised account may be used to engage in system\ninformation discovery in order to gather detailed information about system configuration and software versions. This may\nbe a precursor to selection of a persistence mechanism or a method of privilege elevation.", "query": "N/A", "tactic": "Discovery", "technique": "System Information Discovery", "technique_id": "T1082", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ml_linux_system_information_discovery.toml"}
{"title": "Unusual Linux Network Configuration Discovery", "description": "Looks for commands related to system network configuration discovery from an unusual user context. This can be due to\nuncommon troubleshooting activity or due to a compromised account. A compromised account may be used by a threat actor\nto engage in system network configuration discovery in order to increase their understanding of connected networks and\nhosts. This information may be used to shape follow-up behaviors such as lateral movement or additional discovery.", "query": "N/A", "tactic": "Discovery", "technique": "System Network Configuration Discovery", "technique_id": "T1016", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ml_linux_system_network_configuration_discovery.toml"}
{"title": "Unusual Linux Network Connection Discovery", "description": "Looks for commands related to system network connection discovery from an unusual user context. This can be due to\nuncommon troubleshooting activity or due to a compromised account. A compromised account may be used by a threat actor\nto engage in system network connection discovery in order to increase their understanding of connected services and\nsystems. This information may be used to shape follow-up behaviors such as lateral movement or additional discovery.", "query": "N/A", "tactic": "Discovery", "technique": "System Network Connections Discovery", "technique_id": "T1049", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ml_linux_system_network_connection_discovery.toml"}
{"title": "Unusual Linux Process Discovery Activity", "description": "Looks for commands related to system process discovery from an unusual user context. This can be due to uncommon\ntroubleshooting activity or due to a compromised account. A compromised account may be used by a threat actor to engage\nin system process discovery in order to increase their understanding of software applications running on a target host\nor network. This may be a precursor to selection of a persistence mechanism or a method of privilege elevation.", "query": "N/A", "tactic": "Discovery", "technique": "Process Discovery", "technique_id": "T1057", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ml_linux_system_process_discovery.toml"}
{"title": "Unusual Linux User Discovery Activity", "description": "Looks for commands related to system user or owner discovery from an unusual user context. This can be due to uncommon\ntroubleshooting activity or due to a compromised account. A compromised account may be used to engage in system owner or\nuser discovery in order to identify currently active or primary users of a system. This may be a precursor to additional\ndiscovery, credential dumping or privilege elevation activity.", "query": "N/A", "tactic": "Discovery", "technique": "System Owner/User Discovery", "technique_id": "T1033", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_ml_linux_system_user_discovery.toml"}
{"title": "Suspicious Powershell Script", "description": "A machine learning job detected a PowerShell script with unusual data characteristics, such as obfuscation, that may be\na characteristic of malicious PowerShell script text blocks.", "query": "N/A", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_ml_windows_anomalous_script.toml"}
{"title": "Unusual Hour for a User to Logon", "description": "A machine learning job detected a user logging in at a time of day that is unusual for the user. This can be due to\ncredentialed access via a compromised account when the user and the threat actor are in different time zones. In\naddition, unauthorized user activity often takes place during non-business hours.", "query": "N/A", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_ml_auth_rare_hour_for_a_user_to_logon.toml"}
{"title": "Unusual Source IP for a User to Logon from", "description": "A machine learning job detected a user logging in from an IP address that is unusual for the user. This can be due to\ncredentialed access via a compromised account when the user and the threat actor are in different locations. An unusual\nsource IP address for a username could also be due to lateral movement when a compromised account is used to pivot\nbetween hosts.", "query": "N/A", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_ml_auth_rare_source_ip_for_a_user.toml"}
{"title": "Rare User Logon", "description": "A machine learning job found an unusual user name in the authentication logs. An unusual user name is one way of\ndetecting credentialed access by means of a new or dormant user account. An inactive user account (because the user has\nleft the organization) that becomes active may be due to credentialed access using a compromised account password.\nThreat actors will sometimes also create new users as a means of persisting in a compromised web application.", "query": "N/A", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_ml_auth_rare_user_logon.toml"}
{"title": "Unusual Linux Username", "description": "A machine learning job detected activity for a username that is not normally active, which can indicate unauthorized\nchanges, activity by unauthorized users, lateral movement, or compromised credentials. In many organizations, new\nusernames are not often created apart from specific types of system activities, such as creating new accounts for new\nemployees. These user accounts quickly become active and routine. Events from rarely used usernames can point to\nsuspicious activity. Additionally, automated Linux fleets tend to see activity from rarely used usernames only when\npersonnel log in to make authorized or unauthorized changes, or threat actors have acquired credentials and log in for\nmalicious purposes. Unusual usernames can also indicate pivoting, where compromised credentials are used to try and move\nlaterally from one host to another.", "query": "N/A", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_ml_linux_anomalous_user_name.toml"}
{"title": "Unusual Windows Username", "description": "A machine learning job detected activity for a username that is not normally active, which can indicate unauthorized\nchanges, activity by unauthorized users, lateral movement, or compromised credentials. In many organizations, new\nusernames are not often created apart from specific types of system activities, such as creating new accounts for new\nemployees. These user accounts quickly become active and routine. Events from rarely used usernames can point to\nsuspicious activity. Additionally, automated Linux fleets tend to see activity from rarely used usernames only when\npersonnel log in to make authorized or unauthorized changes, or threat actors have acquired credentials and log in for\nmalicious purposes. Unusual usernames can also indicate pivoting, where compromised credentials are used to try and move\nlaterally from one host to another.", "query": "N/A", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_ml_windows_anomalous_user_name.toml"}
{"title": "Unusual Windows Remote User", "description": "A machine learning job detected an unusual remote desktop protocol (RDP) username, which can indicate account takeover\nor credentialed persistence using compromised accounts. RDP attacks, such as BlueKeep, also tend to use unusual\nusernames.", "query": "N/A", "tactic": "Initial Access", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_ml_windows_rare_user_type10_remote_login.toml"}
{"title": "Spike in host-based traffic", "description": "A machine learning job has detected a sudden spike in host based traffic. This can be due to a range of security issues, such as a compromised system, DDoS attacks,\nmalware infections, privilege escalation, or data exfiltration.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_high_count_events_for_a_host_name.toml"}
{"title": "Spike in Firewall Denies", "description": "A machine learning job detected an unusually large spike in network traffic that was denied by network access control\nlists (ACLs) or firewall rules. Such a burst of denied traffic is usually caused by either 1) a mis-configured\napplication or firewall or 2) suspicious or malicious activity. Unsuccessful attempts at network transit, in order to\nconnect to command-and-control (C2), or engage in data exfiltration, may produce a burst of failed connections. This\ncould also be due to unusually large amounts of reconnaissance or enumeration traffic. Denial-of-service attacks or\ntraffic floods may also produce such a surge in traffic.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_high_count_network_denies.toml"}
{"title": "Spike in Network Traffic", "description": "A machine learning job detected an unusually large spike in network traffic. Such a burst of traffic, if not caused by a\nsurge in business activity, can be due to suspicious or malicious activity. Large-scale data exfiltration may produce a\nburst of network traffic; this could also be due to unusually large amounts of reconnaissance or enumeration traffic.\nDenial-of-service attacks or traffic floods may also produce such a surge in traffic.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_high_count_network_events.toml"}
{"title": "Unusual Linux Network Activity", "description": "Identifies Linux processes that do not usually use the network but have unexpected network activity, which can indicate\ncommand-and-control, lateral movement, persistence, or data exfiltration activity. A process with unusual network\nactivity can denote process exploitation or injection, where the process is used to run persistence mechanisms that\nallow a malicious actor remote access or control of the host, data exfiltration, and execution of unauthorized network\napplications.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_linux_anomalous_network_activity.toml"}
{"title": "Unusual Linux Network Port Activity", "description": "Identifies unusual destination port activity that can indicate command-and-control, persistence mechanism, or data\nexfiltration activity. Rarely used destination port activity is generally unusual in Linux fleets, and can indicate\nunauthorized access or threat actor activity.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_linux_anomalous_network_port_activity.toml"}
{"title": "Decline in host-based traffic", "description": "A machine learning job has detected a sudden drop in host based traffic. This can be due to a range of security issues, such as a compromised system,\na failed service, or a network misconfiguration.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_low_count_events_for_a_host_name.toml"}
{"title": "Unusual Network Destination Domain Name", "description": "A machine learning job detected an unusual network destination domain name. This can be due to initial access,\npersistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing\nemail or opens a malicious document, a request may be sent to download and run a payload from an uncommon web server\nname. When malware is already running, it may send requests to an uncommon DNS domain the malware uses for\ncommand-and-control communication.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_packetbeat_rare_server_domain.toml"}
{"title": "Network Traffic to Rare Destination Country", "description": "A machine learning job detected a rare destination country name in the network logs. This can be due to initial access,\npersistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing\nemail or opens a malicious document, a request may be sent to download and run a payload from a server in a country\nwhich does not normally appear in network traffic or business work-flows. Malware instances and persistence mechanisms\nmay communicate with command-and-control (C2) infrastructure in their country of origin, which may be an unusual\ndestination country for the source network.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_rare_destination_country.toml"}
{"title": "Spike in Network Traffic To a Country", "description": "A machine learning job detected an unusually large spike in network activity to one destination country in the network\nlogs. This could be due to unusually large amounts of reconnaissance or enumeration traffic. Data exfiltration activity\nmay also produce such a surge in traffic to a destination country that does not normally appear in network traffic or\nbusiness workflows. Malware instances and persistence mechanisms may communicate with command-and-control (C2)\ninfrastructure in their country of origin, which may be an unusual destination country for the source network.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_spike_in_traffic_to_a_country.toml"}
{"title": "Unusual Windows Network Activity", "description": "Identifies Windows processes that do not usually use the network but have unexpected network activity, which can\nindicate command-and-control, lateral movement, persistence, or data exfiltration activity. A process with unusual\nnetwork activity can denote process exploitation or injection, where the process is used to run persistence mechanisms\nthat allow a malicious actor remote access or control of the host, data exfiltration, and execution of unauthorized\nnetwork applications.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "ml_windows_anomalous_network_activity.toml"}
{"title": "Anomalous Process For a Linux Population", "description": "Searches for rare processes running on multiple Linux hosts in an entire fleet or network. This reduces the detection of\nfalse positives since automated maintenance processes usually only run occasionally on a single machine but are common\nto all or many hosts in a fleet.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_linux_anomalous_process_all_hosts.toml"}
{"title": "Unusual Process For a Linux Host", "description": "Identifies rare processes that do not usually run on individual hosts, which can indicate execution of unauthorized\nservices, malware, or persistence mechanisms. Processes are considered rare when they only run occasionally as compared\nwith other processes running on the host.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_rare_process_by_host_linux.toml"}
{"title": "Unusual Process For a Windows Host", "description": "Identifies rare processes that do not usually run on individual hosts, which can indicate execution of unauthorized\nservices, malware, or persistence mechanisms. Processes are considered rare when they only run occasionally as compared\nwith other processes running on the host.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_rare_process_by_host_windows.toml"}
{"title": "Unusual Windows Path Activity", "description": "Identifies processes started from atypical folders in the file system, which might indicate malware execution or\npersistence mechanisms. In corporate Windows environments, software installation is centrally managed and it is unusual\nfor programs to be executed from user or temporary directories. Processes executed from these locations can denote that\na user downloaded software directly from the Internet or a malicious script or macro executed malware.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_windows_anomalous_path_activity.toml"}
{"title": "Anomalous Process For a Windows Population", "description": "Searches for rare processes running on multiple hosts in an entire fleet or network. This reduces the detection of false\npositives since automated maintenance processes usually only run occasionally on a single machine but are common to all\nor many hosts in a fleet.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_windows_anomalous_process_all_hosts.toml"}
{"title": "Anomalous Windows Process Creation", "description": "Identifies unusual parent-child process relationships that can indicate malware execution or persistence mechanisms.\nMalicious scripts often call on other applications and processes as part of their exploit payload. For example, when a\nmalicious Office document runs scripts as part of an exploit payload, Excel or Word may start a script interpreter\nprocess, which, in turn, runs a script that downloads and executes malware. Another common scenario is Outlook running\nan unusual process when malware is downloaded in an email. Monitoring and identifying anomalous process relationships is\na method of detecting new and emerging malware that is not yet recognized by anti-virus scanners.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_windows_anomalous_process_creation.toml"}
{"title": "Unusual Windows Service", "description": "A machine learning job detected an unusual Windows service, This can indicate execution of unauthorized services,\nmalware, or persistence mechanisms. In corporate Windows environments, hosts do not generally run many rare or unique\nservices. This job helps detect malware and persistence mechanisms that have been installed and run as a service.", "query": "N/A", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ml_windows_anomalous_service.toml"}
{"title": "Unusual Sudo Activity", "description": "Looks for sudo activity from an unusual user context. An unusual sudo user could be due to troubleshooting activity or\nit could be a sign of credentialed access via compromised accounts.", "query": "N/A", "tactic": "Defense Evasion", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_ml_linux_anomalous_sudo_activity.toml"}
{"title": "Unusual Windows User Privilege Elevation Activity", "description": "A machine learning job detected an unusual user context switch, using the runas command or similar techniques, which can\nindicate account takeover or privilege escalation using compromised accounts. Privilege elevation using tools like runas\nare more commonly used by domain and network administrators than by regular Windows users.", "query": "N/A", "tactic": "Privilege Escalation", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_ml_windows_rare_user_runas_event.toml"}
{"title": "Anomalous Linux Compiler Activity", "description": "Looks for compiler activity by a user context which does not normally run compilers. This can be the result of ad-hoc\nsoftware changes or unauthorized software deployment. This can also be due to local privilege elevation via locally run\nexploits or malware activity.", "query": "N/A", "tactic": "Resource Development", "technique": "Obtain Capabilities", "technique_id": "T1588", "risk_score": "N/A", "tags": [], "references": [], "file": "resource_development_ml_linux_anomalous_compiler_activity.toml"}
{"title": "Accepted Default Telnet Port Connection", "description": "This rule detects network events that may indicate the use of Telnet traffic. Telnet is commonly used by system\nadministrators to remotely control older or embedded systems using the command line shell. It should almost never be\ndirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or\nbackdoor vector. As a plain-text protocol, it may also expose usernames and passwords to anyone capable of observing the\ntraffic.", "query": "(event.dataset:network_traffic.flow or event.category:(network or network_traffic))\n    and event.type:connection and not event.action:(\n        flow_dropped or flow_denied or denied or deny or\n        flow_terminated or timeout or Reject or network_flow)\n    and destination.port:23", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_accepted_default_telnet_port_connection.toml"}
{"title": "Cobalt Strike Command and Control Beacon", "description": "Cobalt Strike is a threat emulation platform commonly modified and used by adversaries to conduct network attack and\nexploitation campaigns. This rule detects a network activity algorithm leveraged by Cobalt Strike implant beacons for\ncommand and control.", "query": "((event.category: (network OR network_traffic) AND type: (tls OR http))\n    OR event.dataset: (network_traffic.tls OR network_traffic.http)\n) AND destination.domain:/[a-z]{3}.stage.[0-9]{8}\\..*/", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_cobalt_strike_beacon.toml"}
{"title": "Default Cobalt Strike Team Server Certificate", "description": "This rule detects the use of the default Cobalt Strike Team Server TLS certificate. Cobalt Strike is software for\nAdversary Simulations and Red Team Operations which are security assessments that replicate the tactics and techniques\nof an advanced adversary in a network. Modifications to the Packetbeat configuration can be made to include MD5 and\nSHA256 hashing algorithms (the default is SHA1). See the References section for additional information on module\nconfiguration.", "query": "(event.dataset: network_traffic.tls or event.category: (network or network_traffic))\n  and (tls.server.hash.md5:950098276A495286EB2A2556FBAB6D83\n  or tls.server.hash.sha1:6ECE5ECE4192683D2D84E25B0BA7E04F9CB7EB7C\n  or tls.server.hash.sha256:87F2085C32B6A2CC709B365F55873E207A9CAA10BFFECF2FD16D3CF9D94D390C)", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_cobalt_strike_default_teamserver_cert.toml"}
{"title": "Roshal Archive (RAR) or PowerShell File Downloaded from the Internet", "description": "Detects a Roshal Archive (RAR) file or PowerShell script downloaded from the internet by an internal host. Gaining\ninitial access to a system and then downloading encoded or encrypted tools to move laterally is a common practice for\nadversaries as a way to protect their more valuable tools and tactics, techniques, and procedures (TTPs). This may be\natypical behavior for a managed network and can be indicative of malware, exfiltration, or command and control.", "query": "(event.dataset: (network_traffic.http or network_traffic.tls) or\n  (event.category: (network or network_traffic) and network.protocol: http)) and\n  (url.extension:(ps1 or rar) or url.path:(*.ps1 or *.rar)) and\n    not destination.ip:(\n      10.0.0.0/8 or\n      127.0.0.0/8 or\n      169.254.0.0/16 or\n      172.16.0.0/12 or\n      192.0.0.0/24 or\n      192.0.0.0/29 or\n      192.0.0.8/32 or\n      192.0.0.9/32 or\n      192.0.0.10/32 or\n      192.0.0.170/32 or\n      192.0.0.171/32 or\n      192.0.2.0/24 or\n      192.31.196.0/24 or\n      192.52.193.0/24 or\n      192.168.0.0/16 or\n      192.88.99.0/24 or\n      224.0.0.0/4 or\n      100.64.0.0/10 or\n      192.175.48.0/24 or\n      198.18.0.0/15 or\n      198.51.100.0/24 or\n      203.0.113.0/24 or\n      240.0.0.0/4 or\n      \"::1\" or\n      \"FE80::/10\" or\n      \"FF00::/8\"\n    ) and\n    source.ip:(\n      10.0.0.0/8 or\n      172.16.0.0/12 or\n      192.168.0.0/16\n    )", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_download_rar_powershell_from_internet.toml"}
{"title": "Possible FIN7 DGA Command and Control Behavior", "description": "This rule detects a known command and control pattern in network events. The FIN7 threat group is known to use this\ncommand and control technique, while maintaining persistence in their target's network.", "query": "(event.dataset: (network_traffic.tls OR network_traffic.http) OR\n    (event.category: (network OR network_traffic) AND type: (tls OR http) AND network.transport: tcp)) AND\ndestination.domain:/[a-zA-Z]{4,5}\\.(pw|us|club|info|site|top)/ AND NOT destination.domain:zoom.us", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_fin7_c2_behavior.toml"}
{"title": "Halfbaked Command and Control Beacon", "description": "Halfbaked is a malware family used to establish persistence in a contested network. This rule detects a network activity\nalgorithm leveraged by Halfbaked implant beacons for command and control.", "query": "(event.dataset: (network_traffic.tls OR network_traffic.http) OR\n  (event.category: (network OR network_traffic) AND network.protocol: http)) AND\n  network.transport:tcp AND url.full:/http:\\/\\/[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}\\/cd/ AND\n  destination.port:(53 OR 80 OR 8080 OR 443)", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_halfbaked_beacon.toml"}
{"title": "IPSEC NAT Traversal Port Activity", "description": "This rule detects events that could be describing IPSEC NAT Traversal traffic. IPSEC is a VPN technology that allows one\nsystem to talk to another using encrypted tunnels. NAT Traversal enables these tunnels to communicate over the Internet\nwhere one of the sides is behind a NAT router gateway. This may be common on your network, but this technique is also\nused by threat actors to avoid detection.", "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and network.transport:udp and destination.port:4500", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_nat_traversal_port_activity.toml"}
{"title": "SMTP on Port 26/TCP", "description": "This rule detects events that may indicate use of SMTP on TCP port 26. This port is commonly used by several popular\nmail transfer agents to deconflict with the default SMTP port 25. This port has also been used by a malware family\ncalled BadPatch for command and control of Windows systems.", "query": "(event.dataset: (network_traffic.flow or zeek.smtp) or event.category:(network or network_traffic)) and network.transport:tcp and destination.port:26", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_port_26_activity.toml"}
{"title": "RDP (Remote Desktop Protocol) from the Internet", "description": "This rule detects network events that may indicate the use of RDP traffic from the Internet. RDP is commonly used by\nsystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never be\ndirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or\nbackdoor vector.", "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:3389 or event.dataset:zeek.rdp) and\n  not source.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  ) and\n  destination.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  )", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_rdp_remote_desktop_protocol_from_the_internet.toml"}
{"title": "VNC (Virtual Network Computing) from the Internet", "description": "This rule detects network events that may indicate the use of VNC traffic from the Internet. VNC is commonly used by\nsystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never be\ndirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or\nbackdoor vector.", "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and destination.port >= 5800 and destination.port <= 5810 and\n  not source.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  ) and\n  destination.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  )", "tactic": "Command and Control", "technique": "Remote Access Tools", "technique_id": "T1219", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_vnc_virtual_network_computing_from_the_internet.toml"}
{"title": "VNC (Virtual Network Computing) to the Internet", "description": "This rule detects network events that may indicate the use of VNC traffic to the Internet. VNC is commonly used by\nsystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never be\ndirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or\nbackdoor vector.", "query": "(event.dataset: network_traffic.flow  or (event.category: (network or network_traffic))) and\n  network.transport:tcp and destination.port >= 5800 and destination.port <= 5810 and\n  source.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  ) and\n  not destination.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  )", "tactic": "Command and Control", "technique": "Remote Access Tools", "technique_id": "T1219", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_vnc_virtual_network_computing_to_the_internet.toml"}
{"title": "Potential Network Sweep Detected", "description": "This rule identifies a potential network sweep. A network sweep is a method used by attackers to scan a target network,\nidentifying active hosts, open ports, and available services to gather information on vulnerabilities and weaknesses.\nThis reconnaissance helps them plan subsequent attacks and exploit potential entry points for unauthorized access, data\ntheft, or other malicious activities. This rule defines a threshold-based approach to detect multiple connection\nattempts from a single host to numerous destination hosts over commonly used network services.", "query": "event.action:network_flow and destination.port:(21 or 22 or 23 or 25 or 139 or 445 or 3389 or 5985 or 5986) and\nsource.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_potential_network_sweep_detected.toml"}
{"title": "Potential Network Scan Detected", "description": "This rule identifies a potential port scan. A port scan is a method utilized by attackers to systematically scan a\ntarget system or network for open ports, allowing them to identify available services and potential vulnerabilities. By\nmapping out the open ports, attackers can gather critical information to plan and execute targeted attacks, gaining\nunauthorized access, compromising security, and potentially leading to data breaches, unauthorized control, or further\nexploitation of the targeted system or network. This rule defines a threshold-based approach to detect connection\nattempts from a single source to a wide range of destination ports.", "query": "event.action:network_flow and destination.port:* and source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_potential_port_scan_detected.toml"}
{"title": "Potential SYN-Based Port Scan Detected", "description": "This rule identifies a potential SYN-Based port scan. A SYN port scan is a technique employed by attackers to scan a\ntarget network for open ports by sending SYN packets to multiple ports and observing the response. Attackers use this\nmethod to identify potential entry points or services that may be vulnerable to exploitation, allowing them to launch\ntargeted attacks or gain unauthorized access to the system or network, compromising its security and potentially leading\nto data breaches or further malicious activities. This rule defines a threshold-based approach to detect connection\nattempts from a single source to a large number of unique destination ports, while limiting the number of packets per port.", "query": "event.action:network_flow and destination.port:* and network.packets <= 2 and source.ip:(10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)", "tactic": "Discovery", "technique": "Network Service Discovery", "technique_id": "T1046", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_potential_syn_port_scan_detected.toml"}
{"title": "RPC (Remote Procedure Call) from the Internet", "description": "This rule detects network events that may indicate the use of RPC traffic from the Internet. RPC is commonly used by\nsystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never be\ndirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or\nbackdoor vector.", "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) and\n  not source.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  ) and\n  destination.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  )", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_rpc_remote_procedure_call_from_the_internet.toml"}
{"title": "RPC (Remote Procedure Call) to the Internet", "description": "This rule detects network events that may indicate the use of RPC traffic to the Internet. RPC is commonly used by\nsystem administrators to remotely control a system for maintenance or to use shared resources. It should almost never be\ndirectly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or\nbackdoor vector.", "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) and\n  source.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  ) and\n  not destination.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  )", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_rpc_remote_procedure_call_to_the_internet.toml"}
{"title": "SMB (Windows File Sharing) Activity to the Internet", "description": "This rule detects network events that may indicate the use of Windows file sharing (also called SMB or CIFS) traffic to\nthe Internet. SMB is commonly used within networks to share files, printers, and other system resources amongst trusted\nsystems. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by\nthreat actors as an initial access or backdoor vector or for data exfiltration.", "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:(139 or 445) or event.dataset:zeek.smb) and\n  source.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  ) and\n  not destination.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  )", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_smb_windows_file_sharing_activity_to_the_internet.toml"}
{"title": "Inbound Connection to an Unsecure Elasticsearch Node", "description": "Identifies Elasticsearch nodes that do not have Transport Layer Security (TLS), and/or lack authentication, and are\naccepting inbound network connections over the default Elasticsearch port.", "query": "(event.dataset: network_traffic.http OR (event.category: network_traffic AND network.protocol: http)) AND\n    status:OK AND destination.port:9200 AND network.direction:inbound AND NOT http.response.headers.content-type:\"image/x-icon\" AND NOT\n    _exists_:http.request.headers.authorization", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_unsecure_elasticsearch_node.toml"}
{"title": "Abnormally Large DNS Response", "description": "Specially crafted DNS requests can manipulate a known overflow vulnerability in some Windows DNS servers, resulting in\nRemote Code Execution (RCE) or a Denial of Service (DoS) from crashing the service.", "query": "(event.dataset: network_traffic.dns or (event.category: (network or network_traffic) and destination.port: 53)) and\n  (event.dataset:zeek.dns or type:dns or event.type:connection) and network.bytes > 60000", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_dns_server_overflow.toml"}
{"title": "Credential Dumping - Detected - Elastic Endgame", "description": "Elastic Endgame detected Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in\nthe rule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event)", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_endgame_cred_dumping_detected.toml"}
{"title": "Credential Dumping - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in\nthe rule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event)", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_endgame_cred_dumping_prevented.toml"}
{"title": "Adversary Behavior - Detected - Elastic Endgame", "description": "Elastic Endgame detected an Adversary Behavior. Click the Elastic Endgame icon in the event.module column or the link in\nthe rule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and (event.action:behavior_protection_event or endgame.event_subtype_full:behavior_protection_event)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "endgame_adversary_behavior_detected.toml"}
{"title": "Malware - Detected - Elastic Endgame", "description": "Elastic Endgame detected Malware. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:file_classification_event or endgame.event_subtype_full:file_classification_event)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "endgame_malware_detected.toml"}
{"title": "Malware - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented Malware. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:file_classification_event or endgame.event_subtype_full:file_classification_event)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "endgame_malware_prevented.toml"}
{"title": "Ransomware - Detected - Elastic Endgame", "description": "Elastic Endgame detected ransomware. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "endgame_ransomware_detected.toml"}
{"title": "Ransomware - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented ransomware. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:ransomware_event or endgame.event_subtype_full:ransomware_event)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "endgame_ransomware_prevented.toml"}
{"title": "Exploit - Detected - Elastic Endgame", "description": "Elastic Endgame detected an Exploit. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:exploit_event or endgame.event_subtype_full:exploit_event)", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_endgame_exploit_detected.toml"}
{"title": "Exploit - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented an Exploit. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:exploit_event or endgame.event_subtype_full:exploit_event)", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_endgame_exploit_prevented.toml"}
{"title": "External Alerts", "description": "Generates a detection alert for each external alert written to the configured indices. Enabling this rule allows you to\nimmediately begin investigating external alerts in the app.", "query": "event.kind:alert and not event.module:(endgame or endpoint or cloud_defend)", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "external_alerts.toml"}
{"title": "Credential Manipulation - Detected - Elastic Endgame", "description": "Elastic Endgame detected Credential Manipulation. Click the Elastic Endgame icon in the event.module column or the link\nin the rule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:token_manipulation_event or endgame.event_subtype_full:token_manipulation_event)", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_endgame_cred_manipulation_detected.toml"}
{"title": "Credential Manipulation - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented Credential Manipulation. Click the Elastic Endgame icon in the event.module column or the link\nin the rule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:token_manipulation_event or endgame.event_subtype_full:token_manipulation_event)", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_endgame_cred_manipulation_prevented.toml"}
{"title": "Permission Theft - Detected - Elastic Endgame", "description": "Elastic Endgame detected Permission Theft. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:token_protection_event or endgame.event_subtype_full:token_protection_event)", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_endgame_permission_theft_detected.toml"}
{"title": "Permission Theft - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented Permission Theft. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:token_protection_event or endgame.event_subtype_full:token_protection_event)", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_endgame_permission_theft_prevented.toml"}
{"title": "Process Injection - Detected - Elastic Endgame", "description": "Elastic Endgame detected Process Injection. Click the Elastic Endgame icon in the event.module column or the link in the\nrule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:kernel_shellcode_event or endgame.event_subtype_full:kernel_shellcode_event)", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_endgame_process_injection_detected.toml"}
{"title": "Process Injection - Prevented - Elastic Endgame", "description": "Elastic Endgame prevented Process Injection. Click the Elastic Endgame icon in the event.module column or the link in\nthe rule.reference column for additional information.", "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:kernel_shellcode_event or endgame.event_subtype_full:kernel_shellcode_event)", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_endgame_process_injection_prevented.toml"}
{"title": "Threat Intel IP Address Indicator Match", "description": "This rule is triggered when an IP address indicator from the Threat Intel Filebeat module or integrations has a match\nagainst a network event.", "query": "source.ip:* or destination.ip:*", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "threat_intel_indicator_match_address.toml"}
{"title": "Threat Intel Email Indicator Match", "description": "This rule is triggered when an email indicator from the Threat Intel Filebeat module or integrations matches an event\ncontaining email-related data, such as logs from email security gateways or email service providers.", "query": "email.from.address:* or email.sender.address:* or email.reply_to.address:* or email.to.address:*", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "threat_intel_indicator_match_email.toml"}
{"title": "Threat Intel Hash Indicator Match", "description": "This rule is triggered when a hash indicator from the Threat Intel Filebeat module or integrations has a match against\nan event that contains file hashes, such as antivirus alerts, process creation, library load, and file operation events.", "query": "file.hash.*:* or process.hash.*:* or dll.hash.*:*", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "threat_intel_indicator_match_hash.toml"}
{"title": "Threat Intel Windows Registry Indicator Match", "description": "This rule is triggered when a Windows registry indicator from the Threat Intel Filebeat module or integrations has a\nmatch against an event that contains registry data.", "query": "registry.path:*", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "threat_intel_indicator_match_registry.toml"}
{"title": "Threat Intel URL Indicator Match", "description": "This rule is triggered when a URL indicator from the Threat Intel Filebeat module or integrations has a match against an\nevent that contains URL data, like DNS events, network logs, etc.", "query": "url.full:*", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "threat_intel_indicator_match_url.toml"}
{"title": "Rapid7 Threat Command CVEs Correlation", "description": "This rule is triggered when CVEs collected from the Rapid7 Threat Command Integration have a match against\nvulnerabilities that were found in the customer environment.", "query": "vulnerability.id : *", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "threat_intel_rapid7_threat_command.toml"}
{"title": "Suspicious Inter-Process Communication via Outlook", "description": "Detects Inter-Process Communication with Outlook via Component Object Model from an unusual process. Adversaries may\ntarget user email to collect sensitive information or send email on their behalf via API.", "query": "sequence with maxspan=1m\n[process where host.os.type == \"windows\" and event.action == \"start\" and\n  (\n    process.name : (\n      \"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\",\n      \"cmd.exe\", \"regsvr32.exe\", \"cscript.exe\", \"wscript.exe\"\n    ) or\n    (\n      (process.code_signature.trusted == false or process.code_signature.exists == false) and\n      (process.Ext.relative_file_creation_time <= 500 or process.Ext.relative_file_name_modify_time <= 500)\n    )\n  )\n] by process.entity_id\n[process where host.os.type == \"windows\" and event.action == \"start\" and process.name : \"OUTLOOK.EXE\" and\n  process.Ext.effective_parent.name != null] by process.Ext.effective_parent.entity_id", "tactic": "Collection", "technique": "Email Collection", "technique_id": "T1114", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_email_outlook_mailbox_via_com.toml"}
{"title": "Exporting Exchange Mailbox via PowerShell", "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary\nmailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")", "tactic": "Collection", "technique": "Data from Local System", "technique_id": "T1005", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_email_powershell_exchange_mailbox.toml"}
{"title": "Exchange Mailbox Export via PowerShell", "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary\nmailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : \"New-MailboxExportRequest\"", "tactic": "Collection", "technique": "Data from Local System", "technique_id": "T1005", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_mailbox_export_winlog.toml"}
{"title": "PowerShell Suspicious Script with Audio Capture Capabilities", "description": "Detects PowerShell scripts that can record audio, a common feature in popular post-exploitation tooling.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Get-MicrophoneAudio\" or\n    \"WindowsAudioDevice-Powershell-Cmdlet\" or\n    (waveInGetNumDevs and mciSendStringA)\n  )\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )\n  and not user.id : \"S-1-5-18\"", "tactic": "Collection", "technique": "Audio Capture", "technique_id": "T1123", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_posh_audio_capture.toml"}
{"title": "PowerShell Suspicious Script with Clipboard Retrieval Capabilities", "description": "Detects PowerShell scripts that can get the contents of the clipboard, which attackers can abuse to retrieve sensitive\ninformation like credentials, messages, etc.", "query": "event.category:process and host.os.type:windows and\n  (powershell.file.script_block_text : (\n    \"Windows.Clipboard\" or\n    \"Windows.Forms.Clipboard\" or\n    \"Windows.Forms.TextBox\"\n   ) and\n   powershell.file.script_block_text : (\n    \"]::GetText\" or\n    \".Paste()\"\n  )) or powershell.file.script_block_text : \"Get-Clipboard\" and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.path : C\\:\\\\Program?Files\\\\WindowsPowerShell\\\\*Modules*.ps1 and\n    file.name : (\"Convert-ExcelRangeToImage.ps1\" or \"Read-Clipboard.ps1\")\n  )", "tactic": "Collection", "technique": "Clipboard Data", "technique_id": "T1115", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_posh_clipboard_capture.toml"}
{"title": "PowerShell Keylogging Script", "description": "Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers use\nthis technique to capture user input, looking for credentials and/or other valuable data.", "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or \"Get-Keystrokes\") or\n   powershell.file.script_block_text : (\n        (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and\n        (GetForegroundWindow or GetWindowTextA or GetWindowTextW or \"WM_KEYBOARD_LL\" or \"WH_MOUSE_LL\")\n   )\n   ) and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  )", "tactic": "Collection", "technique": "Input Capture", "technique_id": "T1056", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_posh_keylogger.toml"}
{"title": "PowerShell Mailbox Collection Script", "description": "Detects PowerShell scripts that can be used to collect data from mailboxes. Adversaries may target user email to collect\nsensitive information.", "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (\n      \"Microsoft.Office.Interop.Outlook\" or\n      \"Interop.Outlook.olDefaultFolders\" or\n      \"::olFolderInBox\"\n   ) or\n   powershell.file.script_block_text : (\n      \"Microsoft.Exchange.WebServices.Data.Folder\" or\n      \"Microsoft.Exchange.WebServices.Data.FileAttachment\"\n   )\n  ) and not user.id : \"S-1-5-18\"", "tactic": "Collection", "technique": "Email Collection", "technique_id": "T1114", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_posh_mailbox.toml"}
{"title": "PowerShell Suspicious Script with Screenshot Capabilities", "description": "Detects PowerShell scripts that can take screenshots, which is a common feature in post-exploitation kits and remote\naccess tools (RATs).", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    CopyFromScreen and\n    (\"System.Drawing.Bitmap\" or \"Drawing.Bitmap\")\n  ) and not user.id : \"S-1-5-18\"", "tactic": "Collection", "technique": "Screen Capture", "technique_id": "T1113", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_posh_screen_grabber.toml"}
{"title": "PowerShell Script with Webcam Video Capture Capabilities", "description": "Detects PowerShell scripts that can be used to record webcam video. Attackers can capture this information to extort or\nspy on victims.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"NewFrameEventHandler\" or\n    \"VideoCaptureDevice\" or\n    \"DirectX.Capture.Filters\" or\n    \"VideoCompressors\" or\n    \"Start-WebcamRecorder\" or\n    (\n      (\"capCreateCaptureWindowA\" or\n       \"capCreateCaptureWindow\" or\n       \"capGetDriverDescription\") and\n      (\"avicap32.dll\" or \"avicap32\")\n    )\n  )", "tactic": "Collection", "technique": "Video Capture", "technique_id": "T1125", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_posh_webcam_video_capture.toml"}
{"title": "Encrypting Files with WinRar or 7z", "description": "Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data in\npreparation for exfiltration.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      process.name:\"rar.exe\" or ?process.code_signature.subject_name == \"win.rar GmbH\" or\n      ?process.pe.original_file_name == \"Command line RAR\"\n    ) and\n    process.args == \"a\" and process.args : (\"-hp*\", \"-p*\", \"/hp*\", \"/p*\")\n  ) or\n  (\n    (process.name : (\"7z.exe\", \"7za.exe\") or ?process.pe.original_file_name in (\"7z.exe\", \"7za.exe\")) and\n    process.args == \"a\" and process.args : \"-p*\"\n  )\n) and\n  not process.parent.executable : (\n        \"C:\\\\Program Files\\\\*.exe\",\n        \"C:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"?:\\\\Nox\\\\bin\\\\Nox.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Nox\\\\bin\\\\Nox.exe\"\n      )", "tactic": "Collection", "technique": "Data from Local System", "technique_id": "T1005", "risk_score": "N/A", "tags": [], "references": [], "file": "collection_winrar_encryption.toml"}
{"title": "Potential File Transfer via Certreq", "description": "Identifies Certreq making an HTTP Post request. Adversaries could abuse Certreq to download files or upload data to a\nremote URL.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"CertReq.exe\" or ?process.pe.original_file_name == \"CertReq.exe\") and process.args : \"-Post\"", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_certreq_postdata.toml"}
{"title": "Connection to Commonly Abused Web Services", "description": "Adversaries may implement command and control (C2) communications that use common web services to hide their activity.\nThis attack technique is typically targeted at an organization and uses web services common to the victim network, which\nallows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since they\nhave most likely been used before compromise, which helps malicious traffic blend in.", "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n    process.name != null and user.id not in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n    /* Add new WebSvc domains here */\n    dns.question.name :\n       (\n        \"raw.githubusercontent.*\",\n        \"pastebin.*\",\n        \"paste4btc.com\",\n        \"paste.ee\",\n        \"ghostbin.com\",\n        \"drive.google.com\",\n        \"?.docs.live.net\",\n        \"api.dropboxapi.*\",\n        \"content.dropboxapi.*\",\n        \"dl.dropboxusercontent.*\",\n        \"api.onedrive.com\",\n        \"*.onedrive.org\",\n        \"onedrive.live.com\",\n        \"filebin.net\",\n        \"*.ngrok.io\",\n        \"ngrok.com\",\n        \"*.portmap.*\",\n        \"*serveo.net\",\n        \"*localtunnel.me\",\n        \"*pagekite.me\",\n        \"*localxpose.io\",\n        \"*notabug.org\",\n        \"rawcdn.githack.*\",\n        \"paste.nrecom.net\",\n        \"zerobin.net\",\n        \"controlc.com\",\n        \"requestbin.net\",\n        \"slack.com\",\n        \"api.slack.com\",\n        \"slack-redir.net\",\n        \"slack-files.com\",\n        \"cdn.discordapp.com\",\n        \"discordapp.com\",\n        \"discord.com\",\n        \"apis.azureedge.net\",\n        \"cdn.sql.gg\",\n        \"?.top4top.io\",\n        \"top4top.io\",\n        \"www.uplooder.net\",\n        \"*.cdnmegafiles.com\",\n        \"transfer.sh\",\n        \"gofile.io\",\n        \"updates.peer2profit.com\",\n        \"api.telegram.org\",\n        \"t.me\",\n        \"meacz.gq\",\n        \"rwrd.org\",\n        \"*.publicvm.com\",\n        \"*.blogspot.com\",\n        \"api.mylnikov.org\",\n        \"file.io\",\n        \"stackoverflow.com\",\n        \"*files.1drv.com\",\n        \"api.anonfile.com\",\n        \"*hosting-profi.de\",\n        \"ipbase.com\",\n        \"ipfs.io\",\n        \"*up.freeo*.space\",\n        \"api.mylnikov.org\",\n        \"script.google.com\",\n        \"script.googleusercontent.com\",\n        \"api.notion.com\",\n        \"graph.microsoft.com\",\n        \"*.sharepoint.com\",\n        \"mbasic.facebook.com\",\n        \"login.live.com\",\n        \"api.gofile.io\",\n        \"api.anonfiles.com\",\n        \"api.notion.com\",\n        \"api.trello.com\",\n        \"gist.githubusercontent.com\",\n        \"files.pythonhosted.org\",\n        \"g.live.com\",\n        \"*.zulipchat.com\",\n        \"webhook.site\",\n        \"run.mocky.io\",\n        \"mockbin.org\", \n        \"www.googleapis.com\", \n        \"googleapis.com\",\n        \"global.rel.tunnels.api.visualstudio.com\",\n        \"*.devtunnels.ms\", \n        \"api.github.com\") and\n        \n    /* Insert noisy false positives here */\n    not (\n      (\n        process.executable : (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\BraveSoftware\\\\*\\\\Application\\\\brave.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Vivaldi\\\\Application\\\\vivaldi.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera*\\\\opera.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\PowerToys\\\\PowerToys.exe\",\n          \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\", \n          \"?:\\\\Windows\\\\System32\\\\wsl.exe\", \n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\"\n        )\n      ) or\n    \n      /* Discord App */\n      (process.name : \"Discord.exe\" and (process.code_signature.subject_name : \"Discord Inc.\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"discord.com\", \"cdn.discordapp.com\", \"discordapp.com\")\n      ) or \n\n      /* MS Sharepoint */\n      (process.name : \"Microsoft.SharePoint.exe\" and (process.code_signature.subject_name : \"Microsoft Corporation\" and\n       process.code_signature.trusted == true) and dns.question.name : \"onedrive.live.com\"\n      ) or \n\n      /* Firefox */\n      (process.name : \"firefox.exe\" and (process.code_signature.subject_name : \"Mozilla Corporation\" and\n       process.code_signature.trusted == true)\n      ) or \n\n      /* Dropbox */\n      (process.name : \"Dropbox.exe\" and (process.code_signature.subject_name : \"Dropbox, Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"api.dropboxapi.com\", \"*.dropboxusercontent.com\")\n      ) or \n\n      /* Obsidian - Plugins are stored on raw.githubusercontent.com */\n      (process.name : \"Obsidian.exe\" and (process.code_signature.subject_name : \"Dynalist Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : \"raw.githubusercontent.com\"\n      ) or \n\n      /* WebExperienceHostApp */\n      (process.name : \"WebExperienceHostApp.exe\" and (process.code_signature.subject_name : \"Microsoft Windows\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"onedrive.live.com\", \"skyapi.onedrive.live.com\")\n      ) or\n\n      (process.code_signature.subject_name : \"Microsoft *\" and process.code_signature.trusted == true and\n       dns.question.name : (\"*.sharepoint.com\", \"graph.microsoft.com\", \"g.live.com\", \"login.live.com\", \"login.live.com\")) or\n\n      (process.code_signature.trusted == true and\n       process.code_signature.subject_name :\n                             (\"Johannes Schindelin\",\n                              \"Redis Inc.\",\n                              \"Slack Technologies, LLC\",\n                              \"Cisco Systems, Inc.\",\n                              \"Dropbox, Inc\",\n                              \"Amazon.com Services LLC\", \n                              \"Island Technology Inc.\", \n                              \"GitHub, Inc.\", \n                              \"Red Hat, Inc\"))\n    )", "tactic": "Command and Control", "technique": "Web Service", "technique_id": "T1102", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_common_webservices.toml"}
{"title": "Potential DNS Tunneling via NsLookup", "description": "This rule identifies a large number (15) of nslookup.exe executions with an explicit query type from the same host. This\nmay indicate command and control activity utilizing the DNS protocol.", "query": "sequence by host.id with maxspan=5m\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"nslookup.exe\" and process.args:(\"-querytype=*\", \"-qt=*\", \"-q=*\", \"-type=*\")] with runs = 10", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_dns_tunneling_nslookup.toml"}
{"title": "Connection to Commonly Abused Free SSL Certificate Providers", "description": "Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a known\nencryption algorithm to conceal command and control traffic.", "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n  /* Add new free SSL certificate provider domains here */\n  dns.question.name : (\"*letsencrypt.org\", \"*.sslforfree.com\", \"*.zerossl.com\", \"*.freessl.org\") and\n\n  /* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */\n  process.executable : (\"C:\\\\Windows\\\\System32\\\\*.exe\",\n                        \"C:\\\\Windows\\\\System\\\\*.exe\",\n\t                  \"C:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\explorer.exe\",\n\t\t          \"C:\\\\Windows\\\\notepad.exe\") and\n\n  /* Insert noisy false positives here */\n  not process.name : (\"svchost.exe\", \"MicrosoftEdge*.exe\", \"msedge.exe\")", "tactic": "Command and Control", "technique": "Encrypted Channel", "technique_id": "T1573", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_encrypted_channel_freesslcert.toml"}
{"title": "Potential File Download via a Headless Browser", "description": "Identifies the use of a browser to download a file from a remote URL and from a suspicious parent process. Adversaries\nmay use browsers to avoid ingress tool transfer restrictions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\") and\n  (process.args : \"--headless*\" or process.args : \"data:text/html;base64,*\") and\n  process.parent.name :\n     (\"cmd.exe\", \"powershell.exe\", \"wscript.exe\", \"cscript.exe\", \"mshta.exe\", \"conhost.exe\", \"msiexec.exe\",\n      \"explorer.exe\", \"rundll32.exe\", \"winword.exe\", \"excel.exe\", \"onenote.exe\", \"hh.exe\", \"powerpnt.exe\", \"forfiles.exe\",\n      \"pcalua.exe\", \"wmiprvse.exe\")", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_headless_browser.toml"}
{"title": "Potential Command and Control via Internet Explorer", "description": "Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) making\nunusual network connections. Adversaries could abuse Internet Explorer via COM to avoid suspicious processes making\nnetwork connections and bypass host-based firewall restrictions.", "query": "sequence by host.id, user.name with maxspan = 5s\n  [library where host.os.type == \"windows\" and dll.name : \"IEProxy.dll\" and process.name : (\"rundll32.exe\", \"regsvr32.exe\")]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"iexplore.exe\" and process.parent.args : \"-Embedding\"]\n  /* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */\n  [network where host.os.type == \"windows\" and network.protocol == \"dns\" and process.name : \"iexplore.exe\" and\n   not dns.question.name :\n   (\n    \"*.microsoft.com\",\n    \"*.digicert.com\",\n    \"*.msocsp.com\",\n    \"*.windowsupdate.com\",\n    \"*.bing.com\",\n    \"*.identrust.com\",\n    \"*.sharepoint.com\",\n    \"*.office365.com\",\n    \"*.office.com\"\n    )\n  ] /* with runs=5 */", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_iexplore_via_com.toml"}
{"title": "Ingress Transfer via Windows BITS", "description": "Identifies downloads of executable and archive files via the Windows Background Intelligent Transfer Service (BITS).\nAdversaries could leverage Windows BITS transfer jobs to download remote payloads.", "query": "file where host.os.type == \"windows\" and event.action == \"rename\" and\n  process.name : \"svchost.exe\" and file.Ext.original.name : \"BIT*.tmp\" and \n  (file.extension : (\"exe\", \"zip\", \"rar\", \"bat\", \"dll\", \"ps1\", \"vbs\", \"wsh\", \"js\", \"vbe\", \"pif\", \"scr\", \"cmd\", \"cpl\") or\n   file.Ext.header_bytes : \"4d5a*\") and \n \n  /* noisy paths, for hunting purposes you can use the same query without the following exclusions */\n  not file.path : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Windows\\\\*\", \"?:\\\\ProgramData\\\\*\\\\*\") and \n \n  /* lot of third party SW use BITS to download executables with a long file name */\n  not length(file.name) > 30 and\n  not file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp*\\\\wct*.tmp\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Adobe\\\\ARM\\\\*\\\\RdrServicesUpdater*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Adobe\\\\ARM\\\\*\\\\AcroServicesUpdater*.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Docker Desktop Installer\\\\update-*.exe\"\n  )", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_ingress_transfer_bits.toml"}
{"title": "First Time Seen Commonly Abused Remote Access Tool Execution", "description": "Adversaries may install legitimate remote access tools (RAT) to compromised endpoints for further command-and-control\n(C2). Adversaries can rely on installed RATs for persistence, execution of native commands and more. This rule detects\nwhen a process is started whose name or code signature resembles commonly abused RATs. This is a New Terms rule type\nindicating the host has not seen this RAT process started before within the last 30 days.", "query": "host.os.type: \"windows\" and\n\n   event.category: \"process\" and event.type : \"start\" and\n\n    (\n        process.code_signature.subject_name : (\n            \"Action1 Corporation\" or\n            \"AeroAdmin LLC\" or\n            \"Ammyy LLC\" or\n            \"Atera Networks Ltd\" or\n            \"AWERAY PTE. LTD.\" or\n            \"BeamYourScreen GmbH\" or\n            \"Bomgar Corporation\" or\n            \"DUC FABULOUS CO.,LTD\" or\n            \"DOMOTZ INC.\" or\n            \"DWSNET O\u00dc\" or\n            \"FleetDeck Inc\" or\n            \"GlavSoft LLC\" or\n            \"GlavSoft LLC.\" or\n            \"Hefei Pingbo Network Technology Co. Ltd\" or\n            \"IDrive, Inc.\" or\n            \"IMPERO SOLUTIONS LIMITED\" or\n            \"Instant Housecall\" or\n            \"ISL Online Ltd.\" or\n            \"LogMeIn, Inc.\" or\n            \"Monitoring Client\" or\n            \"MMSOFT Design Ltd.\" or\n            \"Nanosystems S.r.l.\" or\n            \"NetSupport Ltd\" or\n            \"NinjaRMM, LLC\" or\n            \"Parallels International GmbH\" or\n            \"philandro Software GmbH\" or\n            \"Pro Softnet Corporation\" or\n            \"RealVNC\" or\n            \"RealVNC Limited\" or\n            \"BreakingSecurity.net\" or\n            \"Remote Utilities LLC\" or\n            \"Rocket Software, Inc.\" or\n            \"SAFIB\" or\n            \"Servably, Inc.\" or\n            \"ShowMyPC INC\" or\n            \"Splashtop Inc.\" or\n            \"Superops Inc.\" or\n            \"TeamViewer\" or\n            \"TeamViewer GmbH\" or\n            \"TeamViewer Germany GmbH\" or\n            \"Techinline Limited\" or\n            \"uvnc bvba\" or\n            \"Yakhnovets Denis Aleksandrovich IP\" or\n            \"Zhou Huabing\"\n        ) or\n\n        process.name.caseless : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        ) or\n        process.name : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        )\n\t) and\n\n\tnot (process.pe.original_file_name : (\"G2M.exe\" or \"Updater.exe\" or \"powershell.exe\") and process.code_signature.subject_name : \"LogMeIn, Inc.\")", "tactic": "Command and Control", "technique": "Remote Access Tools", "technique_id": "T1219", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_new_terms_commonly_abused_rat_execution.toml"}
{"title": "Outlook Home Page Registry Modification", "description": "Identifies modifications in registry keys associated with abuse of the Outlook Home Page functionality for command and\ncontrol or persistence.", "query": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and registry.value : \"URL\" and\n    registry.path : (\n        \"*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Outlook\\\\Webview\\\\*\",\n        \"*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Outlook\\\\Today\\\\*\"\n    ) and registry.data.strings : \"*://*\"", "tactic": "Command and Control", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_outlook_home_page.toml"}
{"title": "Port Forwarding Rule Addition", "description": "Identifies the creation of a new port forwarding rule. An adversary may abuse this technique to bypass network\nsegmentation restrictions.", "query": "registry where host.os.type == \"windows\" and registry.path : (\n  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\",\n  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\",\n  \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\"\n)", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_port_forwarding_added_registry.toml"}
{"title": "Potential Remote Desktop Tunneling Detected", "description": "Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to\nenable routing of network packets that would otherwise not reach their intended destination.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* RDP port and usual SSH tunneling related switches in command line */\n  process.args : \"*:3389\" and\n  process.args : (\"-L\", \"-P\", \"-R\", \"-pw\", \"-ssh\")", "tactic": "Command and Control", "technique": "Protocol Tunneling", "technique_id": "T1572", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_rdp_tunnel_plink.toml"}
{"title": "Remote File Download via Desktopimgdownldr Utility", "description": "Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr to\ndownload arbitrary files as an alternative to certutil.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"desktopimgdownldr.exe\" or ?process.pe.original_file_name == \"desktopimgdownldr.exe\") and\n  process.args : \"/lockscreenurl:http*\"", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_remote_file_copy_desktopimgdownldr.toml"}
{"title": "Remote File Download via MpCmdRun", "description": "Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"MpCmdRun.exe\" or ?process.pe.original_file_name == \"MpCmdRun.exe\") and\n   process.args : \"-DownloadFile\" and process.args : \"-url\" and process.args : \"-path\"", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_remote_file_copy_mpcmdrun.toml"}
{"title": "Remote File Download via PowerShell", "description": "Identifies powershell.exe being used to download an executable file from an untrusted remote destination.", "query": "sequence by process.entity_id with maxspan=30s\n\n[network where host.os.type == \"windows\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and network.protocol == \"dns\" and\n   not dns.question.name : (\n          \"localhost\", \"*.microsoft.com\", \"*.azureedge.net\", \"*.powershellgallery.com\",\n          \"*.windowsupdate.com\", \"metadata.google.internal\", \"dist.nuget.org\",\n          \"artifacts.elastic.co\", \"*.digicert.com\", \"packages.chocolatey.org\",\n          \"outlook.office365.com\"\n       ) and not user.id : \"S-1-5-18\"]\n[file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : \"powershell.exe\" and file.extension : (\"exe\", \"dll\", \"ps1\", \"bat\") and\n  not file.name : \"__PSScriptPolicy*.ps1\"]", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_remote_file_copy_powershell.toml"}
{"title": "Remote File Download via Script Interpreter", "description": "Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable file\nfrom a remote destination.", "query": "sequence by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and process.name : (\"wscript.exe\", \"cscript.exe\") and network.protocol != \"dns\" and\n   network.direction : (\"outgoing\", \"egress\") and network.type == \"ipv4\" and destination.ip != \"127.0.0.1\"\n  ]\n  [file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : (\"exe\", \"dll\")]", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_remote_file_copy_scripts.toml"}
{"title": "Suspicious ScreenConnect Client Child Process", "description": "Identifies suspicious processes being spawned by the ScreenConnect client processes. This activity may indicate\nexecution abusing unauthorized access to the ScreenConnect remote access software.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name :\n                (\"ScreenConnect.ClientService.exe\",\n                 \"ScreenConnect.WindowsClient.exe\",\n                 \"ScreenConnect.WindowsBackstageShell.exe\",\n                 \"ScreenConnect.WindowsFileManager.exe\") and\n  (\n   (process.name : \"powershell.exe\" and\n    process.args : (\"-enc\", \"-ec\", \"-e\", \"*downloadstring*\", \"*Reflection.Assembly*\", \"*http*\")) or\n   (process.name : \"cmd.exe\" and process.args : \"/c\") or\n   (process.name : \"net.exe\" and process.args : \"/add\") or\n   (process.name : \"schtasks.exe\" and process.args : (\"/create\", \"-create\")) or\n   (process.name : \"sc.exe\" and process.args : \"create\") or\n   (process.name : \"rundll32.exe\" and not process.args : \"url.dll,FileProtocolHandler\") or\n   (process.name : \"msiexec.exe\" and process.args : (\"/i\", \"-i\") and\n    process.args : (\"/q\", \"/quiet\", \"/qn\", \"-q\", \"-quiet\", \"-qn\", \"-Q+\")) or\n   process.name : (\"mshta.exe\", \"certutil.exe\", \"bistadmin.exe\", \"certreq.exe\", \"wscript.exe\", \"cscript.exe\", \"curl.exe\",\n                   \"ssh.exe\", \"scp.exe\", \"wevtutil.exe\", \"wget.exe\", \"wmic.exe\")\n   )", "tactic": "Command and Control", "technique": "Remote Access Tools", "technique_id": "T1219", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_screenconnect_childproc.toml"}
{"title": "SUNBURST Command and Control Activity", "description": "The malware known as SUNBURST targets the SolarWind's Orion business software for command and control. This rule detects\npost-exploitation command and control activity of the SUNBURST backdoor.", "query": "network where host.os.type == \"windows\" and event.type == \"protocol\" and network.protocol == \"http\" and\n  process.name : (\"ConfigurationWizard.exe\",\n                  \"NetFlowService.exe\",\n                  \"NetflowDatabaseMaintenance.exe\",\n                  \"SolarWinds.Administration.exe\",\n                  \"SolarWinds.BusinessLayerHost.exe\",\n                  \"SolarWinds.BusinessLayerHostx64.exe\",\n                  \"SolarWinds.Collector.Service.exe\",\n                  \"SolarwindsDiagnostics.exe\") and\n  (\n    (\n      (http.request.body.content : \"*/swip/Upload.ashx*\" and http.request.body.content : (\"POST*\", \"PUT*\")) or\n      (http.request.body.content : (\"*/swip/SystemDescription*\", \"*/swip/Events*\") and http.request.body.content : (\"GET*\", \"HEAD*\"))\n    ) and\n    not http.request.body.content : \"*solarwinds.com*\"\n  )", "tactic": "Command and Control", "technique": "Application Layer Protocol", "technique_id": "T1071", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_sunburst_c2_activity_detected.toml"}
{"title": "Remote File Copy via TeamViewer", "description": "Identifies an executable or script file remotely downloaded via a TeamViewer transfer session.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and process.name : \"TeamViewer.exe\" and\n  file.extension : (\"exe\", \"dll\", \"scr\", \"com\", \"bat\", \"ps1\", \"vbs\", \"vbe\", \"js\", \"wsh\", \"hta\") and\n  not \n  (\n    file.path : (\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\*.js\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\TeamViewer\\\\update.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\?\\\\TeamViewer\\\\update.exe\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\TeamViewer\\\\CustomConfigs\\\\???????\\\\TeamViewer_Resource_??.dll\",\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\TeamViewer\\\\CustomConfigs\\\\???????\\\\TeamViewer*.exe\"\n    ) and process.code_signature.trusted == true\n  )", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_teamviewer_remote_file_copy.toml"}
{"title": "Potential File Transfer via Curl for Windows", "description": "Identifies Curl for Windows making an HTTP request. Adversaries could abuse Curl to download files or upload data to a\nremote URL.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\curl.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\curl.exe\"\n  ) and\n  process.command_line : \"*http*\" and\n  process.parent.name : (\n    \"cmd.exe\", \"powershell.exe\",\n    \"rundll32.exe\", \"explorer.exe\",\n    \"conhost.exe\", \"forfiles.exe\",\n    \"wscript.exe\", \"cscript.exe\",\n    \"mshta.exe\", \"hh.exe\", \"mmc.exe\"\n  ) and \n  not (\n    user.id == \"S-1-5-18\" and\n    /* Don't apply the user.id exclusion to Sysmon for compatibility */\n    not event.dataset : (\"windows.sysmon_operational\", \"windows.sysmon\")\n  ) and\n  /* Exclude System Integrity Processes for Sysmon */\n  not ?winlog.event_data.IntegrityLevel == \"System\"", "tactic": "Command and Control", "technique": "Ingress Tool Transfer", "technique_id": "T1105", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_tool_transfer_via_curl.toml"}
{"title": "Attempt to Establish VScode Remote Tunnel", "description": "Detects the execution of the VScode portable binary with the tunnel command line option indicating an attempt to\nestablish a remote tunnel session to Github or a remote VScode instance.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"tunnel\" and (process.args : \"--accept-server-license-terms\" or process.name : \"code*.exe\") and\n  not (process.name == \"code-tunnel.exe\" and process.args == \"status\" and process.parent.name == \"Code.exe\")", "tactic": "Command and Control", "technique": "Remote Access Tools", "technique_id": "T1219", "risk_score": "N/A", "tags": [], "references": [], "file": "command_and_control_tunnel_vscode.toml"}
{"title": "Potential ADIDNS Poisoning via Wildcard Record Creation", "description": "Active Directory Integrated DNS (ADIDNS) is one of the core components of AD DS, leveraging AD's access control and\nreplication to maintain domain consistency. It stores DNS zones as AD objects, a feature that, while robust, introduces\nsome security issues, such as wildcard records, mainly because of the default permission (Any authenticated users) to\ncreate DNS-named records. Attackers can create wildcard records to redirect traffic that doesn't explicitly match\nrecords contained in the zone, becoming the Man-in-the-Middle and being able to abuse DNS similarly to LLMNR/NBNS\nspoofing.", "query": "any where host.os.type == \"windows\" and event.code == \"5137\" and\n    startsWith(winlog.event_data.ObjectDN, \"DC=*,\")", "tactic": "Credential Access", "technique": "Adversary-in-the-Middle", "technique_id": "T1557", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_adidns_wildcard.toml"}
{"title": "Potential WPAD Spoofing via DNS Record Creation", "description": "Identifies the creation of a DNS record that is potentially meant to enable WPAD spoofing. Attackers can disable the\nGlobal Query Block List (GQBL) and create a \"wpad\" record to exploit hosts running WPAD with default settings for\nprivilege escalation and lateral movement.", "query": "any where host.os.type == \"windows\" and event.code == \"5137\" and winlog.event_data.ObjectDN : \"DC=wpad,*\"", "tactic": "Credential Access", "technique": "Adversary-in-the-Middle", "technique_id": "T1557", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_adidns_wpad_record.toml"}
{"title": "Privileged Account Brute Force", "description": "Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within a\nshort time interval. Adversaries will often brute force login attempts across multiple users with a common or known\npassword, in an attempt to gain access to accounts.", "query": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and user.name : \"*admin*\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_bruteforce_admin_account.toml"}
{"title": "Multiple Logon Failure Followed by Logon Success", "description": "Identifies multiple logon failures followed by a successful one from the same source address. Adversaries will often\nbrute force login attempts across multiple users with a common or known password, in an attempt to gain access to\naccounts.", "query": "sequence by winlog.computer_name, source.ip with maxspan=5s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and user.id != null and \n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and \n    not winlog.event_data.TargetUserSid : \"S-1-0-0\" and not user.id : \"S-1-0-0\" and \n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\"]", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_bruteforce_multiple_logon_failure_followed_by_success.toml"}
{"title": "Multiple Logon Failure from the same Source Address", "description": "Identifies multiple consecutive logon failures from the same source address and within a short time interval.\nAdversaries will often brute force login attempts across multiple users with a common or known password, in an attempt\nto gain access to accounts.", "query": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /*\n    noisy failure status codes often associated to authentication misconfiguration :\n     0xC000015B - The user has not been granted the requested logon type (also called the logon right) at this machine.\n     0XC000005E\t- There are currently no logon servers available to service the logon request.\n     0XC0000133\t- Clocks between DC and other computer too far out of sync.\n     0XC0000192\tAn attempt was made to logon, but the Netlogon service was not started.\n    */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=10", "tactic": "Credential Access", "technique": "Brute Force", "technique_id": "T1110", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_bruteforce_multiple_logon_failure_same_srcip.toml"}
{"title": "Potential Credential Access via Windows Utilities", "description": "Identifies the execution of known Windows utilities often abused to dump LSASS memory or the Active Directory database\n(NTDS.dit) in preparation for credential access.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (?process.pe.original_file_name : \"procdump\" or process.name : \"procdump.exe\") and process.args : \"-ma\"\n  ) or\n  (\n    process.name : \"ProcessDump.exe\" and not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Cisco Systems\\\\.* \"\"\"  ) or\n  (\n    (?process.pe.original_file_name : \"WriteMiniDump.exe\" or process.name : \"WriteMiniDump.exe\") and\n      not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Steam\\\\.* \"\"\"  ) or\n  (\n    (?process.pe.original_file_name : \"RUNDLL32.EXE\" or process.name : \"RUNDLL32.exe\") and\n      (process.args : \"MiniDump*\" or process.command_line : \"*comsvcs.dll*#24*\")\n  ) or\n  (\n    (?process.pe.original_file_name : \"RdrLeakDiag.exe\" or process.name : \"RdrLeakDiag.exe\") and\n      process.args : \"/fullmemdmp\"\n  ) or\n  (\n    (?process.pe.original_file_name : \"SqlDumper.exe\" or process.name : \"SqlDumper.exe\") and\n      process.args : \"0x01100*\") or\n  (\n    (?process.pe.original_file_name : \"TTTracer.exe\" or process.name : \"TTTracer.exe\") and\n      process.args : \"-dumpFull\" and process.args : \"-attach\") or\n  (\n    (?process.pe.original_file_name : \"ntdsutil.exe\" or process.name : \"ntdsutil.exe\") and\n      process.args : \"create*full*\") or\n  (\n    (?process.pe.original_file_name : \"diskshadow.exe\" or process.name : \"diskshadow.exe\") and process.args : \"/s\")\n)", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_cmdline_dump_tool.toml"}
{"title": "NTDS or SAM Database File Copied", "description": "Identifies a copy operation of the Active Directory Domain Database (ntds.dit) or Security Account Manager (SAM) files.\nThose files contain sensitive information including hashed domain and/or local credentials.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    ((?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\") or process.name : (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\")) and\n       process.args : (\"copy\", \"xcopy\", \"Copy-Item\", \"move\", \"cp\", \"mv\")\n    ) or\n    ((?process.pe.original_file_name : \"esentutl.exe\" or process.name : \"esentutl.exe\") and process.args : (\"*/y*\", \"*/vss*\", \"*/d*\"))\n  ) and\n  process.command_line : (\"*\\\\ntds.dit*\", \"*\\\\config\\\\SAM*\", \"*\\\\*\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy*\\\\*\", \"*/system32/config/SAM*\", \"*\\\\User Data\\\\*\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_copy_ntds_sam_volshadowcp_cmdline.toml"}
{"title": "Potential Credential Access via Trusted Developer Utility", "description": "An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows\ncredential management. This technique is sometimes used for credential dumping.", "query": "sequence by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\")]\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : (\"vaultcli.dll\", \"SAMLib.DLL\") or file.name : (\"vaultcli.dll\", \"SAMLib.DLL\"))]", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_credential_dumping_msbuild.toml"}
{"title": "FirstTime Seen Account Performing DCSync", "description": "This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers\ncan use the DCSync technique to get credential information of individual accounts or the entire domain, thus\ncompromising the entire domain.", "query": "event.code:\"4662\" and winlog.event_data.Properties:(\n                               *DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or\n                               *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or\n                               *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and\n not winlog.event_data.SubjectUserName:(*$ or MSOL_*)", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dcsync_newterm_subjectuser.toml"}
{"title": "Potential Credential Access via DCSync", "description": "This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync\ntechnique to get credential information of individual accounts or the entire domain, thus compromising the entire\ndomain.", "query": "any where event.code == \"4662\" and\n  winlog.event_data.Properties : (\n\n    /* Control Access Rights/Permissions Symbol */\n\n    \"*DS-Replication-Get-Changes*\",\n    \"*DS-Replication-Get-Changes-All*\",\n    \"*DS-Replication-Get-Changes-In-Filtered-Set*\",\n\n    /* Identifying GUID used in ACE */\n\n    \"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*89e95b76-444d-4c62-991a-0facbeda640c*\")\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    and winlog.event_data.AccessMask : \"0x100\" and\n    not winlog.event_data.SubjectUserName : (\n          \"*$\", \"MSOL_*\", \"OpenDNS_Connector\", \"adconnect\", \"SyncADConnect\",\n          \"SyncADConnectCM\", \"aadsync\", \"svcAzureADSync\", \"-\"\n        )\n\n    /* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dcsync_replication_rights.toml"}
{"title": "Potential Active Directory Replication Account Backdoor", "description": "Identifies the modification of the nTSecurityDescriptor attribute in a domain object with rights related to DCSync to a\nuser/computer account. Attackers can use this backdoor to re-obtain access to hashes of any user/computer.", "query": "event.code:\"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"nTSecurityDescriptor\" and\n  winlog.event_data.AttributeValue : (\n    (\n      *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and\n      *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and\n      *89e95b76-444d-4c62-991a-0facbeda640c;;S-1-5-21-*\n    )\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dcsync_user_backdoor.toml"}
{"title": "Kerberos Pre-authentication Disabled for User", "description": "Identifies the modification of an account's Kerberos pre-authentication options. An adversary with\nGenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline password\ncracking attacks such as AS-REP roasting.", "query": "any where host.os.type == \"windows\" and event.code == \"4738\" and\n  winlog.event_data.NewUACList == \"USER_DONT_REQUIRE_PREAUTH\"", "tactic": "Credential Access", "technique": "Steal or Forge Kerberos Tickets", "technique_id": "T1558", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_disable_kerberos_preauth.toml"}
{"title": "Creation of a DNS-Named Record", "description": "Active Directory Integrated DNS (ADIDNS) is one of the core components of AD DS, leveraging AD's access control and\nreplication to maintain domain consistency. It stores DNS zones as AD objects, a feature that, while robust, introduces\nsome security issues because of the default permission (Any authenticated users) to create DNS-named records. Attackers\ncan perform Dynamic Spoofing attacks, where they monitor LLMNR/NBT-NS requests and create DNS-named records to target\nsystems that are requested from multiple systems. They can also create specific records to target specific services,\nsuch as wpad, for spoofing attacks.", "query": "any where host.os.type == \"windows\" and event.code == \"5137\" and winlog.event_data.ObjectClass == \"dnsNode\" and\n    not winlog.event_data.SubjectUserName : \"*$\"", "tactic": "Credential Access", "technique": "Adversary-in-the-Middle", "technique_id": "T1557", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dnsnode_creation.toml"}
{"title": "Potential Relay Attack against a Domain Controller", "description": "Identifies potential relay attacks against a domain controller (DC) by identifying authentication events using the\ndomain controller computer account coming from other hosts to the DC that owns the account. Attackers may relay the DC\nhash after capturing it using forced authentication.", "query": "authentication where host.os.type == \"windows\" and event.code in (\"4624\", \"4625\") and endswith~(user.name, \"$\") and\n    winlog.event_data.AuthenticationPackageName : \"NTLM\" and winlog.logon.type : \"network\" and\n\n    /* Filter for a machine account that matches the hostname */\n    startswith~(host.name, substring(user.name, 0, -1)) and\n\n    /* Verify if the Source IP belongs to the host */\n    not endswith(string(source.ip), string(host.ip)) and\n    source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"", "tactic": "Credential Access", "technique": "Forced Authentication", "technique_id": "T1187", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dollar_account_relay.toml"}
{"title": "Creation or Modification of Domain Backup DPAPI private key", "description": "Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API\n(DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")", "tactic": "Credential Access", "technique": "Unsecured Credentials", "technique_id": "T1552", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_domain_backup_dpapi_private_keys.toml"}
{"title": "Credential Acquisition via Registry Hive Dumping", "description": "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"reg.exe\" or process.name : \"reg.exe\") and\n process.args : (\"save\", \"export\") and\n process.args : (\"hklm\\\\sam\", \"hklm\\\\security\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_dump_registry_hives.toml"}
{"title": "Full User-Mode Dumps Enabled System-Wide", "description": "Identifies the enable of the full user-mode dumps feature system-wide. This feature allows Windows Error Reporting (WER)\nto collect data after an application crashes. This setting is a requirement for the LSASS Shtinkering attack, which\nfakes the communication of a crash on LSASS, generating a dump of the process memory, which gives the attacker access to\nthe credentials present on the system without having to bring malware to the system. This setting is not enabled by\ndefault, and applications must create their registry subkeys to hold settings that enable them to collect dumps.", "query": "registry where host.os.type == \"windows\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\"\n    ) and\n    registry.data.strings : (\"2\", \"0x00000002\") and\n    not (process.executable : \"?:\\\\Windows\\\\system32\\\\svchost.exe\" and user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\"))", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_generic_localdumps.toml"}
{"title": "Microsoft IIS Connection Strings Decryption", "description": "Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web server\naccess via a webshell or alike can decrypt and dump any hardcoded connection strings, such as the MSSQL service account\npassword using aspnet_regiis command.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"aspnet_regiis.exe\" or ?process.pe.original_file_name == \"aspnet_regiis.exe\") and\n  process.args : \"connectionStrings\" and process.args : \"-pdf\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_iis_connectionstrings_dumping.toml"}
{"title": "Untrusted DLL Loaded by Azure AD Sync Service", "description": "Identifies the load of a DLL without a valid code signature by the Azure AD Sync process, which may indicate an attempt\nto persist or collect sensitive credentials passing through the Azure AD synchronization server.", "query": "any where host.os.type == \"windows\" and process.name : \"AzureADConnectAuthenticationAgentService.exe\" and\n(\n (event.category == \"library\" and event.action == \"load\") or\n (event.category == \"process\" and event.action : \"Image loaded*\")\n) and\n\nnot (?dll.code_signature.trusted == true or file.code_signature.status == \"Valid\") and not\n\n  (\n   /* Elastic defend DLL path */\n   ?dll.path :\n         (\"?:\\\\Windows\\\\assembly\\\\NativeImages*\",\n          \"?:\\\\Windows\\\\Microsoft.NET\\\\*\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\") or\n\n   /* Sysmon DLL path is mapped to file.path */\n   file.path :\n         (\"?:\\\\Windows\\\\assembly\\\\NativeImages*\",\n          \"?:\\\\Windows\\\\Microsoft.NET\\\\*\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\")\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_imageload_azureadconnectauthsvc.toml"}
{"title": "Kerberos Traffic from Unusual Process", "description": "Identifies network connections to the standard Kerberos port from an unusual process. On Windows, the only process that\nnormally performs Kerberos traffic from a domain joined host is lsass.exe.", "query": "network where host.os.type == \"windows\" and event.type == \"start\" and network.direction == \"egress\" and\n  destination.port == 88 and source.port >= 49152 and process.pid != 4 and destination.address : \"*\" and\n  not \n  (\n    process.executable : (\n        \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap\\\\nmap.exe\",\n        \"\\\\device\\\\harddiskvolume?\\\\program files (x86)\\\\nmap oem\\\\nmap.exe\",\n        \"\\\\device\\\\harddiskvolume?\\\\windows\\\\system32\\\\lsass.exe\",\n        \"?:\\\\Program Files\\\\Amazon Corretto\\\\jdk1*\\\\bin\\\\java.exe\",\n        \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Proxy Server\\\\bin\\\\prunsrv.exe\",\n        \"?:\\\\Program Files\\\\BlackBerry\\\\UEM\\\\Core\\\\tomcat-core\\\\bin\\\\tomcat9.exe\",\n        \"?:\\\\Program Files\\\\DBeaver\\\\dbeaver.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.backend.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\com.docker.vpnkit.exe\",\n        \"?:\\\\Program Files\\\\Docker\\\\Docker\\\\resources\\\\vpnkit.exe\",\n        \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files\\\\Internet Explorer\\\\iexplore.exe\",\n        \"?:\\\\Program Files\\\\JetBrains\\\\PyCharm Community Edition*\\\\bin\\\\pycharm64.exe\",\n        \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n        \"?:\\\\Program Files\\\\Oracle\\\\VirtualBox\\\\VirtualBoxVM.exe\",\n        \"?:\\\\Program Files\\\\Puppet Labs\\\\Puppet\\\\puppet\\\\bin\\\\ruby.exe\",\n        \"?:\\\\Program Files\\\\rapid7\\\\nexpose\\\\nse\\\\.DLLCACHE\\\\nseserv.exe\",\n        \"?:\\\\Program Files\\\\Silverfort\\\\Silverfort AD Adapter\\\\SilverfortServer.exe\",\n        \"?:\\\\Program Files\\\\Tenable\\\\Nessus\\\\nessusd.exe\",\n        \"?:\\\\Program Files\\\\VMware\\\\VMware View\\\\Server\\\\bin\\\\ws_TomcatService.exe\",\n        \"?:\\\\Program Files (x86)\\\\Advanced Port Scanner\\\\advanced_port_scanner.exe\",\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcpatchscan.exe\",\n        \"?:\\\\Program Files (x86)\\\\GFI\\\\LanGuard 12 Agent\\\\lnsscomm.exe\",\n        \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n        \"?:\\\\Program Files (x86)\\\\Internet Explorer\\\\iexplore.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeUpdate\\\\MicrosoftEdgeUpdate.exe\",\n        \"?:\\\\Program Files (x86)\\\\Microsoft Silverlight\\\\sllauncher.exe\",\n        \"?:\\\\Program Files (x86)\\\\Nmap\\\\nmap.exe\",\n        \"?:\\\\Program Files (x86)\\\\Nmap OEM\\\\nmap.exe\",\n        \"?:\\\\Program Files (x86)\\\\nwps\\\\NetScanTools Pro\\\\NSTPRO.exe\",\n        \"?:\\\\Program Files (x86)\\\\SAP BusinessObjects\\\\tomcat\\\\bin\\\\tomcat9.exe\",\n        \"?:\\\\Program Files (x86)\\\\SuperScan\\\\scanner.exe\",\n        \"?:\\\\Program Files (x86)\\\\Zscaler\\\\ZSATunnel\\\\ZSATunnel.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\vmnat.exe\",\n        \"?:\\\\Windows\\\\SystemApps\\\\Microsoft.MicrosoftEdge_*\\\\MicrosoftEdge.exe\",\n        \"System\"\n    ) and process.code_signature.trusted == true\n  ) and\n destination.address != \"127.0.0.1\" and destination.address != \"::1\"", "tactic": "Credential Access", "technique": "Steal or Forge Kerberos Tickets", "technique_id": "T1558", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_kerberoasting_unusual_process.toml"}
{"title": "Potential Kerberos Coercion via DNS-Based SPN Spoofing", "description": "Identifies the creation of a DNS record containing a base64-encoded blob matching the pattern \"UWhRCA...BAAAA\". This\npattern corresponds to a marshaled CREDENTIAL_TARGET_INFORMATION structure, commonly used in Kerberos coercion attacks.\nIt is associated with tools and techniques that exploit SPN spoofing via DNS. Adversaries may abuse this to coerce\nvictim systems into authenticating to attacker-controlled hosts while requesting Kerberos tickets for legitimate\nservices (often the victim's own identity). This enables reflective Kerberos relay attacks, potentially resulting in\nprivileged access such as NT AUTHORITY\\SYSTEM, without relying on NTLM fallback.", "query": "(event.code:4662 and winlog.event_data.AdditionalInfo: *UWhRC*BAAAA*MicrosoftDNS*) or\n(event.code:5137 and winlog.event_data.ObjectDN: *UWhRC*BAAAA*MicrosoftDNS*)", "tactic": "Credential Access", "technique": "Adversary-in-the-Middle", "technique_id": "T1557", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_kerberos_coerce.toml"}
{"title": "Potential Kerberos SPN Spoofing via Suspicious DNS Query", "description": "Identifies queries to a DNS record containing a base64-encoded blob matching the pattern \"UWhRCA...BAAAA\". This pattern\ncorresponds to a marshaled CREDENTIAL_TARGET_INFORMATION structure, commonly used in Kerberos coercion attacks. It is\nassociated with tools and techniques that exploit SPN spoofing via DNS. Adversaries may abuse this to coerce victim\nsystems into authenticating to attacker-controlled hosts while requesting Kerberos tickets for legitimate services\n(often the victim's own identity), enabling attacks such as NTLM reflection.", "query": "network where host.os.type == \"windows\" and dns.question.name : \"*UWhRC*BAAAA*\"", "tactic": "Credential Access", "technique": "Adversary-in-the-Middle", "technique_id": "T1557", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_kerberos_coerce_dns.toml"}
{"title": "Kirbi File Creation", "description": "Identifies the creation of .kirbi files. The creation of this kind of file is an indicator of an attacker running\nKerberos ticket dump utilities, such as Mimikatz, and precedes attacks such as Pass-The-Ticket (PTT), which allows the\nattacker to impersonate users using Kerberos tickets.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"kirbi\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_kirbi_file.toml"}
{"title": "Access to a Sensitive LDAP Attribute", "description": "Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as\nunixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.", "query": "any where event.code == \"4662\" and\n\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n  winlog.event_data.Properties : (\n   /* unixUserPassword */\n  \"*612cb747-c0e8-4f92-9221-fdd5f15b550d*\",\n\n  /* ms-PKI-AccountCredentials */\n  \"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*\",\n\n  /*  ms-PKI-DPAPIMasterKeys */\n  \"*b3f93023-9239-4f7c-b99c-6745d87adbc2*\",\n\n  /* msPKI-CredentialRoamingTokens */\n  \"*b7ff5a38-0818-42b0-8110-d3d154c97f24*\"\n  ) and\n\n  /*\n   Excluding noisy AccessMasks\n   0x0 undefined and 0x100 Control Access\n   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n   */\n  not winlog.event_data.AccessMask in (\"0x0\", \"0x100\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_ldap_attributes.toml"}
{"title": "Suspicious LSASS Access via MalSecLogon", "description": "Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access\nrights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service in\npreparation for credential access.", "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* seclogon service accessing lsass */\n  winlog.event_data.CallTrace : \"*seclogon.dll*\" and process.name : \"svchost.exe\" and\n\n   /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */\n  winlog.event_data.GrantedAccess == \"0x14c0\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_lsass_handle_via_malseclogon.toml"}
{"title": "Suspicious Module Loaded by LSASS", "description": "Identifies LSASS loading an unsigned or untrusted DLL. Windows Security Support Provider (SSP) DLLs are loaded into\nLSSAS process at system start. Once loaded into the LSA, SSP DLLs have access to encrypted and plaintext passwords that\nare stored in Windows, such as any logged-on user's Domain password or smart card PINs.", "query": "any where event.category in (\"library\", \"driver\") and host.os.type == \"windows\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  not (dll.code_signature.subject_name :\n               (\"Microsoft Windows\",\n                \"Microsoft Corporation\",\n                \"Microsoft Windows Publisher\",\n                \"Microsoft Windows Software Compatibility Publisher\",\n                \"Microsoft Windows Hardware Compatibility Publisher\",\n                \"McAfee, Inc.\",\n                \"SecMaker AB\",\n                \"HID Global Corporation\",\n                \"HID Global\",\n                \"Apple Inc.\",\n                \"Citrix Systems, Inc.\",\n                \"Dell Inc\",\n                \"Hewlett-Packard Company\",\n                \"Symantec Corporation\",\n                \"National Instruments Corporation\",\n                \"DigitalPersona, Inc.\",\n                \"Novell, Inc.\",\n                \"gemalto\",\n                \"EasyAntiCheat Oy\",\n                \"Entrust Datacard Corporation\",\n                \"AuriStor, Inc.\",\n                \"LogMeIn, Inc.\",\n                \"VMware, Inc.\",\n                \"Istituto Poligrafico e Zecca dello Stato S.p.A.\",\n                \"Nubeva Technologies Ltd\",\n                \"Micro Focus (US), Inc.\",\n                \"Yubico AB\",\n                \"GEMALTO SA\",\n                \"Secure Endpoints, Inc.\",\n                \"Sophos Ltd\",\n                \"Morphisec Information Security 2014 Ltd\",\n                \"Entrust, Inc.\",\n                \"Nubeva Technologies Ltd\",\n                \"Micro Focus (US), Inc.\",\n                \"F5 Networks Inc\",\n                \"Bit4id\",\n                \"Thales DIS CPL USA, Inc.\",\n                \"Micro Focus International plc\",\n                \"HYPR Corp\",\n                \"Intel(R) Software Development Products\",\n                \"PGP Corporation\",\n                \"Parallels International GmbH\",\n                \"FrontRange Solutions Deutschland GmbH\",\n                \"SecureLink, Inc.\",\n                \"Tidexa OU\",\n                \"Amazon Web Services, Inc.\",\n                \"SentryBay Limited\",\n                \"Audinate Pty Ltd\",\n                \"CyberArk Software Ltd.\",\n                \"McAfeeSysPrep\",\n                \"NVIDIA Corporation PE Sign v2016\",\n                \"Trend Micro, Inc.\",\n                \"Fortinet Technologies (Canada) Inc.\",\n                \"Carbon Black, Inc.\") and\n       dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\")) and\n\n     not dll.hash.sha256 :\n                (\"811a03a5d7c03802676d2613d741be690b3461022ea925eb6b2651a5be740a4c\",\n                 \"1181542d9cfd63fb00c76242567446513e6773ea37db6211545629ba2ecf26a1\",\n                 \"ed6e735aa6233ed262f50f67585949712f1622751035db256811b4088c214ce3\",\n                 \"26be2e4383728eebe191c0ab19706188f0e9592add2e0bf86b37442083ae5e12\",\n                 \"9367e78b84ef30cf38ab27776605f2645e52e3f6e93369c674972b668a444faa\",\n                 \"d46cc934765c5ecd53867070f540e8d6f7701e834831c51c2b0552aba871921b\",\n                 \"0f77a3826d7a5cd0533990be0269d951a88a5c277bc47cff94553330b715ec61\",\n                 \"4aca034d3d85a9e9127b5d7a10882c2ef4c3e0daa3329ae2ac1d0797398695fb\",\n                 \"86031e69914d9d33c34c2f4ac4ae523cef855254d411f88ac26684265c981d95\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_lsass_loaded_susp_dll.toml"}
{"title": "LSASS Memory Dump Creation", "description": "Identifies the creation of a Local Security Authority Subsystem Service (lsass.exe) default memory dump. This may\nindicate a credential access attempt via trusted system utilities such as Task Manager (taskmgr.exe) and SQL Dumper\n(sqldumper.exe) or known pentesting tools such as Dumpert and AndrewSpecial.", "query": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n  file.name : (\"lsass*.dmp\", \"dumpert.dmp\", \"Andrew.dmp\", \"SQLDmpr*.mdmp\", \"Coredump.dmp\") and\n\n  not (\n        process.executable : (\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\SqlDumper.exe\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server Reporting Services\\\\SSRS\\\\ReportServer\\\\bin\\\\SqlDumper.exe\",\n          \"?:\\\\Windows\\\\System32\\\\dllhost.exe\"\n        ) and\n        file.path : (\n          \"?:\\\\*\\\\Reporting Services\\\\Logfiles\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server Reporting Services\\\\SSRS\\\\Logfiles\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\Shared\\\\ErrorDumps\\\\SQLDmpr*.mdmp\",\n          \"?:\\\\Program Files\\\\Microsoft SQL Server\\\\*\\\\MSSQL\\\\LOG\\\\SQLDmpr*.mdmp\"\n        )\n      ) and\n\n  not (\n        process.executable : (\n          \"?:\\\\Windows\\\\system32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n          ) and\n        file.path : (\n          \"?:\\\\Windows\\\\System32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\CrashDumps\\\\lsass.exe.*.dmp\",\n          \"?:\\\\Windows\\\\System32\\\\%LOCALAPPDATA%\\\\CrashDumps\\\\lsass.exe.*.dmp\"\n        )\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_lsass_memdump_file_created.toml"}
{"title": "LSASS Memory Dump Handle Access", "description": "Identifies handle requests for the Local Security Authority Subsystem Service (LSASS) object access with specific access\nmasks that many tools with a capability to dump memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is tool\nagnostic as it has been validated against a host of various LSASS dump tools such as SharpDump, Procdump, Mimikatz,\nComsvcs etc. It detects this behavior at a low level and does not depend on a specific tool or dump file name.", "query": "any where event.code == \"4656\" and\n\n    winlog.event_data.ObjectName : (\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\System32\\\\lsass.exe\") and\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    (winlog.event_data.AccessMask : (\"0x1fffff\" , \"0x1010\", \"0x120089\", \"0x1F3FFF\") or\n     winlog.event_data.AccessMaskDescription : (\"READ_CONTROL\", \"Read from process memory\"))\n\n     /* Common Noisy False Positives */\n\n    and not winlog.event_data.ProcessName : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\System32\\\\dllhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\",\n        \"?:\\\\Windows\\\\System32\\\\poqexec.exe\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_lsass_memdump_handle_access.toml"}
{"title": "LSASS Process Access via Windows API", "description": "Identifies access attempts to the LSASS handle, which may indicate an attempt to dump credentials from LSASS memory.", "query": "api where host.os.type == \"windows\" and\n  process.Ext.api.name in (\"OpenProcess\", \"OpenThread\") and Target.process.name : \"lsass.exe\" and \n  not \n  (\n    process.executable : (\n        \"?:\\\\ProgramData\\\\GetSupportService*\\\\Updates\\\\Update_*.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files (x86)\\\\Asiainfo Security\\\\OfficeScan Client\\\\NTRTScan.exe\",\n        \"?:\\\\Program Files (x86)\\\\Blackpoint\\\\SnapAgent\\\\SnapAgent.exe\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Security\\\\EFR\\\\EFRService.exe\",\n        \"?:\\\\Program Files (x86)\\\\CyberCNSAgent\\\\osqueryi.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\vpnagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\aciseagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\cisco\\\\cisco anyconnect secure mobility client\\\\vpndownloader.exe\",\n        \"?:\\\\Program Files (x86)\\\\eScan\\\\reload.exe\",\n        \"?:\\\\Program Files (x86)\\\\Google\\\\Update\\\\GoogleUpdate.exe\",\n        \"?:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\*\\\\avp.exe\",\n        \"?:\\\\Program Files (x86)\\\\microsoft intune management extension\\\\microsoft.management.services.intunewindowsagent.exe\",\n        \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\Reactive\\\\bin\\\\NableReactiveManagement.exe\",\n        \"?:\\\\Program Files (x86)\\\\N-able Technologies\\\\Windows Agent\\\\bin\\\\agent.exe\",\n        \"?:\\\\Program Files (x86)\\\\Tanium\\\\Tanium Client\\\\TaniumClient.exe\",\n        \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*\\\\CCSF\\\\TmCCSF.exe\",\n        \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\TMASutility.exe\",\n        \"?:\\\\Program Files*\\\\Windows Defender\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\EPSecurityService.exe\",\n        \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n        \"?:\\\\Program Files\\\\Common Files\\\\McAfee\\\\AVSolution\\\\mcshield.exe\",\n        \"?:\\\\Program Files\\\\EA\\\\AC\\\\EAAntiCheat.GameService.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\agentbeat.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\metricbeat.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\osqueryd.exe\",\n        \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\packetbeat.exe\",\n        \"?:\\\\Program Files\\\\ESET\\\\ESET Security\\\\ekrn.exe\",\n        \"?:\\\\Program Files\\\\Fortinet\\\\FortiClient\\\\FortiProxy.exe\",\n        \"?:\\\\Program Files\\\\Fortinet\\\\FortiClient\\\\FortiSSLVPNdaemon.exe\",\n        \"?:\\\\Program Files\\\\Goverlan Inc\\\\GoverlanAgent\\\\GovAgentx64.exe\",\n        \"?:\\\\Program Files\\\\Huntress\\\\HuntressAgent.exe\",\n        \"?:\\\\Program Files\\\\LogicMonitor\\\\Agent\\\\bin\\\\sbshutdown.exe\",\n        \"?:\\\\Program Files\\\\Malwarebytes\\\\Anti-Malware\\\\MBAMService.exe\",\n        \"?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\*\\\\pmfexe.exe\", \n        \"?:\\\\Program Files\\\\Microsoft Security Client\\\\MsMpEng.exe\",\n        \"?:\\\\Program Files\\\\Qualys\\\\QualysAgent\\\\QualysAgent.exe\",\n        \"?:\\\\Program Files\\\\smart-x\\\\controlupagent\\\\version*\\\\cuagent.exe\",\n        \"?:\\\\Program Files\\\\TDAgent\\\\ossec-agent\\\\ossec-agent.exe\",\n        \"?:\\\\Program Files\\\\Topaz OFD\\\\Warsaw\\\\core.exe\",\n        \"?:\\\\Program Files\\\\Trend Micro\\\\Deep Security Agent\\\\netagent\\\\tm_netagent.exe\",\n        \"?:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe\",\n        \"?:\\\\Program Files\\\\Windows Defender Advanced Threat Protection\\\\MsSense.exe\",\n        \"?:\\\\Program Files\\\\Wise\\\\Wise Memory Optimizer\\\\WiseMemoryOptimzer.exe\",\n        \"?:\\\\Windows\\\\AdminArsenal\\\\PDQDeployRunner\\\\*\\\\exec\\\\Sysmon64.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"?:\\\\Windows\\\\System32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n        \"?:\\\\Windows\\\\System32\\\\RtkAudUService64.exe\",\n        \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\tenable_mw_scan_142a90001fb65e0beb1751cc8c63edd0.exe\"\n    ) and not ?process.code_signature.trusted == false\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_lsass_openprocess_api.toml"}
{"title": "Potential Machine Account Relay Attack via SMB", "description": "Identifies potential relay attacks against a machine account by identifying network share access events coming from a\nremote source.ip but using the target server computer account. This may indicate a successful SMB relay attack.", "query": "file where event.code == \"5145\" and endswith(user.name, \"$\") and\n\n /* compare computername with user.name and make sure they match */\n startswith~(winlog.computer_name, substring(user.name, 0, -1)) and\n\n /* exclude local access */\n not endswith(string(source.ip), string(host.ip)) and\n source.ip != \"::\" and source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"", "tactic": "Credential Access", "technique": "Forced Authentication", "technique_id": "T1187", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_machine_account_smb_relay.toml"}
{"title": "Mimikatz Memssp Log File Detected", "description": "Identifies the password log file from the default Mimikatz memssp module.", "query": "file where host.os.type == \"windows\" and file.name : \"mimilsa.log\" and process.name : \"lsass.exe\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_mimikatz_memssp_default_logs.toml"}
{"title": "Potential Invoke-Mimikatz PowerShell Script", "description": "Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with many\nother features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShell\nscript and alike.", "query": "event.category:process and host.os.type:windows and\npowershell.file.script_block_text:(\n  (DumpCreds and\n  DumpCerts) or\n  \"sekurlsa::logonpasswords\" or\n  (\"crypto::certificates\" and\n  \"CERT_SYSTEM_STORE_LOCAL_MACHINE\")\n)", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_mimikatz_powershell_module.toml"}
{"title": "Modification of WDigest Security Provider", "description": "Identifies attempts to modify the WDigest security provider in the registry to force the user's password to be stored in\nclear text in memory. This behavior can be indicative of an adversary attempting to weaken the security configuration of\nan endpoint. Once the UseLogonCredential value is modified, the adversary may attempt to dump clear text passwords from\nmemory.", "query": "registry where host.os.type == \"windows\" and event.type == \"creation\" and\n    registry.path : (\n        \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\SecurityProviders\\\\WDigest\\\\UseLogonCredential\"\n    ) and registry.data.strings : (\"1\", \"0x00000001\") and\n    not (process.executable : \"?:\\\\Windows\\\\System32\\\\svchost.exe\" and user.id : \"S-1-5-18\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_mod_wdigest_security_provider.toml"}
{"title": "Windows Registry File Creation in SMB Share", "description": "Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, which\nmay indicate an exfiltration attempt of a previously dumped Security Account Manager (SAM) registry hive for credential\nextraction on an attacker-controlled system.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n /* regf file header */\n file.Ext.header_bytes : \"72656766*\" and file.size >= 30000 and\n process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-1-*\") and\n not file.path : (\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT\",\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT.LASTGOOD.LOAD\",\n    \"?:\\\\*\\\\UPM_Profile\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\UsrClass.dat*\",\n    \"?:\\\\Windows\\\\Netwrix\\\\Temp\\\\????????.???.offreg\",\n    \"?:\\\\*\\\\AppData\\\\Local\\\\Packages\\\\Microsoft.*\\\\Settings\\\\settings.dat*\"\n )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_moving_registry_hive_via_smb.toml"}
{"title": "Network Logon Provider Registry Modification", "description": "Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon\nprovider module for persistence and/or credential access via intercepting the authentication credentials in clear text\nduring user logon.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.data.strings : \"?*\" and registry.value : \"ProviderPath\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\"\n  ) and\n  /* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */\n  not (\n    user.id : \"S-1-5-18\" and\n    registry.data.strings : (\n        \"%SystemRoot%\\\\System32\\\\ntlanman.dll\",\n        \"%SystemRoot%\\\\System32\\\\drprov.dll\",\n        \"%SystemRoot%\\\\System32\\\\davclnt.dll\",\n        \"%SystemRoot%\\\\System32\\\\vmhgfs.dll\",\n        \"?:\\\\Program Files (x86)\\\\Citrix\\\\ICA Client\\\\x64\\\\pnsson.dll\",\n        \"?:\\\\Program Files\\\\Dell\\\\SARemediation\\\\agent\\\\DellMgmtNP.dll\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Connect\\\\\\\\epcgina.dll\"\n    )\n  )", "tactic": "Credential Access", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_persistence_network_logon_provider_modification.toml"}
{"title": "PowerShell Invoke-NinjaCopy script", "description": "Detects PowerShell scripts that contain the default exported functions used on Invoke-NinjaCopy. Attackers can use\nInvoke-NinjaCopy to read SYSTEM files that are normally locked, such as the NTDS.dit file or registry hives.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"StealthReadFile\" or\n    \"StealthReadFileAddr\" or\n    \"StealthCloseFileDelegate\" or\n    \"StealthOpenFile\" or\n    \"StealthCloseFile\" or\n    \"StealthReadFile\" or\n    \"Invoke-NinjaCopy\"\n   )\n  and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_posh_invoke_ninjacopy.toml"}
{"title": "PowerShell Kerberos Ticket Dump", "description": "Detects PowerShell scripts that have the capability of dumping Kerberos tickets from LSA, which potentially indicates an\nattacker's attempt to acquire credentials for lateral movement.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"LsaCallAuthenticationPackage\" and\n    (\n      \"KerbRetrieveEncodedTicketMessage\" or\n      \"KerbQueryTicketCacheMessage\" or\n      \"KerbQueryTicketCacheExMessage\" or\n      \"KerbQueryTicketCacheEx2Message\" or\n      \"KerbRetrieveTicketMessage\" or\n      \"KerbDecryptDataMessage\"\n    )\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_posh_kerb_ticket_dump.toml"}
{"title": "PowerShell MiniDump Script", "description": "This rule detects PowerShell scripts capable of dumping process memory using WindowsErrorReporting or Dbghelp.dll\nMiniDumpWriteDump. Attackers can use this tooling to dump LSASS and get access to credentials.", "query": "event.category:process and host.os.type:windows and powershell.file.script_block_text:(MiniDumpWriteDump or MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id : \"S-1-5-18\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_posh_minidump.toml"}
{"title": "Potential PowerShell Pass-the-Hash/Relay Script", "description": "Detects PowerShell scripts that can execute pass-the-hash (PtH) attacks, intercept and relay NTLM challenges, and carry\nout other man-in-the-middle (MitM) attacks.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\"NTLMSSPNegotiate\" and (\"NegotiateSMB\" or \"NegotiateSMB2\")) or\n    \"4E544C4D53535000\" or\n    \"0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50\" or\n    \"0x4e,0x54,0x20,0x4c,0x4d\" or\n    \"0x53,0x4d,0x42,0x20,0x32\" or\n    \"0x81,0xbb,0x7a,0x36,0x44,0x98,0xf1,0x35,0xad,0x32,0x98,0xf0,0x38\"\n  ) and\n  not file.directory : \"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\"", "tactic": "Credential Access", "technique": "Adversary-in-the-Middle", "technique_id": "T1557", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_posh_relay_tools.toml"}
{"title": "PowerShell Kerberos Ticket Request", "description": "Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step in\nKerberoasting toolkits to crack service accounts.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    KerberosRequestorSecurityToken\n  ) and not user.id : (\"S-1-5-18\" or \"S-1-5-20\") and\n  not powershell.file.script_block_text : (\n    (\"sentinelbreakpoints\" and (\"Set-PSBreakpoint\" or \"Set-HookFunctionTabs\")) or\n    (\"function global\" and \"\\\\windows\\\\sentinel\\\\4\")\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_posh_request_ticket.toml"}
{"title": "Potential Credential Access via DuplicateHandle in LSASS", "description": "Identifies suspicious access to an LSASS handle via DuplicateHandle from an unknown call trace module. This may indicate\nan attempt to bypass the NtOpenProcess API to evade detection and dump LSASS memory for credential access.", "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n\n /* LSASS requesting DuplicateHandle access right to another process */\n process.name : \"lsass.exe\" and winlog.event_data.GrantedAccess == \"0x40\" and\n\n /* call is coming from an unknown executable region */\n winlog.event_data.CallTrace : \"*UNKNOWN*\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_potential_lsa_memdump_via_mirrordump.toml"}
{"title": "Rare Connection to WebDAV Target", "description": "Identifies rare connection attempts to a Web Distributed Authoring and Versioning (WebDAV) resource. Attackers may inject\nWebDAV paths in files or features opened by a victim user to leak their NTLM credentials via forced authentication.", "query": "FROM logs-*\n| where @timestamp > NOW() - 8 hours\n| WHERE event.category == \"process\" and event.type == \"start\" and process.name == \"rundll32.exe\" and process.command_line like \"*DavSetCookie*\"\n| keep host.id, process.command_line, user.name\n| grok process.command_line \"\"\"(?<target>DavSetCookie .* http) \"\"\"| eval webdav_target = REPLACE(target, \"(DavSetCookie | http)\", \"\")\n| where webdav_target is not null and webdav_target rlike \"\"\"(([a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,3}(@SSL.*)*|(\\d{1,3}\\.){3}\\d{1,3})\"\"\" and not webdav_target in (\"www.google.com@SSL\", \"www.elastic.co@SSL\") and not webdav_target rlike \"\"\"(10\\.(\\d{1,3}\\.){2}\\d{1,3}|172\\.(1[6-9]|2\\d|3[0-1])\\.(\\d{1,3}\\.)\\d{1,3}|192\\.168\\.(\\d{1,3}\\.)\\d{1,3}) \"\"\"| stats total = count(*), unique_count_host = count_distinct(host.id), hosts = VALUES(host.id), users = VALUES(user.name) by webdav_target\n| where unique_count_host == 1 and total <= 3", "tactic": "Credential Access", "technique": "Forced Authentication", "technique_id": "T1187", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_rare_webdav_destination.toml"}
{"title": "Sensitive Registry Hive Access via RegBack", "description": "Identifies attempts to access sensitive registry hives which contain credentials from the registry backup folder.", "query": "file where host.os.type == \"windows\" and\n event.action == \"open\" and event.outcome == \"success\" and process.executable != null and \n file.path :\n      (\"?:\\\\Windows\\\\System32\\\\config\\\\RegBack\\\\SAM\",\n       \"?:\\\\Windows\\\\System32\\\\config\\\\RegBack\\\\SECURITY\",\n       \"?:\\\\Windows\\\\System32\\\\config\\\\RegBack\\\\SYSTEM\") and \n not (\n    user.id == \"S-1-5-18\" and process.executable : (\n        \"?:\\\\Windows\\\\system32\\\\taskhostw.exe\", \"?:\\\\Windows\\\\system32\\\\taskhost.exe\"\n    ))", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_regback_sam_security_hives.toml"}
{"title": "Potential Local NTLM Relay via HTTP", "description": "Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target.\nAn adversary may use this primitive in combination with other techniques to elevate privileges on a compromised system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"rundll32.exe\" and\n\n  /* Rundll32 WbeDav Client  */\n  process.args : (\"?:\\\\Windows\\\\System32\\\\davclnt.dll,DavSetCookie\", \"?:\\\\Windows\\\\SysWOW64\\\\davclnt.dll,DavSetCookie\") and\n\n  /* Access to named pipe via http */\n  process.args : (\"http*/print/pipe/*\", \"http*/pipe/spoolss\", \"http*/pipe/srvsvc\")", "tactic": "Credential Access", "technique": "Exploitation for Credential Access", "technique_id": "T1212", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_relay_ntlm_auth_via_http_spoolss.toml"}
{"title": "Potential Remote Credential Access via Registry", "description": "Identifies remote access to the registry to potentially dump credential data from the Security Account Manager (SAM)\nregistry hive in preparation for credential access and privileges elevation.", "query": "file where host.os.type == \"windows\" and\n  event.action == \"creation\" and process.name : \"svchost.exe\" and\n  file.Ext.header_bytes : \"72656766*\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and file.size >= 30000 and\n  file.path : (\"?:\\\\Windows\\\\system32\\\\*.tmp\", \"?:\\\\WINDOWS\\\\Temp\\\\*.tmp\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_remote_sam_secretsdump.toml"}
{"title": "Searching for Saved Credentials via VaultCmd", "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected\napplications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for\nsaved usernames and passwords. This may also be performed in preparation of lateral movement.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name:\"vaultcmd.exe\" or process.name:\"vaultcmd.exe\") and\n  process.args:\"/list*\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_saved_creds_vaultcmd.toml"}
{"title": "Multiple Vault Web Credentials Read", "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected\napplications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for\nsaved usernames and passwords. This may also be performed in preparation of lateral movement.", "query": "sequence by winlog.computer_name, winlog.process.pid with maxspan=1s\n\n /* 2 consecutive vault reads from same pid for web creds */\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n  not winlog.event_data.Resource : \"http://localhost/\"]\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n  not winlog.event_data.Resource : \"http://localhost/\"]", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_saved_creds_vault_winlog.toml"}
{"title": "Sensitive Privilege SeEnableDelegationPrivilege assigned to a User", "description": "Identifies the assignment of the SeEnableDelegationPrivilege sensitive \"user right\" to a user. The\nSeEnableDelegationPrivilege \"user right\" enables computer and user accounts to be trusted for delegation. Attackers can\nabuse this right to compromise Active Directory accounts and elevate their privileges.", "query": "event.code:4704 and winlog.event_data.PrivilegeList:\"SeEnableDelegationPrivilege\"", "tactic": "Credential Access", "technique": "Steal or Forge Kerberos Tickets", "technique_id": "T1558", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_seenabledelegationprivilege_assigned_to_user.toml"}
{"title": "Potential Shadow Credentials added to AD Object", "description": "Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object.\nAttackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtain\npersistent and stealthy access to the target user or computer object.", "query": "event.code:\"5136\" and winlog.event_data.AttributeLDAPDisplayName:\"msDS-KeyCredentialLink\" and\n  winlog.event_data.AttributeValue :B\\:828* and\n  not winlog.event_data.SubjectUserName: MSOL_*", "tactic": "Credential Access", "technique": "Modify Authentication Process", "technique_id": "T1556", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_shadow_credentials.toml"}
{"title": "User account exposed to Kerberoasting", "description": "Detects when a user account has the servicePrincipalName attribute modified. Attackers can abuse write privileges over a\nuser to configure Service Principle Names (SPNs) so that they can perform Kerberoasting. Administrators can also\nconfigure this for legitimate purposes, exposing the account to Kerberoasting.", "query": "event.code:5136 and winlog.event_data.OperationType:\"%%14674\" and\n  winlog.event_data.ObjectClass:\"user\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"servicePrincipalName\"", "tactic": "Credential Access", "technique": "Steal or Forge Kerberos Tickets", "technique_id": "T1558", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_spn_attribute_modified.toml"}
{"title": "Potential Credential Access via Renamed COM+ Services DLL", "description": "Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump a\nprocess memory. This may indicate an attempt to dump LSASS memory while bypassing command-line based detection in\npreparation for credential access.", "query": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.category == \"process\" and\n    process.name : \"rundll32.exe\"]\n [process where host.os.type == \"windows\" and event.category == \"process\" and event.dataset : \"windows.sysmon_operational\" and event.code == \"7\" and\n   (file.pe.original_file_name : \"COMSVCS.DLL\" or file.pe.imphash : \"EADBCCBB324829ACB5F2BBE87E5549A8\") and\n    /* renamed COMSVCS */\n    not file.name : \"COMSVCS.DLL\"]", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_suspicious_comsvcs_imageload.toml"}
{"title": "Suspicious Lsass Process Access", "description": "Identifies access attempts to LSASS handle, this may indicate an attempt to dump credentials from Lsass memory.", "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n  not winlog.event_data.GrantedAccess :\n                (\"0x1000\", \"0x1400\", \"0x101400\", \"0x101000\", \"0x101001\", \"0x100000\", \"0x100040\", \"0x3200\", \"0x40\", \"0x3200\") and\n  not process.name : (\"procexp64.exe\", \"procmon.exe\", \"procexp.exe\", \"Microsoft.Identity.AadConnect.Health.AadSync.Host.ex\") and\n  not process.executable : (\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\platform\\\\*\",\n        \"?:\\\\ProgramData\\\\WebEx\\\\webex\\\\*\",\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n        \"?:\\\\Windows\\\\LTSvc\\\\LTSVC.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"C:\\\\Windows\\\\CynetMS.exe\",\n        \"?:\\\\Windows\\\\system32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsm.exe\",\n        \"?:\\\\Windows\\\\system32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\wmiprvse.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wininit.exe\",\n        \"?:\\\\Windows\\\\SystemTemp\\\\GUM*.tmp\\\\GoogleUpdate.exe\",\n        \"?:\\\\Windows\\\\sysWOW64\\\\wbem\\\\wmiprvse.exe\",\n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlplus.exe\",\n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlldr.exe\",\n        \"d:\\\\oracle\\\\product\\\\19\\\\dbhome1\\\\bin\\\\ORACLE.EXE\",\n        \"C:\\\\wamp\\\\bin\\\\apache\\\\apache*\\\\bin\\\\httpd.exe\",\n        \"C:\\\\Windows\\\\system32\\\\netstat.exe\",\n        \"C:\\\\PROGRA~1\\\\INFORM~1\\\\apps\\\\jdk\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"C:\\\\PROGRA~2\\\\CyberCNSAgentV2\\\\osqueryi.exe\",\n        \"C:\\\\Utilityw2k19\\\\packetbeat\\\\packetbeat.exe\",\n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco AnyConnect Secure Mobility Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\",\n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco Secure Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\"\n  ) and\n  not winlog.event_data.CallTrace : (\"*mpengine.dll*\", \"*appresolver.dll*\", \"*sysmain.dll*\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_suspicious_lsass_access_generic.toml"}
{"title": "Potential Credential Access via LSASS Memory Dump", "description": "Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export\nthe MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access.", "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/\n  winlog.event_data.CallTrace : (\"*dbghelp*\", \"*dbgcore*\") and\n\n   /* case of lsass crashing */\n  not process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n      )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_suspicious_lsass_access_memdump.toml"}
{"title": "Potential LSASS Memory Dump via PssCaptureSnapShot", "description": "Identifies suspicious access to an LSASS handle via PssCaptureSnapShot where two successive process accesses are\nperformed by the same process and target two different instances of LSASS. This may indicate an attempt to evade\ndetection and dump LSASS memory for credential access.", "query": "event.category:process and host.os.type:windows and event.code:10 and\n winlog.event_data.TargetImage:(\"C:\\\\Windows\\\\system32\\\\lsass.exe\" or\n                                 \"c:\\\\Windows\\\\system32\\\\lsass.exe\" or\n                                 \"c:\\\\Windows\\\\System32\\\\lsass.exe\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_suspicious_lsass_access_via_snapshot.toml"}
{"title": "Suspicious Remote Registry Access via SeBackupPrivilege", "description": "Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an\nattempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for\ncredential access and privileges elevation.", "query": "sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m\n [iam where event.action == \"logged-in-special\"  and\n  winlog.event_data.PrivilegeList : \"SeBackupPrivilege\" and\n\n  /* excluding accounts with existing privileged access */\n  not winlog.event_data.PrivilegeList : \"SeDebugPrivilege\"]\n [any where event.code == \"5145\" and winlog.event_data.RelativeTargetName : \"winreg\"]", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_suspicious_winreg_access_via_sebackup_priv.toml"}
{"title": "Symbolic Link to Shadow Copy Created", "description": "Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadow\ncopy, including sensitive files such as ntds.dit, System Boot Key and browser offline credentials.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (\n    (?process.pe.original_file_name in (\"Cmd.Exe\",\"PowerShell.EXE\")) or\n    (process.name : (\"cmd.exe\", \"powershell.exe\"))\n ) and\n\n /* Create Symbolic Link to Shadow Copies */\n process.args : (\"*mklink*\", \"*SymbolicLink*\") and process.command_line : (\"*HarddiskVolumeShadowCopy*\")", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_symbolic_link_to_shadow_copy_created.toml"}
{"title": "Veeam Backup Library Loaded by Unusual Process", "description": "Identifies potential credential decrypt operations by PowerShell or unsigned processes using the Veeam.Backup.Common.dll\nlibrary. Attackers can use Veeam Credentials to target backups as part of destructive operations such as Ransomware\nattacks.", "query": "library where host.os.type == \"windows\" and event.action == \"load\" and\n  (dll.name : \"Veeam.Backup.Common.dll\" or dll.pe.original_file_name : \"Veeam.Backup.Common.dll\") and\n  (\n    process.code_signature.trusted == false or\n    process.code_signature.exists == false or\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")\n  )", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_veeam_backup_dll_imageload.toml"}
{"title": "Potential Veeam Credential Access Command", "description": "Identifies commands that can access and decrypt Veeam credentials stored in MSSQL databases. Attackers can use Veeam\nCredentials to target backups as part of destructive operations such as Ransomware attacks.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    (process.name : \"sqlcmd.exe\" or ?process.pe.original_file_name : \"sqlcmd.exe\") or\n    process.args : (\"Invoke-Sqlcmd\", \"Invoke-SqlExecute\", \"Invoke-DbaQuery\", \"Invoke-SqlQuery\")\n  ) and\n  process.args : \"*[VeeamBackup].[dbo].[Credentials]*\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_veeam_commands.toml"}
{"title": "Potential LSASS Clone Creation via PssCaptureSnapShot", "description": "Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS\nprocess instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.", "query": "process where host.os.type == \"windows\" and event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_via_snapshot_lsass_clone_creation.toml"}
{"title": "NTDS Dump via Wbadmin", "description": "Identifies the execution of wbadmin to access the NTDS.dit file in a domain controller. Attackers with privileges from\ngroups like Backup Operators can abuse the utility to perform credential access and compromise the domain.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name : \"wbadmin.exe\") and\n     process.args : \"recovery\" and process.command_line : \"*ntds.dit*\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_wbadmin_ntds.toml"}
{"title": "Wireless Credential Dumping using Netsh Command", "description": "Identifies attempts to dump Wireless saved access keys in clear text using the Windows built-in utility Netsh.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"netsh.exe\" or ?process.pe.original_file_name == \"netsh.exe\") and\n  process.args : \"wlan\" and process.args : \"key*clear\"", "tactic": "Credential Access", "technique": "OS Credential Dumping", "technique_id": "T1003", "risk_score": "N/A", "tags": [], "references": [], "file": "credential_access_wireless_creds_dumping.toml"}
{"title": "Adding Hidden File Attribute via Attrib", "description": "Adversaries can add the 'hidden' attribute to files to hide them from the user in an attempt to evade detection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"attrib.exe\" or ?process.pe.original_file_name == \"ATTRIB.EXE\") and process.args : \"+h\" and\n  not (process.parent.name: \"cmd.exe\" and process.command_line: \"attrib  +R +H +S +A *.cui\")", "tactic": "Defense Evasion", "technique": "File and Directory Permissions Modification", "technique_id": "T1222", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_adding_the_hidden_file_attribute_with_via_attribexe.toml"}
{"title": "Modification of AmsiEnable Registry Key", "description": "Identifies modifications of the AmsiEnable registry key to 0, which disables the Antimalware Scan Interface (AMSI). An\nadversary can modify this key to disable AMSI protections.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"AmsiEnable\" and registry.data.strings: (\"0\", \"0x00000000\")\n\n  /*\n    Full registry key path omitted due to data source variations:\n    HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows Script\\\\Settings\\\\AmsiEnable\"\n  */", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_amsienable_key_mod.toml"}
{"title": "Suspicious Antimalware Scan Interface DLL", "description": "Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate an\nattempt to bypass AMSI by loading a rogue AMSI module instead of the legit one.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.path != null and\n  file.name : (\"amsi.dll\", \"amsi\") and\n  not file.path : (\n    \"?:\\\\$SysReset\\\\CloudImage\\\\Package_for_RollupFix*\",\n    \"?:\\\\Windows\\\\system32\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\Syswow64\\\\amsi.dll\",\n    \"?:\\\\$WINDOWS.~BT\\\\DUImageSandbox\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSXS\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\servicing\\\\LCU\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\Store\\\\Offline\\\\File\\\\C$\\\\Windows\\\\SoftwareDistribution\\\\Download.bak\\\\*\",\n    \"?:\\\\Windows\\\\CbsTemp\\\\*\\\\f\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\",\n    \"?:\\\\Windows\\\\WinSxS\\\\amd64_microsoft-antimalware-scan-interface_*\\\\amsi.dll\"\n  ) and\n  not\n  (\n    process.executable : \"C:\\\\Windows\\\\System32\\\\wbengine.exe\" and\n    file.path : (\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\system32\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\syswow64\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\",\n      \"\\\\\\\\?\\\\Volume{*}\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\",\n      \"\\\\\\\\?\\\\Volume{*}\\\\Windows\\\\system32\\\\amsi.dll\",\n      \"\\\\\\\\?\\\\Volume{*}\\\\Windows\\\\syswow64\\\\amsi.dll\"\n    )\n  )", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_amsi_bypass_dllhijack.toml"}
{"title": "Sensitive Audit Policy Sub-Category Disabled", "description": "Identifies attempts to disable auditing for some security sensitive audit policy sub-categories. This is often done by\nattackers in an attempt to evade detection and forensics on a system.", "query": "event.code : \"4719\" and host.os.type : \"windows\" and\n  winlog.event_data.AuditPolicyChangesDescription : \"Success removed\" and\n  winlog.event_data.SubCategory : (\n     \"Logon\" or\n     \"Audit Policy Change\" or\n     \"Process Creation\" or\n     \"Audit Other System Events\" or\n     \"Audit Security Group Management\" or\n     \"Audit User Account Management\"\n  )", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_audit_policy_disabled_winlog.toml"}
{"title": "Clearing Windows Console History", "description": "Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised\naccount to conceal the actions undertaken during an intrusion.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  (\n    process.args : \"*Clear-History*\" or\n    (process.args : (\"*Remove-Item*\", \"rm\") and process.args : (\"*ConsoleHost_history.txt*\", \"*(Get-PSReadlineOption).HistorySavePath*\")) or\n    (process.args : \"*Set-PSReadlineOption*\" and process.args : \"*SaveNothing*\")\n  )", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_clearing_windows_console_history.toml"}
{"title": "Clearing Windows Event Logs", "description": "Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done by\nattackers in an attempt to evade detection or destroy forensic evidence on a system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name : \"wevtutil.exe\" or ?process.pe.original_file_name == \"wevtutil.exe\") and\n    process.args : (\"/e:false\", \"cl\", \"clear-log\")\n  ) or\n  (\n    (\n      process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n    ) and\n    process.args : \"Clear-EventLog\"\n  )\n)", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_clearing_windows_event_logs.toml"}
{"title": "Windows Event Logs Cleared", "description": "Identifies attempts to clear Windows event log stores. This is often done by attackers in an attempt to evade detection\nor destroy forensic evidence on a system.", "query": "host.os.type:windows and event.action:(\"audit-log-cleared\" or \"Log clear\") and\n  not winlog.provider_name:\"AD FS Auditing\"", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_clearing_windows_security_logs.toml"}
{"title": "Code Signing Policy Modification Through Built-in tools", "description": "Identifies attempts to disable/modify the code signing policy through system native utilities. Code signing provides\nauthenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By\nallowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name: \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and process.args: (\"-set\", \"/set\") and \n  process.args: (\"TESTSIGNING\", \"nointegritychecks\", \"loadoptions\", \"DISABLE_INTEGRITY_CHECKS\")", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_code_signing_policy_modification_builtin_tools.toml"}
{"title": "Code Signing Policy Modification Through Registry", "description": "Identifies attempts to disable the code signing policy through the registry. Code signing provides authenticity on a\nprogram, and grants the user with the ability to check whether the program has been tampered with. By allowing the\nexecution of unsigned or self-signed code, threat actors can craft and execute malicious code.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value: \"BehaviorOnFailedVerify\" and registry.data.strings : (\"0\", \"0x00000000\", \"1\", \"0x00000001\")\n\n  /*\n    Full registry key path omitted due to data source variations:\n    \"HKEY_USERS\\\\*\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Driver Signing\\\\BehaviorOnFailedVerify\"\n  */", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_code_signing_policy_modification_registry.toml"}
{"title": "Suspicious Communication App Child Process", "description": "Identifies suspicious child processes of communications apps, which can indicate a potential masquerading as the\ncommunication app or the exploitation of a vulnerability on the application causing it to execute code.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    /* Slack */\n    (process.parent.name : \"slack.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Zoom\\\\bin*\\\\Zoom.exe\",\n            \"?:\\\\Windows\\\\System32\\\\rundll32.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Windows\\\\System32\\\\notepad.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Slack Technologies, Inc.\",\n            \"Slack Technologies, LLC\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"powershell.exe\" and process.command_line : \"powershell.exe -c Invoke-WebRequest -Uri https://slackb.com/*\") or\n          (process.name : \"cmd.exe\" and process.command_line : \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /d /s /c \\\"%windir%\\\\System32\\\\rundll32.exe User32.dll,SetFocus 0\\\"\")\n        )\n      )\n    ) or\n\n    /* WebEx */\n    (process.parent.name : (\"CiscoCollabHost.exe\", \"WebexHost.exe\") and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Cisco Systems, Inc.\",\n            \"Cisco WebEx LLC\",\n            \"Cisco Systems Inc.\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Teams */\n    (process.parent.name : \"Teams.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\BrowserCore\\\\BrowserCore.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Microsoft Corporation\",\n            \"Microsoft 3rd Party Application Component\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"taskkill.exe\" and process.args : \"Teams.exe\")\n        )\n      )\n    ) or\n\n    /* Discord */\n    (process.parent.name : \"Discord.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Windows\\\\System32\\\\reg.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\reg.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Discord Inc.\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.name : \"cmd.exe\" and\n          (\n            process.command_line : (\n              \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /d /s /c \\\"chcp\\\"\",\n              \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe /q /d /s /c \\\"C:\\\\Program^ Files\\\\NVIDIA^ Corporation\\\\NVSMI\\\\nvidia-smi.exe\\\"\"\"            ) or\n            process.args : (\n              \"C:\\\\WINDOWS/System32/nvidia-smi.exe\",\n              \"C:\\\\WINDOWS\\\\System32\\\\nvidia-smi.exe\",\n              \"C:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository/*/nvidia-smi.exe*\"\n            )\n          )\n        )\n      )\n    ) or\n\n    /* WhatsApp */\n    (process.parent.name : \"Whatsapp.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\System32\\\\reg.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\reg.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"WhatsApp LLC\",\n            \"WhatsApp, Inc\",\n            \"24803D75-212C-471A-BC57-9EF86AB91435\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          (process.name : \"cmd.exe\" and process.command_line : \"C:\\\\Windows\\\\system32\\\\cmd.exe /d /s /c \\\"C:\\\\Windows\\\\system32\\\\wbem\\\\wmic.exe*\")\n        )\n      )\n    ) or\n\n    /* Zoom */\n    (process.parent.name : \"Zoom.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Island\\\\Island\\\\Application\\\\Island.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Zoom Video Communications, Inc.\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Thunderbird */\n    (process.parent.name : \"thunderbird.exe\" and not\n      (\n        (\n          process.executable : (\n            \"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n            \"?:\\\\Windows\\\\splwow64.exe\"\n          ) and process.code_signature.trusted == true\n        ) or\n        (\n          process.code_signature.subject_name : (\n            \"Mozilla Corporation\"\n          ) and process.code_signature.trusted == true\n        )\n      )\n    )\n  )", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_communication_apps_suspicious_child_process.toml"}
{"title": "Creation or Modification of Root Certificate", "description": "Identifies the creation or modification of a local trusted root certificate in Windows. The install of a malicious root\ncertificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity\n(for example, Microsoft). It could also allow an attacker to decrypt SSL traffic.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Blob\" and\n  registry.path :\n    (\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\"\n    ) and\n  not process.executable : (\n          \"?:\\\\ProgramData\\\\Lenovo\\\\Vantage\\\\Addins\\\\LenovoHardwareScanAddin\\\\*\\\\LdeApi.Server.exe\",\n          \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\64\\\\certmgr.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MpDefenderCoreService.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n          \"?:\\\\ProgramData\\\\Quest\\\\KACE\\\\modules\\\\clientidentifier\\\\clientidentifier.exe\",\n          \"?:\\\\ProgramData\\\\Sophos\\\\AutoUpdate\\\\Cache\\\\sophos_autoupdate1.dir\\\\SophosUpdate.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n          \"?:\\\\Windows\\\\ccmsetup\\\\cache\\\\ccmsetup.exe\",\n          \"?:\\\\Windows\\\\Cluster\\\\clussvc.exe\",\n          \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe\",\n          \"?:\\\\Windows\\\\Lenovo\\\\ImController\\\\PluginHost86\\\\Lenovo.Modern.ImController.PluginHost.Device.exe\",\n          \"?:\\\\Windows\\\\Lenovo\\\\ImController\\\\Service\\\\Lenovo.Modern.ImController.exe\",\n          \"?:\\\\Windows\\\\Sysmon.exe\",\n          \"?:\\\\Windows\\\\Sysmon64.exe\",\n          \"?:\\\\Windows\\\\System32\\\\*.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*.exe\"\n  )", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_create_mod_root_certificate.toml"}
{"title": "Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall)", "description": "A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC)\ncertificates. An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign a\nmalicious executable, making it appear the file was from a trusted, legitimate source.", "query": "event.provider:\"Microsoft-Windows-Audit-CVE\" and message:\"[CVE-2020-0601]\" and host.os.type:windows", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_cve_2020_0601.toml"}
{"title": "Windows Defender Disabled via Registry Modification", "description": "Identifies modifications to the Windows Defender registry settings to disable the service or set the service to be\nstarted manually.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  (\n    (\n      registry.path: (\n        \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\"\n      ) and\n      registry.data.strings: (\"1\", \"0x00000001\")\n   ) or\n   (\n      registry.path: (\n        \"HKLM\\\\System\\\\*ControlSet*\\\\Services\\\\WinDefend\\\\Start\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\System\\\\*ControlSet*\\\\Services\\\\WinDefend\\\\Start\"\n      ) and\n      registry.data.strings in (\"3\", \"4\", \"0x00000003\", \"0x00000004\")\n   )\n  ) and\n\n  not\n    (\n      process.executable : (\n          \"?:\\\\WINDOWS\\\\system32\\\\services.exe\",\n          \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n          \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\NTRmv.exe\"\n      ) and user.id : \"S-1-5-18\"\n    )", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_defender_disabled_via_registry.toml"}
{"title": "Windows Defender Exclusions Added via PowerShell", "description": "Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folder\ndirectory or process level.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")) and\n  process.args : (\"*Add-MpPreference*\", \"*Set-MpPreference*\") and\n  process.args : (\"*-Exclusion*\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_defender_exclusion_via_powershell.toml"}
{"title": "Delete Volume USN Journal with Fsutil", "description": "Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidence\nof files created during post-exploitation activities.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"deletejournal\" and process.args : \"usn\"", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_delete_volume_usn_journal_with_fsutil.toml"}
{"title": "Network-Level Authentication (NLA) Disabled", "description": "Identifies the attempt to disable Network-Level Authentication (NLA) via registry modification. Network Level\nAuthentication (NLA) is a feature on Windows that provides an extra layer of security for Remote Desktop (RDP)\nconnections, as it requires users to authenticate before allowing a full RDP session. Attackers can disable NLA to\nenable persistence methods that require access to the Windows sign-in screen without authenticating, such as\nAccessibility Features persistence methods, like Sticky Keys.", "query": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and registry.value : \"UserAuthentication\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\UserAuthentication\"\n  ) and registry.data.strings :  (\"0\", \"0x00000000\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disable_nla.toml"}
{"title": "PowerShell Script Block Logging Disabled", "description": "Identifies attempts to disable PowerShell Script Block Logging via registry modification. Attackers may disable this\nlogging to conceal their activities in the host and evade detection.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\",\n        \"MACHINE\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\PowerShell\\\\ScriptBlockLogging\\\\EnableScriptBlockLogging\"\n    ) and registry.data.strings : (\"0\", \"0x00000000\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disable_posh_scriptblocklogging.toml"}
{"title": "Disable Windows Firewall Rules via Netsh", "description": "Identifies use of the netsh.exe to disable or weaken the local firewall. Attackers will use this command line tool to\ndisable the firewall during troubleshooting or to enable network mobility.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"netsh.exe\" and\n  (\n    (process.args : \"disable\" and process.args : \"firewall\" and process.args : \"set\") or\n    (process.args : \"advfirewall\" and process.args : \"off\" and process.args : \"state\")\n  )", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disable_windows_firewall_rules_with_netsh.toml"}
{"title": "Disabling Windows Defender Security Settings via PowerShell", "description": "Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  process.args : \"Set-MpPreference\" and process.args : (\"-Disable*\", \"Disabled\", \"NeverSend\", \"-Exclusion*\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disabling_windows_defender_powershell.toml"}
{"title": "Disable Windows Event and Security Logs Using Built-in Tools", "description": "Identifies attempts to disable EventLog via the logman Windows utility, PowerShell, or auditpol. This is often done by\nattackers in an attempt to evade detection on a system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name:\"logman.exe\" or ?process.pe.original_file_name == \"Logman.exe\") and\n    process.args : \"EventLog-*\" and process.args : (\"stop\", \"delete\")\n  ) or\n  (\n    (\n      process.name : (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\")\n    ) and\n\t  process.args : \"Set-Service\" and process.args: \"EventLog\" and process.args : \"Disabled\"\n  )  or\n  (\n    (process.name:\"auditpol.exe\" or ?process.pe.original_file_name == \"AUDITPOL.EXE\") and process.args : \"/success:disable\"\n  )\n)", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_disabling_windows_logs.toml"}
{"title": "DNS-over-HTTPS Enabled via Registry", "description": "Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltrating\ndata. With this enabled, an organization will lose visibility into data such as query type, response, and originating\nIP, which are used to determine bad actors.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Edge\\\\BuiltInDnsClientEnabled\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"*\\\\SOFTWARE\\\\Google\\\\Chrome\\\\DnsOverHttpsMode\" and\n  registry.data.strings : \"secure\") or\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Mozilla\\\\Firefox\\\\DNSOverHTTPS\" and\n  registry.data.strings : (\"1\", \"0x00000001\"))", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_dns_over_https_enabled.toml"}
{"title": "Suspicious .NET Code Compilation", "description": "Identifies executions of .NET compilers with suspicious parent processes, which can indicate an attacker's attempt to\ncompile code after delivery in order to bypass security mechanisms.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"csc.exe\", \"vbc.exe\") and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\", \"cscript.exe\", \"wmic.exe\", \"svchost.exe\", \"rundll32.exe\", \"cmstp.exe\", \"regsvr32.exe\")", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_dotnet_compiler_parent_process.toml"}
{"title": "Remote Desktop Enabled in Windows Firewall by Netsh", "description": "Identifies use of the network shell utility (netsh.exe) to enable inbound Remote Desktop Protocol (RDP) connections in\nthe Windows Firewall.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"netsh.exe\" or ?process.pe.original_file_name == \"netsh.exe\") and\n process.args : (\"localport=3389\", \"RemoteDesktop\", \"group=\\\"remote desktop\\\"\") and\n process.args : (\"action=allow\", \"enable=Yes\", \"enable\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_enable_inbound_rdp_with_netsh.toml"}
{"title": "Enable Host Network Discovery via Netsh", "description": "Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-line\ntool to weaken the host firewall settings.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.name : \"netsh.exe\" and\nprocess.args : (\"firewall\", \"advfirewall\") and process.args : \"group=Network Discovery\" and process.args : \"enable=Yes\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_enable_network_discovery_with_netsh.toml"}
{"title": "Control Panel Process with Unusual Arguments", "description": "Identifies unusual instances of Control Panel with suspicious keywords or paths in the process command line value.\nAdversaries may abuse control.exe to proxy execution of malicious code.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and\n  process.command_line : (\n    \"*.jpg*\", \"*.png*\",\n    \"*.gif*\", \"*.bmp*\",\n    \"*.jpeg*\", \"*.TIFF*\",\n    \"*.inf*\", \"*.cpl:*/*\",\n    \"*../../..*\",\n    \"*/AppData/Local/*\",\n    \"*:\\\\Users\\\\Public\\\\*\",\n    \"*\\\\AppData\\\\Local\\\\*\"\n)", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_control_panel_suspicious_args.toml"}
{"title": "ImageLoad via Windows Update Auto Update Client", "description": "Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is used\nas a defense evasion technique to blend-in malicious activity with legitimate Windows software.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name == \"wuauclt.exe\" or process.name : \"wuauclt.exe\") and\n   /* necessary windows update client args to load a dll */\n   process.args : \"/RunHandlerComServer\" and process.args : \"/UpdateDeploymentProvider\" and\n   /* common paths writeable by a standard user where the target DLL can be placed */\n   process.args : (\"C:\\\\Users\\\\*.dll\", \"C:\\\\ProgramData\\\\*.dll\", \"C:\\\\Windows\\\\Temp\\\\*.dll\", \"C:\\\\Windows\\\\Tasks\\\\*.dll\")", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_lolbas_wuauclt.toml"}
{"title": "Microsoft Build Engine Started by an Office Application", "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the Build\nEngine and could have been caused by an Excel or Word document executing a malicious script payload.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"eqnedt32.exe\",\n                         \"excel.exe\",\n                         \"fltldr.exe\",\n                         \"msaccess.exe\",\n                         \"mspub.exe\",\n                         \"outlook.exe\",\n                         \"powerpnt.exe\",\n                         \"winword.exe\" )", "tactic": "Defense Evasion", "technique": "Trusted Developer Utilities Proxy Execution", "technique_id": "T1127", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_msbuild_started_by_office_app.toml"}
{"title": "Microsoft Build Engine Started by a Script Process", "description": "An instance of MSBuild, the Microsoft Build Engine, was started by a script or the Windows command interpreter. This\nbehavior is unusual and is sometimes used by malicious payloads.", "query": "host.os.type:windows and event.category:process and event.type:start and (\n  process.name.caseless:\"msbuild.exe\" or process.pe.original_file_name:\"MSBuild.exe\") and\n  process.parent.name:(\"cmd.exe\" or \"powershell.exe\" or \"pwsh.exe\" or \"powershell_ise.exe\" or \"cscript.exe\" or\n    \"wscript.exe\" or \"mshta.exe\")", "tactic": "Defense Evasion", "technique": "Trusted Developer Utilities Proxy Execution", "technique_id": "T1127", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_msbuild_started_by_script.toml"}
{"title": "Microsoft Build Engine Started by a System Process", "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management\nInstrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"explorer.exe\", \"wmiprvse.exe\")", "tactic": "Defense Evasion", "technique": "Trusted Developer Utilities Proxy Execution", "technique_id": "T1127", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_msbuild_started_by_system_process.toml"}
{"title": "Microsoft Build Engine Using an Alternate Name", "description": "An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and may\nindicate an attempt to run unnoticed or undetected.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name == \"MSBuild.exe\" and\n  not process.name : \"MSBuild.exe\"", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_msbuild_started_renamed.toml"}
{"title": "Microsoft Build Engine Started an Unusual Process", "description": "An instance of MSBuild, the Microsoft Build Engine, started a PowerShell script or the Visual C# Command Line Compiler.\nThis technique is sometimes used to deploy a malicious payload using the Build Engine.", "query": "host.os.type:windows and event.category:process and event.type:start and process.parent.name:(\"MSBuild.exe\" or \"msbuild.exe\") and\nprocess.name:(\"csc.exe\" or \"iexplore.exe\" or \"powershell.exe\")", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_msbuild_started_unusal_process.toml"}
{"title": "Potential DLL Side-Loading via Trusted Microsoft Programs", "description": "Identifies an instance of a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking\nstarting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade\ndefenses via side loading a malicious DLL within the memory space of one of those processes.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name in (\"WinWord.exe\", \"EXPLORER.EXE\", \"w3wp.exe\", \"DISM.EXE\") and \n  not process.executable : (\"?:\\\\Windows\\\\explorer.exe\", \n                            \"?:\\\\Windows\\\\SysWOW64\\\\explorer.exe\",\n                            \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\WINWORD.EXE\", \n                            \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\Office*\\\\WINWORD.EXE\", \n                            \"?:\\\\Windows\\\\System32\\\\Dism.exe\", \n                            \"?:\\\\Windows\\\\SysWOW64\\\\Dism.exe\",  \n                            \"?:\\\\Program Files (x86)\\\\Windows Kits\\\\10\\\\Assessment and Deployment Kit\\\\Deployment Tools\\\\amd64\\\\DISM\\\\dism.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\", \n                            \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_suspicious_explorer_winword.toml"}
{"title": "Potential DLL Side-Loading via Microsoft Antimalware Service Executable", "description": "Identifies a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after being\nrenamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses via\nside-loading a malicious DLL within the memory space of one of those processes.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.pe.original_file_name == \"MsMpEng.exe\" and not process.name : \"MsMpEng.exe\") or\n  (process.name : \"MsMpEng.exe\" and not\n        process.executable : (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n                              \"?:\\\\Program Files\\\\Windows Defender\\\\*.exe\",\n                              \"?:\\\\Program Files (x86)\\\\Windows Defender\\\\*.exe\",\n                              \"?:\\\\Program Files\\\\Microsoft Security Client\\\\*.exe\",\n                              \"?:\\\\Program Files (x86)\\\\Microsoft Security Client\\\\*.exe\"))\n)", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_execution_windefend_unusual_path.toml"}
{"title": "Executable File Creation with Multiple Extensions", "description": "Masquerading can allow an adversary to evade defenses and better blend in with the environment. One way it occurs is\nwhen the name or location of a file is manipulated as a means of tricking a user into executing what they think is a\nbenign file type but is actually executable code.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"exe\" and\n  file.name regex~ \"\"\".*\\.(vbs|vbe|bat|js|cmd|wsh|ps1|pdf|docx?|xlsx?|pptx?|txt|rtf|gif|jpg|png|bmp|hta|txt|img|iso)\\.exe\"\"\" and\n  not (process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"C:\\\\Users\\\\*\\\\QGIS_SCCM\\\\Files\\\\QGIS-OSGeo4W-*-Setup-x86_64.exe\") and\n       file.path : \"?:\\\\Program Files\\\\QGIS *\\\\apps\\\\grass\\\\*.exe\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_file_creation_mult_extension.toml"}
{"title": "Process Execution from an Unusual Directory", "description": "Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hide\nmalware in trusted paths.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* add suspicious execution paths here */\n  process.executable : (\n    \"?:\\\\PerfLogs\\\\*.exe\", \"?:\\\\Users\\\\Public\\\\*.exe\", \"?:\\\\Windows\\\\Tasks\\\\*.exe\",\n    \"?:\\\\Intel\\\\*.exe\", \"?:\\\\AMD\\\\Temp\\\\*.exe\", \"?:\\\\Windows\\\\AppReadiness\\\\*.exe\",\n    \"?:\\\\Windows\\\\ServiceState\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\IdentityCRL\\\\*.exe\",\n    \"?:\\\\Windows\\\\Branding\\\\*.exe\", \"?:\\\\Windows\\\\csc\\\\*.exe\", \"?:\\\\Windows\\\\DigitalLocker\\\\*.exe\",\n    \"?:\\\\Windows\\\\en-US\\\\*.exe\", \"?:\\\\Windows\\\\wlansvc\\\\*.exe\", \"?:\\\\Windows\\\\Prefetch\\\\*.exe\",\n    \"?:\\\\Windows\\\\Fonts\\\\*.exe\", \"?:\\\\Windows\\\\diagnostics\\\\*.exe\", \"?:\\\\Windows\\\\TAPI\\\\*.exe\",\n    \"?:\\\\Windows\\\\INF\\\\*.exe\", \"?:\\\\Windows\\\\System32\\\\Speech\\\\*.exe\", \"?:\\\\windows\\\\tracing\\\\*.exe\",\n    \"?:\\\\windows\\\\IME\\\\*.exe\", \"?:\\\\Windows\\\\Performance\\\\*.exe\", \"?:\\\\windows\\\\intel\\\\*.exe\",\n    \"?:\\\\windows\\\\ms\\\\*.exe\", \"?:\\\\Windows\\\\dot3svc\\\\*.exe\", \"?:\\\\Windows\\\\panther\\\\*.exe\",\n    \"?:\\\\Windows\\\\RemotePackages\\\\*.exe\", \"?:\\\\Windows\\\\OCR\\\\*.exe\", \"?:\\\\Windows\\\\appcompat\\\\*.exe\",\n    \"?:\\\\Windows\\\\apppatch\\\\*.exe\", \"?:\\\\Windows\\\\addins\\\\*.exe\", \"?:\\\\Windows\\\\Setup\\\\*.exe\",\n    \"?:\\\\Windows\\\\Help\\\\*.exe\", \"?:\\\\Windows\\\\SKB\\\\*.exe\", \"?:\\\\Windows\\\\Vss\\\\*.exe\",\n    \"?:\\\\Windows\\\\Web\\\\*.exe\", \"?:\\\\Windows\\\\servicing\\\\*.exe\", \"?:\\\\Windows\\\\CbsTemp\\\\*.exe\",\n    \"?:\\\\Windows\\\\Logs\\\\*.exe\", \"?:\\\\Windows\\\\WaaS\\\\*.exe\", \"?:\\\\Windows\\\\ShellExperiences\\\\*.exe\",\n    \"?:\\\\Windows\\\\ShellComponents\\\\*.exe\", \"?:\\\\Windows\\\\PLA\\\\*.exe\", \"?:\\\\Windows\\\\Migration\\\\*.exe\",\n    \"?:\\\\Windows\\\\debug\\\\*.exe\", \"?:\\\\Windows\\\\Cursors\\\\*.exe\", \"?:\\\\Windows\\\\Containers\\\\*.exe\",\n    \"?:\\\\Windows\\\\Boot\\\\*.exe\", \"?:\\\\Windows\\\\bcastdvr\\\\*.exe\", \"?:\\\\Windows\\\\assembly\\\\*.exe\",\n    \"?:\\\\Windows\\\\TextInput\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\SchCache\\\\*.exe\", \"?:\\\\Windows\\\\Resources\\\\*.exe\", \"?:\\\\Windows\\\\rescache\\\\*.exe\",\n    \"?:\\\\Windows\\\\Provisioning\\\\*.exe\", \"?:\\\\Windows\\\\PrintDialog\\\\*.exe\", \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.exe\",\n    \"?:\\\\Windows\\\\media\\\\*.exe\", \"?:\\\\Windows\\\\Globalization\\\\*.exe\", \"?:\\\\Windows\\\\L2Schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\LiveKernelReports\\\\*.exe\", \"?:\\\\Windows\\\\ModemLogs\\\\*.exe\",\n    \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.exe\"\n  ) and\n  \n  not process.name : (\n    \"SpeechUXWiz.exe\", \"SystemSettings.exe\", \"TrustedInstaller.exe\",\n    \"PrintDialog.exe\", \"MpSigStub.exe\", \"LMS.exe\", \"mpam-*.exe\"\n  ) and\n  not process.executable :\n            (\"?:\\\\Intel\\\\Wireless\\\\WUSetupLauncher.exe\",\n             \"?:\\\\Intel\\\\Wireless\\\\Setup.exe\",\n             \"?:\\\\Intel\\\\Move Mouse.exe\",\n             \"?:\\\\windows\\\\Panther\\\\DiagTrackRunner.exe\",\n             \"?:\\\\Windows\\\\servicing\\\\GC64\\\\tzupd.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\RemoteLite.exe\",\n             \"?:\\\\Users\\\\Public\\\\IBM\\\\ClientSolutions\\\\*.exe\",\n             \"?:\\\\Users\\\\Public\\\\Documents\\\\syspin.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\FileWatcher.exe\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_from_unusual_directory.toml"}
{"title": "Encoded Executable Stored in the Registry", "description": "Identifies registry write modifications to hide an encoded portable executable. This could be indicative of adversary\ndefense evasion by avoiding the storing of malicious content directly on disk.", "query": "registry where host.os.type == \"windows\" and\n/* update here with encoding combinations */\n registry.data.strings : \"TVqQAAMAAAAEAAAA*\"", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_hide_encoded_executable_registry.toml"}
{"title": "IIS HTTP Logging Disabled", "description": "Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS server\naccess via a webshell or other mechanism can disable HTTP Logging as an effective anti-forensics measure.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"appcmd.exe\" or ?process.pe.original_file_name == \"appcmd.exe\") and\n  process.args : \"/dontLog*:*True\" and\n  not process.parent.name : \"iissetup.exe\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_iis_httplogging_disabled.toml"}
{"title": "Command Execution via ForFiles", "description": "Detects attempts to execute a command via the forfiles Windows utility. Adversaries may use this utility to proxy\nexecution via a trusted parent process.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"forfiles.exe\" or ?process.pe.original_file_name == \"forfiles.exe\") and process.args : (\"/c\", \"-c\")", "tactic": "Defense Evasion", "technique": "Indirect Command Execution", "technique_id": "T1202", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_indirect_exec_forfiles.toml"}
{"title": "Process Injection by the Microsoft Build Engine", "description": "An instance of MSBuild, the Microsoft Build Engine, created a thread in another process. This technique is sometimes\nused to evade detection or elevate privileges.", "query": "process where host.os.type == \"windows\" and\n  event.provider == \"Microsoft-Windows-Sysmon\" and\n  /* CreateRemoteThread */\n  event.code == \"8\" and process.name: \"MSBuild.exe\"", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_injection_msbuild.toml"}
{"title": "InstallUtil Process Making Network Connections", "description": "Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is\noften leveraged by adversaries to execute code and evade detection.", "query": "/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */\n\nsequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"installutil.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"installutil.exe\" and network.direction : (\"outgoing\", \"egress\")]", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_installutil_beacon.toml"}
{"title": "Execution via Windows Command Debugging Utility", "description": "An adversary can use the Windows command line debugging utility cdb.exe to execute commands or shellcode. This rule\nlooks for those instances and where the cdb.exe binary is outside of the normal WindowsKit installation paths.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"CDB.Exe\" or process.name : \"cdb.exe\") and\n  process.args : (\"-cf\", \"-c\", \"-pd\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"?:\\\\Program Files\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*\\\\cdb.exe\"\n  )", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_lolbas_win_cdb_utility.toml"}
{"title": "Disabling Lsa Protection via Registry Modification", "description": "LSA protecton is provided to prevent nonprotected processes from reading memory and injecting code. This feature provides added security for the credentials that LSA stores and manages.\nAdversaries may modify the RunAsPPL registry and wait or initiate a system restart to enable Lsass credentials access.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Lsa\\\\RunAsPPL\", \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Lsa\\\\RunAsPPL\") and \n  not registry.data.strings : (\"1\", \"0x00000001\", \"2\", \"0x00000002\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_lsass_ppl_disabled_registry.toml"}
{"title": "Suspicious Endpoint Security Parent Process", "description": "A suspicious Endpoint Security parent process was detected. This may indicate a process hollowing or other form of code\ninjection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"esensor.exe\", \"elastic-endpoint.exe\") and\n  process.parent.executable != null and\n  /* add FPs here */\n  not process.parent.executable : (\n        \"?:\\\\Program Files\\\\Elastic\\\\*\",\n        \"?:\\\\Windows\\\\System32\\\\services.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\"\n  ) and\n  not (\n    process.parent.executable : (\n        \"?:\\\\Windows\\\\System32\\\\cmd.exe\",\n        \"?:\\\\Windows\\\\System32\\\\SecurityHealthHost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"\n    ) and\n    process.args : (\n        \"test\", \"version\",\n        \"top\", \"run\",\n        \"*help\", \"status\",\n        \"upgrade\", \"/launch\",\n        \"/enable\"\n    )\n  )", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_as_elastic_endpoint_process.toml"}
{"title": "Potential Masquerading as Business App Installer", "description": "Identifies executables with names resembling legitimate business applications but lacking signatures from the original\ndeveloper. Attackers may trick users into downloading malicious executables that masquerade as legitimate applications\nvia malicious ads, forum posts, and tutorials, effectively gaining initial access.", "query": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and process.executable : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\" and\n  not process.code_signature.status : (\"errorCode_endpoint*\", \"errorUntrustedRoot\", \"errorChaining\") and\n  (\n    /* Slack */\n    (process.name : \"*slack*.exe\" and not\n      (process.code_signature.subject_name in (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"*webex*.exe\" and not\n      (process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"teams*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"*discord*.exe\" and not\n      (process.code_signature.subject_name == \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"*whatsapp*.exe\" and not\n      (process.code_signature.subject_name in (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : (\"*zoom*installer*.exe\", \"*zoom*setup*.exe\", \"zoom.exe\")  and not\n      (process.code_signature.subject_name == \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"*outlook*.exe\" and not\n      (\n        (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) or\n        (\n          process.name: \"MSOutlookHelp-PST-Viewer.exe\" and process.code_signature.subject_name == \"Aryson Technologies Pvt. Ltd\" and\n          process.code_signature.trusted == true\n        )\n      )\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"*thunderbird*.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Grammarly */\n    (process.name : \"*grammarly*.exe\" and not\n      (process.code_signature.subject_name == \"Grammarly, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Dropbox */\n    (process.name : \"*dropbox*.exe\" and not\n      (process.code_signature.subject_name == \"Dropbox, Inc\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Tableau */\n    (process.name : \"*tableau*.exe\" and not\n      (process.code_signature.subject_name == \"Tableau Software LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Google Drive */\n    (process.name : \"*googledrive*.exe\" and not\n      (process.code_signature.subject_name == \"Google LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* MSOffice */\n    (process.name : \"*office*setup*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Okta */\n    (process.name : \"*okta*.exe\" and not\n      (process.code_signature.subject_name == \"Okta, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* OneDrive */\n    (process.name : \"*onedrive*.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Chrome */\n    (process.name : \"*chrome*.exe\" and not\n      (process.code_signature.subject_name in (\"Google LLC\", \"Google Inc\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Firefox */\n    (process.name : \"*firefox*.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Edge */\n    (process.name : (\"*microsoftedge*.exe\", \"*msedge*.exe\") and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Brave */\n    (process.name : \"*brave*.exe\" and not\n      (process.code_signature.subject_name == \"Brave Software, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* GoogleCloud Related Tools */\n    (process.name : \"*GoogleCloud*.exe\" and not\n      (process.code_signature.subject_name == \"Google LLC\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Github Related Tools */\n    (process.name : \"*github*.exe\" and not\n      (process.code_signature.subject_name == \"GitHub, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Notion */\n    (process.name : \"*notion*.exe\" and not\n      (process.code_signature.subject_name == \"Notion Labs, Inc.\" and process.code_signature.trusted == true)\n    )\n  )", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_business_apps_installer.toml"}
{"title": "Potential Masquerading as Communication Apps", "description": "Identifies suspicious instances of communications apps, both unsigned and renamed ones, that can indicate an attempt to\nconceal malicious activity, bypass security features such as allowlists, or trick users into executing malware.", "query": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and\n  (\n    /* Slack */\n    (process.name : \"slack.exe\" and not\n      (process.code_signature.subject_name in (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"WebexHost.exe\" and not\n      (process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"Teams.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"Discord.exe\" and not\n      (process.code_signature.subject_name == \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* RocketChat */\n    (process.name : \"Rocket.Chat.exe\" and not\n      (process.code_signature.subject_name == \"Rocket.Chat Technologies Corp.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Mattermost */\n    (process.name : \"Mattermost.exe\" and not\n      (process.code_signature.subject_name == \"Mattermost, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"WhatsApp.exe\" and not\n      (process.code_signature.subject_name in (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : \"Zoom.exe\" and not\n      (process.code_signature.subject_name == \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"outlook.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"thunderbird.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    )\n  )", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_communication_apps.toml"}
{"title": "Renamed AutoIt Scripts Interpreter", "description": "Identifies a suspicious AutoIt process execution. Malware written as an AutoIt script tends to rename the AutoIt\nexecutable to avoid detection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name : \"AutoIt*.exe\" and not process.name : \"AutoIt*.exe\"", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_renamed_autoit.toml"}
{"title": "Suspicious WerFault Child Process", "description": "A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit\nregistry key manipulation. Verify process details such as command line, network connections and file writes.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n\n  process.parent.name : \"WerFault.exe\" and\n\n  /* args -s and -t used to execute a process via SilentProcessExit mechanism */\n  (process.parent.args : \"-s\" and process.parent.args : \"-t\" and process.parent.args : \"-c\") and\n\n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\Initcrypt.exe\", \"?:\\\\Program Files (x86)\\\\Heimdal\\\\Heimdal.Guard.exe\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_suspicious_werfault_childproc.toml"}
{"title": "Program Files Directory Masquerading", "description": "Identifies execution from a directory masquerading as the Windows Program Files directories. These paths are trusted and\nusually host trusted third party programs. An adversary may leverage masquerading, along with low privileges to bypass\ndetections allowlisting those folders.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"C:\\\\*Program*Files*\\\\*.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\*Program*Files*\\\\*.exe\"\n  ) and\n  not process.executable : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Users\\\\*.exe\",\n        \"?:\\\\ProgramData\\\\*.exe\",\n        \"?:\\\\Windows\\\\Downloaded Program Files\\\\*.exe\",\n        \"?:\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?FilesOpera*\\\\*.exe\",\n        \"?:\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?Files?(x86)Opera*\\\\*.exe\"\n  ) and\n  not (\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\ProgramData\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Downloaded Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?FilesOpera*\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?Files?(x86)Opera*\\\\*.exe\"\n      )\n  )", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_trusted_directory.toml"}
{"title": "Potential Windows Error Manager Masquerading", "description": "Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matching\ncommand-line and process executable values performing outgoing network connections. This may be indicative of a\nmasquerading attempt to evade suspicious child process behavior detections.", "query": "sequence by host.id, process.entity_id with maxspan = 5s\n  [process where host.os.type == \"windows\" and event.type:\"start\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and network.protocol != \"dns\" and\n    network.direction : (\"outgoing\", \"egress\") and destination.ip !=\"::1\" and destination.ip !=\"127.0.0.1\"\n  ]", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_masquerading_werfault.toml"}
{"title": "Microsoft Windows Defender Tampering", "description": "Identifies when one or more features on Microsoft Defender are disabled. Adversaries may disable or tamper with\nMicrosoft Defender features to evade detection and conceal malicious behavior.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and process.executable != null and\n  (\n    (\n      registry.value : (\n        \"PUAProtection\", \"DisallowExploitProtectionOverride\", \"TamperProtection\", \"EnableControlledFolderAccess\",\n        \"SpynetReporting\", \"SubmitSamplesConsent\"\n      ) and registry.data.strings : (\"0\", \"0x00000000\")\n    ) or\n    (\n      registry.value : (\n        \"DisableAntiSpyware\", \"DisableRealtimeMonitoring\", \"DisableIntrusionPreventionSystem\", \"DisableScriptScanning\",\n        \"DisableIOAVProtection\", \"DisableEnhancedNotifications\", \"DisableBlockAtFirstSeen\", \"DisableBehaviorMonitoring\"\n      ) and registry.data.strings : (\"1\", \"0x00000001\")\n    )\n  ) and\n  not process.executable : (\n    \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \n    \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\", \n    \"?:\\\\Windows\\\\System32\\\\DeviceEnroller.exe\", \n    \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\Security Agent\\\\tmuninst.exe\"\n  )\n\n/*\n    Full registry key paths omitted due to data source variations:\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\DisableAntiSpyware\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableRealtimeMonitoring\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIntrusionPreventionSystem\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableScriptScanning\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableIOAVProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Reporting\\\\DisableEnhancedNotifications\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\DisableBlockAtFirstSeen\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection\\\\DisableBehaviorMonitoring\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\PUAProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender Security Center\\\\App and Browser protection\\\\DisallowExploitProtectionOverride\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Features\\\\TamperProtection\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Windows Defender Exploit Guard\\\\Controlled Folder Access\\\\EnableControlledFolderAccess\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SpynetReporting\"\n    \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\SpyNet\\\\SubmitSamplesConsent\"\n*/", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_microsoft_defender_tampering.toml"}
{"title": "Network Connection via Signed Binary", "description": "Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signature\nvalidation. Adversaries may use these binaries to 'live off the land' and execute malicious files that could bypass\napplication allowlists and signature validation.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n                 event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n    not cidrmatch(destination.ip,\n      \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",\n      \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\",\n      \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n      \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\", \"FF00::/8\")]", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_misc_lolbin_connecting_to_the_internet.toml"}
{"title": "MsBuild Making Network Connections", "description": "Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is often\nleveraged by adversaries to execute code and evade detection.", "query": "sequence by process.entity_id with maxspan=30s\n\n  /* Look for MSBuild.exe process execution */\n  /* The events for this first sequence may be noisy, consider adding exceptions */\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (\n      process.pe.original_file_name: \"MSBuild.exe\" or\n      process.name: \"MSBuild.exe\"\n    ) and\n    not user.id == \"S-1-5-18\"]\n\n  /* Followed by a network connection to an external address */\n  /* Exclude domains that are known to be benign */\n  [network where host.os.type == \"windows\" and\n    event.action: (\"connection_attempted\", \"lookup_requested\") and\n    (\n      process.pe.original_file_name: \"MSBuild.exe\" or\n      process.name: \"MSBuild.exe\"\n    ) and\n    not user.id == \"S-1-5-18\" and\n    not cidrmatch(destination.ip, \"127.0.0.1\", \"::1\") and\n    not dns.question.name : (\n      \"localhost\",\n      \"dc.services.visualstudio.com\",\n      \"vortex.data.microsoft.com\",\n      \"api.nuget.org\")]", "tactic": "Defense Evasion", "technique": "Trusted Developer Utilities Proxy Execution", "technique_id": "T1127", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_msbuild_making_network_connections.toml"}
{"title": "Mshta Making Network Connections", "description": "Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is often\nleveraged by adversaries to execute malicious scripts and evade detection.", "query": "sequence by process.entity_id with maxspan=10m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     not process.parent.name : \"Microsoft.ConfigurationManagement.exe\" and\n     not (process.parent.executable : \"C:\\\\Amazon\\\\Amazon Assistant\\\\amazonAssistantService.exe\" or\n          process.parent.executable : \"C:\\\\TeamViewer\\\\TeamViewer.exe\") and\n     not process.args : \"ADSelfService_Enroll.hta\"]\n  [network where host.os.type == \"windows\" and process.name : \"mshta.exe\"]", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_mshta_beacon.toml"}
{"title": "MsiExec Service Child Process With Network Connection", "description": "Identifies the execution of an MsiExec service child process followed by network or dns lookup activity. Adversaries may\nabuse Windows Installers for initial access and delivery of malware.", "query": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : \"msiexec.exe\" and process.parent.args : \"/v\" and\n  not process.executable :\n        (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n         \"?:\\\\Windows\\\\sysWOW64\\\\msiexec.exe\",\n         \"?:\\\\Windows\\\\system32\\\\srtasks.exe\",\n         \"?:\\\\Windows\\\\syswow64\\\\srtasks.exe\",\n         \"?:\\\\Windows\\\\sys*\\\\taskkill.exe\",\n         \"?:\\\\Program Files\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\*.exe\",\n         \"?:\\\\Windows\\\\Installer\\\\MSI*.tmp\",\n         \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\RegSvcs.exe\") and\n not (process.name : (\"rundll32.exe\", \"regsvr32.exe\") and process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))]\n[any where host.os.type == \"windows\" and event.category in (\"network\", \"dns\") and process.name != null]", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_msiexec_child_proc_netcon.toml"}
{"title": "Network Connection via MsXsl", "description": "Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged\nby adversaries to execute malicious scripts and evade detection.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]", "tactic": "Defense Evasion", "technique": "XSL Script Processing", "technique_id": "T1220", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_msxsl_network.toml"}
{"title": "MS Office Macro Security Registry Modifications", "description": "Microsoft Office Products offer options for users and developers to control the security settings for running and using\nMacros. Adversaries may abuse these security settings to modify the default behavior of the Office Application to trust\nfuture macros and/or disable security warnings, which could increase their chances of establishing persistence.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : (\"AccessVBOM\", \"VbaWarnings\") and\n    registry.path : (\n        /* Sysmon */\n        \"HKU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"HKU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        /* MDE */\n        \"HKCU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKCU\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"HKCU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"HKCU\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        /* Endgame */\n        \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"\\\\REGISTRY\\\\USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        /* SentinelOne */\n        \"USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"USER\\\\S-1-5-21-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\",\n        \"USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\AccessVBOM\",\n        \"USER\\\\S-1-12-1-*\\\\SOFTWARE\\\\Microsoft\\\\Office\\\\*\\\\Security\\\\VbaWarnings\"\n        ) and\n    registry.data.strings : (\"0x00000001\", \"1\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ms_office_suspicious_regmod.toml"}
{"title": "Unusual Network Activity from a Windows System Binary", "description": "Identifies network activity from unexpected system applications. This may indicate adversarial activity as these\napplications are often leveraged by adversaries to execute code and evade detection.", "query": "sequence by process.entity_id with maxspan=5m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n\n     /* known applocker bypasses */\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      process.name : \"MSBuild.exe\" or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      process.name : \"wscript.exe\" or\n      process.name : \"msiexec.exe\" or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\")]\n  [network where\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      (\n        process.name : \"msbuild.exe\" and\n          destination.ip != \"127.0.0.1\"\n      ) or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      (\n        process.name : \"msiexec.exe\" and not\n        dns.question.name : (\n           \"ocsp.digicert.com\", \"ocsp.verisign.com\", \"ocsp.comodoca.com\", \"ocsp.entrust.net\", \"ocsp.usertrust.com\",\n           \"ocsp.godaddy.com\", \"ocsp.camerfirma.com\", \"ocsp.globalsign.com\", \"ocsp.sectigo.com\", \"*.local\"\n        ) and\n        /* Localhost, DigiCert and Comodo CA IP addresses */\n        not cidrmatch(destination.ip, \"127.0.0.1\", \"192.229.211.108/32\", \"192.229.221.95/32\",\n                      \"152.195.38.76/32\", \"104.18.14.101/32\")\n      ) or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\") and \n      \n      not dns.question.name : (\"localhost\", \"setup.officetimeline.com\", \"us.deployment.endpoint.ingress.rapid7.com\", \n        \"ctldl.windowsupdate.com\", \"crl?.digicert.com\", \"ocsp.digicert.com\", \"addon-cms-asl.eu.goskope.com\", \"crls.ssl.com\", \n        \"evcs-ocsp.ws.symantec.com\", \"s.symcd.com\", \"s?.symcb.com\", \"crl.verisign.com\", \"oneocsp.microsoft.com\", \"crl.verisign.com\", \n        \"aka.ms\", \"crl.comodoca.com\", \"acroipm2.adobe.com\", \"sv.symcd.com\") and \n\n      /* host query itself */\n      not startswith~(dns.question.name, host.name)\n      ]", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_network_connection_from_windows_binary.toml"}
{"title": "Potential NetNTLMv1 Downgrade Attack", "description": "Identifies registry modification to force the system to fall back to NTLMv1 for authentication. This modification is possible\nwith local administrator privileges and is commonly referred to as a `NetNTLMv1 downgrade attack`.", "query": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and\n registry.value == \"LmCompatibilityLevel\" and registry.data.strings in (\"2\", \"1\", \"0\", \"0x00000002\", \"0x00000001\", \"0x00000000\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_ntlm_downgrade.toml"}
{"title": "Parent Process PID Spoofing", "description": "Identifies parent process spoofing used to thwart detection. Adversaries may spoof the parent process identifier (PPID)\nof a new process to evade process-monitoring defenses or to elevate privileges.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_parent_process_pid_spoofing.toml"}
{"title": "Local Account TokenFilter Policy Disabled", "description": "Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn't by\ndefault) and is set to 1, then remote connections from all local members of Administrators are granted full\nhigh-integrity tokens during negotiation.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"LocalAccountTokenFilterPolicy\" and\n  registry.path : (\n    \"HKLM\\\\*\\\\LocalAccountTokenFilterPolicy\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\",\n    \"MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\"\n  ) and registry.data.strings : (\"1\", \"0x00000001\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_persistence_account_tokenfilterpolicy.toml"}
{"title": "Suspicious .NET Reflection via PowerShell", "description": "Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this method\nto load executables and DLLs without writing to the disk, bypassing security solutions.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"[System.Reflection.Assembly]::Load\" or\n    \"[Reflection.Assembly]::Load\" or\n    \"Assembly.Load(\"\n  ) and\n  not powershell.file.script_block_text : (\n        (\"CommonWorkflowParameters\" or \"RelatedLinksHelpInfo\") and\n        \"HelpDisplayStrings\"\n  ) and\n  not (powershell.file.script_block_text :\n        (\"Get-SolutionFiles\" or \"Get-VisualStudio\" or \"Select-MSBuildPath\") and\n        file.name : \"PathFunctions.ps1\"\n  ) and\n  not powershell.file.script_block_text : (\n        \"Microsoft.PowerShell.Workflow.ServiceCore\" and \"ExtractPluginProperties([string]$pluginDir\"\n  ) and \n  \n  not powershell.file.script_block_text : (\"reflection.assembly]::Load('System.\" or \"LoadWithPartialName('Microsoft.\" or \"::Load(\\\"Microsoft.\" or \"Microsoft.Build.Utilities.Core.dll\") and \n  \n  not user.id : \"S-1-5-18\"", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_posh_assembly_load.toml"}
{"title": "PowerShell Suspicious Payload Encoded and Compressed", "description": "Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, which\nmalware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"System.IO.Compression.DeflateStream\" or\n      \"System.IO.Compression.GzipStream\" or\n      \"IO.Compression.DeflateStream\" or\n      \"IO.Compression.GzipStream\"\n    ) and\n    FromBase64String\n  ) and\n  not user.id : \"S-1-5-18\"", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_posh_compressed.toml"}
{"title": "PowerShell Script with Encryption/Decryption Capabilities", "description": "Identifies the use of Cmdlets and methods related to encryption/decryption of files in PowerShell scripts, which malware\nand offensive security tools can abuse to encrypt data or decrypt payloads to bypass security solutions.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"Cryptography.AESManaged\" or\n      \"Cryptography.RijndaelManaged\" or\n      \"Cryptography.SHA1Managed\" or\n      \"Cryptography.SHA256Managed\" or\n      \"Cryptography.SHA384Managed\" or\n      \"Cryptography.SHA512Managed\" or\n      \"Cryptography.SymmetricAlgorithm\" or\n      \"PasswordDeriveBytes\" or\n      \"Rfc2898DeriveBytes\"\n    ) and\n    (\n      CipherMode and PaddingMode\n    ) and\n    (\n      \".CreateEncryptor\" or\n      \".CreateDecryptor\"\n    )\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.name : \"Bootstrap.Octopus.FunctionAppenderContext.ps1\" and\n    powershell.file.script_block_text : (\"function Decrypt-Variables\" or \"github.com/OctopusDeploy\")\n  )", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_posh_encryption.toml"}
{"title": "Potential PowerShell Obfuscated Script", "description": "Identifies scripts that contain patterns and known methods that obfuscate PowerShell code. Attackers can use obfuscation\ntechniques to bypass PowerShell security protections such as Antimalware Scan Interface (AMSI).", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"[string]::join\" or\n    \"-Join\" or\n    \"[convert]::toint16\" or\n    \"[char][int]$_\" or\n    (\"ConvertTo-SecureString\" and \"PtrToStringAuto\") or\n    \".GetNetworkCredential().password\" or\n    \"-BXor\" or\n    (\"replace\" and \"char\") or\n    \"[array]::reverse\" or\n    \"-replace\"\n  ) and\n  powershell.file.script_block_text : (\n    (\"$pSHoMe[\" and \"+$pSHoMe[\") or\n    (\"$ShellId[\" and \"+$ShellId[\") or\n    (\"$env:ComSpec[4\" and \"25]-Join\") or\n    ((\"Set-Variable\" or \"SV\" or \"Set-Item\") and \"OFS\") or\n    (\"*MDR*\" and \"Name[3,11,2]\") or\n    (\"$VerbosePreference\" and \"[1,3]+'X'-Join''\") or\n    (\"rahc\" or \"ekovin\" or \"gnirts\" or \"ecnereferpesobrev\" or \"ecalper\" or \"cepsmoc\" or \"dillehs\") or\n    (\"System.Management.Automation.$([cHAr]\" or \"System.$([cHAr]\" or \")+[cHAR]([byte]\")\n  )", "tactic": "Defense Evasion", "technique": "Obfuscated Files or Information", "technique_id": "T1027", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_posh_obfuscation.toml"}
{"title": "Potential Process Injection via PowerShell", "description": "Detects the use of Windows API functions that are commonly abused by malware and security tools to load malicious code\nor inject it into remote processes.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n   (VirtualAlloc or VirtualAllocEx or VirtualProtect or LdrLoadDll or LoadLibrary or LoadLibraryA or\n      LoadLibraryEx or GetProcAddress or OpenProcess or OpenProcessToken or AdjustTokenPrivileges) and\n   (WriteProcessMemory or CreateRemoteThread or NtCreateThreadEx or CreateThread or QueueUserAPC or\n      SuspendThread or ResumeThread or GetDelegateForFunctionPointer)\n  ) and not \n  file.directory: (\n    \"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\SenseCM\" or\n    \"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\"\n  )", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_posh_process_injection.toml"}
{"title": "Windows Firewall Disabled via PowerShell", "description": "Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade network\nconstraints, like internet and network lateral communication restrictions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  process.args : \"*Set-NetFirewallProfile*\" and\n  process.args : \"*-Enabled*\" and process.args : \"*False*\" and\n  process.args : (\"*-All*\", \"*Public*\", \"*Domain*\", \"*Private*\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_powershell_windows_firewall_disabled.toml"}
{"title": "Process Termination followed by Deletion", "description": "Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other\nnon-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removal\nof these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's\nfootprint.", "query": "sequence by host.id with maxspan=5s\n   [process where host.os.type == \"windows\" and event.type == \"end\" and\n    process.code_signature.trusted != true and\n    not process.executable like\n             (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n              \"C:\\\\Windows\\\\WinSxS\\\\*.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not (\n      process.name : \"infinst.exe\" and process.parent.name: \"dxsetup.exe\" and\n      process.parent.code_signature.subject_name == \"NVIDIA Corporation\" and\n      process.parent.code_signature.status == \"trusted\"\n    )\n   ] by process.executable\n   [file where host.os.type == \"windows\" and event.type == \"deletion\" and file.extension in~ (\"exe\", \"scr\", \"com\") and\n    not process.executable like\n             (\"?:\\\\Program Files\\\\*.exe\",\n              \"?:\\\\Program Files (x86)\\\\*.exe\",\n              \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n              \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not file.path like (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\Temp\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WinREAgent\\\\Scratch\\\\*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\tenable_mw_scan_*.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\LogiUI\\\\Pak\\\\uninstall.exe\",\n          \"?:\\\\ProgramData\\\\chocolatey\\\\*.exe\"\n    ) and\n    not (process.name : \"OktaVerifySetup-*.exe\" and process.code_signature.subject_name == \"Okta, Inc.\") and\n    not (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\" and\n      process.code_signature.subject_name == \"Citrix Systems, Inc.\" and\n      file.path : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\\\\bootstrapperhelper.exe\"\n    )\n   ] by file.path", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_process_termination_followed_by_deletion.toml"}
{"title": "Suspicious Microsoft Diagnostics Wizard Execution", "description": "Identifies potential abuse of the Microsoft Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious command or\nbinary execution via malicious process arguments.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.pe.original_file_name == \"msdt.exe\" or process.name : \"msdt.exe\") and\n   (\n    process.args : (\"IT_RebrowseForFile=*\", \"ms-msdt:/id\", \"ms-msdt:-id\", \"*FromBase64*\") or\n\n    (process.args : \"-af\" and process.args : \"/skip\" and\n     process.parent.name : (\"explorer.exe\", \"cmd.exe\", \"powershell.exe\", \"cscript.exe\", \"wscript.exe\", \"mshta.exe\", \"rundll32.exe\", \"regsvr32.exe\") and\n     process.args : (\"?:\\\\WINDOWS\\\\diagnostics\\\\index\\\\PCWDiagnostic.xml\", \"PCWDiagnostic.xml\", \"?:\\\\Users\\\\Public\\\\*\", \"?:\\\\Windows\\\\Temp\\\\*\")) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.name : \"msdt.exe\" and process.name != null) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.executable : (\"?:\\\\Windows\\\\system32\\\\msdt.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\msdt.exe\"))\n    )", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_proxy_execution_via_msdt.toml"}
{"title": "Potential RemoteMonologue Attack", "description": "Identifies attempt to perform session hijack via COM object registry modification by setting the RunAs value to Interactive User.", "query": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and registry.value == \"RunAs\" and registry.data.strings : \"Interactive User\"", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_regmod_remotemonologue.toml"}
{"title": "DNS Global Query Block List Modified or Disabled", "description": "Identifies changes to the DNS Global Query Block List (GQBL), a security feature that prevents the resolution of certain\nDNS names often exploited in attacks like WPAD spoofing. Attackers with certain privileges, such as DNSAdmins, can\nmodify or disable the GQBL, allowing exploitation of hosts running WPAD with default settings for privilege escalation\nand lateral movement.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n(\n  (registry.value : \"EnableGlobalQueryBlockList\" and registry.data.strings : (\"0\", \"0x00000000\")) or\n  (registry.value : \"GlobalQueryBlockList\" and not registry.data.strings : \"wpad\")\n)", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_reg_disable_enableglobalqueryblocklist.toml"}
{"title": "File with Right-to-Left Override Character (RTLO) Created/Executed", "description": "Identifies the creation or execution of files or processes with names containing the Right-to-Left Override (RTLO)\ncharacter, which can be used to disguise the file extension and trick users into executing malicious files.", "query": "any where host.os.type == \"windows\" and event.category in (\"file\", \"process\") and\n  (\n    (event.type == \"creation\" and file.path : \"*\\u{202E}*\") or \n    (event.type == \"start\" and process.name : \"*\\u{202E}*\")\n  )", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_right_to_left_override.toml"}
{"title": "Alternate Data Stream Creation/Execution at Volume Root Directory", "description": "Identifies the creation of an Alternate Data Stream (ADS) at a volume root directory, which can indicate the attempt to\nhide tools and malware, as ADSs created in this directory are not displayed by system utilities.", "query": "any where host.os.type == \"windows\" and event.category in (\"file\", \"process\") and\n  (\n    (event.type == \"creation\" and file.path regex~ \"\"\"[A-Z]:\\\\:.+\"\"\") or\n    (event.type == \"start\" and process.executable regex~ \"\"\"[A-Z]:\\\\:.+\"\"\")\n  )", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_root_dir_ads_creation.toml"}
{"title": "Unusual Child Processes of RunDLL32", "description": "Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse of\nRunDLL32 could indicate malicious activity.", "query": "sequence with maxspan=1h\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"rundll32.exe\" or process.pe.original_file_name == \"RUNDLL32.EXE\") and\n      process.args_count == 1\n  ] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"rundll32.exe\"\n  ] by process.parent.entity_id", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_rundll32_no_arguments.toml"}
{"title": "Windows Sandbox with Sensitive Configuration", "description": "Identifies Windows sanfbox processes indicating the start of a new container with sensitive configurations like write\naccess to the host file system, network connection and automatic execution via logon command. Malware may abuse the\nsandbox feature to evade detection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"wsb.exe\", \"WindowsSandboxClient.exe\") and\n  process.command_line : (\"*<Networking>Enable</Networking>*\",\n                          \"*<HostFolder>C:\\\\*<ReadOnly>false*\",\n                          \"*<LogonCommand>*\",\n                          \"*<NetworkingEnabled>true*\")", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_run_virt_windowssandbox.toml"}
{"title": "Potential Windows Session Hijacking via CcmExec", "description": "This detection rule identifies when 'SCNotification.exe' loads an untrusted DLL, which is a potential indicator of an\nattacker attempt to hijack/impersonate a Windows user session.", "query": "library where host.os.type == \"windows\" and process.name : \"SCNotification.exe\" and\n  (dll.Ext.relative_file_creation_time < 86400 or dll.Ext.relative_file_name_modify_time <= 500) and dll.code_signature.status != \"trusted\"", "tactic": "Defense Evasion", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sccm_scnotification_dll.toml"}
{"title": "Scheduled Tasks AT Command Enabled", "description": "Identifies attempts to enable the Windows scheduled tasks AT command via the registry. Attackers may use this method to\nmove laterally or persist locally. The AT command has been deprecated since Windows 8 and Windows Server 2012, but still\nexists for backwards compatibility.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\Configuration\\\\EnableAt\"\n  ) and registry.data.strings : (\"1\", \"0x00000001\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_scheduledjobs_at_protocol_enabled.toml"}
{"title": "Script Execution via Microsoft HTML Application", "description": "Identifies the execution of scripts via HTML applications using Windows utilities rundll32.exe or mshta.exe. Adversaries\nmay bypass process and/or signature-based defenses by proxying execution of malicious content with signed binaries.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"rundll32.exe\", \"mshta.exe\") and\n  (\n     (process.command_line :\n        (\n        \"*script*eval(*\",\n         \"*script*GetObject*\",\n         \"*.regread(*\",\n         \"*WScript.Shell*\",\n         \"*.run(*\",\n         \"*).Exec()*\",\n         \"*mshta*http*\",\n         \"*mshtml*RunHTMLApplication*\",\n         \"*mshtml*,#135*\",\n         \"*StrReverse*\",\n         \"*.RegWrite*\",\n         /* Issue #379 */\n         \"*window.close(*\",\n         \"* Chr(*\"\n         )\n     and not process.parent.executable :\n                  (\"?:\\\\Program Files (x86)\\\\Citrix\\\\System32\\\\wfshell.exe\",\n                   \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\Office*\\\\MSACCESS.EXE\",\n                   \"?:\\\\Program Files\\\\Quokka.Works GTInstaller\\\\GTInstaller.exe\")\n     ) or\n\n    (process.name : \"mshta.exe\" and\n     not process.command_line : (\"*.hta*\", \"*.htm*\", \"-Embedding\") and process.args_count >=2) or\n\n     /* Execution of HTA file downloaded from the internet */\n     (process.name : \"mshta.exe\" and process.command_line : \"*\\\\Users\\\\*\\\\Downloads\\\\*.hta*\") or\n\n     /* Execution of HTA file from archive */\n     (process.name : \"mshta.exe\" and\n      process.args : (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\", \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\", \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\", \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\"))\n   )", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_script_via_html_app.toml"}
{"title": "Service DACL Modification via sc.exe", "description": "Identifies DACL modifications to deny access to a service, making it unstoppable, or hide it from system and users.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name : \"sc.exe\") and\n  process.args : \"sdset\" and process.args : \"*D;*\" and\n  process.args : (\"*;IU*\", \"*;SU*\", \"*;BA*\", \"*;SY*\", \"*;WD*\")", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sc_sdset.toml"}
{"title": "Potential Secure File Deletion via SDelete Utility", "description": "Detects file name patterns generated by the use of Sysinternals SDelete utility to securely delete a file via multiple\nfile overwrite and rename operations.", "query": "file where host.os.type == \"windows\" and event.type == \"change\" and file.name : \"*AAA.AAA\"", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sdelete_like_filename_rename.toml"}
{"title": "SIP Provider Modification", "description": "Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the\nWindows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signature\nvalidation checks or inject code into critical processes.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : (\"Dll\", \"$Dll\") and\n  registry.path: (\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\"\n    ) and\n  registry.data.strings:\"*.dll\" and\n  not (process.name : \"msiexec.exe\" and registry.data.strings : \"mso.dll\") and\n  not (process.name : \"regsvr32.exe\" and registry.data.strings == \"WINTRUST.DLL\")", "tactic": "Defense Evasion", "technique": "Subvert Trust Controls", "technique_id": "T1553", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_sip_provider_mod.toml"}
{"title": "SolarWinds Process Disabling Services via Registry", "description": "Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse this\ntechnique to manipulate relevant security services.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Start\" and\n  process.name : (\n      \"SolarWinds.BusinessLayerHost*.exe\",\n      \"ConfigurationWizard*.exe\",\n      \"NetflowDatabaseMaintenance*.exe\",\n      \"NetFlowService*.exe\",\n      \"SolarWinds.Administration*.exe\",\n      \"SolarWinds.Collector.Service*.exe\",\n      \"SolarwindsDiagnostics*.exe\"\n  ) and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\"\n  ) and\n  registry.data.strings : (\"4\", \"0x00000004\")", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_solarwinds_backdoor_service_disabled_via_registry.toml"}
{"title": "Suspicious CertUtil Commands", "description": "Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part of\nCertificate Services. CertUtil is often abused by attackers to live off the land for stealthier command and control or\ndata exfiltration.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"certutil.exe\" or ?process.pe.original_file_name == \"CertUtil.exe\") and\n  process.args : (\"?decode\", \"?encode\", \"?urlcache\", \"?verifyctl\", \"?encodehex\", \"?decodehex\", \"?exportPFX\")", "tactic": "Defense Evasion", "technique": "Deobfuscate/Decode Files or Information", "technique_id": "T1140", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_certutil_commands.toml"}
{"title": "Suspicious Execution from a Mounted Device", "description": "Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker may\nuse this technique to evade defenses.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"C:\\\\*\" and\n  (process.working_directory : \"?:\\\\\" and not process.working_directory: \"C:\\\\\") and\n  process.parent.name : \"explorer.exe\" and\n  process.name : (\"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\", \"cmd.exe\", \"regsvr32.exe\",\n                  \"cscript.exe\", \"wscript.exe\")", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_execution_from_mounted_device.toml"}
{"title": "Suspicious Managed Code Hosting Process", "description": "Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious\ncode execution.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : (\"wscript.exe.log\",\n               \"cscript.exe.log\",\n               \"mshta.exe.log\",\n               \"wmic.exe.log\",\n               \"svchost.exe.log\",\n               \"dllhost.exe.log\",\n               \"cmstp.exe.log\",\n               \"regsvr32.exe.log\")", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_managedcode_host_process.toml"}
{"title": "Suspicious Process Access via Direct System Call", "description": "Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hook\nuserland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass\nhooked functions by writing malicious functions that call syscalls directly.", "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n length(winlog.event_data.CallTrace) > 0 and\n\n /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */\n not winlog.event_data.CallTrace :\n            (\"?:\\\\WINDOWS\\\\SYSTEM32\\\\ntdll.dll*\",\n             \"?:\\\\WINDOWS\\\\SysWOW64\\\\ntdll.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\wow64cpu.dll*\",\n             \"?:\\\\WINDOWS\\\\System32\\\\wow64win.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\win32u.dll*\") and\n\n not winlog.event_data.TargetImage :\n            (\"?:\\\\Program Files (x86)\\\\Malwarebytes Anti-Exploit\\\\mbae-svc.exe\",\n             \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\*\\\\AcroCEF.exe\") and\n\n not (process.executable : (\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n                            \"?:\\\\Program Files (x86)\\\\World of Warcraft\\\\_classic_\\\\WowClassic.exe\") and\n      not winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\")", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_process_access_direct_syscall.toml"}
{"title": "Suspicious Process Creation CallTrace", "description": "Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parent\nprocess. This may indicate a code injection attempt.", "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.code == \"1\" and\n   /* sysmon process creation */\n   process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\", \"fltldr.exe\",\n                          \"mspub.exe\", \"msaccess.exe\",\"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                          \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") and\n\n   /* noisy FP patterns */\n   not (process.parent.name : \"EXCEL.EXE\" and process.executable : \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\ADDINS\\\\*.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\splwow64.exe\" and process.args in (\"8192\", \"12288\") and process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"rundll32.exe\" and process.parent.args : (\"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\", \"--no-sandbox\")) and\n   not (process.executable :\n            (\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\DWWIN.EXE\") and\n        process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"regsvr32.exe\" and process.parent.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n   ] by process.parent.entity_id, process.entity_id\n  [process where host.os.type == \"windows\" and event.code == \"10\" and\n   /* Sysmon process access event from unknown module */\n   winlog.event_data.CallTrace : \"*UNKNOWN*\"] by process.entity_id, winlog.event_data.TargetProcessGUID", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_process_creation_calltrace.toml"}
{"title": "Suspicious Script Object Execution", "description": "Identifies scrobj.dll loaded into unusual Microsoft processes. This usually means a malicious scriptlet is being\nexecuted in the target process.", "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : \"scrobj.dll\" or ?file.name : \"scrobj.dll\") and\n process.executable : (\"?:\\\\Windows\\\\System32\\\\*.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\*.exe\") and\n not process.executable : (\n       \"?:\\\\Windows\\\\System32\\\\cscript.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\cscript.exe\",\n       \"?:\\\\Windows\\\\system32\\\\msiexec.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n       \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n       \"?:\\\\Windows\\\\system32\\\\taskhostw.exe\",\n       \"?:\\\\windows\\\\system32\\\\inetsrv\\\\w3wp.exe\",\n       \"?:\\\\windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n       \"?:\\\\Windows\\\\system32\\\\wscript.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\wscript.exe\",\n       \"?:\\\\Windows\\\\System32\\\\mshta.exe\",\n       \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\",\n       \"?:\\\\Windows\\\\System32\\\\cmd.exe\",\n       \"?:\\\\Windows\\\\SysWOW64\\\\cmd.exe\",\n       \"?:\\\\Windows\\\\System32\\\\OpenWith.exe\",\n       \"?:\\\\Windows\\\\System32\\\\wbem\\\\WMIADAP.exe\",\n       \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\")", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_scrobj_load.toml"}
{"title": "Renamed Utility Executed with Short Program Name", "description": "Identifies the execution of a process with a single character process name, differing from the original file name. This\nis often done by adversaries while staging, executing temporary utilities, or trying to bypass security detections based\non the process name.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and length(process.name) > 0 and\n length(process.name) == 5 and length(process.pe.original_file_name) > 5", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_short_program_name.toml"}
{"title": "Suspicious WMIC XSL Script Execution", "description": "Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scripting\nlibraries it may be indicative of an allowlist bypass.", "query": "sequence by process.entity_id with maxspan = 2m\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.name : \"WMIC.exe\" or process.pe.original_file_name : \"wmic.exe\") and\n   process.args : (\"format*:*\", \"/format*:*\", \"*-format*:*\") and\n   not process.command_line : (\"* /format:table *\", \"* /format:table\")]\n[any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : (\"jscript.dll\", \"vbscript.dll\") or file.name : (\"jscript.dll\", \"vbscript.dll\"))]", "tactic": "Defense Evasion", "technique": "XSL Script Processing", "technique_id": "T1220", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_wmi_script.toml"}
{"title": "Suspicious Zoom Child Process", "description": "A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details\nsuch as command line, network connections, file writes and associated file signature details as well.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_suspicious_zoom_child_process.toml"}
{"title": "Unusual Executable File Creation by a System Critical Process", "description": "Identifies an unexpected executable file being created or modified by a Windows system critical process, which may\nindicate activity related to remote code execution or other forms of exploitation.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : (\"exe\", \"dll\") and\n  process.name : (\"smss.exe\",\n                  \"autochk.exe\",\n                  \"csrss.exe\",\n                  \"wininit.exe\",\n                  \"services.exe\",\n                  \"lsass.exe\",\n                  \"winlogon.exe\",\n                  \"userinit.exe\",\n                  \"LogonUI.exe\")", "tactic": "Defense Evasion", "technique": "Exploitation for Defense Evasion", "technique_id": "T1211", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_system_critical_proc_abnormal_file_activity.toml"}
{"title": "File Creation Time Changed", "description": "Identifies modification of a file creation time. Adversaries may modify file time attributes to blend malicious content\nwith existing files. Timestomping is a technique that modifies the timestamps of a file often to mimic files that are in\ntrusted directories.", "query": "file where host.os.type == \"windows\" and\n  event.provider == \"Microsoft-Windows-Sysmon\" and\n  /* File creation time change */\n  event.code == \"2\" and\n  not process.executable :\n           (\"?:\\\\Program Files\\\\*\",\n            \"?:\\\\Program Files (x86)\\\\*\",\n            \"?:\\\\Windows\\\\system32\\\\cleanmgr.exe\",\n            \"?:\\\\Windows\\\\system32\\\\msiexec.exe\",\n            \"?:\\\\Windows\\\\syswow64\\\\msiexec.exe\",\n            \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n            \"?:\\\\WINDOWS\\\\system32\\\\backgroundTaskHost.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\app-*\\\\slack.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\GitHubDesktop\\\\app-*\\\\GitHubDesktop.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\") and\n  not file.extension : (\"temp\", \"tmp\", \"~tmp\", \"xml\", \"newcfg\") and not user.name : (\"SYSTEM\", \"Local Service\", \"Network Service\") and\n  not file.name : (\"LOG\", \"temp-index\", \"license.rtf\", \"iconcache_*.db\")", "tactic": "Defense Evasion", "technique": "Indicator Removal", "technique_id": "T1070", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_timestomp_sysmon.toml"}
{"title": "Unsigned DLL Side-Loading from a Suspicious Folder", "description": "Identifies a Windows trusted program running from locations often abused by adversaries to masquerade as a trusted\nprogram and loading a recently dropped DLL. This behavior may indicate an attempt to evade defenses via side-loading a\nmalicious DLL within the memory space of a signed processes.", "query": "library where host.os.type == \"windows\" and\n\n process.code_signature.trusted == true and\n\n (dll.Ext.relative_file_creation_time <= 500 or dll.Ext.relative_file_name_modify_time <= 500) and\n\n  not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\", \"errorChaining\") and\n\n      /* Suspicious Paths */\n      dll.path : (\"?:\\\\PerfLogs\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Pictures\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Music\\\\*.dll\",\n                  \"?:\\\\Users\\\\Public\\\\*.dll\",\n                  \"?:\\\\Users\\\\*\\\\Documents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Windows\\\\System32\\\\Tasks\\\\*.dll\",\n                  \"?:\\\\Intel\\\\*.dll\",\n                  \"?:\\\\AMD\\\\Temp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*.dll\",\n                  \"?:\\\\Windows\\\\security\\\\*.dll\",\n\t\t  \"?:\\\\Windows\\\\System\\\\*.dll\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Branding\\\\*.dll\",\n                  \"?:\\\\Windows\\\\csc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*.dll\",\n                  \"?:\\\\Windows\\\\en-US\\\\*.dll\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*.dll\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*.dll\",\n                  \"?:\\\\Windows\\\\INF\\\\*.dll\",\n                  \"?:\\\\windows\\\\tracing\\\\*.dll\",\n                  \"?:\\\\windows\\\\IME\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Performance\\\\*.dll\",\n                  \"?:\\\\windows\\\\intel\\\\*.dll\",\n                  \"?:\\\\windows\\\\ms\\\\*.dll\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ServiceProfiles\\\\*.dll\",\n                  \"?:\\\\Windows\\\\panther\\\\*.dll\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*.dll\",\n                  \"?:\\\\Windows\\\\OCR\\\\*.dll\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*.dll\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*.dll\",\n                  \"?:\\\\Windows\\\\addins\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Setup\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Help\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SKB\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Vss\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Web\\\\*.dll\",\n                  \"?:\\\\Windows\\\\servicing\\\\*.dll\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Logs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*.dll\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PLA\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Migration\\\\*.dll\",\n                  \"?:\\\\Windows\\\\debug\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Containers\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Boot\\\\*.dll\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*.dll\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*.dll\",\n                  \"?:\\\\Windows\\\\schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Resources\\\\*.dll\",\n                  \"?:\\\\Windows\\\\rescache\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*.dll\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.dll\",\n                  \"?:\\\\Windows\\\\media\\\\*.dll\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*.dll\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*.dll\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*.dll\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.dll\",\n                  \"?:\\\\$Recycle.Bin\\\\*.dll\") and\n\n\t /* DLL loaded from the process.executable current directory */\n\t endswith~(substring(dll.path, 0, length(dll.path) - (length(dll.name) + 1)), substring(process.executable, 0, length(process.executable) - (length(process.name) + 1)))", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unsigned_dll_loaded_from_suspdir.toml"}
{"title": "Untrusted Driver Loaded", "description": "Identifies attempt to load an untrusted driver. Adversaries may modify code signing policies to enable execution of\nunsigned or self-signed code.", "query": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  dll.code_signature.trusted != true and \n  not dll.code_signature.status : (\"errorExpired\", \"errorRevoked\", \"errorCode_endpoint:*\")", "tactic": "Defense Evasion", "technique": "Masquerading", "technique_id": "T1036", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_untrusted_driver_loaded.toml"}
{"title": "Unusual File Creation - Alternate Data Stream", "description": "Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate files\nand sometimes done by adversaries to hide malware.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n\n  file.path : \"C:\\\\*:*\" and\n  not file.path : \n          (\"C:\\\\*:zone.identifier*\",\n           \"C:\\\\users\\\\*\\\\appdata\\\\roaming\\\\microsoft\\\\teams\\\\old_weblogs_*:$DATA\",\n           \"C:\\\\Windows\\\\CSC\\\\*:CscBitmapStream\") and\n\n  not process.executable : (\n          \"?:\\\\Program Files (x86)\\\\Dropbox\\\\Client\\\\Dropbox.exe\",\n          \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n          \"?:\\\\Program Files\\\\ExpressConnect\\\\ExpressConnectNetworkService.exe\",\n          \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n          \"?:\\\\Program Files\\\\Windows Defender Advanced Threat Protection\\\\MsSense.exe\",\n          \"?:\\\\Program Files\\\\Rivet Networks\\\\SmartByte\\\\SmartByteNetworkService.exe\",\n          \"?:\\\\Windows\\\\explorer.exe\",\n          \"?:\\\\Windows\\\\System32\\\\DataExchangeHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\Intel\\\\ICPS\\\\IntelConnectivityNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\RivetNetworks\\\\Killer\\\\KillerNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n          \"?:\\\\Windows\\\\System32\\\\PickerHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\SearchProtocolHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\sihost.exe\",\n          \"?:\\\\windows\\\\System32\\\\svchost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WFS.exe\"\n  ) and\n\n  file.extension :\n    (\n      \"pdf\", \"dll\", \"exe\", \"dat\", \"com\", \"bat\", \"cmd\", \"sys\", \"vbs\", \"ps1\", \"hta\", \"txt\", \"vbe\", \"js\",\n      \"wsh\", \"docx\", \"doc\", \"xlsx\", \"xls\", \"pptx\", \"ppt\", \"rtf\", \"gif\", \"jpg\", \"png\", \"bmp\", \"img\", \"iso\"\n    )", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_ads_file_creation.toml"}
{"title": "Unusual Process Execution Path - Alternate Data Stream", "description": "Identifies processes running from an Alternate Data Stream. This is uncommon for legitimate processes and sometimes done\nby adversaries to hide malware.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"?:\\\\*:*\" and process.args_count == 1", "tactic": "Defense Evasion", "technique": "Hide Artifacts", "technique_id": "T1564", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_dir_ads.toml"}
{"title": "Unusual Network Connection via DllHost", "description": "Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Command\nand Control activity.", "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"dllhost.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n    \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n    \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n    \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n    \"FF00::/8\")]", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_network_connection_via_dllhost.toml"}
{"title": "Unusual Network Connection via RunDLL32", "description": "Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Command\nand Control activity.", "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"rundll32.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"rundll32.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_network_connection_via_rundll32.toml"}
{"title": "Unusual Process Network Connection", "description": "Identifies network activity from unexpected system applications. This may indicate adversarial activity as these\napplications are often leveraged by adversaries to execute code and evade detection.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\") and\n     event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\")]", "tactic": "Defense Evasion", "technique": "Trusted Developer Utilities Proxy Execution", "technique_id": "T1127", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_process_network_connection.toml"}
{"title": "Unusual Child Process from a System Virtual Process", "description": "Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.pid == 4 and process.executable : \"?*\" and\n  not process.executable : (\"Registry\", \"MemCompression\", \"?:\\\\Windows\\\\System32\\\\smss.exe\")", "tactic": "Defense Evasion", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_unusual_system_vp_child_program.toml"}
{"title": "Potential Evasion via Filter Manager", "description": "The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evade\ndefenses.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"fltMC.exe\" and process.args : \"unload\" and\n  not process.parent.executable : \n                   (\"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\DCFAService64.exe\", \n                    \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\installer\\\\installer.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Endpoint Security\\\\EPSecurityService.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Bitdefender Security\\\\productcfg.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\Bitdefender Security\\\\bdservicehost.exe\", \n                    \"?:\\\\Program Files\\\\Bitdefender\\\\EndpointSetupInformation\\\\{*}\\\\Installer.exe\")", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_via_filter_manager.toml"}
{"title": "WDAC Policy File by an Unusual Process", "description": "Identifies the creation of a Windows Defender Application Control (WDAC) policy file by an unusual process. Adversaries\nmay use a secially crafted WDAC policy to restrict the execution of security products.", "query": "file where host.os.type == \"windows\" and event.action != \"deletion\" and\n file.path : (\"?:\\\\Windows\\\\System32\\\\CodeIntegrity\\\\*.p7b\", \"?:\\\\Windows\\\\System32\\\\CodeIntegrity\\\\CiPolicies\\\\Active\\\\*.cip\") and\n not process.executable : \"C:\\\\Windows\\\\System32\\\\poqexec.exe\"", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wdac_policy_by_unusual_process.toml"}
{"title": "Potential Evasion via Windows Filtering Platform", "description": "Identifies multiple Windows Filtering Platform block events and where the process name is related to an endpoint\nsecurity software. Adversaries may add malicious WFP rules to prevent Endpoint security from sending telemetry.", "query": "sequence by winlog.computer_name with maxspan=1m\n [network where host.os.type == \"windows\" and\n  event.action : (\"windows-firewall-packet-block\", \"windows-firewall-packet-drop\") and\n  process.name : (\n        \"bdagent.exe\", \"bdreinit.exe\", \"pdscan.exe\", \"pdiface.exe\", \"BDSubWiz.exe\", \"ProductAgentService.exe\",\n        \"ProductAgentUI.exe\", \"WatchDog.exe\", \"CarbonBlackClientSetup.exe\", \"TrGUI.exe\", \"TracCAPI.exe\", \"cpmsi_tool.exe\",\n        \"trac.exe\", \"vna_install64.exe\", \"vna_utils.exe\", \"TracSrvWrapper.exe\", \"vsmon.exe\", \"p95tray.exe\",\n        \"CybereasonRansomFreeServiceHost.exe\", \"CrAmTray.exe\", \"minionhost.exe\", \"CybereasonSensor.exe\", \"CylanceUI.exe\",\n        \"CylanceProtectSetup.exe\", \"cylancesvc.exe\", \"cyupdate.exe\", \"elastic-agent.exe\", \"elastic-endpoint.exe\",\n        \"egui.exe\", \"minodlogin.exe\", \"emu-rep.exe\", \"emu_install.exe\", \"emu-cci.exe\", \"emu-gui.exe\", \"emu-uninstall.exe\",\n        \"ndep.exe\", \"spike.exe\", \"ecls.exe\", \"ecmd.exe\", \"ecomserver.exe\", \"eeclnt.exe\", \"eh64.exe\", \"EHttpSrv.exe\",\n        \"xagt.exe\", \"collectoragent.exe\", \"FSAEConfig.exe\", \"uninstalldcagent.exe\", \"rmon.exe\", \"fccomint.exe\",\n        \"fclanguageselector.exe\", \"fortifw.exe\", \"fcreg.exe\", \"fortitray.exe\", \"fcappdb.exe\", \"fcwizard.exe\", \"submitv.exe\",\n        \"av_task.exe\", \"fortiwf.exe\", \"fortiwadbd.exe\", \"fcauth.exe\", \"fcdblog.exe\", \"fcmgr.exe\", \"fortiwad.exe\",\n        \"fortiproxy.exe\", \"fortiscand.exe\", \"fortivpnst.exe\", \"ipsec.exe\", \"fcwscd7.exe\", \"fcasc.exe\", \"fchelper.exe\",\n        \"forticlient.exe\",\"fcwsc.exe\", \"FortiClient.exe\", \"fmon.exe\", \"FSSOMA.exe\", \"FCVbltScan.exe\", \"FortiESNAC.exe\",\n        \"EPCUserAvatar.exe\", \"FortiAvatar.exe\", \"FortiClient_Diagnostic_Tool.exe\", \"FortiSSLVPNdaemon.exe\", \"avp.exe\",\n        \"FCConfig.exe\", \"avpsus.exe\", \"klnagent.exe\", \"klnsacwsrv.exe\", \"kl_platf.exe\", \"stpass.exe\", \"klnagwds.exe\",\n        \"mbae.exe\", \"mbae64.exe\", \"mbae-svc.exe\", \"mbae-uninstaller.exe\", \"mbaeLoader32.exe\", \"mbaeloader64.exe\",\n        \"mbam-dor.exe\", \"mbamgui.exe\", \"mbamservice.exe\", \"mbamtrayctrl.exe\", \"mbampt.exe\", \"mbamscheduler.exe\",\n        \"Coreinst.exe\", \"mbae-setup.exe\", \"mcupdate.exe\", \"ProtectedModuleHost.exe\", \"ESConfigTool.exe\", \"FWInstCheck.exe\",\n        \"FwWindowsFirewallHandler.exe\", \"mfeesp.exe\", \"mfefw.exe\", \"mfeProvisionModeUtility.exe\", \"mfetp.exe\", \"avpui.exe\",\n        \"WscAVExe.exe\", \"mcshield.exe\", \"McChHost.exe\", \"mfewc.exe\", \"mfewch.exe\", \"mfewcui.exe\", \"fwinfo.exe\",\n        \"mfecanary.exe\", \"mfefire.exe\", \"mfehidin.exe\", \"mfemms.exe\", \"mfevtps.exe\", \"mmsinfo.exe\", \"vtpinfo.exe\",\n        \"MarSetup.exe\", \"mctray.exe\", \"masvc.exe\", \"macmnsvc.exe\", \"McAPExe.exe\", \"McPvTray.exe\", \"mcods.exe\",\n        \"mcuicnt.exe\", \"mcuihost.exe\", \"xtray.exe\", \"McpService.exe\", \"epefprtrainer.exe\", \"mfeffcoreservice.exe\",\n        \"MfeEpeSvc.exe\", \"qualysagent.exe\", \"QualysProxy.exe\", \"QualysAgentUI.exe\", \"SVRTgui.exe\", \"SVRTcli.exe\",\n        \"SVRTcli.exe\", \"SVRTgui.exe\", \"SCTCleanupService.exe\", \"SVRTservice.exe\", \"native.exe\", \"SCTBootTasks.exe\",\n        \"ALMon.exe\", \"SAA.exe\", \"SUMService.exe\", \"ssp.exe\", \"SCFService.exe\", \"SCFManager.exe\", \"spa.exe\", \"cabarc.exe\",\n        \"sargui.exe\", \"sntpservice.exe\", \"McsClient.exe\", \"McsAgent.exe\", \"McsHeartbeat.exe\", \"SAVAdminService.exe\",\n        \"sav32cli.exe\", \"ForceUpdateAlongSideSGN.exe\", \"SAVCleanupService.exe\", \"SavMain.exe\", \"SavProgress.exe\",\n        \"SavProxy.exe\", \"SavService.exe\", \"swc_service.exe\", \"swi_di.exe\", \"swi_service.exe\", \"swi_filter.exe\",\n        \"ALUpdate.exe\", \"SophosUpdate.exe\", \"ALsvc.exe\", \"SophosAlert.exe\", \"osCheck.exe\", \"N360Downloader.exe\",\n        \"InstWrap.exe\", \"symbos.exe\", \"nss.exe\", \"symcorpui.exe\", \"isPwdSvc.exe\", \"ccsvchst.exe\", \"ntrmv.exe\",\n        \"pccntmon.exe\", \"AosUImanager.exe\", \"NTRTScan.exe\", \"TMAS_OL.exe\", \"TMAS_OLImp.exe\", \"TMAS_OLSentry.exe\",\n        \"ufnavi.exe\", \"Clnrbin.exe\", \"vizorhtmldialog.exe\", \"pwmConsole.exe\", \"PwmSvc.exe\", \"coreServiceShell.exe\",\n        \"ds_agent.exe\", \"SfCtlCom.exe\", \"MBAMHelper.exe\", \"cb.exe\", \"smc.exe\", \"tda.exe\", \"xagtnotif.exe\", \"ekrn.exe\",\n        \"dsa.exe\", \"Notifier.exe\", \"rphcp.exe\", \"lc_sensor.exe\", \"CSFalconService.exe\", \"CSFalconController.exe\",\n        \"SenseSampleUploader.exe\", \"windefend.exe\", \"MSASCui.exe\", \"MSASCuiL.exe\", \"msmpeng.exe\", \"msmpsvc.exe\",\n        \"MsSense.exe\", \"esensor.exe\", \"sentinelone.exe\", \"tmccsf.exe\", \"csfalconcontainer.exe\", \"sensecncproxy.exe\",\n        \"splunk.exe\", \"sysmon.exe\", \"sysmon64.exe\", \"taniumclient.exe\"\n    )] with runs=5", "tactic": "Defense Evasion", "technique": "Impair Defenses", "technique_id": "T1562", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_windows_filtering_platform.toml"}
{"title": "Signed Proxy Execution via MS Work Folders", "description": "Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working\ndirectory. Misuse of Windows Work Folders could indicate malicious activity.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and process.parent.name : \"WorkFolders.exe\" and\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\control.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\control.exe\"\n  )", "tactic": "Defense Evasion", "technique": "System Binary Proxy Execution", "technique_id": "T1218", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_workfolders_control_execution.toml"}
{"title": "Suspicious Execution via Windows Subsystem for Linux", "description": "Detects Linux Bash commands from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to\navoid detection.", "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n  (\n    (\n      (process.executable : \"?:\\\\Windows\\\\System32\\\\bash.exe\" or ?process.pe.original_file_name == \"Bash.exe\") and\n      not process.command_line : (\"bash\", \"bash.exe\")\n    ) or\n    process.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Packages\\\\*\\\\rootfs\\\\usr\\\\bin\\\\bash\" or\n    (\n      process.parent.name : \"wsl.exe\" and process.parent.command_line : \"bash*\" and not process.name : \"wslhost.exe\"\n    ) or\n    (\n      process.name : \"wsl.exe\" and process.args : (\n        \"curl\", \"/etc/shadow\", \"/etc/passwd\", \"cat\", \"--system\", \"root\", \"-e\", \"--exec\", \"bash\", \"/mnt/c/*\"\n      ) and not process.args : (\"wsl-bootstrap\", \"docker-desktop-data\", \"*.vscode-server*\")\n    )\n  ) and\n    not process.parent.executable : (\"?:\\\\Program Files\\\\Docker\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\Docker\\\\*.exe\")", "tactic": "Defense Evasion", "technique": "Indirect Command Execution", "technique_id": "T1202", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wsl_bash_exec.toml"}
{"title": "Execution via Windows Subsystem for Linux", "description": "Detects attempts to execute a program on the host from the Windows Subsystem for Linux. Adversaries may enable and use\nWSL for Linux to avoid detection.", "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : (\"wsl.exe\", \"wslhost.exe\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n  ) and\n  not (\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n      )\n  )", "tactic": "Defense Evasion", "technique": "Indirect Command Execution", "technique_id": "T1202", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wsl_child_process.toml"}
{"title": "Windows Subsystem for Linux Enabled via Dism Utility", "description": "Detects attempts to enable the Windows Subsystem for Linux using Microsoft Dism utility. Adversaries may enable and use\nWSL for Linux to avoid detection.", "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n (process.name : \"Dism.exe\" or ?process.pe.original_file_name == \"DISM.EXE\") and \n process.command_line : \"*Microsoft-Windows-Subsystem-Linux*\"", "tactic": "Defense Evasion", "technique": "Indirect Command Execution", "technique_id": "T1202", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wsl_enabled_via_dism.toml"}
{"title": "Host Files System Changes via Windows Subsystem for Linux", "description": "Detects files creation and modification on the host system from the the Windows Subsystem for Linux. Adversaries may\nenable and use WSL for Linux to avoid detection.", "query": "sequence by process.entity_id with maxspan=5m\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"dllhost.exe\" and\n   /* Plan9FileSystem CLSID - WSL Host File System Worker */\n  process.command_line : \"*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*\"]\n [file where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and not file.path : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\"]", "tactic": "Defense Evasion", "technique": "Indirect Command Execution", "technique_id": "T1202", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wsl_filesystem.toml"}
{"title": "Attempt to Install Kali Linux via WSL", "description": "Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for\nLinux to avoid detection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.name : \"wsl.exe\" and process.args : (\"-d\", \"--distribution\", \"-i\", \"--install\") and process.args : \"kali*\") or\n  process.executable : (\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"?:\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\"\n  )\n)", "tactic": "Defense Evasion", "technique": "Indirect Command Execution", "technique_id": "T1202", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wsl_kalilinux.toml"}
{"title": "Windows Subsystem for Linux Distribution Installed", "description": "Detects changes to the registry that indicates the install of a new Windows Subsystem for Linux distribution by name.\nAdversaries may enable and use WSL for Linux to avoid detection.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"PackageFamilyName\" and\n registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Lxss\\\\*\\\\PackageFamilyName\"", "tactic": "Defense Evasion", "technique": "Modify Registry", "technique_id": "T1112", "risk_score": "N/A", "tags": [], "references": [], "file": "defense_evasion_wsl_registry_modification.toml"}
{"title": "Potential Enumeration via Active Directory Web Service", "description": "Identifies processes loading Active Directory related modules followed by a network connection to the ADWS dedicated TCP\nport. Adversaries may abuse the ADWS Windows service that allows Active Directory to be queried via this web service.", "query": "sequence by process.entity_id with maxspan=3m\n [library where host.os.type == \"windows\" and\n  dll.name : (\"System.DirectoryServices*.dll\", \"System.IdentityModel*.dll\") and\n  not user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  not process.executable :\n                (\"?:\\\\windows\\\\system32\\\\dsac.exe\",\n                 \"?:\\\\program files\\\\powershell\\\\?\\\\pwsh.exe\",\n                 \"?:\\\\windows\\\\system32\\\\windowspowershell\\\\*.exe\",\n                 \"?:\\\\windows\\\\syswow64\\\\windowspowershell\\\\*.exe\",\n                 \"?:\\\\program files\\\\microsoft monitoring agent\\\\*.exe\",\n                 \"?:\\\\windows\\\\adws\\\\microsoft.activedirectory.webservices.exe\")]\n [network where host.os.type == \"windows\" and destination.port == 9389 and source.port >= 49152 and\n  network.direction == \"egress\" and network.transport == \"tcp\" and not cidrmatch(destination.ip, \"127.0.0.0/8\", \"::1/128\")]", "tactic": "Discovery", "technique": "Remote System Discovery", "technique_id": "T1018", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_active_directory_webservice.toml"}
{"title": "AdFind Command Activity", "description": "This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequently\nleveraged by threat actors to perform post-exploitation Active Directory reconnaissance. The AdFind tool has been\nobserved in Trickbot, Ryuk, Maze, and FIN6 campaigns. For Winlogbeat, this rule requires Sysmon.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"AdFind*.exe\" or ?process.pe.original_file_name == \"AdFind.exe\") and\n  process.args : (\"objectcategory=computer\", \"(objectcategory=computer)\",\n                  \"objectcategory=person\", \"(objectcategory=person)\",\n                  \"objectcategory=subnet\", \"(objectcategory=subnet)\",\n                  \"objectcategory=group\", \"(objectcategory=group)\",\n                  \"objectcategory=organizationalunit\", \"(objectcategory=organizationalunit)\",\n                  \"objectcategory=attributeschema\", \"(objectcategory=attributeschema)\",\n                  \"domainlist\", \"dcmodes\", \"adinfo\", \"dclist\", \"computers_pwnotreqd\", \"trustdmp\")", "tactic": "Discovery", "technique": "System Network Configuration Discovery", "technique_id": "T1016", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_adfind_command_activity.toml"}
{"title": "Enumeration of Administrator Accounts", "description": "Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windows\ntools.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      (process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or\n      ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and not process.parent.name : \"net.exe\")\n    ) and\n    process.args : (\"group\", \"user\", \"localgroup\") and\n    process.args : (\"*admin*\", \"Domain Admins\", \"Remote Desktop Users\", \"Enterprise Admins\", \"Organization Management\")\n    and not process.args : (\"/add\", \"/delete\")\n  ) or\n  (\n    (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n    process.args : (\"group\", \"useraccount\")\n  )\n) and not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")", "tactic": "Discovery", "technique": "Permission Groups Discovery", "technique_id": "T1069", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_admin_recon.toml"}
{"title": "Enumerating Domain Trusts via DSQUERY.EXE", "description": "Identifies the use of dsquery.exe for domain trust discovery purposes. Adversaries may use this command-line utility to\nenumerate trust relationships that may be used for Lateral Movement opportunities in Windows multi-domain forest\nenvironments.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"dsquery.exe\" or ?process.pe.original_file_name: \"dsquery.exe\") and \n    process.args : \"*objectClass=trustedDomain*\"", "tactic": "Discovery", "technique": "Remote System Discovery", "technique_id": "T1018", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_enumerating_domain_trusts_via_dsquery.toml"}
{"title": "Enumerating Domain Trusts via NLTEST.EXE", "description": "Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to\nenumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC)\nreplication in a Microsoft Windows NT Domain.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.name : \"nltest.exe\" and process.args : (\n        \"/DCLIST:*\", \"/DCNAME:*\", \"/DSGET*\",\n        \"/LSAQUERYFTI:*\", \"/PARENTDOMAIN\",\n        \"/DOMAIN_TRUSTS\", \"/BDC_QUERY:*\"\n        ) and \nnot process.parent.name : \"PDQInventoryScanner.exe\" and\nnot (\n  user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  /* Don't apply the user.id exclusion to Sysmon for compatibility */\n  not event.dataset : (\"windows.sysmon_operational\", \"windows.sysmon\")\n)", "tactic": "Discovery", "technique": "Remote System Discovery", "technique_id": "T1018", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_enumerating_domain_trusts_via_nltest.toml"}
{"title": "Group Policy Discovery via Microsoft GPResult Utility", "description": "Detects the usage of gpresult.exe to query group policy objects. Attackers may query group policy objects during the\nreconnaissance phase after compromising a system to gain a better understanding of the active directory environment and\npossible methods to escalate privileges or move laterally.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(process.name: \"gpresult.exe\" or ?process.pe.original_file_name == \"gprslt.exe\") and process.args: (\"/z\", \"/v\", \"/r\", \"/x\")", "tactic": "Discovery", "technique": "Group Policy Discovery", "technique_id": "T1615", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_group_policy_object_discovery.toml"}
{"title": "Suspicious Access to LDAP Attributes", "description": "Identify read access to a high number of Active Directory object attributes. The knowledge of objects properties can\nhelp adversaries find vulnerabilities, elevate privileges or collect sensitive information.", "query": "any where event.code == \"4662\" and not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n winlog.event_data.AccessMaskDescription == \"Read Property\" and length(winlog.event_data.Properties) >= 2000", "tactic": "Discovery", "technique": "Permission Groups Discovery", "technique_id": "T1069", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_high_number_ad_properties.toml"}
{"title": "Peripheral Device Discovery", "description": "Identifies use of the Windows file system utility (fsutil.exe) to gather information about attached peripheral devices\nand components connected to a computer system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"fsinfo\" and process.args : \"drives\"", "tactic": "Discovery", "technique": "Peripheral Device Discovery", "technique_id": "T1120", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_peripheral_device.toml"}
{"title": "PowerShell Share Enumeration Script", "description": "Detects scripts that contain PowerShell functions, structures, or Windows API functions related to windows share\nenumeration activities. Attackers, mainly ransomware groups, commonly identify and inspect network shares, looking for\ncritical information for encryption and/or exfiltration.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"Invoke-ShareFinder\" or\n    \"Invoke-ShareFinderThreaded\" or\n    (\n      \"shi1_netname\" and\n      \"shi1_remark\"\n    ) or\n    (\n      \"NetShareEnum\" and\n      \"NetApiBufferFree\"\n    )\n  ) and not user.id : \"S-1-5-18\"", "tactic": "Discovery", "technique": "Network Share Discovery", "technique_id": "T1135", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_posh_invoke_sharefinder.toml"}
{"title": "PowerShell Suspicious Discovery Related Windows API Functions", "description": "This rule detects the use of discovery-related Windows API functions in PowerShell Scripts. Attackers can use these\nfunctions to perform various situational awareness related activities, like enumerating users, shares, sessions, domain\ntrusts, groups, etc.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    NetShareEnum or\n    NetWkstaUserEnum or\n    NetSessionEnum or\n    NetLocalGroupEnum or\n    NetLocalGroupGetMembers or\n    DsGetSiteName or\n    DsEnumerateDomainTrusts or\n    WTSEnumerateSessionsEx or\n    WTSQuerySessionInformation or\n    LsaGetLogonSessionData or\n    QueryServiceObjectSecurity or\n    GetComputerNameEx or\n    NetWkstaGetInfo or\n    GetUserNameEx or\n    NetUserEnum or\n    NetUserGetInfo or\n    NetGroupEnum or\n    NetGroupGetInfo or\n    NetGroupGetUsers or\n    NetWkstaTransportEnum or\n    NetServerGetInfo or\n    LsaEnumerateTrustedDomains  or\n    NetScheduleJobEnum or\n    NetUserModalsGet\n  ) and\n  not powershell.file.script_block_text : (\n    (\"DsGetSiteName\" and (\"DiscoverWindowsComputerProperties.ps1\" and \"param($SourceType, $SourceId, $ManagedEntityId, $ComputerIdentity)\")) or\n    (\"# Copyright: (c) 2018, Ansible Project\" and \"#Requires -Module Ansible.ModuleUtils.AddType\" and \"#AnsibleRequires -CSharpUtil Ansible.Basic\") or\n    (\"Ansible.Windows.Setup\" and \"Ansible.Windows.Setup\" and \"NativeMethods.NetWkstaGetInfo(null, 100, out netBuffer);\")\n  )", "tactic": "Discovery", "technique": "Permission Groups Discovery", "technique_id": "T1069", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_posh_suspicious_api_functions.toml"}
{"title": "Enumeration of Privileged Local Groups Membership", "description": "Identifies instances of an unusual process enumerating built-in Windows privileged local groups membership like\nAdministrators or Remote Desktop users.", "query": "host.os.type:windows and event.category:iam and event.action:user-member-enumerated and\n  (\n    group.name:(*Admin* or \"RemoteDesktopUsers\") or\n    winlog.event_data.TargetSid:(\"S-1-5-32-544\" or \"S-1-5-32-555\")\n  ) and \n  not (\n    winlog.event_data.SubjectUserName: *$ or\n    winlog.event_data.SubjectUserSid: (\"S-1-5-19\" or \"S-1-5-20\") or \n    winlog.event_data.CallerProcessName:(\"-\" or \n                                       C\\:\\\\Windows\\\\System32\\\\VSSVC.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\SearchIndexer.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\CompatTelRunner.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\oobe\\\\msoobe.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\net1.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\svchost.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\Netplwiz.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\msiexec.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\CloudExperienceHostBroker.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\RuntimeBroker.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\SrTasks.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\diskshadow.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\dfsrs.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\vssadmin.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\dllhost.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\mmc.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\SettingSyncHost.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\wsmprovhost.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\mstsc.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\esentutl.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\RecoveryDrive.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe or\n                                       C\\:\\\\Windows\\\\SysWOW64\\\\msiexec.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\taskhostw.exe or\n                                       C\\:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe or\n                                       C\\:\\\\Windows\\\\Temp\\\\rubrik_vmware*\\\\snaptool.exe or\n                                       C\\:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe or\n                                       C\\:\\\\WindowsAzure\\\\*WaAppAgent.exe or\n                                       C\\:\\\\$WINDOWS.~BT\\\\Sources\\\\*.exe\n                                      )\n  )", "tactic": "Discovery", "technique": "Permission Groups Discovery", "technique_id": "T1069", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_privileged_localgroup_membership.toml"}
{"title": "Unusual Discovery Signal Alert with Unusual Process Command Line", "description": "This rule leverages alert data from various Discovery building block rules to alert on signals with unusual unique\nhost.id, user.id and process.command_line entries.", "query": "host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:(\n  \"d68e95ad-1c82-4074-a12a-125fe10ac8ba\" or \"7b8bfc26-81d2-435e-965c-d722ee397ef1\" or\n  \"0635c542-1b96-4335-9b47-126582d2c19a\" or \"6ea55c81-e2ba-42f2-a134-bccf857ba922\" or\n  \"e0881d20-54ac-457f-8733-fe0bc5d44c55\" or \"06568a02-af29-4f20-929c-f3af281e41aa\" or\n  \"c4e9ed3e-55a2-4309-a012-bc3c78dad10a\" or \"51176ed2-2d90-49f2-9f3d-17196428b169\"\n)", "tactic": "Discovery", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_signal_unusual_discovery_signal_proc_cmdline.toml"}
{"title": "Unusual Discovery Signal Alert with Unusual Process Executable", "description": "This rule leverages Discovery building block rule alert data to alert on signals with unusual unique host.id, user.id\nand process.executable entries.", "query": "host.os.type:windows and event.kind:signal and kibana.alert.rule.rule_id:\"1d72d014-e2ab-4707-b056-9b96abe7b511\"", "tactic": "Discovery", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_signal_unusual_discovery_signal_proc_executable.toml"}
{"title": "Whoami Process Activity", "description": "Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who is\ncurrently logged on to the local system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"whoami.exe\" and\n(\n  (\n    /* scoped for whoami execution under system privileges */\n    (\n      (\n        user.domain : (\"NT *\", \"* NT\", \"IIS APPPOOL\") and\n        user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\", \"S-1-5-82-*\") and\n        not ?winlog.event_data.SubjectUserName : \"*$\" and\n\n        /* Sysmon will always populate user.id as S-1-5-18, leading to FPs */\n        not event.dataset : (\"windows.sysmon_operational\", \"windows.sysmon\")\n      ) or\n      (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n    ) and\n    not (\n      process.parent.name : \"cmd.exe\" and\n      process.parent.args : (\n          \"chcp 437>nul 2>&1 & C:\\\\WINDOWS\\\\System32\\\\whoami.exe  /groups\",\n          \"chcp 437>nul 2>&1 & %systemroot%\\\\system32\\\\whoami /user\",\n          \"C:\\\\WINDOWS\\\\System32\\\\whoami.exe /groups\",\n          \"*WINDOWS\\\\system32\\\\config\\\\systemprofile*\"\n      )\n    ) and\n    not (process.parent.executable : \"C:\\\\Windows\\\\system32\\\\inetsrv\\\\appcmd.exe\" and process.parent.args : \"LIST\") and\n    not process.parent.executable : (\n        \"C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\MonitoringHost.exe\",\n        \"C:\\\\Program Files\\\\Cohesity\\\\cohesity_windows_agent_service.exe\"\n    )\n  ) or\n  process.parent.name : (\"wsmprovhost.exe\", \"w3wp.exe\", \"wmiprvse.exe\", \"rundll32.exe\", \"regsvr32.exe\")\n)", "tactic": "Discovery", "technique": "System Owner/User Discovery", "technique_id": "T1033", "risk_score": "N/A", "tags": [], "references": [], "file": "discovery_whoami_command_activity.toml"}
{"title": "Command Execution via SolarWinds Process", "description": "A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name: (\"cmd.exe\", \"powershell.exe\") and\nprocess.parent.name: (\n     \"ConfigurationWizard*.exe\",\n     \"NetflowDatabaseMaintenance*.exe\",\n     \"NetFlowService*.exe\",\n     \"SolarWinds.Administration*.exe\",\n     \"SolarWinds.Collector.Service*.exe\",\n     \"SolarwindsDiagnostics*.exe\"\n     )", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_apt_solarwinds_backdoor_child_cmd_powershell.toml"}
{"title": "Suspicious SolarWinds Child Process", "description": "A suspicious SolarWinds child process was detected, which may indicate an attempt to execute malicious programs.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name: (\"SolarWinds.BusinessLayerHost.exe\", \"SolarWinds.BusinessLayerHostx64.exe\") and\n not (\n    process.name : (\n        \"APMServiceControl*.exe\",\n        \"ExportToPDFCmd*.Exe\",\n        \"SolarWinds.Credentials.Orion.WebApi*.exe\",\n        \"SolarWinds.Orion.Topology.Calculator*.exe\",\n        \"Database-Maint.exe\",\n        \"SolarWinds.Orion.ApiPoller.Service.exe\",\n        \"WerFault.exe\",\n        \"WerMgr.exe\",\n        \"SolarWinds.BusinessLayerHost.exe\",\n        \"SolarWinds.BusinessLayerHostx64.exe\",\n        \"SolarWinds.Topology.Calculator.exe\",\n        \"SolarWinds.Topology.Calculatorx64.exe\",\n        \"SolarWinds.APM.RealTimeProcessPoller.exe\") and\n    process.code_signature.trusted == true\n ) and\n not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\ARP.EXE\", \"?:\\\\Windows\\\\SysWOW64\\\\lodctr.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\unlodctr.exe\")", "tactic": "Execution", "technique": "Native API", "technique_id": "T1106", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_apt_solarwinds_backdoor_unusual_child_processes.toml"}
{"title": "Command Prompt Network Connection", "description": "Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from a\nremote URL.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"cmd.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"cmd.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                  \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                  \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                  \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                  \"FE80::/10\", \"FF00::/8\") and\n    not dns.question.name : (\n          \"wpad\", \"localhost\", \"ocsp.comodoca.com\", \"ocsp.digicert.com\", \"ocsp.sectigo.com\", \"crl.comodoca.com\"\n    )]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_command_prompt_connecting_to_the_internet.toml"}
{"title": "Svchost spawning Cmd", "description": "Identifies a suspicious parent child process relationship with cmd.exe descending from svchost.exe", "query": "host.os.type:windows and event.category:process and event.type:start and process.parent.name:\"svchost.exe\" and\nprocess.name:(\"cmd.exe\" or \"Cmd.exe\" or \"CMD.EXE\") and\nnot process.command_line : \"\\\"cmd.exe\\\" /C sc control hptpsmarthealthservice 211\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_command_shell_started_by_svchost.toml"}
{"title": "Unusual Parent Process for cmd.exe", "description": "Identifies a suspicious parent child process relationship with cmd.exe descending from an unusual process.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and\n  process.parent.name : (\"lsass.exe\",\n                         \"csrss.exe\",\n                         \"epad.exe\",\n                         \"regsvr32.exe\",\n                         \"dllhost.exe\",\n                         \"LogonUI.exe\",\n                         \"wermgr.exe\",\n                         \"spoolsv.exe\",\n                         \"jucheck.exe\",\n                         \"jusched.exe\",\n                         \"ctfmon.exe\",\n                         \"taskhostw.exe\",\n                         \"GoogleUpdate.exe\",\n                         \"sppsvc.exe\",\n                         \"sihost.exe\",\n                         \"slui.exe\",\n                         \"SIHClient.exe\",\n                         \"SearchIndexer.exe\",\n                         \"SearchProtocolHost.exe\",\n                         \"FlashPlayerUpdateService.exe\",\n                         \"WerFault.exe\",\n                         \"WUDFHost.exe\",\n                         \"unsecapp.exe\",\n                         \"wlanext.exe\" ) and\n  not (process.parent.name : \"dllhost.exe\" and process.parent.args : \"/Processid:{CA8C87C1-929D-45BA-94DB-EF8E6CB346AD}\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_command_shell_started_by_unusual_process.toml"}
{"title": "Command Shell Activity Started via RunDLL32", "description": "Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"cmd.exe\", \"powershell.exe\") and\n  process.parent.name : \"rundll32.exe\" and process.parent.command_line != null and\n  /* common FPs can be added here */\n  not process.parent.args : (\"C:\\\\Windows\\\\System32\\\\SHELL32.dll,RunAsNewUser_RunDLL\",\n                             \"C:\\\\WINDOWS\\\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_command_shell_via_rundll32.toml"}
{"title": "Execution of COM object via Xwizard", "description": "Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows application\nprogramming interface (API) that enables interaction between software objects or executable code. Xwizard can be used to\nrun a COM object created in registry to evade defensive counter measures.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"xwizard.exe\" or ?process.pe.original_file_name : \"xwizard.exe\") and\n (\n   (process.args : \"RunWizard\" and process.args : \"{*}\") or\n   (process.executable != null and\n     not process.executable : (\n        \"C:\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"C:\\\\Windows\\\\System32\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\xwizard.exe\"\n     )\n   )\n )", "tactic": "Execution", "technique": "Inter-Process Communication", "technique_id": "T1559", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_com_object_xwizard.toml"}
{"title": "Delayed Execution via Ping", "description": "Identifies the execution of commonly abused Windows utilities via a delayed Ping execution. This behavior is often\nobserved during malware installation and is consistent with an attacker attempting to evade detection.", "query": "sequence by process.parent.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.action == \"start\" and process.name : \"ping.exe\" and\n   process.args : \"-n\" and process.parent.name : \"cmd.exe\" and not user.id : \"S-1-5-18\"]\n  [process where host.os.type == \"windows\" and event.action == \"start\" and\n   process.parent.name : \"cmd.exe\" and\n   (\n        process.name : (\n            \"rundll32.exe\", \"powershell.exe\",\n            \"mshta.exe\", \"msbuild.exe\",\n            \"certutil.exe\", \"regsvr32.exe\",\n            \"powershell.exe\", \"cscript.exe\",\n            \"wscript.exe\", \"wmic.exe\",\n            \"installutil.exe\", \"msxsl.exe\",\n            \"Microsoft.Workflow.Compiler.exe\",\n            \"ieexec.exe\", \"iexpress.exe\",\n            \"RegAsm.exe\", \"installutil.exe\",\n            \"RegSvcs.exe\", \"RegAsm.exe\"\n        ) or\n        (process.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\*.exe\" and not process.code_signature.trusted == true)\n    ) and\n\n    not process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\") and\n    not (process.name : (\"openssl.exe\", \"httpcfg.exe\", \"certutil.exe\") and process.parent.command_line : \"*ScreenConnectConfigurator.cmd*\") and\n    not (process.pe.original_file_name : \"DPInst.exe\" and process.command_line : \"driver\\\\DPInst_x64  /f \") and\n    not (process.name : \"powershell.exe\" and process.args : \"Write-Host ======*\") and\n    not (process.name : \"wscript.exe\" and process.args : \"launchquiet_args.vbs\" and process.parent.args : \"?:\\\\Windows\\\\TempInst\\\\7z*\") and\n    not (process.name : \"regsvr32.exe\" and process.args : (\"?:\\\\windows\\\\syswow64\\\\msxml?.dll\", \"msxml?.dll\", \"?:\\\\Windows\\\\SysWOW64\\\\mschrt20.ocx\")) and\n    not (process.name : \"wscript.exe\" and\n         process.working_directory :\n                    (\"?:\\\\Windows\\\\TempInst\\\\*\",\n                     \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\BackupBootstrapper\\\\Logs\\\\\",\n                     \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\QBTools\\\\\"))\n    ]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_delayed_via_ping_lolbas_unsigned.toml"}
{"title": "Downloaded Shortcut Files", "description": "Identifies .lnk shortcut file downloaded from outside the local network. These shortcut files are commonly used in\nphishing campaigns.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension == \"lnk\" and file.Ext.windows.zone_identifier > 1", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_downloaded_shortcut_files.toml"}
{"title": "Downloaded URL Files", "description": "Identifies .url shortcut files downloaded from outside the local network. These shortcut files are commonly used in\nphishing campaigns.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension == \"url\"\n   and file.Ext.windows.zone_identifier == 3", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_downloaded_url_file.toml"}
{"title": "Enumeration Command Spawned via WMIPrvSE", "description": "Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation\nProvider Service (WMIPrvSE).", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.command_line != null and\n  process.name:\n  (\n    \"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n    \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\", \"quser.exe\",\n    \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\"\n  ) and\n  process.parent.name:\"wmiprvse.exe\" and\n  not (\n    process.name : \"sc.exe\" and process.args : \"RemoteRegistry\" and process.args : \"start=\" and\n    process.args : (\"demand\", \"disabled\")\n  ) and\n  not process.args : \"tenable_mw_scan\"", "tactic": "Execution", "technique": "Windows Management Instrumentation", "technique_id": "T1047", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_enumeration_via_wmiprvse.toml"}
{"title": "Execution from Unusual Directory - Command Line", "description": "Identifies process execution from suspicious default Windows directories. This may be abused by adversaries to hide\nmalware in trusted paths.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"wscript.exe\",\n                  \"cscript.exe\",\n                  \"rundll32.exe\",\n                  \"regsvr32.exe\",\n                  \"cmstp.exe\",\n                  \"RegAsm.exe\",\n                  \"installutil.exe\",\n                  \"mshta.exe\",\n                  \"RegSvcs.exe\",\n                  \"powershell.exe\",\n                  \"pwsh.exe\",\n                  \"cmd.exe\") and\n\n  /* add suspicious execution paths here */\n  process.args : (\"C:\\\\PerfLogs\\\\*\",\n                  \"C:\\\\Users\\\\Public\\\\*\",\n                  \"C:\\\\Windows\\\\Tasks\\\\*\",\n                  \"C:\\\\Intel\\\\*\",\n                  \"C:\\\\AMD\\\\Temp\\\\*\",\n                  \"C:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"C:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"C:\\\\Windows\\\\Branding\\\\*\",\n                  \"C:\\\\Windows\\\\csc\\\\*\",\n                  \"C:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"C:\\\\Windows\\\\en-US\\\\*\",\n                  \"C:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"C:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"C:\\\\Windows\\\\Fonts\\\\*\",\n                  \"C:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"C:\\\\Windows\\\\TAPI\\\\*\",\n                  \"C:\\\\Windows\\\\INF\\\\*\",\n                  \"C:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"C:\\\\windows\\\\tracing\\\\*\",\n                  \"c:\\\\windows\\\\IME\\\\*\",\n                  \"c:\\\\Windows\\\\Performance\\\\*\",\n                  \"c:\\\\windows\\\\intel\\\\*\",\n                  \"c:\\\\windows\\\\ms\\\\*\",\n                  \"C:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"C:\\\\Windows\\\\panther\\\\*\",\n                  \"C:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"C:\\\\Windows\\\\OCR\\\\*\",\n                  \"C:\\\\Windows\\\\appcompat\\\\*\",\n                  \"C:\\\\Windows\\\\apppatch\\\\*\",\n                  \"C:\\\\Windows\\\\addins\\\\*\",\n                  \"C:\\\\Windows\\\\Setup\\\\*\",\n                  \"C:\\\\Windows\\\\Help\\\\*\",\n                  \"C:\\\\Windows\\\\SKB\\\\*\",\n                  \"C:\\\\Windows\\\\Vss\\\\*\",\n                  \"C:\\\\Windows\\\\servicing\\\\*\",\n                  \"C:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"C:\\\\Windows\\\\Logs\\\\*\",\n                  \"C:\\\\Windows\\\\WaaS\\\\*\",\n                  \"C:\\\\Windows\\\\twain_32\\\\*\",\n                  \"C:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"C:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"C:\\\\Windows\\\\PLA\\\\*\",\n                  \"C:\\\\Windows\\\\Migration\\\\*\",\n                  \"C:\\\\Windows\\\\debug\\\\*\",\n                  \"C:\\\\Windows\\\\Cursors\\\\*\",\n                  \"C:\\\\Windows\\\\Containers\\\\*\",\n                  \"C:\\\\Windows\\\\Boot\\\\*\",\n                  \"C:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"C:\\\\Windows\\\\TextInput\\\\*\",\n                  \"C:\\\\Windows\\\\security\\\\*\",\n                  \"C:\\\\Windows\\\\schemas\\\\*\",\n                  \"C:\\\\Windows\\\\SchCache\\\\*\",\n                  \"C:\\\\Windows\\\\Resources\\\\*\",\n                  \"C:\\\\Windows\\\\rescache\\\\*\",\n                  \"C:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"C:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"C:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"C:\\\\Windows\\\\media\\\\*\",\n                  \"C:\\\\Windows\\\\Globalization\\\\*\",\n                  \"C:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"C:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"C:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"C:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"C:\\\\$Recycle.Bin\\\\*\") and\n\n  /* noisy FP patterns */\n\n  not process.parent.executable : (\"C:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\igfxCUIService*.exe\",\n                                   \"C:\\\\Windows\\\\System32\\\\spacedeskService.exe\",\n                                   \"C:\\\\Program Files\\\\Dell\\\\SupportAssistAgent\\\\SRE\\\\SRE.exe\") and\n  not (process.name : \"rundll32.exe\" and\n       process.args : (\"uxtheme.dll,#64\",\n                       \"PRINTUI.DLL,PrintUIEntry\",\n                       \"?:\\\\Windows\\\\System32\\\\FirewallControlPanel.dll,ShowNotificationDialog\",\n                       \"?:\\\\WINDOWS\\\\system32\\\\Speech\\\\SpeechUX\\\\sapi.cpl\",\n                       \"?:\\\\Windows\\\\system32\\\\shell32.dll,OpenAs_RunDLL\")) and\n\n  not (process.name : \"cscript.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\calluxxprovider.vbs\") and\n\n  not (process.name : \"cmd.exe\" and process.args : \"?:\\\\WINDOWS\\\\system32\\\\powercfg.exe\" and process.args : \"?:\\\\WINDOWS\\\\inf\\\\PowerPlan.log\") and\n\n  not (process.name : \"regsvr32.exe\" and process.args : \"?:\\\\Windows\\\\Help\\\\OEM\\\\scripts\\\\checkmui.dll\") and\n\n  not (process.name : \"cmd.exe\" and\n       process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\oobe\\\\windeploy.exe\",\n                                    \"?:\\\\Program Files (x86)\\\\ossec-agent\\\\wazuh-agent.exe\",\n                                    \"?:\\\\Windows\\\\System32\\\\igfxCUIService.exe\",\n                                    \"?:\\\\Windows\\\\Temp\\\\IE*.tmp\\\\IE*-support\\\\ienrcore.exe\"))", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_from_unusual_path_cmdline.toml"}
{"title": "Network Connection via Compiled HTML File", "description": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal\nmalicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable\nprogram (hh.exe).", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"hh.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"hh.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and\n     not dns.question.name : \"localhost\"]", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_html_help_executable_program_connecting_to_the_internet.toml"}
{"title": "Potential Foxmail Exploitation", "description": "Identifies the Foxmail client spawning a child process with argument pointing to the Foxmail temp directory. This may\nindicate the successful exploitation of a Foxmail vulnerability for initial access and execution via a malicious email.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Foxmail.exe\" and process.args : (\"?:\\\\Users\\\\*\\\\AppData\\\\*\", \"\\\\\\\\*\")", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_initial_access_foxmail_exploit.toml"}
{"title": "Unusual Execution via Microsoft Common Console File", "description": "Identifies the execution of a child process from a Microsoft Common Console file. Adversaries may embed a malicious\ncommand in an MSC file in order to trick victims into executing malicious commands.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.executable : \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and endswith~(process.parent.args, \".msc\") and\n not process.parent.args : (\"?:\\\\Windows\\\\System32\\\\*.msc\", \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\", \"?:\\\\Program files\\\\*.msc\", \"?:\\\\Program Files (x86)\\\\*.msc\")", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_initial_access_via_msc_file.toml"}
{"title": "WPS Office Exploitation via DLL Hijack", "description": "Identifies the load of a remote library by the WPS Office promecefpluginhost.exe executable. This may indicate the\nsuccessful exploitation of CVE-2024-7262 or CVE-2024-7263 via DLL hijack abusing the ksoqing custom protocol handler.", "query": "any where host.os.type == \"windows\" and process.name : \"promecefpluginhost.exe\" and\n(\n (event.category == \"library\" and\n  ?dll.path :\n     (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\wps\\\\INetCache\\\\*\",\n      \"\\\\Device\\\\Mup\\\\**\", \"\\\\\\\\*\")) or\n\n  ((event.category == \"process\" and event.action : \"Image loaded*\") and\n  ?file.path :\n     (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\wps\\\\INetCache\\\\*\",\n      \"\\\\Device\\\\Mup\\\\**\", \"\\\\\\\\*\"))\n)", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_initial_access_wps_dll_exploit.toml"}
{"title": "Mofcomp Activity", "description": "Managed Object Format (MOF) files can be compiled locally or remotely through mofcomp.exe. Attackers may leverage MOF\nfiles to build their own namespaces and classes into the Windows Management Instrumentation (WMI) repository, or\nestablish persistence using WMI Event Subscription.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"mofcomp.exe\" and process.args : \"*.mof\" and\n  not user.id : \"S-1-5-18\" and\n  not\n  (\n    process.parent.name : \"ScenarioEngine.exe\" and\n    process.args : (\n      \"*\\\\MSSQL\\\\Binn\\\\*.mof\",\n      \"*\\\\Microsoft SQL Server\\\\???\\\\Shared\\\\*.mof\",\n      \"*\\\\OLAP\\\\bin\\\\*.mof\"\n    )\n  )", "tactic": "Execution", "technique": "Windows Management Instrumentation", "technique_id": "T1047", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_mofcomp.toml"}
{"title": "Execution of File Written or Modified by Microsoft Office", "description": "Identifies an executable created by a Microsoft Office application and subsequently executed. These processes are often\nlaunched via scripts inside documents or during exploitation of Microsoft Office applications.", "query": "sequence with maxspan=2h\n  [file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"WINWORD.EXE\" or\n      process.name : \"EXCEL.EXE\" or\n      process.name : \"OUTLOOK.EXE\" or\n      process.name : \"POWERPNT.EXE\" or\n      process.name : \"eqnedt32.exe\" or\n      process.name : \"fltldr.exe\" or\n      process.name : \"MSPUB.EXE\" or\n      process.name : \"MSACCESS.EXE\")\n  ] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\" and \n   not (process.name : \"NewOutlookInstaller.exe\" and process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true) and \n   not (process.name : \"ShareFileForOutlook-v*.exe\" and process.code_signature.subject_name : \"Citrix Systems, Inc.\" and process.code_signature.trusted == true)\n  ] by host.id, process.executable", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_ms_office_written_file.toml"}
{"title": "Execution of File Written or Modified by PDF Reader", "description": "Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes are\noften launched via exploitation of PDF applications.", "query": "sequence with maxspan=2h\n  [file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"AcroRd32.exe\" or\n      process.name : \"rdrcef.exe\" or\n      process.name : \"FoxitPhantomPDF.exe\" or\n      process.name : \"FoxitReader.exe\") and\n     not (file.name : \"FoxitPhantomPDF.exe\" or\n          file.name : \"FoxitPhantomPDFUpdater.exe\" or\n          file.name : \"FoxitReader.exe\" or\n          file.name : \"FoxitReaderUpdater.exe\" or\n          file.name : \"AcroRd32.exe\" or\n          file.name : \"rdrcef.exe\")\n  ] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\"] by host.id, process.executable", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_pdf_written_file.toml"}
{"title": "Potential PowerShell HackTool Script by Author", "description": "Detects known PowerShell offensive tooling author's name in PowerShell scripts. Attackers commonly use out-of-the-box\noffensive tools without modifying the code, which may still contain the author artifacts. This rule identifies common\nauthor handles found in popular PowerShell scripts used for red team exercises.", "query": "host.os.type:windows and event.category:process and\n  powershell.file.script_block_text : (\n      \"mattifestation\" or \"JosephBialek\" or\n      \"harmj0y\" or \"ukstufus\" or\n      \"SecureThisShit\" or \"Matthew Graeber\" or\n      \"secabstraction\" or \"mgeeky\" or\n      \"oddvarmoe\" or \"am0nsec\" or\n      \"obscuresec\" or \"sixdub\" or\n      \"darkoperator\" or \"funoverip\" or\n      \"rvrsh3ll\" or \"kevin_robertson\" or\n      \"dafthack\" or \"r4wd3r\" or\n      \"danielhbohannon\" or \"OneLogicalMyth\" or\n      \"cobbr_io\" or \"xorrior\" or\n      \"PetrMedonos\" or \"citronneur\" or\n      \"eladshamir\" or \"RastaMouse\" or\n      \"enigma0x3\" or \"FuzzySec\" or\n      \"424f424f\" or \"jaredhaight\" or\n      \"fullmetalcache\" or \"Hubbl3\" or\n      \"curi0usJack\" or \"Cx01N\" or\n      \"itm4n\" or \"nurfed1\" or\n      \"cfalta\" or \"Scott Sutherland\" or\n      \"_nullbind\" or \"_tmenochet\" or\n      \"jaredcatkinson\" or \"ChrisTruncer\" or\n      \"monoxgas\" or \"TheRealWover\" or\n      \"splinter_code\"\n  )", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_posh_hacktool_authors.toml"}
{"title": "Potential PowerShell HackTool Script by Function Names", "description": "Detects known PowerShell offensive tooling functions names in PowerShell scripts. Attackers commonly use out-of-the-box\noffensive tools without modifying the code. This rule aim is to take advantage of that.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Add-DomainGroupMember\" or \"Add-DomainObjectAcl\" or\n    \"Add-RemoteConnection\" or \"Add-ServiceDacl\" or\n    \"Add-Win32Type\" or \"Convert-ADName\" or\n    \"Convert-LDAPProperty\" or \"ConvertFrom-LDAPLogonHours\" or\n    \"ConvertFrom-UACValue\" or \"Copy-ArrayOfMemAddresses\" or\n    \"Create-NamedPipe\" or \"Create-ProcessWithToken\" or\n    \"Create-RemoteThread\" or \"Create-SuspendedWinLogon\" or\n    \"Create-WinLogonProcess\" or \"Emit-CallThreadStub\" or\n    \"Enable-SeAssignPrimaryTokenPrivilege\" or \"Enable-SeDebugPrivilege\" or\n    \"Enum-AllTokens\" or \"Export-PowerViewCSV\" or\n    \"Find-AVSignature\" or \"Find-AppLockerLog\" or\n    \"Find-DomainLocalGroupMember\" or \"Find-DomainObjectPropertyOutlier\" or\n    \"Find-DomainProcess\" or \"Find-DomainShare\" or\n    \"Find-DomainUserEvent\" or \"Find-DomainUserLocation\" or\n    \"Find-InterestingDomainAcl\" or \"Find-InterestingDomainShareFile\" or\n    \"Find-InterestingFile\" or \"Find-LocalAdminAccess\" or\n    \"Find-PSScriptsInPSAppLog\" or \"Find-PathDLLHijack\" or\n    \"Find-ProcessDLLHijack\" or \"Find-RDPClientConnection\" or\n    \"Get-AllAttributesForClass\" or \"Get-CachedGPPPassword\" or\n    \"Get-DecryptedCpassword\" or \"Get-DecryptedSitelistPassword\" or\n    \"Get-DelegateType\" or \"New-RelayEnumObject\" or\n    \"Get-DomainDFSShare\" or \"Get-DomainDFSShareV1\" or\n    \"Get-DomainDFSShareV2\" or \"Get-DomainDNSRecord\" or\n    \"Get-DomainDNSZone\" or \"Get-DomainFileServer\" or\n    \"Get-DomainForeignGroupMember\" or \"Get-DomainForeignUser\" or\n    \"Get-DomainGPO\" or \"Get-DomainGPOComputerLocalGroupMapping\" or\n    \"Get-DomainGPOLocalGroup\" or \"Get-DomainGPOUserLocalGroupMapping\" or\n    \"Get-DomainGUIDMap\" or \"Get-DomainGroup\" or\n    \"Get-DomainGroupMember\" or \"Get-DomainGroupMemberDeleted\" or\n    \"Get-DomainManagedSecurityGroup\" or \"Get-DomainOU\" or\n    \"Get-DomainObject\" or \"Get-DomainObjectAcl\" or\n    \"Get-DomainObjectAttributeHistory\" or \"Get-DomainObjectLinkedAttributeHistory\" or\n    \"Get-DomainPolicyData\" or \"Get-DomainSID\" or\n    \"Get-DomainSPNTicket\" or \"Get-DomainSearcher\" or\n    \"Get-DomainSite\" or \"Get-DomainSubnet\" or\n    \"Get-DomainTrust\" or \"Get-DomainTrustMapping\" or\n    \"Get-DomainUser\" or \"Get-DomainUserEvent\" or\n    \"Get-Forest\" or \"Get-ForestDomain\" or\n    \"Get-ForestGlobalCatalog\" or \"Get-ForestSchemaClass\" or\n    \"Get-ForestTrust\" or \"Get-GPODelegation\" or\n    \"Get-GPPAutologon\" or \"Get-GPPInnerField\" or\n    \"Get-GPPInnerFields\" or \"Get-GPPPassword\" or\n    \"Get-GptTmpl\" or \"Get-GroupsXML\" or\n    \"Get-HttpStatus\" or \"Get-ImageNtHeaders\" or\n    \"Get-Keystrokes\" or \"New-SOASerialNumberArray\" or\n    \"Get-MemoryProcAddress\" or \"Get-MicrophoneAudio\" or\n    \"Get-ModifiablePath\" or \"Get-ModifiableRegistryAutoRun\" or\n    \"Get-ModifiableScheduledTaskFile\" or \"Get-ModifiableService\" or\n    \"Get-ModifiableServiceFile\" or \"Get-Name\" or\n    \"Get-NetComputerSiteName\" or \"Get-NetLocalGroup\" or\n    \"Get-NetLocalGroupMember\" or \"Get-NetLoggedon\" or\n    \"Get-NetRDPSession\" or \"Get-NetSession\" or\n    \"Get-NetShare\" or \"Get-PEArchitecture\" or\n    \"Get-PEBasicInfo\" or \"Get-PEDetailedInfo\" or\n    \"Get-PathAcl\" or \"Get-PrimaryToken\" or\n    \"Get-ProcAddress\" or \"Get-ProcessTokenGroup\" or\n    \"Get-ProcessTokenPrivilege\" or \"Get-ProcessTokenType\" or\n    \"Get-RegLoggedOn\" or \"Get-RegistryAlwaysInstallElevated\" or\n    \"Get-RegistryAutoLogon\" or \"Get-RemoteProcAddress\" or\n    \"Get-Screenshot\" or \"Get-ServiceDetail\" or\n    \"Get-SiteListPassword\" or \"Get-SitelistField\" or\n    \"Get-System\" or \"Get-SystemNamedPipe\" or\n    \"Get-SystemToken\" or \"Get-ThreadToken\" or\n    \"Get-TimedScreenshot\" or \"Get-TokenInformation\" or\n    \"Get-TopPort\" or \"Get-UnattendedInstallFile\" or\n    \"Get-UniqueTokens\" or \"Get-UnquotedService\" or\n    \"Get-VaultCredential\" or \"Get-VaultElementValue\" or\n    \"Get-VirtualProtectValue\" or \"Get-VolumeShadowCopy\" or\n    \"Get-WMIProcess\" or \"Get-WMIRegCachedRDPConnection\" or\n    \"Get-WMIRegLastLoggedOn\" or \"Get-WMIRegMountedDrive\" or\n    \"Get-WMIRegProxy\" or \"Get-WebConfig\" or\n    \"Get-Win32Constants\" or \"Get-Win32Functions\" or\n    \"Get-Win32Types\" or \"Import-DllImports\" or\n    \"Import-DllInRemoteProcess\" or \"Inject-LocalShellcode\" or\n    \"Inject-RemoteShellcode\" or \"Install-ServiceBinary\" or\n    \"Invoke-CompareAttributesForClass\" or \"Invoke-CreateRemoteThread\" or\n    \"Invoke-CredentialInjection\" or \"Invoke-DllInjection\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-ImpersonateUser\" or\n    \"Invoke-Kerberoast\" or \"Invoke-MemoryFreeLibrary\" or\n    \"Invoke-MemoryLoadLibrary\" or\n    \"Invoke-Mimikatz\" or \"Invoke-NinjaCopy\" or\n    \"Invoke-PatchDll\" or \"Invoke-Portscan\" or\n    \"Invoke-PrivescAudit\" or \"Invoke-ReflectivePEInjection\" or\n    \"Invoke-ReverseDnsLookup\" or \"Invoke-RevertToSelf\" or\n    \"Invoke-ServiceAbuse\" or \"Invoke-Shellcode\" or\n    \"Invoke-TokenManipulation\" or \"Invoke-UserImpersonation\" or\n    \"Invoke-WmiCommand\" or \"Mount-VolumeShadowCopy\" or\n    \"New-ADObjectAccessControlEntry\" or \"New-DomainGroup\" or\n    \"New-DomainUser\" or \"New-DynamicParameter\" or\n    \"New-InMemoryModule\" or\n    \"New-ThreadedFunction\" or \"New-VolumeShadowCopy\" or\n    \"Out-CompressedDll\" or \"Out-EncodedCommand\" or\n    \"Out-EncryptedScript\" or \"Out-Minidump\" or\n    \"PortScan-Alive\" or \"Portscan-Port\" or\n    \"Remove-DomainGroupMember\" or \"Remove-DomainObjectAcl\" or\n    \"Remove-RemoteConnection\" or \"Remove-VolumeShadowCopy\" or\n    \"Restore-ServiceBinary\" or \"Set-DesktopACLToAllowEveryone\" or\n    \"Set-DesktopACLs\" or \"Set-DomainObject\" or\n    \"Set-DomainObjectOwner\" or \"Set-DomainUserPassword\" or\n    \"Set-ServiceBinaryPath\" or \"Sub-SignedIntAsUnsigned\" or\n    \"Test-AdminAccess\" or \"Test-MemoryRangeValid\" or\n    \"Test-ServiceDaclPermission\" or \"Update-ExeFunctions\" or\n    \"Update-MemoryAddresses\" or \"Update-MemoryProtectionFlags\" or\n    \"Write-BytesToMemory\" or \"Write-HijackDll\" or\n    \"Write-PortscanOut\" or \"Write-ServiceBinary\" or\n    \"Write-UserAddMSI\" or \"Invoke-Privesc\" or\n    \"func_get_proc_address\" or \"Invoke-BloodHound\" or\n    \"Invoke-HostEnum\" or \"Get-BrowserInformation\" or\n    \"Get-DomainAccountPolicy\" or \"Get-DomainAdmins\" or\n    \"Get-AVProcesses\" or \"Get-AVInfo\" or\n    \"Get-RecycleBin\" or \"Invoke-BruteForce\" or\n    \"Get-PassHints\" or \"Invoke-SessionGopher\" or\n    \"Get-LSASecret\" or \"Get-PassHashes\" or\n    \"Invoke-WdigestDowngrade\" or \"Get-ChromeDump\" or\n    \"Invoke-DomainPasswordSpray\" or \"Get-FoxDump\" or\n    \"New-HoneyHash\" or \"Invoke-DCSync\" or\n    \"Invoke-PowerDump\" or \"Invoke-SSIDExfil\" or\n    \"Invoke-PowerShellTCP\" or \"Add-Exfiltration\" or\n    \"Do-Exfiltration\" or \"Invoke-DropboxUpload\" or\n    \"Invoke-ExfilDataToGitHub\" or \"Invoke-EgressCheck\" or\n    \"Invoke-PostExfil\" or \"Create-MultipleSessions\" or\n    \"Invoke-NetworkRelay\" or \"New-GPOImmediateTask\" or\n    \"Invoke-WMIDebugger\" or \"Invoke-SQLOSCMD\" or\n    \"Invoke-SMBExec\" or \"Invoke-PSRemoting\" or\n    \"Invoke-ExecuteMSBuild\" or \"Invoke-DCOM\" or\n    \"Invoke-InveighRelay\" or \"Invoke-PsExec\" or\n    \"Invoke-SSHCommand\" or \"Find-ActiveUsersWMI\" or\n    \"Get-SystemDrivesWMI\" or \"Get-ActiveNICSWMI\" or\n    \"Remove-Persistence\" or \"DNS_TXT_Pwnage\" or\n    \"Execute-OnTime\" or \"HTTP-Backdoor\" or\n    \"Add-ConstrainedDelegationBackdoor\" or \"Add-RegBackdoor\" or\n    \"Add-ScrnSaveBackdoor\" or \"Gupt-Backdoor\" or\n    \"Invoke-ADSBackdoor\" or \"Add-Persistence\" or\n    \"Invoke-ResolverBackdoor\" or \"Invoke-EventLogBackdoor\" or\n    \"Invoke-DeadUserBackdoor\" or \"Invoke-DisableMachineAcctChange\" or\n    \"Invoke-AccessBinary\" or \"Add-NetUser\" or\n    \"Invoke-Schtasks\" or \"Invoke-JSRatRegsvr\" or\n    \"Invoke-JSRatRundll\" or \"Invoke-PoshRatHttps\" or\n    \"Invoke-PsGcatAgent\" or \"Remove-PoshRat\" or\n    \"Install-SSP\" or \"Invoke-BackdoorLNK\" or\n    \"PowerBreach\" or \"InstallEXE-Persistence\" or\n    \"RemoveEXE-Persistence\" or \"Install-ServiceLevel-Persistence\" or\n    \"Remove-ServiceLevel-Persistence\" or \"Invoke-Prompt\" or\n    \"Invoke-PacketCapture\" or \"Start-WebcamRecorder\" or\n    \"Get-USBKeyStrokes\" or \"Invoke-KeeThief\" or\n    \"Get-Keystrokes\" or \"Invoke-NetRipper\" or\n    \"Get-EmailItems\" or \"Invoke-MailSearch\" or\n    \"Invoke-SearchGAL\" or \"Get-WebCredentials\" or\n    \"Start-CaptureServer\" or \"Invoke-PowerShellIcmp\" or\n    \"Invoke-PowerShellTcpOneLine\" or \"Invoke-PowerShellTcpOneLineBind\" or\n    \"Invoke-PowerShellUdp\" or \"Invoke-PowerShellUdpOneLine\" or\n    \"Run-EXEonRemote\" or \"Download-Execute-PS\" or\n    \"Out-RundllCommand\" or \"Set-RemoteWMI\" or\n    \"Set-DCShadowPermissions\" or \"Invoke-PowerShellWMI\" or\n    \"Invoke-Vnc\" or \"Invoke-LockWorkStation\" or\n    \"Invoke-EternalBlue\" or \"Invoke-ShellcodeMSIL\" or\n    \"Invoke-MetasploitPayload\" or \"Invoke-DowngradeAccount\" or\n    \"Invoke-RunAs\" or \"ExetoText\" or\n    \"Disable-SecuritySettings\" or \"Set-MacAttribute\" or\n    \"Invoke-MS16032\" or \"Invoke-BypassUACTokenManipulation\" or\n    \"Invoke-SDCLTBypass\" or \"Invoke-FodHelperBypass\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-EnvBypass\" or\n    \"Get-ServiceUnquoted\" or \"Get-ServiceFilePermission\" or\n    \"Get-ServicePermission\" or\n    \"Enable-DuplicateToken\" or \"Invoke-PsUaCme\" or\n    \"Invoke-Tater\" or \"Invoke-WScriptBypassUAC\" or\n    \"Invoke-AllChecks\" or \"Find-TrustedDocuments\" or\n    \"Invoke-Interceptor\" or \"Invoke-PoshRatHttp\" or\n    \"Invoke-ExecCommandWMI\" or \"Invoke-KillProcessWMI\" or\n    \"Invoke-CreateShareandExecute\" or \"Invoke-RemoteScriptWithOutput\" or\n    \"Invoke-SchedJobManipulation\" or \"Invoke-ServiceManipulation\" or\n    \"Invoke-PowerOptionsWMI\" or \"Invoke-DirectoryListing\" or\n    \"Invoke-FileTransferOverWMI\" or \"Invoke-WMImplant\" or\n    \"Invoke-WMIObfuscatedPSCommand\" or \"Invoke-WMIDuplicateClass\" or\n    \"Invoke-WMIUpload\" or \"Invoke-WMIRemoteExtract\" or \"Invoke-winPEAS\" or\n    \"Invoke-AzureHound\" or \"Invoke-SharpHound\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  ) and\n  not user.id : (\"S-1-5-18\" or \"S-1-5-19\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_posh_hacktool_functions.toml"}
{"title": "Potential Malicious PowerShell Based on Alert Correlation", "description": "Identifies PowerShell script blocks associated with multiple distinct detections, indicating likely malicious behavior.", "query": "FROM .alerts-security.* metadata _id\n\n// Filter for PowerShell related alerts\n| WHERE kibana.alert.rule.name LIKE \"*PowerShell*\"\n\n// As alerts don't have non-ECS fields, parse the script block ID using GROK\n| GROK message \"ScriptBlock ID: (?<powershell.file.script_block_id>.+)\"\n| WHERE powershell.file.script_block_id IS NOT NULL\n\n| KEEP kibana.alert.rule.name, powershell.file.script_block_id, _id\n\n// Count distinct alerts and filter for matches above the threshold\n| STATS distinct_alerts = COUNT_DISTINCT(kibana.alert.rule.name), rules_triggered = VALUES(kibana.alert.rule.name), alert_ids = VALUES(_id) BY powershell.file.script_block_id\n| WHERE distinct_alerts >= 5", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_posh_malicious_script_agg.toml"}
{"title": "Suspicious Portable Executable Encoded in Powershell Script", "description": "Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackers\nembed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    TVqQAAMAAAAEAAAA\n  ) and not user.id : \"S-1-5-18\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_posh_portable_executable.toml"}
{"title": "PowerShell PSReflect Script", "description": "Detects the use of PSReflect in PowerShell scripts. Attackers leverage PSReflect as a library that enables PowerShell to\naccess win32 API functions.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"New-InMemoryModule\" or\n    \"Add-Win32Type\" or\n    psenum or\n    DefineDynamicAssembly or\n    DefineDynamicModule or\n    \"Reflection.TypeAttributes\" or\n    \"Reflection.Emit.OpCodes\" or\n    \"Reflection.Emit.CustomAttributeBuilder\" or\n    \"Runtime.InteropServices.DllImportAttribute\"\n  ) and\n  not user.id : \"S-1-5-18\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_posh_psreflect.toml"}
{"title": "Command and Scripting Interpreter via Windows Scripts", "description": "Identifies PowerShell.exe or Cmd.exe execution spawning from Windows Script Host processes Wscript.exe.", "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"cmd.exe\") and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\") and ?process.parent.args : \"?:\\\\Users\\\\*\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_powershell_susp_args_via_winscript.toml"}
{"title": "PsExec Network Connection", "description": "Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateral\nmovement.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"PsExec.exe\" and event.type == \"start\" and\n\n   /* This flag suppresses the display of the license dialog and may\n      indicate that psexec executed for the first time in the machine */\n   process.args : \"-accepteula\" and\n\n   not process.executable : (\"?:\\\\ProgramData\\\\Docusnap\\\\Discovery\\\\discovery\\\\plugins\\\\17\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Docusnap 11\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Tools\\\\dsDNS.exe\") and\n   not process.parent.executable : \"?:\\\\Program Files (x86)\\\\Cynet\\\\Cynet Scanner\\\\CynetScanner.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"PsExec.exe\"]", "tactic": "Execution", "technique": "System Services", "technique_id": "T1569", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_psexec_lateral_movement_command.toml"}
{"title": "Network Connection via Registration Utility", "description": "Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection.\nThis may be indicative of an attacker bypassing allowlists or running arbitrary scripts via a signed Microsoft binary.", "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\") and\n   not (\n         (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n         (process.parent.name : \"msiexec.exe\" or process.parent.executable : (\"C:\\\\Program Files (x86)\\\\*.exe\", \"C:\\\\Program Files\\\\*.exe\"))\n       )\n   ]\n  [network where host.os.type == \"windows\" and process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\")  and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and network.protocol != \"dns\"]", "tactic": "Execution", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_register_server_program_connecting_to_the_internet.toml"}
{"title": "Outbound Scheduled Task Activity via PowerShell", "description": "Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connection\nwithin a short time period. This may indicate lateral movement or remote discovery via scheduled tasks.", "query": "sequence by host.id, process.entity_id with maxspan = 5s\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n [network where host.os.type == \"windows\" and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and destination.port == 135 and not destination.address in (\"127.0.0.1\", \"::1\")]", "tactic": "Execution", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_scheduled_task_powershell_source.toml"}
{"title": "Execution via local SxS Shared Module", "description": "Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuse\nshared modules to execute malicious payloads by instructing the Windows module loader to load DLLs from arbitrary local\npaths.", "query": "file where host.os.type == \"windows\" and file.extension : \"dll\" and file.path : \"C:\\\\*\\\\*.exe.local\\\\*.dll\"", "tactic": "Execution", "technique": "Shared Modules", "technique_id": "T1129", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_shared_modules_local_sxs_dll.toml"}
{"title": "Suspicious Cmd Execution via WMI", "description": "Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This could\nbe indicative of adversary lateral movement.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"WmiPrvSE.exe\" and process.name : \"cmd.exe\" and process.args : \"/c\" and process.args:\"/Q\" and \n process.args : \"2>&1\" and process.args: \"1>\"  and \n process.args : (\"C:\\\\windows\\\\temp\\\\*.txt\", \"\\\\Windows\\\\Temp\\\\*\", \"-encodehex\", \"\\\\\\\\127.0.0.1\\\\C$\\\\Windows\\\\Temp\\\\*\", \"\\\\\\\\127.0.0.1\\\\ADMIN$\\\\__*.*\")", "tactic": "Execution", "technique": "Windows Management Instrumentation", "technique_id": "T1047", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_cmd_wmi.toml"}
{"title": "Suspicious WMI Image Load from MS Office", "description": "Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicate\nadversarial activity where child processes are spawned via Windows Management Instrumentation (WMI). This technique can\nbe used to execute code and evade traditional parent/child processes spawned from Microsoft Office products.", "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\")", "tactic": "Execution", "technique": "Windows Management Instrumentation", "technique_id": "T1047", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_image_load_wmi_ms_office.toml"}
{"title": "Suspicious PDF Reader Child Process", "description": "Identifies suspicious child processes of PDF reader applications. These child processes are often launched via\nexploitation of PDF applications or social engineering.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"AcroRd32.exe\",\n                         \"Acrobat.exe\",\n                         \"FoxitPhantomPDF.exe\",\n                         \"FoxitReader.exe\") and\n  process.name : (\"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n                  \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\",\n                  \"quser.exe\", \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\",\n                  \"whoami.exe\", \"bginfo.exe\", \"cdb.exe\", \"cmstp.exe\", \"csi.exe\", \"dnx.exe\", \"fsi.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"Microsoft.Workflow.Compiler.exe\", \"msbuild.exe\", \"mshta.exe\",\n                  \"msxsl.exe\", \"odbcconf.exe\", \"rcsi.exe\", \"regsvr32.exe\", \"xwizard.exe\", \"atbroker.exe\",\n                  \"forfiles.exe\", \"schtasks.exe\", \"regasm.exe\", \"regsvcs.exe\", \"cmd.exe\", \"cscript.exe\",\n                  \"powershell.exe\", \"pwsh.exe\", \"wmic.exe\", \"wscript.exe\", \"bitsadmin.exe\", \"certutil.exe\", \"ftp.exe\")", "tactic": "Execution", "technique": "Exploitation for Client Execution", "technique_id": "T1203", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_pdf_reader.toml"}
{"title": "Suspicious PowerShell Engine ImageLoad", "description": "Identifies the PowerShell engine being invoked by unexpected processes. Rather than executing PowerShell functionality\nwith powershell.exe, some attackers do this to operate more stealthily.", "query": "host.os.type:windows and event.category:library and\n  dll.name:(\"System.Management.Automation.dll\" or \"System.Management.Automation.ni.dll\") and \n  not (\n    process.code_signature.subject_name:(\"Microsoft Corporation\" or \"Microsoft Dynamic Code Publisher\" or \"Microsoft Windows\") and process.code_signature.trusted:true and not process.name.caseless:(\"regsvr32.exe\" or \"rundll32.exe\")\n  ) and \n  not (\n    process.executable.caseless:(C\\:\\\\Program*Files*\\(x86\\)\\\\*.exe or C\\:\\\\Program*Files\\\\*.exe) and\n    process.code_signature.trusted:true\n  ) and \n  not (\n    process.executable.caseless: C\\:\\\\Windows\\\\Lenovo\\\\*.exe and process.code_signature.subject_name:\"Lenovo\" and \n    process.code_signature.trusted:true\n  ) and \n  not (\n    process.executable.caseless: \"C:\\\\ProgramData\\\\chocolatey\\\\choco.exe\" and\n    process.code_signature.subject_name:\"Chocolatey Software, Inc.\" and process.code_signature.trusted:true\n  ) and not process.executable.caseless : \"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\"", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_powershell_imgload.toml"}
{"title": "Suspicious Process Execution via Renamed PsExec Executable", "description": "Identifies suspicious psexec activity which is executing from the psexec service that has been renamed, possibly to\nevade detection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name : \"psexesvc.exe\" and not process.name : \"PSEXESVC.exe\"", "tactic": "Execution", "technique": "System Services", "technique_id": "T1569", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_suspicious_psexesvc.toml"}
{"title": "Process Activity via Compiled HTML File", "description": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal\nmalicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable\nprogram (hh.exe).", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"hh.exe\" and\n process.name : (\"mshta.exe\", \"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cscript.exe\", \"wscript.exe\")", "tactic": "Execution", "technique": "User Execution", "technique_id": "T1204", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_via_compiled_html_file.toml"}
{"title": "Conhost Spawned By Suspicious Parent Process", "description": "Detects when the Console Window Host (conhost.exe) process is spawned by a suspicious parent process, which could be\nindicative of code injection.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"conhost.exe\" and\n  process.parent.name : (\"lsass.exe\", \"services.exe\", \"smss.exe\", \"winlogon.exe\", \"explorer.exe\", \"dllhost.exe\", \"rundll32.exe\",\n                         \"regsvr32.exe\", \"userinit.exe\", \"wininit.exe\", \"spoolsv.exe\", \"ctfmon.exe\") and\n  not (process.parent.name : \"rundll32.exe\" and\n       process.parent.args : (\"?:\\\\Windows\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\",\n                              \"?:\\\\WINDOWS\\\\system32\\\\PcaSvc.dll,PcaPatchSdbTask\",\n                              \"?:\\\\WINDOWS\\\\system32\\\\davclnt.dll,DavSetCookie\"))", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_via_hidden_shell_conhost.toml"}
{"title": "Microsoft Management Console File from Unusual Path", "description": "Identifies attempts to open a Microsoft Management Console File from untrusted paths. Adversaries may use MSC files for\ninitial access and execution.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\mmc.exe\"\n  ) and\n  process.args : \"*.msc\" and\n  not process.args : (\n        \"?:\\\\Windows\\\\System32\\\\*.msc\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\",\n        \"?:\\\\Program files\\\\*.msc\",\n        \"?:\\\\Program Files (x86)\\\\*.msc\"\n  )", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_via_mmc_console_file_unusual_path.toml"}
{"title": "Suspicious Windows Command Shell Arguments", "description": "Identifies the execution of the Windows Command Shell process (cmd.exe) with suspicious argument values. This behavior\nis often observed during malware installation.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"cmd.exe\" and\n (\n\n  process.command_line : (\"*).Run(*\", \"*GetObject*\", \"* curl*regsvr32*\", \"*echo*wscript*\", \"*echo*ZONE.identifier*\",\n  \"*ActiveXObject*\", \"*dir /s /b *echo*\", \"*unescape(*\",  \"*findstr*TVNDRgAAAA*\", \"*findstr*passw*\", \"*start*\\\\\\\\*\\\\DavWWWRoot\\\\*\",\n  \"* explorer*%CD%*\", \"*%cd%\\\\*.js*\", \"*attrib*%CD%*\", \"*/?cMD<*\", \"*/AutoIt3ExecuteScript*..*\", \"*&cls&cls&cls&cls&cls&*\",\n  \"*&#*;&#*;&#*;&#*;*\", \"* &&s^eT*\", \"*& ChrW(*\", \"*&explorer /root*\", \"*start __ & __\\\\*\", \"*findstr /V /L *forfiles*\",\n  \"*=wscri& set *\", \"*http*!COmpUternaME!*\", \"*start *.pdf * start /min cmd.exe /c *\\\\\\\\*\", \"*pip install*System.Net.WebClient*\",\n  \"*Invoke-WebReques*Start-Process*\", \"*-command (Invoke-webrequest*\", \"*copy /b *\\\\\\\\* ping *-n*\", \"*echo*.ToCharArray*\") or\n\n  (process.args : \"echo\" and process.parent.name : (\"wscript.exe\", \"mshta.exe\")) or\n\n  process.args : (\"1>?:\\\\*.vbs\", \"1>?:\\\\*.js\") or\n\n  (process.args : \"explorer.exe\" and process.args : \"type\" and process.args : \">\" and process.args : \"start\") or\n\n  (process.parent.name : \"explorer.exe\" and\n   process.command_line :\n           (\"*&&S^eT *\",\n            \"*&& set *&& set *&& set *&& set *&& set *&& call*\",\n            \"**\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??*\")) or\n\n   (process.parent.name : \"explorer.exe\" and process.args : \"copy\" and process.args : \"&&\" and process.args : \"\\\\\\\\*@*\\\\*\")\n  ) and\n\n  /* false positives */\n  not (process.args : \"%TEMP%\\\\Spiceworks\\\\*\" and process.parent.name : \"wmiprvse.exe\") and\n  not process.parent.executable :\n                (\"?:\\\\Perl64\\\\bin\\\\perl.exe\",\n                 \"?:\\\\Program Files\\\\nodejs\\\\node.exe\",\n                 \"?:\\\\Program Files\\\\HP\\\\RS\\\\pgsql\\\\bin\\\\pg_dumpall.exe\",\n                 \"?:\\\\Program Files (x86)\\\\PRTG Network Monitor\\\\64 bit\\\\PRTG Server.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Spiceworks\\\\bin\\\\spiceworks-finder.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Zuercher Suite\\\\production\\\\leds\\\\leds.exe\",\n                 \"?:\\\\Program Files\\\\Tripwire\\\\Agent\\\\Plugins\\\\twexec\\\\twexec.exe\",\n                 \"D:\\\\Agents\\\\?\\\\_work\\\\_tasks\\\\*\\\\SonarScanner.MSBuild.exe\",\n                 \"?:\\\\Program Files\\\\Microsoft VS Code\\\\Code.exe\",\n                 \"?:\\\\programmiweb\\\\NetBeans-*\\\\netbeans\\\\bin\\\\netbeans64.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Public Safety Suite Professional\\\\production\\\\leds\\\\leds.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Tier2Tickets\\\\button_gui.exe\",\n                 \"?:\\\\Program Files\\\\NetBeans-*\\\\netbeans\\\\bin\\\\netbeans*.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Public Safety Suite Professional\\\\production\\\\leds\\\\leds.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Tier2Tickets\\\\button_gui.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Helpdesk Button\\\\button_gui.exe\",\n                 \"?:\\\\VTSPortable\\\\VTS\\\\jre\\\\bin\\\\javaw.exe\",\n                 \"?:\\\\Program Files\\\\Bot Framework Composer\\\\Bot Framework Composer.exe\",\n                 \"?:\\\\Program Files\\\\KMSYS Worldwide\\\\eQuate\\\\*\\\\SessionMgr.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Craneware\\\\Pricing Analyzer\\\\Craneware.Pricing.Shell.exe\",\n                 \"?:\\\\Program Files (x86)\\\\jumpcloud-agent-app\\\\jumpcloud-agent-app.exe\",\n                 \"?:\\\\Program Files\\\\PostgreSQL\\\\*\\\\bin\\\\pg_dumpall.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Vim\\\\vim*\\\\vimrun.exe\") and\n  not (process.args :  \"?:\\\\Program Files\\\\Citrix\\\\Secure Access Client\\\\nsauto.exe\" and process.parent.name : \"userinit.exe\") and\n  not process.args :\n            (\"?:\\\\Program Files (x86)\\\\PCMatic\\\\PCPitstopScheduleService.exe\",\n             \"?:\\\\Program Files (x86)\\\\AllesTechnologyAgent\\\\*\",\n             \"https://auth.axis.com/oauth2/oauth-authorize*\") and\n  not process.command_line :\n               (\"\\\"cmd\\\" /c %NETBEANS_MAVEN_COMMAND_LINE%\",\n                \"?:\\\\Windows\\\\system32\\\\cmd.exe /q /d /s /c \\\"npm.cmd ^\\\"install^\\\" ^\\\"--no-bin-links^\\\" ^\\\"--production^\\\"\\\"\") and\n  not (process.name : \"cmd.exe\" and process.args : \"%TEMP%\\\\Spiceworks\\\\*\" and process.args : \"http*/dataloader/persist_netstat_data\") and\n  not (process.args == \"echo\" and process.args == \"GEQ\" and process.args == \"1073741824\")", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_windows_cmd_shell_susp_args.toml"}
{"title": "Execution of a Downloaded Windows Script", "description": "Identifies the creation of a Windows script downloaded from the internet followed by the execution of a scripting utility.\nAdversaries may use Windows script files for initial access and execution.", "query": "sequence by host.id, user.id with maxspan=3m\n[file where host.os.type == \"windows\" and event.action == \"creation\" and user.id != \"S-1-5-18\" and\n  process.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"7zG.exe\", \"Bandizip.exe\") and\n  file.extension in~ (\"js\", \"jse\", \"vbs\", \"vbe\", \"wsh\", \"hta\", \"cmd\", \"bat\") and\n  (file.origin_url != null or file.origin_referrer_url != null)]\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"firefox.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"7zG.exe\", \"Bandizip.exe\") and \n process.args_count >= 2 and\n (\n  process.name in~ (\"wscript.exe\", \"mshta.exe\") or\n  (process.name : \"cmd.exe\" and process.command_line : (\"*.cmd*\", \"*.bat*\"))\n  )]", "tactic": "Execution", "technique": "Command and Scripting Interpreter", "technique_id": "T1059", "risk_score": "N/A", "tags": [], "references": [], "file": "execution_windows_script_from_internet.toml"}
{"title": "Rare SMB Connection to the Internet", "description": "This rule detects rare internet network connections via the SMB protocol. SMB is commonly used to leak NTLM credentials\nvia rogue UNC path injection.", "query": "event.category:network and host.os.type:windows and process.pid:4 and\n  network.transport:tcp and destination.port:(139 or 445) and\n  source.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  ) and\n  not destination.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  )", "tactic": "Exfiltration", "technique": "Exfiltration Over Alternative Protocol", "technique_id": "T1048", "risk_score": "N/A", "tags": [], "references": [], "file": "exfiltration_smb_rare_destination.toml"}
{"title": "Third-party Backup Files Deleted via Unexpected Process", "description": "Identifies the deletion of backup files, saved using third-party software, by a process outside of the backup suite.\nAdversaries may delete Backup files to ensure that recovery from a ransomware attack is less likely.", "query": "file where host.os.type == \"windows\" and event.type == \"deletion\" and\n  (\n    /* Veeam Related Backup Files */\n    (\n      file.extension : (\"VBK\", \"VIB\", \"VBM\") and\n      not (\n        process.executable : (\"?:\\\\Windows\\\\*\", \"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\") and\n        (process.code_signature.trusted == true and process.code_signature.subject_name : (\"Veeam Software Group GmbH\", \"Veeam Software AG\"))\n      )\n    ) or\n    /* Veritas Backup Exec Related Backup File */\n    (\n      file.extension : \"BKF\" and\n        not process.executable : (\n          \"?:\\\\Program Files\\\\Veritas\\\\Backup Exec\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\Veritas\\\\Backup Exec\\\\*\"\n        )\n    )\n  ) and\n  not (\n    process.name : (\"MSExchangeMailboxAssistants.exe\", \"Microsoft.PowerBI.EnterpriseGateway.exe\") and\n      (process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true)\n  ) and\n  not file.path : (\n    \"?:\\\\ProgramData\\\\Trend Micro\\\\*\",\n    \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*\",\n    \"?:\\\\$RECYCLE.BIN\\\\*\"\n  )", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_backup_file_deletion.toml"}
{"title": "Backup Deletion with Wbadmin", "description": "Detects use of wbadmin.exe to delete backup catalogs, system state backups, or other backup data. Ransomware and other\nmalware may do this to prevent system recovery.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name == \"WBADMIN.EXE\") and\n  process.args : (\"catalog\", \"backup\", \"systemstatebackup\") and process.args : \"delete\"", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_deleting_backup_catalogs_with_wbadmin.toml"}
{"title": "Potential Ransomware Behavior - High count of Readme files by System", "description": "This rule identifies a high number (20) of file creation event by the System virtual process from the same host and with\nsame file name containing keywords similar to ransomware note files and all within a short time period.", "query": "event.category:file and host.os.type:windows and process.pid:4 and event.action:creation and\n file.name:(*read*me* or *README* or *lock* or *LOCK* or *how*to* or *HOW*TO* or *@* or *recover* or *RECOVER* or *decrypt* or *DECRYPT* or *restore* or *RESTORE* or *FILES_BACK* or *files_back*)", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_high_freq_file_renames_by_kernel.toml"}
{"title": "Modification of Boot Configuration", "description": "Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an\nattacker as a destructive technique.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and\n    (\n      (process.args : \"/set\" and process.args : \"bootstatuspolicy\" and process.args : \"ignoreallfailures\") or\n      (process.args : \"no\" and process.args : \"recoveryenabled\")\n    )", "tactic": "Impact", "technique": "Inhibit System Recovery", "technique_id": "T1490", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_modification_of_boot_config.toml"}
{"title": "Suspicious File Renamed via SMB", "description": "Identifies an incoming SMB connection followed by a suspicious file rename operation. This may indicate a remote\nransomware attack via the SMB protocol.", "query": "sequence by host.id with maxspan=1s\n [network where host.os.type == \"windows\" and\n  event.action == \"connection_accepted\" and destination.port == 445 and source.port >= 49152 and process.pid == 4 and\n  source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.type == \"ipv4\" and not endswith(source.address, destination.address)]\n [file where host.os.type == \"windows\" and\n  event.action == \"rename\" and process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and\n  file.extension != null and file.Ext.entropy >= 6 and file.path : \"C:\\\\Users\\\\*\" and\n  file.Ext.original.name : (\"*.jpg\", \"*.bmp\", \"*.png\", \"*.pdf\", \"*.doc\", \"*.docx\", \"*.xls\", \"*.xlsx\", \"*.ppt\", \"*.pptx\", \"*.lnk\") and\n  not file.extension : (\"jpg\", \"bmp\", \"png\", \"pdf\", \"doc\", \"docx\", \"xls\", \"xlsx\", \"ppt\", \"pptx\", \"*.lnk\")] with runs=3", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_ransomware_file_rename_smb.toml"}
{"title": "Potential Ransomware Note File Dropped via SMB", "description": "Identifies an incoming SMB connection followed by the creation of a file with a name similar to ransomware note files.\nThis may indicate a remote ransomware attack via the SMB protocol.", "query": "sequence by host.id with maxspan=1s\n [network where host.os.type == \"windows\" and\n  event.action == \"connection_accepted\" and destination.port == 445 and source.port >= 49152 and process.pid == 4 and\n  source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.type == \"ipv4\" and not endswith(source.address, destination.address)]\n [file where host.os.type == \"windows\" and event.action == \"creation\" and\n  process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and file.extension : (\"hta\", \"txt\", \"readme\", \"htm*\") and\n  file.path : \"C:\\\\Users\\\\*\" and\n   /* ransom file name keywords */\n    file.name : (\"*read*me*\", \"*lock*\", \"*@*\", \"*RECOVER*\", \"*decrypt*\", \"*restore*file*\", \"*FILES_BACK*\", \"*how*to*\")] with runs=3", "tactic": "Impact", "technique": "Data Destruction", "technique_id": "T1485", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_ransomware_note_file_over_smb.toml"}
{"title": "High Number of Process and/or Service Terminations", "description": "This rule identifies a high number (10) of process terminations (stop, delete, or suspend) from the same host within a\nshort time period.", "query": "event.category:process and host.os.type:windows and event.type:start and process.name:(net.exe or sc.exe or taskkill.exe) and\n process.args:(stop or pause or delete or \"/PID\" or \"/IM\" or \"/T\" or \"/F\" or \"/t\" or \"/f\" or \"/im\" or \"/pid\") and\n not process.parent.name:(osquerybeat.exe or agentbeat.exe)", "tactic": "Impact", "technique": "Service Stop", "technique_id": "T1489", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_stop_process_service_threshold.toml"}
{"title": "Volume Shadow Copy Deleted or Resized via VssAdmin", "description": "Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with\nransomware or other destructive attacks.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"vssadmin.exe\" or ?process.pe.original_file_name == \"VSSADMIN.EXE\") and\n  process.args : (\"delete\", \"resize\") and process.args : \"shadows*\"", "tactic": "Impact", "technique": "Inhibit System Recovery", "technique_id": "T1490", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_volume_shadow_copy_deletion_or_resized_via_vssadmin.toml"}
{"title": "Volume Shadow Copy Deletion via PowerShell", "description": "Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonly\noccurs in tandem with ransomware or other destructive attacks.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.args : (\"*Get-WmiObject*\", \"*gwmi*\", \"*Get-CimInstance*\", \"*gcim*\") and\n  process.args : (\"*Win32_ShadowCopy*\") and\n  process.args : (\"*.Delete()*\", \"*Remove-WmiObject*\", \"*rwmi*\", \"*Remove-CimInstance*\", \"*rcim*\")", "tactic": "Impact", "technique": "Inhibit System Recovery", "technique_id": "T1490", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_volume_shadow_copy_deletion_via_powershell.toml"}
{"title": "Volume Shadow Copy Deletion via WMIC", "description": "Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware or\nother destructive attacks.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"WMIC.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"delete\" and process.args : \"shadowcopy\"", "tactic": "Impact", "technique": "Inhibit System Recovery", "technique_id": "T1490", "risk_score": "N/A", "tags": [], "references": [], "file": "impact_volume_shadow_copy_deletion_via_wmic.toml"}
{"title": "Suspicious HTML File Creation", "description": "Identifies the execution of a browser process to open an HTML file with high entropy and size. Adversaries may smuggle\ndata and files past content filters by hiding malicious payloads inside of seemingly benign HTML files.", "query": "sequence by user.id with maxspan=2m\n\n [file where host.os.type == \"windows\" and event.action in (\"creation\", \"rename\") and\n\n  /* Check for HTML files with high entropy and size */\n  file.extension : (\"htm\", \"html\") and ((file.Ext.entropy >= 5 and file.size >= 150000) or file.size >= 1000000) and\n\n  /* Check for file paths in common download and temporary directories */\n  file.path : (\n    \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n    \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\")]\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  (\n   /* Check for browser processes opening HTML files with single argument */\n   (process.name in (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\")\n    and process.args == \"--single-argument\") or\n\n   /* Optionally, check for browser processes opening HTML files with two arguments */\n   (process.name == \"iexplore.exe\" and process.args_count == 2) or\n\n   /* Optionally, check for browser processes opening HTML files with URL argument */\n   (process.name in (\"firefox.exe\", \"waterfox.exe\") and process.args == \"-url\")\n  )\n  /* Check for file paths in common download and temporary directories targeted in the process arguments */\n  and process.args : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\Content.Outlook\\\\*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*.htm*\",\n                      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*.htm*\")]", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_evasion_suspicious_htm_file_creation.toml"}
{"title": "Suspicious Execution from INET Cache", "description": "Identifies the execution of a process with arguments pointing to the INetCache Folder. Adversaries may deliver malicious\ncontent via WININET during initial access.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"Bandizip.exe\") and\n  (\n    process.args : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\" or\n    process.executable : (\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\",\n      \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\"\n    )\n  )", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_execution_from_inetcache.toml"}
{"title": "Execution from a Removable Media with Network Connection", "description": "Identifies process execution from a removable media and by an unusual process. Adversaries may move onto systems,\npossibly those on disconnected or air-gapped networks, by copying malware to removable media and taking advantage of\nAutorun features when the media is inserted into a system and executes.", "query": "sequence by process.entity_id with maxspan=5m\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n\n  /* Direct Exec from USB */\n  (process.Ext.device.bus_type : \"usb\" or process.Ext.device.product_id : \"USB *\") and\n  (process.code_signature.trusted == false or process.code_signature.exists == false) and\n\n  not process.code_signature.status : (\"errorExpired\", \"errorCode_endpoint*\")]\n [network where host.os.type == \"windows\" and event.action == \"connection_attempted\"]", "tactic": "Initial Access", "technique": "Replication Through Removable Media", "technique_id": "T1091", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_execution_from_removable_media.toml"}
{"title": "Potential Remote File Execution via MSIEXEC", "description": "Identifies the execution of the built-in Windows Installer, msiexec.exe, to install a remote package. Adversaries may\nabuse msiexec.exe to launch local or network accessible MSI files.", "query": "sequence with maxspan=1m\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n    process.name : \"msiexec.exe\" and process.args : \"/V\"] by process.entity_id\n [network where host.os.type == \"windows\" and process.name : \"msiexec.exe\" and\n    event.action == \"connection_attempted\"] by process.entity_id\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.parent.name : \"msiexec.exe\" and user.id : (\"S-1-5-21-*\", \"S-1-5-12-1-*\") and\n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\srtasks.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\srtasks.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\taskkill.exe\",\n                            \"?:\\\\Windows\\\\Installer\\\\MSI*.tmp\",\n                            \"?:\\\\Program Files\\\\*.exe\",\n                            \"?:\\\\Program Files (x86)\\\\*.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\ie4uinit.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\ie4uinit.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\sc.exe\",\n                            \"?:\\\\Windows\\\\system32\\\\Wbem\\\\mofcomp.exe\",\n                            \"?:\\\\Windows\\\\twain_32\\\\fjscan32\\\\SOP\\\\crtdmprc.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\taskkill.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\schtasks.exe\",\n                            \"?:\\\\Windows\\\\system32\\\\schtasks.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\sdbinst.exe\") and\n  not (process.code_signature.subject_name == \"Citrix Systems, Inc.\" and process.code_signature.trusted == true) and\n  not (process.name : (\"regsvr32.exe\", \"powershell.exe\", \"rundll32.exe\", \"wscript.exe\") and\n       process.Ext.token.integrity_level_name == \"high\" and\n       process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\")) and\n  not (process.executable : (\"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\") and process.code_signature.trusted == true) and\n  not (process.name : \"rundll32.exe\" and process.args : \"printui.dll,PrintUIEntry\")\n  ] by process.parent.entity_id", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_execution_remote_via_msiexec.toml"}
{"title": "Suspicious Execution via Microsoft Office Add-Ins", "description": "Identifies execution of common Microsoft Office applications to launch an Office Add-In from a suspicious path or with\nan unusual parent process. This may indicate an attempt to get initial access via a malicious phishing MS Office Add-In.", "query": "process where\n\n    host.os.type == \"windows\" and event.type == \"start\" and\n\n    process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSACCESS.EXE\", \"VSTOInstaller.exe\") and\n\n    process.args regex~ \"\"\".+\\.(wll|xll|ppa|ppam|xla|xlam|vsto)\"\"\" and\n\n    /* Office Add-In from suspicious paths */\n    (process.args :\n             (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\",\n              \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n              \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\",\n              \"?:\\\\Users\\\\Public\\\\*\",\n              \"?:\\\\ProgramData\\\\*\",\n              \"?:\\\\Windows\\\\Temp\\\\*\",\n              \"\\\\Device\\\\*\",\n              \"http*\") or\n\n    process.parent.name : (\"explorer.exe\", \"OpenWith.exe\") or\n\n    /* Office Add-In from suspicious parent */\n    process.parent.name : (\"cmd.exe\", \"powershell.exe\")) and\n\n    /* False Positives */\n    not (process.args : \"*.vsto\" and\n         process.parent.executable :\n                   (\"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility.exe\",\n                    \"?:\\\\Program Files\\\\LogiOptionsPlus\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\VSTO\\\\*\\\\VSTOInstaller.exe\")) and\n    not (process.args : \"/Uninstall\" and process.name : \"VSTOInstaller.exe\") and\n    not (process.parent.name : \"rundll32.exe\" and\n         process.parent.args : \"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\") and\n    not (process.name : \"VSTOInstaller.exe\" and process.args : \"https://dl.getsidekick.com/outlook/vsto/Sidekick.vsto\")", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_execution_via_office_addins.toml"}
{"title": "First Time Seen Removable Device", "description": "Identifies newly seen removable devices by device friendly name using registry modification events. While this activity\nis not inherently malicious, analysts can use those events to aid monitoring for data exfiltration over those devices.", "query": "event.category:\"registry\" and host.os.type:\"windows\" and registry.value:\"FriendlyName\" and registry.path:*USBSTOR*", "tactic": "Initial Access", "technique": "Replication Through Removable Media", "technique_id": "T1091", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_exfiltration_first_time_seen_usb.toml"}
{"title": "Suspicious JetBrains TeamCity Child Process", "description": "Identifies suspicious processes being spawned by the JetBrain TeamCity process. This activity could be related to\nJetBrains remote code execution vulnerabilities.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable :\n                 (\"?:\\\\TeamCity\\\\jre\\\\bin\\\\java.exe\",\n                  \"?:\\\\Program Files\\\\TeamCity\\\\jre\\\\bin\\\\java.exe\",\n                  \"?:\\\\Program Files (x86)\\\\TeamCity\\\\jre\\\\bin\\\\java.exe\",\n                  \"?:\\\\TeamCity\\\\BuildAgent\\\\jre\\\\bin\\\\java.exe\") and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"msiexec.exe\", \"certutil.exe\", \"bitsadmin.exe\", \"wmic.exe\", \"curl.exe\", \"ssh.exe\",\n                   \"rundll32.exe\", \"regsvr32.exe\", \"mshta.exe\", \"certreq.exe\", \"net.exe\", \"nltest.exe\", \"whoami.exe\", \"hostname.exe\",\n                   \"tasklist.exe\", \"arp.exe\", \"nbtstat.exe\", \"netstat.exe\", \"reg.exe\", \"tasklist.exe\", \"Microsoft.Workflow.Compiler.exe\",\n                   \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\",\n                   \"dnx.exe\", \"dsget.exe\", \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"ieexec.exe\", \"iexpress.exe\",\n                   \"installutil.exe\", \"ipconfig.exe\",\"msxsl.exe\", \"netsh.exe\", \"odbcconf.exe\", \"ping.exe\", \"pwsh.exe\", \"qprocess.exe\",\n                   \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\",\n                   \"systeminfo.exe\", \"tracert.exe\", \"wmic.exe\", \"wscript.exe\",\"xwizard.exe\", \"explorer.exe\", \"msdt.exe\") and\n not (process.name : \"powershell.exe\" and process.args : \"-ExecutionPolicy\" and process.args : \"?:\\\\TeamCity\\\\buildAgent\\\\work\\\\*.ps1\") and\n not (process.name : \"cmd.exe\" and process.args : \"dir\" and process.args : \"/-c\")", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_exploit_jetbrains_teamcity.toml"}
{"title": "Remote Desktop File Opened from Suspicious Path", "description": "Identifies attempts to open a remote desktop file from suspicious paths. Adversaries may abuse RDP files for initial\naccess.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"mstsc.exe\" and\n process.args : (\"?:\\\\Users\\\\*\\\\Downloads\\\\*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Temp?_*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\7z*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\\\\*.rdp\",\n                 \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\BNZ.*.rdp\",\n                 \"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\Content.Outlook\\\\*.rdp\")", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_rdp_file_mail_attachment.toml"}
{"title": "Windows Script Interpreter Executing Process via WMI", "description": "Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process\nvia Windows Management Instrumentation (WMI). This may be indicative of malicious activity.", "query": "sequence by host.id with maxspan = 5s\n    [any where host.os.type == \"windows\" and\n     (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n     (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\") and process.name : (\"wscript.exe\", \"cscript.exe\")]\n    [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.parent.name : \"wmiprvse.exe\" and\n     user.domain != \"NT AUTHORITY\" and\n     (process.pe.original_file_name :\n        (\n          \"cscript.exe\",\n          \"wscript.exe\",\n          \"PowerShell.EXE\",\n          \"Cmd.Exe\",\n          \"MSHTA.EXE\",\n          \"RUNDLL32.EXE\",\n          \"REGSVR32.EXE\",\n          \"MSBuild.exe\",\n          \"InstallUtil.exe\",\n          \"RegAsm.exe\",\n          \"RegSvcs.exe\",\n          \"msxsl.exe\",\n          \"CONTROL.EXE\",\n          \"EXPLORER.EXE\",\n          \"Microsoft.Workflow.Compiler.exe\",\n          \"msiexec.exe\"\n        ) or\n      process.executable : (\"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n     )\n    ]", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_scripts_process_started_via_wmi.toml"}
{"title": "Windows Script Executing PowerShell", "description": "Identifies a PowerShell process launched by either cscript.exe or wscript.exe. Observing Windows scripting processes\nexecuting a PowerShell script, may be indicative of malicious activity.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"cscript.exe\", \"wscript.exe\") and process.name : \"powershell.exe\" and\n  not (\n    process.parent.name : \"wscript.exe\" and\n    process.parent.args : \"?:\\\\ProgramData\\\\intune-drive-mapping-generator\\\\IntuneDriveMapping-VBSHelper.vbs\" and\n    process.parent.args : \"?:\\\\ProgramData\\\\intune-drive-mapping-generator\\\\DriveMapping.ps1\"\n  )", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_script_executing_powershell.toml"}
{"title": "Microsoft Exchange Server UM Writing Suspicious Files", "description": "Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activity\nhas been observed exploiting CVE-2021-26858.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : (\"UMWorkerProcess.exe\", \"umservice.exe\") and\n  file.extension : (\"php\", \"jsp\", \"js\", \"aspx\", \"asmx\", \"asax\", \"cfm\", \"shtml\") and\n  (\n    file.path : \"?:\\\\inetpub\\\\wwwroot\\\\aspnet_client\\\\*\" or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\*\" and\n       not (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\version\\\\*\" or\n            file.name : (\"errorFE.aspx\", \"expiredpassword.aspx\", \"frowny.aspx\", \"GetIdToken.htm\", \"logoff.aspx\",\n                        \"logon.aspx\", \"OutlookCN.aspx\", \"RedirSuiteServiceProxy.aspx\", \"signout.aspx\"))) or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\ecp\\\\auth\\\\*\" and\n       not file.name : \"TimeoutLogoff.aspx\")\n  )", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_ms_exchange_files.toml"}
{"title": "Microsoft Exchange Server UM Spawning Suspicious Processes", "description": "Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. This\nactivity has been observed exploiting CVE-2021-26857.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"UMService.exe\", \"UMWorkerProcess.exe\") and\n    not process.executable : (\n          \"?:\\\\Windows\\\\System32\\\\werfault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n          \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"E:\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"E:\\\\Exchange Server\\\\V15\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\werfault.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wermgr.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange Server\\\\V15\\\\Bin\\\\UMWorkerProcess.exe\"\n    )", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_ms_exchange_process.toml"}
{"title": "Microsoft Exchange Worker Spawning Suspicious Processes", "description": "Identifies suspicious processes being spawned by the Microsoft Exchange Server worker process (w3wp). This activity may\nindicate exploitation activity or access to an existing web shell backdoor.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"w3wp.exe\" and process.parent.args : \"MSExchange*AppPool\" and\n  (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n  ?process.pe.original_file_name in (\"cmd.exe\", \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\"))", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_ms_exchange_worker_child_process.toml"}
{"title": "Suspicious MS Office Child Process", "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel).\nThese child processes are often launched during exploitation of Office applications or from documents with malicious\nmacros.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\n      \"eqnedt32.exe\", \"excel.exe\", \"fltldr.exe\", \"msaccess.exe\",\n      \"mspub.exe\", \"powerpnt.exe\", \"winword.exe\", \"outlook.exe\"\n  ) and\n  process.name : (\n      \"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\",\n      \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n      \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\", \"iexpress.exe\",\n      \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\", \"net1.exe\", \"netsh.exe\",\n      \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\", \"pwsh.exe\", \"qprocess.exe\",\n      \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\",\n      \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\",\n      \"xwizard.exe\", \"explorer.exe\", \"rundll32.exe\", \"hh.exe\", \"msdt.exe\"\n  ) and\n  not (\n    process.parent.name : \"outlook.exe\" and\n    process.name : \"rundll32.exe\" and\n    process.args : \"shell32.dll,Control_RunDLL\" and\n    process.args : \"srchadmin.dll\"\n  )", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_ms_office_child_process.toml"}
{"title": "Suspicious MS Outlook Child Process", "description": "Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spear\nphishing activity.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"outlook.exe\" and\n  process.name : (\"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\",\n                  \"cdb.exe\", \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n                  \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\",\n                  \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\",\n                  \"pwsh.exe\", \"qprocess.exe\", \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\",\n                  \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\",\n                  \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\", \"xwizard.exe\")", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_suspicious_ms_outlook_child_process.toml"}
{"title": "Potential CVE-2025-33053 Exploitation", "description": "Identifies a suspicious Diagnostics Utility for Internet Explorer child process. This may indicate the successful exploitation of the vulnerability CVE-2025-33053.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Program Files\\\\Internet Explorer\\\\iediagcmd.exe\" and\n  process.name : (\"route.exe\", \"netsh.exe\", \"ipconfig.exe\", \"dxdiag.exe\", \"conhost.exe\", \"makecab.exe\") and\n  process.executable != null and\n  not process.executable : (\"C:\\\\Windows\\\\System32\\\\route.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\netsh.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\ipconfig.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\dxdiag.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\conhost.exe\",\n                            \"C:\\\\Windows\\\\System32\\\\makecab.exe\")", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_url_cve_2025_33053.toml"}
{"title": "Suspicious Explorer Child Process", "description": "Identifies a suspicious Windows explorer child process. Explorer.exe can be abused to launch malicious scripts or\nexecutables from a trusted parent process.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"rundll32.exe\", \"cmd.exe\", \"mshta.exe\", \"regsvr32.exe\") or\n   ?process.pe.original_file_name in (\"cscript.exe\", \"wscript.exe\", \"PowerShell.EXE\", \"RUNDLL32.EXE\", \"Cmd.Exe\", \"MSHTA.EXE\", \"REGSVR32.EXE\")\n  ) and\n  /* Explorer started via DCOM */\n  process.parent.name : \"explorer.exe\" and process.parent.args : \"-Embedding\" and\n  not process.parent.args:\n          (\n            /* Noisy CLSID_SeparateSingleProcessExplorerHost Explorer COM Class IDs   */\n            \"/factory,{5BD95610-9434-43C2-886C-57852CC8A120}\",\n            \"/factory,{ceff45ee-c862-41de-aee2-a022c81eda92}\"\n          )", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_via_explorer_suspicious_child_parent_args.toml"}
{"title": "ScreenConnect Server Spawning Suspicious Processes", "description": "Identifies suspicious processes being spawned by the ScreenConnect server process (ScreenConnect.Service.exe). This\nactivity may indicate exploitation activity or access to an existing web shell backdoor.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"ScreenConnect.Service.exe\" and\n  (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"csc.exe\") or\n  ?process.pe.original_file_name in (\"cmd.exe\", \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\"))", "tactic": "Initial Access", "technique": "Exploit Public-Facing Application", "technique_id": "T1190", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_webshell_screenconnect_server.toml"}
{"title": "Remote XSL Script Execution via COM", "description": "Identifies the execution of a hosted XSL script using the Microsoft.XMLDOM COM interface via Microsoft Office processes.\nThis behavior may indicate adversarial activity to execute malicious JScript or VBScript on the system.", "query": "sequence with maxspan=1m\n [library where host.os.type == \"windows\" and dll.name : \"msxml3.dll\" and\n  process.name : (\"winword.exe\", \"excel.exe\", \"powerpnt.exe\", \"mspub.exe\")] by process.entity_id\n [process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.parent.name : (\"winword.exe\", \"excel.exe\", \"powerpnt.exe\", \"mspub.exe\") and\n  not process.executable :\n        (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n         \"?:\\\\Windows\\\\SysWoW64\\\\WerFault.exe\",\n         \"?:\\\\windows\\\\splwow64.exe\",\n         \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n         \"?:\\\\Program Files\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\*exe\")] by process.parent.entity_id", "tactic": "Initial Access", "technique": "Phishing", "technique_id": "T1566", "risk_score": "N/A", "tags": [], "references": [], "file": "initial_access_xsl_script_execution_via_com.toml"}
{"title": "Potential Pass-the-Hash (PtH) Attempt", "description": "Adversaries may pass the hash using stolen password hashes to move laterally within an environment, bypassing normal\nsystem access controls. Pass the hash (PtH) is a method of authenticating as a user without having access to the user's\ncleartext password.", "query": "host.os.type:\"windows\" and\nevent.category : \"authentication\" and event.action : \"logged-in\" and\nwinlog.logon.type : \"NewCredentials\" and event.outcome : \"success\" and\nuser.id : (S-1-5-21-* or S-1-12-1-*) and winlog.event_data.LogonProcessName : \"seclogo\"", "tactic": "Lateral Movement", "technique": "Use Alternate Authentication Material", "technique_id": "T1550", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_alternate_creds_pth.toml"}
{"title": "Service Command Lateral Movement", "description": "Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversary\nlateral movement but will be noisy if commonly done by admins.", "query": "sequence by process.entity_id with maxspan = 1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"sc.exe\" or process.pe.original_file_name : \"sc.exe\") and\n      process.args : \"\\\\\\\\*\" and process.args : (\"binPath=*\", \"binpath=*\") and\n      process.args : (\"create\", \"config\", \"failure\", \"start\")]\n  [network where host.os.type == \"windows\" and process.name : \"sc.exe\" and destination.ip != \"127.0.0.1\"]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_cmd_service.toml"}
{"title": "Incoming DCOM Lateral Movement via MSHTA", "description": "Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which are\nlaunched via the HTA Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move\nlaterally while attempting to evade detection.", "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.name : \"mshta.exe\" and process.args : \"-Embedding\"\n  ] by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n     source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by host.id, process.entity_id", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_dcom_hta.toml"}
{"title": "Incoming DCOM Lateral Movement with MMC", "description": "Identifies the use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched\nvia the MMC20 Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move\nlaterally.", "query": "sequence by host.id with maxspan=1m\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mmc.exe\" and source.port >= 49152 and\n destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"mmc.exe\"\n ] by process.parent.entity_id", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_dcom_mmc20.toml"}
{"title": "Incoming DCOM Lateral Movement with ShellBrowserWindow or ShellWindows", "description": "Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via\nthe ShellBrowserWindow or ShellWindows Application COM Object. This behavior may indicate an attacker abusing a DCOM\napplication to stealthily move laterally.", "query": "sequence by host.id with maxspan=5s\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n  source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"explorer.exe\"\n ] by process.parent.entity_id", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_dcom_shellwindow_shellbrowserwindow.toml"}
{"title": "NullSessionPipe Registry Modification", "description": "Identifies NullSessionPipe registry modifications that specify which pipes can be accessed anonymously. This could be\nindicative of adversary lateral movement preparation by making the added pipe available to everyone.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\nregistry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\services\\\\LanmanServer\\\\Parameters\\\\NullSessionPipes\"\n) and length(registry.data.strings) > 0 and\nnot registry.data.strings : \"(empty)\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_defense_evasion_lanman_nullsessionpipe_modification.toml"}
{"title": "SMB Connections via LOLBin or Untrusted Process", "description": "Identifies potentially suspicious processes that are not trusted or living-off-the-land binaries (LOLBin) making Server\nMessage Block (SMB) network connections over port 445. Windows File Sharing is typically implemented over SMB, which\ncommunicates between hosts using port 445. Legitimate connections are generally established by the kernel (PID 4). This\nrule helps to detect processes that might be port scanners, exploits, or user-level processes attempting lateral\nmovement within the network by leveraging SMB connections.", "query": "sequence by process.entity_id with maxspan=1m\n\n  /* first sequence to capture the start of Windows processes */\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.pid != 4 and\n\n    /* ignore NT Authority and Network Service accounts */\n    not user.id in (\"S-1-5-19\", \"S-1-5-20\") and\n\n    /* filter out anything trusted but not from Microsoft */\n    /* LOLBins will be inherently trusted and signed, so ignore everything else trusted */\n    not (process.code_signature.trusted == true and not startsWith(process.code_signature.subject_name, \"Microsoft\")) and\n\n    /* filter out PowerShell scripts from Windows Defender ATP */\n    not (\n      process.name : \"powershell.exe\" and\n      process.args :\"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\PSScript_*.ps1\")]\n\n  /* second sequence to capture network connections over port 445 related to SMB */\n  [network where host.os.type == \"windows\" and destination.port == 445 and process.pid != 4]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_direct_outbound_smb_connection.toml"}
{"title": "Potential Remote Desktop Shadowing Activity", "description": "Identifies the modification of the Remote Desktop Protocol (RDP) Shadow registry or the execution of processes\nindicative of an active RDP shadowing session. An adversary may abuse the RDP Shadowing feature to spy on or control\nother users active RDP sessions.", "query": "/* Identifies the modification of RDP Shadow registry or\n  the execution of processes indicative of active shadow RDP session */\n\nany where host.os.type == \"windows\" and\n(\n  (event.category == \"registry\" and\n     registry.path : (\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\Terminal Services\\\\Shadow\"\n    )\n  ) or\n  (event.category == \"process\" and event.type == \"start\" and\n     (process.name : (\"RdpSaUacHelper.exe\", \"RdpSaProxy.exe\") and process.parent.name : \"svchost.exe\") or\n     (?process.pe.original_file_name : \"mstsc.exe\" and process.args : \"/shadow:*\")\n  )\n)", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_evasion_rdp_shadowing.toml"}
{"title": "Potential Lateral Tool Transfer via SMB Share", "description": "Identifies the creation or change of a Windows executable file over network shares. Adversaries may transfer tools or\nother files between systems in a compromised environment.", "query": "sequence by host.id with maxspan=30s\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.pid == 4 and destination.port == 445 and\n   network.direction : (\"incoming\", \"ingress\") and\n   network.transport == \"tcp\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by process.entity_id\n  /* add more executable extensions here if they are not noisy in your environment */\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and process.pid == 4 and \n   (file.Ext.header_bytes : \"4d5a*\" or file.extension : (\"exe\", \"scr\", \"pif\", \"com\", \"dll\"))] by process.entity_id", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_executable_tool_transfer_smb.toml"}
{"title": "Execution via TSClient Mountpoint", "description": "Identifies execution from the Remote Desktop Protocol (RDP) shared mountpoint tsclient on the target host. This may\nindicate a lateral movement attempt.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"\\\\Device\\\\Mup\\\\tsclient\\\\*.exe\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_execution_from_tsclient_mup.toml"}
{"title": "Remote Execution via File Shares", "description": "Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movement\nvia network file shares.", "query": "sequence with maxspan=1m\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and \n   process.pid == 4 and (file.extension : \"exe\" or file.Ext.header_bytes : \"4d5a*\")] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    not (\n      /* Veeam related processes */\n      (\n        process.name : (\n          \"VeeamGuestHelper.exe\", \"VeeamGuestIndexer.exe\", \"VeeamAgent.exe\", \"VeeamLogShipper.exe\",\n          \"Veeam.VSS.Sharepoint20??.exe\", \"OracleProxy.exe\", \"Veeam.SQL.Service\", \"VeeamDeploymentSvc.exe\"\n        ) and process.code_signature.trusted == true and process.code_signature.subject_name : \"Veeam Software Group GmbH\"\n      ) or\n      /* PDQ related processes */\n      (\n        process.name : (\n          \"PDQInventoryScanner.exe\", \"PDQInventoryMonitor.exe\", \"PDQInventory-Scanner-?.exe\",\n          \"PDQInventoryWakeCommand-?.exe\", \"PDQDeployRunner-?.exe\"\n        ) and process.code_signature.trusted == true and process.code_signature.subject_name : \"PDQ.com Corporation\"\n      ) or\n      /* CrowdStrike related processes */\n      (\n        (process.executable : \"?:\\\\Windows\\\\System32\\\\drivers\\\\CrowdStrike\\\\*Sensor*.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"CrowdStrike, Inc.\") or\n        (process.executable : \"?:\\\\Windows\\\\System32\\\\drivers\\\\CrowdStrike\\\\*-CsInstallerService.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Windows Hardware Compatibility Publisher\")\n      ) or\n      /* MS related processes */\n      (\n        process.executable == \"System\" or\n        (process.executable : \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Corporation\")\n      ) or\n      /* CyberArk processes */\n      (\n        process.executable : \"?:\\\\Windows\\\\CAInvokerService.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"CyberArk Software Ltd.\"\n      )  or\n      /* Sophos processes */\n      (\n        process.executable : \"?:\\\\ProgramData\\\\Sophos\\\\AutoUpdate\\\\Cache\\\\sophos_autoupdate1.dir\\\\SophosUpdate.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"Sophos Ltd\"\n      )  or\n      /* Elastic processes */\n      (\n        process.executable : (\n          \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\previous\\\\elastic-endpoint.exe\",\n          \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\elastic-agent.exe\",\n          \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\elastic-agent-*\\\\components\\\\agentbeat.exe\"\n        ) and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"Elasticsearch, Inc.\"\n      ) \n    )\n  ] by host.id, process.executable", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_execution_via_file_shares_sequence.toml"}
{"title": "Incoming Execution via WinRM Remote Shell", "description": "Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be an\nindication of lateral movement.", "query": "sequence by host.id with maxspan=30s\n   [network where host.os.type == \"windows\" and process.pid == 4 and network.direction : (\"incoming\", \"ingress\") and\n    destination.port in (5985, 5986) and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and\n    event.type == \"start\" and process.parent.name : \"winrshost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_incoming_winrm_shell_execution.toml"}
{"title": "WMI Incoming Lateral Movement", "description": "Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of\nadversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts.", "query": "N/A", "tactic": "", "technique": "", "technique_id": "", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_incoming_wmi.toml"}
{"title": "Mounting Hidden or WebDav Remote Shares", "description": "Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement or\npreparation for data exfiltration.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n ((process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and\n not process.parent.name : \"net.exe\")) and\n process.args : \"use\" and\n /* including hidden and webdav based online shares such as onedrive  */\n process.args : (\"\\\\\\\\*\\\\*$*\", \"\\\\\\\\*@SSL\\\\*\", \"http*\") and\n /* excluding shares deletion operation */\n not process.args : \"/d*\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_mount_hidden_or_webdav_share_net.toml"}
{"title": "Incoming Execution via PowerShell Remoting", "description": "Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run any\nWindows PowerShell command on one or more remote computers. This could be an indication of lateral movement.", "query": "sequence by host.id with maxspan = 30s\n   [network where host.os.type == \"windows\" and network.direction : (\"incoming\", \"ingress\") and destination.port in (5985, 5986) and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and\n    event.type == \"start\" and process.parent.name : \"wsmprovhost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_powershell_remoting_target.toml"}
{"title": "RDP Enabled via Registry", "description": "Identifies registry write modifications to enable Remote Desktop Protocol (RDP) access. This could be indicative of\nadversary lateral movement preparation.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\",\n    \"MACHINE\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\"\n  ) and\n  registry.data.strings : (\"0\", \"0x00000000\") and\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\SystemPropertiesRemote.exe\", \n                            \"?:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe\", \n                            \"?:\\\\Windows\\\\System32\\\\SystemPropertiesAdvanced.exe\", \n                            \"?:\\\\Windows\\\\System32\\\\SystemSettingsAdminFlows.exe\", \n                            \"?:\\\\Windows\\\\WinSxS\\\\*\\\\TiWorker.exe\", \n                            \"?:\\\\Windows\\\\system32\\\\svchost.exe\")", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_rdp_enabled_registry.toml"}
{"title": "Potential SharpRDP Behavior", "description": "Identifies potential behavior of SharpRDP, which is a tool that can be used to perform authenticated command execution\nagainst a remote target via Remote Desktop Protocol (RDP) for the purposes of lateral movement.", "query": "/* Incoming RDP followed by a new RunMRU string value set to cmd, powershell, taskmgr or tsclient, followed by process execution within 1m */\n\nsequence by host.id with maxspan=1m\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"svchost.exe\" and destination.port == 3389 and\n   network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ]\n\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and process.name : \"explorer.exe\" and\n   registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\RunMRU\\\\*\") and\n   registry.data.strings : (\"cmd.exe*\", \"powershell.exe*\", \"taskmgr*\", \"\\\\\\\\tsclient\\\\*.exe\\\\*\")\n  ]\n\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.parent.name : (\"cmd.exe\", \"powershell.exe\", \"taskmgr.exe\") or process.args : (\"\\\\\\\\tsclient\\\\*.exe\")) and\n   not process.name : \"conhost.exe\"\n   ]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_rdp_sharprdp_target.toml"}
{"title": "Remote File Copy to a Hidden Share", "description": "Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data staging\nactivity.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"xcopy.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and \n  process.command_line : \"*\\\\\\\\*\\\\*$*\" and process.command_line : (\"*copy*\", \"*move*\", \"* cp *\", \"* mv *\")", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_remote_file_copy_hidden_share.toml"}
{"title": "Remotely Started Services via RPC", "description": "Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral\nmovement, but will be noisy if commonly done by administrators.", "query": "sequence with maxspan=1s\n   [network where host.os.type == \"windows\" and process.name : \"services.exe\" and\n      network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n      source.port >= 49152 and destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ] by host.id, process.entity_id\n   [process where host.os.type == \"windows\" and \n       event.type == \"start\" and process.parent.name : \"services.exe\" and\n       not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"/V\") and\n       not process.executable : (\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\srmhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\"\n       )] by host.id, process.parent.entity_id", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_remote_services.toml"}
{"title": "Remote Windows Service Installed", "description": "Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateral\nmovement, but will be noisy if commonly done by administrators.\"", "query": "sequence by winlog.logon.id, winlog.computer_name with maxspan=1m\n[authentication where event.action == \"logged-in\" and winlog.logon.type : \"Network\" and\nevent.outcome==\"success\" and source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n[iam where event.action == \"service-installed\" and\n not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n not winlog.event_data.ServiceFileName :\n               (\"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\WINDOWS\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\")]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_remote_service_installed_winlog.toml"}
{"title": "Remote Scheduled Task Creation via RPC", "description": "Identifies scheduled task creation from a remote source. This could be indicative of adversary lateral movement.", "query": "iam where event.action == \"scheduled-task-created\" and\n winlog.event_data.RpcCallClientLocality : \"0\" and winlog.event_data.ClientProcessId : \"0\"", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_remote_task_creation_winlog.toml"}
{"title": "Remote Scheduled Task Creation", "description": "Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement.", "query": "/* Task Scheduler service incoming connection followed by TaskCache registry modification  */\n\nsequence by host.id, process.entity_id with maxspan = 1m\n   [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and\n   network.direction : (\"incoming\", \"ingress\") and source.port >= 49152 and destination.port >= 49152 and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ]\n   [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"]", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_scheduled_task_target.toml"}
{"title": "Suspicious RDP ActiveX Client Loaded", "description": "Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate the\npresence of RDP lateral movement capability.", "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : \"mstscax.dll\" or file.name : \"mstscax.dll\") and\n   /* depending on noise in your env add here extra paths  */\n  process.executable : (\n    \"C:\\\\Windows\\\\*\",\n    \"C:\\\\Users\\\\Public\\\\*\",\n    \"C:\\\\Users\\\\Default\\\\*\",\n    \"C:\\\\Intel\\\\*\",\n    \"C:\\\\PerfLogs\\\\*\",\n    \"C:\\\\ProgramData\\\\*\",\n    \"\\\\Device\\\\Mup\\\\*\",\n    \"\\\\\\\\*\"\n  ) and\n  /* add here FPs */\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\System32\\\\vmconnect.exe\",\n    \"?:\\\\Windows\\\\System32\\\\WindowsSandboxClient.exe\",\n    \"?:\\\\Windows\\\\System32\\\\hvsirdpclient.exe\"\n  )", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_suspicious_rdp_client_imageload.toml"}
{"title": "Unusual Child Process of dns.exe", "description": "Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, which\nmay indicate activity related to remote code execution or other forms of exploitation.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"dns.exe\" and\n  not process.name : \"conhost.exe\"", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_unusual_dns_service_children.toml"}
{"title": "Unusual File Modification by dns.exe", "description": "Identifies an unexpected file being modified by dns.exe, the process responsible for Windows DNS Server services, which\nmay indicate activity related to remote code execution or other forms of exploitation.", "query": "file where host.os.type == \"windows\" and process.name : \"dns.exe\" and event.type in (\"creation\", \"deletion\", \"change\") and\n  not file.name : \"dns.log\" and not\n  (file.extension : (\"old\", \"temp\", \"bak\", \"dns\", \"arpa\") and file.path : \"C:\\\\Windows\\\\System32\\\\dns\\\\*\") and\n\n  /* DNS logs with custom names, header converts to \"DNS Server log\" */\n  not ?file.Ext.header_bytes : \"444e5320536572766572206c6f67*\"", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_unusual_dns_service_file_writes.toml"}
{"title": "Lateral Movement via Startup Folder", "description": "Identifies suspicious file creations in the startup folder of a remote system. An adversary could abuse this to move\nlaterally by dropping a malicious script or executable that will be executed after a reboot or user logon.", "query": "file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and\n\n /* via RDP TSClient mounted share or SMB */\n  (process.name : \"mstsc.exe\" or process.pid == 4) and\n\n   file.path : (\"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\")", "tactic": "Lateral Movement", "technique": "Remote Services", "technique_id": "T1021", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_via_startup_folder_rdp_smb.toml"}
{"title": "Potential WSUS Abuse for Lateral Movement", "description": "Identifies a potential Windows Server Update Services (WSUS) abuse to execute psexec to enable for lateral movement.\nWSUS is limited to executing Microsoft signed binaries, which limits the executables that can be used to tools published\nby Microsoft.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"wuauclt.exe\" and\nprocess.executable : (\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\"\n) and\n(process.name : \"psexec64.exe\" or ?process.pe.original_file_name : \"psexec.c\")", "tactic": "Lateral Movement", "technique": "Exploitation of Remote Services", "technique_id": "T1210", "risk_score": "N/A", "tags": [], "references": [], "file": "lateral_movement_via_wsus_update.toml"}
{"title": "Adobe Hijack Persistence", "description": "Detects writing executable files that will be automatically launched by Adobe on launch.", "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.path : (\"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n               \"?:\\\\Program Files\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\") and\n  not process.name : \"msiexec.exe\"", "tactic": "Persistence", "technique": "Compromise Host Software Binary", "technique_id": "T1554", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_adobe_hijack_persistence.toml"}
{"title": "AdminSDHolder Backdoor", "description": "Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent\nbackdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the\nAdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on\nthe protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their\nAdministrative Privileges.", "query": "event.code:5136 and winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ad_adminsdholder.toml"}
{"title": "Registry Persistence via AppCert DLL", "description": "Detects attempts to maintain persistence by creating registry keys using AppCert DLLs. AppCert DLLs are loaded by every\nprocess using the common API functions to create processes.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\"\n  )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_appcertdlls_registry.toml"}
{"title": "Registry Persistence via AppInit DLL", "description": "AppInit DLLs are dynamic-link libraries (DLLs) that are loaded into every process that creates a user interface (loads\nuser32.dll) on Microsoft Windows operating systems. The AppInit DLL mechanism is used to load custom code into user-mode\nprocesses, allowing for the customization of the user interface and the behavior of Windows-based applications.\nAttackers who add those DLLs to the registry locations can execute code with elevated privileges, similar to process\ninjection, and provide a solid and constant persistence on the machine.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n     \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"HKLM\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\",\n     \"MACHINE\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\AppInit_Dlls\"\n  ) and\n  not process.executable : (\n     \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*\\\\Display.NvContainer\\\\NVDisplay.Container.exe\",\n     \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n     \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n     \"?:\\\\Program Files\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files (x86)\\\\Commvault\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files (x86)\\\\Commvault\\\\ContentStore*\\\\Base\\\\cvd.exe\",\n     \"?:\\\\Program Files\\\\NVIDIA Corporation\\\\Display.NvContainer\\\\NVDisplay.Container.exe\"\n  )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_appinitdlls_registry.toml"}
{"title": "Installation of Custom Shim Databases", "description": "Identifies the installation of custom Application Compatibility Shim databases. This Windows functionality has been\nabused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\",\n        \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\AppCompatFlags\\\\Custom\\\\*.sdb\"\n    ) and\n    not process.executable :\n                       (\"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\swrepository\\\\1\\\\swuploads\\\\SAP-SLC\\\\SAPSetupSLC02_14-80001954\\\\Setup\\\\NwSapSetup.exe\",\n                        \"?:\\\\$WINDOWS.~BT\\\\Sources\\\\SetupPlatform.exe\",\n                         \"?:\\\\Program Files (x86)\\\\SAP\\\\SAPsetup\\\\setup\\\\NwSapSetup.exe\",\n                         \"?:\\\\Program Files (x86)\\\\SAP\\\\SapSetup\\\\OnRebootSvc\\\\NWSAPSetupOnRebootInstSvc.exe\",\n                         \"?:\\\\Program Files (x86)\\\\Kaspersky Lab\\\\Kaspersky Security for Windows Server\\\\kavfs.exe\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_app_compat_shim.toml"}
{"title": "Browser Extension Install", "description": "Identifies the install of browser extensions. Malicious browser extensions can be installed via app store downloads\nmasquerading as legitimate extensions, social engineering, or by an adversary that has already compromised a system.", "query": "file where host.os.type == \"windows\" and event.type : \"creation\" and\n(\n  /* Firefox-Based Browsers */\n  (\n    file.name : \"*.xpi\" and\n    file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\\\\Profiles\\\\*\\\\Extensions\\\\*.xpi\" and\n    not\n    (\n      process.name : \"firefox.exe\" and\n      file.name : (\"langpack-*@firefox.mozilla.org.xpi\", \"*@dictionaries.addons.mozilla.org.xpi\")\n    )\n  ) or\n  /* Chromium-Based Browsers */\n  (\n    file.name : \"*.crx\" and\n    file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\*\\\\*\\\\User Data\\\\Webstore Downloads\\\\*\"\n  )\n)", "tactic": "Persistence", "technique": "Software Extensions", "technique_id": "T1176", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_browser_extension_install.toml"}
{"title": "Creation of a Hidden Local User Account", "description": "Identifies the creation of a hidden local user account by appending the dollar sign to the account name. This is\nsometimes done by attackers to increase access to a system and avoid appearing in the results of accounts listing using\nthe net users command.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\",\n    \"MACHINE\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\\\\Names\\\\*$\\\\\"\n)", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_evasion_hidden_local_account_creation.toml"}
{"title": "Image File Execution Options Injection", "description": "The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing a\ndifferent process to be executed. This functionality can be abused by an adversary to establish persistence.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : (\"Debugger\", \"MonitorProcess\") and length(registry.data.strings) > 0 and\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\"\n  ) and\n    /* add FPs here */\n  not registry.data.strings regex~ (\"\"\"C:\\\\Program Files( \\(x86\\))?\\\\ThinKiosk\\\\thinkiosk\\.exe\"\"\", \"\"\".*\\\\PSAppDeployToolkit\\\\.*\"\"\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_evasion_registry_ifeo_injection.toml"}
{"title": "Suspicious Startup Shell Folder Modification", "description": "Identifies suspicious startup shell folder modifications to change the default Startup directory in order to bypass\ndetections monitoring file creation in the Windows Startup folder.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.value : (\"Common Startup\", \"Startup\") and\n registry.path : (\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"HKCU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"HKCU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\",\n     \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Common Startup\",\n     \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Common Startup\",\n     \"USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\User Shell Folders\\\\Startup\",\n     \"USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Shell Folders\\\\Startup\"\n     ) and\n  registry.data.strings != null and\n  /* Normal Startup Folder Paths */\n  not registry.data.strings : (\n           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%ProgramData%\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"%USERPROFILE%\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\",\n           \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\"\n           )", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_evasion_registry_startup_shell_folder_modified.toml"}
{"title": "Active Directory Group Modification by SYSTEM", "description": "Identifies a user being added to an active directory group by the SYSTEM (S-1-5-18) user. This behavior can indicate\nthat the attacker has achieved SYSTEM privileges in a domain controller, which attackers can obtain by exploiting\nvulnerabilities or abusing default group privileges (e.g., Server Operators), and is attempting to pivot to a domain\naccount.", "query": "iam where host.os.type == \"windows\" and event.code == \"4728\" and\nwinlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n/* DOMAIN_USERS and local groups */\nnot group.id : \"S-1-5-21-*-513\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_group_modification_by_system.toml"}
{"title": "Persistence via Scheduled Job Creation", "description": "A job can be used to schedule programs or scripts to be executed at a specified date and time. Adversaries may abuse\ntask scheduling functionality to facilitate initial or recurring execution of malicious code.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.path : \"?:\\\\Windows\\\\Tasks\\\\*\" and file.extension : \"job\" and\n  not (\n    (\n      process.executable : \"?:\\\\Program Files\\\\CCleaner\\\\CCleaner64.exe\" and\n      file.path : \"?:\\\\Windows\\\\Tasks\\\\CCleanerCrashReporting.job\"\n    ) or\n    (\n      process.executable : (\n        \"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\dcagentregister.exe\",\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcagentregister.exe\"\n      ) and\n      file.path : \"?:\\\\Windows\\\\Tasks\\\\DCAgentUpdater.job\"\n    )\n  )", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_local_scheduled_job_creation.toml"}
{"title": "Local Scheduled Task Creation", "description": "Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or\nescalate privileges.", "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    ((process.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                      \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") or\n    process.pe.original_file_name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                                     \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\",\n                                     \"winrshost.exe\")) or\n    ?process.code_signature.trusted == false)] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"schtasks.exe\" or process.pe.original_file_name == \"schtasks.exe\") and\n    process.args : (\"/create\", \"-create\") and process.args : (\"/RU\", \"/SC\", \"/TN\", \"/TR\", \"/F\", \"/XML\") and\n    /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */\n    not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n  ] by process.parent.entity_id", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_local_scheduled_task_creation.toml"}
{"title": "Scheduled Task Created by a Windows Script", "description": "A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by\nan adversary to establish persistence.", "query": "sequence by host.id with maxspan = 30s\n  [any where host.os.type == \"windows\" and \n    (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n    (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and\n    process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"\n  )]", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_local_scheduled_task_scripting.toml"}
{"title": "KRBTGT Delegation Backdoor", "description": "Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique to\nmaintain persistence to the domain by having the ability to request tickets for the KRBTGT service.", "query": "iam where event.code == \"4738\" and winlog.event_data.AllowedToDelegateTo : \"*krbtgt*\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_msds_alloweddelegateto_krbtgt.toml"}
{"title": "Persistence via a Windows Installer", "description": "Identifies when the Windows installer process msiexec.exe creates a new persistence entry via scheduled tasks or startup.", "query": "any where host.os.type == \"windows\" and\n (process.name : \"msiexec.exe\" or Effective_process.name : \"msiexec.exe\") and\n (\n  (event.category == \"file\" and event.action == \"creation\" and\n   file.path : (\"?:\\\\Windows\\\\System32\\\\Tasks\\\\*\",\n                \"?:\\\\programdata\\\\microsoft\\\\windows\\\\start menu\\\\programs\\\\startup\\\\*\",\n                \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\")) or\n\n  (event.category == \"registry\" and event.action == \"modification\" and\n   registry.path : (\"H*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                    \"H*\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                    \"H*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                    \"H*\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\"))\n  )", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_msi_installer_task_startup.toml"}
{"title": "Office Test Registry Persistence", "description": "Identifies the modification of the Microsoft Office \"Office Test\" Registry key, a registry location that can be used to\nspecify a DLL which will be executed every time an MS Office application is started. Attackers can abuse this to gain\npersistence on a compromised host.", "query": "registry where host.os.type == \"windows\" and event.action != \"deletion\" and\n    registry.path : \"*\\\\Software\\\\Microsoft\\\\Office Test\\\\Special\\\\Perf\\\\*\"", "tactic": "Persistence", "technique": "Office Application Startup", "technique_id": "T1137", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_msoffice_startup_registry.toml"}
{"title": "Persistence via Microsoft Office AddIns", "description": "Detects attempts to establish persistence on an endpoint by abusing Microsoft Office add-ins.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n file.extension : (\"wll\",\"xll\",\"ppa\",\"ppam\",\"xla\",\"xlam\") and\n file.path :\n    (\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Word\\\\Startup\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\AddIns\\\\*\",\n    \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Excel\\\\XLSTART\\\\*\"\n    )", "tactic": "Persistence", "technique": "Office Application Startup", "technique_id": "T1137", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ms_office_addins_file.toml"}
{"title": "Persistence via Microsoft Outlook VBA", "description": "Detects attempts to establish persistence on an endpoint by installing a rogue Microsoft Outlook VBA Template.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n file.path : \"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Outlook\\\\VbaProject.OTM\"", "tactic": "Persistence", "technique": "Office Application Startup", "technique_id": "T1137", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_ms_outlook_vba_template.toml"}
{"title": "Netsh Helper DLL", "description": "Identifies the addition of a Netsh Helper DLL, netsh.exe supports the addition of these DLLs to extend its\nfunctionality. Attackers may abuse this mechanism to execute malicious payloads every time the utility is executed,\nwhich can be done by administrators or a scheduled task.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\Software\\\\Microsoft\\\\netsh\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\netsh\\\\*\",\n    \"MACHINE\\\\Software\\\\Microsoft\\\\netsh\\\\*\"\n  )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_netsh_helper_dll.toml"}
{"title": "New ActiveSyncAllowedDeviceID Added via PowerShell", "description": "Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device.\nAdversaries may target user email to collect sensitive information.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and process.args : \"Set-CASMailbox*ActiveSyncAllowedDeviceIDs*\"", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_powershell_exch_mailbox_activesync_add_device.toml"}
{"title": "Persistence via PowerShell profile", "description": "Identifies the creation or modification of a PowerShell profile. PowerShell profile is a script that is executed when\nPowerShell starts to customize the user environment, which can be abused by attackers to persist in a environment where\nPowerShell is common.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.path : (\"?:\\\\Users\\\\*\\\\Documents\\\\WindowsPowerShell\\\\*\",\n               \"?:\\\\Users\\\\*\\\\Documents\\\\PowerShell\\\\*\",\n               \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\*\") and\n  file.name : (\"profile.ps1\", \"Microsoft.Powershell_profile.ps1\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_powershell_profiles.toml"}
{"title": "Potential Modification of Accessibility Binaries", "description": "Windows contains accessibility features that may be launched with a key combination before a user has logged in. An\nadversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the\nsystem.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : (\"Utilman.exe\", \"winlogon.exe\") and user.name == \"SYSTEM\" and\n process.pe.original_file_name : \"?*\" and\n process.args :\n    (\n    \"C:\\\\Windows\\\\System32\\\\osk.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Magnify.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Narrator.exe\",\n    \"C:\\\\Windows\\\\System32\\\\Sethc.exe\",\n    \"utilman.exe\",\n    \"ATBroker.exe\",\n    \"DisplaySwitch.exe\",\n    \"sethc.exe\"\n    )\n and not process.pe.original_file_name in\n    (\n    \"osk.exe\",\n    \"sethc.exe\",\n    \"utilman2.exe\",\n    \"DisplaySwitch.exe\",\n    \"ATBroker.exe\",\n    \"ScreenMagnifier.exe\",\n    \"SR.exe\",\n    \"Narrator.exe\",\n    \"magnify.exe\",\n    \"MAGNIFY.EXE\"\n    )\n\n/* uncomment once in winlogbeat to avoid bypass with rogue process with matching pe original file name */\n/* and process.code_signature.subject_name == \"Microsoft Windows\" and process.code_signature.status == \"trusted\" */", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_priv_escalation_via_accessibility_features.toml"}
{"title": "Uncommon Registry Persistence Change", "description": "Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could\nbe an indication of an adversary's attempt to persist in a stealthy manner.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n length(registry.data.strings) > 0 and\n registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Runonce\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Run\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\IconServiceLib\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\AppSetup\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Taskman\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\VmApplet\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components\\\\*\\\\ShellComponent\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnConnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnDisconnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\Control Panel\\\\Desktop\\\\scrnsave.exe\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\VerifierDlls\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\GpExtensions\\\\*\\\\DllName\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\SafeBoot\\\\AlternateShell\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\Wds\\\\rdpwd\\\\StartupPrograms\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\InitialProgram\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecuteNoPnpSync\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecuteNoPnpSync\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\PlatformExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\Execute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\S0InitialCommand\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\ServiceControlManagerExtension\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\BootVerificationProgram\\\\ImagePath\",\n      \"HKLM\\\\SYSTEM\\\\Setup\\\\CmdLine\",\n      \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\") and\n\n not registry.data.strings : (\"C:\\\\Windows\\\\system32\\\\userinit.exe\", \"cmd.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\",\n                              \"C:\\\\Program Files\\\\*.exe\") and\n not (process.name : \"rundll32.exe\" and registry.path : \"*\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\") and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n                           \"C:\\\\Program Files\\\\*.exe\",\n                           \"C:\\\\Program Files (x86)\\\\*.exe\") and\n not (process.name : (\"TiWorker.exe\", \"poqexec.exe\") and registry.value : \"SetupExecute\" and\n      registry.data.strings : (\n        \"C:\\\\windows\\\\System32\\\\poqexec.exe /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\",\n        \"C:\\\\Windows\\\\System32\\\\poqexec.exe /skip_critical_poq /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\"\n      )\n     ) and\n not (process.name : \"svchost.exe\" and registry.value : \"SCRNSAVE.EXE\" and\n      registry.data.strings : (\n        \"%windir%\\\\system32\\\\rundll32.exe user32.dll,LockWorkStation\",\n        \"scrnsave.scr\",\n        \"%windir%\\\\system32\\\\Ribbons.scr\"\n      )\n     )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_registry_uncommon.toml"}
{"title": "Account Password Reset Remotely", "description": "Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate account\npasswords to maintain access or evade password duration policies and preserve compromised credentials.", "query": "sequence by winlog.computer_name with maxspan=1m\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and event.outcome == \"success\" and source.ip != null and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not winlog.event_data.TargetUserName : (\"svc*\", \"PIM_*\", \"_*_\", \"*-*-*\", \"*$\")] by winlog.event_data.TargetLogonId\n   /* event 4724 need to be logged */\n  [iam where event.action == \"reset-password\" and\n   (\n    /*\n       This rule is very noisy if not scoped to privileged accounts, duplicate the\n       rule and add your own naming convention and accounts of interest here.\n     */\n    winlog.event_data.TargetUserName: (\"*Admin*\", \"*super*\", \"*SVC*\", \"*DC0*\", \"*service*\", \"*DMZ*\", \"*ADM*\") or\n    winlog.event_data.TargetSid : (\"S-1-5-21-*-500\", \"S-1-12-1-*-500\")\n    )\n  ] by winlog.event_data.SubjectLogonId", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_remote_password_reset.toml"}
{"title": "Execution of Persistent Suspicious Program", "description": "Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage and\ncommand line usage.", "query": "/* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */\nsequence by host.id, user.name with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"userinit.exe\" and process.parent.name : \"winlogon.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"explorer.exe\" and\n   /* add suspicious programs here */\n   process.pe.original_file_name in (\"cscript.exe\",\n                                     \"wscript.exe\",\n                                     \"PowerShell.EXE\",\n                                     \"MSHTA.EXE\",\n                                     \"RUNDLL32.EXE\",\n                                     \"REGSVR32.EXE\",\n                                     \"RegAsm.exe\",\n                                     \"MSBuild.exe\",\n                                     \"InstallUtil.exe\") and\n    /* add potential suspicious paths here */\n    process.args : (\"C:\\\\Users\\\\*\", \"C:\\\\ProgramData\\\\*\", \"C:\\\\Windows\\\\Temp\\\\*\", \"C:\\\\Windows\\\\Tasks\\\\*\", \"C:\\\\PerfLogs\\\\*\", \"C:\\\\Intel\\\\*\")\n   ]", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_runtime_run_key_startup_susp_procs.toml"}
{"title": "Startup or Run Key Registry Modification", "description": "Identifies run key or startup key registry modifications. In order to survive reboots and other system interrupts,\nattackers will modify run keys within the registry or leverage startup folder items as a form of persistence.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.data.strings != null and registry.hive : (\"HKEY_USERS\", \"HKLM\") and\n registry.path : (\n     /* Machine Hive */\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKLM\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n     /* Users Hive */\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n     \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\"\n     ) and\n  /* add common legitimate changes without being too restrictive as this is one of the most abused AESPs */\n  not registry.data.strings : \"ctfmon.exe /n\" and\n  not (registry.value : \"Application Restart #*\" and process.name : \"csrss.exe\") and\n  not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n  not registry.data.strings : (\"?:\\\\Program Files\\\\*.exe\", \"?:\\\\Program Files (x86)\\\\*.exe\") and\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\") and\n  not (\n    /* Logitech G Hub */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Logitech Inc\" and\n      (\n        process.name : \"lghub_agent.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files\\\\LGHUB\\\\lghub.exe\\\" --background\",\n          \"\\\"?:\\\\Program Files\\\\LGHUB\\\\system_tray\\\\lghub_system_tray.exe\\\" --minimized\"\n        )\n      ) or\n      (\n        process.name : \"LogiBolt.exe\" and registry.data.strings : (\n          \"?:\\\\Program Files\\\\Logi\\\\LogiBolt\\\\LogiBolt.exe --startup\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Logi\\\\LogiBolt\\\\LogiBolt.exe --startup\"\n        )\n      )\n    ) or\n\n    /* Google Drive File Stream, Chrome, and Google Update */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Google LLC\" and\n      (\n        process.name : \"GoogleDriveFS.exe\" and registry.data.strings : (\n        \"\\\"?:\\\\Program Files\\\\Google\\\\Drive File Stream\\\\*\\\\GoogleDriveFS.exe\\\" --startup_mode\"\n        ) or\n\n        process.name : \"chrome.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --no-startup-window /prefetch:5\",\n          \"\\\"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\\\" --no-startup-window /prefetch:5\"\n        ) or\n\n        process.name : (\"GoogleUpdate.exe\", \"updater.exe\") and registry.data.strings : (\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Update\\\\*\\\\GoogleUpdateCore.exe\\\"\",\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\GoogleUpdater\\\\*\\\\updater.exe\\\" --wake\"\n        )\n      )\n    ) or\n\n    /* MS Programs */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name in (\"Microsoft Windows\", \"Microsoft Corporation\") and\n      (\n        process.name : \"msedge.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\" --no-startup-window --win-session-start /prefetch:5\",\n          \"\\\"C:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\" --win-session-start\",\n          \"\\\"C:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\\\" --no-startup-window --win-session-start\"\n        ) or\n\n        process.name : (\"Update.exe\", \"Teams.exe\", \"ms-teamsupdate.exe\") and registry.data.strings : (\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\Update.exe --processStart \\\"Teams.exe\\\" --process-start-args \\\"--system-initiated\\\"\",\n          \"?:\\\\ProgramData\\\\*\\\\Microsoft\\\\Teams\\\\Update.exe --processStart \\\"Teams.exe\\\" --process-start-args \\\"--system-initiated\\\"\",\n          \"ms-teamsupdate.exe -UninstallT20\"\n        ) or\n\n        process.name : (\"OneDrive*.exe\", \"Microsoft.SharePoint.exe\") and registry.data.strings : (\n            \"?:\\\\Program Files\\\\Microsoft OneDrive\\\\OneDrive.exe /background *\",\n            \"?:\\\\Program Files (x86)\\\\Microsoft OneDrive\\\\OneDrive.exe /background*\",\n            \"\\\"?:\\\\Program Files (x86)\\\\Microsoft OneDrive\\\\OneDrive.exe\\\" /background*\",\n            \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\\\" /background\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\??.???.????.????\\\\Microsoft.SharePoint.exe\",\n            \"?:\\\\Windows\\\\system32\\\\cmd.exe /q /c * \\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\*\\\"\"\"        ) or\n\n        process.name : \"MicrosoftEdgeUpdate.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\EdgeUpdate\\\\*\\\\MicrosoftEdgeUpdateCore.exe\\\"\"\"        ) or\n        \n        process.executable : \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\Installer\\\\setup.exe\" and\n        registry.data.strings : (\n          \"\\\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\Installer\\\\setup.exe\\\" --msedgewebview --delete-old-versions --system-level --verbose-logging --on-logon\"\n        ) or\n\n        process.name : \"BingWallpaper.exe\" and registry.data.strings : (\n          \"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\UnInstDaemon.exe\"\n        ) or\n\n        /* Discord Update.exe via reg.exe */\n        process.name : \"reg.exe\" and registry.data.strings : (\n          \"\\\"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Discord\\\\Update.exe\\\" --processStart Discord.exe\"\n        )\n      )\n    ) or\n\n    /* Slack */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name in (\n       \"Slack Technologies, Inc.\", \"Slack Technologies, LLC\"\n      ) and process.name : \"slack.exe\" and registry.data.strings : (\n        \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\slack.exe\\\" --process-start-args --startup\",\n        \"\\\"?:\\\\ProgramData\\\\*\\\\slack\\\\slack.exe\\\" --process-start-args --startup\",\n        \"\\\"?:\\\\Program Files\\\\Slack\\\\slack.exe\\\" --process-start-args --startup\"\n      )\n    ) or\n\n    /* Cisco */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and\n      (\n        process.name : \"WebexHost.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\WebEx\\\\WebexHost.exe\\\" /daemon /runFrom=autorun\"\n        )\n      ) or\n      (\n        process.name : \"CiscoJabber.exe\" and registry.data.strings : (\n          \"\\\"?:\\\\Program Files (x86)\\\\Cisco Systems\\\\Cisco Jabber\\\\CiscoJabber.exe\\\" /min\"\n        )\n      )\n    ) or\n\n    /* Loom */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Loom, Inc.\" and\n      process.name : \"Loom.exe\" and registry.data.strings : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Loom\\\\Loom.exe --process-start-args \\\"--loomHidden\\\"\"\"      )\n    ) or\n\n    /* Adobe */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Adobe Inc.\" and\n      process.name : (\"Acrobat.exe\", \"FlashUtil32_*_Plugin.exe\") and registry.data.strings : (\n        \"\\\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\AdobeCollabSync.exe\\\"\",\n        \"\\\"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\AdobeCollabSync.exe\\\"\",\n        \"?:\\\\WINDOWS\\\\SysWOW64\\\\Macromed\\\\Flash\\\\FlashUtil32_*_Plugin.exe -update plugin\"\n      )\n    ) or\n\n    /* CCleaner */\n    (\n      process.code_signature.trusted == true and\n      process.code_signature.subject_name in (\"PIRIFORM SOFTWARE LIMITED\", \"Gen Digital Inc.\") and\n      process.name : (\"CCleanerBrowser.exe\", \"CCleaner64.exe\") and registry.data.strings : (\n        \"\\\"C:\\\\Program Files (x86)\\\\CCleaner Browser\\\\Application\\\\CCleanerBrowser.exe\\\" --check-run=src=logon --auto-launch-at-startup --profile-directory=\\\"Default\\\"\",\n        \"\\\"C:\\\\Program Files\\\\CCleaner\\\\CCleaner64.exe\\\" /MONITOR\"\n      )\n    ) or\n\n    /* Opera */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Opera Norway AS\" and\n      process.name : (\"opera.exe\", \"assistant_installer.exe\") and registry.data.strings : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\launcher.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\opera.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera GX\\\\launcher.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera GX\\\\opera.exe\",\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera\\\\assistant\\\\browser_assistant.exe\"\n      )\n    ) or\n\n    /* Avast */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Avast Software s.r.o.\" and\n      process.name : \"AvastBrowser.exe\" and registry.data.strings : (\n        \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\AVAST Software\\\\Browser\\\\Application\\\\AvastBrowser.exe\\\" --check-run=src=logon --auto-launch-at-startup*\",\n        \"\\\"?:\\\\Program Files (x86)\\\\AVAST Software\\\\Browser\\\\Application\\\\AvastBrowser.exe\\\" --check-run=src=logon --auto-launch-at-startup*\",\n        \"\"\"      )\n    ) or\n\n    /* Grammarly */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Grammarly, Inc.\" and\n      process.name : \"GrammarlyInstaller.exe\" and registry.data.strings : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Grammarly\\\\DesktopIntegrations\\\\Grammarly.Desktop.exe\",\n        \"\\\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Grammarly\\\\DesktopIntegrations\\\\Grammarly.Desktop.exe\\\"\"\"      )\n    ) or\n\n    /* AVG */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"AVG Technologies USA, LLC\" and\n      process.name : \"AVGBrowser.exe\" and registry.data.strings : (\n        \"\\\"C:\\\\Program Files\\\\AVG\\\\Browser\\\\Application\\\\AVGBrowser.exe\\\"*\",\n        \"\\\"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\AVG\\\\Browser\\\\Application\\\\AVGBrowser.exe\\\"*\"\n      )\n    ) or\n\n    /* HP */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"HP Inc.\" and\n      process.name : \"ScanToPCActivationApp.exe\" and registry.data.strings : (\n        \"\\\"C:\\\\Program Files\\\\HP\\\\HP*\"\n      )\n    ) or\n\n    /* 1Password */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Agilebits\" and\n      process.name : \"1PasswordSetup*.exe\" and registry.data.strings : (\n        \"\\\"C:\\\\Users\\\\*\\\\AppData\\\\Local\\\\1Password\\\\app\\\\?\\\\1Password.exe\\\" --silent\"\n      )\n    ) or\n\n    /* OpenVPN */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"OpenVPN Inc.\" and\n      process.name : \"OpenVPNConnect.exe\" and registry.data.strings : (\n        \"C:\\\\Program Files\\\\OpenVPN Connect\\\\OpenVPNConnect.exe --opened-at-login --minimize\"\n      )\n    ) or\n\n    /* Docker */\n    (\n      process.code_signature.trusted == true and process.code_signature.subject_name == \"Docker Inc\" and\n      process.name: \"com.docker.backend.exe\" and registry.data.strings : (\n        \"C:\\\\Program Files\\\\Docker\\\\Docker\\\\Docker Desktop.exe -Autostart\"\n      )\n    )\n  )", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_run_key_and_startup_broad.toml"}
{"title": "A scheduled task was created", "description": "Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence,\nmove laterally, and/or escalate privileges.", "query": "iam where event.action == \"scheduled-task-created\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and\n\n /* TaskContent is not parsed, exclude by full taskname noisy ones */\n not winlog.event_data.TaskName : (\n              \"\\\\CreateExplorerShellUnelevatedTask\",\n              \"\\\\Hewlett-Packard\\\\HPDeviceCheck\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker_backup\",\n              \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n              \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\",\n              \"\\\\OneDrive Standalone Update Task-S-1-5-21*\",\n              \"\\\\OneDrive Standalone Update Task-S-1-12-1-*\"\n )", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_scheduled_task_creation_winlog.toml"}
{"title": "Unusual Scheduled Task Update", "description": "Identifies first-time modifications to scheduled tasks by user accounts, excluding system activity and machine accounts.", "query": "event.category: \"iam\" and event.code: \"4702\" and\n  not winlog.event_data.SubjectUserSid: (\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\") and\n  not user.name : *$", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_scheduled_task_updated.toml"}
{"title": "AdminSDHolder SDProp Exclusion Added", "description": "Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from\nthe SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolder\nobject. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected\naccounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded will\nremain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in these\ngroups.", "query": "any where event.code == \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName : \"dSHeuristics\" and\n  length(winlog.event_data.AttributeValue) > 15 and\n  winlog.event_data.AttributeValue regex~ \"[0-9]{15}([1-9a-f]).*\"", "tactic": "Persistence", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_sdprop_exclusion_dsheuristics.toml"}
{"title": "Unusual Persistence via Services Registry", "description": "Identifies processes modifying the services registry key directly, instead of through the expected Windows APIs. This\ncould be an indication of an adversary attempting to stealthily persist through abnormal service creation or\nmodification of an existing service.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : (\"ServiceDLL\", \"ImagePath\") and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n      \"MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n      \"MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\"\n  ) and not registry.data.strings : (\n      \"?:\\\\windows\\\\system32\\\\Drivers\\\\*.sys\",\n      \"\\\\SystemRoot\\\\System32\\\\drivers\\\\*.sys\",\n      \"\\\\??\\\\?:\\\\Windows\\\\system32\\\\Drivers\\\\*.SYS\",\n      \"\\\\??\\\\?:\\\\Windows\\\\syswow64\\\\*.sys\",\n      \"system32\\\\DRIVERS\\\\USBSTOR\") and\n  not (process.name : \"procexp??.exe\" and registry.data.strings : \"?:\\\\*\\\\procexp*.sys\") and\n  not process.executable : (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n      \"?:\\\\Windows\\\\winsxs\\\\*\\\\TiWorker.exe\",\n      \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n      \"?:\\\\Windows\\\\System32\\\\services.exe\",\n      \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n      \"?:\\\\Windows\\\\System32\\\\regsvr32.exe\",\n      \"?:\\\\Windows\\\\System32\\\\WaaSMedicAgent.exe\"\n  )", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_services_registry.toml"}
{"title": "Unsigned DLL Loaded by Svchost", "description": "Identifies an unsigned library created in the last 5 minutes and subsequently loaded by a shared windows service\n(svchost). Adversaries may use this technique to maintain persistence or run with System privileges.", "query": "library where host.os.type == \"windows\" and\n\n process.executable :\n     (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \"?:\\\\Windows\\\\Syswow64\\\\svchost.exe\") and\n\n dll.code_signature.trusted != true and\n\n not dll.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and\n\n dll.hash.sha256 != null and\n\n (\n       /* DLL created within 5 minutes of the library load event - compatible with Elastic Endpoint 8.4+ */\n       dll.Ext.relative_file_creation_time <= 300 or\n\n       /* unusual paths */\n       dll.path :(\"?:\\\\ProgramData\\\\*\",\n                  \"?:\\\\Users\\\\*\",\n                  \"?:\\\\PerfLogs\\\\*\",\n                  \"?:\\\\Windows\\\\Tasks\\\\*\",\n                  \"?:\\\\Intel\\\\*\",\n                  \"?:\\\\AMD\\\\Temp\\\\*\",\n                  \"?:\\\\Windows\\\\AppReadiness\\\\*\",\n                  \"?:\\\\Windows\\\\ServiceState\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\IdentityCRL\\\\*\",\n                  \"?:\\\\Windows\\\\Branding\\\\*\",\n                  \"?:\\\\Windows\\\\csc\\\\*\",\n                  \"?:\\\\Windows\\\\DigitalLocker\\\\*\",\n                  \"?:\\\\Windows\\\\en-US\\\\*\",\n                  \"?:\\\\Windows\\\\wlansvc\\\\*\",\n                  \"?:\\\\Windows\\\\Prefetch\\\\*\",\n                  \"?:\\\\Windows\\\\Fonts\\\\*\",\n                  \"?:\\\\Windows\\\\diagnostics\\\\*\",\n                  \"?:\\\\Windows\\\\TAPI\\\\*\",\n                  \"?:\\\\Windows\\\\INF\\\\*\",\n                  \"?:\\\\Windows\\\\System32\\\\Speech\\\\*\",\n                  \"?:\\\\windows\\\\tracing\\\\*\",\n                  \"?:\\\\windows\\\\IME\\\\*\",\n                  \"?:\\\\Windows\\\\Performance\\\\*\",\n                  \"?:\\\\windows\\\\intel\\\\*\",\n                  \"?:\\\\windows\\\\ms\\\\*\",\n                  \"?:\\\\Windows\\\\dot3svc\\\\*\",\n                  \"?:\\\\Windows\\\\panther\\\\*\",\n                  \"?:\\\\Windows\\\\RemotePackages\\\\*\",\n                  \"?:\\\\Windows\\\\OCR\\\\*\",\n                  \"?:\\\\Windows\\\\appcompat\\\\*\",\n                  \"?:\\\\Windows\\\\apppatch\\\\*\",\n                  \"?:\\\\Windows\\\\addins\\\\*\",\n                  \"?:\\\\Windows\\\\Setup\\\\*\",\n                  \"?:\\\\Windows\\\\Help\\\\*\",\n                  \"?:\\\\Windows\\\\SKB\\\\*\",\n                  \"?:\\\\Windows\\\\Vss\\\\*\",\n                  \"?:\\\\Windows\\\\servicing\\\\*\",\n                  \"?:\\\\Windows\\\\CbsTemp\\\\*\",\n                  \"?:\\\\Windows\\\\Logs\\\\*\",\n                  \"?:\\\\Windows\\\\WaaS\\\\*\",\n                  \"?:\\\\Windows\\\\twain_32\\\\*\",\n                  \"?:\\\\Windows\\\\ShellExperiences\\\\*\",\n                  \"?:\\\\Windows\\\\ShellComponents\\\\*\",\n                  \"?:\\\\Windows\\\\PLA\\\\*\",\n                  \"?:\\\\Windows\\\\Migration\\\\*\",\n                  \"?:\\\\Windows\\\\debug\\\\*\",\n                  \"?:\\\\Windows\\\\Cursors\\\\*\",\n                  \"?:\\\\Windows\\\\Containers\\\\*\",\n                  \"?:\\\\Windows\\\\Boot\\\\*\",\n                  \"?:\\\\Windows\\\\bcastdvr\\\\*\",\n                  \"?:\\\\Windows\\\\TextInput\\\\*\",\n                  \"?:\\\\Windows\\\\security\\\\*\",\n                  \"?:\\\\Windows\\\\schemas\\\\*\",\n                  \"?:\\\\Windows\\\\SchCache\\\\*\",\n                  \"?:\\\\Windows\\\\Resources\\\\*\",\n                  \"?:\\\\Windows\\\\rescache\\\\*\",\n                  \"?:\\\\Windows\\\\Provisioning\\\\*\",\n                  \"?:\\\\Windows\\\\PrintDialog\\\\*\",\n                  \"?:\\\\Windows\\\\PolicyDefinitions\\\\*\",\n                  \"?:\\\\Windows\\\\media\\\\*\",\n                  \"?:\\\\Windows\\\\Globalization\\\\*\",\n                  \"?:\\\\Windows\\\\L2Schemas\\\\*\",\n                  \"?:\\\\Windows\\\\LiveKernelReports\\\\*\",\n                  \"?:\\\\Windows\\\\ModemLogs\\\\*\",\n                  \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*\",\n                  \"?:\\\\$Recycle.Bin\\\\*\")\n  ) and\n\n  not dll.hash.sha256 :\n            (\"3ed33e71641645367442e65dca6dab0d326b22b48ef9a4c2a2488e67383aa9a6\",\n             \"b4db053f6032964df1b254ac44cb995ffaeb4f3ade09597670aba4f172cf65e4\",\n             \"214c75f678bc596bbe667a3b520aaaf09a0e50c364a28ac738a02f867a085eba\",\n             \"23aa95b637a1bf6188b386c21c4e87967ede80242327c55447a5bb70d9439244\",\n             \"5050b025909e81ae5481db37beb807a80c52fc6dd30c8aa47c9f7841e2a31be7\")", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_service_dll_unsigned.toml"}
{"title": "Suspicious Service was Installed in the System", "description": "Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically run\nas SYSTEM and can be used for privilege escalation and persistence.", "query": "any where\n  (event.code : \"4697\" and\n   (winlog.event_data.ServiceFileName : \n           (\"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\", \n            \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\", \n            \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n            \"*regsvr32*\", \"*msbuild*\") or\n   winlog.event_data.ServiceFileName regex~ \"\"\"%systemroot%\\\\[a-z0-9]+\\.exe\"\"\")) or\n\n  (event.code : \"7045\" and\n   winlog.event_data.ImagePath : (\n       \"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\",\n       \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\",\n       \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n       \"*regsvr32*\", \"*msbuild*\"))", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_service_windows_service_winlog.toml"}
{"title": "Startup Persistence by a Suspicious Process", "description": "Identifies files written to or modified in the startup folder by commonly abused processes. Adversaries may use this\ntechnique to maintain persistence.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  user.domain != \"NT AUTHORITY\" and\n  file.path : (\"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n               \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\") and\n  process.name : (\"cmd.exe\",\n                  \"powershell.exe\",\n                  \"wmic.exe\",\n                  \"mshta.exe\",\n                  \"pwsh.exe\",\n                  \"cscript.exe\",\n                  \"wscript.exe\",\n                  \"regsvr32.exe\",\n                  \"RegAsm.exe\",\n                  \"rundll32.exe\",\n                  \"EQNEDT32.EXE\",\n                  \"WINWORD.EXE\",\n                  \"EXCEL.EXE\",\n                  \"POWERPNT.EXE\",\n                  \"MSPUB.EXE\",\n                  \"MSACCESS.EXE\",\n                  \"iexplore.exe\",\n                  \"InstallUtil.exe\")", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_startup_folder_file_written_by_suspicious_process.toml"}
{"title": "Startup Folder Persistence via Unsigned Process", "description": "Identifies files written or modified in the startup folder by unsigned processes. Adversaries may abuse this technique\nto maintain persistence in an environment.", "query": "sequence by host.id, process.entity_id with maxspan=5s\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.code_signature.trusted == false and\n  /* suspicious paths can be added here  */\n   process.executable : (\"C:\\\\Users\\\\*.exe\",\n                         \"C:\\\\ProgramData\\\\*.exe\",\n                         \"C:\\\\Windows\\\\Temp\\\\*.exe\",\n                         \"C:\\\\Windows\\\\Tasks\\\\*.exe\",\n                         \"C:\\\\Intel\\\\*.exe\",\n                         \"C:\\\\PerfLogs\\\\*.exe\")\n   ]\n   [file where host.os.type == \"windows\" and event.type != \"deletion\" and user.domain != \"NT AUTHORITY\" and\n    file.path : (\"C:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                 \"C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\")\n   ]", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_startup_folder_file_written_by_unsigned_process.toml"}
{"title": "Persistent Scripts in the Startup Directory", "description": "Identifies script engines creating files in the Startup folder, or the creation of script files in the Startup folder.\nAdversaries may abuse this technique to maintain persistence in an environment.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n\n  /* Call attention to file extensions that may be used for malicious purposes */\n  /* Optionally, Windows scripting engine processes targeting shortcut files */\n  (\n    file.extension : (\"vbs\", \"vbe\", \"wsh\", \"wsf\", \"js\") or\n    process.name : (\"wscript.exe\", \"cscript.exe\")\n  ) and not (startsWith(user.domain, \"NT\") or endsWith(user.domain, \"NT\"))\n\n  /* Identify files created or changed in the startup folder */\n  and file.path : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\StartUp\\\\*\")", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_startup_folder_scripts.toml"}
{"title": "Component Object Model Hijacking", "description": "Identifies Component Object Model (COM) hijacking via registry modification. Adversaries may establish persistence by\nexecuting malicious content triggered by hijacked references to COM objects.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  /* not necessary but good for filtering privileged installations */\n  user.domain != \"NT AUTHORITY\" and process.executable != null and \n  (\n    (\n      registry.path : \"HK*\\\\InprocServer32\\\\\" and\n      registry.data.strings: (\"scrobj.dll\", \"?:\\\\*\\\\scrobj.dll\") and\n      not registry.path : \"*\\\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\\\*\"\n    ) or\n\n    (\n      registry.path : \"HKLM\\\\*\\\\InProcServer32\\\\*\" and\n        registry.data.strings : (\"*\\\\Users\\\\*\", \"*\\\\ProgramData\\\\*\")\n    ) or\n\n    /* in general COM Registry changes on Users Hive is less noisy and worth alerting */\n    (\n      registry.path : (\n        \"HKEY_USERS\\\\*\\\\InprocServer32\\\\\",\n        \"HKEY_USERS\\\\*\\\\LocalServer32\\\\\",\n        \"HKEY_USERS\\\\*\\\\DelegateExecute\",\n        \"HKEY_USERS\\\\*\\\\TreatAs\\\\\",\n        \"HKEY_USERS\\\\*\\\\ScriptletURL*\"\n      )  \n    )\n  ) and \n\n      not  (\n            process.code_signature.trusted == true and\n            process.code_signature.subject_name in \n                         (\"Island Technology Inc.\", \"Google LLC\", \"Grammarly, Inc.\", \"Dropbox, Inc\", \"REFINITIV US LLC\", \"HP Inc.\",\n                          \"Citrix Systems, Inc.\", \"Adobe Inc.\", \"Veeam Software Group GmbH\", \"Zhuhai Kingsoft Office Software Co., Ltd.\",\n                          \"Oracle America, Inc.\")\n        ) and \n\n  /* excludes Microsoft signed noisy processes */\n  not\n  (\n    process.name : (\"OneDrive.exe\", \"OneDriveSetup.exe\", \"FileSyncConfig.exe\", \"Teams.exe\", \"MicrosoftEdgeUpdate.exe\", \"msrdcw.exe\", \"MicrosoftEdgeUpdateComRegisterShell64.exe\") and\n    process.code_signature.trusted == true and process.code_signature.subject_name in (\"Microsoft Windows\", \"Microsoft Corporation\")\n  ) and\n  \n  not process.executable : \n                  (\"?:\\\\Program Files (x86)\\\\*.exe\", \n                   \"?:\\\\Program Files\\\\*.exe\",\n                   \"?:\\\\Windows\\\\System32\\\\svchost.exe\", \n                   \"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \n                   \"?:\\\\Windows\\\\SysWOW64\\\\regsvr32.exe\",\n                   \"?:\\\\Windows\\\\System32\\\\regsvr32.exe\",\n                   \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*.exe\", \n                   \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_com_hijack_registry.toml"}
{"title": "Suspicious Image Load (taskschd.dll) from MS Office", "description": "Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate\nadversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique can\nbe used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary\n(schtasks.exe) used to manage scheduled tasks.", "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\")", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_image_load_scheduled_task_ms_office.toml"}
{"title": "Suspicious Execution via Scheduled Task", "description": "Identifies execution of a suspicious program via scheduled tasks by looking at process lineage and command line usage.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    /* Schedule service cmdline on Win10+ */\n    process.parent.name : \"svchost.exe\" and process.parent.args : \"Schedule\" and\n    /* add suspicious programs here */\n    process.pe.original_file_name in\n                                (\n                                  \"cscript.exe\",\n                                  \"wscript.exe\",\n                                  \"PowerShell.EXE\",\n                                  \"Cmd.Exe\",\n                                  \"MSHTA.EXE\",\n                                  \"RUNDLL32.EXE\",\n                                  \"REGSVR32.EXE\",\n                                  \"MSBuild.exe\",\n                                  \"InstallUtil.exe\",\n                                  \"RegAsm.exe\",\n                                  \"RegSvcs.exe\",\n                                  \"msxsl.exe\",\n                                  \"CONTROL.EXE\",\n                                  \"EXPLORER.EXE\",\n                                  \"Microsoft.Workflow.Compiler.exe\",\n                                  \"msiexec.exe\"\n                                  ) and\n    /* add suspicious paths here */\n    process.args : (\n       \"C:\\\\Users\\\\*\",\n       \"C:\\\\ProgramData\\\\*\",\n       \"C:\\\\Windows\\\\Temp\\\\*\",\n       \"C:\\\\Windows\\\\Tasks\\\\*\",\n       \"C:\\\\PerfLogs\\\\*\",\n       \"C:\\\\Intel\\\\*\",\n       \"C:\\\\Windows\\\\Debug\\\\*\",\n       \"C:\\\\HP\\\\*\") and\n\n    not (process.name : \"cmd.exe\" and process.args : \"?:\\\\*.bat\" and process.working_directory : \"?:\\\\Windows\\\\System32\\\\\") and\n    not (process.name : \"cscript.exe\" and process.args : \"?:\\\\Windows\\\\system32\\\\calluxxprovider.vbs\") and\n    not (\n       process.name : \"powershell.exe\" and\n       process.args : (\n           \"-File\", \"-PSConsoleFile\",\n           \"C:\\\\ProgramData\\\\Microsoft\\\\AutopatchSetupScheduled\\\\SetupAutopatchClientV2Package.ps1\",\n           \"C:\\\\ProgramData\\\\Microsoft\\\\AutopatchSetupScheduled\\\\SetupAutopatchClientPackage.ps1\"                \n       ) and user.id : \"S-1-5-18\"\n    ) and\n    not (process.name : \"msiexec.exe\" and user.id : \"S-1-5-18\")", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_scheduled_task_runtime.toml"}
{"title": "Suspicious ImagePath Service Creation", "description": "Identifies the creation of a suspicious ImagePath value. This could be an indication of an adversary attempting to\nstealthily persist or escalate privileges through abnormal service creation.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"ImagePath\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\ControlSet*\\\\Services\\\\*\\\\ImagePath\"\n    ) and\n  /* add suspicious registry ImagePath values here */\n  registry.data.strings : (\"%COMSPEC%*\", \"*\\\\.\\\\pipe\\\\*\")", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_suspicious_service_created_registry.toml"}
{"title": "Suspicious WMI Event Subscription Created", "description": "Detects the creation of a WMI Event Subscription. Attackers can abuse this mechanism for persistence or to elevate to\nSYSTEM privileges.", "query": "any where\n (\n   (event.dataset == \"windows.sysmon_operational\" and event.code == \"21\" and\n    ?winlog.event_data.Operation : \"Created\" and ?winlog.event_data.Consumer : (\"*subscription:CommandLineEventConsumer*\", \"*subscription:ActiveScriptEventConsumer*\")) or\n\n   (event.dataset == \"endpoint.events.api\" and event.provider == \"Microsoft-Windows-WMI-Activity\" and ?process.Ext.api.name == \"IWbemServices::PutInstance\" and\n    ?process.Ext.api.parameters.consumer_type in (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\"))\n )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_sysmon_wmi_event_subscription.toml"}
{"title": "System Shells via Services", "description": "Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetration\ntesters may run a shell as a service to gain SYSTEM permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"services.exe\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n\n  /* Third party FP's */\n  not process.args : \"NVDisplay.ContainerLocalSystem\"", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_system_shells_via_services.toml"}
{"title": "Temporarily Scheduled Task Creation", "description": "Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxy\nmalicious execution via the schedule service and perform clean up.", "query": "sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m\n   [iam where event.action == \"scheduled-task-created\" and not user.name : \"*$\"]\n   [iam where event.action == \"scheduled-task-deleted\" and not user.name : \"*$\"]", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_temp_scheduled_task.toml"}
{"title": "Potential Persistence via Time Provider Modification", "description": "Identifies modification of the Time Provider. Adversaries may establish persistence by registering and enabling a\nmalicious DLL as a time provider. Windows uses the time provider architecture to obtain accurate time stamps from other\nnetwork devices or clients in the network. Time providers are implemented in the form of a DLL file which resides in the\nSystem32 folder. The service W32Time initiates during the startup of Windows and loads w32time.dll.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path: (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\"\n  ) and\n  registry.data.strings:\"*.dll\" and\n  not\n  (\n    process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and\n    registry.data.strings : \"?:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmwTimeProvider\\\\vmwTimeProvider.dll\"\n  ) and\n  not registry.data.strings : \"C:\\\\Windows\\\\SYSTEM32\\\\w32time.DLL\"", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_time_provider_mod.toml"}
{"title": "User Added to Privileged Group in Active Directory", "description": "Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in Active\nDirectory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly\nany action in Active Directory and on domain-joined systems.", "query": "iam where host.os.type == \"windows\" and event.action == \"added-member-to-group\" and\n(\n    group.id : \"S-1-5-21*\" and\n    (\n        group.name : (\n            \"Admin*\",\n            \"Domain Admins\",\n            \"Enterprise Admins\",\n            \"Backup Admins\",\n            \"Schema Admins\",\n            \"DnsAdmins\",\n            \"Exchange Organization Administrators\",\n            \"Print Operators\",\n            \"Server Operators\",\n            \"Account Operators\"\n        )\n    ) or\n    (\n        group.id : (\n            \"S-1-5-21-*-544\",\n            \"S-1-5-21-*-512\",\n            \"S-1-5-21-*-519\",\n            \"S-1-5-21-*-551\",\n            \"S-1-5-21-*-518\",\n            \"S-1-5-21-*-1101\",\n            \"S-1-5-21-*-1102\",\n            \"S-1-5-21-*-550\",\n            \"S-1-5-21-*-549\",\n            \"S-1-5-21-*-548\"\n        )\n    )\n)", "tactic": "Persistence", "technique": "Account Manipulation", "technique_id": "T1098", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_account_added_to_privileged_group_ad.toml"}
{"title": "User Account Creation", "description": "Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistence\non a system or domain.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : (\"net.exe\", \"net1.exe\") and not process.parent.name : \"net.exe\") and\n  (process.args : \"user\" and process.args : (\"/ad\", \"/add\"))", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_account_creation.toml"}
{"title": "Windows User Account Creation", "description": "Identifies attempts to create a Windows User Account. This is sometimes done by attackers to persist or increase access\nto a system or domain.", "query": "host.os.type:windows and event.module:(\"system\" or \"security\") and (event.code:\"4720\" or event.action:\"added-user-account\")", "tactic": "Persistence", "technique": "Create Account", "technique_id": "T1136", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_user_account_creation_event_logs.toml"}
{"title": "Potential Application Shimming via Sdbinst", "description": "The Application Shim was created to allow for backward compatibility of software as the operating system codebase\nchanges over time. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary\ncode execution in legitimate Windows processes.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"sdbinst.exe\" and\n  process.args : \"?*\" and\n  not (process.args : \"-m\" and process.args : \"-bg\") and\n  not process.args : \"-mm\"", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_application_shimming.toml"}
{"title": "Persistence via BITS Job Notify Cmdline", "description": "An adversary can use the Background Intelligent Transfer Service (BITS) SetNotifyCmdLine method to execute a program\nthat runs after a job finishes transferring data or after a job enters a specified state in order to persist on a\nsystem.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and process.parent.args : \"BITS\" and\n  not process.executable :\n              (\"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n               \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n               \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n               \"?:\\\\WINDOWS\\\\system32\\\\directxdatabaseupdater.exe\")", "tactic": "Persistence", "technique": "BITS Jobs", "technique_id": "T1197", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_bits_job_notify_command.toml"}
{"title": "Persistence via Hidden Run Key Detected", "description": "Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated)\nregistry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit).", "query": "/* Registry Path ends with backslash */\nregistry where host.os.type == \"windows\" and event.type == \"change\" and length(registry.data.strings) > 0 and\n registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\")", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_hidden_run_key_valuename.toml"}
{"title": "Installation of Security Support Provider", "description": "Identifies registry modifications related to the Windows Security Support Provider (SSP) configuration. Adversaries may\nabuse this to establish persistence in an environment.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n   registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\",\n      \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Security Packages*\",\n      \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\OSConfig\\\\Security Packages*\"\n   ) and\n   not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\", \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\")", "tactic": "Persistence", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_lsa_security_support_provider_registry.toml"}
{"title": "Persistence via TelemetryController Scheduled Task Hijack", "description": "Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an\nintegrity level of system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"CompatTelRunner.exe\" and process.args : \"-cv*\" and\n  not process.name : (\"conhost.exe\",\n                      \"DeviceCensus.exe\",\n                      \"CompatTelRunner.exe\",\n                      \"DismHost.exe\",\n                      \"rundll32.exe\",\n                      \"powershell.exe\")", "tactic": "Persistence", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_telemetrycontroller_scheduledtask_hijack.toml"}
{"title": "Persistence via Update Orchestrator Service Hijack", "description": "Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integrity\nlevel of SYSTEM.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Windows\\\\System32\\\\svchost.exe\" and\n  process.parent.args : \"UsoSvc\" and\n  not process.executable :\n          (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\Packages\\\\*\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoClient.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotification.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotificationUx.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotifyIcon.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerMgr.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\ClickToRun\\\\OfficeC2RClient.exe\") and\n  not process.name : (\"MoUsoCoreWorker.exe\", \"OfficeC2RClient.exe\")", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_update_orchestrator_service_hijack.toml"}
{"title": "Persistence via WMI Event Subscription", "description": "An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, and\nbindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to an\nevent and execute arbitrary code when that event occurs, providing persistence on a system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"create\" and\n  process.args : (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\")", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_windows_management_instrumentation_event_subscription.toml"}
{"title": "Persistence via WMI Standard Registry Provider", "description": "Identifies use of the Windows Management Instrumentation StdRegProv (registry provider) to modify commonly abused\nregistry locations for persistence.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n registry.data.strings != null and process.name : \"WmiPrvSe.exe\" and\n registry.path : (\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx\\\\*\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ServiceDLL\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\\\\*\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\UserInitMprLogonScript\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\"\n                  )", "tactic": "Persistence", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_wmi_stdregprov_run_services.toml"}
{"title": "Execution via MSSQL xp_cmdshell Stored Procedure", "description": "Identifies execution via MSSQL xp_cmdshell stored procedure. Malicious users may attempt to elevate their privileges by\nusing xp_cmdshell, which is disabled by default, thus, it's important to review the context of it's use.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"sqlservr.exe\" and\n  (\n   (process.name : \"cmd.exe\" and \n    not process.args : (\"\\\\\\\\*\", \"diskfree\", \"rmdir\", \"mkdir\", \"dir\", \"del\", \"rename\", \"bcp\", \"*XMLNAMESPACES*\", \n                        \"?:\\\\MSSQL\\\\Backup\\\\Jobs\\\\sql_agent_backup_job.ps1\", \"K:\\\\MSSQL\\\\Backup\\\\msdb\", \"K:\\\\MSSQL\\\\Backup\\\\Logins\")) or \n                        \n   (process.name : \"vpnbridge.exe\" or ?process.pe.original_file_name : \"vpnbridge.exe\") or \n\n   (process.name : \"certutil.exe\" or ?process.pe.original_file_name == \"CertUtil.exe\") or \n\n   (process.name : \"bitsadmin.exe\" or ?process.pe.original_file_name == \"bitsadmin.exe\")\n  )", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_via_xp_cmdshell_mssql_stored_procedure.toml"}
{"title": "Web Shell Detection: Script Process Child of Common Web Processes", "description": "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"w3wp.exe\", \"httpd.exe\", \"nginx.exe\", \"php.exe\", \"php-cgi.exe\", \"tomcat.exe\") and\n  process.name : (\"cmd.exe\", \"cscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"wmic.exe\", \"wscript.exe\") and\n  not\n  (\n    process.parent.name : (\"php.exe\", \"httpd.exe\") and process.name : \"cmd.exe\" and\n    process.command_line : (\n      \"cmd.exe /c mode CON\",\n      \"cmd.exe /s /c \\\"mode CON\\\"\",\n      \"cmd.exe /c \\\"mode\\\"\",\n      \"cmd.exe /s /c \\\"tput colors 2>&1\\\"\"\"    )\n  )", "tactic": "Persistence", "technique": "Server Software Component", "technique_id": "T1505", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_webshell_detection.toml"}
{"title": "Werfault ReflectDebugger Persistence", "description": "Identifies the registration of a Werfault Debugger. Attackers may abuse this mechanism to execute malicious payloads\nevery time the utility is executed with the \"-pr\" parameter.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\Hangs\\\\ReflectDebugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\Hangs\\\\ReflectDebugger\",\n    \"MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\Hangs\\\\ReflectDebugger\"\n  )", "tactic": "Persistence", "technique": "Event Triggered Execution", "technique_id": "T1546", "risk_score": "N/A", "tags": [], "references": [], "file": "persistence_werfault_reflectdebugger.toml"}
{"title": "Delegated Managed Service Account Modification by an Unusual User", "description": "Detects modifications in the msDS-ManagedAccountPrecededByLink attribute of a delegated managed service account by an unusual\nsubject account. Attackers can abuse this attribute to take over the permission of a target account and inherit it's permissions\nallowing them to further elevate privileges.", "query": "event.code:5136 and winlog.event_data.AttributeLDAPDisplayName:\"msDS-ManagedAccountPrecededByLink\"", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_badsuccessor_dmsa_abuse.toml"}
{"title": "Process Creation via Secondary Logon", "description": "Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to\nescalate privileges and bypass access controls.", "query": "sequence by winlog.computer_name with maxspan=1m\n\n[authentication where event.action:\"logged-in\" and\n event.outcome == \"success\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n /* seclogon service */\n process.name == \"svchost.exe\" and\n winlog.event_data.LogonProcessName : \"seclogo*\" and source.ip == \"::1\" ] by winlog.event_data.TargetLogonId\n\n[process where event.type == \"start\"] by winlog.event_data.TargetLogonId", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_create_process_as_different_user.toml"}
{"title": "Process Created with a Duplicated Token", "description": "Identifies the creation of a process impersonating the token of another user logon session. Adversaries may create a new\nprocess with a different token to escalate privileges and bypass access controls.", "query": "/* This rule is only compatible with Elastic Endpoint 8.4+ */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n (process.Ext.effective_parent.executable regex~ \"\"\"[C-Z]:\\\\Windows\\\\(System32|SysWOW64)\\\\[a-zA-Z0-9\\-\\_\\.]+\\.exe\"\"\" or\n  process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\explorer.exe\") and\n\n (\n  process.name : (\"powershell.exe\", \"cmd.exe\", \"rundll32.exe\", \"notepad.exe\", \"net.exe\", \"ntdsutil.exe\",\n                  \"tasklist.exe\", \"reg.exe\", \"certutil.exe\", \"bitsadmin.exe\", \"msbuild.exe\", \"esentutl.exe\") or\n\n  ((process.Ext.relative_file_creation_time <= 900 or process.Ext.relative_file_name_modify_time <= 900) and\n   not process.code_signature.status : (\"trusted\", \"errorExpired\", \"errorCode_endpoint*\") and\n   not process.executable : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n ) and\n not (process.name : \"rundll32.exe\" and\n      process.command_line : (\"*davclnt.dll,DavSetCookie*\", \"*?:\\\\Program Files*\",\n                              \"*\\\\Windows\\\\System32\\\\winethc.dll*\", \"*\\\\Windows\\\\SYSTEM32\\\\EDGEHTML.dll*\",\n                              \"*shell32.dll,SHCreateLocalServerRunDll*\")) and\n not startswith~(process.Ext.effective_parent.name, process.parent.name) and\n not (process.name : \"powershell.exe\" and process.parent.name : \"wmiprvse.exe\" and process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\wsmprovhost.exe\") and\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\" and process.parent.executable : \"?:\\\\Windows\\\\System32\\\\sihost.exe\") and\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\sethc.exe\" and process.parent.executable : \"?:\\\\Windows\\\\System32\\\\svchost.exe\") and\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\explorer.exe\" and\n      process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\svchost.exe\", \"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \"?:\\\\Windows\\\\twain_32\\\\*.exe\"))", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_create_process_with_token_unpriv.toml"}
{"title": "Modification of the msPKIAccountCredentials", "description": "Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can\nabuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials\ncontains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys,\ncertificates, and certificate requests.", "query": "event.code:\"5136\" and winlog.event_data.AttributeLDAPDisplayName:\"msPKIAccountCredentials\" and\n  winlog.event_data.OperationType:\"%%14674\" and\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_credroaming_ldap.toml"}
{"title": "Disabling User Account Control via Registry Modification", "description": "User Account Control (UAC) can help mitigate the impact of malware on Windows hosts. With UAC, apps and tasks always run\nin the security context of a non-administrator account, unless an administrator specifically authorizes\nadministrator-level access to the system. This rule identifies registry value changes to bypass User Access Control\n(UAC) protection.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path :\n    (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\",\n      \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\EnableLUA\",\n      \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\ConsentPromptBehaviorAdmin\",\n      \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\PromptOnSecureDesktop\"\n    ) and\n  registry.data.strings : (\"0\", \"0x00000000\")", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_disable_uac_registry.toml"}
{"title": "dMSA Account Creation by an Unusual User", "description": "Detects the creation of a delegated Managed Service Account by an unusual subject account. Attackers can abuse the dMSA\naccount migration feature to elevate privileges abusing weak persmission allowing users child objects rights or\nmsDS-DelegatedManagedServiceAccount rights.", "query": "event.code:5137 and winlog.event_data.ObjectClass:\"msDS-DelegatedManagedServiceAccount\"", "tactic": "Privilege Escalation", "technique": "Valid Accounts", "technique_id": "T1078", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_dmsa_creation_by_unusual_user.toml"}
{"title": "Unsigned DLL loaded by DNS Service", "description": "Identifies unusual DLLs loaded by the DNS Server process, potentially indicating the abuse of the ServerLevelPluginDll\nfunctionality. This can lead to privilege escalation and remote code execution with SYSTEM privileges.", "query": "any where host.os.type == \"windows\" and event.category : (\"library\", \"process\") and\n  event.type : (\"start\", \"change\") and event.action : (\"load\", \"Image loaded*\") and\n  process.executable : \"?:\\\\windows\\\\system32\\\\dns.exe\" and\n  not ?dll.code_signature.trusted == true and\n  not file.code_signature.status == \"Valid\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_dns_serverlevelplugindll.toml"}
{"title": "First Time Seen Driver Loaded", "description": "Identifies the load of a driver with an original file name and signature values that were observed for the first time\nduring the last 30 days. This rule type can help baseline drivers installation within your environment.", "query": "event.category:\"driver\" and host.os.type:windows and event.action:\"load\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_driver_newterm_imphash.toml"}
{"title": "Expired or Revoked Driver Loaded", "description": "Identifies an attempt to load a revoked or expired driver. Adversaries may bring outdated drivers with vulnerabilities\nto gain code execution in kernel mode or abuse revoked certificates to sign their drivers.", "query": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  dll.code_signature.status : (\"errorExpired\", \"errorRevoked\")", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_expired_driver_loaded.toml"}
{"title": "Potential privilege escalation via CVE-2022-38028", "description": "Identifies a privilege escalation attempt via exploiting CVE-2022-38028 to hijack the print spooler service execution.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n    file.name : \"MPDW-constraints.js\" and\n    file.path : (\n        \"?:\\\\*\\\\Windows\\\\system32\\\\DriVerStoRe\\\\FiLeRePoSiToRy\\\\*\\\\MPDW-constraints.js\",\n        \"?:\\\\*\\\\Windows\\\\WinSxS\\\\amd64_microsoft-windows-printing-printtopdf_*\\\\MPDW-constraints.js\"\n    )", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_exploit_cve_202238028.toml"}
{"title": "Creation or Modification of a new GPO Scheduled Task or Service", "description": "Detects the creation or modification of a new Group Policy based scheduled task or service. These methods are used for\nlegitimate system administration, but can also be abused by an attacker with domain admin permissions to execute a\nmalicious payload remotely on all or a subset of the domain joined machines.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and event.action != \"open\" and\n file.name : (\"ScheduledTasks.xml\", \"Services.xml\") and\n  file.path : (\n    \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\ScheduledTasks\\\\ScheduledTasks.xml\",\n    \"?:\\\\Windows\\\\SYSVOL\\\\domain\\\\Policies\\\\*\\\\MACHINE\\\\Preferences\\\\Services\\\\Services.xml\"\n  ) and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\dfsrs.exe\"", "tactic": "Privilege Escalation", "technique": "Domain or Tenant Policy Modification", "technique_id": "T1484", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_gpo_schtask_service_creation.toml"}
{"title": "Startup/Logon Script added to Group Policy Object", "description": "Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.", "query": "any where host.os.type == \"windows\" and event.code in (\"5136\", \"5145\") and\n(\n  (\n    winlog.event_data.AttributeLDAPDisplayName : (\n      \"gPCMachineExtensionNames\",\n      \"gPCUserExtensionNames\"\n    ) and\n    winlog.event_data.AttributeValue : \"*42B5FAAE-6536-11D2-AE5A-0000F87571E3*\" and\n    winlog.event_data.AttributeValue : (\n      \"*40B66650-4972-11D1-A7CA-0000F87571E3*\",\n      \"*40B6664F-4972-11D1-A7CA-0000F87571E3*\"\n    )\n  ) or\n  (\n    winlog.event_data.ShareName : \"\\\\\\\\*\\\\SYSVOL\" and\n    winlog.event_data.RelativeTargetName : (\"*\\\\scripts.ini\", \"*\\\\psscripts.ini\") and\n    winlog.event_data.AccessList:\"*%%4417*\"\n  )\n)", "tactic": "Privilege Escalation", "technique": "Domain or Tenant Policy Modification", "technique_id": "T1484", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_group_policy_iniscript.toml"}
{"title": "Group Policy Abuse for Privilege Addition", "description": "Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or\nuse them to add users as local admins.", "query": "any where host.os.type == \"windows\" and event.code: \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName: \"gPCMachineExtensionNames\" and\n  winlog.event_data.AttributeValue: \"*827D319E-6EAC-11D2-A4EA-00C04F79F83A*\" and\n  winlog.event_data.AttributeValue: \"*803E14A0-B4FB-11D0-A0D0-00A0C90F574B*\"", "tactic": "Privilege Escalation", "technique": "Domain or Tenant Policy Modification", "technique_id": "T1484", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_group_policy_privileged_groups.toml"}
{"title": "Scheduled Task Execution at Scale via GPO", "description": "Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by the\nGPO.", "query": "any where host.os.type == \"windows\" and event.code in (\"5136\", \"5145\") and\n(\n  (\n    winlog.event_data.AttributeLDAPDisplayName : (\n      \"gPCMachineExtensionNames\",\n      \"gPCUserExtensionNames\"\n    ) and\n    winlog.event_data.AttributeValue : \"*CAB54552-DEEA-4691-817E-ED4A4D1AFC72*\" and\n    winlog.event_data.AttributeValue : \"*AADCED64-746C-4633-A97C-D61349046527*\"\n  ) or\n  (\n    winlog.event_data.ShareName : \"\\\\\\\\*\\\\SYSVOL\" and\n    winlog.event_data.RelativeTargetName : \"*ScheduledTasks.xml\" and\n    winlog.event_data.AccessList:\"*%%4417*\"\n  )\n)", "tactic": "Privilege Escalation", "technique": "Scheduled Task/Job", "technique_id": "T1053", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_group_policy_scheduled_task.toml"}
{"title": "Potential Privilege Escalation via InstallerFileTakeOver", "description": "Identifies a potential exploitation of InstallerTakeOver (CVE-2021-41379) default PoC execution. Successful exploitation\nallows an unprivileged user to escalate privileges to SYSTEM.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.Ext.token.integrity_level_name : \"System\" and\n    (\n      (process.name : \"elevation_service.exe\" and\n       not process.pe.original_file_name == \"elevation_service.exe\") or\n      \n      (process.name : \"elevation_service.exe\" and\n       not process.code_signature.trusted == true) or\n\n      (process.parent.name : \"elevation_service.exe\" and\n       process.name : (\"rundll32.exe\", \"cmd.exe\", \"powershell.exe\"))\n    ) and\n    not\n    (\n      process.name : \"elevation_service.exe\" and process.code_signature.trusted == true and\n      process.pe.original_file_name == null\n    )", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_installertakeover.toml"}
{"title": "Service Creation via Local Kerberos Authentication", "description": "Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to\nlocalhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberos\nrelay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges.", "query": "sequence by winlog.computer_name with maxspan=5m\n [authentication where\n\n  /* event 4624 need to be logged */\n  event.action == \"logged-in\" and event.outcome == \"success\" and winlog.event_data.ElevatedToken == \"%%1843\" and process.pid == 0 and \n\n  /* authenticate locally using relayed kerberos Ticket */\n  winlog.event_data.AuthenticationPackageName :\"Kerberos\" and winlog.logon.type == \"Network\" and cidrmatch(source.ip, \"127.0.0.0/8\", \"::1\")] by winlog.event_data.TargetLogonId\n\n  [any where\n   /* event 4697 need to be logged */\n   event.action : \"service-installed\"] by winlog.event_data.SubjectLogonId", "tactic": "Privilege Escalation", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_krbrelayup_service_creation.toml"}
{"title": "Potential LSA Authentication Package Abuse", "description": "Adversaries can use the autostart mechanism provided by the Local Security Authority (LSA) authentication packages for\nprivilege escalation or persistence by placing a reference to a binary in the Windows registry. The binary will then be\nexecuted by SYSTEM when the authentication packages are loaded.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Lsa\\\\Authentication Packages\"\n  ) and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"", "tactic": "Privilege Escalation", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_lsa_auth_package.toml"}
{"title": "Interactive Logon by an Unusual Process", "description": "Identifies interactive logon attempt with alternate credentials and by an unusual process. Adversaries may create a new\ntoken to escalate privileges and bypass access controls.", "query": "authentication where\n host.os.type : \"windows\" and winlog.event_data.LogonProcessName : \"Advapi*\" and\n winlog.logon.type == \"Interactive\" and winlog.event_data.SubjectUserSid : (\"S-1-5-21*\", \"S-1-12-*\") and\n winlog.event_data.TargetUserSid : (\"S-1-5-21*\", \"S-1-12-*\")  and process.executable : \"C:\\\\*\" and\n not startswith~(winlog.event_data.SubjectUserSid, winlog.event_data.TargetUserSid) and\n not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\winlogon.exe\",\n             \"?:\\\\Windows\\\\System32\\\\wininit.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n             \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\")", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_make_token_local.toml"}
{"title": "Potential Escalation via Vulnerable MSI Repair", "description": "Identifies when a browser process navigates to the Microsoft Help page followed by spawning an elevated process. This\nmay indicate a successful exploitation for privilege escalation abusing a vulnerable Windows Installer repair setup.", "query": "process where event.type == \"start\" and host.os.type == \"windows\" and\n user.domain : (\"NT AUTHORITY\", \"AUTORITE NT\", \"AUTORIDADE NT\") and\n process.parent.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\",\n                        \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\", \"tor.exe\", \"safari.exe\") and\n process.parent.command_line : \"*go.microsoft.com*\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_msi_repair_via_mshelp_link.toml"}
{"title": "Privilege Escalation via Named Pipe Impersonation", "description": "Identifies a privilege escalation attempt via named pipe impersonation. An adversary may abuse this technique by\nutilizing a framework such Metasploit's meterpreter getsystem command.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"Cmd.Exe\", \"PowerShell.EXE\") or ?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\")) and\n process.args : \"echo\" and process.args : \">\" and process.args : \"\\\\\\\\.\\\\pipe\\\\*\"", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_named_pipe_impersonation.toml"}
{"title": "First Time Seen NewCredentials Logon Process", "description": "Identifies a new credentials logon type performed by an unusual process. This may indicate the existence of an access\ntoken forging capability that are often abused to bypass access control restrictions.", "query": "event.category:\"authentication\" and host.os.type:\"windows\" and winlog.logon.type:\"NewCredentials\" and winlog.event_data.LogonProcessName:(Advapi* or \"Advapi  \") and not winlog.event_data.SubjectUserName:*$ and not process.executable :???\\\\Program?Files*", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_newcreds_logon_rare_process.toml"}
{"title": "Suspicious DLL Loaded for Persistence or Privilege Escalation", "description": "Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or one\nthat can be loaded from a different location by a native Windows process. This may be abused to persist or elevate\nprivileges via privileged file write vulnerabilities.", "query": "any where host.os.type == \"windows\" and\n(event.category : (\"driver\", \"library\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n(\n  /* compatible with Elastic Endpoint Library Events */\n  (\n    ?dll.name : (\n        \"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n        \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n        \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n        \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\"\n    )\n    and (\n      ?dll.code_signature.trusted != true or\n      ?dll.code_signature.exists != true or\n      (\n        dll.code_signature.trusted == true and\n          not dll.code_signature.subject_name : (\"Microsoft Windows\", \"Microsoft Corporation\", \"Microsoft Windows Publisher\")\n      )\n  ) or\n   /* oci.dll is too noisy due to unsigned Oracle related DLL loaded from random dirs */\n  (\n   (?dll.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and process.executable : \"?:\\\\Windows\\\\*.exe\" and \n    (?dll.code_signature.trusted != true or ?dll.code_signature.exists != true)) or \n    \n   (file.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and not file.code_signature.status == \"Valid\" and process.executable : \"?:\\\\Windows\\\\*.exe\")\n   ) or \n\n  /* compatible with Sysmon EventID 7 - Image Load */\n  (file.name : (\"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n               \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n               \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n               \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\") and \n   not file.hash.sha256 : \n            (\"6e837794fc282446906c36d681958f2f6212043fc117c716936920be166a700f\", \n             \"b14e4954e8cca060ffeb57f2458b6a3a39c7d2f27e94391cbcea5387652f21a4\", \n             \"c258d90acd006fa109dc6b748008edbb196d6168bc75ace0de0de54a4db46662\") and \n   not file.code_signature.status == \"Valid\")\n  ) and\n  not\n  (\n    ?dll.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    ) or\n    file.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    )\n  )\n)", "tactic": "Privilege Escalation", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_persistence_phantom_dll.toml"}
{"title": "Potential Port Monitor or Print Processor Registration Abuse", "description": "Identifies port monitor and print processor registry modifications. Adversaries may abuse port monitor and print\nprocessors to run malicious DLLs during system boot that will be executed as SYSTEM for privilege escalation and/or\npersistence, if permissions allow writing a fully-qualified pathname for that DLL.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n      \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Monitors\\\\*\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Print\\\\Environments\\\\Windows*\\\\Print Processors\\\\*\"\n  ) and registry.data.strings : \"*.dll\" and\n  /* exclude SYSTEM SID - look for changes by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"", "tactic": "Privilege Escalation", "technique": "Boot or Logon Autostart Execution", "technique_id": "T1547", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_port_monitor_print_pocessor_abuse.toml"}
{"title": "PowerShell Script with Token Impersonation Capabilities", "description": "Detects scripts that contain PowerShell functions, structures, or Windows API functions related to token\nimpersonation/theft. Attackers may duplicate then impersonate another user's token to escalate privileges and bypass\naccess controls.", "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"Invoke-TokenManipulation\" or\n    \"ImpersonateNamedPipeClient\" or\n    \"NtImpersonateThread\" or\n    (\n      \"STARTUPINFOEX\" and\n      \"UpdateProcThreadAttribute\"\n    ) or\n    (\n      \"AdjustTokenPrivileges\" and\n      \"SeDebugPrivilege\"\n    ) or\n    (\n      (\"DuplicateToken\" or\n      \"DuplicateTokenEx\") and\n      (\"SetThreadToken\" or\n      \"ImpersonateLoggedOnUser\" or\n      \"CreateProcessWithTokenW\" or\n      \"CreatePRocessAsUserW\" or\n      \"CreateProcessAsUserA\")\n    ) \n  ) and\n  not (\n    user.id:(\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\") and\n    file.directory: \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not (\n    powershell.file.script_block_text : \"New-HPPrivateToastNotificationLogo\" and\n    file.path : \"C:\\Program Files\\HPConnect\\hp-cmsl-wl\\modules\\HP.Notifications\\HP.Notifications.psm1\"\n  )", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_posh_token_impersonation.toml"}
{"title": "Suspicious Print Spooler Point and Print DLL", "description": "Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service.\nExploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running as\nSYSTEM.", "query": "sequence by host.id with maxspan=30s\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\"]\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\\\\*\"]", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_printspooler_registry_copyfiles.toml"}
{"title": "Suspicious PrintSpooler Service Executable File Creation", "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service. For more\ninformation refer to the following CVE's - CVE-2020-1048, CVE-2020-1337 and CVE-2020-1300 and verify that the impacted\nsystem is patched.", "query": "event.category : \"file\" and host.os.type : \"windows\" and event.type : \"creation\" and\n  process.name : \"spoolsv.exe\" and file.extension : \"dll\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_printspooler_service_suspicious_file.toml"}
{"title": "Suspicious Print Spooler File Deletion", "description": "Detects deletion of print driver files by an unusual process. This may indicate a clean up attempt post successful\nprivilege escalation via Print Spooler service related vulnerabilities.", "query": "file where host.os.type == \"windows\" and event.type == \"deletion\" and\n  file.extension : \"dll\" and file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.dll\" and\n  not process.name : (\"spoolsv.exe\", \"dllhost.exe\", \"explorer.exe\")", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_printspooler_suspicious_file_deletion.toml"}
{"title": "Suspicious Print Spooler SPL File Created", "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service including\nCVE-2020-1048 and CVE-2020-1337.", "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : \"spl\" and\n  file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\PRINTERS\\\\*\" and\n  not process.name : (\"spoolsv.exe\",\n                      \"printfilterpipelinesvc.exe\",\n                      \"PrintIsolationHost.exe\",\n                      \"splwow64.exe\",\n                      \"msiexec.exe\",\n                      \"poqexec.exe\",\n                      \"System\") and\n  not user.id : \"S-1-5-18\" and\n  not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"\\\\Device\\\\Mup\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\printui.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\spool\\\\*.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\PROGRA~1\\\\*.exe\",\n             \"?:\\\\PROGRA~2\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\rundll32.exe\")", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_printspooler_suspicious_spl_file.toml"}
{"title": "Potential Privilege Escalation via Service ImagePath Modification", "description": "Identifies registry modifications to default services that could enable privilege escalation to SYSTEM. Attackers with\nprivileges from groups like Server Operators may change the ImagePath of services to executables under their control or\nto execute commands.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and process.executable != null and\n  event.action == \"modification\" and registry.value == \"ImagePath\" and\n  registry.key : (\n    \"*\\\\ADWS\", \"*\\\\AppHostSvc\", \"*\\\\AppReadiness\", \"*\\\\AudioEndpointBuilder\", \"*\\\\AxInstSV\", \"*\\\\camsvc\", \"*\\\\CertSvc\",\n    \"*\\\\COMSysApp\", \"*\\\\CscService\", \"*\\\\defragsvc\", \"*\\\\DeviceAssociationService\", \"*\\\\DeviceInstall\", \"*\\\\DevQueryBroker\",\n    \"*\\\\Dfs\", \"*\\\\DFSR\", \"*\\\\diagnosticshub.standardcollector.service\", \"*\\\\DiagTrack\", \"*\\\\DmEnrollmentSvc\", \"*\\\\DNS\",\n    \"*\\\\dot3svc\", \"*\\\\Eaphost\", \"*\\\\GraphicsPerfSvc\", \"*\\\\hidserv\", \"*\\\\HvHost\", \"*\\\\IISADMIN\", \"*\\\\IKEEXT\",\n    \"*\\\\InstallService\", \"*\\\\iphlpsvc\", \"*\\\\IsmServ\", \"*\\\\LanmanServer\", \"*\\\\MSiSCSI\", \"*\\\\NcbService\", \"*\\\\Netlogon\",\n    \"*\\\\Netman\", \"*\\\\NtFrs\", \"*\\\\PlugPlay\", \"*\\\\Power\", \"*\\\\PrintNotify\", \"*\\\\ProfSvc\", \"*\\\\PushToInstall\", \"*\\\\RSoPProv\",\n    \"*\\\\sacsvr\", \"*\\\\SENS\", \"*\\\\SensorDataService\", \"*\\\\SgrmBroker\", \"*\\\\ShellHWDetection\", \"*\\\\shpamsvc\", \"*\\\\StorSvc\",\n    \"*\\\\svsvc\", \"*\\\\swprv\", \"*\\\\SysMain\", \"*\\\\Themes\", \"*\\\\TieringEngineService\", \"*\\\\TokenBroker\", \"*\\\\TrkWks\",\n    \"*\\\\UALSVC\", \"*\\\\UserManager\", \"*\\\\vm3dservice\", \"*\\\\vmicguestinterface\", \"*\\\\vmicheartbeat\", \"*\\\\vmickvpexchange\",\n    \"*\\\\vmicrdv\", \"*\\\\vmicshutdown\", \"*\\\\vmicvmsession\", \"*\\\\vmicvss\", \"*\\\\vmvss\", \"*\\\\VSS\", \"*\\\\w3logsvc\", \"*\\\\W3SVC\",\n    \"*\\\\WalletService\", \"*\\\\WAS\", \"*\\\\wercplsupport\", \"*\\\\WerSvc\", \"*\\\\Winmgmt\", \"*\\\\wisvc\", \"*\\\\wmiApSrv\",\n    \"*\\\\WPDBusEnum\", \"*\\\\WSearch\"\n  ) and\n  not (\n    registry.data.strings : (\n        \"?:\\\\Windows\\\\system32\\\\*.exe\",\n        \"%systemroot%\\\\system32\\\\*.exe\",\n        \"%windir%\\\\system32\\\\*.exe\",\n        \"%SystemRoot%\\\\system32\\\\svchost.exe -k *\",\n        \"%windir%\\\\system32\\\\svchost.exe -k *\"\n    ) and\n        not registry.data.strings : (\n            \"*\\\\cmd.exe\",\n            \"*\\\\cscript.exe\",\n            \"*\\\\ieexec.exe\",\n            \"*\\\\iexpress.exe\",\n            \"*\\\\installutil.exe\",\n            \"*\\\\Microsoft.Workflow.Compiler.exe\",\n            \"*\\\\msbuild.exe\",\n            \"*\\\\mshta.exe\",\n            \"*\\\\msiexec.exe\",\n            \"*\\\\msxsl.exe\",\n            \"*\\\\net.exe\",\n            \"*\\\\powershell.exe\",\n            \"*\\\\pwsh.exe\",\n            \"*\\\\reg.exe\",\n            \"*\\\\RegAsm.exe\",\n            \"*\\\\RegSvcs.exe\",\n            \"*\\\\regsvr32.exe\",\n            \"*\\\\rundll32.exe\",\n            \"*\\\\vssadmin.exe\",\n            \"*\\\\wbadmin.exe\",\n            \"*\\\\wmic.exe\",\n            \"*\\\\wscript.exe\"\n        )\n  )", "tactic": "Privilege Escalation", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_reg_service_imagepath_mod.toml"}
{"title": "Privilege Escalation via Windir Environment Variable", "description": "Identifies a privilege escalation attempt via a rogue Windows directory (Windir) environment variable. This is a known\nprimitive that is often combined with other vulnerabilities to elevate privileges.", "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\nregistry.value : (\"windir\", \"systemroot\") and\nregistry.path : (\n    \"HKEY_USERS\\\\*\\\\Environment\\\\windir\",\n    \"HKEY_USERS\\\\*\\\\Environment\\\\systemroot\",\n    \"HKU\\\\*\\\\Environment\\\\windir\",\n    \"HKU\\\\*\\\\Environment\\\\systemroot\",\n    \"HKCU\\\\*\\\\Environment\\\\windir\",\n    \"HKCU\\\\*\\\\Environment\\\\systemroot\",\n    \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\windir\",\n    \"\\\\REGISTRY\\\\USER\\\\*\\\\Environment\\\\systemroot\",\n    \"USER\\\\*\\\\Environment\\\\windir\",\n    \"USER\\\\*\\\\Environment\\\\systemroot\"\n    ) and\n not registry.data.strings : (\"C:\\\\windows\", \"%SystemRoot%\")", "tactic": "Privilege Escalation", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_rogue_windir_environment_var.toml"}
{"title": "Potential Privileged Escalation via SamAccountName Spoofing", "description": "Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to\nelevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a security\nvulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing.", "query": "iam where event.action == \"renamed-user-account\" and\n  /* machine account name renamed to user like account name */\n  winlog.event_data.OldTargetUserName : \"*$\" and not winlog.event_data.NewTargetUserName : \"*$\"", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_samaccountname_spoofing_attack.toml"}
{"title": "Service Control Spawned via Script Interpreter", "description": "Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services.\nThis can potentially indicate an attempt to elevate privileges or maintain persistence.", "query": "/* This rule is not compatible with Sysmon due to user.id issues */\n\nprocess where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name == \"sc.exe\") and\n  process.parent.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                         \"wmic.exe\", \"mshta.exe\",\"powershell.exe\", \"pwsh.exe\") and\n  process.args:(\"config\", \"create\", \"start\", \"delete\", \"stop\", \"pause\") and\n  /* exclude SYSTEM SID - look for service creations by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"", "tactic": "Privilege Escalation", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_service_control_spawned_script_int.toml"}
{"title": "Remote Computer Account DnsHostName Update", "description": "Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain\ncontroller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation\nstep to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin\nprivileges.", "query": "iam where event.action == \"changed-computer-account\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_suspicious_dnshostname_update.toml"}
{"title": "SeDebugPrivilege Enabled by a Suspicious Process", "description": "Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries\nmay create a new process with a different token to escalate privileges and bypass access controls.", "query": "any where host.os.type == \"windows\" and event.provider: \"Microsoft-Windows-Security-Auditing\" and\n event.action : \"Token Right Adjusted Events\" and\n\n winlog.event_data.EnabledPrivilegeList : \"SeDebugPrivilege\" and\n\n /* exclude processes with System Integrity  */\n not winlog.event_data.SubjectUserSid : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n\n not winlog.event_data.ProcessName :\n         (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Program Files\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n          \"?:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n          \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n          \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*-*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\auditpol.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSe.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSe.exe\")", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_tokenmanip_sedebugpriv_enabled.toml"}
{"title": "UAC Bypass Attempt with IEditionUpgradeManager Elevated COM Interface", "description": "Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue Windows\nClipUp program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"Clipup.exe\" and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\ClipUp.exe\" and process.parent.name : \"dllhost.exe\" and\n  /* CLSID of the Elevated COM Interface IEditionUpgradeManager */\n  process.parent.args : \"/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}\"", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_com_clipup.toml"}
{"title": "UAC Bypass Attempt via Elevated COM Internet Explorer Add-On Installer", "description": "Identifies User Account Control (UAC) bypass attempts by abusing an elevated COM Interface to launch a malicious\nprogram. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.executable : \"C:\\\\*\\\\AppData\\\\*\\\\Temp\\\\IDC*.tmp\\\\*.exe\" and\n process.parent.name : \"ieinstal.exe\" and process.parent.args : \"-Embedding\"\n\n /* uncomment once in winlogbeat */\n /* and not (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true) */", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_com_ieinstal.toml"}
{"title": "UAC Bypass via ICMLuaUtil Elevated COM Interface", "description": "Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attempt\nto bypass UAC to stealthily execute code with elevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"dllhost.exe\" and\n process.parent.args in (\"/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}\", \"/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}\") and\n process.pe.original_file_name != \"WerFault.exe\"", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_com_interface_icmluautil.toml"}
{"title": "UAC Bypass via DiskCleanup Scheduled Task Hijack", "description": "Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to\nstealthily execute code with elevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.args : \"/autoclean\" and process.args : \"/d\" and process.executable != null and\n not process.executable : (\n        \"C:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\taskhostw.exe\"\n)", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_diskcleanup_hijack.toml"}
{"title": "UAC Bypass Attempt via Privileged IFileOperation COM Interface", "description": "Identifies attempts to bypass User Account Control (UAC) via DLL side-loading. Attackers may attempt to bypass UAC to\nstealthily execute code with elevated permissions.", "query": "file where host.os.type == \"windows\" and event.type : \"change\" and process.name : \"dllhost.exe\" and\n  /* Known modules names side loaded into process running with high or system integrity level for UAC Bypass, update here for new modules */\n  file.name : (\"wow64log.dll\", \"comctl32.dll\", \"DismCore.dll\", \"OskSupport.dll\", \"duser.dll\", \"Accessibility.ni.dll\") and\n  /* has no impact on rule logic just to avoid OS install related FPs */\n  not file.path : (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*\", \"C:\\\\Windows\\\\WinSxS\\\\*\")", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_dll_sideloading.toml"}
{"title": "Bypass UAC via Event Viewer", "description": "Identifies User Account Control (UAC) bypass via eventvwr.exe. Attackers bypass UAC to stealthily execute code with\nelevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"eventvwr.exe\" and\n  not process.executable : (\n        \"?:\\\\Windows\\\\SysWOW64\\\\mmc.exe\",\n        \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\mmc.exe\",\n        \"?\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\WerFault.exe\"\n  )", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_event_viewer.toml"}
{"title": "UAC Bypass Attempt via Windows Directory Masquerading", "description": "Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory.\nAttackers may bypass UAC to stealthily execute code with elevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"C:\\\\Windows \\\\system32\\\\*.exe\", \"C:\\\\Windows \\\\SysWOW64\\\\*.exe\")", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_mock_windir.toml"}
{"title": "UAC Bypass via Windows Firewall Snap-In Hijack", "description": "Identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows\nFirewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"mmc.exe\" and\n /* process.Ext.token.integrity_level_name == \"high\" can be added in future for tuning */\n /* args of the Windows Firewall SnapIn */\n  process.parent.args == \"WF.msc\" and process.name != \"WerFault.exe\"", "tactic": "Privilege Escalation", "technique": "Abuse Elevation Control Mechanism", "technique_id": "T1548", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_uac_bypass_winfw_mmc_hijack.toml"}
{"title": "Potential Exploitation of an Unquoted Service Path Vulnerability", "description": "Adversaries may leverage unquoted service path vulnerabilities to escalate privileges. By placing an executable in a\nhigher-level directory within the path of an unquoted service executable, Windows will natively launch this executable\nfrom its defined path variable instead of the benign one in a deeper directory, thus leading to code execution.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.executable : \"?:\\\\Program.exe\" or\n    process.executable regex \"\"\"(C:\\\\Program Files \\(x86\\)\\\\|C:\\\\Program Files\\\\)\\w+.exe \"\"\"  )", "tactic": "Privilege Escalation", "technique": "Hijack Execution Flow", "technique_id": "T1574", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_unquoted_service_path.toml"}
{"title": "Unusual Parent-Child Relationship", "description": "Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strange\nactivity on a system.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.parent.name != null and\n (\n   /* suspicious parent processes */\n   (process.name:\"autochk.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"fontdrvhost.exe\", \"dwm.exe\") and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\", \"dwm.exe\")) or\n   (process.name:(\"consent.exe\", \"RuntimeBroker.exe\", \"TiWorker.exe\") and not process.parent.name:(\"svchost.exe\", \"Workplace Container Helper.exe\")) or\n   (process.name:\"SearchIndexer.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"SearchProtocolHost.exe\" and not process.parent.name:(\"SearchIndexer.exe\", \"dllhost.exe\")) or\n   (process.name:\"dllhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"smss.exe\" and not process.parent.name:(\"System\", \"smss.exe\")) or\n   (process.name:\"csrss.exe\" and not process.parent.name:(\"smss.exe\", \"svchost.exe\")) or\n   (process.name:\"wininit.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:\"winlogon.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"lsass.exe\", \"LsaIso.exe\") and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"LogonUI.exe\" and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:\"services.exe\" and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"svchost.exe\" and not process.parent.name:(\"MsMpEng.exe\", \"services.exe\", \"svchost.exe\")) or\n   (process.name:\"spoolsv.exe\" and not process.parent.name:(\"services.exe\", \"Workplace Starter.exe\")) or\n   (process.name:\"taskhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\", \"ngentask.exe\")) or\n   (process.name:\"taskhostw.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"userinit.exe\" and not process.parent.name:(\"dwm.exe\", \"winlogon.exe\", \"KUsrInit.exe\")) or\n   (process.name:(\"wmiprvse.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") and not process.parent.name:\"svchost.exe\") or\n   /* suspicious child processes */\n   (process.parent.name:(\"SearchProtocolHost.exe\", \"taskhost.exe\", \"csrss.exe\") and not process.name:(\"werfault.exe\", \"wermgr.exe\", \"WerFaultSecure.exe\", \"conhost.exe\", \"ngentask.exe\")) or\n   (process.parent.name:\"autochk.exe\" and not process.name:(\"chkdsk.exe\", \"doskey.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"smss.exe\" and not process.name:(\"autochk.exe\", \"smss.exe\", \"csrss.exe\", \"wininit.exe\", \"winlogon.exe\", \"setupcl.exe\", \"WerFault.exe\", \"wpbbin.exe\", \"PvsVmBoot.exe\", \"SophosNA.exe\", \"omnissa-ic-nga.exe\", \"icarus_rvrt.exe\", \"poqexec.exe\")) or\n   (process.parent.name:\"wermgr.exe\" and not process.name:(\"WerFaultSecure.exe\", \"wermgr.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"conhost.exe\" and not process.name:(\"mscorsvw.exe\", \"wermgr.exe\", \"WerFault.exe\", \"WerFaultSecure.exe\"))\n  )", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_unusual_parentchild_relationship.toml"}
{"title": "Unusual Print Spooler Child Process", "description": "Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege\nescalation vulnerabilities related to the Printing Service on Windows.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"spoolsv.exe\" and process.command_line != null and\n (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n\n /* exclusions for FP control below */\n not process.name : (\"splwow64.exe\", \"PDFCreator.exe\", \"acrodist.exe\", \"spoolsv.exe\", \"msiexec.exe\", \"route.exe\", \"WerFault.exe\") and\n not process.command_line : \"*\\\\WINDOWS\\\\system32\\\\spool\\\\DRIVERS*\" and\n not (process.name : \"net.exe\" and process.command_line : (\"*stop*\", \"*start*\")) and\n not (process.name : (\"cmd.exe\", \"powershell.exe\") and process.command_line : (\"*.spl*\", \"*\\\\program files*\", \"*route add*\")) and\n not (process.name : \"netsh.exe\" and process.command_line : (\"*add portopening*\", \"*rule name*\")) and\n not (process.name : \"regsvr32.exe\" and process.command_line : \"*PrintConfig.dll*\") and\n not process.executable : (\n    \"?:\\\\Program Files (x86)\\\\CutePDF Writer\\\\CPWriter2.exe\",\n    \"?:\\\\Program Files (x86)\\\\GPLGS\\\\gswin32c.exe\"\n )", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_unusual_printspooler_childprocess.toml"}
{"title": "Unusual Service Host Child Process - Childless Service", "description": "Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes.\nThis may indicate a code injection or an equivalent form of exploitation.", "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and\n\n  /* based on svchost service arguments -s svcname where the service is known to be childless */\n  process.parent.args : (\n    \"WdiSystemHost\", \"LicenseManager\", \"StorSvc\", \"CDPSvc\", \"cdbhsvc\", \"BthAvctpSvc\", \"SstpSvc\", \"WdiServiceHost\",\n    \"imgsvc\", \"TrkWks\", \"WpnService\", \"IKEEXT\", \"PolicyAgent\", \"CryptSvc\", \"netprofm\", \"ProfSvc\", \"StateRepository\",\n    \"camsvc\", \"LanmanWorkstation\", \"NlaSvc\", \"EventLog\", \"hidserv\", \"DisplayEnhancementService\", \"ShellHWDetection\",\n    \"AppHostSvc\", \"fhsvc\", \"CscService\", \"PushToInstall\"\n  ) and\n\n  /* unknown FPs can be added here */\n  not process.name : (\"WerFault.exe\", \"WerFaultSecure.exe\", \"wermgr.exe\") and\n  not (process.executable : \"?:\\\\Windows\\\\System32\\\\RelPost.exe\" and process.parent.args : \"WdiSystemHost\") and\n  not (\n    process.name : \"rundll32.exe\" and\n    process.args : \"?:\\\\WINDOWS\\\\System32\\\\winethc.dll,ForceProxyDetectionOnNextRun\" and\n    process.parent.args : \"WdiServiceHost\"\n  ) and\n  not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*\",\n      \"?:\\\\Program Files (x86)\\\\*\",\n      \"?:\\\\Windows\\\\System32\\\\Kodak\\\\kds_?????\\\\lib\\\\lexexe.exe\"\n    ) and process.parent.args : \"imgsvc\"\n  )", "tactic": "Privilege Escalation", "technique": "Process Injection", "technique_id": "T1055", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_unusual_svchost_childproc_childless.toml"}
{"title": "Privileges Elevation via Parent Process PID Spoofing", "description": "Identifies parent process spoofing used to create an elevated child process. Adversaries may spoof the parent process\nidentifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges.", "query": "/* This rule is compatible with Elastic Endpoint only */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n /* process creation via seclogon */\n process.parent.Ext.real.pid > 0 and\n\n /* PrivEsc to SYSTEM */\n user.id : \"S-1-5-18\"  and\n\n /* Common FPs - evasion via hollowing is possible, should be covered by code injection */\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\") and\n /* Logon Utilities */\n not (process.parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and\n     process.executable : (\"?:\\\\Windows\\\\System32\\\\osk.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Narrator.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Magnify.exe\")) and\n\n not process.parent.executable : \"?:\\\\Windows\\\\System32\\\\AtBroker.exe\" and\n\n not (process.code_signature.subject_name in\n           (\"philandro Software GmbH\", \"Freedom Scientific Inc.\", \"TeamViewer Germany GmbH\", \"Projector.is, Inc.\",\n            \"TeamViewer GmbH\", \"Cisco WebEx LLC\", \"Dell Inc\") and process.code_signature.trusted == true) and\n\n /* AM_Delta_Patch Windows Update */\n not (process.executable : (\"?:\\\\Windows\\\\System32\\\\MpSigStub.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\MpSigStub.exe\") and\n      process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\wuauclt.exe\",\n                                   \"?:\\\\Windows\\\\SysWOW64\\\\wuauclt.exe\",\n                                   \"?:\\\\Windows\\\\UUS\\\\Packages\\\\Preview\\\\*\\\\wuaucltcore.exe\",\n                                   \"?:\\\\Windows\\\\UUS\\\\amd64\\\\wuauclt.exe\",\n                                   \"?:\\\\Windows\\\\UUS\\\\amd64\\\\wuaucltcore.exe\",\n                                   \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\*\\\\wuaucltcore.exe\")) and\n not (process.executable : (\"?:\\\\Windows\\\\System32\\\\MpSigStub.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\MpSigStub.exe\") and process.parent.executable == null) and\n\n /* Other third party SW */\n not process.parent.executable :\n                   (\"?:\\\\Program Files (x86)\\\\HEAT Software\\\\HEAT Remote\\\\HEATRemoteServer.exe\",\n                    \"?:\\\\Program Files (x86)\\\\VisualCron\\\\VisualCronService.exe\",\n                    \"?:\\\\Program Files\\\\BinaryDefense\\\\Vision\\\\Agent\\\\bds-vision-agent-app.exe\",\n                    \"?:\\\\Program Files\\\\Tablet\\\\Wacom\\\\WacomHost.exe\",\n                    \"?:\\\\Program Files (x86)\\\\LogMeIn\\\\x64\\\\LogMeIn.exe\",\n                    \"?:\\\\Program Files (x86)\\\\EMC Captiva\\\\Captiva Cloud Runtime\\\\Emc.Captiva.WebCaptureRunner.exe\",\n                    \"?:\\\\Program Files\\\\Freedom Scientific\\\\*.exe\",\n                    \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome Remote Desktop\\\\*\\\\remoting_host.exe\",\n                    \"?:\\\\Program Files (x86)\\\\GoToAssist Remote Support Customer\\\\*\\\\g2ax_comm_customer.exe\") and\n not (\n    process.code_signature.trusted == true and process.code_signature.subject_name == \"Netwrix Corporation\" and\n    process.name : \"adcrcpy.exe\" and process.parent.executable : (\n      \"?:\\\\Program Files (x86)\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.EventCollector.exe\",\n      \"?:\\\\Program Files (x86)\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.Analyzer.exe\",\n      \"?:\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.EventCollector.exe\"\n    )\n )", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_via_ppid_spoofing.toml"}
{"title": "Privilege Escalation via Rogue Named Pipe Impersonation", "description": "Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique by\nmasquerading as a known named pipe and manipulating a privileged process to connect to it.", "query": "file where host.os.type == \"windows\" and\n  event.provider == \"Microsoft-Windows-Sysmon\" and\n  \n  /* Named Pipe Creation */\n  event.code == \"17\" and\n  \n  /* Sysmon truncates the \"Pipe\" keyword in normal named pipe creation events */\n  file.name : \"\\\\*\\\\Pipe\\\\*\"", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_via_rogue_named_pipe.toml"}
{"title": "Process Created with an Elevated Token", "description": "Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries\nmay create a new process with a different token to escalate privileges and bypass access controls.", "query": "/* This rule is only compatible with Elastic Endpoint 8.4+ */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n /* CreateProcessWithToken and effective parent is a privileged MS native binary used as a target for token theft */\n user.id : \"S-1-5-18\"  and\n\n /* Token Theft target process usually running as service are located in one of the following paths */\n process.Ext.effective_parent.executable :\n                (\"?:\\\\Windows\\\\*.exe\",\n                 \"?:\\\\Program Files\\\\*.exe\",\n                 \"?:\\\\Program Files (x86)\\\\*.exe\",\n                 \"?:\\\\ProgramData\\\\*\") and\n\n/* Ignores Utility Manager in Windows running in debug mode */\n not (process.Ext.effective_parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and\n      process.parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and process.parent.args : \"/debug\") and\n\n/* Ignores Windows print spooler service with correlation to Access Intelligent Form */\nnot (process.parent.executable : \"?\\\\Windows\\\\System32\\\\spoolsv.exe\" and\n     process.executable: \"?:\\\\Program Files*\\\\Access\\\\Intelligent Form\\\\*\\\\LaunchCreate.exe\") and\n\n/* Ignores Windows error reporting executables */\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\windows\\\\system32\\\\WerMgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\")  and\n\n /* Ignores Windows updates from TiWorker.exe that runs with elevated privileges */\n not (process.parent.executable : \"?:\\\\Windows\\\\WinSxS\\\\*\\\\TiWorker.exe\" and\n      process.executable : (\"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*.exe\",\n                            \"?:\\\\Windows\\\\WinSxS\\\\*.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\iissetup.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\iissetup.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\aspnetca.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\aspnetca.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\lodctr.exe\",\n                            \"?:\\\\Windows\\\\SysWOW64\\\\lodctr.exe\",\n                            \"?:\\\\Windows\\\\System32\\\\netcfg.exe\",\n                            \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*\\\\ngen.exe\",\n                            \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*\\\\aspnet_regiis.exe\")) and\n\n\n/* Ignores additional parent executables that run with elevated privileges */\n not process.parent.executable :\n               (\"?:\\\\Windows\\\\System32\\\\AtBroker.exe\",\n                \"?:\\\\Windows\\\\system32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\*\") and\n\n/* Ignores Windows binaries with a trusted signature and specific signature name */\n not (process.code_signature.trusted == true and\n      process.code_signature.subject_name :\n                (\"philandro Software GmbH\",\n                 \"Freedom Scientific Inc.\",\n                 \"TeamViewer Germany GmbH\",\n                 \"Projector.is, Inc.\",\n                 \"TeamViewer GmbH\",\n                 \"Cisco WebEx LLC\",\n                 \"Dell Inc\"))", "tactic": "Privilege Escalation", "technique": "Access Token Manipulation", "technique_id": "T1134", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_via_token_theft.toml"}
{"title": "Windows Service Installed via an Unusual Client", "description": "Identifies the creation of a Windows service by an unusual client process. Services may be created with administrator\nprivileges but are executed under SYSTEM privileges, so an adversary may also use a service to escalate privileges from\nadministrator to SYSTEM.", "query": "configuration where host.os.type == \"windows\" and\n  event.action == \"service-installed\" and\n  (winlog.event_data.ClientProcessId == \"0\" or winlog.event_data.ParentProcessId == \"0\") and\n  startswith~(user.domain, winlog.computer_name) and winlog.event_data.ServiceAccount == \"LocalSystem\" and \n  not winlog.event_data.ServiceFileName : (\n    \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n    \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n    \"%SystemRoot%\\\\system32\\\\Drivers\\\\Crowdstrike\\\\*-CsInstallerService.exe\",\n    \"\\\"%windir%\\\\AdminArsenal\\\\PDQInventory-Scanner\\\\service-1\\\\PDQInventory-Scanner-1.exe\\\" \"\n  )", "tactic": "Privilege Escalation", "technique": "Create or Modify System Process", "technique_id": "T1543", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_windows_service_via_unusual_client.toml"}
{"title": "WPAD Service Exploit", "description": "Identifies probable exploitation of the Web Proxy Auto-Discovery Protocol (WPAD) service. Attackers who have access to\nthe local network or upstream DNS traffic can inject malicious JavaScript to the WPAD service which can lead to a full\nsystem compromise.", "query": "/* preference would be to use user.sid rather than domain+name, once it is available in ECS + datasources */\n/* didn't trigger successfully during testing */\n\nsequence with maxspan=5s\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"svchost.exe\" and\n     user.domain : \"NT AUTHORITY\" and user.name : \"LOCAL SERVICE\"] by process.entity_id\n  [network where host.os.type == \"windows\" and network.protocol : \"dns\" and process.name : \"svchost.exe\" and\n     dns.question.name : \"wpad\" and process.name : \"svchost.exe\"] by process.entity_id\n  [network where host.os.type == \"windows\" and process.name : \"svchost.exe\"\n     and network.direction : (\"outgoing\", \"egress\") and destination.port == 80] by process.entity_id\n  [library where host.os.type == \"windows\" and event.type : \"start\" and process.name : \"svchost.exe\" and\n     dll.name : \"jscript.dll\" and process.name : \"svchost.exe\"] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.parent.name : \"svchost.exe\"] by process.parent.entity_id", "tactic": "Privilege Escalation", "technique": "Exploitation for Privilege Escalation", "technique_id": "T1068", "risk_score": "N/A", "tags": [], "references": [], "file": "privilege_escalation_wpad_exploitation.toml"}
